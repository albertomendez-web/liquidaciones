<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Liquidaciones — Gestión de Reservas</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'DM Sans', 'Helvetica Neue', sans-serif; background: #f0f2f5; color: #1a1a2e; min-height: 100vh; }
.sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 250px; background: linear-gradient(195deg, #0f1628 0%, #1a2744 100%); color: #fff; display: flex; flex-direction: column; z-index: 50; }
.logo { padding: 28px 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
.logo h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.02em; }
.logo p { font-size: 11px; color: rgba(255,255,255,0.45); margin-top: 4px; letter-spacing: 0.06em; text-transform: uppercase; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 13px 24px; font-size: 14px; color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
.nav-item:hover { color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.04); }
.nav-item.active { color: #fff; font-weight: 600; background: rgba(255,255,255,0.08); border-left-color: #4f8cff; }
.sidebar-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 11px; color: rgba(255,255,255,0.35); margin-top: auto; }
.main { margin-left: 250px; padding: 32px 40px; min-height: 100vh; }
.card { background: #fff; border-radius: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); padding: 28px 32px; margin-bottom: 24px; }
.upload-wrap { display: flex; align-items: center; justify-content: center; min-height: 70vh; }
.upload-inner { max-width: 520px; width: 100%; text-align: center; }
.upload-inner h2 { font-size: 32px; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 8px; }
.upload-inner p { color: #6b7280; font-size: 15px; margin-bottom: 32px; }
.dropzone { border: 2px dashed #cfd5de; border-radius: 16px; padding: 64px 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fafbfc; }
.dropzone.dragging { border-color: #4f8cff; background: rgba(79,140,255,0.04); }
.dropzone svg { color: #9ca3af; margin-bottom: 16px; }
.dropzone .title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
.dropzone .sub { font-size: 13px; color: #9ca3af; }
.stats-row { display: flex; gap: 16px; margin-bottom: 24px; }
.stat-card { flex: 1; padding: 20px 24px; border-radius: 12px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.stat-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; margin-bottom: 6px; }
.stat-value { font-size: 26px; font-weight: 700; letter-spacing: -0.02em; }
.stat-filtered { font-size: 13px; font-weight: 600; color: #4f8cff; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #e0e4ea; }
.stat-pct { font-size: 11px; font-weight: 500; color: #9ca3af; }
.filters-bar { display: flex; gap: 12px; align-items: center; padding: 16px 24px; margin-bottom: 16px; flex-wrap: wrap; }
.filters-bar label { font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.06em; }
.filters-bar .count { font-size: 12px; color: #9ca3af; margin-left: auto; }
.filter-sep { width: 1px; height: 24px; background: #e5e7eb; }
.table-wrap { overflow-x: auto; overflow-y: auto; max-height: 75vh; }
table { width: 100%; border-collapse: collapse; }
th { padding: 10px 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; border-bottom: 2px solid #eef0f4; text-align: left; white-space: nowrap; background: #f8f9fb; cursor: pointer; user-select: none; position: sticky; top: 0; z-index: 3; }
th:hover { color: #4f8cff; }
th.right { text-align: right; }
th .sort-arrow { font-size: 10px; margin-left: 4px; opacity: 0.3; }
th.sorted .sort-arrow { opacity: 1; color: #4f8cff; }
th.no-sort { cursor: default; }
th.no-sort:hover { color: #6b7280; }
td { padding: 9px 10px; font-size: 13px; border-bottom: 1px solid #f3f4f6; white-space: nowrap; vertical-align: middle; }
td.right { text-align: right; font-variant-numeric: tabular-nums; }
td.bold { font-weight: 700; }
td.ellip { max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
td.muted { font-size: 12px; color: #6b7280; }
tr:hover td { background: #f8f9ff; }
tfoot td { position: sticky; bottom: 0; z-index: 2; background: #0f1628 !important; }
tfoot tr:hover td { background: #0f1628 !important; }
th.col-comPlataforma, th.col-comGTC, th.col-limpieza, th.col-amenities, th.col-pasarela, th.col-noches { text-align: center; }
tr.validated td { background: rgba(232,245,233,0.3); }
tr.highlight td { animation: pulse-highlight 0.6s ease-in-out 3; }
@keyframes pulse-highlight {
  0% { background: #fff; }
  50% { background: #e3f0ff; }
  100% { background: #fff; }
}
.badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.02em; }
.badge-green { background: #e8f5e9; color: #2e7d32; }
.badge-amber { background: #fff8e1; color: #f57f17; }
.badge-blue { background: #e3f2fd; color: #1565c0; }
.badge-purple { background: #f3e5f5; color: #7b1fa2; }
.badge-red { background: #ffebee; color: #c62828; }
select.sel { padding: 6px 10px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-weight: 500; background: #fafbfc; outline: none; cursor: pointer; transition: border-color 0.2s; font-family: inherit; display: inline-block; text-align: center; text-align-last: center; }
select.sel:focus { border-color: #4f8cff; }
select.sel:disabled { opacity: 0.5; cursor: not-allowed; }
.toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; }
.toggle-track { width: 38px; height: 22px; border-radius: 11px; background: #d1d5db; position: relative; transition: background 0.2s; flex-shrink: 0; }
.toggle-track.on { background: #4f8cff; }
.toggle-thumb { position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; border-radius: 9px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.15); transition: left 0.2s; }
.toggle-track.on .toggle-thumb { left: 18px; }
.toggle-label { font-size: 11px; color: #6b7280; }
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
.btn:hover { opacity: 0.88; }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-primary { background: #4f8cff; color: #fff; }
.btn-success { background: #43a047; color: #fff; }
.btn-orange { background: #ef6c00; color: #fff; }
.btn-outline { background: transparent; color: #4f8cff; border: 1.5px solid #4f8cff; }
.btn-disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; }
.btn-disabled:hover { opacity: 1; }

/* MODAL */
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
.modal { background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); width: 600px; max-height: 85vh; overflow-y: auto; }
.modal-header { padding: 24px 28px 16px; border-bottom: 1px solid #eef0f4; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 2; border-radius: 16px 16px 0 0; }
.modal-header h3 { font-size: 18px; font-weight: 700; }
.modal-close { width: 32px; height: 32px; border-radius: 8px; border: none; background: #f3f4f6; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
.modal-close:hover { background: #e5e7eb; }
.modal-body { padding: 24px 28px; }
.modal-section { margin-bottom: 28px; }
.modal-section:last-child { margin-bottom: 0; }
.modal-section h4 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; margin-bottom: 12px; }
.modal-section .desc { font-size: 12px; color: #9ca3af; margin-top: -8px; margin-bottom: 12px; }
.option-list { display: flex; flex-direction: column; gap: 6px; }
.option-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 8px; background: #f8f9fb; font-size: 14px; font-weight: 500; }
.option-delete { width: 28px; height: 28px; border-radius: 6px; border: none; background: transparent; color: #e53935; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.option-delete:hover { background: #ffebee; }
.add-row { display: flex; gap: 8px; margin-top: 10px; }
.add-input { flex: 1; padding: 8px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 14px; font-family: inherit; outline: none; }
.add-input:focus { border-color: #4f8cff; }
.add-input::placeholder { color: #bbb; }
.section-divider { border: none; border-top: 2px solid #eef0f4; margin: 28px 0; }
.modal-tabs { display: flex; gap: 4px; padding: 16px 28px 0; background: #fff; position: sticky; top: 60px; z-index: 1; border-bottom: 1px solid #eef0f4; }
.modal-tab { padding: 10px 18px; font-size: 13px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
.modal-tab:hover { color: #4f8cff; }
.modal-tab.active { color: #4f8cff; border-bottom-color: #4f8cff; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ALOJAMIENTO CARDS */
.aloj-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-bottom: 24px; }
.aloj-card { background: #fff; border-radius: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); padding: 24px; transition: all 0.2s; cursor: pointer; border: 2px solid transparent; position: relative; overflow: hidden; }
.aloj-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }
.aloj-card.ready { border-color: #43a047; }
.aloj-card.pending { border-color: #ff9800; }
.aloj-semaforo { position: absolute; top: 0; right: 0; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
.aloj-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; padding-right: 40px; }
.aloj-edificio { font-size: 12px; color: #6b7280; margin-bottom: 16px; }
.aloj-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.aloj-stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; }
.aloj-stat-value { font-size: 18px; font-weight: 700; margin-top: 2px; }
.aloj-bar { height: 4px; border-radius: 2px; background: #eef0f4; margin-top: 16px; overflow: hidden; }
.aloj-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

/* CONSOLIDATED LIQUIDACION */
.consol-container { max-width: 100%; margin: 0 auto; }
.consol-header { background: linear-gradient(135deg, #0f1628 0%, #1a2744 100%); color: #fff; padding: 32px 32px; border-radius: 14px 14px 0 0; }
.consol-header .type { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.6; margin-bottom: 4px; }
.consol-header .name { font-size: 24px; font-weight: 700; }
.consol-meta { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 24px; font-size: 13px; }
.consol-meta-label { opacity: 0.5; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; }
.consol-meta-value { font-weight: 600; margin-top: 2px; }
.consol-body { background: #fff; border-radius: 0 0 14px 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); overflow: hidden; }
.consol-section-title { padding: 14px 28px 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; background: #f8f9fb; border-top: 2px solid #eef0f4; }
.consol-section-title:first-child { border-top: none; }
.consol-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 28px; font-size: 13px; }
.consol-row:nth-child(even) { background: #fafbfc; }
.consol-row.sub { padding-left: 44px; font-size: 12px; color: #6b7280; }
.consol-row .neg { color: #e53935; }
.consol-row .pos { color: #43a047; }
.consol-divider { height: 1px; background: #eef0f4; margin: 4px 28px; }
.consol-subtotal { display: flex; justify-content: space-between; align-items: center; padding: 14px 28px; font-size: 15px; font-weight: 700; background: #f0f2f5; }
.consol-total { display: flex; justify-content: space-between; align-items: center; padding: 20px 28px; font-size: 20px; font-weight: 700; background: #0f1628; color: #fff; }
.consol-mini-table { margin: 0; width: 100%; table-layout: auto; }
.consol-mini-table th { font-size: 10px; padding: 10px 8px; }
.consol-mini-table td { font-size: 11px; padding: 8px 8px; }
.consol-mini-table tbody tr:hover td { background: #eef3ff; }
.consol-mini-table .ellip { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 160px; }
.consol-summary-block { }

/* LIQUIDACIÁ“N INDIVIDUAL */
.liq-container { max-width: 800px; margin: 0 auto; background: #fff; border-radius: 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); overflow: hidden; }
.liq-header { background: linear-gradient(135deg, #0f1628 0%, #1a2744 100%); color: #fff; padding: 36px 40px; }
.liq-header .type { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.6; margin-bottom: 4px; }
.liq-header .name { font-size: 24px; font-weight: 700; }
.liq-meta { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 24px; font-size: 13px; }
.liq-meta-label { opacity: 0.5; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; }
.liq-meta-value { font-weight: 600; margin-top: 2px; }
.liq-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 40px; font-size: 14px; }
.liq-row:nth-child(even) { background: #f8f9fb; }
.liq-row.bold { font-weight: 700; }
.liq-row .neg { color: #e53935; }
.liq-row .pos { color: #43a047; }
.liq-divider { height: 1px; background: #eef0f4; margin: 4px 40px; }
.liq-total { display: flex; justify-content: space-between; align-items: center; padding: 18px 40px; font-size: 18px; font-weight: 700; background: #0f1628; color: #fff; }
.liq-actions { display: flex; gap: 12px; justify-content: center; margin-top: 28px; }
.header-top { display: flex; justify-content: space-between; align-items: flex-start; }
.badge-liq { padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
.badge-liq-green { background: rgba(67,160,71,0.2); color: #81c784; }
.badge-liq-amber { background: rgba(255,183,77,0.2); color: #ffb74d; }

.screen { display: none; }
.screen.active { display: block; }
.gear-btn { width: 36px; height: 36px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; }
.gear-btn:hover { border-color: #4f8cff; background: #f0f5ff; }

/* SEARCHABLE COMBO */
.combo { position: relative; min-width: 190px; }
.combo-input { padding: 6px 30px 6px 10px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-weight: 500; background: #fafbfc; outline: none; cursor: pointer; transition: border-color 0.2s; font-family: inherit; width: 100%; }
.combo-input:focus { border-color: #4f8cff; }
.combo-input::placeholder { color: #6b7280; font-weight: 500; }
.combo-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; border-radius: 4px; display: none; align-items: center; justify-content: center; font-size: 11px; color: #9ca3af; cursor: pointer; background: transparent; }
.combo-clear:hover { color: #e53935; background: #ffebee; }
.combo.has-value .combo-clear { display: flex; }
.combo.has-value .combo-input { padding-right: 30px; font-weight: 600; color: #1a1a2e; }
.combo-list { display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; max-height: 260px; overflow-y: auto; padding: 4px; }
.combo-list.open { display: block; }
.combo-item { padding: 8px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
.combo-item:hover { background: #eef3ff; }
.combo-item.active { background: #e3f2fd; font-weight: 600; color: #4f8cff; }
.combo-item .match { font-weight: 700; color: #4f8cff; }
.combo-item-count { font-size: 11px; color: #9ca3af; margin-left: 6px; }
.combo-empty { padding: 12px; font-size: 12px; color: #9ca3af; text-align: center; }
@media print {
  @page { size: A4 landscape; margin: 10mm 12mm; }
  body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  body * { visibility: hidden; }
  .print-target, .print-target * { visibility: visible; }
  .print-target { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none !important; border-radius: 0 !important; }
  .sidebar, .btn, .no-print, .liq-actions, .gear-btn { display: none !important; }

  /* Container */
  .consol-container, .liq-container { max-width: 100% !important; box-shadow: none !important; border-radius: 0 !important; }

  /* Header */
  .consol-header, .liq-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; border-radius: 0 !important; padding: 16px 20px !important; }
  .consol-header .name { font-size: 18px !important; }
  .consol-meta { gap: 12px !important; margin-top: 14px !important; font-size: 11px !important; }

  /* Body */
  .consol-body { box-shadow: none !important; border-radius: 0 !important; overflow: visible !important; }
  .table-wrap { overflow: visible !important; }

  /* Mini table — compact for landscape A4 */
  .consol-mini-table { table-layout: fixed !important; width: 100% !important; }
  .consol-mini-table th { padding: 4px 5px !important; font-size: 8px !important; }
  .consol-mini-table td { padding: 4px 5px !important; font-size: 9px !important; }
  .consol-mini-table .ellip { max-width: 0; }
  .badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 7px !important; padding: 1px 4px !important; }

  /* Summary rows */
  .consol-section-title { padding: 8px 16px 4px !important; font-size: 9px !important; }
  .consol-row { padding: 5px 16px !important; font-size: 10px !important; }
  .consol-row.sub { padding-left: 28px !important; font-size: 9px !important; }
  .consol-divider { margin: 2px 16px !important; }
  .consol-subtotal { padding: 8px 16px !important; font-size: 12px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .consol-total { padding: 12px 16px !important; font-size: 15px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; border-radius: 0 !important; }

  /* CRITICAL: keep summary + total together — never split across pages */
  .consol-summary-block { page-break-inside: avoid !important; break-inside: avoid !important; }

  /* Table page break rules */
  table { page-break-inside: auto; }
  thead { display: table-header-group; }
  tr { page-break-inside: avoid; }
  .consol-section-title { page-break-after: avoid; }

  /* Individual liquidación */
  .liq-row { padding: 6px 20px !important; font-size: 11px !important; }
  .liq-divider { margin: 2px 20px !important; }
  .liq-total { padding: 10px 20px !important; font-size: 15px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-header { padding: 16px 20px !important; }

  /* Print cards: keep each card together, break between them */
  .print-card { page-break-inside: avoid !important; break-inside: avoid !important; margin-bottom: 12px !important; }
  .print-summary { page-break-inside: avoid !important; break-inside: avoid !important; margin-top: 12px !important; }
}
::-webkit-scrollbar { height: 6px; width: 6px; }
::-webkit-scrollbar-thumb { background: #cfd5de; border-radius: 3px; }
/* GOOGLE SHEETS UI */
.gsheet-section { margin-top: 32px; padding-top: 28px; border-top: 2px solid #eef0f4; }
.gsheet-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.gsheet-section p { font-size: 13px; color: #9ca3af; margin-bottom: 16px; }
.gsheet-status { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; margin-bottom: 16px; }
.gsheet-status.connected { background: #e8f5e9; color: #2e7d32; }
.gsheet-status.disconnected { background: #f3f4f6; color: #6b7280; }
.gsheet-status .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.gsheet-status.connected .dot { background: #43a047; }
.gsheet-status.disconnected .dot { background: #9ca3af; }
.gsheet-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
.gsheet-history { margin-top: 20px; }
.gsheet-history h4 { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; margin-bottom: 10px; }
.gsheet-history-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 8px; background: #f8f9fb; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; border: 1.5px solid transparent; }
.gsheet-history-item:hover { border-color: #4f8cff; background: #f0f5ff; }
.gsheet-history-item .name { font-size: 13px; font-weight: 600; }
.gsheet-history-item .meta { font-size: 11px; color: #9ca3af; }
.gsheet-history-item .remove-btn { width: 24px; height: 24px; border-radius: 6px; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
.gsheet-history-item .remove-btn:hover { background: #ffebee; color: #e53935; }
.gsheet-url-row { display: flex; gap: 8px; margin-bottom: 12px; }
.gsheet-url-input { flex: 1; padding: 10px 14px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-family: inherit; outline: none; }
.gsheet-url-input:focus { border-color: #4f8cff; }
.gsheet-url-input::placeholder { color: #bbb; }
.gsheet-loading { display: flex; align-items: center; gap: 10px; padding: 16px; font-size: 14px; color: #6b7280; }
.gsheet-spinner { width: 20px; height: 20px; border: 2.5px solid #e0e4ea; border-top-color: #4f8cff; border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.sidebar-google { padding: 10px 24px; border-top: 1px solid rgba(255,255,255,0.08); }
.sidebar-google .status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }
.sidebar-google .status-text { font-size: 11px; color: rgba(255,255,255,0.5); }
.sidebar-google .status-dot.on { background: #43a047; }
.sidebar-google .status-dot.off { background: #666; }
/* SYNC INDICATOR */
.sync-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; transition: background 0.3s; }
.sync-dot.idle { background: #43a047; }
.sync-dot.syncing { background: #ff9800; animation: sync-pulse 0.8s ease-in-out infinite; }
.sync-dot.saved { background: #43a047; }
.sync-dot.error { background: #e53935; }
@keyframes sync-pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
.page-header h1 { font-size: 26px; font-weight: 700; letter-spacing: -0.02em; }
.page-header p { color: #6b7280; font-size: 14px; margin-top: 4px; }
/* COLUMN TOGGLE DROPDOWN */
.col-toggle-wrap { position: relative; }
.col-toggle-btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fafbfc; font-size: 12px; font-weight: 600; color: #6b7280; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.col-toggle-btn:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
.col-toggle-dd { display: none; position: absolute; top: calc(100% + 4px); right: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; padding: 8px 4px; min-width: 200px; }
.col-toggle-dd.open { display: block; }
.col-toggle-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; }
.col-toggle-item:hover { background: #eef3ff; }
.col-toggle-item input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; }
.col-toggle-item.locked { opacity: 0.4; cursor: not-allowed; }
.col-toggle-item.locked:hover { background: transparent; }
/* MONTH PICKER */
.mp-wrap { position: relative; }
.mp-btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fafbfc; font-size: 13px; font-weight: 500; color: #6b7280; cursor: pointer; font-family: inherit; transition: all 0.2s; white-space: nowrap; }
.mp-btn:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
.mp-btn.active { border-color: #4f8cff; background: #e3f2fd; color: #1565c0; font-weight: 600; }
.mp-btn .mp-icon { font-size: 14px; }
.mp-btn .mp-clear { margin-left: 4px; width: 16px; height: 16px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; color: #9ca3af; }
.mp-btn .mp-clear:hover { color: #e53935; background: #ffebee; }
.mp-nav { display: inline-flex; align-items: center; gap: 0; margin-right: 2px; }
.mp-arrow { width: 22px; height: 22px; border-radius: 5px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #4f8cff; display: inline-flex; align-items: center; justify-content: center; transition: all 0.15s; font-family: inherit; padding: 0; }
.mp-arrow:hover { background: rgba(79,140,255,0.15); }
.mp-dd { display: none; position: absolute; top: calc(100% + 4px); left: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; padding: 12px; min-width: 280px; }
.mp-dd.open { display: block; }
.mp-years { display: flex; gap: 4px; margin-bottom: 10px; flex-wrap: wrap; }
.mp-year { padding: 5px 12px; border-radius: 6px; border: 1.5px solid #e0e4ea; background: #fafbfc; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; font-family: inherit; color: #6b7280; }
.mp-year:hover { border-color: #4f8cff; color: #4f8cff; }
.mp-year.sel { background: #4f8cff; color: #fff; border-color: #4f8cff; }
.mp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
.mp-month { padding: 8px 4px; border-radius: 6px; border: none; background: #f8f9fb; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; font-family: inherit; text-align: center; color: #1a1a2e; }
.mp-month:hover { background: #e3f2fd; color: #1565c0; }
.mp-month.sel { background: #4f8cff; color: #fff; font-weight: 700; }
.mp-month.dim { opacity: 0.3; cursor: default; pointer-events: none; }
.mp-month .mp-cnt { display: block; font-size: 10px; font-weight: 400; opacity: 0.6; margin-top: 1px; }
.mp-month.sel .mp-cnt { opacity: 0.8; }
.mp-all { display: block; width: 100%; padding: 7px; margin-top: 8px; border-radius: 6px; border: 1.5px dashed #dde1e8; background: transparent; font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; color: #6b7280; text-align: center; transition: all 0.15s; }
.mp-all:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
/* MULTI-SELECT COMBO ADDITIONS */
.combo-item-chk { display: flex; align-items: center; gap: 8px; padding: 7px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; }
.combo-item-chk:hover { background: #eef3ff; }
.combo-item-chk input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; flex-shrink: 0; }
.combo-item-chk .match { font-weight: 700; color: #4f8cff; }
.combo-item-chk .combo-item-count { font-size: 11px; color: #9ca3af; margin-left: auto; }
.combo-selall { display: flex; align-items: center; gap: 8px; padding: 7px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; color: #4f8cff; font-weight: 600; border-bottom: 1px solid #eef0f4; margin-bottom: 2px; }
.combo-selall:hover { background: #f0f5ff; }
.combo-selall input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; flex-shrink: 0; }
.combo-tags { display: flex; gap: 4px; flex-wrap: wrap; max-width: 240px; }
.combo-tag { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 4px; background: #e3f2fd; color: #1565c0; font-size: 11px; font-weight: 600; white-space: nowrap; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
</style>
<style id="col-visibility-style"></style>
<style id="consol-col-visibility-style"></style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>

<div class="sidebar">
  <div class="logo"><h1>Liquidaciones</h1><p>Gestión de Reservas</p></div>
  <nav style="margin-top:16px; flex:1;">
    <div class="nav-item active" id="nav-upload" onclick="showScreen('upload')">&#128228; Cargar Fichero</div>
    <div class="nav-item" id="nav-list" onclick="showScreen('list')">&#128203; Preliquidaciones</div>
    <div class="nav-item" id="nav-consol" onclick="showScreen('consol')" style="display:none;">&#127968; Por Alojamiento</div>
    <div class="nav-item" id="nav-detail" onclick="showScreen('detail')" style="display:none;">&#128065; Detalle</div>
    <div class="nav-item" id="nav-consoldetail" onclick="showScreen('consoldetail')" style="display:none;">&#128196; Liquidación</div>
  </nav>
  <div class="sidebar-google" id="sidebar-google" style="display:none;">
    <span class="status-dot" id="google-dot"></span>
    <span class="status-text" id="google-status-text"></span>
  </div>
  <div class="sidebar-footer" id="file-indicator" style="display:none;">&#128206; <span id="file-name"></span></div>
  <div id="sync-indicator" style="display:none;padding:8px 24px;align-items:center;gap:8px;font-size:11px;color:rgba(255,255,255,0.6);">
    <div class="sync-dot idle"></div>
    <span class="sync-text">Sincronizado</span>
  </div>
  <div class="sidebar-footer" id="version-indicator" style="cursor:pointer;" onclick="showVersionInfo()" title="Info de versión">v<span id="version-label"></span></div>
</div>

<div class="main">
  <!-- UPLOAD -->
  <div class="screen active" id="screen-upload">
    <div class="upload-wrap"><div class="upload-inner">
      <h2>Cargar Reservas</h2>
      <p>Sube un fichero Excel o conecta con Google Sheets para cargar las reservas</p>
      <div class="dropzone" id="dropzone"
        ondragover="event.preventDefault(); this.classList.add('dragging');"
        ondragleave="this.classList.remove('dragging');"
        ondrop="event.preventDefault(); this.classList.remove('dragging'); handleFile(event.dataTransfer.files[0]);"
        onclick="document.getElementById('fileInput').click();">
        <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
        <div class="title">Arrastra tu fichero aquí</div>
        <div class="sub">o haz clic para seleccionar — formato .xlsx</div>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;" onchange="handleFile(this.files[0]);">

      <!-- GOOGLE SHEETS SECTION -->
      <div class="gsheet-section" id="gsheet-section">
        <h3>&#128202; Cargar desde Google Sheets</h3>
        <p>Conecta con tu cuenta Google para cargar datos directamente desde una hoja de cálculo</p>
        <div id="gsheet-auth-area">
          <div class="gsheet-status disconnected" id="gsheet-status">
            <div class="dot"></div>
            <span id="gsheet-status-label">No conectado</span>
          </div>
          <div class="gsheet-actions">
            <button class="btn btn-primary" id="btn-google-connect" onclick="googleSignIn()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#fff"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#fff" opacity=".8"/></svg>
              Conectar con Google
            </button>
            <button class="btn btn-outline" id="btn-google-disconnect" onclick="googleSignOut()" style="display:none;">Desconectar</button>
          </div>
        </div>
        <div id="gsheet-default-area" style="display:none; margin-top:20px;">
          <div style="background:#f0f5ff;border:1.5px solid #c3d9ff;border-radius:10px;padding:16px 20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#4f8cff;">&#9733; Hoja por defecto</span>
              <div style="display:flex;gap:6px;">
                <button class="btn btn-sm btn-primary" id="btn-load-default" onclick="loadDefaultSheet()">&#9654; Cargar ahora</button>
                <button class="btn btn-sm btn-outline" onclick="editDefaultUrl()" title="Cambiar URL">&#9998;</button>
                <button class="btn btn-sm" style="background:#ffebee;color:#e53935;padding:6px 10px;" onclick="clearDefaultUrl()" title="Quitar por defecto">&#10005;</button>
              </div>
            </div>
            <div id="default-url-display" style="font-size:13px;color:#1a2744;font-weight:500;word-break:break-all;"></div>
            <div id="default-url-edit" style="display:none;">
              <div class="gsheet-url-row" style="margin-bottom:0;">
                <input class="gsheet-url-input" type="text" id="default-url-edit-input" placeholder="https://docs.google.com/spreadsheets/d/...">
                <button class="btn btn-sm btn-success" onclick="saveDefaultUrlEdit()">Guardar</button>
                <button class="btn btn-sm btn-outline" onclick="cancelDefaultUrlEdit()">Cancelar</button>
              </div>
            </div>
          </div>
        </div>
        <div id="gsheet-autoload-status" style="display:none;margin-top:12px;">
          <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;background:#e8f5e9;color:#2e7d32;font-size:13px;font-weight:500;">
            <div class="gsheet-spinner" style="border-top-color:#43a047;border-color:#c8e6c9;width:18px;height:18px;"></div>
            <span id="autoload-status-text">Cargando hoja por defecto...</span>
          </div>
        </div>
        <div id="gsheet-no-default" style="display:none; margin-top:20px;">
          <div style="background:#f8f9fb;border:1.5px dashed #dde1e8;border-radius:10px;padding:14px 20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div>
                <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#9ca3af;margin-bottom:4px;">Hoja por defecto</div>
                <div style="font-size:13px;color:#6b7280;">Configura una URL para cargar autom&aacute;ticamente al conectar</div>
              </div>
              <button class="btn btn-sm btn-outline" onclick="showSetDefaultUrl()">Configurar</button>
            </div>
            <div id="set-default-url-form" style="display:none;margin-top:12px;">
              <div class="gsheet-url-row" style="margin-bottom:0;">
                <input class="gsheet-url-input" type="text" id="set-default-url-input" placeholder="https://docs.google.com/spreadsheets/d/...">
                <button class="btn btn-sm btn-success" onclick="saveNewDefaultUrl()">Guardar</button>
              </div>
            </div>
          </div>
        </div>
        <div id="gsheet-picker-area" style="display:none; margin-top:20px;">
          <div class="gsheet-actions" style="margin-bottom:12px;">
            <button class="btn btn-primary" onclick="openGooglePicker()">&#128193; Explorar Google Drive</button>
          </div>
          <div style="display:flex;align-items:center;gap:12px;margin:12px 0;">
            <div style="flex:1;height:1px;background:#e0e4ea;"></div>
            <span style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.08em;">o pega la URL</span>
            <div style="flex:1;height:1px;background:#e0e4ea;"></div>
          </div>
          <div class="gsheet-url-row">
            <input class="gsheet-url-input" type="text" id="gsheet-url-input" placeholder="https://docs.google.com/spreadsheets/d/...">
            <button class="btn btn-primary" onclick="loadFromUrl()">Cargar</button>
          </div>
        </div>
        <div id="gsheet-loading" style="display:none;" class="gsheet-loading">
          <div class="gsheet-spinner"></div>
          <span id="gsheet-loading-text">Cargando datos...</span>
        </div>
        <div id="gsheet-sheets-selector" style="display:none; margin-top:16px;">
          <label style="font-size:12px;font-weight:600;color:#6b7280;display:block;margin-bottom:8px;">Selecciona la hoja:</label>
          <div id="gsheet-sheets-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
        <div class="gsheet-history" id="gsheet-history" style="display:none;">
          <h4>Hojas recientes</h4>
          <div id="gsheet-history-list"></div>
        </div>
      </div>
    </div></div>
  </div>

  <!-- LIST -->
  <div class="screen" id="screen-list">
    <div class="page-header" style="margin-bottom:28px;">
      <h1>Preliquidaciones</h1>
      <p>Revisa, ajusta y valida cada reserva antes de generar la liquidación definitiva</p>
    </div>
    <div class="stats-row" id="stats-row"></div>
    <div class="card filters-bar">
      <label>Filtros</label>
      <div class="combo" id="combo-platform">
        <input class="combo-input" type="text" placeholder="Todas las plataformas" onclick="openCombo('platform')" oninput="filterCombo('platform')">
        <div class="combo-clear" onclick="clearCombo('platform')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-platform"></div>
      </div>
      <div class="combo" id="combo-aloj">
        <input class="combo-input" type="text" placeholder="Todos los alojamientos" onclick="openCombo('aloj')" oninput="filterCombo('aloj')">
        <div class="combo-clear" onclick="clearCombo('aloj')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-aloj"></div>
      </div>
      <div class="combo" id="combo-status" style="min-width:150px;">
        <input class="combo-input" type="text" placeholder="Todos los estados" readonly onclick="openSimpleCombo('status')" style="cursor:pointer;">
        <div class="combo-clear" onclick="clearSimpleCombo('status')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-status"></div>
      </div>
      <div class="mp-wrap" id="mp-wrap-p">
        <button class="mp-btn" id="mp-btn-p" onclick="toggleMonthPicker('p')"><span class="mp-icon">&#128197;</span> <span id="mp-label-p">Todos los meses</span></button>
        <div class="mp-dd" id="mp-dd-p"></div>
      </div>
      <div class="filter-sep"></div>
      <label>Ordenar</label>
      <div class="combo" id="combo-sort" style="min-width:160px;">
        <input class="combo-input" type="text" placeholder="Orden original" readonly onclick="openSimpleCombo('sort')" style="cursor:pointer;">
        <div class="combo-list" id="combo-list-sort"></div>
      </div>
      <div class="combo" id="combo-sortdir" style="min-width:50px;">
        <input class="combo-input" type="text" placeholder="&#8593;" readonly onclick="openSimpleCombo('sortdir')" style="cursor:pointer;text-align:center;padding:6px 8px;">
        <div class="combo-list" id="combo-list-sortdir"></div>
      </div>
      <div class="filter-sep"></div>
      <button class="gear-btn" onclick="openConfigModal()" title="Configurar valores">&#9881;</button>
      <div class="col-toggle-wrap">
        <button class="col-toggle-btn" onclick="toggleColDropdown()" title="Mostrar/ocultar columnas">&#9783; Columnas</button>
        <div class="col-toggle-dd" id="col-toggle-dd"></div>
      </div>
      <div class="filter-sep"></div>
      <button class="btn btn-sm btn-success" id="btn-validar-todas" onclick="validarTodas()" style="display:none;">&#10004; Validar todas</button>
      <button class="btn btn-sm btn-orange" id="btn-desvalidar-todas" onclick="desvalidarTodas()" style="display:none;">&#8617; Desvalidar todas</button>
      <span class="count" id="filter-count"></span>
    </div>
    <div class="card" style="padding:0; overflow:hidden;">
      <div class="table-wrap">
        <table><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody><tfoot id="table-foot"></tfoot></table>
      </div>
      <div id="pagination-bar" class="no-print" style="display:none;padding:12px 20px;align-items:center;justify-content:space-between;gap:16px;border-top:1px solid #eef0f4;flex-wrap:wrap;"></div>
    </div>
  </div>

  <!-- DETAIL (individual) -->
  <div class="screen" id="screen-detail">
    <button class="btn btn-outline no-print" style="margin-bottom:24px;" onclick="showScreen('list')">&#8592; Volver a la lista</button>
    <div id="detail-content"></div>
  </div>

  <!-- CONSOLIDATED: grid of alojamientos -->
  <div class="screen" id="screen-consol">
    <div class="page-header" style="margin-bottom:28px;">
      <h1>Liquidaciones por Alojamiento</h1>
      <p>Consolida las reservas validadas de cada alojamiento para generar la liquidación mensual</p>
    </div>
    <div class="stats-row" id="consol-stats"></div>
    <div class="card filters-bar" style="padding:12px 24px;">
      <div class="mp-wrap" id="mp-wrap-c">
        <button class="mp-btn" id="mp-btn-c" onclick="toggleMonthPicker('c')"><span class="mp-icon">&#128197;</span> <span id="mp-label-c">Todos los meses</span></button>
        <div class="mp-dd" id="mp-dd-c"></div>
      </div>
      <div class="filter-sep"></div>
      <label>Ordenar por</label>
      <div class="combo" id="combo-consolsort" style="min-width:190px;">
        <input class="combo-input" type="text" placeholder="Nombre A→Z" readonly onclick="openSimpleCombo('consolsort')" style="cursor:pointer;">
        <div class="combo-clear" onclick="clearSimpleCombo('consolsort')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-consolsort"></div>
      </div>
    </div>
    <div class="aloj-grid" id="aloj-grid"></div>
  </div>

  <!-- CONSOLIDATED DETAIL: one alojamiento -->
  <div class="screen" id="screen-consoldetail">
    <button class="btn btn-outline no-print" style="margin-bottom:24px;" onclick="showScreen('consol')">&#8592; Volver a alojamientos</button>
    <div id="consoldetail-content"></div>
  </div>
</div>

<!-- CONFIG MODAL -->
<div class="modal-overlay" id="config-modal" style="display:none;" onclick="if(event.target===this)closeConfigModal();">
  <div class="modal">
    <div class="modal-header">
      <h3>&#9881; Configurar Valores</h3>
      <button class="modal-close" onclick="closeConfigModal()">&#10005;</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab('tab-plat',this)">Com. Plataforma</button>
      <button class="modal-tab" onclick="switchTab('tab-pasarela',this)">Pasarela</button>
      <button class="modal-tab" onclick="switchTab('tab-otros',this)">GTC / Limpieza / IRPF</button>
    </div>
    <div class="modal-body">
      <div class="tab-panel active" id="tab-plat"></div>
      <div class="tab-panel" id="tab-pasarela"></div>
      <div class="tab-panel" id="tab-otros"></div>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════
// CONTROL DE VERSIONES
// ═══════════════════════════════════════════════════════════════
const APP_VERSION = '1.5.0';
const APP_BUILD   = '2026-02-09T18:00:00';
const APP_CHANGES = 'Escritura de validaciones en Google Sheets (columna Validada, sincronización inmediata)';

// Mostrar versión en sidebar
window.addEventListener('DOMContentLoaded', () => {
  const vl = document.getElementById('version-label');
  if (vl) vl.textContent = APP_VERSION;
});
function showVersionInfo() {
  const buildDate = new Date(APP_BUILD);
  const buildStr = buildDate.toLocaleDateString('es-ES', { day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' });
  alert('Liquidaciones — Gestión de Reservas\n\nVersión: ' + APP_VERSION + '\nBuild: ' + buildStr + '\nCambios: ' + APP_CHANGES);
}

// ═══ CONFIGURACIÁ“N GOOGLE — Sustituye con tus credenciales reales ═══
const GOOGLE_CLIENT_ID = '658971789892-cnsnbr36hus5jablgkuj2qk8ipic5ptf.apps.googleusercontent.com';
const GOOGLE_API_KEY   = 'AIzaSyAqn7NyL_QRC97KW-huBjzZjTLPGpEoT-k';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';

// ═══ GOOGLE STATE ═══
let _gapiInited = false, _gisInited = false, _googleToken = null, _tokenClient = null;
let _pickerInited = false;
let _sheetHistory = [];
try { const h = localStorage.getItem('gsheet-history'); if (h) _sheetHistory = JSON.parse(h); } catch(e) {}
let _defaultSheetUrl = null;
try { _defaultSheetUrl = localStorage.getItem('gsheet-default-url') || null; } catch(e) {}

function gapiLoaded() {
  gapi.load('client:picker', async () => {
    try {
      await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
      _gapiInited = true; _pickerInited = true;
      maybeEnableGoogleUI();
    } catch(e) { console.warn('gapi init error:', e); }
  });
}

function gisLoaded() {
  _tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID, scope: SCOPES, callback: onTokenResponse,
  });
  _gisInited = true;
  maybeEnableGoogleUI();
}

function maybeEnableGoogleUI() {
  if (_gapiInited && _gisInited) {
    renderSheetHistory();
    if (GOOGLE_CLIENT_ID === 'TU_CLIENT_ID.apps.googleusercontent.com') {
      const el = document.getElementById('gsheet-section');
      if (el) el.innerHTML = '<h3>&#128202; Google Sheets</h3>' +
        '<p style="color:#e53935;">Configura GOOGLE_CLIENT_ID y GOOGLE_API_KEY en el código para activar esta función. Consulta el README.md para instrucciones.</p>';
    }
  }
}

window.addEventListener('load', () => {
  if (typeof gapi !== 'undefined') gapiLoaded();
  else { const s = document.querySelector('script[src*="apis.google.com"]'); if (s) s.addEventListener('load', gapiLoaded); }
  if (typeof google !== 'undefined' && google.accounts) gisLoaded();
  else { const s = document.querySelector('script[src*="accounts.google.com"]'); if (s) s.addEventListener('load', () => setTimeout(gisLoaded, 100)); }
});

// ═══ GOOGLE AUTH ═══
function googleSignIn() {
  if (!_tokenClient) { alert('Google API no inicializada. Recarga la página.'); return; }
  if (_googleToken) { updateGoogleStatus(true); return; }
  _tokenClient.requestAccessToken({ prompt: '' });
}
function onTokenResponse(resp) {
  if (resp.error) { console.error('Auth error:', resp); return; }
  _googleToken = resp; updateGoogleStatus(true);
}
function googleSignOut() {
  if (_googleToken) { google.accounts.oauth2.revoke(_googleToken.access_token, () => {}); _googleToken = null; }
  updateGoogleStatus(false);
}
let _autoLoadAttempted = false;
function updateGoogleStatus(connected) {
  const statusEl = document.getElementById('gsheet-status');
  const labelEl = document.getElementById('gsheet-status-label');
  const btnC = document.getElementById('btn-google-connect');
  const btnD = document.getElementById('btn-google-disconnect');
  const picker = document.getElementById('gsheet-picker-area');
  const sidebar = document.getElementById('sidebar-google');
  const defaultArea = document.getElementById('gsheet-default-area');
  const noDefaultArea = document.getElementById('gsheet-no-default');
  if (connected) {
    statusEl.className = 'gsheet-status connected'; labelEl.textContent = 'Conectado con Google';
    btnC.style.display = 'none'; btnD.style.display = ''; picker.style.display = '';
    sidebar.style.display = 'block';
    document.getElementById('google-dot').className = 'status-dot on';
    document.getElementById('google-status-text').textContent = 'Google conectado';
    if (_defaultSheetUrl) {
      defaultArea.style.display = '';
      noDefaultArea.style.display = 'none';
      renderDefaultUrlDisplay();
      if (!_autoLoadAttempted && allReservas.length === 0) {
        _autoLoadAttempted = true;
        setTimeout(function() { autoLoadDefaultSheet(); }, 300);
      }
    } else {
      defaultArea.style.display = 'none';
      noDefaultArea.style.display = '';
    }
  } else {
    statusEl.className = 'gsheet-status disconnected'; labelEl.textContent = 'No conectado';
    btnC.style.display = ''; btnD.style.display = 'none'; picker.style.display = 'none';
    sidebar.style.display = 'none';
    defaultArea.style.display = 'none';
    noDefaultArea.style.display = 'none';
    document.getElementById('gsheet-autoload-status').style.display = 'none';
  }
  renderSheetHistory();
}

// ═══ DEFAULT SHEET URL MANAGEMENT ═══
function renderDefaultUrlDisplay() {
  var el = document.getElementById('default-url-display');
  if (!el || !_defaultSheetUrl) return;
  var short = _defaultSheetUrl.length > 80 ? _defaultSheetUrl.substring(0, 77) + '...' : _defaultSheetUrl;
  el.innerHTML = '<span style="color:#6b7280;font-size:12px;">URL:</span> ' + short;
}
function loadDefaultSheet() {
  if (!_defaultSheetUrl) return;
  var id = extractSheetId(_defaultSheetUrl);
  if (!id) { alert('La URL por defecto no es válida.'); return; }
  loadSheetById(id, 'Hoja por defecto');
}
function autoLoadDefaultSheet() {
  if (!_defaultSheetUrl || !_googleToken) return;
  var id = extractSheetId(_defaultSheetUrl);
  if (!id) return;
  var statusEl = document.getElementById('gsheet-autoload-status');
  statusEl.style.display = '';
  document.getElementById('autoload-status-text').textContent = 'Cargando hoja por defecto...';
  loadSheetById(id, 'Hoja por defecto');
}
function editDefaultUrl() {
  document.getElementById('default-url-display').style.display = 'none';
  document.getElementById('default-url-edit').style.display = '';
  document.getElementById('default-url-edit-input').value = _defaultSheetUrl || '';
  document.getElementById('default-url-edit-input').focus();
}
function cancelDefaultUrlEdit() {
  document.getElementById('default-url-display').style.display = '';
  document.getElementById('default-url-edit').style.display = 'none';
}
function saveDefaultUrlEdit() {
  var url = document.getElementById('default-url-edit-input').value.trim();
  if (!url) { alert('Introduce una URL válida.'); return; }
  var id = extractSheetId(url);
  if (!id) { alert('URL no válida. Debe ser una URL de Google Sheets.'); return; }
  _defaultSheetUrl = url;
  try { localStorage.setItem('gsheet-default-url', url); } catch(e) {}
  cancelDefaultUrlEdit();
  renderDefaultUrlDisplay();
  document.getElementById('gsheet-default-area').style.display = '';
  document.getElementById('gsheet-no-default').style.display = 'none';
}
function clearDefaultUrl() {
  if (!confirm('¿Quitar la hoja por defecto?')) return;
  _defaultSheetUrl = null;
  try { localStorage.removeItem('gsheet-default-url'); } catch(e) {}
  document.getElementById('gsheet-default-area').style.display = 'none';
  if (_googleToken) document.getElementById('gsheet-no-default').style.display = '';
}
function showSetDefaultUrl() {
  var form = document.getElementById('set-default-url-form');
  form.style.display = form.style.display === 'none' ? '' : 'none';
  if (form.style.display !== 'none') document.getElementById('set-default-url-input').focus();
}
function saveNewDefaultUrl() {
  var url = document.getElementById('set-default-url-input').value.trim();
  if (!url) { alert('Introduce una URL válida.'); return; }
  var id = extractSheetId(url);
  if (!id) { alert('URL no válida. Debe ser una URL de Google Sheets.'); return; }
  _defaultSheetUrl = url;
  try { localStorage.setItem('gsheet-default-url', url); } catch(e) {}
  document.getElementById('set-default-url-form').style.display = 'none';
  document.getElementById('set-default-url-input').value = '';
  document.getElementById('gsheet-no-default').style.display = 'none';
  document.getElementById('gsheet-default-area').style.display = '';
  renderDefaultUrlDisplay();
}

// ═══ GOOGLE PICKER ═══
function getAppId() {
  const m = GOOGLE_CLIENT_ID.match(/^(\d+)/);
  return m ? m[1] : '';
}
function openGooglePicker() {
  if (!_pickerInited || !_googleToken) { alert('Inicia sesión con Google primero.'); return; }
  const view = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS).setIncludeFolders(true).setSelectFolderEnabled(false);
  const sharedView = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS).setIncludeFolders(true).setOwnedByMe(false);
  const picker = new google.picker.PickerBuilder()
    .enableFeature(google.picker.Feature.NAV_HIDDEN)
    .setTitle('Selecciona la hoja de reservas')
    .addView(view).addView(sharedView)
    .setOAuthToken(_googleToken.access_token)
    .setDeveloperKey(GOOGLE_API_KEY)
    .setAppId(getAppId())
    .setCallback(onPickerCallback)
    .setSize(900, 550).build();
  picker.setVisible(true);
}
function onPickerCallback(data) {
  if (data.action === google.picker.Action.PICKED) {
    const doc = data.docs[0]; loadSheetById(doc.id, doc.name);
  }
}

// ═══ LOAD FROM URL ═══
function loadFromUrl() {
  const url = document.getElementById('gsheet-url-input').value.trim();
  if (!url) { alert('Pega la URL de la hoja de Google Sheets'); return; }
  const id = extractSheetId(url);
  if (!id) { alert('URL no válida. Debe ser una URL de Google Sheets.'); return; }
  loadSheetById(id, 'Google Sheet');
}
function extractSheetId(url) {
  const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  if (m) return m[1];
  if (/^[a-zA-Z0-9_-]{20,}$/.test(url)) return url;
  return null;
}

// ═══ LOAD SHEET DATA ═══
async function loadSheetById(sheetId, sheetName) {
  if (!_googleToken) { alert('Inicia sesión con Google primero.'); return; }
  showGSheetLoading('Obteniendo información de la hoja...');
  try {
    const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: sheetId, fields: 'properties.title,sheets.properties' });
    const title = meta.result.properties.title;
    const sheets = meta.result.sheets.map(s => ({ name: s.properties.title, index: s.properties.index }));
    if (sheets.length === 1) { await loadSheetData(sheetId, sheets[0].name, title); }
    else { hideGSheetLoading(); showSheetSelector(sheetId, sheets, title); }
  } catch(e) {
    hideGSheetLoading(); console.error('Error loading sheet:', e);
    alert(e.result && e.result.error ? 'Error: ' + e.result.error.message : 'Error al cargar la hoja. Verifica que tienes acceso.');
  }
}
function showSheetSelector(sheetId, sheets, title) {
  const sel = document.getElementById('gsheet-sheets-selector');
  const list = document.getElementById('gsheet-sheets-list');
  sel.style.display = '';
  list.innerHTML = '';
  sheets.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline btn-sm';
    btn.textContent = s.name;
    btn.addEventListener('click', () => selectSheetTab(sheetId, s.name, title + ' / ' + s.name));
    list.appendChild(btn);
  });
}
async function selectSheetTab(sheetId, sheetTab, title) {
  document.getElementById('gsheet-sheets-selector').style.display = 'none';
  await loadSheetData(sheetId, sheetTab, title + ' / ' + sheetTab);
}
async function loadSheetData(sheetId, sheetTab, displayName) {
  showGSheetLoading('Leyendo datos de "' + displayName + '"...');
  try {
    const range = sheetTab + '!A1:Z10000';
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: sheetId, range: range,
      valueRenderOption: 'UNFORMATTED_VALUE', dateTimeRenderOption: 'SERIAL_NUMBER'
    });
    const rows = resp.result.values;
    if (!rows || rows.length < 2) { hideGSheetLoading(); alert('La hoja está vacía o no tiene datos suficientes.'); return; }
    showGSheetLoading('Procesando ' + (rows.length - 1) + ' filas...');
    if (!processRows(rows)) { hideGSheetLoading(); return; }

    // Set up sheet source for write-back
    const valColIdx = processRows._lastValColIdx;
    const headerRowIdx = processRows._lastHeaderRow;
    await setupSheetSource(sheetId, sheetTab, headerRowIdx, valColIdx);

    addToSheetHistory(sheetId, displayName, sheetTab);
    document.getElementById("file-name").textContent = '\u{1F4CA} ' + displayName;
    document.getElementById("file-indicator").style.display = "block";
    document.getElementById("nav-consol").style.display = "block";
    updateSyncIndicator('idle');
    hideGSheetLoading(); showScreen("list"); renderTable();
  } catch(e) {
    hideGSheetLoading(); console.error('Error reading sheet data:', e);
    alert(e.result && e.result.error ? 'Error: ' + e.result.error.message : 'Error al leer los datos de la hoja.');
  }
}

// ═══ LOADING UI ═══
function showGSheetLoading(text) { document.getElementById('gsheet-loading').style.display = 'flex'; document.getElementById('gsheet-loading-text').textContent = text || 'Cargando...'; }
function hideGSheetLoading() { document.getElementById('gsheet-loading').style.display = 'none'; document.getElementById('gsheet-autoload-status').style.display = 'none'; }

// ═══ SHEET WRITE-BACK: Validation column ═══
function colIndexToLetter(idx) {
  let s = '';
  idx = Math.max(0, idx);
  while (true) {
    s = String.fromCharCode(65 + (idx % 26)) + s;
    idx = Math.floor(idx / 26) - 1;
    if (idx < 0) break;
  }
  return s;
}

async function setupSheetSource(sheetId, sheetTab, headerRowIdx, valColIdx) {
  if (valColIdx !== null) {
    // Column already exists
    _sheetSource = {
      id: sheetId,
      tab: sheetTab,
      valColIdx: valColIdx,
      valColLetter: colIndexToLetter(valColIdx),
      headerRow: headerRowIdx
    };
    console.log('[Sync] Validation column found at ' + _sheetSource.valColLetter + ' (index ' + valColIdx + ')');
    return;
  }

  // Column doesn't exist — create it after the last used column
  // Find the max column used in header row
  const headerResp = await gapi.client.sheets.spreadsheets.values.get({
    spreadsheetId: sheetId,
    range: sheetTab + '!' + (headerRowIdx + 1) + ':' + (headerRowIdx + 1),
    valueRenderOption: 'UNFORMATTED_VALUE'
  });
  const headerVals = (headerResp.result.values && headerResp.result.values[0]) || [];
  const newColIdx = headerVals.length; // next empty column
  const newColLetter = colIndexToLetter(newColIdx);

  // Write the header "Validada"
  await gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId: sheetId,
    range: sheetTab + '!' + newColLetter + (headerRowIdx + 1),
    valueInputOption: 'RAW',
    resource: { values: [['Validada']] }
  });

  _sheetSource = {
    id: sheetId,
    tab: sheetTab,
    valColIdx: newColIdx,
    valColLetter: newColLetter,
    headerRow: headerRowIdx
  };
  console.log('[Sync] Created validation column at ' + newColLetter + ' (index ' + newColIdx + ')');
}

async function writeValidationToSheet(reservaIdx, isValidated) {
  if (!_sheetSource || !_googleToken) return;
  const r = allReservas[reservaIdx];
  if (!r) return;
  const cell = _sheetSource.tab + '!' + _sheetSource.valColLetter + r._sheetRow;
  const value = isValidated ? 'Sí' : '';
  updateSyncIndicator('syncing');
  try {
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: _sheetSource.id,
      range: cell,
      valueInputOption: 'RAW',
      resource: { values: [[value]] }
    });
    updateSyncIndicator('saved');
    console.log('[Sync] Wrote ' + (isValidated ? 'Sí' : '(empty)') + ' to ' + cell);
  } catch(e) {
    console.error('[Sync] Error writing to ' + cell + ':', e);
    updateSyncIndicator('error');
  }
}

async function batchWriteValidation(reservaIndices, isValidated) {
  if (!_sheetSource || !_googleToken || reservaIndices.length === 0) return;
  updateSyncIndicator('syncing');
  const value = isValidated ? 'Sí' : '';
  const data = reservaIndices.map(idx => {
    const r = allReservas[idx];
    if (!r) return null;
    return {
      range: _sheetSource.tab + '!' + _sheetSource.valColLetter + r._sheetRow,
      values: [[value]]
    };
  }).filter(Boolean);

  if (data.length === 0) { updateSyncIndicator('idle'); return; }

  try {
    await gapi.client.sheets.spreadsheets.values.batchUpdate({
      spreadsheetId: _sheetSource.id,
      resource: {
        valueInputOption: 'RAW',
        data: data
      }
    });
    updateSyncIndicator('saved');
    console.log('[Sync] Batch wrote ' + data.length + ' cells (' + (isValidated ? 'validar' : 'desvalidar') + ')');
  } catch(e) {
    console.error('[Sync] Batch write error:', e);
    updateSyncIndicator('error');
  }
}

// Sync status indicator
function updateSyncIndicator(state) {
  const el = document.getElementById('sync-indicator');
  if (!el) return;
  if (!_sheetSource) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  const dot = el.querySelector('.sync-dot');
  const text = el.querySelector('.sync-text');
  switch(state) {
    case 'syncing':
      dot.className = 'sync-dot syncing';
      text.textContent = 'Guardando...';
      break;
    case 'saved':
      dot.className = 'sync-dot saved';
      text.textContent = 'Guardado';
      // Fade back to idle after 2s
      clearTimeout(el._fadeTimer);
      el._fadeTimer = setTimeout(() => updateSyncIndicator('idle'), 2500);
      break;
    case 'error':
      dot.className = 'sync-dot error';
      text.textContent = 'Error al guardar';
      clearTimeout(el._fadeTimer);
      el._fadeTimer = setTimeout(() => updateSyncIndicator('idle'), 5000);
      break;
    default: // idle
      dot.className = 'sync-dot idle';
      text.textContent = 'Sincronizado';
      break;
  }
}

// ═══ SHEET HISTORY ═══
function addToSheetHistory(sheetId, name, sheetTab) {
  _sheetHistory = _sheetHistory.filter(h => h.id !== sheetId || h.tab !== sheetTab);
  _sheetHistory.unshift({ id: sheetId, name, tab: sheetTab, date: new Date().toISOString() });
  if (_sheetHistory.length > 10) _sheetHistory = _sheetHistory.slice(0, 10);
  try { localStorage.setItem('gsheet-history', JSON.stringify(_sheetHistory)); } catch(e) {}
  renderSheetHistory();
}
function removeFromHistory(idx) {
  _sheetHistory.splice(idx, 1);
  try { localStorage.setItem('gsheet-history', JSON.stringify(_sheetHistory)); } catch(e) {}
  renderSheetHistory();
}
function renderSheetHistory() {
  const container = document.getElementById('gsheet-history');
  const list = document.getElementById('gsheet-history-list');
  if (!container || !list) return;
  if (!_sheetHistory.length) { container.style.display = 'none'; return; }
  container.style.display = '';
  list.innerHTML = '';
  _sheetHistory.forEach((h, i) => {
    const d = new Date(h.date);
    const dateStr = d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' });
    const canLoad = !!_googleToken;
    const item = document.createElement('div');
    item.className = 'gsheet-history-item';
    if (!canLoad) item.style.cssText = 'opacity:0.5;cursor:default;';
    item.innerHTML = '<div><div class="name">&#128202; ' + (h.name || h.id) + '</div><div class="meta">' + dateStr + (h.tab ? ' &middot; ' + h.tab : '') + '</div></div>';
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.title = 'Eliminar';
    removeBtn.innerHTML = '&#10005;';
    removeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeFromHistory(i); });
    item.appendChild(removeBtn);
    if (canLoad) {
      item.addEventListener('click', () => loadSheetById(h.id, h.name || h.id));
    }
    list.appendChild(item);
  });
}

// ══════════════════════════════════════════════════
// APP ORIGINAL
// ══════════════════════════════════════════════════

const IVA_RESERVA = 0.10, IVA_SUBTOTAL = 0.21;
let AMENITIES = 7;

let platformOptions = {
  "Airbnb.com": [15.5], "Booking.com": [15, 17, 22], "Caddie Golf": [10],
  "Comercial": [10], "De Propietario": [0], "Frontex": [10],
  "Granadabeachgolf.com": [10], "Homeaway.com": [15], "Sport2event SL": [10],
};
let pasarelaStripeOptions = [1.3];
let pasarelaBookingOptions = [1.5];
let cleaningOptions = [100, 120];
let irpfOptions = [19, 24];
let gtcOptions = [20];

let allReservas = [], settings = {}, validated = new Set(), _lastFiltered = [];
let currentConsolAloj = null, currentDetailIdx = null;
// Google Sheets write-back state
let _sheetSource = null; // { id, tab, valColIdx, valColLetter, headerRow } – null when loaded from file
let _syncQueue = []; // pending write operations
let _syncActive = false; // true while a write is in flight
// Performance: liquidation cache + pagination + render debouncing
let _pageSize = 100;
let _liqCache = {}, _currentPage = 1, _fmtCache = {};
function invalidateCache(idx) { if (idx !== undefined) { delete _liqCache[idx]; } else { _liqCache = {}; invalidateGlobalStats(); invalidateFilterCache(); } }
function getLiq(r) {
  const idx = r.idx;
  if (_liqCache[idx]) return _liqCache[idx];
  _liqCache[idx] = calcLiquidacion(r, settings[idx] || {});
  return _liqCache[idx];
}
// Debounced render via requestAnimationFrame - coalesces multiple renderTable calls into one frame
let _renderRafId = 0, _renderMode = 'full'; // 'full' | 'append'
function scheduleRender(mode) {
  // 'full' overrides 'append'; 'append' only if no pending full
  if (mode === 'full' || _renderMode === 'full') _renderMode = 'full';
  else _renderMode = mode || 'full';
  if (_renderRafId) return; // already scheduled
  _renderRafId = requestAnimationFrame(() => {
    _renderRafId = 0;
    const m = _renderMode; _renderMode = 'full';
    if (m === 'append') _renderPageOnly();
    else _renderFull();
  });
}
// Cached filter+sort result — invalidated on filter/sort/data changes, NOT on pagination
let _cachedFiltered = null, _filterSortKey = '', _validatedVersion = 0;
function getFilterSortKey() {
  const pKey = [...comboState.platform.selected].sort().join(',') || 'all';
  const aKey = [...comboState.aloj.selected].sort().join(',') || 'all';
  return pKey + '|' + aKey + '|' + _mpYear + '|' + _mpMonth + '|' +
    simpleComboState.status.value + '|' + simpleComboState.sort.value + '|' +
    simpleComboState.sortdir.value + '|' + _validatedVersion + '|' + allReservas.length;
}
function invalidateFilterCache() { _cachedFiltered = null; _filterSortKey = ''; _cachedFilteredStats = null; }
function getFilteredSorted() {
  const key = getFilterSortKey();
  if (_cachedFiltered && _filterSortKey === key) return _cachedFiltered;
  const pSel = comboState.platform.selected, aSel = comboState.aloj.selected;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value, sortD = simpleComboState.sortdir.value;
  let fil = allReservas.filter(r => {
    if (pSel.size > 0 && !pSel.has(r.plataforma)) return false;
    if (aSel.size > 0 && !aSel.has(r.alojamiento)) return false;
    if (_mpYear !== null && r._dEntrada) {
      if (r._dEntrada.getFullYear() !== _mpYear) return false;
      if (_mpMonth !== null && r._dEntrada.getMonth() !== _mpMonth) return false;
    } else if (_mpYear !== null && !r._dEntrada) return false;
    if (sf2 === "validated" && !validated.has(r.idx)) return false;
    if (sf2 === "pending" && validated.has(r.idx)) return false;
    return true;
  });
  fil.sort((a, b) => {
    let va = getSortValue(a, sortF), vb = getSortValue(b, sortF);
    if (typeof va === "string") return sortD === "asc" ? va.localeCompare(vb) : vb.localeCompare(va);
    return sortD === "asc" ? va - vb : vb - va;
  });
  _cachedFiltered = fil;
  _filterSortKey = key;
  return fil;
}
// Pre-computed select option strings (rebuilt when config changes)
let _selectCache = {};
function rebuildSelectCache() {
  _selectCache = {};
  // Platform options per platform name
  Object.keys(platformOptions).forEach(name => {
    const opts = platformOptions[name];
    _selectCache['plat_' + name] = opts.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  });
  // GTC
  _selectCache.gtc = gtcOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  // Cleaning
  _selectCache.clean = cleaningOptions.map(o => `<option value="${o}">${o} €</option>`).join('');
  // IRPF
  _selectCache.irpf = irpfOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  // Pasarela
  _selectCache.pasStripe = pasarelaStripeOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  _selectCache.pasBooking = pasarelaBookingOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
}
function selectWithValue(html, val) {
  // Set selected on matching option via string replace (fast)
  const needle = `value="${val}"`;
  return html.replace(needle, needle + ' selected');
}
function selectCleanWithValue(html, val) {
  const needle = `value="${val}"`;
  return html.replace(needle, needle + ' selected');
}

// Fast number formatter (avoid toLocaleString which is ~50x slower)
function fmt(n) {
  const fixed = Math.abs(n).toFixed(2);
  const [int, dec] = fixed.split('.');
  // Add thousands separator (dot for es-ES)
  let result = '';
  for (let i = int.length - 1, c = 0; i >= 0; i--, c++) {
    if (c > 0 && c % 3 === 0) result = '.' + result;
    result = int[i] + result;
  }
  if (n < 0) result = '-' + result;
  return result + ',' + dec;
}
// Fast date formatter (avoid toLocaleDateString)
function fmtDate(d) {
  if (!d) return '—';
  const dd = d.getDate(), mm = d.getMonth() + 1, yy = d.getFullYear();
  return (dd < 10 ? '0' : '') + dd + '/' + (mm < 10 ? '0' : '') + mm + '/' + yy;
}
function parseDate(val) {
  if (!val) return null;
  if (val instanceof Date) return val;
  if (typeof val === "number") return new Date((val - 25569) * 86400000);
  const s = String(val).trim();
  // DD/MM/YYYY or DD/MM/YY
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (m) { const y = m[3].length === 2 ? 2000 + parseInt(m[3]) : parseInt(m[3]); return new Date(y, parseInt(m[2])-1, parseInt(m[1])); }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function formatDate(val) {
  const d = parseDate(val);
  return d ? fmtDate(d) : (val ? String(val) : "—");
}
function dateToNum(val) { const d = parseDate(val); return d ? d.getTime() : 0; }
function calcNights(e, s) {
  const a = parseDate(e), b = parseDate(s);
  if (!a || !b) return 0; return Math.max(0, Math.round((b - a) / 86400000));
}
function parseNum(v) {
  if (typeof v === "number") return v;
  if (!v) return 0;
  const s = String(v).trim();
  // Spanish format: 1.400,00 → remove dots, replace comma with dot
  if (s.includes(",")) return parseFloat(s.replace(/\./g, "").replace(",", ".")) || 0;
  return parseFloat(s) || 0;
}
function getDefaultForPlatform(plat) { const o = platformOptions[plat]; return o && o.length ? o[0] / 100 : 0.10; }

function calcLiquidacion(r, s) {
  const total = r.totalReserva, baseSinIVA = total / (1 + IVA_RESERVA);
  let comRate = s.comPlataforma !== undefined ? s.comPlataforma : getDefaultForPlatform(r.plataforma);
  const comPlat = total * comRate;
  const gtcRate = s.comGTC !== undefined ? s.comGTC : gtcOptions[0]/100;
  const comGTC = baseSinIVA * gtcRate;
  let comPas = 0;
  if (s.pasarela) {
    const isB = r.plataforma === "Booking.com";
    const pr = s.pasarelaRate !== undefined ? s.pasarelaRate : (isB ? pasarelaBookingOptions[0]/100 : pasarelaStripeOptions[0]/100);
    comPas = total * pr;
  }
  const limp = s.limpieza || cleaningOptions[0];
  const sub = baseSinIVA - comPlat - comGTC - comPas - limp - AMENITIES;
  const iva = sub * IVA_SUBTOTAL, irpfRate = s.irpf || irpfOptions[0]/100, ret = sub * irpfRate;
  return { total, baseSinIVA, comRate, comPlat, gtcRate, comGTC, comPas, limp, sub, iva, irpfRate, ret, totalLiq: sub + iva - ret };
}

// ─── FILE ───
function isHtmlFile(buf) {
  // Detect HTML-based .xls (Avantio exports): first bytes contain "<html" or start with whitespace+<
  const head = new TextDecoder("utf-8").decode(buf.slice(0, 200)).trim().toLowerCase();
  return head.startsWith("<html") || head.startsWith("<!doctype") || head.includes("<html");
}

function parseHtmlXls(text) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(text, "text/html");
  const trs = doc.querySelectorAll("table tr");
  const json = [];
  trs.forEach(tr => {
    const cells = [];
    tr.querySelectorAll("td, th").forEach(td => cells.push(td.textContent.trim()));
    json.push(cells);
  });
  return json;
}

function processRows(json) {
  const headerRow = json.findIndex(r => r && r[0] && String(r[0]).includes("ID Reserva"));
  if (headerRow === -1) { alert("No se encontró la cabecera 'ID Reserva'."); return false; }

  // Detect validation column in header
  const hdr = json[headerRow];
  let detectedValColIdx = null;
  for (let c = 0; c < (hdr ? hdr.length : 0); c++) {
    const h = String(hdr[c] || '').trim().toLowerCase();
    if (h === 'validada' || h === 'validado' || h === 'validated') { detectedValColIdx = c; break; }
  }

  // Build rows preserving original json row index (for sheet write-back)
  const dataStart = headerRow + 1;
  const allDataRows = json.slice(dataStart);
  const rowEntries = [];
  allDataRows.forEach((row, localIdx) => {
    if (row && row[0] && String(row[0]).trim().toLowerCase() !== 'total') {
      rowEntries.push({ data: row, jsonRow: dataStart + localIdx });
    }
  });

  allReservas = rowEntries.map((entry, idx) => {
    const row = entry.data;
    const r = {
      id: String(row[0]||""), localizador: String(row[1]||""), fechaAlta: row[2],
      alojamiento: String(row[3]||""), edificio: String(row[4]||""),
      plataforma: String(row[5]||"").trim() || "Granadabeachgolf.com",
      atendidoPor: String(row[6]||""), origenMarketing: String(row[7]||""),
      cliente: String(row[8]||""),
      tipoReserva: String(row[9]||""), fechaEntrada: row[10], fechaSalida: row[11],
      totalReserva: parseNum(row[12]), observacion: String(row[13]||""), idx,
      _sheetRow: entry.jsonRow + 1, // 1-indexed row in spreadsheet
    };
    const dE = parseDate(r.fechaEntrada), dS = parseDate(r.fechaSalida);
    const dA = parseDate(r.fechaAlta);
    r._dEntrada = dE; r._dSalida = dS; r._dAlta = dA;
    r._fmtEntrada = dE ? fmtDate(dE) : '—';
    r._fmtSalida = dS ? fmtDate(dS) : '—';
    r._fmtAlta = dA ? fmtDate(dA) : '—';
    r._dateNum = dE ? dE.getTime() : 0;
    r._dateAltaNum = dA ? dA.getTime() : 0;
    r._nights = (dE && dS) ? Math.max(0, Math.round((dS - dE) / 86400000)) : 0;
    r._clienteLc = (r.cliente||"").toLowerCase();
    r._alojLc = (r.alojamiento||"").toLowerCase();
    r._platLc = (r.plataforma||"").toLowerCase();
    r._isBooking = r.plataforma === "Booking.com";
    return r;
  });
  settings = {}; validated = new Set();
  allReservas.forEach(r => {
    const isB = r.plataforma === "Booking.com";
    if (!platformOptions[r.plataforma]) platformOptions[r.plataforma] = [10];
    settings[r.idx] = {
      comPlataforma: getDefaultForPlatform(r.plataforma), comGTC: gtcOptions[0]/100,
      limpieza: cleaningOptions[0], irpf: irpfOptions[0]/100, pasarela: false,
      pasarelaRate: isB ? pasarelaBookingOptions[0]/100 : pasarelaStripeOptions[0]/100,
    };
  });

  // Read validation state from sheet if column exists
  if (detectedValColIdx !== null) {
    allReservas.forEach((r, idx) => {
      const val = String(rowEntries[idx].data[detectedValColIdx] || '').trim().toLowerCase();
      if (val && (val === 'sí' || val === 'si' || val === 'yes' || val === '1' || val === 'true' || val === 'x')) {
        validated.add(r.idx);
      }
    });
  }

  // Store metadata for sheet source setup (used by loadSheetData)
  processRows._lastValColIdx = detectedValColIdx;
  processRows._lastHeaderRow = headerRow;

  const plats = [...new Set(allReservas.map(r => r.plataforma))].sort();
  populateCombo('platform', plats);
  const alojs = [...new Set(allReservas.map(r => r.alojamiento))].sort();
  populateCombo('aloj', alojs);
  buildAvailableMonths();
  invalidateCache();
  invalidateAlojCache();
  rebuildSelectCache();
  _currentPage = 1;
  return true;
}

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const buf = new Uint8Array(e.target.result);
    let json;
    if (isHtmlFile(buf)) {
      // HTML-based .xls (Avantio): parse as HTML to preserve original text values
      const text = new TextDecoder("utf-8").decode(buf);
      json = parseHtmlXls(text);
    } else {
      // Real .xlsx: use SheetJS
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      json = XLSX.utils.sheet_to_json(ws, { header: 1 });
    }
    if (!processRows(json)) return;
    _sheetSource = null; // not loaded from Google Sheets
    document.getElementById("file-name").textContent = file.name;
    document.getElementById("file-indicator").style.display = "block";
    document.getElementById("nav-consol").style.display = "block";
    showScreen("list"); renderTable();
  };
  reader.readAsArrayBuffer(file);
}

let _navigating = false;
function showScreen(name) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
  document.getElementById("screen-" + name).classList.add("active");
  document.getElementById("nav-" + name).classList.add("active");
  if (_previewActive) exitPreview();
  if (_navigating) return;
  _navigating = true;
  if (name === "list") renderTable();
  if (name === "consol") renderConsolGrid();
  if (name === "consoldetail" && currentConsolAloj) viewConsolDetail(currentConsolAloj);
  if (name === "detail" && currentDetailIdx !== null) viewDetail(currentDetailIdx);
  _navigating = false;
}

// ─── TABLE ───
const COLUMNS = [
  { key:"estado",label:"Estado",sortable:true,locked:true },
  { key:"idReserva",label:"ID Reserva",sortable:true },
  { key:"localizador",label:"Localizador",sortable:true },
  { key:"fechaAlta",label:"Fecha Alta",sortable:true },
  { key:"cliente",label:"Cliente",sortable:true },
  { key:"alojamiento",label:"Alojamiento",sortable:true },
  { key:"edificio",label:"Edificio",sortable:true },
  { key:"plataforma",label:"Plataforma",sortable:true },
  { key:"atendidoPor",label:"Atendido por",sortable:true },
  { key:"origenMarketing",label:"Origen Mkt.",sortable:true },
  { key:"tipoReserva",label:"Tipo Reserva",sortable:true },
  { key:"fechaEntrada",label:"F. Entrada",sortable:true },
  { key:"fechaSalida",label:"F. Salida",sortable:true },
  { key:"noches",label:"Noch.",sortable:true },
  { key:"totalReserva",label:"Total Res.",sortable:true,right:true },
  { key:"baseSinIVA",label:"Base s/IVA",sortable:true,right:true },
  { key:"comPlataforma",label:"Com. Plat.",sortable:false },
  { key:"comGTC",label:"Com. GTC",sortable:false },
  { key:"limpieza",label:"Limpieza",sortable:false },
  { key:"amenities",label:"Amenities",sortable:false },
  { key:"pasarela",label:"Pasarela",sortable:false },
  { key:"subtotal",label:"Subtotal",sortable:true,right:true },
  { key:"irpf",label:"IRPF",sortable:false },
  { key:"iva21",label:"IVA 21%",sortable:false },
  { key:"totalLiquidar",label:"A Liquidar",sortable:true,right:true,locked:true },
  { key:"observacion",label:"Observación",sortable:true },
  { key:"acciones",label:"",sortable:false,locked:true },
];
// Column visibility state
let colVisibility = {};
COLUMNS.forEach(c => { colVisibility[c.key] = true; });
// Hidden by default
colVisibility['irpf'] = false;
colVisibility['iva21'] = false;
colVisibility['subtotal'] = false;
colVisibility['idReserva'] = false;
colVisibility['localizador'] = false;
colVisibility['fechaAlta'] = false;
colVisibility['edificio'] = false;
colVisibility['atendidoPor'] = false;
colVisibility['origenMarketing'] = false;
colVisibility['tipoReserva'] = false;
colVisibility['observacion'] = false;
function isColVisible(key) { return colVisibility[key] !== false; }
function toggleColVisibility(key) {
  const col = COLUMNS.find(c => c.key === key);
  if (col && col.locked) return;
  colVisibility[key] = !colVisibility[key];
  updateColStyles(); renderTable(); renderColToggle();
}
function updateColStyles() {
  let css = '';
  COLUMNS.forEach(c => {
    if (!isColVisible(c.key)) css += '.col-' + c.key + ' { display: none !important; }\n';
  });
  document.getElementById('col-visibility-style').textContent = css;
}
function renderColToggle() {
  const dd = document.getElementById('col-toggle-dd');
  dd.innerHTML = COLUMNS.filter(c => c.label).map(c => {
    const checked = isColVisible(c.key) ? 'checked' : '';
    const locked = c.locked ? 'locked' : '';
    const dis = c.locked ? 'disabled' : '';
    return '<label class="col-toggle-item ' + locked + '"><input type="checkbox" ' + checked + ' ' + dis +
      ' onchange="toggleColVisibility(\'' + c.key + '\')"> ' + c.label + '</label>';
  }).join('');
}
function toggleColDropdown() {
  const dd = document.getElementById('col-toggle-dd');
  const isOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!isOpen) renderColToggle();
}

// ─── CONSOLIDATED TABLE: columns, sort, visibility ───
const CONSOL_COLUMNS = COLUMNS.filter(c => c.key !== 'alojamiento');
let consolColVis = {};
CONSOL_COLUMNS.forEach(c => { consolColVis[c.key] = true; });
consolColVis['irpf'] = false;
consolColVis['iva21'] = false;
consolColVis['subtotal'] = false;
consolColVis['idReserva'] = false;
consolColVis['localizador'] = false;
consolColVis['fechaAlta'] = false;
consolColVis['edificio'] = false;
consolColVis['atendidoPor'] = false;
consolColVis['origenMarketing'] = false;
consolColVis['tipoReserva'] = false;
consolColVis['observacion'] = false;
let consolSortF = 'idx', consolSortD = 'asc';
// Apply initial col visibility
setTimeout(updateConsolColStyles, 0);
setTimeout(updateColStyles, 0);

function isConsolColVis(key) { return consolColVis[key] !== false; }
function toggleConsolColVis(key) {
  const col = CONSOL_COLUMNS.find(c => c.key === key);
  if (col && col.locked) return;
  consolColVis[key] = !consolColVis[key];
  updateConsolColStyles();
}
function updateConsolColStyles() {
  let css = '';
  CONSOL_COLUMNS.forEach(c => {
    if (!isConsolColVis(c.key)) css += '.cc-' + c.key + ' { display: none !important; }\n';
  });
  document.getElementById('consol-col-visibility-style').textContent = css;
}
function renderConsolColToggle() {
  const dd = document.getElementById('consol-col-toggle-dd');
  if (!dd) return;
  dd.innerHTML = CONSOL_COLUMNS.filter(c => c.label).map(c => {
    const checked = isConsolColVis(c.key) ? 'checked' : '';
    const locked = c.locked ? 'locked' : '';
    const dis = c.locked ? 'disabled' : '';
    return '<label class="col-toggle-item ' + locked + '"><input type="checkbox" ' + checked + ' ' + dis +
      ' onchange="toggleConsolColVis(\'' + c.key + '\')"> ' + c.label + '</label>';
  }).join('');
}
function toggleConsolColDropdown() {
  const dd = document.getElementById('consol-col-toggle-dd');
  const isOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!isOpen) renderConsolColToggle();
}
function consolSortByColumn(f) {
  if (consolSortF === f) { consolSortD = consolSortD === 'asc' ? 'desc' : 'asc'; }
  else { consolSortF = f; consolSortD = 'asc'; }
  if (currentConsolAloj) viewConsolDetail(currentConsolAloj);
}
function consolGetSortValue(x, f) {
  const r = x.r, c = x.c;
  switch(f) {
    case "estado": return validated.has(r.idx)?1:0;
    case "idReserva": return r.id.toLowerCase();
    case "localizador": return r.localizador.toLowerCase();
    case "fechaAlta": return r._dateAltaNum;
    case "cliente": return r._clienteLc;
    case "edificio": return (r.edificio||"").toLowerCase();
    case "plataforma": return r._platLc;
    case "atendidoPor": return (r.atendidoPor||"").toLowerCase();
    case "origenMarketing": return (r.origenMarketing||"").toLowerCase();
    case "tipoReserva": return (r.tipoReserva||"").toLowerCase();
    case "fechaEntrada": return r._dateNum;
    case "fechaSalida": return r._dSalida ? r._dSalida.getTime() : 0;
    case "noches": return r._nights;
    case "totalReserva": return r.totalReserva;
    case "baseSinIVA": return c.baseSinIVA;
    case "subtotal": return c.sub;
    case "totalLiquidar": return c.totalLiq;
    case "observacion": return (r.observacion||"").toLowerCase();
    default: return r.idx;
  }
}
function getSortValue(r, f) {
  const c = getLiq(r);
  switch(f) {
    case "estado": return validated.has(r.idx)?1:0;
    case "idReserva": return r.id.toLowerCase();
    case "localizador": return r.localizador.toLowerCase();
    case "fechaAlta": return r._dateAltaNum;
    case "cliente": return r._clienteLc;
    case "alojamiento": return r._alojLc;
    case "edificio": return (r.edificio||"").toLowerCase();
    case "plataforma": return r._platLc;
    case "atendidoPor": return (r.atendidoPor||"").toLowerCase();
    case "origenMarketing": return (r.origenMarketing||"").toLowerCase();
    case "tipoReserva": return (r.tipoReserva||"").toLowerCase();
    case "fechaEntrada": return r._dateNum;
    case "fechaSalida": return r._dSalida ? r._dSalida.getTime() : 0;
    case "noches": return r._nights;
    case "totalReserva": return r.totalReserva;
    case "baseSinIVA": return c.baseSinIVA;
    case "subtotal": return c.sub;
    case "totalLiquidar": return c.totalLiq;
    case "observacion": return (r.observacion||"").toLowerCase();
    default: return r.idx;
  }
}
function sortByColumn(f) {
  const sortInput = document.querySelector('#combo-sort .combo-input');
  const sortWrap = document.getElementById('combo-sort');
  const dirInput = document.querySelector('#combo-sortdir .combo-input');
  const dirWrap = document.getElementById('combo-sortdir');
  if(simpleComboState.sort.value===f) {
    const nv = simpleComboState.sortdir.value==="asc"?"desc":"asc";
    simpleComboState.sortdir.value = nv;
    if (nv==='asc') { dirInput.value=''; dirInput.placeholder='\u2191'; dirWrap.classList.remove('has-value'); }
    else { dirInput.value='\u2193'; dirWrap.classList.add('has-value'); }
  } else {
    simpleComboState.sort.value = f;
    const opt = simpleComboOptions.sort.find(o=>o.value===f);
    if (f==='idx') { sortInput.value=''; sortInput.placeholder='Orden original'; sortWrap.classList.remove('has-value'); }
    else { sortInput.value=opt?opt.label:f; sortWrap.classList.add('has-value'); }
    simpleComboState.sortdir.value = 'asc';
    dirInput.value=''; dirInput.placeholder='\u2191'; dirWrap.classList.remove('has-value');
  }
  _currentPage = 1;
  renderTable();
}

// Global stats cache (recomputed only when needed)
let _globalStatsCache = null;
function getGlobalStats() {
  if (_globalStatsCache) return _globalStatsCache;
  let tR = 0, tL = 0;
  for (let i = 0; i < allReservas.length; i++) {
    const r = allReservas[i];
    tR += r.totalReserva;
    tL += getLiq(r).totalLiq;
  }
  _globalStatsCache = { tR, tL };
  return _globalStatsCache;
}
function invalidateGlobalStats() { _globalStatsCache = null; }

function renderTable() { _renderFull(); }

function _buildRowHtml(r) {
  const s = settings[r.idx] || {}, c = getLiq(r), isV = validated.has(r.idx), isB = r._isBooking, dis = isV ? "disabled" : "";
  const pO = selectWithValue(_selectCache['plat_' + r.plataforma] || '<option>10%</option>', s.comPlataforma);
  const gO = selectWithValue(_selectCache.gtc, s.comGTC);
  const cO = selectCleanWithValue(_selectCache.clean, s.limpieza);
  const iO = selectWithValue(_selectCache.irpf, s.irpf);
  const psO = selectWithValue(isB ? _selectCache.pasBooking : _selectCache.pasStripe, s.pasarelaRate);
  return `<tr ${isV ? 'class="validated"' : ''} id="row-${r.idx}">
    <td class="col-estado">${isV ? '<span class="badge badge-green">&#10003; Validada</span>' : '<span class="badge badge-amber">Pendiente</span>'}</td>
    <td class="col-idReserva muted" style="font-size:12px;">${r.id}</td>
    <td class="col-localizador muted" style="font-size:11px;max-width:120px;overflow:hidden;text-overflow:ellipsis;">${r.localizador}</td>
    <td class="col-fechaAlta muted" style="font-size:12px;">${r._fmtAlta}</td>
    <td class="col-cliente bold ellip">${r.cliente}</td>
    <td class="col-alojamiento ellip muted">${r.alojamiento}</td>
    <td class="col-edificio ellip muted" style="font-size:12px;">${r.edificio}</td>
    <td class="col-plataforma"><span class="badge ${isB ? 'badge-purple' : 'badge-blue'}">${r.plataforma}</span></td>
    <td class="col-atendidoPor ellip muted" style="font-size:12px;">${r.atendidoPor}</td>
    <td class="col-origenMarketing ellip muted" style="font-size:12px;">${r.origenMarketing}</td>
    <td class="col-tipoReserva muted" style="font-size:12px;">${r.tipoReserva}</td>
    <td class="col-fechaEntrada" style="font-size:12px;white-space:nowrap;">${r._fmtEntrada}</td>
    <td class="col-fechaSalida" style="font-size:12px;white-space:nowrap;">${r._fmtSalida}</td>
    <td class="col-noches" style="text-align:center">${r._nights}</td>
    <td class="col-totalReserva right bold">${fmt(r.totalReserva)} &#8364;</td>
    <td class="col-baseSinIVA right" style="color:#6b7280;font-size:12px;">${fmt(c.baseSinIVA)} &#8364;</td>
    <td class="col-comPlataforma" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'comPlataforma',parseFloat(this.value))" ${dis}>${pO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPlat)} &#8364;</span></div></td>
    <td class="col-comGTC" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'comGTC',parseFloat(this.value))" ${dis}>${gO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comGTC)} &#8364;</span></div></td>
    <td class="col-limpieza" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'limpieza',parseFloat(this.value))" ${dis}>${cO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.limp)} &#8364;</span></div></td>
    <td class="col-amenities" style="text-align:center;vertical-align:middle;font-size:12px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(AMENITIES)} &#8364;</td>
    <td class="col-pasarela" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><div style="display:flex;align-items:center;justify-content:center;gap:6px;">
      <div class="toggle" onclick="if(!${isV}){togglePasarela(${r.idx})}"><div class="toggle-track ${s.pasarela ? 'on' : ''}"><div class="toggle-thumb"></div></div></div>
      ${s.pasarela ? `<select class="sel" style="width:70px;font-size:11px;padding:4px 6px;" onchange="changeSetting(${r.idx},'pasarelaRate',parseFloat(this.value))" ${dis}>${psO}</select>` : `<span class="toggle-label">${isB ? 'Booking' : 'Stripe'}</span>`}
    </div>${s.pasarela && c.comPas > 0 ? `<span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPas)} &#8364;</span>` : ''}</div></td>
    <td class="col-subtotal right bold" style="font-size:12px;">${fmt(c.sub)} &#8364;</td>
    <td class="col-irpf" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'irpf',parseFloat(this.value))" ${dis}>${iO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.ret)} &#8364;</span></div></td>
    <td class="col-iva21" style="text-align:center;vertical-align:middle;"><span style="font-size:11px;color:#43a047;font-variant-numeric:tabular-nums;">+ ${fmt(c.iva)} &#8364;</span></td>
    <td class="col-totalLiquidar right bold" style="color:${c.totalLiq >= 0 ? '#1a2744' : '#e53935'}">${fmt(c.totalLiq)} &#8364;</td>
    <td class="col-observacion ellip muted" style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${r.observacion.replace(/"/g,'&quot;')}">${r.observacion}</td>
    <td class="col-acciones"><div style="display:flex;gap:6px;">
      <button class="btn btn-sm btn-primary" onclick="viewDetail(${r.idx})">&#128065;</button>
      ${!isV ? `<button class="btn btn-sm btn-success" onclick="toggleValidate(${r.idx})">&#10004;</button>` : `<button class="btn btn-sm btn-orange" onclick="toggleValidate(${r.idx})">&#8617;</button>`}
    </div></td>
  </tr>`;
}

function _renderFull() {
  const fil = getFilteredSorted();
  _lastFiltered = fil;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value, sortD = simpleComboState.sortdir.value;
  const hasFilter = comboState.platform.selected.size > 0 || comboState.aloj.selected.size > 0 || sf2 !== "all" || _mpYear !== null;

  document.getElementById("filter-count").textContent = fil.length + " reservas";

  // Single pass over filtered: stats + totals + button counts
  const st = _computeStatsFromScratch(fil);
  const filPendingCount = st.filPendingCount, filValidatedCount = st.filValidatedCount;
  const fR = st.fR, fL = st.fL, fV = st.fV;
  const tNoches = st.tNoches, tTotal = st.tTotal, tBase = st.tBase;
  const tComPlat = st.tComPlat, tComGTC = st.tComGTC, tLimp = st.tLimp, tAmen = st.tAmen;
  const tComPas = st.tComPas, tSub = st.tSub, tRet = st.tRet, tIva21 = st.tIva21, tLiq = st.tLiq;

  // Global stats (cached)
  const gs = getGlobalStats();
  const tR = gs.tR, tL = gs.tL;
  const vC = validated.size;

  const btnVal = document.getElementById("btn-validar-todas");
  const btnDesval = document.getElementById("btn-desvalidar-todas");
  btnVal.style.display = filPendingCount > 0 ? '' : 'none';
  btnVal.textContent = filPendingCount === fil.length ? `✔ Validar todas (${filPendingCount})` : `✔ Validar pendientes (${filPendingCount})`;
  btnDesval.style.display = filValidatedCount > 0 ? '' : 'none';
  btnDesval.textContent = filValidatedCount === fil.length ? `↩ Desvalidar todas (${filValidatedCount})` : `↩ Desvalidar validadas (${filValidatedCount})`;

  const pctR = allReservas.length > 0 ? (fil.length / allReservas.length * 100).toFixed(1) : 0;
  const pctTR = tR > 0 ? (fR / tR * 100).toFixed(1) : 0;
  const pctTL = tL > 0 ? (fL / tL * 100).toFixed(1) : 0;
  const pctV = vC > 0 ? (fV / vC * 100).toFixed(1) : 0;
  document.getElementById("stats-row").innerHTML = `
    <div class="stat-card"><div class="stat-label">Reservas</div><div class="stat-value">${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fil.length} filtradas <span class="stat-pct">(${pctR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Total Reservas</div><div class="stat-value" style="color:#1a2744">${fmt(tR)} €</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(fR)} € <span class="stat-pct">(${pctTR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Total a Liquidar</div><div class="stat-value" style="color:#4f8cff">${fmt(tL)} €</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(fL)} € <span class="stat-pct">(${pctTL}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Validadas</div><div class="stat-value" style="color:#43a047">${vC} / ${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fV} / ${fil.length} filtradas <span class="stat-pct">(${pctV}%)</span></div>` : ''}</div>`;

  const thead = document.getElementById("table-header");
  thead.innerHTML = COLUMNS.map(c => { const is = sortF === c.key; const ar = c.sortable ? `<span class="sort-arrow">${is ? (sortD === "asc" ? "&#9650;" : "&#9660;") : "&#8661;"}</span>` : "";
    const cls = ["col-" + c.key, c.right ? "right" : "", is ? "sorted" : "", c.sortable ? "" : "no-sort"].filter(Boolean).join(" ");
    return `<th class="${cls}" ${c.sortable ? `onclick="sortByColumn('${c.key}')"` : ""}>${c.label}${ar}</th>`; }).join("");

  // PAGINATION: render only current page slice
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  if (_currentPage > totalPages) _currentPage = totalPages;
  const startIdx = (_currentPage - 1) * _pageSize;
  const endIdx = Math.min(startIdx + _pageSize, fil.length);

  // Build row HTML for current page only
  const rowsHtml = new Array(endIdx - startIdx);
  for (let i = startIdx; i < endIdx; i++) {
    rowsHtml[i - startIdx] = _buildRowHtml(fil[i]);
  }
  document.getElementById("table-body").innerHTML = rowsHtml.join('');

  // Pagination bar
  _updatePaginationBar(fil.length, totalPages);

  // Totals footer (always over ALL filtered, not just visible)
  _updateFooter(fil.length, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq);
}

// Fast re-render for page changes only — no stats recalc
function _renderPageOnly() {
  const fil = getFilteredSorted();
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  if (_currentPage > totalPages) _currentPage = totalPages;
  const startIdx = (_currentPage - 1) * _pageSize;
  const endIdx = Math.min(startIdx + _pageSize, fil.length);
  const rowsHtml = new Array(endIdx - startIdx);
  for (let i = startIdx; i < endIdx; i++) {
    rowsHtml[i - startIdx] = _buildRowHtml(fil[i]);
  }
  document.getElementById("table-body").innerHTML = rowsHtml.join('');
  _updatePaginationBar(fil.length, totalPages);
}

function _updatePaginationBar(totalCount, totalPages) {
  const pagBar = document.getElementById("pagination-bar");
  if (totalCount === 0) { pagBar.style.display = 'none'; return; }
  pagBar.style.display = 'flex';

  const startIdx = (_currentPage - 1) * _pageSize + 1;
  const endIdx = Math.min(_currentPage * _pageSize, totalCount);

  // Build page buttons (show max 7 pages with ellipsis)
  let pageButtons = '';
  const maxBtns = 7;
  let pages = [];
  if (totalPages <= maxBtns) {
    for (let i = 1; i <= totalPages; i++) pages.push(i);
  } else {
    pages.push(1);
    let lo = Math.max(2, _currentPage - 1);
    let hi = Math.min(totalPages - 1, _currentPage + 1);
    if (_currentPage <= 3) { lo = 2; hi = 5; }
    if (_currentPage >= totalPages - 2) { lo = totalPages - 4; hi = totalPages - 1; }
    if (lo > 2) pages.push('...');
    for (let i = lo; i <= hi; i++) pages.push(i);
    if (hi < totalPages - 1) pages.push('...');
    pages.push(totalPages);
  }

  pages.forEach(p => {
    if (p === '...') {
      pageButtons += `<span style="padding:4px 2px;color:#9ca3af;font-size:12px;">…</span>`;
    } else {
      const active = p === _currentPage;
      pageButtons += `<button onclick="goToPage(${p})" style="
        min-width:32px;height:32px;border-radius:6px;border:1.5px solid ${active ? '#4f8cff' : '#dde1e8'};
        background:${active ? '#4f8cff' : '#fff'};color:${active ? '#fff' : '#6b7280'};
        font-size:12px;font-weight:${active ? '700' : '500'};cursor:pointer;font-family:inherit;
        transition:all 0.15s;" onmouseover="if(!${active})this.style.borderColor='#4f8cff'" onmouseout="if(!${active})this.style.borderColor='#dde1e8'">${p}</button>`;
    }
  });

  // Page size options
  const sizes = [100, 500, 1000];
  const sizeOpts = sizes.map(s => `<option value="${s}" ${_pageSize === s ? 'selected' : ''}>${s}</option>`).join('');

  pagBar.innerHTML = `
    <div style="display:flex;align-items:center;gap:6px;">
      <button onclick="goToPage(_currentPage-1)" class="btn btn-sm btn-outline" style="padding:4px 10px;${_currentPage <= 1 ? 'opacity:0.4;pointer-events:none;' : ''}">&#8249;</button>
      ${pageButtons}
      <button onclick="goToPage(_currentPage+1)" class="btn btn-sm btn-outline" style="padding:4px 10px;${_currentPage >= totalPages ? 'opacity:0.4;pointer-events:none;' : ''}">&#8250;</button>
    </div>
    <span style="font-size:12px;color:#6b7280;">${startIdx}–${endIdx} de ${totalCount}</span>
    <div style="display:flex;align-items:center;gap:6px;">
      <label style="font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;">Mostrar</label>
      <select class="sel" style="font-size:12px;padding:4px 8px;" onchange="changePageSize(parseInt(this.value))">${sizeOpts}</select>
    </div>`;
}

function goToPage(p) {
  const fil = getFilteredSorted();
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  _currentPage = Math.max(1, Math.min(p, totalPages));
  _renderPageOnly();
  // Scroll table to top
  document.querySelector('#screen-list .table-wrap').scrollTop = 0;
}

function changePageSize(size) {
  // Keep roughly the same scroll position
  const firstVisibleIdx = (_currentPage - 1) * _pageSize;
  _pageSize = size;
  _currentPage = Math.max(1, Math.floor(firstVisibleIdx / _pageSize) + 1);
  _renderPageOnly();
}

function _updateFooter(count, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq) {
  const tfoot = document.getElementById("table-foot");
  const _fs = 'border:none;padding:10px 8px;';
  const _fr = 'border:none;padding:10px 8px;color:#ff8a80;text-align:center;font-variant-numeric:tabular-nums;';
  tfoot.innerHTML = count > 0 ? `<tr style="background:#0f1628;color:#fff;font-weight:700;font-size:12px;">
    <td class="col-estado" style="${_fs}"></td>
    <td class="col-idReserva" style="${_fs}"></td>
    <td class="col-localizador" style="${_fs}"></td>
    <td class="col-fechaAlta" style="${_fs}"></td>
    <td class="col-cliente" style="${_fs}text-align:right;text-transform:uppercase;letter-spacing:0.06em;font-size:11px;color:rgba(255,255,255,0.6);">Totales (${count})</td>
    <td class="col-alojamiento" style="${_fs}"></td>
    <td class="col-edificio" style="${_fs}"></td>
    <td class="col-plataforma" style="${_fs}"></td>
    <td class="col-atendidoPor" style="${_fs}"></td>
    <td class="col-origenMarketing" style="${_fs}"></td>
    <td class="col-tipoReserva" style="${_fs}"></td>
    <td class="col-fechaEntrada" style="${_fs}"></td>
    <td class="col-fechaSalida" style="${_fs}"></td>
    <td class="col-noches" style="${_fs}text-align:center;">${tNoches}</td>
    <td class="col-totalReserva" style="${_fs}text-align:right;">${fmt(tTotal)} &#8364;</td>
    <td class="col-baseSinIVA" style="${_fs}text-align:right;color:rgba(255,255,255,0.6);">${fmt(tBase)} &#8364;</td>
    <td class="col-comPlataforma" style="${_fr}">${fmt(tComPlat)} &#8364;</td>
    <td class="col-comGTC" style="${_fr}">${fmt(tComGTC)} &#8364;</td>
    <td class="col-limpieza" style="${_fr}">${fmt(tLimp)} &#8364;</td>
    <td class="col-amenities" style="${_fr}">${fmt(tAmen)} &#8364;</td>
    <td class="col-pasarela" style="${_fr}">${tComPas > 0 ? fmt(tComPas) + ' &#8364;' : '&#8211;'}</td>
    <td class="col-subtotal" style="${_fs}text-align:right;">${fmt(tSub)} &#8364;</td>
    <td class="col-irpf" style="${_fr}">&#8211; ${fmt(tRet)} &#8364;</td>
    <td class="col-iva21" style="${_fs}text-align:center;color:#81c784;font-variant-numeric:tabular-nums;">+ ${fmt(tIva21)} &#8364;</td>
    <td class="col-totalLiquidar" style="${_fs}text-align:right;color:#81d4fa;font-size:14px;">${fmt(tLiq)} &#8364;</td>
    <td class="col-observacion" style="${_fs}"></td>
    <td class="col-acciones" style="${_fs}"></td>
  </tr>` : '';
}

function changeSetting(i,k,v){
  const oldC = getLiq(allReservas[i]); // capture BEFORE invalidating
  settings[i][k]=v; invalidateCache(i);
  const newC = getLiq(allReservas[i]);
  // Delta update global stats O(1) instead of recomputing O(n)
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _patchSingleRow(i, oldC, newC);
}
function validarTodas() { const pending=_lastFiltered.filter(r=>!validated.has(r.idx)); const n=pending.length; if(!n||!confirm(`¿Validar ${n} reserva${n>1?'s':''}?`))return; pending.forEach(r => validated.add(r.idx)); _validatedVersion++; invalidateFilterCache(); renderTable(); batchWriteValidation(pending.map(r=>r.idx), true); }
function desvalidarTodas() { const vals=_lastFiltered.filter(r=>validated.has(r.idx)); const n=vals.length; if(!n||!confirm(`¿Desvalidar ${n} reserva${n>1?'s':''}?`))return; vals.forEach(r => validated.delete(r.idx)); _validatedVersion++; invalidateFilterCache(); renderTable(); batchWriteValidation(vals.map(r=>r.idx), false); }
function changeSettingConsol(i,k,v){const oldC=getLiq(allReservas[i]);settings[i][k]=v;invalidateCache(i);const newC=getLiq(allReservas[i]);if(_globalStatsCache)_globalStatsCache.tL+=(newC.totalLiq-oldC.totalLiq);if(currentConsolAloj)viewConsolDetail(currentConsolAloj);}
function togglePasarelaConsol(i){const oldC=getLiq(allReservas[i]);settings[i].pasarela=!settings[i].pasarela;invalidateCache(i);const newC=getLiq(allReservas[i]);if(_globalStatsCache)_globalStatsCache.tL+=(newC.totalLiq-oldC.totalLiq);if(currentConsolAloj)viewConsolDetail(currentConsolAloj);}
function toggleValidateConsol(i){const wasV=validated.has(i);if(wasV)validated.delete(i);else validated.add(i);_validatedVersion++;invalidateFilterCache();if(currentConsolAloj)viewConsolDetail(currentConsolAloj);writeValidationToSheet(i,!wasV);}
function validarTodasConsol(alojName) {
  const pending=allReservas.filter(r => r.alojamiento === alojName && !validated.has(r.idx));
  if(!pending.length||!confirm(`¿Validar ${pending.length} reserva${pending.length>1?'s':''} de ${alojName}?`))return;
  pending.forEach(r => validated.add(r.idx));
  _validatedVersion++; invalidateFilterCache();
  if(currentConsolAloj) viewConsolDetail(currentConsolAloj);
  batchWriteValidation(pending.map(r=>r.idx), true);
}
function desvalidarTodasConsol(alojName) {
  const vals=allReservas.filter(r => r.alojamiento === alojName && validated.has(r.idx));
  if(!vals.length||!confirm(`¿Desvalidar ${vals.length} reserva${vals.length>1?'s':''} de ${alojName}?`))return;
  vals.forEach(r => validated.delete(r.idx));
  _validatedVersion++; invalidateFilterCache();
  if(currentConsolAloj) viewConsolDetail(currentConsolAloj);
  batchWriteValidation(vals.map(r=>r.idx), false);
}
function togglePasarela(i){
  const oldC = getLiq(allReservas[i]);
  settings[i].pasarela=!settings[i].pasarela; invalidateCache(i);
  const newC = getLiq(allReservas[i]);
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _patchSingleRow(i, oldC, newC);
}
function toggleValidate(i){
  const wasValidated = validated.has(i);
  if(wasValidated) validated.delete(i); else validated.add(i);
  _validatedVersion++;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value;
  if (sf2 !== 'all' || sortF === 'estado') {
    invalidateFilterCache();
    renderTable();
  } else {
    // Patch path — filtered set unchanged, just toggle badge + update stats
    _patchSingleRow(i, null, null, wasValidated);
  }
  if(document.getElementById("screen-detail").classList.contains("active"))viewDetail(i);
  if(document.getElementById("screen-consoldetail").classList.contains("active") && currentConsolAloj) viewConsolDetail(currentConsolAloj);
  writeValidationToSheet(i, !wasValidated);
}

// ─── CACHED STATS for incremental updates ───
let _cachedFilteredStats = null; // { filPendingCount, filValidatedCount, fR, fL, fV, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq }

function _computeStatsFromScratch(fil) {
  const s = { filPendingCount:0, filValidatedCount:0, fR:0, fL:0, fV:0,
    tNoches:0, tTotal:0, tBase:0, tComPlat:0, tComGTC:0, tLimp:0, tAmen:0, tComPas:0, tSub:0, tRet:0, tIva21:0, tLiq:0 };
  for (let i = 0; i < fil.length; i++) {
    const r = fil[i], c = getLiq(r), isV = validated.has(r.idx);
    s.fR += r.totalReserva; s.fL += c.totalLiq;
    if (isV) { s.fV++; s.filValidatedCount++; } else s.filPendingCount++;
    s.tNoches += r._nights; s.tTotal += r.totalReserva; s.tBase += c.baseSinIVA;
    s.tComPlat += c.comPlat; s.tComGTC += c.comGTC; s.tLimp += c.limp; s.tAmen += AMENITIES; s.tComPas += c.comPas;
    s.tSub += c.sub; s.tRet += c.ret; s.tIva21 += c.iva; s.tLiq += c.totalLiq;
  }
  _cachedFilteredStats = s;
  return s;
}

function _getOrComputeStats(fil) {
  if (_cachedFilteredStats) return _cachedFilteredStats;
  return _computeStatsFromScratch(fil);
}

// ─── IN-PLACE ROW UPDATE O(1) ───
function _patchSingleRow(idx, oldC, newC, validationFlipped) {
  const row = document.getElementById("row-" + idx);
  if (!row) { renderTable(); return; }
  const r = allReservas[idx];
  if (!r) return;

  // Replace just this row's DOM
  const tmp = document.createElement('tbody');
  tmp.innerHTML = _buildRowHtml(r);
  row.replaceWith(tmp.firstElementChild);

  // Incremental stats update — O(1) instead of O(n)
  const fil = _lastFiltered;
  if (!fil) { renderTable(); return; }

  let st = _cachedFilteredStats;
  if (!st) { st = _computeStatsFromScratch(fil); }

  // Row is in DOM → guaranteed in filtered set. Apply delta:
  if (oldC && newC) {
    // Setting/pasarela change: subtract old values, add new
    st.fL += (newC.totalLiq - oldC.totalLiq);
    st.tBase += (newC.baseSinIVA - oldC.baseSinIVA);
    st.tComPlat += (newC.comPlat - oldC.comPlat);
    st.tComGTC += (newC.comGTC - oldC.comGTC);
    st.tLimp += (newC.limp - oldC.limp);
    st.tComPas += (newC.comPas - oldC.comPas);
    st.tSub += (newC.sub - oldC.sub);
    st.tRet += (newC.ret - oldC.ret);
    st.tIva21 += (newC.iva - oldC.iva);
    st.tLiq += (newC.totalLiq - oldC.totalLiq);
  }
  if (validationFlipped !== undefined) {
    if (validationFlipped) {
      st.filValidatedCount--; st.filPendingCount++; st.fV--;
    } else {
      st.filValidatedCount++; st.filPendingCount--; st.fV++;
    }
  }

  _renderStatsFromCache(fil, st);
}

function _renderStatsFromCache(fil, st) {
  const sf2 = simpleComboState.status.value;
  const hasFilter = comboState.platform.selected.size > 0 || comboState.aloj.selected.size > 0 || sf2 !== "all" || _mpYear !== null;

  const gs = getGlobalStats();
  const tR = gs.tR, tL = gs.tL, vC = validated.size;

  const btnVal = document.getElementById("btn-validar-todas");
  const btnDesval = document.getElementById("btn-desvalidar-todas");
  btnVal.style.display = st.filPendingCount > 0 ? '' : 'none';
  btnVal.textContent = st.filPendingCount === fil.length ? `✔ Validar todas (${st.filPendingCount})` : `✔ Validar pendientes (${st.filPendingCount})`;
  btnDesval.style.display = st.filValidatedCount > 0 ? '' : 'none';
  btnDesval.textContent = st.filValidatedCount === fil.length ? `↩ Desvalidar todas (${st.filValidatedCount})` : `↩ Desvalidar validadas (${st.filValidatedCount})`;

  document.getElementById("filter-count").textContent = fil.length + " reservas";
  const pctR = allReservas.length > 0 ? (fil.length / allReservas.length * 100).toFixed(1) : 0;
  const pctTR = tR > 0 ? (st.fR / tR * 100).toFixed(1) : 0;
  const pctTL = tL > 0 ? (st.fL / tL * 100).toFixed(1) : 0;
  const pctV = vC > 0 ? (st.fV / vC * 100).toFixed(1) : 0;
  document.getElementById("stats-row").innerHTML = `
    <div class="stat-card"><div class="stat-label">Reservas</div><div class="stat-value">${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fil.length} filtradas <span class="stat-pct">(${pctR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Total Reservas</div><div class="stat-value" style="color:#1a2744">${fmt(tR)} €</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(st.fR)} € <span class="stat-pct">(${pctTR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Total a Liquidar</div><div class="stat-value" style="color:#4f8cff">${fmt(tL)} €</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(st.fL)} € <span class="stat-pct">(${pctTL}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Validadas</div><div class="stat-value" style="color:#43a047">${vC} / ${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${st.fV} / ${fil.length} filtradas <span class="stat-pct">(${pctV}%)</span></div>` : ''}</div>`;

  _updateFooter(fil.length, st.tNoches, st.tTotal, st.tBase, st.tComPlat, st.tComGTC, st.tLimp, st.tAmen, st.tComPas, st.tSub, st.tRet, st.tIva21, st.tLiq);
}

let highlightIdx = null;
function goToReserva(idx) {
  // Reset filters so the reservation is visible
  comboState.platform.selected = new Set(); updateComboDisplay('platform');
  comboState.aloj.selected = new Set(); updateComboDisplay('aloj');
  clearMonthFilter();
  simpleComboState.status.value = 'all';
  document.querySelector('#combo-status .combo-input').value = '';
  document.querySelector('#combo-status .combo-input').placeholder = 'Todos los estados';
  document.getElementById('combo-status').classList.remove('has-value');
  simpleComboState.sort.value = 'idx';
  document.querySelector('#combo-sort .combo-input').value = '';
  document.querySelector('#combo-sort .combo-input').placeholder = 'Orden original';
  document.getElementById('combo-sort').classList.remove('has-value');
  simpleComboState.sortdir.value = 'asc';
  document.querySelector('#combo-sortdir .combo-input').value = '';
  document.querySelector('#combo-sortdir .combo-input').placeholder = '\u2191';
  document.getElementById('combo-sortdir').classList.remove('has-value');
  highlightIdx = idx;
  showScreen("list");
  renderTable();
  setTimeout(() => {
    const row = document.getElementById("row-" + idx);
    if (row) {
      row.scrollIntoView({ behavior: "smooth", block: "center" });
      row.classList.add("highlight");
      setTimeout(() => { row.classList.remove("highlight"); highlightIdx = null; }, 2000);
    }
  }, 100);
}

// ─── INDIVIDUAL DETAIL ───
function viewDetail(idx) {
  currentDetailIdx = idx;
  const r=allReservas.find(x=>x.idx===idx); if(!r)return;
  const s=settings[r.idx]||{},c=calcLiquidacion(r,s),isV=validated.has(r.idx),isB=r.plataforma==="Booking.com";
  const pasL=isB?"Booking":"Stripe",pasR=s.pasarelaRate!==undefined?s.pasarelaRate:(isB?pasarelaBookingOptions[0]/100:pasarelaStripeOptions[0]/100);
  const _vd = (idx, key, val) => `changeSetting(${idx},'${key}',parseFloat(this.value));viewDetail(${idx})`;
  const _sel = (opts, current, idx, key, unitPct) => {
    if(isV) return unitPct ? `(${(current*100).toFixed(1)}%)` : ``;
    return `<select class="sel" style="font-size:12px;padding:3px 6px;margin-left:6px;" onchange="${_vd(idx,key)}">` +
      opts.map(o => { const v = unitPct ? o/100 : o;
        return `<option value="${v}" ${Math.abs(current-v)<0.0001?'selected':''}>${unitPct?o+'%':o+' &#8364;'}</option>`;
      }).join('') + `</select>`;
  };

  const platOpts = platformOptions[r.plataforma]||[10];
  const pasOpts = isB ? pasarelaBookingOptions : pasarelaStripeOptions;

  const comPlatLabel = `Comisi&#243;n ${r.plataforma} ` + _sel(platOpts, c.comRate, r.idx, 'comPlataforma', true);
  const comGTCLabel = `Comisi&#243;n GTC ` + _sel(gtcOptions, c.gtcRate, r.idx, 'comGTC', true);
  const limpLabel = `Limpieza ` + _sel(cleaningOptions, c.limp, r.idx, 'limpieza', false);

  const rows=[
    {l:"Total Reserva (IVA incluido)",v:c.total,bold:true},{l:`IVA Reserva (${(IVA_RESERVA*100).toFixed(0)}%)`,v:-(c.total-c.baseSinIVA),neg:true},
    {l:"Base sin IVA",v:c.baseSinIVA,bold:true},{div:true},
    {l:comPlatLabel,v:-c.comPlat,neg:true},
    {l:comGTCLabel,v:-c.comGTC,neg:true},
  ];
  if(s.pasarela){
    const pasLabel = isV ? `Comisi&#243;n pasarela ${pasL} (${(pasR*100).toFixed(1)}%)`
      : `Comisi&#243;n pasarela ${pasL} ` + _sel(pasOpts, pasR, r.idx, 'pasarelaRate', true);
    rows.push({l:pasLabel,v:-c.comPas,neg:true});
  }
  // Pasarela toggle row (only if not validated)
  if(!isV){
    const toggleHtml = `<div style="display:inline-flex;align-items:center;gap:8px;margin-left:6px;">` +
      `<div class="toggle" onclick="togglePasarela(${r.idx});viewDetail(${r.idx})"><div class="toggle-track ${s.pasarela?'on':''}"><div class="toggle-thumb"></div></div></div>` +
      `<span style="font-size:12px;color:#6b7280;">${s.pasarela?'Activada':'Desactivada'}</span></div>`;
    if(!s.pasarela) rows.push({l:`Pasarela ${pasL} ${toggleHtml}`,v:0,custom:true});
    else rows.push({l:`${toggleHtml}`,v:0,custom:true});
  }
  rows.push({l:limpLabel,v:-c.limp,neg:true},{l:"Amenities",v:-AMENITIES,neg:true},{div:true},
    {l:"Subtotal",v:c.sub,bold:true},
    {l:"__IRPF__",v:-c.ret,neg:true,irpf:true},
    {l:`IVA del Subtotal (${(IVA_SUBTOTAL*100).toFixed(0)}%)`,v:c.iva,pos:true});
  const irpfSelHtml = isV ? `Retenci&#243;n IRPF (${(c.irpfRate*100).toFixed(0)}%)`
    : `Retenci&#243;n IRPF ` + _sel(irpfOptions, c.irpfRate, r.idx, 'irpf', true);
  let rH=rows.map(row=>{if(row.div)return'<div class="liq-divider"></div>';
    if(row.custom)return`<div class="liq-row" style="justify-content:flex-end;"><span>${row.l}</span></div>`;
    const cl=row.bold?' bold':'';const vc=row.neg?'neg':row.pos?'pos':'';
    const d=row.v<0?`- ${fmt(Math.abs(row.v))}`:fmt(row.v);
    const label=row.irpf?irpfSelHtml:row.l;
    return`<div class="liq-row${cl}"><span>${label}</span><span class="${vc}">${d} &#8364;</span></div>`;}).join("");
  document.getElementById("detail-content").innerHTML=`<div class="liq-container print-target" id="print-zone">
    <div class="liq-header"><div class="header-top"><div><div class="type">${isV?'Liquidación':'Preliquidación'}</div><div class="name">${r.cliente}</div></div>
    <div>${isV?'<span class="badge-liq badge-liq-green">&#10003; VALIDADA</span>':'<span class="badge-liq badge-liq-amber">PENDIENTE</span>'}</div></div>
    <div class="liq-meta"><div><div class="liq-meta-label">Alojamiento</div><div class="liq-meta-value">${r.alojamiento}</div></div>
    <div><div class="liq-meta-label">Fechas</div><div class="liq-meta-value">${formatDate(r.fechaEntrada)} &#8594; ${formatDate(r.fechaSalida)}</div></div>
    <div><div class="liq-meta-label">Plataforma</div><div class="liq-meta-value">${r.plataforma}</div></div>
    <div><div class="liq-meta-label">ID Reserva</div><div class="liq-meta-value">${r.id}</div></div>
    <div><div class="liq-meta-label">Localizador</div><div class="liq-meta-value" style="font-size:11px">${r.localizador}</div></div>
    <div><div class="liq-meta-label">Edificio</div><div class="liq-meta-value">${r.edificio}</div></div></div></div>
    <div style="padding:8px 0;">${rH}</div>
    <div class="liq-total"><span>TOTAL A LIQUIDAR</span><span>${fmt(c.totalLiq)} €</span></div></div>
    <div class="liq-actions no-print">
      ${!isV?`<button class="btn btn-success" onclick="toggleValidate(${r.idx})">&#10003; Validar</button>`:`<button class="btn btn-orange" onclick="toggleValidate(${r.idx})">&#8617; Desvalidar</button>`}
      <button class="btn btn-outline" onclick="window.print()">&#128424; Imprimir</button></div>`;
  document.getElementById("nav-detail").style.display="block"; showScreen("detail");
}

// ─── CONSOLIDATED GRID ───
let _alojCache = null;
function invalidateAlojCache() { _alojCache = null; }
function getAlojamientos() {
  if (_alojCache) return _alojCache;
  const map = {};
  allReservas.forEach(r => {
    if (!map[r.alojamiento]) map[r.alojamiento] = { name: r.alojamiento, edificio: r.edificio, reservas: [] };
    map[r.alojamiento].reservas.push(r);
  });
  _alojCache = Object.values(map).sort((a, b) => a.name.localeCompare(b.name));
  return _alojCache;
}

function renderConsolGrid() {
  const alojamientos = getAlojamientos();

  // Apply date filter helper
  function filterByDate(reservas) {
    if (_mpYear === null) return reservas;
    return reservas.filter(r => {
      if (!r._dEntrada) return false;
      if (r._dEntrada.getFullYear() !== _mpYear) return false;
      if (_mpMonth !== null && r._dEntrada.getMonth() !== _mpMonth) return false;
      return true;
    });
  }

  let totalAloj = 0, readyCount = 0, totalLiq = 0;

  // Pre-compute stats for sorting (with date-filtered reservas)
  const alojData = alojamientos.map(a => {
    const filtered = filterByDate(a.reservas);
    if (filtered.length === 0) return null; // hide alojamientos with 0 reservas in range
    totalAloj++;
    const total = filtered.length;
    const valCount = filtered.filter(r => validated.has(r.idx)).length;
    const allVal = valCount === total;
    if (allVal) readyCount++;
    const sumReservas = filtered.reduce((s, r) => s + r.totalReserva, 0);
    const sumLiq = filtered.reduce((s, r) => s + getLiq(r).totalLiq, 0);
    totalLiq += sumLiq;
    return { ...a, reservas: filtered, total, valCount, allVal, sumReservas, sumLiq };
  }).filter(Boolean);

  // Sort
  const sortMode = simpleComboState.consolsort.value;
  alojData.sort((a, b) => {
    switch(sortMode) {
      case 'name': return a.name.localeCompare(b.name);
      case 'name-desc': return b.name.localeCompare(a.name);
      case 'reservas-desc': return b.total - a.total || a.name.localeCompare(b.name);
      case 'reservas-asc': return a.total - b.total || a.name.localeCompare(b.name);
      case 'liq-desc': return b.sumLiq - a.sumLiq || a.name.localeCompare(b.name);
      case 'liq-asc': return a.sumLiq - b.sumLiq || a.name.localeCompare(b.name);
      case 'total-desc': return b.sumReservas - a.sumReservas || a.name.localeCompare(b.name);
      case 'total-asc': return a.sumReservas - b.sumReservas || a.name.localeCompare(b.name);
      case 'pending': return (a.allVal?1:0) - (b.allVal?1:0) || a.name.localeCompare(b.name);
      case 'ready': return (b.allVal?1:0) - (a.allVal?1:0) || a.name.localeCompare(b.name);
      default: return a.name.localeCompare(b.name);
    }
  });

  // Render position badges for top sorts
  const showRank = ['reservas-desc','liq-desc','total-desc'].includes(sortMode);

  let cardsHTML = '';
  alojData.forEach((a, idx) => {
    const pct = a.total > 0 ? (a.valCount / a.total * 100) : 0;
    const barColor = a.allVal ? '#43a047' : '#ff9800';
    const rankBadge = showRank ? `<div style="position:absolute;top:12px;left:12px;width:24px;height:24px;border-radius:12px;background:${idx<3?'#4f8cff':'#e0e4ea'};color:${idx<3?'#fff':'#6b7280'};font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;">${idx+1}</div>` : '';

    cardsHTML += `
      <div class="aloj-card ${a.allVal ? 'ready' : 'pending'}" onclick="viewConsolDetail('${a.name.replace(/'/g, "\\'")}')">
        ${rankBadge}
        <div class="aloj-semaforo">${a.allVal ? '&#128994;' : '&#128992;'}</div>
        <div class="aloj-name" ${showRank?'style="padding-left:28px;"':''}>${a.name}</div>
        <div class="aloj-edificio">${a.edificio}</div>
        <div class="aloj-stats">
          <div><div class="aloj-stat-label">Reservas</div><div class="aloj-stat-value">${a.total}</div></div>
          <div><div class="aloj-stat-label">Facturación</div><div class="aloj-stat-value" style="font-size:14px;color:#1a2744">${fmt(a.sumReservas)} €</div></div>
          <div><div class="aloj-stat-label">A Liquidar</div><div class="aloj-stat-value" style="color:#4f8cff;font-size:14px">${fmt(a.sumLiq)} €</div></div>
        </div>
        <div class="aloj-bar"><div class="aloj-bar-fill" style="width:${pct}%;background:${barColor};"></div></div>
      </div>`;
  });

  // Compute total facturacion
  const totalFact = alojData.reduce((s, a) => s + a.sumReservas, 0);

  document.getElementById("consol-stats").innerHTML = `
    <div class="stat-card"><div class="stat-label">Alojamientos</div><div class="stat-value">${totalAloj}</div></div>
    <div class="stat-card"><div class="stat-label">Total Facturación</div><div class="stat-value" style="color:#1a2744">${fmt(totalFact)} €</div></div>
    <div class="stat-card"><div class="stat-label">Total a Liquidar</div><div class="stat-value" style="color:#4f8cff">${fmt(totalLiq)} €</div></div>
    <div class="stat-card"><div class="stat-label">Listos para liquidar</div><div class="stat-value" style="color:#43a047">${readyCount} / ${totalAloj}</div></div>`;
  document.getElementById("aloj-grid").innerHTML = cardsHTML;
}

// ─── CONSOLIDATED DETAIL ───
function buildComPlatRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const key = x.r.plataforma + '|' + (x.c.comRate * 100).toFixed(1);
    if (!groups[key]) groups[key] = { plat: x.r.plataforma, rate: x.c.comRate, sum: 0, count: 0 };
    groups[key].sum += x.c.comPlat;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Comisi&#243;n ${g.plat} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '';
  let total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.plat} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Comisiones plataforma</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildGTCRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const rate = x.c.gtcRate;
    const key = (rate * 100).toFixed(0);
    if (!groups[key]) groups[key] = { rate, sum: 0, count: 0 };
    groups[key].sum += x.c.comGTC;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Comisiones GTC (${(g.rate*100).toFixed(0)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>GTC al ${(g.rate*100).toFixed(0)}% &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Comisiones GTC</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildPasarelaRows(calcs) {
  const withPas = calcs.filter(x => x.s.pasarela && x.c.comPas > 0);
  if (withPas.length === 0) return '';
  const groups = {};
  withPas.forEach(x => {
    const isB = x.r.plataforma === 'Booking.com';
    const label = isB ? 'Booking' : 'Stripe';
    const rate = x.s.pasarelaRate || (isB ? pasarelaBookingOptions[0]/100 : pasarelaStripeOptions[0]/100);
    const key = label + '|' + (rate * 100).toFixed(1);
    if (!groups[key]) groups[key] = { label, rate, sum: 0, count: 0 };
    groups[key].sum += x.c.comPas;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Pasarela ${g.label} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.label} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Comisiones pasarela</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildIrpfRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const rate = x.c.irpfRate;
    const key = (rate * 100).toFixed(0);
    if (!groups[key]) groups[key] = { rate, sum: 0, count: 0 };
    groups[key].sum += x.c.ret;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Retenci&#243;n IRPF (${(g.rate*100).toFixed(0)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>IRPF al ${(g.rate*100).toFixed(0)}% &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Retenci&#243;n IRPF</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildLimpRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const v = x.c.limp;
    const key = v.toFixed(0);
    if (!groups[key]) groups[key] = { val: v, sum: 0, count: 0 };
    groups[key].sum += v;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Limpieza (${g.count} &#215; ${fmt(g.val)} &#8364;)</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.count} &#215; ${fmt(g.val)} &#8364;</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Limpieza</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function viewConsolDetail(alojName) {
  currentConsolAloj = alojName;
  const alojamientos = getAlojamientos();
  const a = alojamientos.find(x => x.name === alojName);
  if (!a) return;

  // Apply date filter
  let filteredReservas = a.reservas;
  if (_mpYear !== null) {
    filteredReservas = a.reservas.filter(r => {
      if (!r._dEntrada) return false;
      if (r._dEntrada.getFullYear() !== _mpYear) return false;
      if (_mpMonth !== null && r._dEntrada.getMonth() !== _mpMonth) return false;
      return true;
    });
  }

  const allVal = filteredReservas.every(r => validated.has(r.idx));
  const calcs = filteredReservas.map(r => ({ r, s: settings[r.idx] || {}, c: getLiq(r) }));

  // Sums
  const sumTotal = calcs.reduce((s, x) => s + x.c.total, 0);
  const sumBase = calcs.reduce((s, x) => s + x.c.baseSinIVA, 0);
  const sumComPlat = calcs.reduce((s, x) => s + x.c.comPlat, 0);
  const sumComGTC = calcs.reduce((s, x) => s + x.c.comGTC, 0);
  const sumComPas = calcs.reduce((s, x) => s + x.c.comPas, 0);
  const sumLimp = calcs.reduce((s, x) => s + x.c.limp, 0);
  const sumAmen = calcs.reduce((s, x) => s + AMENITIES, 0);
  const sumSub = calcs.reduce((s, x) => s + x.c.sub, 0);
  const sumIva = calcs.reduce((s, x) => s + x.c.iva, 0);
  const sumRet = calcs.reduce((s, x) => s + x.c.ret, 0);
  const sumLiq = calcs.reduce((s, x) => s + x.c.totalLiq, 0);

  // Sort calcs
  calcs.sort((a,b) => {
    let va = consolGetSortValue(a, consolSortF), vb = consolGetSortValue(b, consolSortF);
    if (typeof va === "string") return consolSortD === "asc" ? va.localeCompare(vb) : vb.localeCompare(va);
    return consolSortD === "asc" ? va - vb : vb - va;
  });

  // Consolidated table - identical look to main preliquidaciones (without alojamiento)
  let cNoches=0, cTotal=0, cBase=0, cComPlat=0, cComGTC=0, cLimp=0, cAmen=0, cComPas=0, cSub=0, cRet=0, cIva21=0, cLiq=0;

  let miniRows = calcs.map(x => {
    const r = x.r, c = x.c, s = x.s, isV = validated.has(r.idx), isB = r._isBooking;
    const nights = r._nights;
    const dis = isV ? 'disabled' : '';

    const pO = selectWithValue(_selectCache['plat_'+r.plataforma]||'<option>10%</option>', s.comPlataforma);
    const gO = selectWithValue(_selectCache.gtc, s.comGTC);
    const cO = selectCleanWithValue(_selectCache.clean, s.limpieza);
    const iO = selectWithValue(_selectCache.irpf, s.irpf);
    const psO = selectWithValue(isB?_selectCache.pasBooking:_selectCache.pasStripe, s.pasarelaRate);

    cNoches+=nights; cTotal+=r.totalReserva; cBase+=c.baseSinIVA; cComPlat+=c.comPlat; cComGTC+=c.comGTC; cLimp+=c.limp; cAmen+=AMENITIES; cComPas+=c.comPas; cSub+=c.sub; cRet+=c.ret; cIva21+=c.iva; cLiq+=c.totalLiq;

    return `<tr ${isV?'class="validated"':''} id="crow-${r.idx}">
      <td class="cc-estado">${isV?'<span class="badge badge-green">&#10003; Validada</span>':'<span class="badge badge-amber">Pendiente</span>'}</td>
      <td class="cc-idReserva" style="font-size:12px;color:#6b7280;">${r.id}</td>
      <td class="cc-localizador" style="font-size:11px;color:#6b7280;max-width:120px;overflow:hidden;text-overflow:ellipsis;">${r.localizador}</td>
      <td class="cc-fechaAlta" style="font-size:12px;color:#6b7280;">${r._fmtAlta}</td>
      <td class="cc-cliente bold ellip">${r.cliente}</td>
      <td class="cc-edificio ellip" style="font-size:12px;color:#6b7280;">${r.edificio}</td>
      <td class="cc-plataforma"><span class="badge ${isB?'badge-purple':'badge-blue'}">${r.plataforma}</span></td>
      <td class="cc-atendidoPor ellip" style="font-size:12px;color:#6b7280;">${r.atendidoPor}</td>
      <td class="cc-origenMarketing ellip" style="font-size:12px;color:#6b7280;">${r.origenMarketing}</td>
      <td class="cc-tipoReserva" style="font-size:12px;color:#6b7280;">${r.tipoReserva}</td>
      <td class="cc-fechaEntrada" style="font-size:12px;white-space:nowrap;">${r._fmtEntrada}</td>
      <td class="cc-fechaSalida" style="font-size:12px;white-space:nowrap;">${r._fmtSalida}</td>
      <td class="cc-noches" style="text-align:center">${nights}</td>
      <td class="cc-totalReserva right bold">${fmt(r.totalReserva)} &#8364;</td>
      <td class="cc-baseSinIVA right" style="color:#6b7280;font-size:12px;">${fmt(c.baseSinIVA)} &#8364;</td>
      <td class="cc-comPlataforma" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'comPlataforma',parseFloat(this.value))" ${dis}>${pO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPlat)} &#8364;</span></div></td>
      <td class="cc-comGTC" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'comGTC',parseFloat(this.value))" ${dis}>${gO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comGTC)} &#8364;</span></div></td>
      <td class="cc-limpieza" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'limpieza',parseFloat(this.value))" ${dis}>${cO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.limp)} &#8364;</span></div></td>
      <td class="cc-amenities" style="text-align:center;vertical-align:middle;font-size:12px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(AMENITIES)} &#8364;</td>
      <td class="cc-pasarela" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><div style="display:flex;align-items:center;justify-content:center;gap:6px;">
        <div class="toggle" onclick="event.stopPropagation();if(!${isV}){togglePasarelaConsol(${r.idx})}"><div class="toggle-track ${s.pasarela?'on':''}"><div class="toggle-thumb"></div></div></div>
        ${s.pasarela?`<select class="sel" style="width:70px;font-size:11px;padding:4px 6px;" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'pasarelaRate',parseFloat(this.value))" ${dis}>${psO}</select>`:`<span class="toggle-label">${isB?'Booking':'Stripe'}</span>`}
      </div>${s.pasarela&&c.comPas>0?`<span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPas)} &#8364;</span>`:''}</div></td>
      <td class="cc-subtotal right bold" style="font-size:12px;">${fmt(c.sub)} &#8364;</td>
      <td class="cc-irpf" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'irpf',parseFloat(this.value))" ${dis}>${iO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.ret)} &#8364;</span></div></td>
      <td class="cc-iva21" style="text-align:center;vertical-align:middle;"><span style="font-size:11px;color:#43a047;font-variant-numeric:tabular-nums;">+ ${fmt(c.iva)} &#8364;</span></td>
      <td class="cc-totalLiquidar right bold" style="color:${c.totalLiq>=0?'#1a2744':'#e53935'}">${fmt(c.totalLiq)} &#8364;</td>
      <td class="cc-observacion ellip" style="font-size:11px;color:#6b7280;max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${r.observacion.replace(/"/g,'&quot;')}">${r.observacion}</td>
      <td class="cc-acciones"><div style="display:flex;gap:6px;">
        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation();goToReserva(${r.idx})">&#128065;</button>
        ${!isV?`<button class="btn btn-sm btn-success" onclick="event.stopPropagation();toggleValidateConsol(${r.idx})">&#10004;</button>`:`<button class="btn btn-sm btn-orange" onclick="event.stopPropagation();toggleValidateConsol(${r.idx})">&#8617;</button>`}
      </div></td>
    </tr>`;
  }).join("");

  // Footer totals - identical dark bar like main table
  const _cfs='border:none;padding:10px 8px;';
  const _cfr='border:none;padding:10px 8px;color:#ff8a80;text-align:center;font-variant-numeric:tabular-nums;';
  const miniTotals = `<tr style="background:#0f1628;color:#fff;font-weight:700;font-size:12px;">
    <td class="cc-estado" style="${_cfs}"></td>
    <td class="cc-idReserva" style="${_cfs}"></td>
    <td class="cc-localizador" style="${_cfs}"></td>
    <td class="cc-fechaAlta" style="${_cfs}"></td>
    <td class="cc-cliente" style="${_cfs}text-align:right;text-transform:uppercase;letter-spacing:0.06em;font-size:11px;color:rgba(255,255,255,0.6);">Totales (${calcs.length})</td>
    <td class="cc-edificio" style="${_cfs}"></td>
    <td class="cc-plataforma" style="${_cfs}"></td>
    <td class="cc-atendidoPor" style="${_cfs}"></td>
    <td class="cc-origenMarketing" style="${_cfs}"></td>
    <td class="cc-tipoReserva" style="${_cfs}"></td>
    <td class="cc-fechaEntrada" style="${_cfs}"></td>
    <td class="cc-fechaSalida" style="${_cfs}"></td>
    <td class="cc-noches" style="${_cfs}text-align:center;">${cNoches}</td>
    <td class="cc-totalReserva" style="${_cfs}text-align:right;">${fmt(cTotal)} &#8364;</td>
    <td class="cc-baseSinIVA" style="${_cfs}text-align:right;color:rgba(255,255,255,0.6);">${fmt(cBase)} &#8364;</td>
    <td class="cc-comPlataforma" style="${_cfr}">${fmt(cComPlat)} &#8364;</td>
    <td class="cc-comGTC" style="${_cfr}">${fmt(cComGTC)} &#8364;</td>
    <td class="cc-limpieza" style="${_cfr}">${fmt(cLimp)} &#8364;</td>
    <td class="cc-amenities" style="${_cfr}">${fmt(cAmen)} &#8364;</td>
    <td class="cc-pasarela" style="${_cfr}">${cComPas>0?fmt(cComPas)+' &#8364;':'&#8211;'}</td>
    <td class="cc-subtotal" style="${_cfs}text-align:right;">${fmt(cSub)} &#8364;</td>
    <td class="cc-irpf" style="${_cfr}">&#8211; ${fmt(cRet)} &#8364;</td>
    <td class="cc-iva21" style="${_cfs}text-align:center;color:#81c784;font-variant-numeric:tabular-nums;">+ ${fmt(cIva21)} &#8364;</td>
    <td class="cc-totalLiquidar" style="${_cfs}text-align:right;color:#81d4fa;font-size:14px;">${fmt(cLiq)} &#8364;</td>
    <td class="cc-observacion" style="${_cfs}"></td>
    <td class="cc-acciones" style="${_cfs}"></td>
  </tr>`;

  const content = `
    <div class="consol-container print-target" id="print-zone">
      <div class="consol-header">
        <div class="header-top">
          <div>
            <div class="type">Liquidación Mensual Consolidada</div>
            <div class="name">${a.name}</div>
          </div>
          <div>${allVal?'<span class="badge-liq badge-liq-green">&#10003; LISTA</span>':'<span class="badge-liq badge-liq-amber">PENDIENTE</span>'}</div>
        </div>
        <div class="consol-meta">
          <div><div class="consol-meta-label">Edificio</div><div class="consol-meta-value">${a.edificio}</div></div>
          <div><div class="consol-meta-label">Nº Reservas</div><div class="consol-meta-value">${a.reservas.length}</div></div>
          <div><div class="consol-meta-label">Validadas</div><div class="consol-meta-value">${a.reservas.filter(r=>validated.has(r.idx)).length} / ${a.reservas.length}</div></div>
        </div>
      </div>

      <div class="consol-body">
        <div class="no-print" style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid #eef0f4;background:#f8f9fb;position:relative;z-index:10;">
          <div style="display:flex;gap:8px;align-items:center;">
            ${!allVal ? `<button class="btn btn-sm btn-success" onclick="validarTodasConsol('${a.name.replace(/'/g, "\\'")}')">&#10004; Validar todas (${a.reservas.filter(r=>!validated.has(r.idx)).length})</button>` : ''}
            ${a.reservas.some(r=>validated.has(r.idx)) ? `<button class="btn btn-sm btn-orange" onclick="desvalidarTodasConsol('${a.name.replace(/'/g, "\\'")}')">&#8617; Desvalidar todas</button>` : ''}
          </div>
          <div class="col-toggle-wrap">
            <button class="col-toggle-btn" onclick="toggleConsolColDropdown()" title="Mostrar/ocultar columnas">&#9783; Columnas</button>
            <div class="col-toggle-dd" id="consol-col-toggle-dd"></div>
          </div>
        </div>
        <div class="card" style="padding:0;overflow:hidden;margin-bottom:0;border-radius:0;box-shadow:none;">
        <div class="table-wrap">
          <table>
            <thead><tr>
              ${CONSOL_COLUMNS.map(c => {
                const is = consolSortF===c.key;
                const ar = c.sortable ? '<span class="sort-arrow">'+(is?(consolSortD==="asc"?"&#9650;":"&#9660;"):"&#8661;")+'</span>' : '';
                const cls = ["cc-"+c.key, c.right?"right":"", is?"sorted":"", c.sortable?"":"no-sort"].filter(Boolean).join(" ");
                return '<th class="'+cls+'" '+(c.sortable?'onclick="consolSortByColumn(\''+c.key+'\')"':'')+'>'+c.label+ar+'</th>';
              }).join("")}
            </tr></thead>
            <tbody>${miniRows}</tbody>
            <tfoot>${miniTotals}</tfoot>
          </table>
        </div>
        </div>

        <div class="consol-summary-block">
        <div class="consol-section-title">Resumen Consolidado</div>
        <div class="consol-row bold"><span>Total Reservas (IVA incluido)</span><span>${fmt(sumTotal)} &#8364;</span></div>
        <div class="consol-row"><span>IVA Reservas (10%)</span><span class="neg">- ${fmt(sumTotal - sumBase)} &#8364;</span></div>
        <div class="consol-row bold"><span>Base sin IVA</span><span>${fmt(sumBase)} &#8364;</span></div>
        <div class="consol-divider"></div>
        ${buildComPlatRows(calcs)}
        ${buildGTCRows(calcs)}
        ${buildPasarelaRows(calcs)}
        ${buildLimpRows(calcs)}
        <div class="consol-row"><span>Amenities (${a.reservas.length} &#215; ${AMENITIES} &#8364;)</span><span class="neg">- ${fmt(sumAmen)} &#8364;</span></div>
        <div class="consol-divider"></div>
        <div class="consol-subtotal"><span>Subtotal</span><span>${fmt(sumSub)} &#8364;</span></div>
        ${buildIrpfRows(calcs)}
        <div class="consol-row"><span>IVA del Subtotal (21%)</span><span class="pos">+ ${fmt(sumIva)} &#8364;</span></div>

        <div class="consol-total"><span>TOTAL A LIQUIDAR</span><span>${fmt(sumLiq)} &#8364;</span></div>
        </div>
      </div>
    </div>

    <div class="liq-actions no-print" style="margin-top:28px;" id="consol-actions">
      ${allVal
        ? `<div style="display:flex;flex-direction:column;align-items:center;gap:14px;">
            <div style="display:flex;gap:12px;align-items:center;">
              <button class="btn btn-success" onclick="handleGenerar()">&#128424; Generar Liquidación</button>
              <button class="btn btn-outline" onclick="showScreen('consol')">&#8592; Volver</button>
            </div>
            ${_previewPref !== null
              ? `<div style="font-size:12px;color:#9ca3af;">
                  ${_previewPref ? 'ðŸ‘ Se mostrará previsualización' : 'ðŸ–¨ Se imprimirá directamente'}
                  &nbsp;·&nbsp; <a href="#" onclick="resetPreviewPref();return false;" style="color:#4f8cff;">Cambiar</a>
                </div>`
              : `<div id="preview-options" style="display:flex;gap:16px;align-items:center;">
                  <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;">
                    <input type="checkbox" id="chk-preview" checked style="width:16px;height:16px;cursor:pointer;">
                    Ver previsualización antes de imprimir
                  </label>
                  <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#9ca3af;cursor:pointer;">
                    <input type="checkbox" id="chk-remember" style="width:14px;height:14px;cursor:pointer;">
                    No preguntar más
                  </label>
                </div>`}
          </div>`
        : `<button class="btn btn-disabled">&#9888; Valida todas las reservas primero</button>
           <button class="btn btn-outline" onclick="showScreen('consol')">&#8592; Volver</button>`}
    </div>

    <div id="preview-zone" style="display:none;"></div>`;

  _previewActive = false;
  document.getElementById("consoldetail-content").innerHTML = content;
  document.getElementById("nav-consoldetail").style.display = "block";
  showScreen("consoldetail");
}

// ─── PRINT PREFERENCES ───
let _previewPref = null; // null = show options, true = always preview, false = never preview
try { const v = localStorage.getItem('liq-preview-pref'); if (v !== null) _previewPref = v === 'true'; } catch(e) {}

function getPreviewPref() { return _previewPref === null ? true : _previewPref; }

function handleGenerar() {
  // If preference is saved, use it directly
  if (_previewPref !== null) {
    if (_previewPref) showPrintPreview(); else printConsolDirect();
    return;
  }
  // Otherwise read checkboxes
  const chkPreview = document.getElementById('chk-preview');
  const chkRemember = document.getElementById('chk-remember');
  const wantPreview = chkPreview ? chkPreview.checked : true;

  if (chkRemember && chkRemember.checked) {
    _previewPref = wantPreview;
    try { localStorage.setItem('liq-preview-pref', String(wantPreview)); } catch(e) {}
  }

  if (wantPreview) showPrintPreview(); else printConsolDirect();
}

function resetPreviewPref() {
  _previewPref = null;
  try { localStorage.removeItem('liq-preview-pref'); } catch(e) {}
  // Re-render to show checkboxes
  if (currentConsolAloj) viewConsolDetail(currentConsolAloj);
}

function buildPrintCards() {
  const alojName = currentConsolAloj;
  if (!alojName) return null;
  const alojamientos = getAlojamientos();
  const a = alojamientos.find(x => x.name === alojName);
  if (!a) return null;

  const calcs = a.reservas.map(r => ({ r, s: settings[r.idx] || {}, c: getLiq(r) }));

  let cardsHtml = calcs.map((x, i) => {
    const r = x.r, s = x.s, c = x.c;
    const isB = r.plataforma === 'Booking.com';
    const pasL = isB ? 'Booking' : 'Stripe';
    const pasR = s.pasarelaRate !== undefined ? s.pasarelaRate : (isB ? pasarelaBookingOptions[0]/100 : pasarelaStripeOptions[0]/100);

    let rows = [
      {l:"Total Reserva (IVA incluido)",v:c.total,bold:true},
      {l:`IVA Reserva (${(IVA_RESERVA*100).toFixed(0)}%)`,v:-(c.total-c.baseSinIVA),neg:true},
      {l:"Base sin IVA",v:c.baseSinIVA,bold:true},{div:true},
      {l:`Comisión ${r.plataforma} (${(c.comRate*100).toFixed(1)}%)`,v:-c.comPlat,neg:true},
      {l:`Comisión GTC (${(c.gtcRate*100).toFixed(0)}%)`,v:-c.comGTC,neg:true},
    ];
    if(s.pasarela) rows.push({l:`Comisión pasarela ${pasL} (${(pasR*100).toFixed(1)}%)`,v:-c.comPas,neg:true});
    rows.push({l:`Limpieza (${fmt(c.limp)} €)`,v:-c.limp,neg:true},
      {l:"Amenities",v:-AMENITIES,neg:true},{div:true},
      {l:"Subtotal",v:c.sub,bold:true},
      {l:`Retención IRPF (${(c.irpfRate*100).toFixed(0)}%)`,v:-c.ret,neg:true},
      {l:`IVA del Subtotal (${(IVA_SUBTOTAL*100).toFixed(0)}%)`,v:c.iva,pos:true});

    const rowsHtml = rows.map(row => {
      if (row.div) return '<div class="liq-divider"></div>';
      const cl = row.bold ? ' bold' : '';
      const vc = row.neg ? 'neg' : row.pos ? 'pos' : '';
      const d = row.v < 0 ? `- ${fmt(Math.abs(row.v))}` : fmt(row.v);
      return `<div class="liq-row${cl}"><span>${row.l}</span><span class="${vc}">${d} &#8364;</span></div>`;
    }).join('');

    return `<div class="liq-container print-card" style="margin-bottom:24px;">
      <div class="liq-header">
        <div class="header-top"><div><div class="type">Liquidación ${i+1} de ${calcs.length}</div><div class="name">${r.cliente}</div></div></div>
        <div class="liq-meta">
          <div><div class="liq-meta-label">Alojamiento</div><div class="liq-meta-value">${r.alojamiento}</div></div>
          <div><div class="liq-meta-label">Fechas</div><div class="liq-meta-value">${formatDate(r.fechaEntrada)} &#8594; ${formatDate(r.fechaSalida)}</div></div>
          <div><div class="liq-meta-label">Plataforma</div><div class="liq-meta-value">${r.plataforma}</div></div>
          <div><div class="liq-meta-label">ID Reserva</div><div class="liq-meta-value">${r.id}</div></div>
          <div><div class="liq-meta-label">Localizador</div><div class="liq-meta-value" style="font-size:11px">${r.localizador}</div></div>
          <div><div class="liq-meta-label">Edificio</div><div class="liq-meta-value">${r.edificio}</div></div>
        </div>
      </div>
      <div style="padding:8px 0;">${rowsHtml}</div>
      <div class="liq-total"><span>TOTAL A LIQUIDAR</span><span>${fmt(c.totalLiq)} &#8364;</span></div>
    </div>`;
  }).join('');

  const sumSub = calcs.reduce((s, x) => s + x.c.sub, 0);
  const sumRet = calcs.reduce((s, x) => s + x.c.ret, 0);
  const sumIva = calcs.reduce((s, x) => s + x.c.iva, 0);
  const sumLiq = calcs.reduce((s, x) => s + x.c.totalLiq, 0);

  const summaryHtml = `<div class="liq-container print-summary" style="margin-top:8px;">
    <div class="liq-header">
      <div class="header-top"><div><div class="type">Resumen Consolidado — ${calcs.length} reservas</div><div class="name">${a.name}</div></div></div>
      <div class="liq-meta">
        <div><div class="liq-meta-label">Edificio</div><div class="liq-meta-value">${a.edificio}</div></div>
        <div><div class="liq-meta-label">Nº Reservas</div><div class="liq-meta-value">${calcs.length}</div></div>
        <div></div>
      </div>
    </div>
    <div style="padding:8px 0;">
      <div class="liq-row bold"><span>Subtotal</span><span>${fmt(sumSub)} &#8364;</span></div>
      <div class="liq-divider"></div>
      <div class="liq-row"><span>Retención IRPF</span><span class="neg">- ${fmt(sumRet)} &#8364;</span></div>
      <div class="liq-row"><span>IVA 21%</span><span class="pos">+ ${fmt(sumIva)} &#8364;</span></div>
    </div>
    <div class="liq-total"><span>TOTAL A LIQUIDAR</span><span>${fmt(sumLiq)} &#8364;</span></div>
  </div>`;

  return { cardsHtml, summaryHtml };
}

let _previewActive = false;

function showPrintPreview() {
  const result = buildPrintCards();
  if (!result) return;

  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  // Populate preview zone with cards + action buttons
  previewZone.innerHTML = result.cardsHtml + result.summaryHtml
    + `<div class="liq-actions no-print" style="margin-top:28px;justify-content:center;">
        <button class="btn btn-success" onclick="printFromPreview()">&#128424; Imprimir</button>
        <button class="btn btn-outline" onclick="exitPreview()">&#8592; Volver a la liquidación</button>
      </div>`;

  // Toggle visibility: hide table, show preview
  printZone.style.display = 'none';
  printZone.classList.remove('print-target');
  actions.style.display = 'none';
  previewZone.style.display = 'block';
  previewZone.classList.add('print-target');
  _previewActive = true;

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function printFromPreview() {
  window.print();
}

function exitPreview() {
  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  if (!_previewActive) return;

  // Toggle back: show table, hide preview
  previewZone.style.display = 'none';
  previewZone.classList.remove('print-target');
  previewZone.innerHTML = '';
  printZone.style.display = '';
  printZone.classList.add('print-target');
  actions.style.display = '';
  _previewActive = false;
}

function printConsolDirect() {
  const result = buildPrintCards();
  if (!result) return;

  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  // Temporarily swap to preview for printing only
  previewZone.innerHTML = result.cardsHtml + result.summaryHtml;
  printZone.style.display = 'none';
  printZone.classList.remove('print-target');
  actions.style.display = 'none';
  previewZone.style.display = 'block';
  previewZone.classList.add('print-target');

  setTimeout(() => {
    window.print();
    // Restore after print dialog closes
    setTimeout(() => {
      previewZone.style.display = 'none';
      previewZone.classList.remove('print-target');
      previewZone.innerHTML = '';
      printZone.style.display = '';
      printZone.classList.add('print-target');
      actions.style.display = '';
    }, 500);
  }, 100);
}

// ─── CONFIG MODAL ───
function switchTab(tabId, btn) {
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".modal-tab").forEach(t => t.classList.remove("active"));
  document.getElementById(tabId).classList.add("active"); btn.classList.add("active");
}
function openConfigModal() { renderConfigModal(); document.getElementById("config-modal").style.display = "flex"; }
function closeConfigModal() { document.getElementById("config-modal").style.display = "none"; rebuildSelectCache(); invalidateCache(); renderTable(); }

function buildOS(title, desc, vals, unit, addId, addFn, delFn) {
  const items = vals.map((v, i) => `<div class="option-item"><span class="val">${v}${unit}</span>
    ${vals.length > 1 ? `<button class="option-delete" onclick="${delFn}(${i})">&#10005;</button>` : '<span style="width:28px"></span>'}</div>`).join("");
  return `<div class="modal-section"><h4>${title}</h4>${desc?`<div class="desc">${desc}</div>`:''}
    <div class="option-list">${items}</div>
    <div class="add-row"><input class="add-input" type="number" id="${addId}" placeholder="Nuevo valor" step="any">
    <button class="btn btn-sm btn-primary" onclick="${addFn}()">+ Añadir</button></div></div>`;
}

function renderConfigModal() {
  const pN = Object.keys(platformOptions).sort();
  let pH = '';
  pN.forEach(name => {
    const safe = name.replace(/[^a-zA-Z0-9]/g,'');
    pH += buildOS(name, "% sobre total reserva (IVA incl.)", platformOptions[name], "%", `add-plat-${safe}`, `addP_${safe}`, `delP_${safe}`);
    window[`addP_${safe}`] = function() { const inp=document.getElementById(`add-plat-${safe}`); const v=parseFloat(inp.value);
      if(isNaN(v)||v<0||v>100){alert("Porcentaje válido: 0-100");return;} if(platformOptions[name].some(x=>Math.abs(x-v)<0.001)){alert("Ya existe.");return;}
      platformOptions[name].push(v); platformOptions[name].sort((a,b)=>a-b); inp.value=""; renderConfigModal(); };
    window[`delP_${safe}`] = function(i) { if(platformOptions[name].length<=1)return; platformOptions[name].splice(i,1); renderConfigModal(); };
  });
  document.getElementById("tab-plat").innerHTML = pH;
  document.getElementById("tab-pasarela").innerHTML =
    buildOS("Pasarela Stripe","Plataformas distintas de Booking",pasarelaStripeOptions,"%","add-ps","addPS","delPS") +
    '<hr class="section-divider">' +
    buildOS("Pasarela Booking","Solo para Booking.com",pasarelaBookingOptions,"%","add-pb","addPB","delPB");
  document.getElementById("tab-otros").innerHTML =
    buildOS("Comisión GTC","% sobre base sin IVA",gtcOptions,"%","add-gtc","addGTC","delGTC") +
    '<hr class="section-divider">' +
    buildOS("Limpieza","€ sin IVA",cleaningOptions," €","add-cl","addCL","delCL") +
    '<hr class="section-divider">' +
    buildOS("Retención IRPF","Porcentaje",irpfOptions,"%","add-ir","addIR","delIR") +
    '<hr class="section-divider">' +
    buildOS("Amenities","Coste fijo por reserva en €",[AMENITIES]," €","add-am","addAM","delAM");
}
function addPS(){aL(pasarelaStripeOptions,"add-ps",100);} function delPS(i){dL(pasarelaStripeOptions,i);}
function addPB(){aL(pasarelaBookingOptions,"add-pb",100);} function delPB(i){dL(pasarelaBookingOptions,i);}
function addCL(){aL(cleaningOptions,"add-cl",99999,false);} function delCL(i){dL(cleaningOptions,i);}
function addIR(){aL(irpfOptions,"add-ir",100);} function delIR(i){dL(irpfOptions,i);}
function addGTC(){aL(gtcOptions,"add-gtc",100);} function delGTC(i){dL(gtcOptions,i);}
function addAM(){const inp=document.getElementById("add-am");const v=parseFloat(inp.value);if(isNaN(v)||v<0){alert("Valor válido.");return;}AMENITIES=v;inp.value="";renderConfigModal();}
function delAM(){}
function aL(list,inputId,max,isP){const inp=document.getElementById(inputId);const v=parseFloat(inp.value);
  if(isP!==false){if(isNaN(v)||v<0||v>max){alert("Valor válido.");return;}}else{if(isNaN(v)||v<0){alert("Valor válido.");return;}}
  if(list.some(x=>Math.abs(x-v)<0.001)){alert("Ya existe.");return;} list.push(v);list.sort((a,b)=>a-b);inp.value="";renderConfigModal();}
function dL(list,i){if(list.length<=1)return;list.splice(i,1);renderConfigModal();}

// ─── SEARCHABLE COMBO SYSTEM ───
const comboState = { platform: { selected: new Set(), options: [] }, aloj: { selected: new Set(), options: [] } };
const comboLabels = { platform: 'Todas las plataformas', aloj: 'Todos los alojamientos' };

// ─── MONTH PICKER STATE ───
const MONTH_NAMES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const MONTH_FULL = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
let _mpYear = null, _mpMonth = null; // null = all
let _mpAvailable = {}; // { 2025: {0: count, 1: count, ...}, ... }
let _mpYears = [];
let _mpActiveSrc = 'p'; // which dropdown is currently open: 'p' or 'c'

function buildAvailableMonths() {
  _mpAvailable = {};
  allReservas.forEach(r => {
    if (!r._dEntrada) return;
    const y = r._dEntrada.getFullYear(), m = r._dEntrada.getMonth();
    if (!_mpAvailable[y]) _mpAvailable[y] = {};
    _mpAvailable[y][m] = (_mpAvailable[y][m] || 0) + 1;
  });
  _mpYears = Object.keys(_mpAvailable).map(Number).sort((a,b) => b-a);
  _mpYear = null; _mpMonth = null;
  updateMonthPickerBtn();
}

function toggleMonthPicker(src) {
  _mpActiveSrc = src || 'p';
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  // Close the other dropdown
  const otherId = _mpActiveSrc === 'p' ? 'mp-dd-c' : 'mp-dd-p';
  document.getElementById(otherId).classList.remove('open');
  const dd = document.getElementById('mp-dd-' + _mpActiveSrc);
  const wasOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!wasOpen) renderMonthPickerDD();
}

function renderMonthPickerDD() {
  const dd = document.getElementById('mp-dd-' + _mpActiveSrc);
  if (!dd) return;
  const dispYear = _mpYear !== null ? _mpYear : (_mpYears[0] || new Date().getFullYear());
  const ym = _mpAvailable[dispYear] || {};

  let yearsHtml = _mpYears.map(y =>
    `<button class="mp-year ${y===dispYear?'sel':''}" onclick="event.stopPropagation();selectMPYear(${y})">${y}</button>`
  ).join('');

  let monthsHtml = '';
  for (let m = 0; m < 12; m++) {
    const cnt = ym[m] || 0;
    const isSel = _mpYear === dispYear && _mpMonth === m;
    const dim = cnt === 0 ? 'dim' : '';
    monthsHtml += `<button class="mp-month ${isSel?'sel':''} ${dim}" onclick="event.stopPropagation();selectMPMonth(${dispYear},${m})">${MONTH_NAMES[m]}<span class="mp-cnt">${cnt>0?cnt:''}</span></button>`;
  }

  const yearOnlyActive = _mpYear === dispYear && _mpMonth === null;

  dd.innerHTML = `
    <div class="mp-years">${yearsHtml}</div>
    <div class="mp-grid">${monthsHtml}</div>
    ${_mpYear !== null || _mpMonth !== null ? `<button class="mp-all" onclick="event.stopPropagation();clearMonthFilter()">✕ Quitar filtro de fecha</button>` : ''}
  `;
}

function selectMPYear(year) {
  if (_mpYear === year && _mpMonth === null) {
    _mpYear = null;
  } else {
    _mpYear = year;
    _mpMonth = null;
  }
  _mpRefreshAll();
  renderMonthPickerDD();
}

function selectMPMonth(year, month) {
  if (_mpYear === year && _mpMonth === month) {
    _mpMonth = null;
  } else {
    _mpYear = year;
    _mpMonth = month;
  }
  _mpRefreshAll();
  if (_mpMonth !== null) document.getElementById('mp-dd-' + _mpActiveSrc).classList.remove('open');
  else renderMonthPickerDD();
}

function clearMonthFilter() {
  _mpYear = null; _mpMonth = null;
  _mpRefreshAll();
  document.getElementById('mp-dd-p').classList.remove('open');
  document.getElementById('mp-dd-c').classList.remove('open');
}

function _mpRefreshAll() {
  updateMonthPickerBtn();
  invalidateFilterCache(); _currentPage = 1; renderTable();
  renderConsolGrid();
  if (document.getElementById("screen-consoldetail").classList.contains("active") && currentConsolAloj) viewConsolDetail(currentConsolAloj);
}

function _mpBtnHtml(arrows) {
  if (_mpYear !== null && _mpMonth !== null) {
    return { active: true, html: '<span class="mp-nav">'
      + '<button class="mp-arrow" onclick="event.stopPropagation();mpPrev()">&#8249;</button>'
      + '</span>'
      + MONTH_FULL[_mpMonth] + ' ' + _mpYear
      + '<span class="mp-nav">'
      + '<button class="mp-arrow" onclick="event.stopPropagation();mpNext()">&#8250;</button>'
      + '</span>'
      + '<span class="mp-clear" onclick="event.stopPropagation();clearMonthFilter();">✕</span>' };
  } else if (_mpYear !== null) {
    return { active: true, html: '<span class="mp-nav">'
      + '<button class="mp-arrow" onclick="event.stopPropagation();mpPrev()">&#8249;</button>'
      + '</span>'
      + 'Año ' + _mpYear
      + '<span class="mp-nav">'
      + '<button class="mp-arrow" onclick="event.stopPropagation();mpNext()">&#8250;</button>'
      + '</span>'
      + '<span class="mp-clear" onclick="event.stopPropagation();clearMonthFilter();">✕</span>' };
  }
  return { active: false, html: null };
}

function updateMonthPickerBtn() {
  const info = _mpBtnHtml();
  ['p','c'].forEach(src => {
    const btn = document.getElementById('mp-btn-' + src);
    const label = document.getElementById('mp-label-' + src);
    if (!btn || !label) return;
    if (info.active) {
      label.innerHTML = info.html;
      btn.classList.add('active');
    } else {
      label.textContent = 'Todos los meses';
      btn.classList.remove('active');
    }
  });
}

function mpPrev() {
  if (_mpYear !== null && _mpMonth !== null) {
    _mpMonth--;
    if (_mpMonth < 0) { _mpMonth = 11; _mpYear--; }
  } else if (_mpYear !== null) {
    _mpYear--;
  }
  _mpRefreshAll();
}

function mpNext() {
  if (_mpYear !== null && _mpMonth !== null) {
    _mpMonth++;
    if (_mpMonth > 11) { _mpMonth = 0; _mpYear++; }
  } else if (_mpYear !== null) {
    _mpYear++;
  }
  _mpRefreshAll();
}

function populateCombo(id, items) {
  comboState[id].options = items;
  comboState[id].selected = new Set();
  updateComboDisplay(id);
}

function openCombo(id) {
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  document.querySelectorAll('.mp-dd').forEach(l => l.classList.remove('open'));
  const input = document.querySelector(`#combo-${id} .combo-input`);
  input.value = '';
  input.select();
  renderComboList(id, '');
  document.getElementById(`combo-list-${id}`).classList.add('open');
}

function filterCombo(id) {
  const input = document.querySelector(`#combo-${id} .combo-input`);
  renderComboList(id, input.value);
  document.getElementById(`combo-list-${id}`).classList.add('open');
}

function renderComboList(id, query) {
  const list = document.getElementById(`combo-list-${id}`);
  const q = query.toLowerCase().trim();
  const items = comboState[id].options;
  let filtered = items;
  if (q) filtered = items.filter(i => i.toLowerCase().includes(q));
  const sel = comboState[id].selected;

  const countFn = id === 'platform'
    ? (v) => allReservas.filter(r => r.plataforma === v).length
    : (v) => allReservas.filter(r => r.alojamiento === v).length;

  const allChecked = sel.size === 0;
  let html = `<label class="combo-selall" onclick="event.stopPropagation()"><input type="checkbox" ${allChecked?'checked':''} onchange="toggleComboAll('${id}', this.checked)"> ${comboLabels[id]} <span class="combo-item-count">(${allReservas.length})</span></label>`;
  if (filtered.length === 0) {
    html += '<div class="combo-empty">Sin resultados</div>';
  } else {
    filtered.forEach(item => {
      const isChecked = sel.has(item);
      let label = item;
      if (q) {
        const idx = item.toLowerCase().indexOf(q);
        if (idx >= 0) label = item.slice(0, idx) + '<span class="match">' + item.slice(idx, idx + q.length) + '</span>' + item.slice(idx + q.length);
      }
      const count = countFn(item);
      const esc = item.replace(/'/g, "\\'");
      html += `<label class="combo-item-chk" onclick="event.stopPropagation()"><input type="checkbox" ${isChecked?'checked':''} onchange="toggleComboItem('${id}','${esc}',this.checked)"> ${label} <span class="combo-item-count">(${count})</span></label>`;
    });
  }
  list.innerHTML = html;
}

function toggleComboItem(id, item, checked) {
  const sel = comboState[id].selected;
  if (checked) sel.add(item); else sel.delete(item);
  updateComboDisplay(id);
  invalidateFilterCache(); _currentPage = 1; renderTable();
  // Re-render list to update checkboxes
  const input = document.querySelector(`#combo-${id} .combo-input`);
  renderComboList(id, '');
}

function toggleComboAll(id, checked) {
  if (checked) {
    comboState[id].selected = new Set();
  } else {
    comboState[id].selected = new Set(comboState[id].options);
  }
  updateComboDisplay(id);
  invalidateFilterCache(); _currentPage = 1; renderTable();
  renderComboList(id, '');
}

function updateComboDisplay(id) {
  const input = document.querySelector(`#combo-${id} .combo-input`);
  const wrap = document.getElementById(`combo-${id}`);
  const sel = comboState[id].selected;
  if (sel.size === 0) {
    input.value = '';
    input.placeholder = comboLabels[id];
    wrap.classList.remove('has-value');
  } else if (sel.size === 1) {
    input.value = [...sel][0];
    wrap.classList.add('has-value');
  } else {
    const noun = id === 'platform' ? 'plataformas' : 'alojamientos';
    input.value = sel.size + ' ' + noun;
    wrap.classList.add('has-value');
  }
}

function clearCombo(id) {
  comboState[id].selected = new Set();
  updateComboDisplay(id);
  document.getElementById(`combo-list-${id}`).classList.remove('open');
  invalidateFilterCache(); _currentPage = 1; renderTable();
}

// ─── SIMPLE COMBO SYSTEM (for status, sort, sortdir) ───
const simpleComboState = {
  status: { value: 'all', label: 'Todos los estados' },
  sort: { value: 'idx', label: 'Orden original' },
  sortdir: { value: 'asc', label: '&#8593;' },
  consolsort: { value: 'name', label: 'Nombre A→Z' }
};
const simpleComboOptions = {
  status: [
    { value: 'all', label: 'Todos los estados' },
    { value: 'pending', label: 'Pendientes' },
    { value: 'validated', label: 'Validadas' }
  ],
  sort: [
    { value: 'idx', label: 'Orden original' },
    { value: 'estado', label: 'Estado' },
    { value: 'idReserva', label: 'ID Reserva' },
    { value: 'localizador', label: 'Localizador' },
    { value: 'fechaAlta', label: 'Fecha Alta' },
    { value: 'cliente', label: 'Cliente' },
    { value: 'alojamiento', label: 'Alojamiento' },
    { value: 'edificio', label: 'Edificio' },
    { value: 'plataforma', label: 'Plataforma' },
    { value: 'atendidoPor', label: 'Atendido por' },
    { value: 'origenMarketing', label: 'Origen Mkt.' },
    { value: 'tipoReserva', label: 'Tipo Reserva' },
    { value: 'fechaEntrada', label: 'Fecha Entrada' },
    { value: 'fechaSalida', label: 'Fecha Salida' },
    { value: 'noches', label: 'Noches' },
    { value: 'totalReserva', label: 'Total reserva' },
    { value: 'baseSinIVA', label: 'Base sin IVA' },
    { value: 'subtotal', label: 'Subtotal' },
    { value: 'totalLiquidar', label: 'Total a liquidar' },
    { value: 'observacion', label: 'Observación' }
  ],
  sortdir: [
    { value: 'asc', label: '&#8593; Ascendente' },
    { value: 'desc', label: '&#8595; Descendente' }
  ],
  consolsort: [
    { value: 'name', label: 'Nombre A→Z' },
    { value: 'name-desc', label: 'Nombre Z→A' },
    { value: 'reservas-desc', label: 'Más reservas' },
    { value: 'reservas-asc', label: 'Menos reservas' },
    { value: 'liq-desc', label: 'Mayor liquidación' },
    { value: 'liq-asc', label: 'Menor liquidación' },
    { value: 'total-desc', label: 'Mayor facturación' },
    { value: 'total-asc', label: 'Menor facturación' },
    { value: 'pending', label: 'Pendientes primero' },
    { value: 'ready', label: 'Listas primero' }
  ]
};

function openSimpleCombo(id) {
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  const list = document.getElementById(`combo-list-${id}`);
  const opts = simpleComboOptions[id];
  const current = simpleComboState[id].value;
  list.innerHTML = opts.map(o =>
    `<div class="combo-item ${o.value===current?'active':''}" onclick="selectSimpleCombo('${id}','${o.value}')">${o.label}</div>`
  ).join('');
  list.classList.add('open');
}

function selectSimpleCombo(id, value) {
  const opt = simpleComboOptions[id].find(o => o.value === value);
  simpleComboState[id].value = value;
  simpleComboState[id].label = opt ? opt.label : value;
  const input = document.querySelector(`#combo-${id} .combo-input`);
  const wrap = document.getElementById(`combo-${id}`);
  if (id === 'status') {
    if (value === 'all') {
      input.value = ''; input.placeholder = 'Todos los estados'; wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  } else if (id === 'sort') {
    if (value === 'idx') {
      input.value = ''; input.placeholder = 'Orden original'; wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  } else if (id === 'sortdir') {
    if (value === 'asc') {
      input.value = ''; input.placeholder = '\u2191'; wrap.classList.remove('has-value');
    } else {
      input.value = '\u2193'; wrap.classList.add('has-value');
    }
  } else if (id === 'consolsort') {
    if (value === 'name') {
      input.value = ''; input.placeholder = 'Nombre A→Z'; wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  }
  document.getElementById(`combo-list-${id}`).classList.remove('open');
  if (id === 'consolsort') { renderConsolGrid(); }
  else { _currentPage = 1; renderTable(); }
}

function clearSimpleCombo(id) {
  const defaults = { status: 'all', sort: 'idx', sortdir: 'asc', consolsort: 'name' };
  selectSimpleCombo(id, defaults[id] || 'all');
}

// Close all combos on outside click
document.addEventListener('click', function(e) {
  // Close column toggles
  document.querySelectorAll('.col-toggle-wrap').forEach(ctw => {
    if (!ctw.contains(e.target)) {
      const dd = ctw.querySelector('.col-toggle-dd');
      if (dd) dd.classList.remove('open');
    }
  });
  // Close month pickers
  ['p','c'].forEach(src => {
    const mpWrap = document.getElementById('mp-wrap-' + src);
    if (mpWrap && !mpWrap.contains(e.target)) {
      document.getElementById('mp-dd-' + src).classList.remove('open');
    }
  });
  document.querySelectorAll('.combo').forEach(c => {
    if (!c.contains(e.target)) {
      c.querySelector('.combo-list').classList.remove('open');
      const id = c.id.replace('combo-', '');
      // Restore display for searchable combos
      if (comboState[id]) updateComboDisplay(id);
    }
  });
});

// Keyboard nav for combos
document.querySelectorAll('.combo-input').forEach(input => {
  input.addEventListener('keydown', function(e) {
    const id = this.closest('.combo').id.replace('combo-', '');
    const list = document.getElementById(`combo-list-${id}`);
    if (e.key === 'Escape') { list.classList.remove('open'); this.blur(); }
  });
});
</script>
</body>
</html>
