<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Liquidaciones &mdash; Gesti&oacute;n de Reservas</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&family=Inter:wght@500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>

:root {
  /* Brand colors */
  --c-primary: #4f8cff;
  --c-primary-dark: #3b6de0;
  --c-primary-light: #e3f2fd;
  --c-primary-bg: #f0f5ff;
  /* Semantic */
  --c-success: #16a34a;
  --c-success-bg: #f0fdf4;
  --c-warning: #f59e0b;
  --c-warning-bg: #fffbeb;
  --c-error: #dc2626;
  --c-error-bg: #fef2f2;
  /* Neutrals */
  --c-bg: #f3f5f8;
  --c-surface: #ffffff;
  --c-border: #e2e5ea;
  --c-border-light: #eef0f4;
  --c-text: #1a1a2e;
  --c-text-secondary: #6b7280;
  --c-text-muted: #9ca3af;
  /* Sidebar */
  --c-sidebar-start: #0f1628;
  --c-sidebar-end: #1a2744;
  /* Typography */
  --font-display: 'Inter', 'DM Sans', sans-serif;
  --font-body: 'DM Sans', 'Helvetica Neue', sans-serif;
  --font-serif: 'Cormorant Garamond', Georgia, serif;
  --font-mono: 'JetBrains Mono', monospace;
  /* Homity palette */
  --hm-gold: #E0AE00;
  --hm-gold-bright: #E8BE4B;
  --hm-gold-deep: #C49A00;
  --hm-gold-muted: #c9a64e;
  --hm-gold-bg: rgba(224,174,0,0.07);
  --hm-gold-bg2: rgba(224,174,0,0.12);
  --hm-gold-border: rgba(224,174,0,0.25);
  --hm-teal: #1D4B56;
  --hm-teal-dark: #163E47;
  --hm-teal-light: #306472;
  --hm-blue-gray: #7191AC;
  --hm-cream: #FBF4E8;
  --hm-cream-warm: #FCF5E9;
  --hm-neg: #c0392b;
  --hm-pos: #27ae60;
  /* Spacing */
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
  --shadow-xl: 0 20px 60px rgba(0,0,0,0.12);
  /* Transitions */
  --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }


/* Language selector */
.lang-option.active { background: rgba(79,140,255,0.3) !important; border-color: rgba(79,140,255,0.6) !important; color: #fff !important; }

/* Global focus styles */
:focus-visible { outline: 2px solid var(--c-primary); outline-offset: 2px; }
input:focus, select:focus, textarea:focus { outline: none; }

::selection { background: rgba(79,140,255,0.2); color: inherit; }
body { font-family: var(--font-body); background: var(--c-bg); color: var(--c-text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
.sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 250px; background: linear-gradient(195deg, var(--c-sidebar-start) 0%, var(--c-sidebar-end) 100%); color: #fff; display: flex; flex-direction: column; z-index: 50; }
.logo { padding: 28px 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
.logo h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.03em; font-family: var(--font-display); }
.logo p { font-size: 11px; color: rgba(255,255,255,0.45); margin-top: 4px; letter-spacing: 0.06em; text-transform: uppercase; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 13px 24px; font-size: 14px; color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.25s var(--ease-out); border-left: 3px solid transparent; }
.nav-item:hover { color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.06); }
.nav-item.active { color: #fff; font-weight: 600; background: rgba(255,255,255,0.08); border-left-color: #4f8cff; }
.sidebar-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 11px; color: rgba(255,255,255,0.35); margin-top: auto; }
.changelog-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
.changelog-modal { background:#fff; border-radius:16px; max-width:640px; width:90vw; max-height:80vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
.changelog-header { display:flex; justify-content:space-between; align-items:center; padding:20px 24px; border-bottom:1px solid #e5e7eb; }
.changelog-header h3 { margin:0; font-size:18px; color:#1a2744; }
.changelog-body { overflow-y:auto; padding:20px 24px; flex:1; }
.cl-version { margin-bottom:20px; }
.cl-version:last-child { margin-bottom:0; }
.cl-version-header { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.cl-badge { background:var(--c-primary); color:#fff; font-size:12px; font-weight:700; padding:3px 10px; border-radius:20px; }
.cl-badge.current { background:#43a047; }
.cl-date { font-size:12px; color:#9ca3af; }
.cl-changes { list-style:none; padding:0; margin:0; }
.cl-changes li { font-size:13px; color:#4b5563; padding:3px 0 3px 18px; position:relative; line-height:1.5; }
.cl-changes li::before { content:'\2022'; position:absolute; left:4px; color:#4f8cff; font-weight:700; }
.main { margin-left: 250px; padding: 32px 40px; min-height: 100vh; }
.card { background: var(--c-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 28px 32px; margin-bottom: 24px; border: 1px solid var(--c-border-light); transition: box-shadow 0.2s ease; }
.upload-wrap { display: flex; align-items: center; justify-content: center; min-height: 70vh; }
.upload-inner { max-width: 520px; width: 100%; text-align: center; }
.upload-inner h2 { font-size: 32px; font-weight: 800; letter-spacing: -0.04em; margin-bottom: 8px; font-family: var(--font-display); }
.upload-inner p { color: #6b7280; font-size: 15px; margin-bottom: 32px; }
.dropzone { border: 2px dashed var(--c-border); border-radius: var(--radius-lg); padding: 64px 40px; text-align: center; cursor: pointer; transition: all 0.3s var(--ease-out); background: #fafbfc; }
.dropzone:hover { border-color: var(--c-primary); background: var(--c-primary-bg); }
.dropzone.dragging { border-color: #4f8cff; background: rgba(79,140,255,0.04); }
.dropzone svg { color: #9ca3af; margin-bottom: 16px; }
.dropzone .title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
.dropzone .sub { font-size: 13px; color: #9ca3af; }
.stats-row { display: flex; gap: 16px; margin-bottom: 24px; }
.stat-card { flex: 1; padding: 20px 24px; border-radius: var(--radius-md); background: var(--c-surface); box-shadow: var(--shadow-sm); border: 1px solid var(--c-border-light); transition: transform 0.15s var(--ease-out), box-shadow 0.15s ease; }
.stat-card:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
.stat-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; margin-bottom: 6px; }
.stat-value { font-size: 26px; font-weight: 800; letter-spacing: -0.03em; font-family: var(--font-display); }
.stat-filtered { font-size: 13px; font-weight: 600; color: #4f8cff; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #e0e4ea; }
.stat-pct { font-size: 11px; font-weight: 500; color: #9ca3af; }
.filters-bar { display: flex; gap: 12px; align-items: center; padding: 16px 24px; margin-bottom: 16px; flex-wrap: wrap; }
.filters-bar label { font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.06em; }
.filters-bar .count { font-size: 12px; color: #9ca3af; margin-left: auto; }
.search-wrap { position: relative; display: flex; align-items: center; }
.search-icon { position: absolute; left: 8px; font-size: 13px; pointer-events: none; z-index: 1; opacity: 0.5; }
.search-input { padding: 6px 28px 6px 28px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-weight: 500; background: #fafbfc; outline: none; transition: border-color 0.2s; font-family: inherit; width: 220px; }
.search-input:focus { border-color: #4f8cff; }
.search-input::placeholder { color: #9ca3af; font-weight: 400; }
.search-clear { position: absolute; right: 6px; cursor: pointer; color: #9ca3af; font-size: 14px; line-height: 1; padding: 2px; }
.search-clear:hover { color: #e53935; }
.filter-sep { width: 1px; height: 24px; background: var(--c-border); }
.table-wrap { overflow-x: auto; overflow-y: scroll; max-height: 75vh; overscroll-behavior: contain; overflow-anchor: none; }
.table-wrap::-webkit-scrollbar { width: 6px; }
.table-wrap::-webkit-scrollbar-track { background: transparent; }
.table-wrap::-webkit-scrollbar-thumb { background: rgba(79,140,255,0.2); border-radius: 3px; }
.table-wrap::-webkit-scrollbar-thumb:hover { background: rgba(79,140,255,0.4); }
table { width: 100%; border-collapse: collapse; }
th { padding: 8px 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; border-bottom: 2px solid #eef0f4; text-align: center; white-space: nowrap; background: #f8f9fb; cursor: pointer; user-select: none; position: sticky; top: 0; z-index: 3; line-height: 1.35; vertical-align: middle; }
th:hover { color: #4f8cff; }
th.right { text-align: center; }
th .sort-arrow { font-size: 9px; margin-left: 3px; opacity: 0.3; }
th.sorted .sort-arrow { opacity: 1; color: #4f8cff; }
th.no-sort { cursor: default; }
th.no-sort:hover { color: #6b7280; }
td { padding: 9px 10px; font-size: 13px; border-bottom: 1px solid #f3f4f6; white-space: nowrap; vertical-align: middle; }
td.right { text-align: right; font-variant-numeric: tabular-nums; }
td.bold { font-weight: 700; }
td.ellip { max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
td.muted { font-size: 12px; color: #6b7280; }
tr:hover td { background: rgba(79,140,255,0.04); }
tfoot td { position: sticky; bottom: 0; z-index: 2; background: linear-gradient(135deg, var(--c-sidebar-start), var(--c-sidebar-end)) !important; font-family: var(--font-display); }
tfoot tr:hover td { background: #0f1628 !important; }
th.col-comPlataforma, th.col-comGTC, th.col-limpieza, th.col-amenities, th.col-pasarela, th.col-noches { text-align: center; }
tr.validated td { background: rgba(22,163,74,0.06); }
tr.highlight td { animation: pulse-highlight 0.6s ease-in-out 3; }
@keyframes pulse-highlight {
  0% { background: #fff; }
  50% { background: #e3f0ff; }
  100% { background: #fff; }
}
.badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.02em; }
.badge-green { background: #e8f5e9; color: #2e7d32; }
.badge-amber { background: #fff8e1; color: #f57f17; }
.badge-blue { background: #e3f2fd; color: #1565c0; }
.badge-purple { background: #f3e5f5; color: #7b1fa2; }
.badge-red { background: #ffebee; color: #c62828; }
select.sel { padding: 6px 10px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-weight: 500; background: #fafbfc; outline: none; cursor: pointer; transition: border-color 0.2s; font-family: inherit; display: inline-block; text-align: center; text-align-last: center; }
select.sel:focus { border-color: #4f8cff; }
select.sel:disabled { opacity: 0.5; cursor: not-allowed; }
.toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; }
.toggle-track { width: 38px; height: 22px; border-radius: 11px; background: #d1d5db; position: relative; transition: background 0.2s; flex-shrink: 0; }
.toggle-track.on { background: #4f8cff; }
.toggle-thumb { position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; border-radius: 9px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.15); transition: left 0.2s; }
.toggle-track.on .toggle-thumb { left: 18px; }
.toggle-label { font-size: 11px; color: #6b7280; }
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: var(--radius-sm); border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s var(--ease-out); font-family: inherit; }
.btn:hover { opacity: 0.92; transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-primary { background: linear-gradient(135deg, var(--c-primary), var(--c-primary-dark)); color: #fff; box-shadow: 0 2px 8px rgba(79,140,255,0.25); }
.btn-primary:hover { box-shadow: 0 4px 14px rgba(79,140,255,0.35); }
.btn-success { background: #43a047; color: #fff; }
.btn-orange { background: #ef6c00; color: #fff; }
.btn-outline { background: transparent; color: #4f8cff; border: 1.5px solid #4f8cff; }
.btn-disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; }
.btn-disabled:hover { opacity: 1; }

/* MODAL */
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 100; display: flex; align-items: flex-start; justify-content: center; padding-top: 8vh; backdrop-filter: blur(3px); }
.modal { background: var(--c-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); width: 600px; max-height: 85vh; min-height: 520px; overflow-y: auto; animation: modalIn 0.25s var(--ease-out); }
@keyframes modalIn { from { opacity: 0; transform: translateY(-10px) scale(0.98); } to { opacity: 1; transform: none; } }
.modal-header { padding: 24px 28px 16px; border-bottom: 1px solid #eef0f4; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 2; border-radius: 16px 16px 0 0; }
.modal-header h3 { font-size: 18px; font-weight: 700; font-family: var(--font-display); }
.modal-close { width: 32px; height: 32px; border-radius: 8px; border: none; background: #f3f4f6; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
.modal-close:hover { background: #e5e7eb; }
.modal-body { padding: 24px 28px; }
.modal-section { margin-bottom: 28px; }
.modal-section:last-child { margin-bottom: 0; }
.modal-section h4 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; margin-bottom: 12px; }
.modal-section .desc { font-size: 12px; color: #9ca3af; margin-top: -8px; margin-bottom: 12px; }
.option-list { display: flex; flex-direction: column; gap: 6px; }
.option-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 8px; background: #f8f9fb; font-size: 14px; font-weight: 500; }
.option-delete { width: 28px; height: 28px; border-radius: 6px; border: none; background: transparent; color: #e53935; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.option-delete:hover { background: #ffebee; }
.add-row { display: flex; gap: 8px; margin-top: 10px; }
.add-input { flex: 1; padding: 8px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 14px; font-family: inherit; outline: none; }
.add-input:focus { border-color: #4f8cff; }
.add-input::placeholder { color: #bbb; }
.section-divider { border: none; border-top: 2px solid #eef0f4; margin: 28px 0; }
.modal-tabs { display: flex; gap: 4px; padding: 16px 28px 0; background: #fff; position: sticky; top: 60px; z-index: 1; border-bottom: 1px solid #eef0f4; }
.modal-tab { padding: 10px 18px; font-size: 13px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
.modal-tab:hover { color: #4f8cff; }
.modal-tab.active { color: #4f8cff; border-bottom-color: #4f8cff; }
.modal-tab.active-purple { color: #7c3aed !important; border-bottom-color: #7c3aed !important; }
/* 80/20 GTC Split Section Ã¢â‚¬â€ v2.3.1 original style */
.gtc-split-section { background: linear-gradient(135deg,#faf5ff,#f3e8ff); border: 1.5px solid #d8b4fe; border-radius: 10px; margin: 8px 0 0; padding: 14px 16px; }
.gtc-split-title { font-size: 12px; font-weight: 700; color: #7c3aed; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
.gtc-split-desc { font-size: 11px; color: #6b7280; margin-bottom: 12px; line-height: 1.5; }
.gtc-split-list { display: flex; flex-direction: column; gap: 2px; }
.gtc-split-row { display: flex; align-items: center; justify-content: space-between; padding: 7px 10px; border-radius: 6px; transition: background 0.15s; }
.gtc-split-row:hover { background: rgba(168,85,247,0.06); }
.gtc-split-row .name { font-size: 12px; font-weight: 500; }
.gtc-split-row .name.on { color: #7c3aed; font-weight: 600; }
.gtc-split-divider-row { height: 1px; background: #ede9fe; margin: 0 10px; }
.gtc-split-counter { display: flex; align-items: center; gap: 8px; margin-top: 10px; padding: 8px 10px; background: rgba(168,85,247,0.08); border-radius: 8px; font-size: 11px; color: #6b7280; }
.gtc-split-counter .badge { display: inline-flex; align-items: center; justify-content: center; background: #7c3aed; color: #fff; font-size: 10px; font-weight: 700; min-width: 20px; height: 20px; border-radius: 10px; padding: 0 6px; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ALOJAMIENTO CARDS */
.aloj-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-bottom: 24px; }
.aloj-card { background: var(--c-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 24px; transition: all 0.25s var(--ease-out); cursor: pointer; border: 2px solid transparent; position: relative; overflow: hidden; }
.aloj-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-3px); }
.aloj-card.ready { border-color: #43a047; }
.aloj-card.pending { border-color: #ff9800; }
.aloj-semaforo { position: absolute; top: 0; right: 0; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
.aloj-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; padding-right: 40px; font-family: var(--font-display); }
.aloj-edificio { font-size: 12px; color: #6b7280; margin-bottom: 16px; }
.aloj-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.aloj-stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; }
.aloj-stat-value { font-size: 18px; font-weight: 700; margin-top: 2px; font-family: var(--font-display); font-variant-numeric: tabular-nums; }
.aloj-bar { height: 4px; border-radius: 2px; background: #eef0f4; margin-top: 16px; overflow: hidden; }
.aloj-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

/* VALIDATION TOGGLE (consol grid) */
.val-toggle-wrap { display:flex; align-items:center; border-radius:8px; overflow:hidden; border:2px solid var(--c-border); background:#f0f2f5; transition:border-color 0.2s; flex-shrink:0; }
.val-toggle-wrap:hover { border-color:var(--c-primary); }
.val-toggle-btn { display:flex; align-items:center; gap:6px; padding:7px 14px; font-size:12px; font-weight:600; font-family:inherit; cursor:pointer; border:none; background:transparent; color:var(--c-text-muted); transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1); white-space:nowrap; }
.val-toggle-btn .vt-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; transition:all 0.25s; }
.val-toggle-btn.no-val .vt-dot { background:#ff9800; }
.val-toggle-btn.si-val .vt-dot { background:#43a047; }
.val-toggle-btn .vt-count { font-size:10px; font-weight:700; padding:1px 5px; border-radius:4px; background:rgba(0,0,0,0.06); color:inherit; transition:all 0.25s; }
.val-toggle-btn.active { background:var(--c-surface); color:var(--c-text); box-shadow:0 1px 4px rgba(0,0,0,0.08); }
.val-toggle-btn.active.no-val { color:#e65100; }
.val-toggle-btn.active.si-val { color:#2e7d32; }
.val-toggle-btn.active .vt-count { background:currentColor; color:#fff; }
.aloj-card.dimmed { opacity:0.35; transform:scale(0.97); filter:grayscale(0.3); transition:all 0.3s var(--ease-out); }
.aloj-card.dimmed:hover { opacity:0.6; transform:scale(0.98); }

/* CONSOLIDATED LIQUIDACION */
.consol-container { max-width: 100%; margin: 0 auto; }
.consol-header { background: var(--hm-teal); color: #fff; border-radius: 14px 14px 0 0; position: relative; overflow: hidden; }
.consol-header::after { content: none; }
.consol-header::before { content: none; }
.consol-header .header-top { padding: 28px 32px 0; position: relative; z-index: 1; }
.consol-header .type { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.14em; color: var(--hm-gold-bright); margin-bottom: 6px; }
.consol-header .name { font-size: 28px; font-weight: 800; font-family: var(--font-display); letter-spacing: -0.02em; }
.cd-progress-wrap { padding: 0 32px; position: relative; z-index: 1; }
.cd-progress { display: flex; align-items: center; gap: 12px; padding: 10px 0 14px; }
.cd-progress-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
.cd-progress-fill { height: 100%; border-radius: 3px; transition: width 0.6s cubic-bezier(0.34,1.56,0.64,1); }
.cd-progress-text { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.5); white-space: nowrap; }
.cd-progress-text strong { color: rgba(255,255,255,0.85); }
.consol-meta-strip { display: flex; gap: 0; background: var(--hm-teal-dark); position: relative; z-index: 1; }
.consol-meta-strip .consol-meta-item { flex: 1; padding: 14px 32px; border-right: 1px solid rgba(255,255,255,0.06); }
.consol-meta-strip .consol-meta-item:last-child { border-right: none; }
.consol-meta-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--hm-blue-gray); margin-bottom: 4px; }
.consol-meta-value { font-weight: 600; font-size: 14px; color: rgba(255,255,255,0.9); }
.consol-meta-value.alert { color: #ef5350; }
.consol-body { background: #fff; border-radius: 0 0 14px 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); overflow: hidden; }
.consol-section-title { padding: 14px 32px 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; background: #f8f9fb; border-top: 2px solid #eef0f4; }
.consol-section-title:first-child { border-top: none; }
/* 2-column summary layout */
.cd-summary-section { display: grid; grid-template-columns: 1fr 1fr; gap: 0; border-top: 2px solid #eef0f4; }
.cd-summary-left { padding: 24px 32px; border-right: 1px solid #eef0f4; }
.cd-summary-right { padding: 24px 32px; display: flex; flex-direction: column; }
.cd-sum-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--c-text-muted); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eef0f4; }
.consol-summary-block { padding: 0; }
.consol-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; font-size: 13px; }
.consol-row + .consol-row { border-top: 1px solid #f5f6f8; }
.consol-row.sub { padding-left: 16px; font-size: 12px; color: #6b7280; }
.consol-row .neg { color: #e53935; font-variant-numeric: tabular-nums; }
.cex-item-row .neg { color: #e53935; font-variant-numeric: tabular-nums; }
.consol-row .pos { color: #43a047; font-variant-numeric: tabular-nums; }
.consol-row.bold { font-weight: 700; color: var(--c-text); font-size: 14px; padding: 10px 0; }
.consol-divider { height: 1px; background: #eef0f4; margin: 6px 0; }
.consol-subtotal-reservas { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; font-size: 14px; font-weight: 700; background: linear-gradient(90deg,#eef3ff,#f8f9fb); border: 1.5px solid var(--c-primary); border-radius: var(--radius-md); color: #1a2744; margin: 12px 0; }
.consol-monthly-box { background: #f0fdf4; border: 1.5px dashed #16a34a; border-radius: 8px; margin: 12px 0; padding: 12px 16px; }
.consol-monthly-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #16a34a; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.consol-monthly-box .consol-row { padding: 6px 0; border-radius: 4px; }
/* Split box with visual bar */
.consol-split-box { background: linear-gradient(135deg,#faf5ff,#f3e8ff); border: 2px solid #a855f7; border-radius: 10px; margin: 12px 0; overflow: hidden; }
.consol-split-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #7c3aed; padding: 10px 16px 6px; display: flex; align-items: center; gap: 8px; }
.consol-split-box .consol-row { padding: 8px 16px; border-radius: 0; }
.consol-split-divider { height: 1px; background: #d8b4fe; margin: 0 16px; }
.consol-split-bar { display: flex; height: 8px; }
.consol-split-bar-gtc { background: linear-gradient(90deg,#7c3aed,#9333ea); color: #fff; font-size: 8px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
.consol-split-bar-owner { background: linear-gradient(90deg,#16a34a,#22c55e); color: #fff; font-size: 8px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
.consol-split-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
/* Quick stats */
.cd-quick-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.cd-qs-item { background: #f8f9fb; border-radius: var(--radius-md); padding: 12px; text-align: center; border: 1px solid #eef0f4; }
.cd-qs-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--c-text-muted); margin-bottom: 4px; }
.cd-qs-value { font-size: 18px; font-weight: 800; color: var(--c-text); font-variant-numeric: tabular-nums; }
/* Total breakdown (right column) */
.cd-tb-row { display: flex; justify-content: space-between; padding: 8px 12px; font-size: 12px; color: var(--c-text-secondary); border-radius: 6px; }
.cd-tb-row:nth-child(odd) { background: #fafbfc; }
.cd-tb-val { font-weight: 600; font-variant-numeric: tabular-nums; }
/* Split mini-card (right column) */
.cd-split-mini { background: linear-gradient(135deg,#faf5ff,#f3e8ff); border: 1.5px solid #d8b4fe; border-radius: var(--radius-md); padding: 10px 12px; margin: 8px 0; }
.cd-split-mini-header { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #7c3aed; margin-bottom: 6px; }
.cd-split-mini-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 12px; color: var(--c-text-secondary); }
/* Total hero */
.cd-total-hero { text-align: center; padding: 32px 24px; background: var(--hm-cream); border-radius: var(--radius-lg); border: 1.5px solid var(--hm-gold-border); margin: 16px 0; }
.cd-total-hero-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.14em; color: var(--hm-teal); margin-bottom: 8px; }
.cd-total-hero-amount { font-size: 36px; font-weight: 800; color: var(--c-text); letter-spacing: -0.02em; line-height: 1; }
.cd-total-hero-amount .eur { font-size: 24px; font-weight: 600; color: var(--c-text-secondary); }
/* Generate button */
.cd-btn-generate { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border-radius: var(--radius-md); background: linear-gradient(135deg,#43a047,#66bb6a); color: #fff; font-size: 15px; font-weight: 700; font-family: var(--font-body); border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(67,160,71,0.3); transition: all 0.2s; width: 100%; }
.cd-btn-generate:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(67,160,71,0.4); }
.cd-btn-generate.disabled { background: #e0e4ea; color: #9ca3af; box-shadow: none; cursor: not-allowed; }
.cd-btn-generate.disabled:hover { transform: none; }
/* Full-width total bar */
.cd-total-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 32px; background: var(--hm-teal); color: #fff; position: relative; border-left: 5px solid var(--hm-gold); }
.cd-total-bar::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: var(--hm-gold); }
.cd-total-bar-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #E0AE00; }
.cd-total-bar-label strong { display: block; font-size: 20px; color: #fff; letter-spacing: normal; margin-top: 2px; text-transform: none; }
.cd-total-bar-amount { font-size: 32px; font-weight: 700; letter-spacing: -0.02em; font-family: Georgia, 'Times New Roman', serif; color: #FFFFFF; }
/* Legacy compat */
.consol-subtotal { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; font-size: 15px; font-weight: 700; }
.consol-total { display: none; }
.consol-mini-table { margin: 0; width: 100%; table-layout: auto; }
.consol-mini-table th { font-size: 10px; padding: 10px 8px; }
.consol-mini-table td { font-size: 11px; padding: 8px 8px; }
.consol-mini-table tbody tr:hover td { background: #eef3ff; }
.consol-mini-table .ellip { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 160px; }

/* LIQUIDACI\u00D3N INDIVIDUAL */
.liq-container { max-width: 720px; margin: 0 auto; background: var(--c-surface); border-radius: var(--radius-lg); box-shadow: 0 4px 24px rgba(0,0,0,0.08); overflow: hidden; }
.liq-gold-bar-top { height: 5px; background: var(--hm-gold); border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
.liq-gold-bar-bottom { height: 4px; background: var(--hm-gold); }
.liq-header { background: var(--hm-teal); color: #fff; position: relative; overflow: hidden; }
.liq-header::after { content: none; }
.liq-header::before { content: none; }
.liq-header .type { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.14em; color: var(--hm-gold-bright); margin-bottom: 6px; }
.liq-header .name { font-size: 24px; font-weight: 800; font-family: var(--font-display); letter-spacing: -0.02em; line-height: 1.15; }
.liq-header-top { display: flex; justify-content: space-between; align-items: flex-start; padding: 24px 32px 16px; position: relative; z-index: 1; }
.liq-header-logo { font-family: Georgia, 'Times New Roman', serif; }
.liq-header-logo .logo-main { font-size: 24px; font-weight: 300; color: var(--hm-gold); letter-spacing: 0.01em; }
.liq-header-logo .logo-sub { font-size: 11px; font-weight: 300; color: var(--hm-blue-gray); letter-spacing: 0.08em; margin-left: 4px; }
.liq-meta-strip { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; background: var(--hm-teal-dark); position: relative; z-index: 1; }
.liq-meta-strip .liq-meta-item { padding: 12px 32px; border-right: 1px solid rgba(255,255,255,0.06); }
.liq-meta-strip .liq-meta-item:nth-child(3n) { border-right: none; }
.liq-meta-strip .liq-meta-item:nth-child(n+4) { border-top: 1px solid rgba(255,255,255,0.05); }
.liq-meta-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--hm-blue-gray); margin-bottom: 3px; }
.liq-meta-value { font-weight: 600; font-size: 13px; color: rgba(255,255,255,0.9); }
.liq-meta-value.sm { font-size: 11px; }
.liq-sec { padding: 20px 32px; }
.liq-sec + .liq-sec { border-top: 1px solid var(--c-border-light); }
.liq-sec-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--c-text-muted); margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--c-border-light); }
.liq-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; font-size: 13px; color: var(--c-text-secondary); }
.liq-row + .liq-row { border-top: 1px solid #f5f6f8; }
.liq-row.bold { font-weight: 700; font-size: 14px; padding: 12px 0; margin: 0 -32px; padding-left: 32px; padding-right: 32px; background: #F5F8FA; border-left: 3px solid var(--hm-teal); color: var(--c-text); }
.liq-row .neg { color: #D04545; }
.liq-row .pos { color: #2E7D32; }
.liq-row .liq-val { font-variant-numeric: tabular-nums; font-size: 13px; font-weight: 600; min-width: 110px; text-align: right; white-space: nowrap; }
.liq-divider { height: 1px; background: linear-gradient(90deg, var(--hm-gold) 0%, #D1E8E6 30%, transparent 100%); margin: 6px 0; }
.liq-sel { font-family: var(--font-body); font-size: 12px; font-weight: 600; color: var(--c-text); background: #f0f2f5; border: 1px solid var(--c-border); border-radius: 4px; padding: 3px 10px; cursor: pointer; outline: none; appearance: none; -webkit-appearance: none; margin-left: 4px; transition: border-color 0.2s; text-align: center; text-align-last: center; }
.liq-sel:focus { border-color: #4f8cff; box-shadow: 0 0 0 2px rgba(79,140,255,0.08); }
.liq-subtotal-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 32px; margin: 0 -32px; font-size: 14px; font-weight: 700; background: var(--hm-cream); border-top: 1.5px solid var(--hm-gold); border-bottom: 1.5px solid var(--hm-gold); color: var(--c-text); }
/* Pasarela integrated row */
.liq-pas-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; font-size: 13px; border-top: 1px solid #f5f6f8; }
.liq-pas-left { display: flex; align-items: center; gap: 10px; flex: 1; }
.liq-sw { position: relative; width: 36px; height: 20px; cursor: pointer; flex-shrink: 0; display: inline-block; }
.liq-sw-track { width: 100%; height: 100%; border-radius: 10px; background: #d1d5db; transition: background 0.2s; position: relative; }
.liq-sw-track.on { background: #4f8cff; }
.liq-sw-thumb { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; border-radius: 8px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.15); transition: transform 0.2s var(--ease-bounce); }
.liq-sw-track.on .liq-sw-thumb { transform: translateX(16px); }
.liq-pas-val { font-variant-numeric: tabular-nums; font-size: 13px; font-weight: 600; color: var(--c-error); min-width: 110px; text-align: right; transition: all 0.2s; }
.liq-pas-val.off { color: var(--c-text-muted); opacity: 0.4; text-decoration: line-through; }
/* CE2 section */
.liq-ce2 { background: var(--c-primary-bg); border-top: 2px solid var(--c-primary); position: relative; padding: 0 32px; }
.liq-ce2 .liq-sec-label { color: var(--c-primary-dark); }
.liq-ce2 .liq-val { color: var(--c-error); }
.liq-ce2-dot { display: inline-block; width: 5px; height: 5px; border-radius: 50%; background: var(--c-primary); margin-right: 6px; vertical-align: middle; }
/* Total */
.liq-total-bar { position: relative; }
.liq-total-bar::before { content: ''; display: block; height: 5px; background: var(--hm-gold); }
.liq-total { display: flex; justify-content: space-between; align-items: center; padding: 22px 32px; background: var(--hm-teal); color: #fff; border-left: 5px solid var(--hm-gold); }
.liq-total-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #E0AE00; }
.liq-total-label-sub { font-size: 20px; font-weight: 700; color: #fff; margin-top: 2px; text-transform: none; letter-spacing: normal; }
.liq-total-value { font-family: Georgia, 'Times New Roman', serif; font-size: 32px; font-weight: 700; color: #FFFFFF; letter-spacing: -0.02em; }
.liq-actions { display: flex; gap: 12px; justify-content: center; padding: 20px 32px; background: #f8f9fb; border-top: 1px solid var(--c-border-light); }
.header-top { display: flex; justify-content: space-between; align-items: flex-start; }
.badge-liq { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; }
.badge-liq-green { background: rgba(67,160,71,0.15); color: #81c784; border: 1px solid rgba(67,160,71,0.3); }
.badge-liq-amber { background: rgba(255,152,0,0.15); color: #ffb74d; border: 1px solid rgba(255,152,0,0.3); }

.screen { display: none; }
.screen.active { display: block; animation: screenFadeIn 0.2s ease; }
@keyframes screenFadeIn { from { opacity: 0; } to { opacity: 1; } }
.gear-btn { width: 36px; height: 36px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; }
.gear-btn:hover { border-color: #4f8cff; background: #f0f5ff; }

/* SEARCHABLE COMBO */
.combo { position: relative; min-width: 190px; }
.combo-input { padding: 6px 30px 6px 10px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-weight: 500; background: #fafbfc; outline: none; cursor: pointer; transition: border-color 0.2s; font-family: inherit; width: 100%; }
.combo-input:focus { border-color: #4f8cff; }
.combo-input::placeholder { color: #6b7280; font-weight: 500; }
.combo-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; border-radius: 4px; display: none; align-items: center; justify-content: center; font-size: 11px; color: #9ca3af; cursor: pointer; background: transparent; }
.combo-clear:hover { color: #e53935; background: #ffebee; }
.combo.has-value .combo-clear { display: flex; }
.combo.has-value .combo-input { padding-right: 30px; font-weight: 600; color: #1a1a2e; }
.combo-list { display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; max-height: 260px; overflow-y: auto; padding: 4px; }
.combo-list.open { display: block; }
.combo-item { padding: 8px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
.combo-item:hover { background: #eef3ff; }
.combo-item.active { background: #e3f2fd; font-weight: 600; color: #4f8cff; }
.combo-item .match { font-weight: 700; color: #4f8cff; }
.combo-item-count { font-size: 11px; color: #9ca3af; margin-left: 6px; }
.combo-empty { padding: 12px; font-size: 12px; color: #9ca3af; text-align: center; }
/* EMAIL MODULE */
.email-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 28px; border-radius: var(--radius-md); background: linear-gradient(135deg, #1976d2, #42a5f5); color: #fff; font-size: 14px; font-weight: 700; font-family: var(--font-body); border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(25,118,210,0.3); transition: all 0.2s; width: 100%; margin-top: 8px; }
.email-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(25,118,210,0.4); }
.email-btn.disabled { background: #e0e4ea; color: #9ca3af; box-shadow: none; cursor: not-allowed; }
.email-btn.disabled:hover { transform: none; }
.pdf-download-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 28px; border-radius: var(--radius-md); background: linear-gradient(135deg, #6366f1, #818cf8); color: #fff; font-size: 14px; font-weight: 700; font-family: var(--font-body); border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(99,102,241,0.3); transition: all 0.2s; width: 100%; margin-top: 8px; }
.pdf-download-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(99,102,241,0.4); }
.pdf-download-btn.disabled { background: #e0e4ea; color: #9ca3af; box-shadow: none; cursor: not-allowed; }
.pdf-download-btn.disabled:hover { transform: none; }
.pdf-download-btn:disabled { background: #c7d2fe; color: #fff; cursor: wait; transform: none; box-shadow: none; }
.email-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
.email-modal { background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 480px; max-width: 90vw; max-height: 90vh; overflow: auto; }
.email-modal-header { padding: 24px 28px 0; }
.email-modal-header h3 { font-family: var(--font-display); font-size: 20px; font-weight: 800; color: var(--c-text); margin: 0 0 4px; }
.email-modal-header p { font-size: 13px; color: #6b7280; margin: 0; }
.email-modal-body { padding: 20px 28px; }
.email-modal-field { margin-bottom: 16px; }
.email-modal-field label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #6b7280; margin-bottom: 6px; }
.email-modal-field input, .email-modal-field textarea { width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; font-family: var(--font-body); transition: border-color 0.2s; outline: none; box-sizing: border-box; }
.email-modal-field input:focus, .email-modal-field textarea:focus { border-color: #1D4B56; }
.email-modal-field textarea { resize: vertical; min-height: 80px; }
.email-modal-footer { padding: 0 28px 24px; display: flex; gap: 10px; justify-content: flex-end; }
.email-modal-footer .btn-send { padding: 10px 24px; border-radius: 10px; background: linear-gradient(135deg, #1D4B56, #306472); color: #fff; font-weight: 700; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s; }
.email-modal-footer .btn-send:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(29,75,86,0.3); }
.email-modal-footer .btn-send:disabled { background: #163E47; color: #E8BE4B; cursor: wait; transform: none; box-shadow: none; }
.email-modal-footer .btn-cancel { padding: 10px 24px; border-radius: 10px; background: #f3f4f6; color: #374151; font-weight: 600; font-size: 14px; border: none; cursor: pointer; }
.email-status { padding: 12px 16px; border-radius: 10px; font-size: 13px; margin-top: 12px; display: none; }
.email-status.sending { display: block; background: #FBF4E8; color: #1D4B56; border: 1px solid rgba(224,174,0,0.3); }
.email-status.success { display: block; background: #E8F5E2; color: #1D4B56; border: 1px solid #9ED48E; }
.email-status.error { display: block; background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
@media print {
  @page { size: A4 landscape; margin: 10mm 12mm; }
  body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  body * { visibility: hidden; }
  .print-target, .print-target * { visibility: visible; }
  .print-target { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none !important; border-radius: 0 !important; }
  .sidebar, .btn, .no-print, .liq-actions, .gear-btn, .email-btn, .pdf-download-btn { display: none !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Containers ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .consol-container, .liq-container { max-width: 100% !important; box-shadow: none !important; border-radius: 0 !important; overflow: visible !important; border: none !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Consolidated header (CRITICAL: overflow + z-index reset) ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .consol-header { overflow: visible !important; border-radius: 0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .consol-header::before { display: none !important; }
  .consol-header .header-top { display: flex !important; justify-content: space-between !important; align-items: flex-start !important; padding: 14px 20px 6px !important; position: static !important; z-index: auto !important; }
  .consol-header .type { font-size: 9px !important; }
  .consol-header .name { font-size: 17px !important; line-height: 1.2 !important; }
  .cd-progress-wrap { padding: 2px 20px 0 !important; position: static !important; z-index: auto !important; }
  .cd-progress { display: flex !important; align-items: center !important; gap: 10px !important; padding: 4px 0 6px !important; }
  .cd-progress-bar { height: 4px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .cd-progress-fill { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .cd-progress-text { font-size: 9px !important; }
  .consol-meta-strip { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 0 !important; position: static !important; z-index: auto !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .consol-meta-strip .consol-meta-item { padding: 8px 16px !important; }
  .consol-meta-label { font-size: 7px !important; margin-bottom: 2px !important; }
  .consol-meta-value { font-size: 11px !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Individual header ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .liq-header { overflow: visible !important; border-radius: 0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-header::before { display: none !important; }
  .liq-header::after { display: none !important; }
  .liq-gold-bar-top, .liq-gold-bar-bottom { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-header-logo { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-header-top { display: flex !important; justify-content: space-between !important; align-items: flex-start !important; padding: 12px 20px 6px !important; position: static !important; z-index: auto !important; }
  .liq-header .type { font-size: 9px !important; }
  .liq-header .name { font-size: 17px !important; line-height: 1.2 !important; }
  .liq-meta-strip { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; position: static !important; z-index: auto !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-meta-strip .liq-meta-item { padding: 8px 16px !important; }
  .liq-meta-label { font-size: 7px !important; margin-bottom: 2px !important; }
  .liq-meta-value { font-size: 11px !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Badge ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .badge-liq { font-size: 8px !important; padding: 3px 8px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Consolidated body & table ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .consol-body { box-shadow: none !important; border-radius: 0 !important; overflow: visible !important; }
  .table-wrap { overflow: visible !important; }
  table { page-break-inside: auto; }
  thead { display: table-header-group; }
  tr { page-break-inside: avoid; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Mini table ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â compact for landscape A4 ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .consol-mini-table { table-layout: fixed !important; width: 100% !important; }
  .consol-mini-table th { padding: 4px 5px !important; font-size: 8px !important; }
  .consol-mini-table td { padding: 4px 5px !important; font-size: 9px !important; }
  .consol-mini-table .ellip { max-width: 0; }
  .badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 7px !important; padding: 1px 4px !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Summary 2-column ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .cd-summary-section { display: grid !important; grid-template-columns: 1.2fr 0.8fr !important; page-break-inside: avoid !important; break-inside: avoid !important; max-width: 100% !important; }
  .cd-summary-left { padding: 14px 18px !important; }
  .cd-summary-right { padding: 14px 18px !important; display: flex !important; flex-direction: column !important; }
  .cd-sum-title { font-size: 9px !important; margin-bottom: 8px !important; padding-bottom: 4px !important; }
  .consol-section-title { padding: 8px 0 4px !important; font-size: 9px !important; page-break-after: avoid; }
  .consol-row { padding: 3px 0 !important; font-size: 10px !important; }
  .consol-row.bold { font-size: 11px !important; }
  .consol-row.sub { padding-left: 12px !important; font-size: 9px !important; }
  .consol-divider { margin: 2px 0 !important; }
  .consol-subtotal { padding: 5px 0 !important; font-size: 11px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .consol-subtotal-reservas { padding: 5px 10px !important; font-size: 10px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .consol-monthly-box { margin: 4px 0 !important; padding: 6px 10px !important; }
  .consol-split-box { margin: 6px 0 !important; padding: 6px 10px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .consol-split-bar { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .consol-split-bar-gtc, .consol-split-bar-owner { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Quick stats (right column) ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .cd-quick-stats { gap: 6px !important; margin-bottom: 10px !important; }
  .cd-qs-item { padding: 6px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .cd-qs-label { font-size: 7px !important; }
  .cd-qs-value { font-size: 13px !important; }
  .cd-tb-row { font-size: 10px !important; padding: 2px 0 !important; }
  .cd-split-mini { padding: 4px 8px !important; margin: 4px 0 !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Total hero ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .cd-total-hero { padding: 12px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .cd-total-hero-label { font-size: 8px !important; }
  .cd-total-hero-amount { font-size: 22px !important; }
  .cd-btn-generate { display: none !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Total bar (full-width) ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .cd-total-bar { padding: 10px 16px !important; border-radius: 0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .cd-total-bar::before { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .cd-total-bar-label { font-size: 8px !important; }
  .cd-total-bar-label strong { font-size: 14px !important; }
  .cd-total-bar-amount { font-size: 22px !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Individual liquidacion rows ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .liq-sec { padding: 10px 20px !important; }
  .liq-row { padding: 4px 0 !important; font-size: 11px !important; }
  .liq-row.bold { margin: 0 -20px !important; padding: 6px 20px !important; font-size: 12px !important; }
  .liq-subtotal-bar { margin: 0 -20px !important; padding: 6px 20px !important; font-size: 12px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-pas-row { padding: 4px 0 !important; font-size: 11px !important; }
  .liq-divider { margin: 2px 0 !important; }
  .liq-total { padding: 10px 20px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-total-label { font-size: 8px !important; }
  .liq-total-label-sub { font-size: 14px !important; }
  .liq-total-value { font-size: 22px !important; }
  .liq-total-bar::before { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-ce2 { -webkit-print-color-adjust: exact; print-color-adjust: exact; padding: 0 20px !important; }
  .liq-sec-label { font-size: 8px !important; margin-bottom: 6px !important; }
  .liq-actions { display: none !important; }
  .liq-sw { display: none !important; }
  .liq-sel { font-size: 10px !important; }

  /* ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ Print cards ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ */
  .print-card { page-break-inside: avoid !important; break-inside: avoid !important; margin-bottom: 12px !important; }
  .print-summary { page-break-inside: avoid !important; break-inside: avoid !important; margin-top: 12px !important; }
  .consol-summary-block { page-break-inside: avoid !important; break-inside: avoid !important; }
}
::-webkit-scrollbar { height: 6px; width: 6px; }
::-webkit-scrollbar-thumb { background: #cfd5de; border-radius: 3px; }
/* GOOGLE SHEETS UI */
.gsheet-section { margin-top: 32px; padding-top: 28px; border-top: 2px solid #eef0f4; }
.gsheet-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; font-family: var(--font-display); }
.gsheet-section p { font-size: 13px; color: #9ca3af; margin-bottom: 16px; }
.gsheet-status { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; margin-bottom: 16px; }
.gsheet-status.connected { background: #e8f5e9; color: #2e7d32; }
.gsheet-status.disconnected { background: #f3f4f6; color: #6b7280; }
.gsheet-status .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.gsheet-status.connected .dot { background: #43a047; }
.gsheet-status.disconnected .dot { background: #9ca3af; }
.gsheet-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
.gsheet-history { margin-top: 20px; }
.gsheet-history h4 { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; margin-bottom: 10px; }
.gsheet-history-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 8px; background: #f8f9fb; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; border: 1.5px solid transparent; }
.gsheet-history-item:hover { border-color: #4f8cff; background: #f0f5ff; }
.gsheet-history-item .name { font-size: 13px; font-weight: 600; }
.gsheet-history-item .meta { font-size: 11px; color: #9ca3af; }
.gsheet-history-item .remove-btn { width: 24px; height: 24px; border-radius: 6px; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
.gsheet-history-item .remove-btn:hover { background: #ffebee; color: #e53935; }
.gsheet-url-row { display: flex; gap: 8px; margin-bottom: 12px; }
.gsheet-url-input { flex: 1; padding: 10px 14px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-family: inherit; outline: none; }
.gsheet-url-input:focus { border-color: #4f8cff; }
.gsheet-url-input::placeholder { color: #bbb; }
.gsheet-loading { display: flex; align-items: center; gap: 10px; padding: 16px; font-size: 14px; color: #6b7280; }
.gsheet-spinner { width: 20px; height: 20px; border: 2.5px solid #e0e4ea; border-top-color: #4f8cff; border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.sidebar-google { padding: 10px 24px; border-top: 1px solid rgba(255,255,255,0.08); }
.sidebar-google .status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }
.sidebar-google .status-text { font-size: 11px; color: rgba(255,255,255,0.5); }
.sidebar-google .status-dot.on { background: #43a047; }
.sidebar-google .status-dot.off { background: #666; }
/* SYNC INDICATOR */
.sync-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; transition: background 0.3s; }
.sync-dot.idle { background: #43a047; }
.sync-dot.syncing { background: #ff9800; animation: sync-pulse 0.8s ease-in-out infinite; }
.sync-dot.saved { background: #43a047; }
.sync-dot.error { background: #e53935; }
@keyframes sync-pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
.page-header h1 { font-size: 26px; font-weight: 800; letter-spacing: -0.03em; font-family: var(--font-display); }
.page-header p { color: #6b7280; font-size: 14px; margin-top: 4px; }
/* COLUMN TOGGLE DROPDOWN */
.col-toggle-wrap { position: relative; }
.col-toggle-btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fafbfc; font-size: 12px; font-weight: 600; color: #6b7280; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.col-toggle-btn:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
.col-toggle-dd { display: none; position: absolute; top: calc(100% + 4px); right: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; padding: 8px 4px; min-width: 200px; max-height: 60vh; overflow-y: auto; }
.col-toggle-dd.open { display: block; }
.col-toggle-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; }
.col-toggle-item:hover { background: #eef3ff; }
.col-toggle-item input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; }
.col-toggle-item.locked { opacity: 0.4; cursor: not-allowed; }
.col-toggle-item.locked:hover { background: transparent; }
/* MONTH PICKER */
.mp-wrap { position: relative; }
.mp-btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fafbfc; font-size: 13px; font-weight: 500; color: #6b7280; cursor: pointer; font-family: inherit; transition: all 0.2s; white-space: nowrap; }
.mp-btn:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
.mp-btn.active { border-color: #4f8cff; background: #e3f2fd; color: #1565c0; font-weight: 600; }
.mp-btn .mp-icon { font-size: 14px; }
.mp-btn .mp-clear { margin-left: 4px; width: 16px; height: 16px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; color: #9ca3af; }
.mp-btn .mp-clear:hover { color: #e53935; background: #ffebee; }
.mp-nav { display: inline-flex; align-items: center; gap: 0; margin-right: 2px; }
.mp-arrow { width: 22px; height: 22px; border-radius: 5px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #4f8cff; display: inline-flex; align-items: center; justify-content: center; transition: all 0.15s; font-family: inherit; padding: 0; }
.mp-arrow:hover { background: rgba(79,140,255,0.15); }
.mp-dd { display: none; position: absolute; top: calc(100% + 4px); left: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; padding: 12px; min-width: 280px; }
.mp-dd.open { display: block; }
.mp-years { display: flex; gap: 4px; margin-bottom: 10px; flex-wrap: wrap; }
.mp-year { padding: 5px 12px; border-radius: 6px; border: 1.5px solid #e0e4ea; background: #fafbfc; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; font-family: inherit; color: #6b7280; }
.mp-year:hover { border-color: #4f8cff; color: #4f8cff; }
.mp-year.sel { background: #4f8cff; color: #fff; border-color: #4f8cff; }
.mp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
.mp-month { padding: 8px 4px; border-radius: 6px; border: none; background: #f8f9fb; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; font-family: inherit; text-align: center; color: #1a1a2e; }
.mp-month:hover { background: #e3f2fd; color: #1565c0; }
.mp-month.sel { background: #4f8cff; color: #fff; font-weight: 700; }
.mp-month.dim { opacity: 0.3; cursor: default; pointer-events: none; }
.mp-month .mp-cnt { display: block; font-size: 10px; font-weight: 400; opacity: 0.6; margin-top: 1px; }
.mp-month.sel .mp-cnt { opacity: 0.8; }
.mp-all { display: block; width: 100%; padding: 7px; margin-top: 8px; border-radius: 6px; border: 1.5px dashed #dde1e8; background: transparent; font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; color: #6b7280; text-align: center; transition: all 0.15s; }
.mp-all:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
/* MULTI-SELECT COMBO ADDITIONS */
.combo-item-chk { display: flex; align-items: center; gap: 8px; padding: 7px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; }
.combo-item-chk:hover { background: #eef3ff; }
.combo-item-chk input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; flex-shrink: 0; }
.combo-item-chk .match { font-weight: 700; color: #4f8cff; }
.combo-item-chk .combo-item-count { font-size: 11px; color: #9ca3af; margin-left: auto; }
.combo-selall { display: flex; align-items: center; gap: 8px; padding: 7px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; color: #4f8cff; font-weight: 600; border-bottom: 1px solid #eef0f4; margin-bottom: 2px; }
.combo-selall:hover { background: #f0f5ff; }
.combo-selall input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; flex-shrink: 0; }
.combo-tags { display: flex; gap: 4px; flex-wrap: wrap; max-width: 240px; }
.combo-tag { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 4px; background: #e3f2fd; color: #1565c0; font-size: 11px; font-weight: 600; white-space: nowrap; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
/* === CONCEPTOS ESPECIALES === */
.ce-btn { display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:7px;border:1.5px dashed #d0d5dd;background:transparent;color:#9ca3af;font-size:15px;cursor:pointer;transition:all .15s;padding:0; }
.ce-btn * { pointer-events:none; }
.ce-btn:hover { border-color:#f59e0b;background:#fffbeb;color:#f59e0b;transform:scale(1.08); }
.ce-btn.has { width:auto;padding:0 8px;height:24px;gap:4px;border:1.5px solid #f59e0b;background:#fffbeb;color:#d97706;font-size:11px;font-weight:700;border-style:solid;white-space:nowrap; }
.ce-btn.has .ce-dot { width:5px;height:5px;border-radius:50%;background:#f59e0b;animation:cePulse 2s infinite; }
.ce-btn.has:hover { background:#fef3c7;border-color:#d97706; }
@keyframes cePulse { 0%,100%{opacity:1}50%{opacity:.4} }
.ce-panel-row td { padding:0!important;border-bottom:1px solid #f59e0b!important; }
.ce-panel-inner { background:#fffdf5;border-top:2px solid #f59e0b;padding:12px 16px 12px 48px;display:flex;align-items:flex-start;gap:16px;animation:ceSlide .2s ease; }
@keyframes ceSlide { from{opacity:0;max-height:0}to{opacity:1;max-height:300px} }
.ce-panel-left { flex:1; }
.ce-panel-title { font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#d97706;margin-bottom:8px;display:flex;align-items:center;gap:8px; }
.ce-panel-title .ce-eye { font-size:9px;color:#9ca3af;font-weight:500;letter-spacing:0;text-transform:none; }
.ce-item-row { display:flex;align-items:center;gap:8px;margin-bottom:5px; }
.ce-item-row.ce-new { animation:ceRowIn .25s ease; }
@keyframes ceRowIn { from { opacity:0;max-height:0;margin-bottom:0;overflow:hidden; } to { opacity:1;max-height:40px;margin-bottom:5px; } }
@keyframes ceRowOut { from { opacity:1;max-height:40px;margin-bottom:5px; } to { opacity:0;max-height:0;margin-bottom:0;overflow:hidden; } }
.ce-item-row input { border:1px solid #e5e7eb;border-radius:5px;padding:4px 8px;font-size:12px;font-family:inherit;background:white; }
.ce-item-row .ce-inp-label { width:180px; }
.ce-item-row .ce-inp-amt { width:90px;text-align:right;font-weight:600; }
.ce-item-row .ce-del { width:22px;height:22px;border-radius:5px;border:none;background:#fef2f2;color:#ef4444;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center; }
.ce-item-row .ce-del:hover { background:#ef4444;color:white; }
.ce-add-link { color:#4f8cff;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-top:2px; }
.ce-add-link:hover { text-decoration:underline; }
.ce-panel-summary { text-align:right;padding:8px 14px;background:#fef3c7;border-radius:8px;min-width:140px; }
.ce-panel-summary .ce-sum-label { font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#92400e;line-height:1.3; }
.ce-panel-summary .ce-sum-val { font-size:16px;font-weight:700;color:#d97706;margin-top:4px; }
tr.ce-highlighted { background:#fffdf5; }
/* === CE SIN IVA (violet) === */
.ce2-btn { display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:7px;border:1.5px dashed #d0d5dd;background:transparent;color:#9ca3af;font-size:15px;cursor:pointer;transition:all .15s;padding:0; }
.ce2-btn * { pointer-events:none; }
.ce2-btn:hover { border-color:#7c3aed;background:#f5f0ff;color:#7c3aed;transform:scale(1.08); }
.ce2-btn.has { width:auto;padding:0 8px;height:24px;gap:4px;border:1.5px solid #7c3aed;background:#f5f0ff;color:#6d28d9;font-size:11px;font-weight:700;border-style:solid;white-space:nowrap; }
.ce2-btn.has .ce2-dot { width:5px;height:5px;border-radius:50%;background:#7c3aed;animation:cePulse 2s infinite; }
.ce2-btn.has:hover { background:#ede9fe;border-color:#6d28d9; }
.ce2-panel-row td { padding:0!important;border-bottom:1px solid #7c3aed!important; }
.ce2-panel-inner { background:#faf8ff;border-top:2px solid #7c3aed;padding:12px 16px 12px 48px;display:flex;align-items:flex-start;gap:16px;animation:ceSlide .2s ease; }
.ce2-panel-left { flex:1; }
.ce2-panel-title { font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#7c3aed;margin-bottom:8px;display:flex;align-items:center;gap:8px; }
.ce2-panel-title .ce2-eye { font-size:9px;color:#9ca3af;font-weight:500;letter-spacing:0;text-transform:none; }
.ce2-item-row { display:flex;align-items:center;gap:8px;margin-bottom:5px; }
.ce2-item-row.ce2-new { animation:ceRowIn .25s ease; }
.ce2-item-row input { border:1px solid #e5e7eb;border-radius:5px;padding:4px 8px;font-size:12px;font-family:inherit;background:white; }
.ce2-item-row .ce2-inp-label { width:180px; }
.ce2-item-row .ce2-inp-amt { width:90px;text-align:right;font-weight:600; }
.ce2-item-row .ce2-del { width:22px;height:22px;border-radius:5px;border:none;background:#fef2f2;color:#ef4444;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center; }
.ce2-item-row .ce2-del:hover { background:#ef4444;color:white; }
.ce2-add-link2 { color:#7c3aed;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-top:2px; }
.ce2-add-link2:hover { text-decoration:underline; }
.ce2-panel-summary { text-align:right;padding:8px 14px;background:#f5f0ff;border-radius:8px;min-width:140px; }
.ce2-panel-summary .ce2-sum-label { font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#5b21b6;line-height:1.3; }
.ce2-panel-summary .ce2-sum-val { font-size:16px;font-weight:700;color:#7c3aed;margin-top:4px; }
tr.ce2-highlighted { background:#faf8ff; }
@media print { .ce-panel-row,.col-ce,.cc-ce,.ce-highlighted,.ce2-panel-row,.col-ceSinIva,.cc-ceSinIva,.ce2-highlighted { display:none!important;background:transparent!important; } }
/* === AI ASSISTANT === */
.ai-fab { position:fixed; bottom:24px; right:24px; width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,var(--c-primary),var(--c-primary-dark)); color:#fff; border:none; font-size:24px; cursor:pointer; box-shadow:0 4px 16px rgba(79,140,255,0.4); z-index:90; display:flex; align-items:center; justify-content:center; transition:transform 0.25s var(--ease-bounce),box-shadow 0.2s; }
.ai-fab:hover { transform:scale(1.08); box-shadow:0 6px 24px rgba(79,140,255,0.5); }
.ai-fab .fab-badge { position:absolute; top:-2px; right:-2px; width:14px; height:14px; background:#43a047; border-radius:50%; border:2px solid #fff; display:none; }
.ai-panel { position:fixed; right:-420px; top:0; bottom:0; width:400px; background:#fff; box-shadow:-4px 0 24px rgba(0,0,0,0.12); z-index:95; display:flex; flex-direction:column; transition:right 0.3s cubic-bezier(0.16,1,0.3,1); }
.ai-panel.open { right:0; }
.ai-header { padding:16px 20px; background:linear-gradient(135deg,#0f1628,#1a2744); color:#fff; display:flex; align-items:center; gap:12px; }
.ai-header h3 { margin:0; font-size:15px; font-weight:600; flex:1; }
.ai-header .ai-close { background:none; border:none; color:rgba(255,255,255,0.6); font-size:20px; cursor:pointer; padding:4px; }
.ai-header .ai-close:hover { color:#fff; }
.ai-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
.ai-msg { max-width:88%; padding:10px 14px; border-radius:14px; font-size:13px; line-height:1.5; word-wrap:break-word; }
.ai-msg.user { align-self:flex-end; background:#4f8cff; color:#fff; border-bottom-right-radius:4px; }
.ai-msg.assistant { align-self:flex-start; background:#f1f3f5; color:#1a2744; border-bottom-left-radius:4px; }
.ai-msg.assistant strong { font-weight:700; }
.ai-msg.system { align-self:center; background:transparent; color:#9ca3af; font-size:11px; text-align:center; padding:4px; }
.ai-msg.error { align-self:center; background:#fef2f2; color:#dc2626; font-size:12px; text-align:center; border-radius:8px; }
.ai-msg.info { align-self:center; background:#eff6ff; color:#2563eb; font-size:12px; text-align:center; border-radius:8px; font-style:italic; }
.ai-input-wrap { padding:12px 16px; border-top:1px solid #eef0f4; display:flex; gap:8px; background:#fff; }
.ai-input-wrap textarea { flex:1; border:1.5px solid #dde1e8; border-radius:10px; padding:10px 12px; font-size:13px; font-family:inherit; resize:none; outline:none; min-height:20px; max-height:100px; line-height:1.4; }
.ai-input-wrap textarea:focus { border-color:#4f8cff; }
.ai-input-wrap button { background:#4f8cff; color:#fff; border:none; border-radius:10px; padding:0 16px; cursor:pointer; font-size:14px; font-weight:600; transition:background 0.2s; }
.ai-input-wrap button:hover { background:#3b6de0; }
.ai-input-wrap button:disabled { background:#a0c4ff; cursor:not-allowed; }
.ai-typing { display:flex; gap:4px; padding:8px 14px; }
.ai-typing span { width:7px; height:7px; background:#9ca3af; border-radius:50%; animation:aiDot 1.4s infinite; }
.ai-typing span:nth-child(2) { animation-delay:0.2s; }
.ai-typing span:nth-child(3) { animation-delay:0.4s; }
@keyframes aiDot { 0%,80%,100%{opacity:0.3;transform:scale(0.8)} 40%{opacity:1;transform:scale(1)} }
@media print { .ai-fab,.ai-panel { display:none!important; } }
.ai-chips { display:flex; flex-wrap:wrap; gap:6px; padding:4px 0 8px; }
.ai-chip { background:#f0f4ff; border:1px solid #d4ddee; border-radius:16px; padding:6px 12px; font-size:11.5px; color:#3b5998; cursor:pointer; transition:all 0.2s; font-family:inherit; line-height:1.3; text-align:left; }
.ai-chip:hover { background:#dce6ff; border-color:#92b0f0; }
.ai-chip:active { transform:scale(0.97); }
.ai-chips-hidden { display:none !important; }
.ai-alert { align-self:stretch !important; max-width:100% !important; background:linear-gradient(135deg,#fffbeb,#fef3c7); color:#92400e; border:1px solid #fcd34d; border-radius:10px; font-size:12px; line-height:1.6; padding:12px 14px !important; }
.ai-alert strong { color:#78350f; }
.ai-export-link { display:inline-block; margin-top:6px; padding:4px 10px; background:#4f8cff; color:#fff !important; border-radius:6px; text-decoration:none; font-size:11px; font-weight:600; cursor:pointer; }
.ai-export-link:hover { background:#3b6de0; }
.ai-followups { display:flex; flex-wrap:wrap; gap:4px; padding:2px 0 4px; }
.ai-followup-btn { background:#f0f7ff; color:#1e40af; border:1px solid #dbeafe; border-radius:14px; padding:4px 10px; font-size:11px; cursor:pointer; transition:all 0.15s; font-family:inherit; }
.ai-followup-btn:hover { background:#dbeafe; border-color:#93c5fd; }
/* Help button */
.ai-help-btn { background:none; border:1px solid rgba(255,255,255,0.25); color:rgba(255,255,255,0.75); font-size:15px; cursor:pointer; padding:2px 7px; border-radius:6px; transition:all 0.2s; }
.ai-help-btn:hover { color:#fff; background:rgba(255,255,255,0.12); border-color:rgba(255,255,255,0.5); }
/* Help overlay */
.ai-help-overlay { display:none; position:absolute; top:56px; left:0; right:0; bottom:0; z-index:10; background:#f8fafc; overflow-y:auto; }
.ai-help-overlay.open { display:block; }
.ai-help-scroll { padding:20px 22px 40px; }
.ai-help-header { text-align:center; margin-bottom:20px; padding-bottom:16px; border-bottom:2px solid #e2e8f0; }
.ai-help-header h2 { font-size:17px; color:#1a2744; margin:0 0 6px; }
.ai-help-header p { font-size:12.5px; color:#64748b; margin:0 0 12px; }
.ai-help-close { background:#4f8cff; color:#fff; border:none; padding:6px 16px; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; }
.ai-help-close:hover { background:#3b6de0; }
.ai-help-section { margin-bottom:20px; }
.ai-help-section h3 { font-size:14px; color:#1a2744; margin:0 0 8px; padding-bottom:6px; border-bottom:1px solid #e2e8f0; }
.ai-help-section p { font-size:12.5px; color:#374151; line-height:1.6; margin:0 0 8px; }
.ai-help-section ol, .ai-help-section > ul { font-size:12.5px; color:#374151; line-height:1.7; margin:0 0 8px; padding-left:20px; }
.ai-help-example { background:#f0f7ff; border:1px solid #dbeafe; border-radius:8px; padding:10px 14px; margin:8px 0; }
.ai-help-example strong { font-size:12px; color:#1e40af; display:block; margin-bottom:4px; }
.ai-help-example ul { font-size:12px; color:#1e3a5f; margin:0; padding-left:18px; line-height:1.8; }
.ai-help-example li { margin-bottom:2px; }
.ai-help-tip { background:linear-gradient(135deg,#fefce8,#fef9c3); border:1px solid #fde68a; border-radius:8px; padding:8px 12px; font-size:12px; color:#854d0e; line-height:1.5; margin:8px 0; }
.ai-help-table { width:100%; border-collapse:collapse; font-size:11.5px; margin:8px 0; }
.ai-help-table th { background:#1a2744; color:#fff; padding:6px 8px; text-align:left; font-weight:600; }
.ai-help-table td { padding:5px 8px; border-bottom:1px solid #e2e8f0; color:#374151; }
.ai-help-table tr:nth-child(even) td { background:#f8fafc; }
.ai-help-table code { background:#e2e8f0; padding:1px 4px; border-radius:3px; font-size:11px; }

/* === TOAST NOTIFICATIONS === */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
.toast { pointer-events: auto; display: flex; align-items: center; gap: 10px; padding: 12px 18px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; font-family: var(--font-body); box-shadow: var(--shadow-lg); animation: toastIn 0.3s var(--ease-out); max-width: 380px; }
.toast.leaving { animation: toastOut 0.25s ease forwards; }
.toast-success { background: var(--c-success-bg); color: #15803d; border: 1px solid #bbf7d0; }
.toast-error { background: var(--c-error-bg); color: var(--c-error); border: 1px solid #fecaca; }
.toast-warning { background: var(--c-warning-bg); color: #b45309; border: 1px solid #fde68a; }
.toast-info { background: var(--c-primary-bg); color: var(--c-primary-dark); border: 1px solid #bfdbfe; }
.toast-icon { font-size: 16px; flex-shrink: 0; }
.toast-close { margin-left: auto; cursor: pointer; opacity: 0.5; font-size: 14px; padding: 2px; flex-shrink: 0; }
.toast-close:hover { opacity: 1; }
@keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: none; } }
@keyframes toastOut { to { opacity: 0; transform: translateX(40px); } }
</style>
<style id="col-visibility-style"></style>
<style id="consol-col-visibility-style"></style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
<div id="toast-container" class="toast-container"></div>

<div class="sidebar">
  <div class="logo"><h1 data-i18n="app.title">Liquidaciones</h1><p data-i18n="app.subtitle">Gesti&oacute;n de Reservas</p></div>
  <nav style="margin-top:16px; flex:1;">
    <div class="nav-item active" id="nav-upload" onclick="showScreen('upload')">&#128228; <span data-i18n="nav.upload">Cargar Fichero</span></div>
    <div class="nav-item" id="nav-list" onclick="showScreen('list')">&#128203; <span data-i18n="nav.list">Por Reserva</span></div>
    <div class="nav-item" id="nav-detail" onclick="showScreen('detail')" style="display:none;">&#128065; <span data-i18n="nav.detail">Liquidaci&oacute;n Reserva</span></div>
    <div class="nav-item" id="nav-consol" onclick="showScreen('consol')" style="display:none;">&#127968; <span data-i18n="nav.consol">Por Alojamiento</span></div>
    <div class="nav-item" id="nav-consoldetail" onclick="showScreen('consoldetail')" style="display:none;">&#128196; <span data-i18n="nav.consoldetail">Liquidaci&oacute;n Alojamiento</span></div>
  </nav>
  <div class="sidebar-google" id="sidebar-google" style="display:none;">
    <span class="status-dot" id="google-dot"></span>
    <span class="status-text" id="google-status-text"></span>
  </div>
  <div class="sidebar-footer" id="file-indicator" style="display:none;">&#128206; <span id="file-name"></span></div>
  <div id="sync-indicator" style="display:none;padding:8px 24px;align-items:center;gap:8px;font-size:11px;color:rgba(255,255,255,0.6);">
    <div class="sync-dot idle"></div>
    <span class="sync-text" data-i18n="sync.synced">Sincronizado</span>
  </div>
  <div id="sync-toggle-btn" onclick="toggleSync()" style="display:none;padding:4px 24px 8px;cursor:pointer;font-size:11px;color:rgba(255,255,255,0.5);transition:color 0.2s;" onmouseover="this.style.color='rgba(255,255,255,0.8)'" onmouseout="this.style.color='rgba(255,255,255,0.5)'" title="Activar sincronizaci&oacute;n multi-usuario">
    <span class="sync-toggle-dot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#6b7280;margin-right:6px;vertical-align:middle;"></span>
    <span class="sync-toggle-label" style="vertical-align:middle;">Sync OFF</span>
  </div>
  <div class="lang-selector" style="padding:8px 24px 12px;display:flex;gap:4px;align-items:center;">
    <span style="font-size:10px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:0.08em;margin-right:4px;" data-i18n="lang.label">Idioma</span>
    <button class="lang-option active" data-lang="es" onclick="setLanguage('es')" style="background:none;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.6);font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.4)'" onmouseout="if(!this.classList.contains('active'))this.style.borderColor='rgba(255,255,255,0.15)'">ES</button>
    <button class="lang-option" data-lang="en" onclick="setLanguage('en')" style="background:none;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.6);font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.4)'" onmouseout="if(!this.classList.contains('active'))this.style.borderColor='rgba(255,255,255,0.15)'">EN</button>
    <button class="lang-option" data-lang="de" onclick="setLanguage('de')" style="background:none;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.6);font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.4)'" onmouseout="if(!this.classList.contains('active'))this.style.borderColor='rgba(255,255,255,0.15)'">DE</button>
  </div>
  <div class="sidebar-footer" id="version-indicator" style="cursor:pointer;" onclick="showVersionInfo()" title="Info de versi&oacute;n">v<span id="version-label"></span></div>
  <div style="padding:0 24px 12px; font-size:11px;"><a href="#" onclick="event.preventDefault();showChangelog()" style="color:rgba(255,255,255,0.4);text-decoration:none;" onmouseover="this.style.color='rgba(255,255,255,0.7)'" onmouseout="this.style.color='rgba(255,255,255,0.4)'">&#x1F4CB; <span data-i18n="changelog.link">Historial de cambios</span></a></div>
</div>

<!-- Changelog Modal -->
<div class="changelog-overlay" id="changelog-overlay" onclick="if(event.target===this)closeChangelog()">
  <div class="changelog-modal">
    <div class="changelog-header">
      <h3>&#x1F4CB; <span data-i18n="changelog.title">Historial de versiones</span></h3>
      <button onclick="closeChangelog()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#6b7280;padding:4px;">&times;</button>
    </div>
    <div class="changelog-body" id="changelog-body"></div>
  </div>
</div>

<!-- AI Assistant -->
<button class="ai-fab" id="ai-fab" onclick="toggleAIPanel()" data-i18n-title="ai.title" title="Asistente Hist&oacute;rico Reservas">&#x1F916;<span class="fab-badge" id="ai-badge"></span></button>
<div class="ai-panel" id="ai-panel">
  <div class="ai-header">
    <span style="font-size:20px;">&#x1F916;</span>
    <h3 data-i18n="ai.title">Asistente Hist&oacute;rico Reservas</h3>
    <button class="ai-help-btn" onclick="_toggleAIHelp()" data-i18n-title="ai.helpBtn" title="L&eacute;eme / Ayuda">&#x2753;</button>
    <button class="ai-close" onclick="toggleAIPanel()">&times;</button>
  </div>
  <div class="ai-help-overlay" id="ai-help-overlay">
    <div class="ai-help-scroll">
      <div id="ai-guide-body"></div>
    </div>
  </div>
  <div class="ai-messages" id="ai-messages">
    <div class="ai-msg system" data-i18n="ai.subtitle">Preg&uacute;ntame sobre tus reservas, liquidaciones, importes... Respondo solo con tus datos reales.</div>
    <div class="ai-chips" id="ai-chips">
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.briefingQ" data-i18n="ai.chip.briefing">&#x26A1; Briefing</button>
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.kpisQ" data-i18n="ai.chip.kpis">&#x1F4CA; KPIs</button>
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.ownersQ" data-i18n="ai.chip.owners">&#x1F465; Propietarios</button>
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.heatmapQ" data-i18n="ai.chip.heatmap">&#x1F5FA;&#xFE0F; Heatmap</button>
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.duplicatesQ" data-i18n="ai.chip.duplicates">&#x1F50D; Duplicados</button>
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.segmentsQ" data-i18n="ai.chip.segments">&#x1F4CA; Segmentos</button>
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.leadtimeQ" data-i18n="ai.chip.leadtime">&#x23F1;&#xFE0F; Lead time</button>
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.whatifQ" data-i18n="ai.chip.whatif">&#x1F52E; What-if</button>
      <button class="ai-chip" onclick="sendAIChip(this)" data-q-key="ai.chip.exportQ" data-i18n="ai.chip.export">&#x1F4E5; Exportar</button>
    </div>
  </div>
  <div class="ai-input-wrap">
    <textarea id="ai-input" data-i18n="ai.placeholder" placeholder="Escribe tu pregunta..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAIMessage();}"></textarea>
    <button id="ai-send" onclick="sendAIMessage()" data-i18n="ai.send">Enviar</button>
  </div>
</div>

<div class="main">
  <!-- UPLOAD -->
  <div class="screen active" id="screen-upload">
    <div class="upload-wrap"><div class="upload-inner">
      <h2 data-i18n="upload.title">Cargar Reservas</h2>
      <p data-i18n="upload.desc">Sube un fichero Excel o conecta con Google Sheets para cargar las reservas</p>
      <div class="dropzone" id="dropzone"
        ondragover="event.preventDefault(); this.classList.add('dragging');"
        ondragleave="this.classList.remove('dragging');"
        ondrop="event.preventDefault(); this.classList.remove('dragging'); handleFile(event.dataTransfer.files[0]);"
        onclick="document.getElementById('fileInput').click();">
        <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
        <div class="title" data-i18n="upload.drop">Arrastra tu fichero aqu&iacute;</div>
        <div class="sub" data-i18n="upload.dropSub">o haz clic para seleccionar &mdash; formato .xlsx</div>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;" onchange="handleFile(this.files[0]);">

      <!-- GOOGLE SHEETS SECTION -->
      <div class="gsheet-section" id="gsheet-section">
        <h3>&#128202; <span data-i18n="upload.gsheet">Cargar desde Google Sheets</span></h3>
        <p data-i18n="upload.gsheetDesc">Conecta con tu cuenta Google para cargar datos directamente desde una hoja de c&aacute;lculo</p>
        <div id="gsheet-auth-area">
          <div class="gsheet-status disconnected" id="gsheet-status">
            <div class="dot"></div>
            <span id="gsheet-status-label" data-i18n="upload.notConnected">No conectado</span>
          </div>
          <div class="gsheet-actions">
            <button class="btn btn-primary" id="btn-google-connect" onclick="googleSignIn()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#fff"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#fff" opacity=".8"/></svg>
              <span data-i18n="upload.connect">Conectar con Google</span>
            </button>
            <button class="btn btn-outline" id="btn-google-disconnect" onclick="googleSignOut()" style="display:none;" data-i18n="upload.disconnect">Desconectar</button>
          </div>
        </div>
        <div id="gsheet-default-area" style="display:none; margin-top:20px;">
          <div style="background:#f0f5ff;border:1.5px solid #c3d9ff;border-radius:10px;padding:16px 20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#4f8cff;">&#9733; <span data-i18n="upload.defaultSheet">Hoja por defecto</span></span>
              <div style="display:flex;gap:6px;">
                <button class="btn btn-sm btn-primary" id="btn-load-default" onclick="loadDefaultSheet()">&#9654; <span data-i18n="upload.loadNow">Cargar ahora</span></button>
                <button class="btn btn-sm btn-outline" onclick="editDefaultUrl()" title="Cambiar URL">&#9998;</button>
                <button class="btn btn-sm" style="background:#ffebee;color:#e53935;padding:6px 10px;" onclick="clearDefaultUrl()" title="Quitar por defecto">&#10005;</button>
              </div>
            </div>
            <div id="default-url-display" style="font-size:13px;color:#1a2744;font-weight:500;word-break:break-all;"></div>
            <div id="default-url-edit" style="display:none;">
              <div class="gsheet-url-row" style="margin-bottom:0;">
                <input class="gsheet-url-input" type="text" id="default-url-edit-input" placeholder="https://docs.google.com/spreadsheets/d/..." onkeydown="if(event.key==='Enter')saveDefaultUrlEdit();">
                <button class="btn btn-sm btn-success" onclick="saveDefaultUrlEdit()" data-i18n="upload.save">Guardar</button>
                <button class="btn btn-sm btn-outline" onclick="cancelDefaultUrlEdit()" data-i18n="upload.cancel">Cancelar</button>
              </div>
            </div>
          </div>
        </div>
        <div id="gsheet-autoload-status" style="display:none;margin-top:12px;">
          <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;background:#e8f5e9;color:#2e7d32;font-size:13px;font-weight:500;">
            <div class="gsheet-spinner" style="border-top-color:#43a047;border-color:#c8e6c9;width:18px;height:18px;"></div>
            <span id="autoload-status-text" data-i18n="upload.loadingDefault">Cargando hoja por defecto...</span>
          </div>
        </div>
        <div id="gsheet-no-default" style="display:none; margin-top:20px;">
          <div style="background:#f8f9fb;border:1.5px dashed #dde1e8;border-radius:10px;padding:14px 20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div>
                <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#9ca3af;margin-bottom:4px;" data-i18n="upload.defaultSheet">Hoja por defecto</div>
                <div style="font-size:13px;color:#6b7280;" data-i18n="upload.configDesc">Configura una URL para cargar autom&aacute;ticamente al conectar</div>
              </div>
              <button class="btn btn-sm btn-outline" onclick="showSetDefaultUrl()" data-i18n="upload.configure">Configurar</button>
            </div>
            <div id="set-default-url-form" style="display:none;margin-top:12px;">
              <div class="gsheet-url-row" style="margin-bottom:0;">
                <input class="gsheet-url-input" type="text" id="set-default-url-input" placeholder="https://docs.google.com/spreadsheets/d/..." onkeydown="if(event.key==='Enter')saveNewDefaultUrl();">
                <button class="btn btn-sm btn-success" onclick="saveNewDefaultUrl()" data-i18n="upload.save">Guardar</button>
              </div>
            </div>
          </div>
        </div>
        <div id="gsheet-picker-area" style="display:none; margin-top:20px;">
          <div class="gsheet-actions" style="margin-bottom:12px;">
            <button class="btn btn-primary" onclick="openGooglePicker()">&#128193; <span data-i18n="upload.explore">Explorar Google Drive</span></button>
          </div>
          <div style="display:flex;align-items:center;gap:12px;margin:12px 0;">
            <div style="flex:1;height:1px;background:#e0e4ea;"></div>
            <span style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.08em;" data-i18n="upload.pasteUrl">o pega la URL</span>
            <div style="flex:1;height:1px;background:#e0e4ea;"></div>
          </div>
          <div class="gsheet-url-row">
            <input class="gsheet-url-input" type="text" id="gsheet-url-input" placeholder="https://docs.google.com/spreadsheets/d/..." onkeydown="if(event.key==='Enter')loadFromUrl();">
            <button class="btn btn-primary" onclick="loadFromUrl()" data-i18n="upload.load">Cargar</button>
          </div>
        </div>
        <div id="gsheet-loading" style="display:none;" class="gsheet-loading">
          <div class="gsheet-spinner"></div>
          <span id="gsheet-loading-text" data-i18n="upload.loading">Cargando datos...</span>
        </div>
        <div id="gsheet-sheets-selector" style="display:none; margin-top:16px;">
          <label style="font-size:12px;font-weight:600;color:#6b7280;display:block;margin-bottom:8px;" data-i18n="upload.selectSheet">Selecciona la hoja:</label>
          <div id="gsheet-sheets-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
        <div class="gsheet-history" id="gsheet-history" style="display:none;">
          <h4 data-i18n="upload.recentSheets">Hojas recientes</h4>
          <div id="gsheet-history-list"></div>
        </div>
      </div>
    </div></div>
  </div>

  <!-- LIST -->
  <div class="screen" id="screen-list">
    <div class="page-header" style="margin-bottom:28px;">
      <h1 data-i18n="list.title">Por Reserva</h1>
      <p data-i18n="list.desc">Revisa, ajusta y valida cada reserva antes de generar la liquidaci&oacute;n definitiva</p>
    </div>
    <div class="stats-row" id="stats-row"></div>
    <div class="card filters-bar">
      <label data-i18n="filter.filters">Filtros</label>
      <div class="combo" id="combo-platform">
        <input class="combo-input" type="text" data-i18n="filter.allPlatforms" placeholder="Todas las plataformas" onclick="openCombo('platform')" oninput="filterCombo('platform')">
        <div class="combo-clear" onclick="clearCombo('platform')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-platform"></div>
      </div>
      <div class="combo" id="combo-aloj">
        <input class="combo-input" type="text" data-i18n="filter.allProperties" placeholder="Todos los alojamientos" onclick="openCombo('aloj')" oninput="filterCombo('aloj')">
        <div class="combo-clear" onclick="clearCombo('aloj')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-aloj"></div>
      </div>
      <div class="combo" id="combo-status" style="min-width:150px;">
        <input class="combo-input" type="text" data-i18n="filter.allStatuses" placeholder="Todos los estados" readonly onclick="openSimpleCombo('status')" style="cursor:pointer;">
        <div class="combo-clear" onclick="clearSimpleCombo('status')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-status"></div>
      </div>
      <div class="mp-wrap" id="mp-wrap-p">
        <button class="mp-btn" id="mp-btn-p" onclick="toggleMonthPicker('p')"><span class="mp-icon">&#128197;</span> <span id="mp-label-p" data-i18n="filter.allMonths">Todos los meses</span></button>
        <div class="mp-dd" id="mp-dd-p"></div>
      </div>
      <div class="filter-sep"></div>
      <div class="search-wrap">
        <span class="search-icon">&#128269;</span>
        <input type="text" class="search-input" id="search-preliq" data-i18n="filter.search" placeholder="Buscar cliente, importe, fecha..." oninput="onSearchPreliq(this.value)">
        <div class="search-clear" id="search-preliq-clear" onclick="clearSearchPreliq()" style="display:none;">&#10005;</div>
      </div>
      <div class="filter-sep"></div>
      <label data-i18n="filter.sort">Ordenar</label>
      <div class="combo" id="combo-sort" style="min-width:160px;">
        <input class="combo-input" type="text" data-i18n="filter.originalOrder" placeholder="Orden original" readonly onclick="openSimpleCombo('sort')" style="cursor:pointer;">
        <div class="combo-list" id="combo-list-sort"></div>
      </div>
      <div class="combo" id="combo-sortdir" style="min-width:50px;">
        <input class="combo-input" type="text" placeholder="&#8593;" readonly onclick="openSimpleCombo('sortdir')" style="cursor:pointer;text-align:center;padding:6px 8px;">
        <div class="combo-list" id="combo-list-sortdir"></div>
      </div>
      <div class="filter-sep"></div>
      <button class="gear-btn" onclick="openConfigModal()" data-i18n-title="misc.configValues" title="Configurar valores">&#9881;</button>
      <div class="col-toggle-wrap">
        <button class="col-toggle-btn" onclick="toggleColDropdown()" data-i18n-title="misc.showHideCols" title="Mostrar/ocultar columnas">&#9783; <span data-i18n="filter.columns">Columnas</span></button>
        <div class="col-toggle-dd" id="col-toggle-dd"></div>
      </div>
      <div class="filter-sep"></div>
      <button class="btn btn-sm btn-orange" id="btn-validar-todas" onclick="validarTodas()" style="display:none;">&#10004; <span data-i18n="btn.validateAll">Validar todas</span></button>
      <button class="btn btn-sm btn-success" id="btn-desvalidar-todas" onclick="desvalidarTodas()" style="display:none;">&#8617; <span data-i18n="btn.unvalidateAll">Desvalidar todas</span></button>
      <span class="count" id="filter-count"></span>
    </div>
    <div class="card" style="padding:0; overflow:hidden;">
      <div class="table-wrap">
        <table><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody><tfoot id="table-foot"></tfoot></table>
      </div>
      <div id="pagination-bar" class="no-print" style="display:none;padding:12px 20px;align-items:center;justify-content:space-between;gap:16px;border-top:1px solid #eef0f4;flex-wrap:wrap;"></div>
    </div>
  </div>

  <!-- DETAIL (individual) -->
  <div class="screen" id="screen-detail">
    <button class="btn btn-outline no-print" style="margin-bottom:24px;" onclick="showScreen('list')">&#8592; <span data-i18n="btn.backToList">Volver a la lista</span></button>
    <div id="detail-content"></div>
  </div>

  <!-- CONSOLIDATED: grid of alojamientos -->
  <div class="screen" id="screen-consol">
    <div class="page-header" style="margin-bottom:28px;">
      <h1 data-i18n="consol.title">Por Alojamiento</h1>
      <p data-i18n="consol.desc">Consolida las reservas validadas de cada alojamiento para generar la liquidaci&oacute;n mensual</p>
    </div>
    <div class="stats-row" id="consol-stats"></div>
    <div class="card filters-bar" style="padding:12px 24px;">
      <div class="mp-wrap" id="mp-wrap-c">
        <button class="mp-btn" id="mp-btn-c" onclick="toggleMonthPicker('c')"><span class="mp-icon">&#128197;</span> <span id="mp-label-c" data-i18n="filter.allMonths">Todos los meses</span></button>
        <div class="mp-dd" id="mp-dd-c"></div>
      </div>
      <div class="filter-sep"></div>
      <div class="search-wrap">
        <span class="search-icon">&#128269;</span>
        <input type="text" class="search-input" id="search-consol" data-i18n="filter.searchConsol" placeholder="Buscar alojamiento, importe..." oninput="onSearchConsol(this.value)">
        <div class="search-clear" id="search-consol-clear" onclick="clearSearchConsol()" style="display:none;">&#10005;</div>
      </div>
      <div class="filter-sep"></div>
      <div class="val-toggle-wrap" id="val-toggle">
        <button class="val-toggle-btn no-val active" id="vt-btn-noval" onclick="toggleConsolVal('noval')">
          <span class="vt-dot"></span><span data-i18n="consol.notValidated">No Validadas</span><span class="vt-count" id="vt-count-noval">0</span>
        </button>
        <button class="val-toggle-btn si-val" id="vt-btn-val" onclick="toggleConsolVal('val')">
          <span class="vt-dot"></span><span data-i18n="consol.validatedTab">Validadas</span><span class="vt-count" id="vt-count-val">0</span>
        </button>
      </div>
      <div class="filter-sep"></div>
      <label data-i18n="filter.sortBy">Ordenar por</label>
      <div class="combo" id="combo-consolsort" style="min-width:190px;">
        <input class="combo-input" type="text" data-i18n="sort.nameAZ" placeholder="Nombre A&#8593;Z" readonly onclick="openSimpleCombo('consolsort')" style="cursor:pointer;">
        <div class="combo-clear" onclick="clearSimpleCombo('consolsort')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-consolsort"></div>
      </div>
    </div>
    <div class="aloj-grid" id="aloj-grid"></div>
  </div>

  <!-- CONSOLIDATED DETAIL: one alojamiento -->
  <div class="screen" id="screen-consoldetail">
    <button class="btn btn-outline no-print" style="margin-bottom:24px;" onclick="showScreen('consol')">&#8592; <span data-i18n="btn.backToProperties">Volver a alojamientos</span></button>
    <div id="consoldetail-content"></div>
  </div>
</div>

<!-- CONFIG MODAL -->
<div class="modal-overlay" id="config-modal" style="display:none;" onclick="if(event.target===this)closeConfigModal();">
  <div class="modal">
    <div class="modal-header">
      <h3>&#9881; <span data-i18n="config.title">Configurar Valores</span></h3>
      <button class="modal-close" onclick="closeConfigModal()">&#10005;</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab('tab-plat',this)" data-i18n="config.salesChannel">Canal de Venta</button>
      <button class="modal-tab" onclick="switchTab('tab-otros',this)" data-i18n="config.gtcService">Servicio GTC / Limpieza / Amenities / Mant.</button>
      <button class="modal-tab" onclick="switchTab('tab-pasarela',this)" data-i18n="config.gateway">Pasarela</button>
      <button class="modal-tab" onclick="switchTab('tab-impuestos',this)" data-i18n="config.taxes">Impuestos</button>
      <button class="modal-tab" onclick="switchTab('tab-8020',this)" style="color:#7c3aed;" data-i18n="config.agreement8020">Acuerdo 80/20</button>
    </div>
    <div class="modal-body">
      <div class="tab-panel active" id="tab-plat"></div>
      <div class="tab-panel" id="tab-otros"></div>
      <div class="tab-panel" id="tab-pasarela"></div>
      <div class="tab-panel" id="tab-impuestos"></div>
      <div class="tab-panel" id="tab-8020"></div>
    </div>
  </div>
</div>

<script>
/**
 * ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
 *  LIQUIDACIONES ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â GestiÃƒÆ’Ã‚Â³n de Reservas Vacacionales
 *  AplicaciÃƒÆ’Ã‚Â³n SPA (Single Page Application) en archivo ÃƒÆ’Ã‚Âºnico
 *  Deploy: https://albertomendez-web.github.io/liquidaciones/
 * ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
 *
 * ÃƒÂ¢Ã¢â‚¬ÂÃ…â€™ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ‚Â
 * ÃƒÂ¢Ã¢â‚¬ÂÃ¢â‚¬Å¡  ARCHITECTURE GUIDE ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â DocumentaciÃƒÆ’Ã‚Â³n interna para Claude / AI Assistants    ÃƒÂ¢Ã¢â‚¬ÂÃ¢â‚¬Å¡
 * ÃƒÂ¢Ã¢â‚¬ÂÃ¢â‚¬Å¡  Lee este bloque ANTES de hacer cualquier cambio en el proyecto            ÃƒÂ¢Ã¢â‚¬ÂÃ¢â‚¬Å¡
 * ÃƒÂ¢Ã¢â‚¬ÂÃ¢â‚¬ÂÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ‹Å“
 *
 * ============================================================================
 * 1. PROPÃƒÆ’Ã¢â‚¬Å“SITO DE LA APLICACIÃƒÆ’Ã¢â‚¬Å“N
 * ============================================================================
 * Sistema de liquidaciÃƒÆ’Ã‚Â³n financiera para empresa de gestiÃƒÆ’Ã‚Â³n de propiedades
 * vacacionales (GTC). Procesa reservas desde Google Sheets o Excel y genera
 * liquidaciones detalladas para propietarios, calculando:
 *   - Comisiones por plataforma (Airbnb, Booking, etc.) y gestiÃƒÆ’Ã‚Â³n GTC
 *   - Limpieza, amenities, pasarela de pago
 *   - Conceptos extraordinarios con IVA (CE) y sin IVA (CE2)
 *   - RetenciÃƒÆ’Ã‚Â³n IRPF e IVA 21% sobre subtotal
 *   - Reparto especial 80/20 GTC para propiedades con mÃƒÆ’Ã‚Â­nimo garantizado
 *   - Mantenimiento y deducciones mensuales por alojamiento
 *
 * ============================================================================
 * 2. PANTALLAS / VISTAS (controladas por showScreen())
 * ============================================================================
 *   upload        ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ Cargar fichero Excel o conectar Google Sheets
 *   list          ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ PreliquidaciÃƒÆ’Ã‚Â³n: tabla con todas las reservas + filtros
 *   detail        ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ Detalle de una reserva individual (preliquidaciÃƒÆ’Ã‚Â³n)
 *   consol        ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ Grid de tarjetas por alojamiento (vista consolidada)
 *   consoldetail  ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ LiquidaciÃƒÆ’Ã‚Â³n completa de un alojamiento (tabla + resumen)
 *
 * ============================================================================
 * 3. MODELO DE DATOS (variables globales principales)
 * ============================================================================
 *
 *   allReservas[]  ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Array de objetos reserva. Cada reserva tiene:
 *     .idx           ÃƒÆ’Ã‚Ândice en el array (clave primaria interna)
 *     .id            ID Reserva (string del Sheet)
 *     .localizador   CÃƒÆ’Ã‚Â³digo localizador
 *     .cliente       Nombre del cliente
 *     .alojamiento   CÃƒÆ’Ã‚Â³digo del alojamiento (ej: "MA-2-P2-1A")
 *     .edificio      Nombre del edificio
 *     .plataforma    Canal de venta ("Booking.com", "Airbnb.com", etc.)
 *     .totalReserva  Importe total con IVA (nÃƒÆ’Ã‚Âºmero)
 *     .fechaEntrada/.fechaSalida  Fechas originales del Sheet
 *     ._dEntrada/_dSalida         Objetos Date parseados
 *     ._fmtEntrada/_fmtSalida     Strings formateados "dd/mm/yyyy"
 *     ._nights       NÃƒÆ’Ã‚Âºmero de noches calculado
 *     ._sheetRow     Fila 1-indexed en el Sheet (para write-back)
 *     ._clienteLc/_alojLc/_platLc  Versiones lowercase para bÃƒÆ’Ã‚Âºsqueda
 *     ._isBooking    Boolean: Ãƒâ€šÃ‚Â¿es Booking.com?
 *
 *   settings{}     ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Objeto indexado por reserva.idx. Cada entrada tiene:
 *     .comPlataforma   ComisiÃƒÆ’Ã‚Â³n plataforma (decimal, ej: 0.155 = 15.5%)
 *     .comGTC          ComisiÃƒÆ’Ã‚Â³n GTC (decimal)
 *     .limpieza        Importe fijo limpieza (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬)
 *     .amenities       Importe fijo amenities (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬)
 *     .irpf            RetenciÃƒÆ’Ã‚Â³n IRPF (decimal)
 *     .pasarela        Boolean: Ãƒâ€šÃ‚Â¿aplicar pasarela?
 *     .pasarelaRate    Tasa pasarela (decimal)
 *     .conceptosEspeciales[]  CE con IVA: [{name, amount}]
 *     .conceptosSinIVA[]      CE sin IVA: [{name, amount}]
 *
 *   validated      ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Set<idx>: ÃƒÆ’Ã‚Â­ndices de reservas validadas
 *
 * ============================================================================
 * 4. FLUJO DE CÃƒÆ’Ã‚ÂLCULO (calcLiquidacion)
 * ============================================================================
 *   totalOriginal = r.totalReserva
 *   ceTotal       = ÃƒÅ½Ã‚Â£ conceptosEspeciales[].amount
 *   total         = totalOriginal - ceTotal
 *   baseSinIVA    = total / (1 + 0.10)              // IVA turÃƒÆ’Ã‚Â­stico 10%
 *   comPlat       = total ÃƒÆ’Ã¢â‚¬â€ comRate                  // comisiÃƒÆ’Ã‚Â³n plataforma
 *   comGTC        = baseSinIVA ÃƒÆ’Ã¢â‚¬â€ gtcRate             // comisiÃƒÆ’Ã‚Â³n gestiÃƒÆ’Ã‚Â³n
 *   comPas        = total ÃƒÆ’Ã¢â‚¬â€ pasarelaRate (si activa) // pasarela de pago
 *   ceSinIvaTotal = ÃƒÅ½Ã‚Â£ conceptosSinIVA[].amount
 *   sub = baseSinIVA - comPlat - comGTC - comPas - limp - amen - ceSinIvaTotal
 *   iva = sub ÃƒÆ’Ã¢â‚¬â€ 0.21        // IVA sobre subtotal
 *   ret = sub ÃƒÆ’Ã¢â‚¬â€ irpfRate    // RetenciÃƒÆ’Ã‚Â³n IRPF
 *   totalLiq = sub + iva - ret
 *
 *   Para propiedades 80/20 GTC (isGtcSplit):
 *     subtotalReservas se divide: 80% propietario, 20% GTC
 *     Los impuestos se calculan sobre el 80%
 *
 * ============================================================================
 * 5. FLUJO DE DATOS GOOGLE SHEETS
 * ============================================================================
 *   1. OAuth ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ onTokenResponse() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ updateGoogleStatus(true)
 *   2. loadSheetById() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ loadSheetData() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ processRows()
 *   3. setupSheetSource() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ configura write-back validaciones
 *   4. loadOrCreateConfigTab() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ carga pestaÃƒÆ’Ã‚Â±a "Configuracion"
 *   5. loadPropietariosTab() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ mapeo alojamientoÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢propietario
 *   6. Cambios ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ schedule*Save() con debounce ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ API write
 *
 * ============================================================================
 * 6. SISTEMA DE CACHÃƒÆ’Ã¢â‚¬Â° / PERFORMANCE
 * ============================================================================
 *   _liqCache{}          ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â CÃƒÆ’Ã‚Â¡lculos por reserva (invalidateCache)
 *   _cachedFiltered      ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Resultado filtrado+ordenado (invalidateFilterCache)
 *   _cachedFilteredStats ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â EstadÃƒÆ’Ã‚Â­sticas filtradas
 *   _globalStatsCache    ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â EstadÃƒÆ’Ã‚Â­sticas globales (invalidateGlobalStats)
 *   _selectCache{}       ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â HTML de <select> preconstruidos
 *   _alojCache           ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â AgrupaciÃƒÆ’Ã‚Â³n por alojamiento
 *   _fmtCache{}          ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Formateo numÃƒÆ’Ã‚Â©rico
 *
 *   PatrÃƒÆ’Ã‚Â³n delta: changeSetting() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ actualiza cache incremental
 *   _patchSingleRow() actualiza solo la fila DOM afectada
 *   _patchConsolLightweight() parchea celdas sin reconstruir DOM
 *
 * ============================================================================
 * 7. ÃƒÆ’Ã‚ÂNDICE DE MÃƒÆ’Ã¢â‚¬Å“DULOS (buscar por [M01], [M02], etc.)
 * ============================================================================
 *   [M01] VERSIONING      ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â APP_VERSION, CHANGELOG, toast actualizaciÃƒÆ’Ã‚Â³n
 *   [M02] UTILITIES       ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â esc(), SafeStorage, debounce(), safeGet()
 *   [M03] CONFIG          ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â CONFIG object, constantes de la aplicaciÃƒÆ’Ã‚Â³n
 *   [M04] TOAST           ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â showToast() - notificaciones no bloqueantes
 *   [M05] GOOGLE_AUTH     ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â OAuth, tokens, estado de conexiÃƒÆ’Ã‚Â³n
 *   [M06] GOOGLE_SHEETS   ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Carga datos, write-back, config persistence
 *   [M07] PROPIETARIOS    ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Mapeo alojamientoÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢propietario, ediciÃƒÆ’Ã‚Â³n inline
 *   [M08] DATA_MODEL      ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â allReservas, settings, opciones globales
 *   [M09] CALCULATIONS    ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â calcLiquidacion, parseNum, fmt()
 *   [M10] SEARCH_FILTER   ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â BÃƒÆ’Ã‚Âºsqueda, filtrado, combos, month picker
 *   [M11] TABLE_RENDER    ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â renderTable, columnas, paginaciÃƒÆ’Ã‚Â³n, footer
 *   [M12] CE_SYSTEM       ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Conceptos extraordinarios (CE + CE2)
 *   [M13] DETAIL_VIEW     ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Vista detalle individual
 *   [M14] CONSOL_VIEW     ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Vista consolidada por alojamiento
 *   [M15] CONSOL_DEDUCT   ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Mantenimiento y extras mensuales
 *   [M16] PRINT           ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â GeneraciÃƒÆ’Ã‚Â³n impresiÃƒÆ’Ã‚Â³n y preview
 *   [M17] SETTINGS_UI     ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Modal configuraciÃƒÆ’Ã‚Â³n, opciones editables
 *   [M18] AI_ASSISTANT    ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Chat IA integrado
 *
 * ============================================================================
 * 8. CONVENCIONES DE CÃƒÆ’Ã¢â‚¬Å“DIGO
 * ============================================================================
 *   - Prefijo _ en funciones: internas (no llamar desde onclick HTML)
 *   - Prefijo _ en variables: estado interno/global
 *   - esc() OBLIGATORIO en todo innerHTML con datos del usuario (XSS)
 *   - schedule*Save() para persistencia con debounce
 *   - invalidateCache() tras cualquier cambio en datos/settings
 *   - Vista 'p' = preliquidaciÃƒÆ’Ã‚Â³n, 'c' = consolidada (en IDs de CE)
 *   - SemVer obligatorio en cada entrega (ver VERSIONING RULES)
 *
 * ============================================================================
 * 9. ESTRUCTURA HTML (fuera del <script>)
 * ============================================================================
 *   <div class="sidebar">         ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â NavegaciÃƒÆ’Ã‚Â³n lateral fija
 *   <div class="main">            ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Contenido principal con pantallas
 *     #screen-upload              ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Carga de datos
 *     #screen-list                ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â PreliquidaciÃƒÆ’Ã‚Â³n (tabla + filtros)
 *     #screen-detail              ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Detalle individual
 *     #screen-consol              ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Grid alojamientos
 *     #screen-consoldetail        ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â LiquidaciÃƒÆ’Ã‚Â³n consolidada
 *   <div id="config-modal">       ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Modal de configuraciÃƒÆ’Ã‚Â³n
 *   <div class="ai-panel">        ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Panel lateral IA
 *   <div class="changelog-overlay"> ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Modal historial de cambios
 */

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M01] VERSIONING ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Control de versiones, CHANGELOG y notificaciones
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
// ===
// CONTROL DE VERSIONES
// ===
// ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ [M10-SEARCH] Funciones de bÃƒÆ’Ã‚Âºsqueda global (se necesitan antes del render) ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬

/** @description Filtra la tabla de preliquidaciÃƒÆ’Ã‚Â³n por texto libre en tiempo real */
function onSearchPreliq(val) {
  _searchText = val.trim().toLowerCase();
  document.getElementById('search-preliq-clear').style.display = _searchText ? 'block' : 'none';
  invalidateFilterCache();
  _currentPage = 1;
  renderTable();
}
/** @description Limpia el filtro de bÃƒÆ’Ã‚Âºsqueda de preliquidaciÃƒÆ’Ã‚Â³n */
function clearSearchPreliq() {
  document.getElementById('search-preliq').value = '';
  onSearchPreliq('');
}
/** @description Filtra el grid de alojamientos por texto libre */
function onSearchConsol(val) {
  _searchTextConsol = val.trim().toLowerCase();
  document.getElementById('search-consol-clear').style.display = _searchTextConsol ? 'block' : 'none';
  renderConsolGrid();
}
/** @description Limpia el filtro de bÃƒÆ’Ã‚Âºsqueda del grid consolidado */
function clearSearchConsol() {
  document.getElementById('search-consol').value = '';
  onSearchConsol('');
}
function toggleConsolVal(mode) {
  _consolValToggle = (_consolValToggle === mode) ? null : mode;
  renderConsolGrid();
}

/**
 * ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚Â
 *  VERSIONING RULES ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â OBLIGATORIO en CADA entrega de cÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³digo
 * ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚Â
 *  MAJOR (X.0.0) ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ Cambios incompatibles, reestructuraciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n total,
 *                   migraciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n de datos necesaria
 *  MINOR (x.Y.0) ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ Nueva funcionalidad, nueva secciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n UI,
 *                   nuevo campo/columna, nueva integraciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n
 *  PATCH (x.y.Z) ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ Bugfix, ajuste visual, optimizaciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n,
 *                   refactor sin cambio funcional
 * ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚Â
 *  CHECKLIST por entrega:
 *  ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ 1. Leer versiÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n actual de APP_VERSION
 *  ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ 2. Decidir bump: MAJOR / MINOR / PATCH
 *  ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ 3. Actualizar APP_VERSION con nueva versiÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n
 *  ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ 4. Actualizar APP_BUILD con fecha/hora actual Madrid (+01/+02)
 *  ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ 5. Actualizar APP_CHANGES con resumen breve (< 100 chars)
 *  ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ 6. AÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â±adir entrada al array CHANGELOG (al principio)
 *       con version, date (ISO Madrid), y array changes detallado
 *  ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ 7. NUNCA reutilizar un nÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Âºmero de versiÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n ya existente
 * ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚ÂÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢Ãƒâ€šÃ‚Â
 */
const APP_VERSION = '2.24.1';
const APP_BUILD   = '2026-02-16T15:00:00+01:00';
const APP_CHANGES = 'Fix: cambio de idioma en consoldetail no re-renderizaba (variable incorrecta), feedback visual';

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M02] UTILITIES ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Funciones auxiliares reutilizables
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === UTILITY: XSS Escaping ===
/**
 * @description Escapa HTML para prevenir XSS. OBLIGATORIO en todo innerHTML
 * que incluya datos del usuario o del Sheet.
 * @param {*} str - String a escapar (null-safe)
 * @returns {string} String con &, <, >, ", ' escapados
 */
function esc(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// === UTILITY: Safe JSON parse ===

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M04] TOAST ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Sistema de notificaciones no bloqueantes
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === TOAST NOTIFICATION SYSTEM ===
function showToast(message, type, duration) {
  type = type || 'info';
  duration = duration || 3500;
  var container = document.getElementById('toast-container');
  if (!container) return;
  var icons = { success: '&#10003;', error: '&#10007;', warning: '&#9888;', info: '&#8505;' };
  var toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  toast.innerHTML = '<span class="toast-icon">' + (icons[type] || '') + '</span>'
    + '<span>' + message + '</span>'
    + '<span class="toast-close" onclick="this.parentElement.remove()">&#10005;</span>';
  container.appendChild(toast);
  setTimeout(function() {
    toast.classList.add('leaving');
    setTimeout(function() { if (toast.parentNode) toast.remove(); }, 250);
  }, duration);
}


// === ERROR BOUNDARY ===
function safeCall(fn, fallback, context) {
  try { return fn(); }
  catch(e) { console.error('[SafeCall]', context || '', e); return fallback; }
}
function safeJSON(str, fallback) {
  if (fallback === undefined) fallback = null;
  if (!str || typeof str !== 'string') return fallback;
  try { return JSON.parse(str); }
  catch(e) { console.warn('[SafeJSON] Failed to parse:', str.substring(0, 100), e.message); return fallback; }
}

// === UTILITY: Safe localStorage ===
/**
 * @description Wrapper seguro para localStorage. Maneja errores silenciosamente
 * (private browsing, storage lleno, etc.). Provee get/set/remove/getJSON.
 * @namespace
 */
const SafeStorage = {
  get(key, fallback) {
    try { const v = localStorage.getItem(key); return v !== null ? v : (fallback !== undefined ? fallback : null); }
    catch(e) { console.warn('[Storage] Read error for', key, e.message); return fallback !== undefined ? fallback : null; }
  },
  set(key, value) {
    try { localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value)); return true; }
    catch(e) { console.warn('[Storage] Write error for', key, e.message); return false; }
  },
  remove(key) {
    try { localStorage.removeItem(key); return true; }
    catch(e) { console.warn('[Storage] Remove error for', key, e.message); return false; }
  },
  getJSON(key, fallback) {
    const raw = this.get(key, null);
    return raw ? safeJSON(raw, fallback !== undefined ? fallback : null) : (fallback !== undefined ? fallback : null);
  }
};

// ═══════════════════════════════════════════════════════════════
//  [i18n] INTERNATIONALIZATION SYSTEM — ES / EN / DE
// ═══════════════════════════════════════════════════════════════
let _currentLang = SafeStorage.get('liq-lang') || 'es';

const I18N = {
  // ——— Navigation ———
  'nav.upload':        { es:'Cargar Fichero', en:'Load File', de:'Datei laden' },
  'nav.list':          { es:'Por Reserva', en:'By Reservation', de:'Nach Buchung' },
  'nav.detail':        { es:'Liquidaci\u00f3n Reserva', en:'Reservation Settlement', de:'Buchungsabrechnung' },
  'nav.consol':        { es:'Por Alojamiento', en:'By Property', de:'Nach Unterkunft' },
  'nav.consoldetail':  { es:'Liquidaci\u00f3n Alojamiento', en:'Property Settlement', de:'Unterkunftsabrechnung' },

  // ——— Logo / Title ———
  'app.title':         { es:'Liquidaciones', en:'Settlements', de:'Abrechnungen' },
  'app.subtitle':      { es:'Gesti\u00f3n de Reservas', en:'Reservation Management', de:'Buchungsverwaltung' },
  'app.doctitle':      { es:'Liquidaciones \u2014 Gesti\u00f3n de Reservas', en:'Settlements \u2014 Reservation Management', de:'Abrechnungen \u2014 Buchungsverwaltung' },

  // ——— Upload Screen ———
  'upload.title':      { es:'Cargar Reservas', en:'Load Reservations', de:'Buchungen laden' },
  'upload.desc':       { es:'Sube un fichero Excel o conecta con Google Sheets para cargar las reservas', en:'Upload an Excel file or connect to Google Sheets to load reservations', de:'Laden Sie eine Excel-Datei hoch oder verbinden Sie sich mit Google Sheets' },
  'upload.drop':       { es:'Arrastra tu fichero aqu\u00ed', en:'Drag your file here', de:'Datei hierher ziehen' },
  'upload.dropSub':    { es:'o haz clic para seleccionar \u2014 formato .xlsx', en:'or click to select \u2014 .xlsx format', de:'oder klicken zum Ausw\u00e4hlen \u2014 .xlsx Format' },
  'upload.gsheet':     { es:'Cargar desde Google Sheets', en:'Load from Google Sheets', de:'Aus Google Sheets laden' },
  'upload.gsheetDesc': { es:'Conecta con tu cuenta Google para cargar datos directamente desde una hoja de c\u00e1lculo', en:'Connect your Google account to load data directly from a spreadsheet', de:'Verbinden Sie Ihr Google-Konto, um Daten direkt aus einer Tabelle zu laden' },
  'upload.notConnected': { es:'No conectado', en:'Not connected', de:'Nicht verbunden' },
  'upload.connect':    { es:'Conectar con Google', en:'Connect with Google', de:'Mit Google verbinden' },
  'upload.disconnect': { es:'Desconectar', en:'Disconnect', de:'Trennen' },
  'upload.defaultSheet': { es:'Hoja por defecto', en:'Default sheet', de:'Standardtabelle' },
  'upload.loadNow':    { es:'Cargar ahora', en:'Load now', de:'Jetzt laden' },
  'upload.save':       { es:'Guardar', en:'Save', de:'Speichern' },
  'upload.cancel':     { es:'Cancelar', en:'Cancel', de:'Abbrechen' },
  'upload.configure':  { es:'Configurar', en:'Configure', de:'Konfigurieren' },
  'upload.configDesc': { es:'Configura una URL para cargar autom\u00e1ticamente al conectar', en:'Set a URL to load automatically on connect', de:'URL f\u00fcr automatisches Laden beim Verbinden festlegen' },
  'upload.explore':    { es:'Explorar Google Drive', en:'Browse Google Drive', de:'Google Drive durchsuchen' },
  'upload.pasteUrl':   { es:'o pega la URL', en:'or paste the URL', de:'oder URL einf\u00fcgen' },
  'upload.load':       { es:'Cargar', en:'Load', de:'Laden' },
  'upload.loading':    { es:'Cargando datos...', en:'Loading data...', de:'Daten werden geladen...' },
  'upload.selectSheet': { es:'Selecciona la hoja:', en:'Select the sheet:', de:'Tabelle ausw\u00e4hlen:' },
  'upload.recentSheets': { es:'Hojas recientes', en:'Recent sheets', de:'Letzte Tabellen' },
  'upload.loadingDefault': { es:'Cargando hoja por defecto...', en:'Loading default sheet...', de:'Standardtabelle wird geladen...' },
  'upload.connectedGoogle': { es:'Conectado con Google', en:'Connected with Google', de:'Mit Google verbunden' },
  'upload.googleConnected': { es:'Google conectado', en:'Google connected', de:'Google verbunden' },

  // ——— List Screen ———
  'list.title':        { es:'Por Reserva', en:'By Reservation', de:'Nach Buchung' },
  'list.desc':         { es:'Revisa, ajusta y valida cada reserva antes de generar la liquidaci\u00f3n definitiva', en:'Review, adjust and validate each reservation before generating the final settlement', de:'\u00dcberpr\u00fcfen, anpassen und validieren Sie jede Buchung vor der endg\u00fcltigen Abrechnung' },

  // ——— Consolidated Screen ———
  'consol.title':      { es:'Por Alojamiento', en:'By Property', de:'Nach Unterkunft' },
  'consol.desc':       { es:'Consolida las reservas validadas de cada alojamiento para generar la liquidaci\u00f3n mensual', en:'Consolidate validated reservations per property to generate the monthly settlement', de:'Konsolidieren Sie validierte Buchungen pro Unterkunft f\u00fcr die monatliche Abrechnung' },

  // ——— Filters / Labels ———
  'filter.filters':    { es:'Filtros', en:'Filters', de:'Filter' },
  'filter.allPlatforms': { es:'Todas las plataformas', en:'All platforms', de:'Alle Plattformen' },
  'filter.allProperties': { es:'Todos los alojamientos', en:'All properties', de:'Alle Unterk\u00fcnfte' },
  'filter.allStatuses': { es:'Todos los estados', en:'All statuses', de:'Alle Status' },
  'filter.search':     { es:'Buscar cliente, importe, fecha...', en:'Search client, amount, date...', de:'Suche Kunde, Betrag, Datum...' },
  'filter.searchConsol': { es:'Buscar alojamiento, importe...', en:'Search property, amount...', de:'Suche Unterkunft, Betrag...' },
  'filter.sort':       { es:'Ordenar', en:'Sort', de:'Sortieren' },
  'filter.sortBy':     { es:'Ordenar por', en:'Sort by', de:'Sortieren nach' },
  'filter.originalOrder': { es:'Orden original', en:'Original order', de:'Urspr\u00fcngliche Reihenfolge' },
  'filter.columns':    { es:'Columnas', en:'Columns', de:'Spalten' },

  // ——— Column Labels ———
  'col.estado':        { es:'Estado', en:'Status', de:'Status' },
  'col.idReserva':     { es:'ID<br>Reserva', en:'Reservation<br>ID', de:'Buchungs-<br>ID' },
  'col.localizador':   { es:'Localizador', en:'Locator', de:'Buchungscode' },
  'col.fechaAlta':     { es:'Fecha<br>Alta', en:'Creation<br>Date', de:'Erstellungs-<br>datum' },
  'col.cliente':       { es:'Cliente', en:'Client', de:'Kunde' },
  'col.alojamiento':   { es:'Alojamiento', en:'Property', de:'Unterkunft' },
  'col.edificio':      { es:'Edificio', en:'Building', de:'Geb\u00e4ude' },
  'col.plataforma':    { es:'Plataforma', en:'Platform', de:'Plattform' },
  'col.atendidoPor':   { es:'Atendido<br>por', en:'Attended<br>by', de:'Betreut<br>von' },
  'col.origenMarketing': { es:'Origen<br>Mkt.', en:'Marketing<br>Source', de:'Marketing-<br>Quelle' },
  'col.tipoReserva':   { es:'Tipo<br>Reserva', en:'Reservation<br>Type', de:'Buchungs-<br>typ' },
  'col.fechaEntrada':  { es:'Fecha<br>Entrada', en:'Check-in<br>Date', de:'Anreise-<br>datum' },
  'col.fechaSalida':   { es:'Fecha<br>Salida', en:'Check-out<br>Date', de:'Abreise-<br>datum' },
  'col.noches':        { es:'Noches', en:'Nights', de:'N\u00e4chte' },
  'col.totalReserva':  { es:'Total Reserva<br>(IVA inc.)', en:'Total Reservation<br>(VAT incl.)', de:'Gesamt Buchung<br>(MwSt. inkl.)' },
  'col.ce':            { es:'C.E.<br>(IVA inc.)', en:'S.C.<br>(VAT incl.)', de:'S.K.<br>(MwSt. inkl.)' },
  'col.baseSinIVA':    { es:'Base<br>sin IVA', en:'Base<br>excl. VAT', de:'Netto-<br>betrag' },
  'col.comPlataforma': { es:'Canal de<br>Venta', en:'Sales<br>Channel', de:'Vertriebs-<br>kanal' },
  'col.comGTC':        { es:'Gesti\u00f3n<br>GTC', en:'GTC<br>Mgmt.', de:'GTC<br>Verwaltung' },
  'col.limpieza':      { es:'Limpieza', en:'Cleaning', de:'Reinigung' },
  'col.amenities':     { es:'Amenities', en:'Amenities', de:'Ausstattung' },
  'col.pasarela':      { es:'Pasarela', en:'Payment<br>Gateway', de:'Zahlungs-<br>gateway' },
  'col.ceSinIva':      { es:'C.E.<br>(Sin IVA)', en:'S.C.<br>(excl. VAT)', de:'S.K.<br>(ohne MwSt.)' },
  'col.subtotal':      { es:'Subtotal', en:'Subtotal', de:'Zwischensumme' },
  'col.irpf':          { es:'IRPF', en:'Tax Withh.', de:'Steuer-<br>einbehalt' },
  'col.iva21':         { es:'IVA 21%', en:'VAT 21%', de:'MwSt. 21%' },
  'col.totalLiquidar': { es:'A<br>Liquidar', en:'To<br>Settle', de:'Zur<br>Abrechnung' },
  'col.observacion':   { es:'Observaci\u00f3n', en:'Notes', de:'Bemerkungen' },

  // ——— Status Badges ———
  'status.validated':  { es:'Validada', en:'Validated', de:'Validiert' },
  'status.pending':    { es:'Pendiente', en:'Pending', de:'Ausstehend' },
  'status.ready':      { es:'Lista', en:'Ready', de:'Bereit' },

  // ——— Stats Cards ———
  'stats.reservations': { es:'Reservas', en:'Reservations', de:'Buchungen' },
  'stats.totalReservations': { es:'Total Reservas', en:'Total Reservations', de:'Gesamt Buchungen' },
  'stats.totalToSettle': { es:'Total a Liquidar', en:'Total to Settle', de:'Gesamt zur Abrechnung' },
  'stats.validated':   { es:'Validadas', en:'Validated', de:'Validiert' },
  'stats.properties':  { es:'Alojamientos', en:'Properties', de:'Unterk\u00fcnfte' },
  'stats.totalBilling': { es:'Total Facturaci\u00f3n', en:'Total Billing', de:'Gesamt Umsatz' },
  'stats.readyToSettle': { es:'Listos para liquidar', en:'Ready to settle', de:'Abrechnungsbereit' },
  'stats.nights':      { es:'Noches', en:'Nights', de:'N\u00e4chte' },
  'stats.billing':     { es:'Facturaci\u00f3n', en:'Billing', de:'Umsatz' },

  // ——— Buttons / Actions ———
  'btn.validate':      { es:'Validar', en:'Validate', de:'Validieren' },
  'btn.unvalidate':    { es:'Desvalidar', en:'Unvalidate', de:'Zur\u00fccksetzen' },
  'btn.print':         { es:'Imprimir', en:'Print', de:'Drucken' },
  'btn.back':          { es:'Volver', en:'Back', de:'Zur\u00fcck' },
  'btn.backToList':    { es:'Volver a la lista', en:'Back to list', de:'Zur\u00fcck zur Liste' },
  'btn.backToProperties': { es:'Volver a alojamientos', en:'Back to properties', de:'Zur\u00fcck zu Unterk\u00fcnften' },
  'btn.generate':      { es:'Generar Liquidaci\u00f3n', en:'Generate Settlement', de:'Abrechnung erstellen' },
  'btn.downloadPdf':   { es:'Descargar PDF', en:'Download PDF', de:'PDF herunterladen' },
  'btn.sendEmail':     { es:'Enviar por Email', en:'Send by Email', de:'Per E-Mail senden' },

  // ——— Liquidation Detail Labels ———
  'liq.reservation':   { es:'Liquidaci\u00f3n Reserva', en:'Reservation Settlement', de:'Buchungsabrechnung' },
  'liq.monthlyConsol': { es:'Liquidaci\u00f3n Mensual Consolidada', en:'Monthly Consolidated Settlement', de:'Monatliche konsolidierte Abrechnung' },
  'liq.totalVAT':      { es:'Total Reserva (IVA incluido)', en:'Total Reservation (VAT included)', de:'Gesamt Buchung (MwSt. inkl.)' },
  'liq.vatReservation': { es:'IVA Reserva', en:'Reservation VAT', de:'Buchungs-MwSt.' },
  'liq.baseNoVAT':     { es:'Base sin IVA', en:'Base excl. VAT', de:'Nettobetrag' },
  'liq.salesOps':      { es:'Venta, gesti\u00f3n y operaciones', en:'Sales, management and operations', de:'Vertrieb, Verwaltung und Betrieb' },
  'liq.amenities':     { es:'Amenities', en:'Amenities', de:'Ausstattung' },
  'liq.gateway':       { es:'Pasarela', en:'Payment Gateway', de:'Zahlungsgateway' },
  'liq.gatewayPayment': { es:'Pasarela de pago', en:'Payment gateway', de:'Zahlungsgateway' },
  'liq.vatSubtotal':   { es:'IVA del Subtotal', en:'VAT on Subtotal', de:'MwSt. auf Zwischensumme' },
  'liq.totalToSettle': { es:'Total a liquidar', en:'Total to settle', de:'Gesamt zur Abrechnung' },
  'liq.monthlySettlement': { es:'Liquidaci\u00f3n mensual', en:'Monthly settlement', de:'Monatliche Abrechnung' },
  'liq.specialConcepts': { es:'Conceptos especiales (sin IVA)', en:'Special Concepts (excl. VAT)', de:'Sonderposten (ohne MwSt.)' },
  'liq.noName':        { es:'Sin nombre', en:'No name', de:'Ohne Namen' },

  // ——— Consolidated Labels ———
  'consol.summary':    { es:'Resumen consolidado', en:'Consolidated Summary', de:'Konsolidierte Zusammenfassung' },
  'consol.quickSummary': { es:'Resumen R\u00e1pido', en:'Quick Summary', de:'Kurz\u00fcbersicht' },
  'consol.totalReservasVAT': { es:'Total Reservas (IVA incluido)', en:'Total Reservations (VAT included)', de:'Gesamt Buchungen (MwSt. inkl.)' },
  'consol.vatReservas': { es:'IVA Reservas', en:'Reservations VAT', de:'Buchungs-MwSt.' },
  'consol.subtotalReservas': { es:'Subtotal Reservas', en:'Reservations Subtotal', de:'Buchungs-Zwischensumme' },
  'consol.otherConcepts': { es:'Otros Conceptos', en:'Other Concepts', de:'Sonstige Posten' },
  'consol.subtotalFinal': { es:'Subtotal Final Mes', en:'Monthly Final Subtotal', de:'Monatliche Endsumme' },
  'consol.totalToSettle': { es:'Total a Liquidar', en:'Total to Settle', de:'Gesamt zur Abrechnung' },
  'consol.owner':      { es:'Propietario', en:'Owner', de:'Eigent\u00fcmer' },
  'consol.building':   { es:'Edificio', en:'Building', de:'Geb\u00e4ude' },
  'consol.numReservations': { es:'N\u00BA Reservas', en:'No. Reservations', de:'Anz. Buchungen' },
  'consol.reservasTotal': { es:'Reservas Totales', en:'Total Reservations', de:'Gesamtbuchungen' },
  'consol.reservation': { es:'reserva', en:'reservation', de:'Buchung' },
  'consol.validated_pl': { es:'validadas', en:'validated', de:'validiert' },
  'consol.missingOwner': { es:'Falta propietario', en:'Missing owner', de:'Eigent\u00fcmer fehlt' },
  'consol.salesOps':   { es:'Venta, gesti\u00f3n y operaciones', en:'Sales, management & operations', de:'Vertrieb, Verwaltung & Betrieb' },
  'consol.subtotalReservas2': { es:'Subtotal reservas', en:'Reservations subtotal', de:'Buchungs-Zwischensumme' },
  'consol.otherConceptsShort': { es:'Otros conceptos', en:'Other concepts', de:'Sonstige Posten' },
  'consol.subtotalFinalMonth': { es:'Subtotal final mes', en:'Monthly final subtotal', de:'Monatliche Endsumme' },
  'consol.specialAgreement': { es:'Acuerdo especial', en:'Special agreement', de:'Sondervereinbarung' },
  'consol.originalTotal': { es:'Total reservas original', en:'Original total reservations', de:'Urspr\u00fcngliche Gesamtbuchungen' },
  'consol.specialConceptsDisc': { es:'Conceptos especiales descontados', en:'Special concepts discounted', de:'Sonderposten abgezogen' },
  'consol.ceNoVatDisc': { es:'C.E. sin IVA descontados', en:'S.C. excl. VAT discounted', de:'S.K. ohne MwSt. abgezogen' },
  'consol.splitTitle':  { es:'Acuerdo GTC / Propietario \u2014 Condici\u00f3n Especial', en:'GTC / Owner Agreement \u2014 Special Condition', de:'GTC / Eigent\u00fcmer Vereinbarung \u2014 Sonderbedingung' },
  'consol.gtcRetains':  { es:'GTC retiene', en:'GTC retains', de:'GTC beh\u00e4lt' },
  'consol.ownerReceives': { es:'Propietario recibe', en:'Owner receives', de:'Eigent\u00fcmer erh\u00e4lt' },
  'consol.toSettleOwner': { es:'Total a Liquidar \u2014 Propietario', en:'Total to Settle \u2014 Owner', de:'Gesamt zur Abrechnung \u2014 Eigent\u00fcmer' },

  // ——— Config Modal ———
  'config.title':      { es:'Configurar Valores', en:'Configure Values', de:'Werte konfigurieren' },
  'config.salesChannel': { es:'Canal de Venta', en:'Sales Channel', de:'Vertriebskanal' },
  'config.gtcService': { es:'Servicio GTC / Limpieza / Amenities / Mant.', en:'GTC Service / Cleaning / Amenities / Maint.', de:'GTC Service / Reinigung / Ausstattung / Wartung' },
  'config.gateway':    { es:'Pasarela', en:'Payment Gateway', de:'Zahlungsgateway' },
  'config.taxes':      { es:'Impuestos', en:'Taxes', de:'Steuern' },
  'config.agreement8020': { es:'Acuerdo 80/20', en:'80/20 Agreement', de:'80/20 Vereinbarung' },

  // ——— Sort/Status Options ———
  'sort.original':     { es:'Orden original', en:'Original order', de:'Urspr\u00fcngliche Reihenfolge' },
  'sort.status':       { es:'Estado', en:'Status', de:'Status' },
  'sort.idReserva':    { es:'ID Reserva', en:'Reservation ID', de:'Buchungs-ID' },
  'sort.localizador':  { es:'Localizador', en:'Locator', de:'Buchungscode' },
  'sort.fechaAlta':    { es:'Fecha Alta', en:'Creation Date', de:'Erstellungsdatum' },
  'sort.cliente':      { es:'Cliente', en:'Client', de:'Kunde' },
  'sort.alojamiento':  { es:'Alojamiento', en:'Property', de:'Unterkunft' },
  'sort.edificio':     { es:'Edificio', en:'Building', de:'Geb\u00e4ude' },
  'sort.plataforma':   { es:'Plataforma', en:'Platform', de:'Plattform' },
  'sort.atendidoPor':  { es:'Atendido por', en:'Attended by', de:'Betreut von' },
  'sort.origenMkt':    { es:'Origen Mkt.', en:'Marketing Source', de:'Marketing-Quelle' },
  'sort.tipoReserva':  { es:'Tipo Reserva', en:'Reservation Type', de:'Buchungstyp' },
  'sort.fechaEntrada': { es:'Fecha Entrada', en:'Check-in Date', de:'Anreisedatum' },
  'sort.fechaSalida':  { es:'Fecha Salida', en:'Check-out Date', de:'Abreisedatum' },
  'sort.nights':       { es:'Noches', en:'Nights', de:'N\u00e4chte' },
  'sort.totalReserva': { es:'Total reserva', en:'Total reservation', de:'Gesamt Buchung' },
  'sort.baseNoVAT':    { es:'Base sin IVA', en:'Base excl. VAT', de:'Nettobetrag' },
  'sort.subtotal':     { es:'Subtotal', en:'Subtotal', de:'Zwischensumme' },
  'sort.totalToSettle': { es:'Total a liquidar', en:'Total to settle', de:'Gesamt zur Abrechnung' },
  'sort.observation':  { es:'Observaci\u00f3n', en:'Notes', de:'Bemerkungen' },
  'sort.ascending':    { es:'\u2191 Ascendente', en:'\u2191 Ascending', de:'\u2191 Aufsteigend' },
  'sort.descending':   { es:'\u2193 Descendente', en:'\u2193 Descending', de:'\u2193 Absteigend' },
  'sort.nameAZ':       { es:'Nombre A\u2191Z', en:'Name A\u2191Z', de:'Name A\u2191Z' },
  'sort.nameZA':       { es:'Nombre Z\u2191A', en:'Name Z\u2191A', de:'Name Z\u2191A' },
  'sort.moreReservations': { es:'M\u00e1s reservas', en:'Most reservations', de:'Meiste Buchungen' },
  'sort.lessReservations': { es:'Menos reservas', en:'Fewest reservations', de:'Wenigste Buchungen' },
  'sort.higherSettlement': { es:'Mayor liquidaci\u00f3n', en:'Highest settlement', de:'H\u00f6chste Abrechnung' },
  'sort.lowerSettlement': { es:'Menor liquidaci\u00f3n', en:'Lowest settlement', de:'Niedrigste Abrechnung' },
  'sort.higherBilling': { es:'Mayor facturaci\u00f3n', en:'Highest billing', de:'H\u00f6chster Umsatz' },
  'sort.lowerBilling': { es:'Menor facturaci\u00f3n', en:'Lowest billing', de:'Niedrigster Umsatz' },
  'status.all':        { es:'Todos los estados', en:'All statuses', de:'Alle Status' },
  'status.pendingPl':  { es:'Pendientes', en:'Pending', de:'Ausstehend' },
  'status.validatedPl': { es:'Validadas', en:'Validated', de:'Validiert' },
  'consol.notValidated': { es:'No Validadas', en:'Not Validated', de:'Nicht validiert' },
  'consol.validatedTab': { es:'Validadas', en:'Validated', de:'Validiert' },

  // ——— Month names ———
  'month.short.0': { es:'Ene', en:'Jan', de:'Jan' },
  'month.short.1': { es:'Feb', en:'Feb', de:'Feb' },
  'month.short.2': { es:'Mar', en:'Mar', de:'M\u00e4r' },
  'month.short.3': { es:'Abr', en:'Apr', de:'Apr' },
  'month.short.4': { es:'May', en:'May', de:'Mai' },
  'month.short.5': { es:'Jun', en:'Jun', de:'Jun' },
  'month.short.6': { es:'Jul', en:'Jul', de:'Jul' },
  'month.short.7': { es:'Ago', en:'Aug', de:'Aug' },
  'month.short.8': { es:'Sep', en:'Sep', de:'Sep' },
  'month.short.9': { es:'Oct', en:'Oct', de:'Okt' },
  'month.short.10': { es:'Nov', en:'Nov', de:'Nov' },
  'month.short.11': { es:'Dic', en:'Dec', de:'Dez' },
  'month.full.0':  { es:'Enero', en:'January', de:'Januar' },
  'month.full.1':  { es:'Febrero', en:'February', de:'Februar' },
  'month.full.2':  { es:'Marzo', en:'March', de:'M\u00e4rz' },
  'month.full.3':  { es:'Abril', en:'April', de:'April' },
  'month.full.4':  { es:'Mayo', en:'May', de:'Mai' },
  'month.full.5':  { es:'Junio', en:'June', de:'Juni' },
  'month.full.6':  { es:'Julio', en:'July', de:'Juli' },
  'month.full.7':  { es:'Agosto', en:'August', de:'August' },
  'month.full.8':  { es:'Septiembre', en:'September', de:'September' },
  'month.full.9':  { es:'Octubre', en:'October', de:'Oktober' },
  'month.full.10': { es:'Noviembre', en:'November', de:'November' },
  'month.full.11': { es:'Diciembre', en:'December', de:'Dezember' },

  // ——— Sync ———
  'sync.synced':       { es:'Sincronizado', en:'Synced', de:'Synchronisiert' },
  'sync.syncing':      { es:'Sincronizando...', en:'Syncing...', de:'Synchronisierung...' },

  // ——— Changelog / Version ———
  'changelog.title':   { es:'Historial de versiones', en:'Version history', de:'Versionshistorie' },
  'changelog.link':    { es:'Historial de cambios', en:'Changelog', de:'\u00c4nderungsprotokoll' },

  // ——— AI Assistant ———
  'ai.title':          { es:'Asistente Hist\u00f3rico Reservas', en:'Reservations History Assistant', de:'Buchungshistorie-Assistent' },
  'ai.placeholder':    { es:'Escribe tu pregunta...', en:'Type your question...', de:'Schreiben Sie Ihre Frage...' },
  'ai.send':           { es:'Enviar', en:'Send', de:'Senden' },
  'ai.guide':          { es:'Gu\u00eda completa del Asistente IA', en:'Complete AI Assistant Guide', de:'Vollst\u00e4ndige KI-Assistenten-Anleitung' },
  'ai.guideDesc':      { es:'Todo lo que puedes hacer con el asistente, explicado con ejemplos reales.', en:'Everything you can do with the assistant, explained with real examples.', de:'Alles, was Sie mit dem Assistenten tun k\u00f6nnen, mit Beispielen erkl\u00e4rt.' },
  'ai.closeGuide':     { es:'Cerrar gu\u00eda', en:'Close guide', de:'Anleitung schlie\u00dfen' },

  // ——— Pagination ———
  'pagination.showing': { es:'Mostrando', en:'Showing', de:'Zeige' },
  'pagination.of':     { es:'de', en:'of', de:'von' },
  'pagination.reservations': { es:'reservas', en:'reservations', de:'Buchungen' },
  'pagination.rowsPerPage': { es:'Filas/p\u00e1g:', en:'Rows/page:', de:'Zeilen/Seite:' },

  // ——— Preview / Print ———
  'preview.show':      { es:'Se mostrar\u00e1 previsualizaci\u00f3n', en:'Preview will be shown', de:'Vorschau wird angezeigt' },
  'preview.direct':    { es:'Se imprimir\u00e1 directamente', en:'Will print directly', de:'Wird direkt gedruckt' },
  'preview.change':    { es:'Cambiar', en:'Change', de:'\u00c4ndern' },
  'preview.before':    { es:'Ver previsualizaci\u00f3n antes', en:'Show preview first', de:'Vorschau zuerst anzeigen' },
  'preview.dontAsk':   { es:'No preguntar m\u00e1s', en:'Don\u0027t ask again', de:'Nicht mehr fragen' },

  // ——— Language Selector ———
  'lang.label':        { es:'Idioma', en:'Language', de:'Sprache' },

  // ——— Misc ———
  'misc.clean':        { es:'Limpiar', en:'Clear', de:'L\u00f6schen' },
  'misc.close':        { es:'Cerrar', en:'Close', de:'Schlie\u00dfen' },
  'misc.clickToEditOwner': { es:'Clic para editar propietario', en:'Click to edit owner', de:'Klicken zum Bearbeiten des Eigent\u00fcmers' },
  'misc.changeUrl':    { es:'Cambiar URL', en:'Change URL', de:'URL \u00e4ndern' },
  'misc.removeDefault': { es:'Quitar por defecto', en:'Remove default', de:'Standard entfernen' },
  'misc.configValues': { es:'Configurar valores', en:'Configure values', de:'Werte konfigurieren' },
  'misc.showHideCols': { es:'Mostrar/ocultar columnas', en:'Show/hide columns', de:'Spalten ein-/ausblenden' },
  // ——— Columns (extra) ———
  'col.comGtc':          { es:'Gesti\u00f3n<br>GTC', en:'GTC<br>Mgmt', de:'GTC<br>Verw.' },
  'col.conceptosEsp':    { es:'Conceptos<br>Esp.', en:'Special<br>Items', de:'Sonder-<br>posten' },
  'col.conceptosSinIVA': { es:'Conceptos<br>s/IVA', en:'Items<br>No VAT', de:'Posten<br>o.MwSt.' },


  // ——— Toast / Loading messages ———
  'toast.googleNotInit':  { es:'Google API no inicializada. Recarga la p\u00e1gina.', en:'Google API not initialized. Reload the page.', de:'Google API nicht initialisiert. Seite neu laden.' },
  'toast.defaultUrlInvalid': { es:'La URL por defecto no es v\u00e1lida.', en:'Default URL is not valid.', de:'Standard-URL ist ung\u00fcltig.' },
  'toast.enterValidUrl':  { es:'Introduce una URL v\u00e1lida.', en:'Enter a valid URL.', de:'Geben Sie eine g\u00fcltige URL ein.' },
  'toast.invalidUrlSheets': { es:'URL no v\u00e1lida. Debe ser Google Sheets.', en:'Invalid URL. Must be Google Sheets.', de:'Ung\u00fcltige URL. Muss Google Sheets sein.' },
  'toast.loginFirst':     { es:'Inicia sesi\u00f3n con Google primero.', en:'Sign in with Google first.', de:'Melden Sie sich zuerst bei Google an.' },
  'toast.pasteUrl':       { es:'Pega la URL de la hoja de Google Sheets', en:'Paste the Google Sheets URL', de:'F\u00fcgen Sie die Google Sheets URL ein' },
  'toast.noDataSheets':   { es:'No se encontraron hojas de datos.', en:'No data sheets found.', de:'Keine Datenbl\u00e4tter gefunden.' },
  'toast.sheetEmpty':     { es:'La hoja est\u00e1 vac\u00eda o no tiene datos suficientes.', en:'The sheet is empty or has insufficient data.', de:'Das Blatt ist leer oder enth\u00e4lt nicht gen\u00fcgend Daten.' },
  'toast.errorLoadSheet': { es:'Error al cargar la hoja. Verifica acceso y URL.', en:'Error loading sheet. Check access and URL.', de:'Fehler beim Laden. Zugriff und URL pr\u00fcfen.' },
  'toast.errorReadData':  { es:'Error al leer datos. Comprueba los permisos.', en:'Error reading data. Check permissions.', de:'Fehler beim Lesen. Berechtigungen pr\u00fcfen.' },
  'toast.errorSaveGoogle': { es:'Error al guardar. \u00bfEst\u00e1s conectado a Google Sheets?', en:'Save error. Are you connected to Google Sheets?', de:'Speicherfehler. Mit Google Sheets verbunden?' },
  'toast.noHeaderId':     { es:'No se encontr\u00f3 la cabecera ID Reserva.', en:'Reservation ID header not found.', de:'Buchungs-ID-Kopfzeile nicht gefunden.' },
  'toast.invalidFile':    { es:'El archivo no contiene datos v\u00e1lidos.', en:'File does not contain valid data.', de:'Datei enth\u00e4lt keine g\u00fcltigen Daten.' },
  'toast.validPercent':   { es:'Porcentaje v\u00e1lido: 0-100', en:'Valid percentage: 0-100', de:'G\u00fcltiger Prozentsatz: 0-100' },
  'toast.alreadyExists':  { es:'Ya existe.', en:'Already exists.', de:'Existiert bereits.' },
  'toast.invalidValue':   { es:'Valor no v\u00e1lido.', en:'Invalid value.', de:'Ung\u00fcltiger Wert.' },
  'loading.reading':      { es:'Leyendo datos de', en:'Reading data from', de:'Lese Daten von' },
  'loading.processing':   { es:'Procesando %s filas...', en:'Processing %s rows...', de:'Verarbeite %s Zeilen...' },
  'loading.gettingInfo':  { es:'Obteniendo informaci\u00f3n de la hoja...', en:'Getting sheet information...', de:'Blattinformationen werden abgerufen...' },
  'sync.updated':         { es:'actualizado', en:'updated', de:'aktualisiert' },
  'sync.updatedPl':       { es:'actualizados', en:'updated', de:'aktualisiert' },
  'btn.addValue':         { es:'+ A\u00f1adir', en:'+ Add', de:'+ Hinzuf\u00fcgen' },


  'btn.sendEmail2':      { es:'&#9993; Enviar por Email', en:'&#9993; Send by Email', de:'&#9993; Per E-Mail senden' },
  'btn.validateFirst':   { es:'\u26a0 Valida todas las reservas primero', en:'\u26a0 Validate all reservations first', de:'\u26a0 Zuerst alle Buchungen validieren' },
  'sync.activateBtn':    { es:'Activar sincronizaci\u00f3n multi-usuario', en:'Activate multi-user sync', de:'Multi-User-Sync aktivieren' },


  // ——— Phase 2A: AI Assistant visible elements ———
  'ai.subtitle':       { es:'Preg\u00fantame sobre tus reservas, liquidaciones, importes... Respondo solo con tus datos reales.', en:'Ask me about your reservations, settlements, amounts... I only answer with your real data.', de:'Fragen Sie mich zu Ihren Buchungen, Abrechnungen, Betr\u00e4gen... Ich antworte nur mit Ihren echten Daten.' },
  'ai.closeGuideBtn':  { es:'Cerrar gu\u00eda \u00d7', en:'Close guide \u00d7', de:'Anleitung schlie\u00dfen \u00d7' },
  'ai.chip.briefing':  { es:'\u26a1 Briefing', en:'\u26a1 Briefing', de:'\u26a1 Briefing' },
  'ai.chip.kpis':      { es:'\ud83d\udcca KPIs', en:'\ud83d\udcca KPIs', de:'\ud83d\udcca KPIs' },
  'ai.chip.owners':    { es:'\ud83d\udc65 Propietarios', en:'\ud83d\udc65 Owners', de:'\ud83d\udc65 Eigent\u00fcmer' },
  'ai.chip.heatmap':   { es:'\ud83d\uddfa\ufe0f Heatmap', en:'\ud83d\uddfa\ufe0f Heatmap', de:'\ud83d\uddfa\ufe0f Heatmap' },
  'ai.chip.duplicates': { es:'\ud83d\udd0d Duplicados', en:'\ud83d\udd0d Duplicates', de:'\ud83d\udd0d Duplikate' },
  'ai.chip.segments':  { es:'\ud83d\udcca Segmentos', en:'\ud83d\udcca Segments', de:'\ud83d\udcca Segmente' },
  'ai.chip.leadtime':  { es:'\u23f1\ufe0f Lead time', en:'\u23f1\ufe0f Lead time', de:'\u23f1\ufe0f Vorlaufzeit' },
  'ai.chip.whatif':    { es:'\ud83d\udd2e What-if', en:'\ud83d\udd2e What-if', de:'\ud83d\udd2e Was-w\u00e4re-wenn' },
  'ai.chip.export':    { es:'\ud83d\udce5 Exportar', en:'\ud83d\udce5 Export', de:'\ud83d\udce5 Exportieren' },
  'ai.chip.briefingQ': { es:'Briefing r\u00e1pido: dame lo m\u00e1s importante en 5 frases', en:'Quick briefing: give me the most important facts in 5 sentences', de:'Schnelles Briefing: gib mir das Wichtigste in 5 S\u00e4tzen' },
  'ai.chip.kpisQ':     { es:'Dame un resumen ejecutivo con KPIs principales: ADR, estancia media, comisi\u00f3n efectiva, margen propietario, top y bottom 5 pisos', en:'Give me an executive summary with main KPIs: ADR, average stay, effective commission, owner margin, top and bottom 5 properties', de:'Gib mir eine Zusammenfassung mit KPIs: ADR, durchschnittliche Aufenthaltsdauer, effektive Provision, Eigent\u00fcmermarge, Top und Bottom 5 Unterk\u00fcnfte' },
  'ai.chip.ownersQ':   { es:'Compara todos los propietarios con m\u00e9tricas detalladas por piso: ADR, margen, reservas, noches', en:'Compare all owners with detailed per-property metrics: ADR, margin, reservations, nights', de:'Vergleiche alle Eigent\u00fcmer mit detaillierten Kennzahlen pro Unterkunft: ADR, Marge, Buchungen, N\u00e4chte' },
  'ai.chip.heatmapQ':  { es:'Mapa de calor de ocupaci\u00f3n por alojamiento y mes con sparklines', en:'Occupancy heatmap by property and month with sparklines', de:'Belegungs-Heatmap nach Unterkunft und Monat mit Sparklines' },
  'ai.chip.duplicatesQ': { es:'\u00bfHay reservas duplicadas o con importes sospechosos? Busca anomal\u00edas', en:'Are there duplicate reservations or suspicious amounts? Look for anomalies', de:'Gibt es doppelte Buchungen oder verd\u00e4chtige Betr\u00e4ge? Suche nach Anomalien' },
  'ai.chip.segmentsQ': { es:'Segmentaci\u00f3n por tipo de estancia: escapadas, vacaciones y larga estancia, por plataforma', en:'Segmentation by stay type: getaways, vacations and long stays, by platform', de:'Segmentierung nach Aufenthaltsart: Kurzurlaub, Urlaub und Langzeitaufenthalt, nach Plattform' },
  'ai.chip.leadtimeQ': { es:'An\u00e1lisis de lead time: \u00bfcon cu\u00e1nta antelaci\u00f3n reservan por plataforma?', en:'Lead time analysis: how far in advance do they book by platform?', de:'Vorlaufzeit-Analyse: wie weit im Voraus wird pro Plattform gebucht?' },
  'ai.chip.whatifQ':   { es:'\u00bfQu\u00e9 pasar\u00eda si subimos el ADR un 10% en todos los pisos?', en:'What if we raise the ADR by 10% on all properties?', de:'Was w\u00e4re, wenn wir den ADR um 10% bei allen Unterk\u00fcnften erh\u00f6hen?' },
  'ai.chip.exportQ':   { es:'Quiero exportar datos a Excel. \u00bfQu\u00e9 opciones de descarga tengo disponibles?', en:'I want to export data to Excel. What download options are available?', de:'Ich m\u00f6chte Daten nach Excel exportieren. Welche Download-Optionen sind verf\u00fcgbar?' },
  'alert.lowAdr':      { es:'piso(s) con ADR < 50\u20ac/noche', en:'property(ies) with ADR < 50\u20ac/night', de:'Unterkunft(en) mit ADR < 50\u20ac/Nacht' },
  'alert.noReserv':    { es:'piso(s) sin reservas en el periodo', en:'property(ies) with no reservations in the period', de:'Unterkunft(en) ohne Buchungen im Zeitraum' },
  'alert.pendingVal':  { es:'reservas pendientes de validar', en:'reservations pending validation', de:'Buchungen ausstehend zur Validierung' },
  'alert.ofTotal':     { es:'del total', en:'of total', de:'der Gesamtzahl' },
  'alert.lowMargin':   { es:'piso(s) con margen < 30%', en:'property(ies) with margin < 30%', de:'Unterkunft(en) mit Marge < 30%' },
  'alert.duplicates':  { es:'posible(s) duplicado(s) detectados. Pregunta:', en:'possible duplicate(s) detected. Ask:', de:'m\u00f6gliche Duplikate erkannt. Fragen Sie:' },
  'alert.showDups':    { es:'\u00abmu\u00e9strame los duplicados\u00bb', en:'\u00abshow me the duplicates\u00bb', de:'\u00abzeig mir die Duplikate\u00bb' },
  'alert.andMore':     { es:'y %s m\u00e1s', en:'and %s more', de:'und %s mehr' },
  'alert.askMore':     { es:'Preg\u00fantame sobre cualquiera de estas alertas para m\u00e1s detalle.', en:'Ask me about any of these alerts for more detail.', de:'Fragen Sie mich zu diesen Warnungen f\u00fcr mehr Details.' },


  // ——— Follow-up suggestion labels & queries ———
  'fu.worstAdr':      { es:'\ud83d\udcc9 Pisos peor ADR', en:'\ud83d\udcc9 Lowest ADR', de:'\ud83d\udcc9 Niedrigster ADR' },
  'fu.worstAdrQ':     { es:'\u00bfQu\u00e9 pisos tienen el ADR m\u00e1s bajo?', en:'Which properties have the lowest ADR?', de:'Welche Unterk\u00fcnfte haben den niedrigsten ADR?' },
  'fu.export':        { es:'\ud83d\udce5 Exportar', en:'\ud83d\udce5 Export', de:'\ud83d\udce5 Exportieren' },
  'fu.exportQ':       { es:'Exportar estos datos a Excel', en:'Export this data to Excel', de:'Diese Daten nach Excel exportieren' },
  'fu.owners':        { es:'\ud83d\udc65 Propietarios', en:'\ud83d\udc65 Owners', de:'\ud83d\udc65 Eigent\u00fcmer' },
  'fu.ownersQ':       { es:'Compara propietarios con m\u00e9tricas detalladas', en:'Compare owners with detailed metrics', de:'Eigent\u00fcmer mit Kennzahlen vergleichen' },
  'fu.simMinus':      { es:'\ud83d\udd2e Simular -2%', en:'\ud83d\udd2e Simulate -2%', de:'\ud83d\udd2e Simulieren -2%' },
  'fu.simMinusQ':     { es:'\u00bfQu\u00e9 pasar\u00eda si reducimos la comisi\u00f3n un 2%?', en:'What if we reduce commission by 2%?', de:'Was wenn wir die Provision um 2% senken?' },
  'fu.rankMargin':    { es:'\ud83d\udcc8 Ranking margen', en:'\ud83d\udcc8 Margin ranking', de:'\ud83d\udcc8 Marge-Ranking' },
  'fu.rankMarginQ':   { es:'Ranking de pisos por margen propietario', en:'Property ranking by owner margin', de:'Unterkunft-Ranking nach Eigent\u00fcmermarge' },
  'fu.leadtime':      { es:'\u23f1\ufe0f Lead time', en:'\u23f1\ufe0f Lead time', de:'\u23f1\ufe0f Vorlaufzeit' },
  'fu.leadtimeQ':     { es:'\u00bfQu\u00e9 plataforma tiene mejor lead time?', en:'Which platform has the best lead time?', de:'Welche Plattform hat die beste Vorlaufzeit?' },
  'fu.segments':      { es:'\ud83d\udcca Segmentos', en:'\ud83d\udcca Segments', de:'\ud83d\udcca Segmente' },
  'fu.segmentsQ':     { es:'Segmentaci\u00f3n de estancias por plataforma', en:'Stay segmentation by platform', de:'Aufenthaltssegmentierung nach Plattform' },
  'fu.heatmap':       { es:'\ud83d\uddfa\ufe0f Heatmap', en:'\ud83d\uddfa\ufe0f Heatmap', de:'\ud83d\uddfa\ufe0f Heatmap' },
  'fu.heatmapQ':      { es:'Mapa de calor de ocupaci\u00f3n por mes', en:'Occupancy heatmap by month', de:'Belegungs-Heatmap nach Monat' },
  'fu.duplicates':    { es:'\ud83d\udd0d Duplicados', en:'\ud83d\udd0d Duplicates', de:'\ud83d\udd0d Duplikate' },
  'fu.duplicatesQ':   { es:'\u00bfHay reservas duplicadas o sospechosas?', en:'Are there duplicate or suspicious reservations?', de:'Gibt es doppelte oder verd\u00e4chtige Buchungen?' },
  'fu.season':        { es:'\u2600\ufe0f Estacionalidad', en:'\u2600\ufe0f Seasonality', de:'\u2600\ufe0f Saisonalit\u00e4t' },
  'fu.seasonQ':       { es:'Estacionalidad por trimestre y plataforma', en:'Seasonality by quarter and platform', de:'Saisonalit\u00e4t nach Quartal und Plattform' },
  'fu.simPlus':       { es:'\ud83d\udd2e Simular +10%', en:'\ud83d\udd2e Simulate +10%', de:'\ud83d\udd2e Simulieren +10%' },
  'fu.simPlusQ':      { es:'\u00bfQu\u00e9 pasar\u00eda si subimos ADR un 10%?', en:'What if we raise ADR by 10%?', de:'Was wenn wir den ADR um 10% erh\u00f6hen?' },
  'fu.predict':       { es:'\ud83d\udd2e Predecir', en:'\ud83d\udd2e Predict', de:'\ud83d\udd2e Vorhersage' },
  'fu.predictQ':      { es:'Predicci\u00f3n de ocupaci\u00f3n futura', en:'Future occupancy prediction', de:'Zuk\u00fcnftige Belegungsprognose' },
  'fu.topGrowth':     { es:'\ud83d\udcc8 Top crecimiento', en:'\ud83d\udcc8 Top growth', de:'\ud83d\udcc8 Top Wachstum' },
  'fu.topGrowthQ':    { es:'Ranking de pisos con mayor crecimiento', en:'Property ranking by highest growth', de:'Unterkunft-Ranking nach h\u00f6chstem Wachstum' },
  'fu.segHigh':       { es:'\ud83c\udfd6\ufe0f Segmentar alta', en:'\ud83c\udfd6\ufe0f Segment high', de:'\ud83c\udfd6\ufe0f Hochsaison seg.' },
  'fu.segHighQ':      { es:'\u00bfQu\u00e9 tipo de estancia predomina en temporada alta?', en:'What stay type dominates in high season?', de:'Welcher Aufenthaltstyp dominiert in der Hochsaison?' },
  'fu.ltByStay':      { es:'\u23f1\ufe0f Lead time', en:'\u23f1\ufe0f Lead time', de:'\u23f1\ufe0f Vorlaufzeit' },
  'fu.ltByStayQ':     { es:'Lead time por tipo de estancia', en:'Lead time by stay type', de:'Vorlaufzeit nach Aufenthaltsart' },
  'fu.byProp':        { es:'\ud83c\udfe0 Por piso', en:'\ud83c\udfe0 By property', de:'\ud83c\udfe0 Nach Unterkunft' },
  'fu.byPropQ':       { es:'\u00bfQu\u00e9 pisos se reservan con m\u00e1s antelaci\u00f3n?', en:'Which properties are booked furthest in advance?', de:'Welche Unterk\u00fcnfte werden am weitesten im Voraus gebucht?' },
  'fu.kpis':          { es:'\ud83d\udcca KPIs', en:'\ud83d\udcca KPIs', de:'\ud83d\udcca KPIs' },
  'fu.kpisQ':         { es:'Resumen ejecutivo con KPIs', en:'Executive summary with KPIs', de:'Zusammenfassung mit KPIs' },
  'fu.realComm':      { es:'\ud83d\udcb0 Comisiones reales', en:'\ud83d\udcb0 Real commissions', de:'\ud83d\udcb0 Echte Provisionen' },
  'fu.realCommQ':     { es:'Desglose real de comisiones por plataforma', en:'Real commission breakdown by platform', de:'Echte Provisionsaufschl\u00fcsselung nach Plattform' },
  'fu.kpiDetail':     { es:'\ud83d\udcca KPIs detallados', en:'\ud83d\udcca Detailed KPIs', de:'\ud83d\udcca Detaillierte KPIs' },
  'fu.kpiDetailQ':    { es:'Dame m\u00e1s detalle con KPIs completos', en:'Give me more detail with complete KPIs', de:'Gib mir mehr Details mit vollst\u00e4ndigen KPIs' },
  'fu.anomalies':     { es:'\u26a0\ufe0f Anomal\u00edas', en:'\u26a0\ufe0f Anomalies', de:'\u26a0\ufe0f Anomalien' },
  'fu.anomaliesQ':    { es:'\u00bfHay algo an\u00f3malo que deba revisar?', en:'Is there anything anomalous I should review?', de:'Gibt es Anomalien, die ich pr\u00fcfen sollte?' },


  'ai.apiKeyPrompt':  { es:'Introduce tu API Key de Anthropic para activar el asistente IA.\n\nLa clave se guarda localmente en tu navegador y nunca se comparte.\n\nPuedes obtenerla en: console.anthropic.com', en:'Enter your Anthropic API Key to activate the AI assistant.\n\nThe key is stored locally in your browser and never shared.\n\nGet it at: console.anthropic.com', de:'Geben Sie Ihren Anthropic API-Schl\u00fcssel ein, um den KI-Assistenten zu aktivieren.\n\nDer Schl\u00fcssel wird lokal in Ihrem Browser gespeichert und nie weitergegeben.\n\nErhalten Sie ihn unter: console.anthropic.com' },
  'ai.rateLimit':     { es:'\u23f3 L\u00edmite de API alcanzado. Reintentando en %ss...', en:'\u23f3 API rate limit reached. Retrying in %ss...', de:'\u23f3 API-Limit erreicht. Erneuter Versuch in %ss...' },
  'ai.errorPrefix':   { es:'Error: ', en:'Error: ', de:'Fehler: ' },
  'ai.errorGeneric':  { es:'Error al comunicarse con la IA', en:'Error communicating with AI', de:'Fehler bei der KI-Kommunikation' },


  'ai.loadFirst':     { es:'Primero carga las reservas desde Google Sheets o Excel para poder responder preguntas.', en:'First load the reservations from Google Sheets or Excel to be able to answer questions.', de:'Laden Sie zuerst die Buchungen von Google Sheets oder Excel, um Fragen beantworten zu k\u00f6nnen.' },
  'ai.helpBtn':       { es:'L\u00e9eme / Ayuda', en:'Read me / Help', de:'Lies mich / Hilfe' },
  'ai.invalidKey':    { es:'API Key inv\u00e1lida. Se ha borrado. Vuelve a intentarlo.', en:'Invalid API Key. It has been deleted. Please try again.', de:'Ung\u00fcltiger API-Schl\u00fcssel. Er wurde gel\u00f6scht. Bitte versuchen Sie es erneut.' },


  // ——— CE panels, buttons, consol detail ———
  'ce.placeholderPet': { es:'E.g.: Pet...', en:'E.g.: Pet...', de:'Z.B.: Haustier...' },
  'ce.placeholderRep': { es:'E.g.: Repair...', en:'E.g.: Repair...', de:'Z.B.: Reparatur...' },


  // ——— Email modal ———



  // ——— Phase 1: Missing visible translations ———
  'stats.filtered':       { es:'filtradas', en:'filtered', de:'gefiltert' },
  'stats.filteredOf':     { es:'filtradas', en:'filtered', de:'gefiltert' },
  'stats.reservationCount': { es:'reservas', en:'reservations', de:'Buchungen' },
  'btn.validateAll':      { es:'Validar todas', en:'Validate all', de:'Alle validieren' },
  'btn.validatePending':  { es:'Validar pendientes', en:'Validate pending', de:'Ausstehende validieren' },
  'btn.unvalidateAll':    { es:'Desvalidar todas', en:'Unvalidate all', de:'Alle devalidieren' },
  'btn.unvalidateValidated': { es:'Desvalidar validadas', en:'Unvalidate validated', de:'Validierte devalidieren' },
  'consol.reservations':  { es:'Reservas', en:'Reservations', de:'Buchungen' },
  'consol.billing':       { es:'Facturaci\u00f3n', en:'Billing', de:'Rechnungsbetrag' },
  'consol.toSettle':      { es:'A Liquidar', en:'To Settle', de:'Abzurechnen' },
  'filter.clearDate':     { es:'\u00d7 Quitar filtro de fecha', en:'\u00d7 Clear date filter', de:'\u00d7 Datumsfilter entfernen' },
  'filter.allMonths':     { es:'Todos los meses', en:'All months', de:'Alle Monate' },
  'filter.allStatuses2':  { es:'Todos los estados', en:'All statuses', de:'Alle Status' },
  'sort.originalOrder':   { es:'Orden original', en:'Original order', de:'Originalreihenfolge' },
  'sort.nameAsc':         { es:'Nombre A\u2191Z', en:'Name A\u2191Z', de:'Name A\u2191Z' },
  'sync.on':              { es:'Sync ON', en:'Sync ON', de:'Sync AN' },
  'sync.off':             { es:'Sync OFF', en:'Sync OFF', de:'Sync AUS' },
  'sync.activeTitle':     { es:'Sincronizaci\u00f3n multi-usuario activa', en:'Multi-user sync active', de:'Multi-User-Sync aktiv' },
  'sync.activateTitle':   { es:'Activar sincronizaci\u00f3n multi-usuario', en:'Activate multi-user sync', de:'Multi-User-Sync aktivieren' },
  'save.saving':          { es:'Guardando...', en:'Saving...', de:'Speichern...' },
  'save.saved':           { es:'Guardado', en:'Saved', de:'Gespeichert' },
  'save.error':           { es:'Error al guardar', en:'Save error', de:'Speicherfehler' },
  'save.synced':          { es:'Sincronizado', en:'Synced', de:'Synchronisiert' },
  'liq.totalToSettleFull': { es:'Total a Liquidar', en:'Total to Settle', de:'Gesamt abzurechnen' },
  'liq.generateBtn':      { es:'\ud83d\udda8 Generar Liquidaci\u00f3n', en:'\ud83d\udda8 Generate Settlement', de:'\ud83d\udda8 Abrechnung erstellen' },
  'liq.paymentGateway':   { es:'Pasarela de pago', en:'Payment gateway', de:'Zahlungsgateway' },
  'liq.irpfWithholding':  { es:'Retenci\u00f3n IRPF', en:'IRPF Withholding', de:'IRPF-Einbehalt' },
  'liq.ownerReceives':    { es:'Propietario recibe', en:'Owner receives', de:'Eigent\u00fcmer erh\u00e4lt' },
  'liq.propietario':      { es:'Propietario', en:'Owner', de:'Eigent\u00fcmer' },
  'consol.summary2':      { es:'Resumen Consolidado', en:'Consolidated Summary', de:'Konsolidierte \u00dcbersicht' },
  'consol.numReservationsLabel': { es:'N\u00ba Reservas', en:'Reservations', de:'Buchungen' },
  'consol.dates':         { es:'Fechas', en:'Dates', de:'Daten' },
  'alert.detected':       { es:'\ud83d\udd0d Alertas detectadas:', en:'\ud83d\udd0d Alerts detected:', de:'\ud83d\udd0d Erkannte Warnungen:' },
  'ce.specialConcepts':   { es:'Conceptos especiales (IVA inc.)', en:'Special concepts (VAT inc.)', de:'Sonderposten (MwSt. inkl.)' },
  'ce2.specialConcepts':  { es:'Conceptos especiales (Sin IVA)', en:'Special concepts (No VAT)', de:'Sonderposten (ohne MwSt.)' },
  'config.newValue':      { es:'Nuevo valor', en:'New value', de:'Neuer Wert' },
  'confirm.validateAll':  { es:'\u00bfValidar %s reserva(s)?', en:'Validate %s reservation(s)?', de:'%s Buchung(en) validieren?' },
  'confirm.unvalidateAll': { es:'\u00bfDesvalidar %s reserva(s)?', en:'Unvalidate %s reservation(s)?', de:'%s Buchung(en) devalidieren?' },
  'confirm.validateConsol': { es:'\u00bfValidar %s reserva(s) de %s?', en:'Validate %s reservation(s) from %s?', de:'%s Buchung(en) von %s validieren?' },
  'pager.of':             { es:'de', en:'of', de:'von' },

  'pdf.errorGenerate': { es:'Error al generar PDF: ', en:'Error generating PDF: ', de:'Fehler beim PDF-Erstellen: ' },
  'pdf.errorRead':     { es:'Error al leer el archivo PDF', en:'Error reading PDF file', de:'Fehler beim Lesen der PDF-Datei' },
  // ——— v2.24.0: CE panels ———
  'ce.title':          { es:'\u26a0 Conceptos especiales', en:'\u26a0 Special Concepts', de:'\u26a0 Sonderposten' },
  'ce.internalOnly':   { es:'\ud83d\udc41 Solo uso interno', en:'\ud83d\udc41 Internal use only', de:'\ud83d\udc41 Nur intern' },
  'ce.addItem':        { es:'+ A\u00f1adir concepto', en:'+ Add concept', de:'+ Posten hinzuf\u00fcgen' },
  'ce.totalReserva':   { es:'Total Reserva', en:'Total Booking', de:'Buchungssumme' },
  'ce.ivaInc':         { es:'(IVA inc.)', en:'(VAT inc.)', de:'(inkl. MwSt.)' },
  'ce.deduct':         { es:'Descontar', en:'Deduct', de:'Abzug' },
  'ce.totalSinCE':     { es:'Total sin C.E.', en:'Total w/o S.C.', de:'Summe ohne S.P.' },
  'ce.sinIVA':         { es:'(sin IVA)', en:'(w/o VAT)', de:'(ohne MwSt.)' },
  'ce.placeholder':    { es:'Ej: Mascota...', en:'E.g.: Pet...', de:'Z.B.: Haustier...' },
  'ce2.title':         { es:'\u26a0 Conceptos especiales (Sin IVA)', en:'\u26a0 Special Concepts (No VAT)', de:'\u26a0 Sonderposten (ohne MwSt.)' },
  'ce2.subtractSub':   { es:'\ud83d\udc41 Resta al subtotal', en:'\ud83d\udc41 Deducted from subtotal', de:'\ud83d\udc41 Vom Zwischensumme abgezogen' },
  'ce2.subBefore':     { es:'Subtotal', en:'Subtotal', de:'Zwischensumme' },
  'ce2.beforeCE':      { es:'antes de C.E.', en:'before S.C.', de:'vor S.P.' },
  'ce2.deductNoVat':   { es:'Descontar', en:'Deduct', de:'Abzug' },
  'ce2.subFinal':      { es:'Subtotal', en:'Subtotal', de:'Zwischensumme' },
  'ce2.final':         { es:'final', en:'final', de:'Endwert' },
  'ce2.placeholder':   { es:'Ej: Reparaci\u00f3n...', en:'E.g.: Repair...', de:'Z.B.: Reparatur...' },
  'cex.placeholder':   { es:'Concepto...', en:'Concept...', de:'Posten...' },
  // ——— v2.24.0: Buttons ———
  'btn.downloadPdfLiq': { es:'Descargar PDF', en:'Download PDF', de:'PDF herunterladen' },
  'btn.sendEmailLiq':  { es:'Enviar por Email', en:'Send by Email', de:'Per E-Mail senden' },
  // ——— v2.24.0: Maintenance ———
  'liq.maintenance':   { es:'Mantenimiento', en:'Maintenance', de:'Instandhaltung' },
  'liq.maintenanceMonthly': { es:'Mantenimiento mensual', en:'Monthly maintenance', de:'Monatliche Instandhaltung' },
  'liq.maintenanceDesc': { es:'Importe base (+ 21% IVA) por liquidaci\u00f3n', en:'Base amount (+ 21% VAT) per settlement', de:'Grundbetrag (+ 21% MwSt.) pro Abrechnung' },
  // ——— v2.24.0: Email modal ———
  'email.title':       { es:'\u2709 Enviar Liquidaci\u00f3n por Email', en:'\u2709 Send Settlement by Email', de:'\u2709 Abrechnung per E-Mail senden' },
  'email.recipient':   { es:'Destinatario', en:'Recipient', de:'Empf\u00e4nger' },
  'email.ccLabel':     { es:'CC \u2014 copia (opcional, separar con comas)', en:'CC \u2014 copy (optional, comma-separated)', de:'CC \u2014 Kopie (optional, kommagetrennt)' },
  'email.ccPlaceholder': { es:'copia1@ejemplo.com, copia2@ejemplo.com', en:'copy1@example.com, copy2@example.com', de:'kopie1@beispiel.com, kopie2@beispiel.com' },
  'email.subject':     { es:'Asunto', en:'Subject', de:'Betreff' },
  'email.extraMsg':    { es:'Mensaje adicional (opcional)', en:'Additional message (optional)', de:'Zus\u00e4tzliche Nachricht (optional)' },
  'email.extraPlaceholder': { es:'A\u00f1ade un mensaje personalizado...', en:'Add a personalized message...', de:'Pers\u00f6nliche Nachricht hinzuf\u00fcgen...' },
  'email.langLabel':   { es:'Idioma del email', en:'Email language', de:'E-Mail-Sprache' },
  'email.langEs':      { es:'Espa\u00f1ol', en:'Spanish', de:'Spanisch' },
  'email.langEn':      { es:'English', en:'English', de:'Englisch' },
  'email.saveAddr':    { es:'Guardar email del propietario', en:'Save owner email', de:'E-Mail des Eigent\u00fcmers speichern' },
  'email.cancel':      { es:'Cancelar', en:'Cancel', de:'Abbrechen' },
  'email.send':        { es:'Enviar \u25b6', en:'Send \u25b6', de:'Senden \u25b6' },
  'email.toPlaceholder': { es:'email@ejemplo.com, otro@ejemplo.com', en:'email@example.com, other@example.com', de:'email@beispiel.com, andere@beispiel.com' },
  'email.sending':     { es:'\u23f3 Enviando email a %s...', en:'\u23f3 Sending email to %s...', de:'\u23f3 E-Mail wird an %s gesendet...' },
  'email.sendingBtn':  { es:'Enviando...', en:'Sending...', de:'Wird gesendet...' },
  'email.sentBtn':     { es:'\u00a1Enviado! \u2714', en:'Sent! \u2714', de:'Gesendet! \u2714' },
  'email.errorSend':   { es:'Error al enviar el email: ', en:'Error sending email: ', de:'Fehler beim E-Mail-Versand: ' },
  // ——— v2.24.0: Liquidation detail (replaces _en? ternary) ———
  'liq.totalResIva':   { es:'Total Reserva (IVA incluido)', en:'Total Booking (VAT included)', de:'Buchungssumme (inkl. MwSt.)' },
  'liq.ivaReserva':    { es:'IVA Reserva', en:'Booking VAT', de:'Buchungs-MwSt.' },
  'liq.baseExclVat':   { es:'Base sin IVA', en:'Base excl. VAT', de:'Nettobetrag' },
  'liq.salesChannel':  { es:'Canal de Venta', en:'Sales Channel', de:'Vertriebskanal' },
  'liq.gtcMgmt':       { es:'Gesti\u00f3n GTC', en:'GTC Management', de:'GTC-Verwaltung' },
  'liq.cleaning':      { es:'Limpieza', en:'Cleaning', de:'Reinigung' },
  'liq.paymentGw':     { es:'Pasarela de pago', en:'Payment Gateway', de:'Zahlungsabwicklung' },
  'liq.ceNoVat':       { es:'C.E. Sin IVA: ', en:'S.C. excl. VAT: ', de:'S.P. ohne MwSt.: ' },
  'liq.unnamed':       { es:'Sin nombre', en:'Unnamed', de:'Ohne Bezeichnung' },
  'liq.subtotal':      { es:'Subtotal', en:'Subtotal', de:'Zwischensumme' },
  'liq.irpfWithhold':  { es:'Retenci\u00f3n IRPF', en:'IRPF Withholding', de:'IRPF-Einbehalt' },
  'liq.vatOnSub':      { es:'IVA del Subtotal', en:'VAT on Subtotal', de:'MwSt. auf Zwischensumme' },
  'liq.settlement':    { es:'Liquidaci\u00f3n', en:'Settlement', de:'Abrechnung' },
  'liq.of':            { es:'de', en:'of', de:'von' },
  'liq.property':      { es:'Alojamiento', en:'Property', de:'Unterkunft' },
  'liq.dates':         { es:'Fechas', en:'Dates', de:'Zeitraum' },
  'liq.bookingId':     { es:'ID Reserva', en:'Booking ID', de:'Buchungs-ID' },
  'liq.reference':     { es:'Localizador', en:'Reference', de:'Referenznr.' },
  'liq.building':      { es:'Edificio', en:'Building', de:'Geb\u00e4ude' },
  'liq.totalSettle':   { es:'Total a liquidar', en:'Total Settlement', de:'Abrechnungssumme' },
  'liq.monthlySettle': { es:'Liquidaci\u00f3n mensual', en:'Monthly settlement', de:'Monatsabrechnung' },
  'liq.gtcRetains':    { es:'GTC retiene', en:'GTC retains', de:'GTC beh\u00e4lt' },
  'liq.ownerLabel':    { es:'Propietario', en:'Owner', de:'Eigent\u00fcmer' },
  'liq.consolSummary': { es:'Resumen consolidado', en:'Consolidated Summary', de:'Zusammenfassung' },
  'liq.reservations':  { es:'reservas', en:'reservations', de:'Buchungen' },
  'liq.numReserv':     { es:'N\u00ba Reservas', en:'Reservations', de:'Buchungen' },
  'liq.resSub':        { es:'Subtotal Reservas', en:'Reservations Subtotal', de:'Buchungs-Zwischensumme' },
  'liq.monthFinalSub': { es:'Subtotal Final Mes', en:'Monthly Final Subtotal', de:'Monats-Endsumme' },
  'liq.vat':           { es:'IVA', en:'VAT', de:'MwSt.' },
  'liq.consolLabel':   { es:'Resumen consolidado', en:'Consolidated summary', de:'Zusammenfassung' },
  'liq.ownerSuffix':   { es:' \u2014 Propietario', en:' \u2014 Owner', de:' \u2014 Eigent\u00fcmer' },
  // ——— v2.24.0: Config modal ———
  'cfg.pasarelaStripe': { es:'Pasarela Stripe', en:'Stripe Gateway', de:'Stripe-Zahlungsabwicklung' },
  'cfg.pasarelaDesc':  { es:'Plataformas distintas de Booking', en:'Platforms other than Booking', de:'Plattformen au\u00dfer Booking' },
  // ——— v2.24.0: Messages ———
  'msg.noHeader':      { es:'No se encontr\u00f3 la cabecera ID Reserva.', en:'Header row ID Reserva not found.', de:'Kopfzeile ID Reserva nicht gefunden.' },
  'msg.noGtcAlojs':    { es:''+t('msg.noGtcAlojs')+'', en:'No GTC properties configured.', de:'Keine GTC-Unterk\u00fcnfte konfiguriert.' },
  'msg.noData':        { es:t('msg.noData'), en:'No data loaded.', de:'Keine Daten geladen.' },
  // ——— v2.24.0: CSV export headers ———
  'csv.property':      { es:'Alojamiento', en:'Property', de:'Unterkunft' },
  'csv.reservations':  { es:'Reservas', en:'Reservations', de:'Buchungen' },
  'csv.nights':        { es:'Noches', en:'Nights', de:'N\u00e4chte' },
  'csv.adr':           { es:'ADR (EUR/noche)', en:'ADR (EUR/night)', de:'ADR (EUR/Nacht)' },
  'csv.totalAmount':   { es:'Importe Total', en:'Total Amount', de:'Gesamtbetrag' },
  'csv.settlement':    { es:'Liquidaci\u00f3n', en:'Settlement', de:'Abrechnung' },
  'csv.margin':        { es:'Margen %', en:'Margin %', de:'Marge %' },
  'csv.owner':         { es:'Propietario', en:'Owner', de:'Eigent\u00fcmer' },
  'csv.units':         { es:'Pisos', en:'Units', de:'Einheiten' },
  'csv.amount':        { es:'Importe', en:'Amount', de:'Betrag' },
  'csv.month':         { es:'Mes', en:'Month', de:'Monat' },
  'csv.platform':      { es:'Plataforma', en:'Platform', de:'Plattform' },
  'csv.channelCom':    { es:'Com. Canal', en:'Channel Com.', de:'Kanal-Prov.' },
  'csv.gatewayCom':    { es:'Com. Pasarela', en:'Gateway Com.', de:'Zahlungs-Prov.' },
  'csv.effectivePct':  { es:'Com. Efectiva %', en:'Effective Com. %', de:'Effektive Prov. %' },
  'csv.id':            { es:'ID', en:'ID', de:'ID' },
  'csv.locator':       { es:'Localizador', en:'Reference', de:'Referenznr.' },
  'csv.client':        { es:'Cliente', en:'Client', de:'Kunde' },
  'csv.checkIn':       { es:'Entrada', en:'Check-in', de:'Anreise' },
  'csv.checkOut':      { es:'Salida', en:'Check-out', de:'Abreise' },
  'csv.channelComFull':{ es:'ComCanal', en:'ChannelCom', de:'KanalProv' },
  'csv.gatewayComFull':{ es:'ComPasarela', en:'GatewayCom', de:'ZahlProv' },
  'csv.gtcComFull':    { es:'ComGTC', en:'GTCCom', de:'GTCProv' },
  'csv.cleaningFull':  { es:'Limpieza', en:'Cleaning', de:'Reinigung' },
  'csv.subtotalFull':  { es:'Subtotal', en:'Subtotal', de:'Zwischensumme' },
  'csv.totalLiq':      { es:'TotalLiq', en:'TotalSettle', de:'GesamtAbr' },
  'csv.status':        { es:'Estado', en:'Status', de:'Status' },
  'csv.validated':     { es:'Validada', en:'Validated', de:'Validiert' },
  'csv.pending':       { es:'Pendiente', en:'Pending', de:'Ausstehend' },

};

function t(key, ...args) {
  const entry = I18N[key];
  if (!entry) return key;
  let text = entry[_currentLang] || entry['es'] || key;
  // Simple %s replacement
  args.forEach(a => { text = text.replace('%s', a); });
  return text;
}
window.t = t; // Explicit global binding
console.log('[i18n] v2.24.0 loaded:', Object.keys(I18N).length, 'keys, lang=' + _currentLang);
function setLanguage(lang) {
  if (!['es','en','de'].includes(lang)) return;
  _currentLang = lang;
  SafeStorage.set('liq-lang', lang);
  document.documentElement.lang = lang;
  document.title = t('app.doctitle');
  // Brief visual feedback
  var _main = document.querySelector('.main-content');
  if (_main) { _main.style.opacity = '0.6'; _main.style.transition = 'opacity 0.15s'; }
  // Update all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
      el.placeholder = t(key);
    } else {
      el.innerHTML = t(key);
    }
  });
  document.querySelectorAll('[data-i18n-title]').forEach(el => {
    el.title = t(el.getAttribute('data-i18n-title'));
  });
  // Update dynamic arrays
  _updateI18nArrays();
  // Re-render active screens
  _i18nRefreshUI();
  // Re-render AI guide in new language
  if (typeof _renderAIGuide === 'function') _renderAIGuide();
  // Update language selector highlight
  document.querySelectorAll('.lang-option').forEach(el => {
    el.classList.toggle('active', el.dataset.lang === lang);
  });
  // Restore visual
  if (_main) requestAnimationFrame(function(){ requestAnimationFrame(function(){ _main.style.opacity = '1'; }); });
}
window.setLanguage = setLanguage; // Explicit global binding for onclick handlers

function _updateI18nArrays() {
  // Update MONTH_NAMES and MONTH_FULL
  for (let i = 0; i < 12; i++) {
    MONTH_NAMES[i] = t('month.short.' + i);
    MONTH_FULL[i] = t('month.full.' + i);
  }
  // Update COLUMNS labels
  COLUMNS.forEach(c => {
    const k = 'col.' + c.key;
    if (I18N[k]) c.label = t(k);
  });
  // Update simpleComboOptions
  simpleComboOptions.status = [
    { value:'all', label: t('status.all') },
    { value:'pending', label: t('status.pendingPl') },
    { value:'validated', label: t('status.validatedPl') }
  ];
  simpleComboOptions.sort = [
    { value:'idx', label: t('sort.original') },
    { value:'estado', label: t('sort.status') },
    { value:'idReserva', label: t('sort.idReserva') },
    { value:'localizador', label: t('sort.localizador') },
    { value:'fechaAlta', label: t('sort.fechaAlta') },
    { value:'cliente', label: t('sort.cliente') },
    { value:'alojamiento', label: t('sort.alojamiento') },
    { value:'edificio', label: t('sort.edificio') },
    { value:'plataforma', label: t('sort.plataforma') },
    { value:'atendidoPor', label: t('sort.atendidoPor') },
    { value:'origenMarketing', label: t('sort.origenMkt') },
    { value:'tipoReserva', label: t('sort.tipoReserva') },
    { value:'fechaEntrada', label: t('sort.fechaEntrada') },
    { value:'fechaSalida', label: t('sort.fechaSalida') },
    { value:'noches', label: t('sort.nights') },
    { value:'totalReserva', label: t('sort.totalReserva') },
    { value:'baseSinIVA', label: t('sort.baseNoVAT') },
    { value:'subtotal', label: t('sort.subtotal') },
    { value:'totalLiquidar', label: t('sort.totalToSettle') },
    { value:'observacion', label: t('sort.observation') }
  ];
  simpleComboOptions.sortdir = [
    { value:'asc', label: t('sort.ascending') },
    { value:'desc', label: t('sort.descending') }
  ];
  simpleComboOptions.consolsort = [
    { value:'name', label: t('sort.nameAZ') },
    { value:'name-desc', label: t('sort.nameZA') },
    { value:'reservas-desc', label: t('sort.moreReservations') },
    { value:'reservas-asc', label: t('sort.lessReservations') },
    { value:'liq-desc', label: t('sort.higherSettlement') },
    { value:'liq-asc', label: t('sort.lowerSettlement') },
    { value:'total-desc', label: t('sort.higherBilling') },
    { value:'total-asc', label: t('sort.lowerBilling') }
  ];
  // Reset combo labels
  simpleComboState.status.label = t('status.all');
  simpleComboState.sort.label = t('sort.original');
  simpleComboState.consolsort.label = t('sort.nameAZ');
  // Update combo filter labels
  if (typeof comboLabels !== 'undefined') {
    comboLabels.platform = t('filter.allPlatforms');
    comboLabels.aloj = t('filter.allProperties');
  }
}

function _i18nRefreshUI() {
  // Refresh currently visible screen
  const screens = ['upload','list','consol','detail','consoldetail'];
  const active = screens.find(s => {
    const el = document.getElementById('screen-' + s);
    return el && el.classList.contains('active');
  });
  if (active === 'list' && allReservas.length > 0) {
    renderTable();
  } else if (active === 'consol' && allReservas.length > 0) {
    renderConsolGrid();
  } else if (active === 'detail' && typeof currentDetailIdx !== 'undefined' && currentDetailIdx !== null) {
    viewDetail(currentDetailIdx);
  } else if (active === 'consoldetail' && currentConsolAloj) {
    viewConsolDetail(currentConsolAloj);
  }
  // Update filter placeholders
  const pi = document.querySelector('#combo-platform .combo-input');
  if (pi && !pi.value) pi.placeholder = t('filter.allPlatforms');
  const ai = document.querySelector('#combo-aloj .combo-input');
  if (ai && !ai.value) ai.placeholder = t('filter.allProperties');
  const si = document.querySelector('#combo-status .combo-input');
  if (si && !si.value) si.placeholder = t('filter.allStatuses');
}



// ——— AI Guide i18n data (v2.22.0) ———
var _GUIDE_I18N = {
es: {
  title: 'Gu\u00eda completa del Asistente IA',
  subtitle: 'Todo lo que puedes hacer con el asistente, explicado con ejemplos reales.',
  closeBtn: 'Cerrar gu\u00eda \u00d7',
  tipLabel: 'Consejo',
  examplesLabel: 'Ejemplos de preguntas',
  sections: [
    { icon:'\ud83d\ude80', title:'Primeros pasos',
      text:'El asistente analiza <strong>todas las reservas cargadas</strong> en la aplicaci\u00f3n. Antes de usarlo, aseg\u00farate de:',
      list:['Cargar tus reservas desde <strong>Google Sheets</strong> o un <strong>archivo Excel</strong>',
            'Haz clic en el bot\u00f3n <strong>\ud83e\udd16</strong> flotante abajo a la derecha',
            'Escribe tu pregunta o usa los <strong>chips r\u00e1pidos</strong> (botones de colores)'],
      tip:'La primera vez se te pedir\u00e1 una API Key de Anthropic. Se guarda localmente en tu navegador.' },
    { icon:'\ud83d\udcca', title:'KPIs y M\u00e9tricas',
      text:'El asistente calcula autom\u00e1ticamente estos indicadores clave de rendimiento:',
      table:{headers:['KPI','Qu\u00e9 mide'],
        rows:[['<strong>ADR</strong>','Tarifa media diaria (importe / noches)'],
              ['<strong>Estancia media</strong>','Noches por reserva promedio'],
              ['<strong>Comisi\u00f3n efectiva</strong>','% que se llevan canal+GTC+pasarela'],
              ['<strong>Margen propietario</strong>','% que llega al propietario'],
              ['<strong>Ingreso/piso</strong>','Facturaci\u00f3n media por alojamiento'],
              ['<strong>Rankings</strong>','Top 5 y Bottom 5 por liquidaci\u00f3n y ADR']]},
      examples:['Dame un resumen ejecutivo con todos los KPIs',
                '\u00bfQu\u00e9 piso tiene el ADR m\u00e1s alto?',
                'Top 10 alojamientos por facturaci\u00f3n',
                '\u00bfCu\u00e1l es la comisi\u00f3n efectiva que pagamos?',
                '\u00bfCu\u00e1nto ingresa de media cada piso al mes?'] },
    { icon:'\ud83c\udfe0', title:'An\u00e1lisis por Alojamiento',
      text:'Consulta m\u00e9tricas de cualquier piso individual o compara entre ellos.',
      examples:['\u00bfC\u00f3mo va el piso MA-2-P3-1C?',
                '\u00bfCu\u00e1ntas noches tiene el apartamento Sunset Beach?',
                'Compara los 5 pisos con m\u00e1s reservas vs los 5 con menos',
                '\u00bfQu\u00e9 pisos tienen menos de 10 reservas?',
                'Ranking de alojamientos por n\u00famero de noches'] },
    { icon:'\ud83d\udcb0', title:'Comisiones y Costes',
      text:'El sistema desglosa 3 tipos de comisi\u00f3n: <strong>canal</strong> (Booking, Airbnb...), <strong>GTC</strong> (gesti\u00f3n) y <strong>pasarela</strong> (Stripe). Tambi\u00e9n incluye limpieza, amenities e IRPF.',
      examples:['Desglose de comisiones por plataforma',
                '\u00bfCu\u00e1nto pagamos a Booking en comisiones?',
                '\u00bfCu\u00e1l es la plataforma m\u00e1s cara en comisiones?',
                '\u00bfCu\u00e1nto se ha retenido de IRPF en total?',
                '\u00bfCu\u00e1nto se gasta en limpieza al mes?',
                '\u00bfQu\u00e9 pisos tienen los mayores costes de amenities?'] },
    { icon:'\ud83d\udc64', title:'Propietarios',
      text:'El asistente conoce qu\u00e9 pisos pertenecen a cada propietario y puede calcular sus m\u00e9tricas.',
      examples:['Resumen por propietario',
                '\u00bfCu\u00e1l es la liquidaci\u00f3n de [nombre]?',
                '\u00bfQu\u00e9 propietario tiene m\u00e1s reservas?',
                '\u00bfCu\u00e1nto se liquida a [nombre] este mes?',
                'Tabla con todos los propietarios y sus pisos'] },
    { icon:'\ud83d\udc65', title:'Comparar Propietarios',
      text:'Compara el rendimiento de distintos propietarios con m\u00e9tricas detalladas por piso.',
      examples:['Compara propietarios con ADR y margen',
                '\u00bfQu\u00e9 propietario tiene mejor margen?',
                'Top 3 propietarios por facturaci\u00f3n',
                'Tabla comparativa de todos los propietarios'] },
    { icon:'\ud83d\udcc8', title:'Comparativa Interanual (YoY)',
      text:'Si tienes datos de <strong>2 o m\u00e1s a\u00f1os</strong>, el asistente genera comparativas autom\u00e1ticas con variaciones porcentuales.',
      examples:['Comparativa 2024 vs 2025','\u00bfHan subido las reservas respecto al a\u00f1o pasado?',
                'Evoluci\u00f3n del ADR por a\u00f1o','\u00bfQu\u00e9 plataforma ha crecido m\u00e1s?',
                '\u00bfQu\u00e9 pisos han mejorado su facturaci\u00f3n este a\u00f1o?'] },
    { icon:'\u2600\ufe0f', title:'Estacionalidad',
      text:'Analiza el rendimiento por <strong>trimestre</strong> y <strong>plataforma</strong>. Identifica temporadas alta y baja.',
      examples:['\u00bfCu\u00e1l es el trimestre m\u00e1s rentable?','Estacionalidad por plataforma',
                '\u00bfQu\u00e9 meses tienen m\u00e1s reservas?','Comparar temporada alta vs baja',
                'Tabla de ingresos por trimestre y plataforma'] },
    { icon:'\ud83d\udd2e', title:'Predicci\u00f3n y Proyecci\u00f3n',
      text:'Con <strong>12+ meses</strong> de datos, genera una proyecci\u00f3n mes a mes para los pr\u00f3ximos 12 meses.',
      examples:['Predicci\u00f3n de ocupaci\u00f3n futura','\u00bfCu\u00e1nto facturaremos el pr\u00f3ximo trimestre?',
                'Proyecci\u00f3n de ingresos a 6 meses','\u00bfQu\u00e9 pisos tendr\u00e1n m\u00e1s demanda?'] },
    { icon:'\ud83d\udce5', title:'Exportar a Excel',
      text:'Descarga los datos en formato <strong>CSV compatible con Excel</strong>. Al preguntar sobre exportaci\u00f3n aparece un bot\u00f3n de descarga.',
      examples:['Exportar datos a Excel','Descargar CSV con todas las reservas',
                'Quiero un Excel con el desglose por propietario','Exportar heatmap a CSV'] },
    { icon:'\ud83d\udc68\u200d\ud83d\udcbc', title:'Agentes y Marketing',
      text:'Analiza el rendimiento de los agentes que gestionan reservas y los or\u00edgenes de marketing.',
      examples:['\u00bfQu\u00e9 agente gestiona m\u00e1s reservas?','Rendimiento por origen de marketing',
                'Comparar agentes por facturaci\u00f3n','\u00bfQu\u00e9 canal de marketing genera m\u00e1s ingresos?'] },
    { icon:'\ud83d\udccb', title:'Reservas Individuales',
      text:'Puedes buscar reservas espec\u00edficas. El asistente muestra las reservas actualmente filtradas.',
      examples:['\u00bfCu\u00e1l es la reserva m\u00e1s cara?','Busca reservas de [cliente]',
                '\u00bfHay reservas de m\u00e1s de 14 noches?','\u00bfCu\u00e1l fue la \u00faltima reserva?'] },
    { icon:'\u2699\ufe0f', title:'Acuerdos Especiales',
      text:'El asistente conoce los pisos con <strong>m\u00ednimo garantizado 80/20</strong> y puede analizar su rendimiento espec\u00edfico.',
      examples:['\u00bfQu\u00e9 pisos tienen acuerdo 80/20?','Rendimiento de pisos con m\u00ednimo garantizado',
                '\u00bfEs rentable el acuerdo 80/20?','Comparar pisos 80/20 vs pisos est\u00e1ndar'] },
    { icon:'\ud83d\udee0\ufe0f', title:'Mantenimiento',
      text:'Consulta las cuotas de mantenimiento mensual configuradas por alojamiento.',
      examples:['\u00bfQu\u00e9 pisos tienen cuota de mantenimiento?','Total de mantenimiento mensual',
                '\u00bfCu\u00e1nto se deduce por mantenimiento?'] },
    { icon:'\u2705', title:'Estado de Validaci\u00f3n',
      text:'Consulta cu\u00e1ntas reservas est\u00e1n validadas o pendientes.',
      examples:['\u00bfCu\u00e1ntas reservas faltan por validar?','Estado de validaci\u00f3n por alojamiento',
                '\u00bfQu\u00e9 pisos tienen todas las reservas validadas?'] },
    { icon:'\ud83d\udd0d', title:'Alertas Autom\u00e1ticas',
      text:'Al abrir el asistente por primera vez tras cargar datos, <strong>detecta autom\u00e1ticamente</strong> anomal\u00edas.',
      bullets:['Pisos con ADR bajo (< 50\u20ac/noche)','Pisos sin reservas en el periodo',
               'Alto porcentaje de reservas pendientes de validar','Pisos con margen muy bajo (< 30%)',
               'Posibles reservas duplicadas'] },
    { icon:'\ud83d\udd04', title:'Duplicados y Anomal\u00edas',
      text:'Detecta <strong>reservas duplicadas</strong> (mismo cliente + alojamiento + fechas) y anomal\u00edas de importe.',
      examples:['\u00bfHay reservas duplicadas?','Muestra anomal\u00edas de importe',
                'Busca reservas sospechosas','\u00bfHay reservas con importe 0?',
                '\u00bfAlg\u00fan cliente ha reservado dos veces las mismas fechas?'] },
    { icon:'\ud83d\udcca', title:'Segmentaci\u00f3n de Clientes',
      text:'Clasifica las reservas en 3 tipos de estancia:',
      bullets:['<strong>Escapada</strong>: 1-3 noches','<strong>Vacaciones</strong>: 4-13 noches',
               '<strong>Larga estancia</strong>: 14+ noches'],
      examples:['Segmentaci\u00f3n por tipo de estancia','\u00bfQu\u00e9 tipo de estancia genera m\u00e1s ingresos?'] },
    { icon:'\ud83d\uddfa\ufe0f', title:'Heatmap de Ocupaci\u00f3n',
      text:'Genera un <strong>mapa de calor visual</strong> con bloques Unicode mostrando la ocupaci\u00f3n por alojamiento y mes.',
      examples:['Mapa de calor de ocupaci\u00f3n','Heatmap por alojamiento y mes',
                '\u00bfQu\u00e9 meses est\u00e1n m\u00e1s llenos?','Sparklines de ocupaci\u00f3n por piso',
                '\u00bfQu\u00e9 pisos tienen la mayor estacionalidad?'] },
    { icon:'\u23f1\ufe0f', title:'Lead Time (Antelaci\u00f3n)',
      text:'Analiza <strong>cu\u00e1ntos d\u00edas antes del check-in</strong> se hacen las reservas, por plataforma.',
      examples:['Lead time por plataforma','\u00bfCon cu\u00e1nta antelaci\u00f3n reservan en Booking?',
                '\u00bfQu\u00e9 plataforma tiene reservas m\u00e1s de \u00faltima hora?',
                'Distribuci\u00f3n de antelaci\u00f3n de reservas',
                'Lead time por tipo de estancia'] },
    { icon:'\ud83d\udd2e', title:'Simulador What-If',
      text:'Simula escenarios hipot\u00e9ticos para ver el impacto financiero <strong>antes de tomar decisiones</strong>.',
      examples:['\u00bfQu\u00e9 pasa si subimos el ADR un 10%?','Simular reducci\u00f3n de comisi\u00f3n al 12%',
                '\u00bfQu\u00e9 pasa si a\u00f1adimos 5 pisos nuevos?','Impacto de subir limpieza 10\u20ac',
                'Simular quitar la pasarela de pago','\u00bfQu\u00e9 pasa si perdemos Booking?'] },
    { icon:'\u26a1', title:'Briefing R\u00e1pido',
      text:'Un <strong>resumen ejecutivo ultracondensado</strong> en 3-5 frases con lo m\u00e1s importante.',
      examples:['Briefing r\u00e1pido','Dame lo m\u00e1s importante en 5 frases',
                'Resumen ejecutivo flash','\u00bfQu\u00e9 debo saber hoy?',
                'Estado general del negocio'] },
    { icon:'\ud83e\udde0', title:'Memoria de Conversaci\u00f3n',
      text:'El asistente <strong>recuerda las entidades</strong> (pisos, propietarios, plataformas) mencionadas en la conversaci\u00f3n para dar respuestas m\u00e1s contextuales.',
      bullets:['Menciona un piso y las siguientes preguntas lo tendr\u00e1n en cuenta',
               'Puedes encadenar preguntas: \u00abCompara piso A vs B\u00bb \u2192 \u00ab\u00bfY en noches?\u00bb',
               'El historial se compacta autom\u00e1ticamente para optimizar tokens',
               'Cada 10+ mensajes se resume la conversaci\u00f3n anterior'] },
    { icon:'\ud83d\udcac', title:'Sugerencias Contextuales',
      text:'Despu\u00e9s de cada respuesta, el asistente muestra <strong>2-3 botones de seguimiento</strong> con preguntas relacionadas para profundizar en el an\u00e1lisis.' },
    { icon:'\u26a1', title:'Trucos Avanzados',
      bullets:['Usa <strong>filtros de fecha</strong> antes de preguntar para limitar el periodo',
               'Puedes <strong>combinar peticiones</strong>: \u00abADR por piso y plataforma\u00bb',
               'Pide <strong>tablas comparativas</strong>: \u00abTabla de propietarios con ADR y margen\u00bb',
               'Usa <strong>superlativos</strong>: \u00abEl mejor\u00bb, \u00abEl peor\u00bb, \u00abTop 5\u00bb',
               'Pide <strong>exportar</strong> cualquier an\u00e1lisis a CSV/Excel',
               'El asistente <strong>responde en el idioma</strong> en que le preguntes',
               'Puedes pedir <strong>gr\u00e1ficos ASCII</strong> y tablas formateadas',
               'Pregunta \u00ab\u00bfQu\u00e9 m\u00e1s puedes hacer?\u00bb si necesitas ideas',
               'Los datos del asistente se basan <strong>solo en tus reservas reales</strong>',
               'Puedes cambiar la API Key en cualquier momento desde el panel',
               'Los chips de colores <strong>desaparecen tras el primer uso</strong> para no molestar'] },
    { icon:'\u2139\ufe0f', title:'Informaci\u00f3n T\u00e9cnica',
      bullets:['Modelo: <strong>Claude 3.5 Sonnet</strong> (Anthropic)','La API Key se guarda en <strong>localStorage</strong> (nunca se env\u00eda a nuestros servidores)',
               'Los datos se env\u00edan directamente a la API de Anthropic con cada pregunta',
               '<strong>24 categor\u00edas</strong> de clasificaci\u00f3n inteligente para optimizar contexto',
               '<strong>Memoria de entidades</strong>: recuerda pisos, propietarios y plataformas mencionados',
               '<strong>Sugerencias contextuales</strong>: 2-3 follow-ups tras cada respuesta',
               'El historial se <strong>compacta autom\u00e1ticamente</strong> tras 10+ mensajes',
               'Los contextos se <strong>cachean 30 segundos</strong> para queries similares',
               'Versi\u00f3n actual: <strong>' + APP_VERSION + '</strong>'] }
  ]
},
en: {
  title: 'Complete AI Assistant Guide',
  subtitle: 'Everything you can do with the assistant, explained with real examples.',
  closeBtn: 'Close guide \u00d7',
  tipLabel: 'Tip',
  examplesLabel: 'Example questions',
  sections: [
    { icon:'\ud83d\ude80', title:'Getting Started',
      text:'The assistant analyzes <strong>all loaded reservations</strong> in the application. Before using it, make sure to:',
      list:['Load your reservations from <strong>Google Sheets</strong> or an <strong>Excel file</strong>',
            'Click the <strong>\ud83e\udd16</strong> floating button at the bottom right',
            'Type your question or use the <strong>quick chips</strong> (colored buttons)'],
      tip:'The first time you will be asked for an Anthropic API Key. It is stored locally in your browser.' },
    { icon:'\ud83d\udcca', title:'KPIs & Metrics',
      text:'The assistant automatically calculates these key performance indicators:',
      table:{headers:['KPI','What it measures'],
        rows:[['<strong>ADR</strong>','Average daily rate (revenue / nights)'],
              ['<strong>Average stay</strong>','Nights per reservation average'],
              ['<strong>Effective commission</strong>','% taken by channel+GTC+gateway'],
              ['<strong>Owner margin</strong>','% that reaches the owner'],
              ['<strong>Revenue/property</strong>','Average billing per property'],
              ['<strong>Rankings</strong>','Top 5 and Bottom 5 by settlement and ADR']]},
      examples:['Give me an executive summary with all KPIs',
                'Which property has the highest ADR?',
                'Top 10 properties by billing',
                'What is the effective commission we pay?',
                'How much does each property earn on average per month?'] },
    { icon:'\ud83c\udfe0', title:'Property Analysis',
      text:'Check metrics for any individual property or compare between them.',
      examples:['How is property MA-2-P3-1C doing?',
                'How many nights does the Sunset Beach apartment have?',
                'Compare the 5 properties with most reservations vs the 5 with fewest',
                'Which properties have fewer than 10 reservations?',
                'Property ranking by number of nights'] },
    { icon:'\ud83d\udcb0', title:'Commissions & Costs',
      text:'The system breaks down 3 types of commission: <strong>channel</strong> (Booking, Airbnb...), <strong>GTC</strong> (management) and <strong>gateway</strong> (Stripe). Also includes cleaning, amenities and IRPF tax.',
      examples:['Commission breakdown by platform',
                'How much do we pay Booking in commissions?',
                'Which platform is the most expensive in commissions?',
                'How much IRPF has been withheld in total?',
                'How much is spent on cleaning per month?',
                'Which properties have the highest amenities costs?'] },
    { icon:'\ud83d\udc64', title:'Owners',
      text:'The assistant knows which properties belong to each owner and can calculate their metrics.',
      examples:['Summary by owner','What is the settlement for [name]?',
                'Which owner has the most reservations?','How much is settled to [name] this month?',
                'Table with all owners and their properties'] },
    { icon:'\ud83d\udc65', title:'Compare Owners',
      text:'Compare the performance of different owners with detailed per-property metrics.',
      examples:['Compare owners with ADR and margin','Which owner has the best margin?',
                'Top 3 owners by billing','Comparative table of all owners'] },
    { icon:'\ud83d\udcc8', title:'Year-over-Year (YoY)',
      text:'If you have data from <strong>2 or more years</strong>, the assistant generates automatic comparisons with percentage variations.',
      examples:['2024 vs 2025 comparison','Have reservations increased compared to last year?',
                'ADR evolution by year','Which platform has grown the most?',
                'Which properties have improved their billing this year?'] },
    { icon:'\u2600\ufe0f', title:'Seasonality',
      text:'Analyze performance by <strong>quarter</strong> and <strong>platform</strong>. Identify high and low seasons.',
      examples:['Which is the most profitable quarter?','Seasonality by platform',
                'Which months have the most reservations?','Compare high vs low season',
                'Revenue table by quarter and platform'] },
    { icon:'\ud83d\udd2e', title:'Prediction & Projection',
      text:'With <strong>12+ months</strong> of data, generates a month-by-month projection for the next 12 months.',
      examples:['Future occupancy prediction','How much will we bill next quarter?',
                '6-month revenue projection','Which properties will have the most demand?'] },
    { icon:'\ud83d\udce5', title:'Export to Excel',
      text:'Download data in <strong>CSV format compatible with Excel</strong>. When asking about export, a download button appears.',
      examples:['Export data to Excel','Download CSV with all reservations',
                'I want an Excel with the owner breakdown','Export heatmap to CSV'] },
    { icon:'\ud83d\udc68\u200d\ud83d\udcbc', title:'Agents & Marketing',
      text:'Analyze the performance of agents managing reservations and marketing sources.',
      examples:['Which agent manages the most reservations?','Performance by marketing source',
                'Compare agents by billing','Which marketing channel generates the most revenue?'] },
    { icon:'\ud83d\udccb', title:'Individual Reservations',
      text:'You can search for specific reservations. The assistant shows the currently filtered reservations.',
      examples:['What is the most expensive reservation?','Find reservations by [client]',
                'Are there reservations longer than 14 nights?','What was the last reservation?'] },
    { icon:'\u2699\ufe0f', title:'Special Agreements',
      text:'The assistant knows the properties with <strong>80/20 guaranteed minimum</strong> and can analyze their specific performance.',
      examples:['Which properties have the 80/20 agreement?','Performance of guaranteed minimum properties',
                'Is the 80/20 agreement profitable?','Compare 80/20 vs standard properties'] },
    { icon:'\ud83d\udee0\ufe0f', title:'Maintenance',
      text:'Check the monthly maintenance fees configured per property.',
      examples:['Which properties have maintenance fees?','Total monthly maintenance',
                'How much is deducted for maintenance?'] },
    { icon:'\u2705', title:'Validation Status',
      text:'Check how many reservations are validated or pending.',
      examples:['How many reservations are pending validation?','Validation status by property',
                'Which properties have all reservations validated?'] },
    { icon:'\ud83d\udd0d', title:'Automatic Alerts',
      text:'When opening the assistant for the first time after loading data, it <strong>automatically detects</strong> anomalies.',
      bullets:['Properties with low ADR (< 50\u20ac/night)','Properties with no reservations in the period',
               'High percentage of pending validation','Properties with very low margin (< 30%)',
               'Possible duplicate reservations'] },
    { icon:'\ud83d\udd04', title:'Duplicates & Anomalies',
      text:'Detects <strong>duplicate reservations</strong> (same client + property + dates) and amount anomalies.',
      examples:['Are there duplicate reservations?','Show amount anomalies',
                'Search for suspicious reservations','Are there reservations with amount 0?',
                'Has any client booked the same dates twice?'] },
    { icon:'\ud83d\udcca', title:'Client Segmentation',
      text:'Classifies reservations into 3 stay types:',
      bullets:['<strong>Getaway</strong>: 1-3 nights','<strong>Vacation</strong>: 4-13 nights',
               '<strong>Long stay</strong>: 14+ nights'],
      examples:['Segmentation by stay type','Which stay type generates the most revenue?'] },
    { icon:'\ud83d\uddfa\ufe0f', title:'Occupancy Heatmap',
      text:'Generates a <strong>visual heatmap</strong> with Unicode blocks showing occupancy by property and month.',
      examples:['Occupancy heatmap','Heatmap by property and month',
                'Which months are fullest?','Occupancy sparklines by property',
                'Which properties have the most seasonality?'] },
    { icon:'\u23f1\ufe0f', title:'Lead Time (Booking Advance)',
      text:'Analyzes <strong>how many days before check-in</strong> reservations are made, by platform.',
      examples:['Lead time by platform','How far in advance do they book on Booking?',
                'Which platform has the most last-minute bookings?',
                'Booking advance distribution',
                'Lead time by stay type'] },
    { icon:'\ud83d\udd2e', title:'What-If Simulator',
      text:'Simulate hypothetical scenarios to see the financial impact <strong>before making decisions</strong>.',
      examples:['What if we raise ADR by 10%?','Simulate reducing commission to 12%',
                'What if we add 5 new properties?','Impact of raising cleaning by 10\u20ac',
                'Simulate removing the payment gateway','What if we lose Booking?'] },
    { icon:'\u26a1', title:'Quick Briefing',
      text:'An <strong>ultra-condensed executive summary</strong> in 3-5 sentences with the most important information.',
      examples:['Quick briefing','Give me the most important in 5 sentences',
                'Flash executive summary','What should I know today?',
                'General business status'] },
    { icon:'\ud83e\udde0', title:'Conversation Memory',
      text:'The assistant <strong>remembers entities</strong> (properties, owners, platforms) mentioned in conversation for more contextual responses.',
      bullets:['Mention a property and subsequent questions will take it into account',
               'You can chain questions: \u00abCompare property A vs B\u00bb \u2192 \u00abAnd in nights?\u00bb',
               'History is automatically compacted to optimize tokens',
               'Every 10+ messages the previous conversation is summarized'] },
    { icon:'\ud83d\udcac', title:'Contextual Suggestions',
      text:'After each response, the assistant shows <strong>2-3 follow-up buttons</strong> with related questions to deepen the analysis.' },
    { icon:'\u26a1', title:'Advanced Tips',
      bullets:['Use <strong>date filters</strong> before asking to limit the period',
               'You can <strong>combine requests</strong>: \u00abADR by property and platform\u00bb',
               'Ask for <strong>comparative tables</strong>: \u00abOwner table with ADR and margin\u00bb',
               'Use <strong>superlatives</strong>: \u00abThe best\u00bb, \u00abThe worst\u00bb, \u00abTop 5\u00bb',
               'Ask to <strong>export</strong> any analysis to CSV/Excel',
               'The assistant <strong>responds in the language</strong> you ask in',
               'You can request <strong>ASCII charts</strong> and formatted tables',
               'Ask \u00abWhat else can you do?\u00bb if you need ideas',
               'Assistant data is based <strong>only on your real reservations</strong>',
               'You can change the API Key at any time from the panel',
               'Color chips <strong>disappear after first use</strong> to stay out of the way'] },
    { icon:'\u2139\ufe0f', title:'Technical Information',
      bullets:['Model: <strong>Claude 3.5 Sonnet</strong> (Anthropic)','The API Key is stored in <strong>localStorage</strong> (never sent to our servers)',
               'Data is sent directly to the Anthropic API with each question',
               '<strong>24 categories</strong> of intelligent classification to optimize context',
               '<strong>Entity memory</strong>: remembers properties, owners and platforms mentioned',
               '<strong>Contextual suggestions</strong>: 2-3 follow-ups after each response',
               'History is <strong>automatically compacted</strong> after 10+ messages',
               'Contexts are <strong>cached 30 seconds</strong> for similar queries',
               'Current version: <strong>' + APP_VERSION + '</strong>'] }
  ]
},
de: {
  title: 'Vollst\u00e4ndige KI-Assistenten-Anleitung',
  subtitle: 'Alles, was Sie mit dem Assistenten tun k\u00f6nnen, mit echten Beispielen erkl\u00e4rt.',
  closeBtn: 'Anleitung schlie\u00dfen \u00d7',
  tipLabel: 'Tipp',
  examplesLabel: 'Beispielfragen',
  sections: [
    { icon:'\ud83d\ude80', title:'Erste Schritte',
      text:'Der Assistent analysiert <strong>alle geladenen Buchungen</strong> in der Anwendung. Stellen Sie vorher sicher:',
      list:['Laden Sie Ihre Buchungen von <strong>Google Sheets</strong> oder einer <strong>Excel-Datei</strong>',
            'Klicken Sie auf den <strong>\ud83e\udd16</strong> schwebenden Button unten rechts',
            'Geben Sie Ihre Frage ein oder nutzen Sie die <strong>Schnell-Chips</strong> (farbige Buttons)'],
      tip:'Beim ersten Mal wird ein Anthropic API-Schl\u00fcssel ben\u00f6tigt. Er wird lokal in Ihrem Browser gespeichert.' },
    { icon:'\ud83d\udcca', title:'KPIs & Kennzahlen',
      text:'Der Assistent berechnet automatisch diese Leistungskennzahlen:',
      table:{headers:['KPI','Was es misst'],
        rows:[['<strong>ADR</strong>','Durchschnittlicher Tagespreis (Umsatz / N\u00e4chte)'],
              ['<strong>Durchschn. Aufenthalt</strong>','N\u00e4chte pro Buchung im Durchschnitt'],
              ['<strong>Effektive Provision</strong>','% f\u00fcr Kanal+GTC+Gateway'],
              ['<strong>Eigent\u00fcmermarge</strong>','% das beim Eigent\u00fcmer ankommt'],
              ['<strong>Umsatz/Unterkunft</strong>','Durchschn. Abrechnung pro Unterkunft'],
              ['<strong>Rankings</strong>','Top 5 und Bottom 5 nach Abrechnung und ADR']]},
      examples:['Gib mir eine Zusammenfassung mit allen KPIs',
                'Welche Unterkunft hat den h\u00f6chsten ADR?',
                'Top 10 Unterk\u00fcnfte nach Umsatz',
                'Wie hoch ist die effektive Provision?',
                'Wie viel verdient jede Unterkunft durchschnittlich pro Monat?'] },
    { icon:'\ud83c\udfe0', title:'Unterkunftsanalyse',
      text:'Pr\u00fcfen Sie Kennzahlen einzelner Unterk\u00fcnfte oder vergleichen Sie sie.',
      examples:['Wie l\u00e4uft Unterkunft MA-2-P3-1C?',
                'Wie viele N\u00e4chte hat das Apartment Sunset Beach?',
                'Vergleiche die 5 Unterk\u00fcnfte mit den meisten vs wenigsten Buchungen',
                'Welche Unterk\u00fcnfte haben weniger als 10 Buchungen?',
                'Ranking der Unterk\u00fcnfte nach N\u00e4chteanzahl'] },
    { icon:'\ud83d\udcb0', title:'Provisionen & Kosten',
      text:'Das System schl\u00fcsselt 3 Provisionsarten auf: <strong>Kanal</strong> (Booking, Airbnb...), <strong>GTC</strong> (Verwaltung) und <strong>Gateway</strong> (Stripe). Inklusive Reinigung, Amenities und IRPF.',
      examples:['Provisionsaufschl\u00fcsselung nach Plattform',
                'Wie viel zahlen wir an Booking?',
                'Welche Plattform ist am teuersten?',
                'Wie viel IRPF wurde insgesamt einbehalten?',
                'Wie viel wird monatlich f\u00fcr Reinigung ausgegeben?',
                'Welche Unterk\u00fcnfte haben die h\u00f6chsten Amenity-Kosten?'] },
    { icon:'\ud83d\udc64', title:'Eigent\u00fcmer',
      text:'Der Assistent kennt die Zuordnung von Unterk\u00fcnften zu Eigent\u00fcmern.',
      examples:['\u00dcbersicht nach Eigent\u00fcmer','Wie hoch ist die Abrechnung f\u00fcr [Name]?',
                'Welcher Eigent\u00fcmer hat die meisten Buchungen?','Wie viel wird [Name] diesen Monat abgerechnet?',
                'Tabelle aller Eigent\u00fcmer und ihrer Unterk\u00fcnfte'] },
    { icon:'\ud83d\udc65', title:'Eigent\u00fcmer vergleichen',
      text:'Vergleichen Sie die Leistung verschiedener Eigent\u00fcmer mit detaillierten Kennzahlen.',
      examples:['Eigent\u00fcmer mit ADR und Marge vergleichen','Welcher Eigent\u00fcmer hat die beste Marge?',
                'Top 3 Eigent\u00fcmer nach Umsatz','Vergleichstabelle aller Eigent\u00fcmer'] },
    { icon:'\ud83d\udcc8', title:'Jahresvergleich (YoY)',
      text:'Bei Daten aus <strong>2+ Jahren</strong> erstellt der Assistent automatische Vergleiche mit prozentualen Ver\u00e4nderungen.',
      examples:['Vergleich 2024 vs 2025','Sind die Buchungen gegen\u00fcber letztem Jahr gestiegen?',
                'ADR-Entwicklung nach Jahr','Welche Plattform ist am meisten gewachsen?',
                'Welche Unterk\u00fcnfte haben ihren Umsatz verbessert?'] },
    { icon:'\u2600\ufe0f', title:'Saisonalit\u00e4t',
      text:'Analysieren Sie die Leistung nach <strong>Quartal</strong> und <strong>Plattform</strong>. Identifizieren Sie Hoch- und Nebensaison.',
      examples:['Welches Quartal ist am profitabelsten?','Saisonalit\u00e4t nach Plattform',
                'Welche Monate haben die meisten Buchungen?','Hochsaison vs Nebensaison vergleichen',
                'Umsatztabelle nach Quartal und Plattform'] },
    { icon:'\ud83d\udd2e', title:'Prognose & Projektion',
      text:'Mit <strong>12+ Monaten</strong> Daten wird eine monatliche Projektion f\u00fcr die n\u00e4chsten 12 Monate erstellt.',
      examples:['Zuk\u00fcnftige Belegungsprognose','Wie viel werden wir n\u00e4chstes Quartal abrechnen?',
                '6-Monats-Umsatzprognose','Welche Unterk\u00fcnfte werden am meisten nachgefragt?'] },
    { icon:'\ud83d\udce5', title:'Nach Excel exportieren',
      text:'Laden Sie Daten im <strong>CSV-Format f\u00fcr Excel</strong> herunter. Ein Download-Button erscheint bei Export-Anfragen.',
      examples:['Daten nach Excel exportieren','CSV mit allen Buchungen herunterladen',
                'Excel mit Eigent\u00fcmer-Aufschl\u00fcsselung','Heatmap als CSV exportieren'] },
    { icon:'\ud83d\udc68\u200d\ud83d\udcbc', title:'Agenten & Marketing',
      text:'Analysieren Sie die Leistung der Agenten und Marketingquellen.',
      examples:['Welcher Agent verwaltet die meisten Buchungen?','Leistung nach Marketingquelle',
                'Agenten nach Umsatz vergleichen','Welcher Marketingkanal generiert den meisten Umsatz?'] },
    { icon:'\ud83d\udccb', title:'Einzelne Buchungen',
      text:'Sie k\u00f6nnen nach bestimmten Buchungen suchen. Der Assistent zeigt die aktuell gefilterten Buchungen.',
      examples:['Was ist die teuerste Buchung?','Buchungen von [Kunde] finden',
                'Gibt es Buchungen \u00fcber 14 N\u00e4chte?','Was war die letzte Buchung?'] },
    { icon:'\u2699\ufe0f', title:'Sondervereinbarungen',
      text:'Der Assistent kennt Unterk\u00fcnfte mit <strong>80/20 Mindestgarantie</strong> und kann deren Leistung analysieren.',
      examples:['Welche Unterk\u00fcnfte haben die 80/20-Vereinbarung?','Leistung der Mindestgarantie-Unterk\u00fcnfte',
                'Ist die 80/20-Vereinbarung rentabel?','80/20 vs Standard-Unterk\u00fcnfte vergleichen'] },
    { icon:'\ud83d\udee0\ufe0f', title:'Wartung',
      text:'Pr\u00fcfen Sie die monatlichen Wartungsgeb\u00fchren pro Unterkunft.',
      examples:['Welche Unterk\u00fcnfte haben Wartungsgeb\u00fchren?','Monatliche Wartung gesamt',
                'Wie viel wird f\u00fcr Wartung abgezogen?'] },
    { icon:'\u2705', title:'Validierungsstatus',
      text:'Pr\u00fcfen Sie, wie viele Buchungen validiert oder ausstehend sind.',
      examples:['Wie viele Buchungen fehlen zur Validierung?','Validierungsstatus nach Unterkunft',
                'Welche Unterk\u00fcnfte sind vollst\u00e4ndig validiert?'] },
    { icon:'\ud83d\udd0d', title:'Automatische Warnungen',
      text:'Beim ersten \u00d6ffnen nach dem Laden erkennt der Assistent <strong>automatisch</strong> Anomalien.',
      bullets:['Unterk\u00fcnfte mit niedrigem ADR (< 50\u20ac/Nacht)','Unterk\u00fcnfte ohne Buchungen im Zeitraum',
               'Hoher Anteil ausstehender Validierungen','Unterk\u00fcnfte mit sehr niedriger Marge (< 30%)',
               'M\u00f6gliche doppelte Buchungen'] },
    { icon:'\ud83d\udd04', title:'Duplikate & Anomalien',
      text:'Erkennt <strong>doppelte Buchungen</strong> (gleicher Kunde + Unterkunft + Daten) und Betragsanomalien.',
      examples:['Gibt es doppelte Buchungen?','Betragsanomalien anzeigen',
                'Verd\u00e4chtige Buchungen suchen','Gibt es Buchungen mit Betrag 0?',
                'Hat ein Kunde zweimal die gleichen Daten gebucht?'] },
    { icon:'\ud83d\udcca', title:'Kundensegmentierung',
      text:'Klassifiziert Buchungen in 3 Aufenthaltstypen:',
      bullets:['<strong>Kurzurlaub</strong>: 1-3 N\u00e4chte','<strong>Urlaub</strong>: 4-13 N\u00e4chte',
               '<strong>Langzeitaufenthalt</strong>: 14+ N\u00e4chte'],
      examples:['Segmentierung nach Aufenthaltsart','Welcher Aufenthaltstyp generiert den meisten Umsatz?'] },
    { icon:'\ud83d\uddfa\ufe0f', title:'Belegungs-Heatmap',
      text:'Erstellt eine <strong>visuelle Heatmap</strong> mit Unicode-Bl\u00f6cken f\u00fcr die Belegung nach Unterkunft und Monat.',
      examples:['Belegungs-Heatmap','Heatmap nach Unterkunft und Monat',
                'Welche Monate sind am vollsten?','Belegungs-Sparklines pro Unterkunft',
                'Welche Unterk\u00fcnfte haben die st\u00e4rkste Saisonalit\u00e4t?'] },
    { icon:'\u23f1\ufe0f', title:'Vorlaufzeit (Buchungsvorlauf)',
      text:'Analysiert <strong>wie viele Tage vor dem Check-in</strong> gebucht wird, nach Plattform.',
      examples:['Vorlaufzeit nach Plattform','Wie weit im Voraus buchen sie auf Booking?',
                'Welche Plattform hat die meisten Last-Minute-Buchungen?',
                'Verteilung der Buchungsvorlaufzeit',
                'Vorlaufzeit nach Aufenthaltsart'] },
    { icon:'\ud83d\udd2e', title:'Was-w\u00e4re-wenn Simulator',
      text:'Simulieren Sie hypothetische Szenarien, um die finanzielle Auswirkung <strong>vor Entscheidungen</strong> zu sehen.',
      examples:['Was wenn wir den ADR um 10% erh\u00f6hen?','Provisionsreduzierung auf 12% simulieren',
                'Was wenn wir 5 neue Unterk\u00fcnfte hinzuf\u00fcgen?','Auswirkung einer Reinigungserh\u00f6hung um 10\u20ac',
                'Zahlungs-Gateway entfernen simulieren','Was wenn wir Booking verlieren?'] },
    { icon:'\u26a1', title:'Schnell-Briefing',
      text:'Eine <strong>ultrakompakte Zusammenfassung</strong> in 3-5 S\u00e4tzen mit den wichtigsten Informationen.',
      examples:['Schnelles Briefing','Gib mir das Wichtigste in 5 S\u00e4tzen',
                'Flash-Zusammenfassung','Was sollte ich heute wissen?',
                'Allgemeiner Gesch\u00e4ftsstatus'] },
    { icon:'\ud83e\udde0', title:'Gespr\u00e4chsspeicher',
      text:'Der Assistent <strong>merkt sich Entit\u00e4ten</strong> (Unterk\u00fcnfte, Eigent\u00fcmer, Plattformen) f\u00fcr kontextbezogenere Antworten.',
      bullets:['Erw\u00e4hnen Sie eine Unterkunft und Folgefragen ber\u00fccksichtigen sie',
               'Fragen verketten: \u00abVergleiche A vs B\u00bb \u2192 \u00abUnd bei N\u00e4chten?\u00bb',
               'Der Verlauf wird automatisch komprimiert',
               'Alle 10+ Nachrichten wird das Gespr\u00e4ch zusammengefasst'] },
    { icon:'\ud83d\udcac', title:'Kontextbezogene Vorschl\u00e4ge',
      text:'Nach jeder Antwort zeigt der Assistent <strong>2-3 Follow-up-Buttons</strong> mit verwandten Fragen zur Vertiefung der Analyse.' },
    { icon:'\u26a1', title:'Fortgeschrittene Tipps',
      bullets:['Nutzen Sie <strong>Datumsfilter</strong> vor der Frage, um den Zeitraum einzugrenzen',
               'Sie k\u00f6nnen <strong>Anfragen kombinieren</strong>: \u00abADR nach Unterkunft und Plattform\u00bb',
               'Bitten Sie um <strong>Vergleichstabellen</strong>: \u00abEigent\u00fcmertabelle mit ADR und Marge\u00bb',
               'Verwenden Sie <strong>Superlative</strong>: \u00abDas Beste\u00bb, \u00abDas Schlechteste\u00bb, \u00abTop 5\u00bb',
               'Bitten Sie um <strong>Export</strong> jeder Analyse als CSV/Excel',
               'Der Assistent <strong>antwortet in der Sprache</strong>, in der Sie fragen',
               'Sie k\u00f6nnen <strong>ASCII-Diagramme</strong> und formatierte Tabellen anfordern',
               'Fragen Sie \u00abWas kannst du noch?\u00bb wenn Sie Ideen brauchen',
               'Die Daten basieren <strong>nur auf Ihren echten Buchungen</strong>',
               'Sie k\u00f6nnen den API-Schl\u00fcssel jederzeit im Panel \u00e4ndern',
               'Farb-Chips <strong>verschwinden nach der ersten Nutzung</strong>'] },
    { icon:'\u2139\ufe0f', title:'Technische Informationen',
      bullets:['Modell: <strong>Claude 3.5 Sonnet</strong> (Anthropic)','API-Schl\u00fcssel in <strong>localStorage</strong> (nie an unsere Server gesendet)',
               'Daten werden direkt an die Anthropic API gesendet',
               '<strong>24 Kategorien</strong> intelligenter Klassifizierung zur Kontextoptimierung',
               '<strong>Entit\u00e4tsspeicher</strong>: merkt sich erw\u00e4hnte Unterk\u00fcnfte, Eigent\u00fcmer und Plattformen',
               '<strong>Kontextvorschl\u00e4ge</strong>: 2-3 Follow-ups nach jeder Antwort',
               'Verlauf wird <strong>automatisch komprimiert</strong> nach 10+ Nachrichten',
               'Kontexte werden <strong>30 Sekunden gecacht</strong> f\u00fcr \u00e4hnliche Anfragen',
               'Aktuelle Version: <strong>' + APP_VERSION + '</strong>'] }
  ]
}
};

/**
 * @description Renders AI guide content in current language.
 * Called on load and on language change.
 */
function _renderAIGuide() {
  var el = document.getElementById('ai-guide-body');
  if (!el || typeof _GUIDE_I18N === 'undefined') return;
  var L = _currentLang || 'es';
  var g = _GUIDE_I18N[L] || _GUIDE_I18N.es;
  el.innerHTML =
    '<div class="ai-help-header">' +
      '<h2>&#x1F4D6; ' + g.title + '</h2>' +
      '<p>' + g.subtitle + '</p>' +
      '<button class="ai-help-close" onclick="_toggleAIHelp()">' + g.closeBtn + '</button>' +
    '</div>' +
    g.sections.map(function(s) {
      var h = '<div class="ai-help-section"><h3>' + s.icon + ' ' + s.title + '</h3>';
      if (s.text) h += '<p>' + s.text + '</p>';
      if (s.table) {
        h += '<table class="ai-help-table"><tr>' + s.table.headers.map(function(th){ return '<th>'+th+'</th>'; }).join('') + '</tr>';
        h += s.table.rows.map(function(r){ return '<tr>' + r.map(function(c){ return '<td>'+c+'</td>'; }).join('') + '</tr>'; }).join('');
        h += '</table>';
      }
      if (s.list) {
        h += '<ol>' + s.list.map(function(li){ return '<li>'+li+'</li>'; }).join('') + '</ol>';
      }
      if (s.tip) {
        h += '<div class="ai-help-tip">&#x1F4A1; <strong>' + g.tipLabel + ':</strong> ' + s.tip + '</div>';
      }
      if (s.examples) {
        h += '<div class="ai-help-example"><strong>' + g.examplesLabel + ':</strong><ul>' +
          s.examples.map(function(ex){ return '<li>&laquo;'+ex+'&raquo;</li>'; }).join('') +
        '</ul></div>';
      }
      if (s.bullets) {
        h += '<ul>' + s.bullets.map(function(b){ return '<li>'+b+'</li>'; }).join('') + '</ul>';
      }
      return h + '</div>';
    }).join('');
}


// === UTILITY: Debounce ===
function debounce(fn, ms) {
  let timer = null;
  const debounced = function() {
    const args = arguments;
    const ctx = this;
    if (timer) clearTimeout(timer);
    timer = setTimeout(function() { timer = null; fn.apply(ctx, args); }, ms);
  };
  debounced.cancel = function() { if (timer) { clearTimeout(timer); timer = null; } };
  return debounced;
}

// === UTILITY: Safe property access ===
function safeGet(obj, path, fallback) {
  if (!obj) return fallback;
  const keys = path.split('.');
  let current = obj;
  for (let i = 0; i < keys.length; i++) {
    if (current == null || typeof current !== 'object') return fallback;
    current = current[keys[i]];
  }
  return current !== undefined ? current : fallback;
}

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M03] CONFIG ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Constantes de la aplicaciÃƒÆ’Ã‚Â³n (inmutables)
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === CONFIG: Application Constants ===
const CONFIG = Object.freeze({
  IVA_RESERVA: 0.10,
  IVA_SUBTOTAL: 0.21,
  MAX_SHEET_ROWS: 10000,
  MAX_CONFIG_ROWS: 10000,
  MAX_AI_DETAIL_ROWS: 50,
  MAX_AI_HISTORY: 20,
  DEFAULT_PAGE_SIZE: 100,
  PAGE_SIZES: [100, 500, 1000],
  MAX_PAGINATION_BUTTONS: 7,
  DEBOUNCE_GLOBAL_CONFIG: 1500,
  DEBOUNCE_RESERVA_CONFIG: 1000,
  SYNC_SAVED_TIMEOUT: 2500,
  SYNC_ERROR_TIMEOUT: 5000,
  VERSION_TOAST_TIMEOUT: 12000,
  SHEET_HISTORY_MAX: 10,
  CONFIG_TAB_NAME: 'Configuracion',
  PROPIETARIOS_TAB_NAME: 'Propietarios',
  AI_MODEL: 'claude-sonnet-4-20250514',
  AI_MAX_TOKENS: 1024,
  SYNC_POLL_INTERVAL: 30000,  // 30s polling for multi-user sync
  SYNC_POLL_MIN: 10000,       // minimum 10s
  SYNC_POLL_MAX: 120000,      // maximum 2min
});


const CHANGELOG = [
  {
    version: '2.24.1',
    date: '2026-02-16',
    changes: [
      'Fix: cambio de idioma en pantalla Liquidaci\\u00f3n Alojamiento no re-renderizaba (_lastConsolAloj \\u2192 currentConsolAloj)',
      'UX: feedback visual (fade) al cambiar idioma para confirmar el cambio',
    ]
  },
  {
    version: '2.24.0',
    date: '2026-02-16',
    changes: [
      'i18n audit final: 482 claves \u2014 34 patrones _en? reemplazados por t()',
      'Liquidaci\u00f3n detalle: todos los labels (canal, limpieza, IRPF, IVA, subtotal, etc.) ahora trilingues',
      'CE panels: t\u00edtulos, labels resumen, placeholders traducidos (CE1+CE2+extras)',
      'Email modal: 16 claves (t\u00edtulo, campos, botones, estados, radio langs)',
      'CSV export: 20+ cabeceras de columna traducidas',
      'Config modal: Pasarela Stripe, Mantenimiento labels traducidos',
      'Botones: Descargar PDF, Enviar Email, Validar primero \u2014 sin iconos duplicados',
      'Consol: Propietario label, Lista badge, Venta gesti\u00f3n y operaciones traducidos',
      'Mensajes error: cabecera no encontrada, sin alojamientos GTC, sin datos',
      'PDF errors: traducidos en email-module.js con (window.t||String)',
      'Alemn (DE): revisi\u00f3n completa \u2014 535\u21d2482 claves tras deduplicaci\u00f3n',
      'Limpieza: 55 claves duplicadas eliminadas, variable _en ya no se usa',
    ]
  },
  {
    version: '2.23.0',
    date: '2026-02-16',
    changes: [
      'i18n Phase 2: Panel Asistente IA completo en ES/EN/DE (390 claves total)',
      'Gu\u00EDa del Asistente IA generada din\u00e1micamente por idioma (26 secciones \u00d7 3 idiomas)',
      'Chips r\u00e1pidos, alertas autom\u00e1ticas y follow-up suggestions traducidos',
      'System prompt del IA adapta idioma de respuesta autom\u00e1ticamente',
      'API Key prompt, rate limit y error messages traducidos',
    ]},
  {
    version: '2.22.0',
    date: '2026-02-16',
    changes: [
      'i18n Phase 1: 314 claves (antes 241) \u2014 traducci\u00F3n completa de textos visibles',
      'Traducido: "filtradas", botones validar/desvalidar, combos ordenaci\u00F3n/filtro, cabeceras columnas',
      'Traducido: cards consol (Reservas/Facturaci\u00F3n/A Liquidar), mensajes toast, estados carga',
      'Traducido: etiquetas limpieza, pasarela, IRPF, propietario, alertas, conceptos especiales',
      'Fix: window.t y window.setLanguage expl\u00EDcitos para garantizar disponibilidad global',
    ]
  },
  {
    version: '2.21.0',
    date: '2026-02-15',
    changes: [
      'Sistema de internacionalizaci\u00F3n (i18n): soporte completo para espa\u00F1ol, ingl\u00E9s y alem\u00E1n',
      'Diccionario I18N con 241+ claves de traducci\u00F3n cubriendo toda la interfaz',
      'Selector de idioma en sidebar (ES/EN/DE) con persistencia en localStorage',
      'Funci\u00F3n t(key) para contenido din\u00E1mico JavaScript y atributos data-i18n para HTML est\u00E1tico',
      'setLanguage() actualiza DOM, arrays de meses, columnas, combos y re-renderiza pantalla activa',
      'Traducci\u00F3n completa: navegaci\u00F3n, filtros, estad\u00EDsticas, detalle liquidaci\u00F3n, consolidado, configuraci\u00F3n',
      'Meses traducidos (cortos y largos) para los 3 idiomas',
      'email-module.js: helper _et() para integraci\u00F3n i18n en m\u00F3dulo de email',
      '74 atributos data-i18n en HTML, 296 llamadas t() en JavaScript',
    ]
  },
  {
    version: '2.20.0',
    date: '2026-02-15',
    changes: [
      'Memoria multi-turno: recuerda pisos, propietarios y plataformas entre mensajes del chat',
      'Detecci\u00F3n de duplicados: encuentra reservas id\u00E9nticas y anomal\u00EDas de importe (>3x o <0.25x ADR)',
      'Segmentaci\u00F3n de clientes: escapada (\u22642 noches), vacaciones (3-7), larga estancia (>7) con desglose por plataforma',
      'Heatmap de ocupaci\u00F3n: mapa de calor alojamiento\u00D7mes con sparklines Unicode',
      'Lead time: an\u00E1lisis de antelaci\u00F3n de reserva por plataforma con distribuci\u00F3n en rangos',
      'Simulador what-if: datos base de costes y comisiones para simular escenarios',
      'Briefing r\u00E1pido: resumen ejecutivo en 3-5 frases con sparkline de tendencia',
      'Sugerencias contextuales: 2-3 botones de follow-up tras cada respuesta',
      'Sparklines Unicode (\u2581\u2582\u2583\u2584\u2585\u2586\u2587\u2588) en heatmap y briefing',
      'Alerta de duplicados en panel de anomal\u00EDas proactivas',
      'Clasificador ampliado: 24 categor\u00EDas (6 nuevas: DUPCHECK, SEGMENT, HEATMAP, LEADTIME, BRIEFING, WHATIF)',
      '9 chips actualizados con nuevas capacidades',
      'Gu\u00EDa ampliada: 8 nuevas secciones documentadas con 40+ ejemplos adicionales',
    ]
  },
  {
    version: '2.19.0',
    date: '2026-02-15',
    changes: [
      'Gu\u00EDa completa L\u00E9eme: documentaci\u00F3n exhaustiva del asistente IA integrada en el panel',
      'Bot\u00F3n de ayuda (\u2753) en cabecera del chat para abrir/cerrar la gu\u00EDa',
      '14 secciones documentadas con 60+ ejemplos de preguntas reales',
      'Trucos avanzados: combinaci\u00F3n de queries, uso de filtros, preguntas complejas',
      'Tablas de referencia de KPIs y tipos de exportaci\u00F3n',
      'Informaci\u00F3n t\u00E9cnica: modelo, cache, compactaci\u00F3n, API Key',
    ]
  },
  {
    version: '2.18.0',
    date: '2026-02-15',
    changes: [
      'Alertas proactivas: detecta autom\u00E1ticamente pisos con ADR bajo, sin reservas, con margen < 30% y pendientes altas',
      'Comparaci\u00F3n de propietarios: m\u00E9tricas por piso con ADR, margen, reservas y noches por propietario',
      'Predicci\u00F3n de ocupaci\u00F3n: proyecci\u00F3n mensual basada en medias hist\u00F3ricas con tendencia interanual',
      'Export a Excel: 5 tipos de descarga CSV (ranking ADR, propietarios, mensual, plataformas, todo)',
      'Cach\u00E9 de contexto: reutiliza contexto 30s si mismas categor\u00EDas y datos, evita rec\u00E1lculos',
      'Cach\u00E9/alertas se resetean autom\u00E1ticamente al recargar datos',
      'Clasificador ampliado: 18 categor\u00EDas (CMP_OWNER, PREDICT, EXPORT)',
      'Chips actualizados: Comparar propietarios, Predicci\u00F3n, Exportar Excel',
      'Botones de descarga inline tras queries de exportaci\u00F3n',
    ]
  },
  {
    version: '2.17.0',
    date: '2026-02-15',
    changes: [
      'Asistente IA Fase 3: KPIs avanzados (ADR, estancia media, comisi\u00F3n efectiva, margen propietario)',
      'Rankings autom\u00E1ticos: Top 5 y Bottom 5 pisos por liquidaci\u00F3n y por ADR',
      'Comparativa interanual completa con tabla \u0394% y top movers por alojamiento',
      'Estacionalidad cruzada: tabla plataforma x trimestre con pico/valle',
      'Nuevas categor\u00EDas clasificador: KPI, YOY, SEASON (15 categor\u00EDas totales)',
      'Chips actualizados: KPIs, Comparar a\u00F1os, Estacionalidad, Comisiones, Propietarios, Ranking ADR',
      'System prompt enriquecido con definiciones de KPIs para respuestas m\u00E1s precisas',
    ]
  },
  {
    version: '2.16.0',
    date: '2026-02-15',
    changes: [
      'Asistente IA Fase 2: clasificador inteligente de queries con 12 categor\u00EDas',
      'Contexto selectivo: solo env\u00EDa secciones relevantes seg\u00FAn la pregunta',
      'Reducci\u00F3n de tokens 50-80% en preguntas espec\u00EDficas vs contexto completo',
      'Historial compactado autom\u00E1ticamente tras 10+ mensajes',
      'System prompt simplificado con regla de contexto selectivo',
      'Log de categor\u00EDas detectadas en consola para debug',
    ]
  },
  {
    version: '2.15.1',
    date: '2026-02-15',
    changes: [
      'Asistente IA Fase 1: contexto enriquecido con desglose financiero completo',
      'Nuevas secciones IA: comisiones canal+GTC+pasarela, limpieza, amenities, IRPF por agrupaci\u00F3n',
      'Propietarios integrados: nombre, pisos, reservas, importe y liquidaci\u00F3n por propietario',
      'Acuerdos especiales: m\u00EDnimo garantizado 80/20 y propiedades GTC en contexto IA',
      'Mantenimiento mensual por alojamiento incluido en contexto',
      'Datos por agente y origen marketing disponibles para el asistente',
      'Comparativa anual autom\u00E1tica cuando hay datos de 2+ a\u00F1os',
      'Chips de preguntas r\u00E1pidas: 6 consultas frecuentes con un clic',
      'Detalle de reservas ampliado: incluye comisiones canal/GTC/limpieza por fila',
    ]
  },
  {
    version: '2.15.0',
    date: '2026-02-15',
    changes: [
      'Sync multi-usuario: polling cada 30s lee cambios de otros usuarios en tiempo real',
      'Validaciones migradas a pesta\u00F1a Configuracion (persisten aunque cambie la hoja de datos)',
      'Backward compat: si Configuracion no tiene validaciones, fallback a columna de la hoja',
      'Toast discreto muestra resumen de cambios remotos aplicados',
      'Bot\u00F3n sync on/off en sidebar con indicador visual',
      'Pausa autom\u00E1tica del polling durante saves pendientes locales',
      'Delta-merge inteligente: solo aplica cambios en reservas no editadas localmente',
      'Fix asistente IA: contexto reducido de ~25k a ~4k tokens (eliminadas secciones redundantes, detalle 50 filas compactas)',
      'Retry autom\u00E1tico con backoff en rate limits (429) del asistente IA',
    ]
  },
  {
    version: '2.14.0',
    date: '2026-02-15',
    changes: [
      'Acuerdo 80/20 GTC: pestana propia al nivel de Pasarela e Impuestos',
      'Diseno violeta original v2.3.1: caja con degradado purpura, borde d8b4fe, toggles compactos',
      'Tab activa con borde purpura distintivo (#7c3aed)',
      'Separado del tab de Servicios GTC / Limpieza / Amenities / Mant.',
    ]
  },
  {
    version: '2.13.0',
    date: '2026-02-15',
    changes: [
      'PDF en ingles: si se elige English, el PDF adjunto se genera completamente en EN',
      'Todas las etiquetas del PDF traducidas: cabeceras, conceptos, totales, resumen',
      'Impresion y descarga directa de PDF siguen en espanol',
    ]
  },
  {
    version: '2.12.1',
    date: '2026-02-14',
    changes: [
      'Migracion Booking: al cargar datos, fuerza comision maxima en todas las reservas no validadas',
      'Cambios se persisten automaticamente en la hoja de configuracion',
    ]
  },
  {
    version: '2.12.0',
    date: '2026-02-14',
    changes: [
      'Default comision plataforma y pasarela: siempre la opcion mas alta',
      'Columna ID Reserva visible por defecto en ambas vistas (reserva y alojamiento)',
      'Filtro de mes por defecto: mes anterior al actual',
      'Email: selector de idioma Espanol/English en el modal',
    ]
  },
  {
    version: '2.11.8',
    date: '2026-02-14',
    changes: [
      'Fix PDF: createPattern parcheado al cargar modulo (antes de html2canvas)',
      'Fix PDF: try/catch en createPattern como fallback adicional',
    ]
  },
  {
    version: '2.11.7',
    date: '2026-02-14',
    changes: [
      'Fix PDF: monkey-patch createPattern para evitar crash con canvas 0px en html2canvas',
      'PDF render: pseudo-elementos y gradientes eliminados en contexto render',
    ]
  },
  {
    version: '2.11.6',
    date: '2026-02-14',
    changes: [
      'Fix PDF: proteccion contra canvas con dimension 0 (error createPattern)',
      'PDF render: min-height forzado en barras doradas y logo para evitar colapso',
      'PDF render: delay aumentado a 400ms para navegadores lentos',
    ]
  },
  {
    version: '2.11.5',
    date: '2026-02-14',
    changes: [
      'Default comision plataforma: siempre la opcion mas alta (Booking 22% en vez de 15%)',
      'Columna ID Reserva visible por defecto en la tabla',
      'Sidebar: Preliquidacion > Por Reserva, Detalle > Liquidacion Reserva',
    ]
  },
  {
    version: '2.11.4',
    date: '2026-02-14',
    changes: [
      'Sidebar: Preliquidacion renombrado a Por Reserva',
      'Sidebar: Detalle Preliquidacion renombrado a Liquidacion Reserva',
      'Tarjeta detalle: tipo muestra Liquidacion Reserva cuando no validada',
    ]
  },
  {
    version: '2.11.3',
    date: '2026-02-14',
    changes: [
      'Total bar estilo D: "TOTAL A LIQUIDAR" dorado 10px + subtitulo blanco 20px',
      'Valor total ampliado a 32px',
      'Aplicado en detalle, consolidado, print cards individual y resumen',
    ]
  },
  {
    version: '2.11.2',
    date: '2026-02-14',
    changes: [
      'Total a liquidar: importe en blanco en vez de dorado (mejor contraste sobre teal)',
      'Firma email: David Fraidiaz | Green Tropical Coast, S.L. | granadabeachgolf.com',
      'Footer email: granadabeachgolf.com en vez de homityholidays.com',
    ]
  },
  {
    version: '2.11.1',
    date: '2026-02-14',
    changes: [
      'Email modal: boton enviar con gradiente teal Homity (#1D4B56)',
      'Estado enviando: fondo teal oscuro + texto dorado (mejor contraste)',
      'Estado enviado: teal + dorado en vez de verde sobre verde',
      'Status bar sending: fondo crema calido, status success: verde con texto teal',
      'Input focus: borde teal en vez de azul',
    ]
  },
  {
    version: '2.11.0',
    date: '2026-02-14',
    changes: [
      'Branding Homity completo: headers teal (#1D4B56), meta-strips teal oscuro (#163E47)',
      'Barras doradas (#E0AE00) superior e inferior en todas las tarjetas de liquidacion',
      'Logo homity holidays en headers de detalle, consolidado e impresion',
      'Total bar: fondo teal con borde dorado, importe en dorado',
      'Dividers con degradado dorado, filas bold con borde teal, subtotal-bar crema',
      'Variables CSS Homity actualizadas al manual de identidad oficial',
      'Print CSS: soporte para gold bars y logo en impresion',
    ]
  },
  {
    version: '2.10.2',
    date: '2026-02-14',
    changes: [
      'Fix: iconos toast (success/error/warning/info/close) corruptos por triple-encoding UTF-8',
      'Reemplazados caracteres mojibake por HTML entities ASCII-safe (&#10003; &#10007; etc.)',
    ]
  },
  {
    version: '2.10.1',
    date: '2026-02-14',
    changes: [
      'email-module.js v2.0.0: reescritura completa del modulo PDF + Gmail',
      'PDF robusto: CSS clonado de la pagina (no depende de herencia), _waitForFonts()',
      'Nuevo boton Descargar PDF: descarga standalone sin necesidad de Gmail',
      'CSS boton pdf-download-btn con gradiente violeta, oculto en print',
      'Precarga de librerias PDF en background al abrir modal de email',
      'Gmail mejorado: errores especificos para 403/429, cierre modal con fade',
      'Singleton promise para carga de librerias (evita duplicados)',
    ]
  },
  {
    version: '2.10.0',
    date: '2026-02-14',
    changes: [
      'Modulo Email: nuevo archivo satelite email-module.js (arquitectura modular)',
      'OAuth scope ampliado: gmail.send para envio de liquidaciones por correo',
      'Propietarios tab ampliada: columna C para email del propietario',
      'Nuevas funciones core: getPropietarioEmail(), savePropietarioEmail()',
      'Boton Enviar por Email en vista consolidada (junto a Generar Liquidacion)',
      'Generacion de PDF en cliente con html2canvas + jsPDF (carga dinamica)',
      'Envio via Gmail API con PDF adjunto (MIME multipart)',
      'Modal de email: confirmacion destinatario, asunto editable, mensaje personalizable',
      'CSS modal de email integrado en index.html (email-modal-*, email-btn, email-status)',
    ]
  },
  {
    version: '2.9.0',
    date: '2026-02-14',
    changes: [
      'Redise\u00F1o preliquidaci\u00F3n individual: header con meta-strip en franja oscura, textura grid, badge pill',
      'Nuevo liq-header-top + liq-meta-strip reemplaza estructura anterior header+liq-meta',
      'Selectores redise\u00F1ados: pills compactas (liq-sel) con fondo gris, menor padding',
      'Subtotal destacado: nueva barra liq-subtotal-bar con gradiente azul y borde (como consolidado)',
      'Label Deducciones renombrado a Venta, gestión y operaciones (coherente con consolidado)',
      'Badge redise\u00F1ado: pill rounded con fondo semitransparente (badge-liq-green/amber)',
      'Padding reducido: 80px a 32px en liq-sec, liq-total, liq-header, liq-ce2',
      'Redise\u00F1o consolidado detalle: header con barra de progreso de validaci\u00F3n animada',
      'Nuevo layout 2 columnas (cd-summary-section): desglose izquierda + resumen rapido derecha',
      'Quick Stats: 3 tarjetas compactas (Reservas, Noches, Facturacion) en columna derecha',
      'Total Hero: tarjeta destacada con gradiente azul y importe 36px centrado',
      'Bot\u00F3n Generar Liquidaci\u00F3n integrado debajo del total hero (verde con shadow)',
      'Split box mejorado: barra visual proporcional (consol-split-bar-gtc/owner) con porcentajes',
      'Dots de color en split: 8px morado para GTC, verde para propietario',
      'Mini-tarjeta split en columna derecha (cd-split-mini) entre subtotal y otros conceptos',
      'Total bar full-width: cd-total-bar oscura con contexto (alojamiento + mes)',
      'Nomenclatura Reparto a Acuerdo en split boxes y panel de configuraci\u00F3n',
      'Nomenclatura Otros Conceptos: reemplaza Conceptos Extraordinarios del Mes',
      'Print: header estructura actualizada a liq-header-top + liq-meta-strip en buildPrintCards',
      'Print: resumen consolidado con propietario en meta-strip y total-label con contexto split',
      'Print CSS actualizado: soporte 2 columnas, progress bar, total hero, meta-strip',
      'Fix: boton Generar Liquidacion no funcionaba (consol-actions eliminado, null-safe en showPrintPreview/exitPreview/printConsolDirect)',
      'Fix print: header consolidado solapado - position:static + z-index:auto + overflow:visible en consol-header/progress/meta-strip',
      'Fix print: consol-meta-strip forzado a grid 4 columnas (evita colapso flex en impresion)',
      'Print CSS reescrito completo: secciones organizadas, todos los componentes nuevos cubiertos',
    ]
  },
  {
    version: '2.8.0',
    date: '2026-02-13',
    changes: [
      'Nuevo: toggle segmentado Validadas/No Validadas en barra de filtros del grid consolidado',
      'Por defecto: No Validadas primero (pendientes destacados, validados atenuados)',
      'Clic en boton activo = estado neutral (sin prioridad de validacion)',
      'Contadores dinamicos en cada boton del toggle',
      'Tarjetas del grupo no prioritario se atenuan (dimmed) pero siguen clicables',
      'Toggle es primario en orden, dropdown Ordenar por actua como secundario',
      'Eliminadas opciones Pendientes/Listas primero del dropdown (ahora en toggle)',
      'Swap colores validacion: validado=verde (positivo), pendiente=naranja (atencion)',
    ]
  },
  {
    version: '2.7.5',
    date: '2026-02-13',
    changes: [
      'Fix print: liq-row.bold con margin:-80px se recortaba al imprimir (ahora -20px en print)',
      'Fix print: liq-container overflow:hidden cortaba contenido (ahora overflow:visible en print)',
      'Fix print: consol-subtotal-reservas sin override de padding 80px en print',
      'Fix print: consol-summary-block max-width 680px limitaba ancho en print',
      'Fix: entrada CHANGELOG con &lt;script&gt; rompia renderizado del historial',
      'Swap colores validacion: validado=verde (positivo), pendiente=naranja (atencion)',
      'Afecta: botones individuales, Validar/Desvalidar todas, vista detalle y consoldetail',
    ]
  },
  {
    version: '2.7.4',
    date: '2026-02-13',
    changes: [
      'Architecture Guide: bloque de documentacion exhaustiva al inicio del &lt;script&gt; para Claude/AI',
      'Modelo de datos documentado: allReservas[], settings{}, validated Set, flujo de cÃƒÆ’Ã‚Â¡lculo',
      'ÃƒÆ’Ã‚Ândice de 18 mÃƒÆ’Ã‚Â³dulos [M01]-[M18] con marcadores buscables en el cÃƒÆ’Ã‚Â³digo',
      'JSDoc en 49+ funciones crÃƒÆ’Ã‚Â­ticas: calcLiquidacion, processRows, renderTable, etc.',
      'DocumentaciÃƒÆ’Ã‚Â³n de flujo Google Sheets: OAuth ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ load ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ persist ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ write-back',
      'DocumentaciÃƒÆ’Ã‚Â³n de sistema de cachÃƒÆ’Ã‚Â©: _liqCache, _cachedFiltered, delta-updates',
      'DocumentaciÃƒÆ’Ã‚Â³n de convenciones: prefijos _, esc() obligatorio, SemVer',
      'MÃƒÆ’Ã‚Â³dulos marcados con separadores ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â para navegaciÃƒÆ’Ã‚Â³n rÃƒÆ’Ã‚Â¡pida',
      'Sub-mÃƒÆ’Ã‚Â³dulos marcados con ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ para secciones dentro de un mÃƒÆ’Ã‚Â³dulo',
      'Zero cambios funcionales: solo documentaciÃƒÆ’Ã‚Â³n y organizaciÃƒÆ’Ã‚Â³n del cÃƒÆ’Ã‚Â³digo',
    ]
  },
  {
    version: '2.7.3',
    date: '2026-02-13',
    changes: [
      'Fix raiz: texto pegado a bordes era por consol-summary sin max-width (se estiraba a 1920px)',
      'consol-summary-block: max-width 860px + margin 0 auto (centrado como liq-container 780px)',
      'Paddings normalizados a 48px en ambas vistas (liq y consol): header, secciones, rows, totales',
      'Eliminada escalada de paddings (36>40>48>56>64) - ahora todo coherente a 48px',
    ]
  },
  {
    version: '2.7.2',
    date: '2026-02-12',
    changes: [
      'Fix: boton CE en fila principal se desincronizaba del panel de resumen',
      '_refreshCESummary() ahora siempre sincroniza el boton .col-ce en row-{idx}',
      '_refreshCE2Summary() idem para boton .col-ceSinIva',
      'CEX removeConsolExtra: eliminacion DOM pura + _rebuildCexIndices (sin re-render)',
      'CEX inputs importe ahora en color rojo (#e53935)',
      'Fix changeConsolMaintAmount: span neg se actualiza al cambiar select',
    ]
  },
  {
    version: '2.7.1',
    date: '2026-02-12',
    changes: [
      'CEX: input label reducido a 50% del ancho (flex:0 0 50%)',
      'CEX: importe negativo en rojo alineado a la derecha como Mantenimiento',
      'CEX: _cexKey() Enter en label salta a importe, Enter en importe abre nueva fila',
      'CEX: Escape en fila vacia la elimina automaticamente',
      'CEX: live input actualiza span rojo inmediatamente + debounce 400ms para totales',
    ]
  },
  {
    version: '2.7.0',
    date: '2026-02-12',
    changes: [
      'Otros Conceptos: edicion inline estilo CE (label+importe+borrar+anadir)',
      'Filas editables con input label + input importe + boton eliminar (misma mecanica que CE/CE2)',
      'Live debounce 400ms en importes: totales finales se actualizan mientras escribes',
      'Nuevo _patchConsolFinalTotals(): parchea solo Subtotal/IRPF/IVA/TOTAL sin re-render',
      'addConsolExtra inserta fila DOM directamente (sin prompt ni re-render completo)',
      'removeConsolExtra con animacion ceRowOut + indices recalculados tras splice',
      'toggleConsolMaint y changeConsolMaintAmount ya no llaman viewConsolDetail',
    ]
  },
  {
    version: '2.6.5',
    date: '2026-02-12',
    changes: [
      'Consol lightweight patch: CE/CE2 ahora parchean celdas individuales sin reconstruir DOM',
      'Mismo path ligero que preliquidaciones \u2014 cero saltos, panel permanece abierto',
      'Nuevo _patchConsolLightweight(): parchea crow cells + footer + summary innerHTML',
      'Nuevo _patchConsolRowCells(): actualiza solo celdas num\u00E9ricas en crow-{idx}',
      'Nuevo _patchConsolFooterRow(): actualiza solo celdas del tfoot consolidado',
      'Nuevo _buildConsolSummaryInner(): genera HTML del resumen sin tocar tabla ni header',
      'Nuevo _getConsolCalcsAndSums(): helper reutilizable para recalcular sumas consolidadas',
      'IDs a\u00F1adidos: consol-tfoot-row, consol-summary-block para patch directo',
      'Sustituye _viewConsolNoJump/_viewConsolNoJumpKeepPanel en todo el c\u00F3digo CE/CE2'
    ]
  },
  {
    version: '2.6.4',
    date: '2026-02-12',
    changes: [
      'Live input: importes CE/CE2 se actualizan en tiempo real mientras el usuario teclea',
      'Delegaci\u00F3n de eventos: un solo listener document.input captura .ce-inp-amt y .ce2-inp-amt',
      'Debounce 400ms evita re-renders excesivos durante escritura r\u00E1pida',
      'Path ligero: actualiza cache + panel summary + footer stats sin reconstruir DOM completo',
      'Nuevo _viewConsolNoJump(): congela altura contenedor + guarda scroll + viewConsolDetail + restaura',
      'Elimina saltos visuales al re-renderizar resumen consolidado durante edici\u00F3n de importes',
      'Usado en: live input, _applyCEChange, _applyCE2Change, removeCEItem, removeCE2Item',
      'Nuevo _viewConsolNoJumpKeepPanel(): re-abre panel CE/CE2 tras re-render consolidado',
      'REEMPLAZADO: _patchConsolLightweight() hace patch quirurgico sin re-render DOM',
      'Borrar item CE/CE2 ya no cierra el panel - patch ligero como en preliq',
      'Limpieza: eliminado codigo muerto (_viewConsolNoJump, _patchConsolInPlace, duplicados)',
      'Fix: corregido innerHTML corrupto en addCEItem tras limpieza de oninput inline'
    ]
  },
  {
    version: '2.6.3',
    date: '2026-02-12',
    changes: [
      'Fix: removeCEItem y removeCE2Item no re-renderizaban resumen consolidado tras eliminar concepto',
      'Causa: rama con animaci\u00F3n (ceRowOut) parcheaba celdas individuales pero no llamaba viewConsolDetail',
      'A\u00F1adido: if (v==="c\" && currentConsolAloj) viewConsolDetail() en ambas funciones tras animationend',
      'Ahora al borrar un CE/CE2 en la tabla consolidada, el resumen inferior se actualiza inmediatamente'
    ]
  },
  {
    version: '2.6.2',
    date: '2026-02-12',
    changes: [
      'Resumen consolidado: caja C.E. sin IVA descontados ahora muestra desglose de cada concepto',
      'Cada item muestra nombre, importe y n\u00FAmero de reserva asociada',
      'Estilo sub-fila: color #9f7aea, font-size 11px, indentado 12px'
    ]
  },
  {
    version: '2.6.1',
    date: '2026-02-12',
    changes: [
      'Fix cr\u00EDtico parseNum(): cuando Google Sheets devuelve n\u00FAmero nativo JS (ej: 1698.91), se convert\u00EDa a string y se eliminaba el punto decimal como si fuera separador de miles',
      'Resultado: 1698.91 \u2192 169891 (x100), 416.24 \u2192 41624, etc.',
      'Soluci\u00F3n: if (typeof v === "number") return v \u2014 devolver directamente sin parsear strings',
      'Afectaba a totalReserva y cualquier campo num\u00E9rico con decimales desde la API'
    ]
  },
  {
    version: '2.6.0',
    date: '2026-02-12',
    changes: [
      'Detalle liquidaci\u00F3n: reemplazada paleta Homity (gold/slate/serif) por paleta app (azul/sidebar/Inter)',
      'Header: gradiente sidebar (#0f1628 \u2192 #1a2744) + l\u00EDnea azul gradient inferior',
      'Labels meta: color var(--c-primary) #4f8cff, tipograf\u00EDa Inter 800 en nombre propietario',
      'Secciones: padding 36px, bordes var(--c-border-light), filas bold con fondo #f8f9fb',
      'CE2: fondo var(--c-primary-bg) #f0f5ff, borde superior azul, dots azules',
      'Total: gradiente sidebar + importe #4f8cff italic, l\u00EDnea azul gradient',
      'Controles: select.sel con border #dde1e8, focus #4f8cff (igual que tabla)',
      'Toggle pasarela: #4f8cff on, #d1d5db off, tama\u00F1o 38x22px (igual que tabla)',
      'Botones: Validar btn-success #43a047, Desvalidar btn-orange, Imprimir btn-outline',
      'Badges: badge-liq-green rgba(46,125,50,0.2), badge-liq-amber rgba(245,158,11,0.2)',
      'Eliminado liq-gold-line, eliminadas referencias Homity en botones detalle'
    ]
  },
  {
    version: '2.5.1',
    date: '2026-02-12',
    changes: [
      'Fix toggle pasarela: <label> con checkbox oculto causaba doble-click (toggle+toggle = sin efecto)',
      'Reemplazado <label>+<input checkbox> por <div> con clase .on en liq-sw-track',
      'CSS: eliminado selector :checked, usa .liq-sw-track.on para estado activo',
      'Eliminado setTimeout innecesario, viewDetail se llama directamente'
    ]
  },
  {
    version: '2.5.0',
    date: '2026-02-12',
    changes: [
      'Redise\u00F1o completo detalle liquidaci\u00F3n con identidad Homity Holidays',
      'Paleta dorado (#d4a843) + slate (#2e4a52) extra\u00EDda del branding h\u00F4mity holidays',
      'Tipograf\u00EDa: Cormorant Garamond (serif display), JetBrains Mono (importes)',
      'Header slate con l\u00EDnea dorada separadora, labels dorado muted',
      'Secciones con liq-sec, liq-sec-label para estructura sem\u00E1ntica',
      'Pasarela integrada: switch dorado + select + valor en fila \u00FAnica',
      'Switch desactivado: label gris, select oculto, valor tachado',
      'Secci\u00F3n CE2 con fondo dorado sutil, l\u00EDnea gold superior, dots dorados',
      'Total: barra dorada + fondo slate con importe en Cormorant 30px',
      'Badges: pendiente dorado outline, validada verde outline',
      'Selects: fondo cream, focus glow dorado, flecha SVG custom',
      'Bot\u00F3n Validar dorado, Imprimir outlined',
      'Print styles actualizados para nuevas clases',
      'Eliminado border-radius (est\u00E9tica editorial resort)',
      'Valores mon con font-mono JetBrains para alineaci\u00F3n tabular'
    ]
  },
  {
    version: '2.4.9',
    date: '2026-02-12',
    changes: [
      'Fix critico persistencia CE2: rango de lectura Config era A1:I (9 cols), faltaba columna J',
      'conceptosSinIVA se escribÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­a en col J pero nunca se leÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­a de vuelta',
      'Corregido a A1:J en lectura y A:J en limpieza de filas obsoletas'
    ]
  },
  {
    version: '2.4.8',
    date: '2026-02-12',
    changes: [
      '_applyCEChange/_applyCE2Change: reemplazado _patchSingleRow por path ligero',
      'Clic entre campos CE ya no reconstruye el panel ni provoca salto',
      'onchange ahora usa _refreshCESummary + _patchMainRowCells (mismo path que Enter)'
    ]
  },
  {
    version: '2.4.7',
    date: '2026-02-12',
    changes: [
      'Fix: _patchMainRowCells ahora actualiza botones CE y CE2 de la fila principal',
      'El badge "-100,00 \u20AC" refleja el total real tras editar con Enter'
    ]
  },
  {
    version: '2.4.6',
    date: '2026-02-12',
    changes: [
      'Fix critico CE2: _ce2Key guardaba en propiedad incorrecta, valores no llegaban al calculo',
      'CE2 ahora suma y persiste correctamente al pulsar Enter'
    ]
  },
  {
    version: '2.4.5',
    date: '2026-02-12',
    changes: [
      'CE/CE2: Enter no crea fila nueva si ya existe una vacÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­a abajo',
      'Si hay fila vacÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­a pendiente, Enter mueve el foco ahÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­ en vez de duplicar'
    ]
  },
  {
    version: '2.4.4',
    date: '2026-02-12',
    changes: [
      'CE Enter zero-jump: fila nueva PRIMERO, nÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Âºmeros actualizados en siguiente frame',
      'focus({preventScroll:true}) en todos los focus de CE/CE2 (6 puntos)',
      'requestAnimationFrame para desacoplar actualizaciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n de cache/stats del DOM',
      'Elimina layout thrashing: no hay lectura+escritura DOM intercalada'
    ]
  },
  {
    version: '2.4.3',
    date: '2026-02-12',
    changes: [
      'CE/CE2: Enter en importe ya no hace re-render completo (0 saltos)',
      'Nuevo _patchMainRowCells: actualiza solo celdas numÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â©ricas sin tocar DOM del panel',
      'Enter guarda directo al modelo de datos, bypass de onchange ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ _applyCEChange ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ _patchSingleRow',
      'Stats del footer actualizados incrementalmente sin rebuild'
    ]
  },
  {
    version: '2.4.2',
    date: '2026-02-12',
    changes: [
      'Config modal: Enter en campo valor ejecuta AÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â±adir directamente',
      'URLs Google Sheets: Enter en los 3 inputs dispara Cargar/Guardar',
      'Conceptos Extraordinarios: prompt() reemplazado por inputs inline',
      'Consol extras: flujo nombre ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ Enter ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ importe ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ Enter ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ guardado suave',
      'Consol extras: Escape cancela, blur inteligente auto-guarda si hay datos'
    ]
  },
  {
    version: '2.4.1',
    date: '2026-02-12',
    changes: [
      'CE/CE2: Pulsar Enter en el campo importe abre nuevo concepto suavemente',
      'CE/CE2: Pulsar Enter en el campo nombre mueve foco al importe',
      'Flujo sin ratÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n: nombre ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ Enter ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ importe ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ Enter ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ nuevo concepto'
    ]
  },
  {
    version: '2.4.0',
    date: '2026-02-12',
    changes: [
      'RediseÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â±o visual: nueva paleta de colores con CSS variables',
      'TipografÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­a mejorada: Inter para tÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­tulos, DM Sans para cuerpo, tabular-nums en tabla',
      'Tarjetas de alojamiento refinadas con gradiente sutil y mejor hover',
      'Toast notifications en lugar de alert() para feedback no bloqueante',
      'ValidaciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n de inputs numÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â©ricos con rango (0-100% para tasas)',
      'Sidebar con iconos SVG y transiciones mÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡s fluidas',
      'Fix: bloque de versionado corrupto (encoding UTF-8) restaurado',
      'Fix: parseNum() ahora valida rangos para porcentajes',
      'Mejoras en sombras, bordes y espaciado general',
      'Nuevas animaciones: fadeIn para pantallas, slide para paneles'
    ]
  },
  { version: '2.3.2', date: '2026-02-12T23:45:00+01:00', changes: [
    'Lista toggles 80/20 limitada a 20 alojamientos propiedad GTC',
    'Nueva lista _gtcOwnedAlojamientos persistida en Google Sheets (clave gtc_owned)',
    'Descripci\u00F3n actualizada: activa los vendidos, GTC retiene 20%'
  ]},
  { version: '2.3.1', date: '2026-02-12T23:30:00+01:00', changes: [
    'Selector visual de alojamientos 80/20 con toggles en pesta\u00F1a Configuraci\u00F3n > GTC',
    'Lista din\u00E1mica generada a partir de alojamientos cargados',
    'Contador de alojamientos activos con guardado autom\u00E1tico'
  ]},
  { version: '2.3.0', date: '2026-02-12T23:15:00+01:00', changes: [
    'Reparto 80/20 GTC: alojamientos con condici\u00F3n especial retienen 20% para GTC del Subtotal Reservas',
    'Caja violeta de reparto entre Subtotal Reservas y Otros Conceptos',
    'IRPF e IVA se calculan sobre Subtotal Final Mes (80% \u2212 conceptos ext.)',
    'Lista de alojamientos especiales persistida en pesta\u00F1a Configuraci\u00F3n de Google Sheets',
    'Versi\u00F3n impresa incluye desglose del reparto GTC/Propietario'
  ]},
  { version: '2.2.0', date: '2026-02-12T22:45:00+01:00', changes: [
    'Nuevo orden resumen consolidado: sigue orden columnas tabla (Amenities \u2192 Pasarela \u2192 C.E. Sin IVA)',
    'Nuevo Subtotal Reservas: subtotal intermedio que cierra deducciones por reserva',
    'Secci\u00F3n Otros Conceptos separada en caja verde',
    'Subtotal renombrado a Subtotal Final Mes para distinguir del Subtotal Reservas',
    'Versi\u00F3n impresa actualizada con nuevos nombres de subtotales'
  ]},
  { version: '2.1.1', date: '2026-02-12T22:15:00+01:00', changes: [
    'Fix: dropdown selector de columnas se cortaba en secci\u00F3n Liquidaci\u00F3n por overflow del contenedor',
    'A\u00F1adido max-height: 60vh con scroll al desplegable de columnas para evitar desbordamiento'
  ]},
  { version: '2.1.0', date: '2026-02-12T17:30:00+01:00', changes: [
    'Nueva columna C.E. (Sin IVA): conceptos especiales que restan directamente al subtotal',
    'Panel desplegable violeta con misma mec\u00E1nica que C.E. (IVA inc.) pero en base sin IVA',
    'Integrado en preliquidaciones, vista consolidada, detalle individual y vista de impresi\u00F3n',
    'Persistencia autom\u00E1tica en pesta\u00F1a Configuracion de Google Sheets',
    'C\u00E1lculo: sub = baseSinIVA \u2212 comPlat \u2212 comGTC \u2212 comPas \u2212 limp \u2212 amen \u2212 ceSinIva'
  ]},
  { version: '2.0.2', date: '2026-02-13T00:20:00+01:00', changes: [
    'Bloque VERSIONING RULES (SemVer) embebido en el c\u00F3digo con checklist obligatorio',
    'Memoria actualizada para forzar cumplimiento de versionado en cada entrega'
  ]},
  { version: '2.0.1', date: '2026-02-13T00:15:00+01:00', changes: [
    'Fix: addCEItem ahora persiste inmediatamente al a\u00F1adir concepto especial',
    'Persistencia write-first: datos se escriben antes de limpiar filas obsoletas',
    'Si la limpieza de filas residuales falla, los datos nuevos ya est\u00E1n seguros',
    'Eliminado riesgo de p\u00E9rdida de config si la red falla entre clear y update'
  ]},
  { version: '2.0.0', date: '2026-02-12T22:45:00+01:00', changes: [
    'Refactorizaci\u00F3n profunda del c\u00F3digo base para mayor robustez y mantenibilidad',
    'Nuevo objeto CONFIG centraliza todas las constantes de la aplicaci\u00F3n',
    'Nuevo objeto AppState unifica variables globales dispersas (60+ vars \u2192 1 objeto)',
    'Funci\u00F3n esc() para sanitizaci\u00F3n XSS en todos los templates HTML',
    'Deduplicaci\u00F3n: getSortValue() unificada para tabla principal y consolidada',
    'Deduplicaci\u00F3n: _buildFooterHtml() genera footer para ambas vistas',
    'Error handling robusto con try/catch y mensajes descriptivos en operaciones Google API',
    'Eliminado patr\u00F3n fr\u00E1gil processRows._lastValColIdx \u2192 retorno por objeto',
    'Conversi\u00F3n completa var \u2192 const/let en todo el c\u00F3digo',
    'SafeJSON: parsing JSON defensivo con fallback para datos corruptos',
    'Validaci\u00F3n de inputs en funciones cr\u00EDticas (changeSetting, processRows)',
    'Funciones de cache centralizadas en CacheManager',
    'Helpers: safeGet() para acceso seguro a propiedades anidadas',
    'Console logging mejorado con prefijos [Module] consistentes',
    'Correcci\u00F3n de potenciales memory leaks en event listeners'
  ]},
  { version: '1.9.1', date: '2026-02-11T01:12:00+01:00', changes: [
    'CE: eliminar concepto con animaci\u00F3n slide-out sin flash ni re-render',
    'CE: a\u00F1adir concepto con animaci\u00F3n slide-in + auto-focus',
    'Texto: "Totales" \u2192 "Reservas Totales" en barra de totales'
  ]},
  { version: '1.9.0', date: '2026-02-11T01:01:00+01:00', changes: [
    'Filtro de fecha multi-selecci\u00F3n: selecciona varios a\u00F1os y meses simult\u00E1neamente',
    'Combinatoria libre: Ene+Feb de 2025+2026, o un mes en 3 a\u00F1os, etc.',
    'Flechas \u2039 \u203A para navegar cuando hay selecci\u00F3n simple (1 a\u00F1o o 1 a\u00F1o+mes)',
    'Contador de reservas por mes agregado seg\u00FAn a\u00F1os seleccionados',
    'Fix: a\u00F1adir concepto CE suave \u2014 inserta DOM sin re-render + animaci\u00F3n slide-down',
    'Texto: "Totales" \u2192 "Reservas Totales" en barra de totales'
  ]},
  { version: '1.8.0', date: '2026-02-11T00:33:00+01:00', changes: [
    'Asistente Hist\u00F3rico Reservas: chat IA integrado con bot\u00F3n flotante y panel lateral',
    'Responde solo con datos reales cargados \u2014 nunca inventa cifras ni nombres',
    'Contexto completo: res\u00FAmenes por alojamiento, plataforma, mes, edificio, atendido por, tipo reserva',
    'Detalle por reserva: todos los campos del Sheet (ID, localizador, cliente, edificio, etc.)',
    'Desglose de liquidaci\u00F3n: base, comisiones, limpieza, amenities, CE, pasarela, subtotal',
    'System prompt estricto anti-alucinaciones con referencia a campos disponibles',
    'API Key se guarda localmente en el navegador (localStorage)',
    'Contexto inteligente: res\u00FAmenes cubren 100% reservas, detalle usa filtros activos (max 200)'
  ]},
  { version: '1.7.5', date: '2026-02-10T09:07:00+01:00', changes: [
    'Changelog muestra d\u00EDa, hora y segundos en horario Madrid (+01:00)',
    'Sidebar muestra hora real del deploy (primer acceso a la versi\u00F3n), no hora de build',
    'Meta tags anti-cach\u00E9: navegador siempre pide versi\u00F3n fresca al servidor',
    'Scrollbar permanente, fino (6px) y transparente \u2014 elimina sombra al abrir/cerrar CE',
    'Fix: modal config no salta al cambiar de tab (posici\u00F3n fija arriba + min-height)'
  ]},
  { version: '1.7.4', date: '2026-02-10T08:30:00+01:00', changes: [
    'Historial de versiones integrado en la app con enlace en sidebar',
    'Tab de configuraci\u00F3n renombrado: Servicio GTC / Limpieza / Amenities / Mant.',
    'Pesta\u00F1a "Impuestos" separada para IRPF',
    'Toast de nueva versi\u00F3n con lista de cambios y link a historial completo',
    'Toast m\u00E1s duradero (12s)',
    'Fix: toast no aparec\u00EDa al no cambiar string de versi\u00F3n',
    'Fix: doble-click necesario tras buscar (search input cambiaba de ancho al perder foco)',
    'Fix: micro-vibraci\u00F3n DOM con overflow-anchor y DocumentFragment'
  ]},
  { version: '1.7.3', date: '2026-02-10T08:00:00+01:00', changes: [
    'Renombrar "Plataforma" \u2192 "Canal de Venta" en cabeceras y detalle',
    'Reordenar secciones: Canal de Venta \u2192 GTC/Limpieza \u2192 Pasarela \u2192 Impuestos',
    'Fix: salto de scroll al hacer click con pocos resultados filtrados',
    'Fix: IDs de panel CE corregidos en _patchSingleRow (ce-ppanel-)'
  ]},
  { version: '1.7.2', date: '2026-02-10T07:20:00+01:00', changes: [
    'CE interactivo en vista consolidada (panel desplegable)',
    'Sistema de prefijo de vista (p/c) para evitar conflictos de IDs',
    'Toast de notificaci\u00F3n de nueva versi\u00F3n al arrancar',
    'Filtro mes/a\u00F1o por defecto al mes y a\u00F1o actual',
    'Deducciones mensuales (mantenimiento + extras) antes del subtotal',
    'Fix: limpieza e IRPF con valor 0\u20AC no se aplicaban (bug falsy)',
    'Fix: estilos consol-row mejorados'
  ]},
  { version: '1.7.1', date: '2026-02-09T19:30:00+01:00', changes: [
    'Integraci\u00F3n de propietarios desde Google Sheets con edici\u00F3n inline',
    'Columnas renombradas: Canal de Venta, Gesti\u00F3n GTC, Pasarela de pago',
    'Estado de validaci\u00F3n ordenable en la tabla',
    'Fix: filtrado por tab en configuraci\u00F3n'
  ]},
  { version: '1.7.0', date: '2026-02-09T18:40:00+01:00', changes: [
    'Conceptos Especiales (CE): panel inline con bot\u00F3n +/- por reserva',
    'CE se descuenta del total antes de calcular comisiones',
    'CE integrado en vista principal, consolidada, detalle e impresi\u00F3n',
    'Persistencia de CE en Google Sheets (tab Configuracion)',
    'B\u00FAsqueda mejorada: filtra tambi\u00E9n por importes y CE',
    'Fix: cabeceras de columna CE con tooltip',
    'Fix: comportamiento de click en bot\u00F3n CE',
    'Fix: persistencia de autenticaci\u00F3n Google entre sesiones'
  ]},
  { version: '1.6.1', date: '2026-02-09T16:23:00+01:00', changes: [
    'Amenities configurables por reserva (no solo global)',
    'Fix: tab Configuracion se filtraba incorrectamente en carga',
    'Fix: estado de carga atascado al cambiar de fuente',
    'Fix: correcciones de codificaci\u00F3n UTF-8 en textos espa\u00F1oles'
  ]},
  { version: '1.6.0', date: '2026-02-09T14:21:00+01:00', changes: [
    'Persistencia de configuraci\u00F3n en pesta\u00F1a "Configuracion" de Google Sheets',
    'Auto-guardado de opciones globales y ajustes por reserva',
    'Carga autom\u00E1tica de configuraci\u00F3n al conectar Google Sheets',
    'Debounce inteligente para minimizar escrituras API'
  ]},
  { version: '1.5.1', date: '2026-02-09T06:00:00+01:00', changes: [
    'Sincronizaci\u00F3n inmediata con indicadores visuales de estado',
    'B\u00FAsqueda de texto global en todas las vistas',
    'Mejoras en layout de columnas',
    'Escritura de validaciones directamente en Google Sheets'
  ]},
  { version: '1.5.0', date: '2026-02-08T21:00:00+01:00', changes: [
    'Write-back de estado de validaci\u00F3n a Google Sheets',
    'Detecci\u00F3n autom\u00E1tica de columna de validaci\u00F3n',
    'Operaciones batch para validar/desvalidar m\u00FAltiples reservas',
    'Paginaci\u00F3n con delta-updates para rendimiento O(1)',
    'Optimizaci\u00F3n de rendimiento para miles de reservas',
    'Integraci\u00F3n con Google Sheets v\u00EDa OAuth',
    'Deploy en GitHub Pages'
  ]},
  { version: '1.4.0', date: '2026-02-08T19:00:00+01:00', changes: [
    'Vista consolidada por alojamiento con resumen financiero',
    'Liquidaci\u00F3n individual con desglose completo',
    'Impresi\u00F3n optimizada de liquidaciones'
  ]},
  { version: '1.3.0', date: '2026-02-08T17:00:00+01:00', changes: [
    'Sistema de filtros combinados: plataforma, alojamiento, estado',
    'Filtro por mes/a\u00F1o con selector visual',
    'Ordenaci\u00F3n por m\u00FAltiples campos',
    'Tarjetas de estad\u00EDsticas con porcentajes filtrados'
  ]},
  { version: '1.2.0', date: '2026-02-08T15:00:00+01:00', changes: [
    'Pasarela de pago configurable (Stripe/Booking)',
    'Toggle de activaci\u00F3n/desactivaci\u00F3n por reserva',
    'Modal de configuraci\u00F3n con gesti\u00F3n de opciones',
    'C\u00E1lculo de IVA sobre subtotal'
  ]},
  { version: '1.1.0', date: '2026-02-08T13:00:00+01:00', changes: [
    'C\u00E1lculo de liquidaci\u00F3n: comisiones, limpieza, IRPF',
    'Vista de detalle individual por reserva',
    'Validaci\u00F3n de reservas con estado persistente',
    'Exportaci\u00F3n y carga de ficheros Excel'
  ]},
  { version: '1.0.0', date: '2026-02-08T11:00:00+01:00', changes: [
    'Versi\u00F3n inicial: carga de ficheros Excel de reservas',
    'Tabla de preliquidaciones con columnas configurables',
    'Sidebar de navegaci\u00F3n',
    'Dise\u00F1o responsive'
  ]}
];

// Mostrar versi\u00F3n en sidebar + toast si nueva versi\u00F3n
window.addEventListener('DOMContentLoaded', () => {
  const vl = document.getElementById('version-label');
  if (vl) {
    // Record actual deploy time (first load of this version)
    const deployKey = 'app-deploy-time-' + APP_VERSION;
    let deployTime = SafeStorage.get(deployKey);
    if (!deployTime) {
      deployTime = new Date().toISOString();
      SafeStorage.set(deployKey, deployTime);
    }
    const bd = new Date(deployTime);
    const bStr = bd.toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Europe/Madrid'});
    vl.textContent = APP_VERSION + ' (' + bStr + ')';
  }
  const lastSeen = SafeStorage.get('app-last-version');
  if (lastSeen && lastSeen !== APP_VERSION) {
    showVersionToast(lastSeen);
  }
  SafeStorage.set('app-last-version', APP_VERSION);
});

function showVersionToast(prevVersion) {
  const entry = CHANGELOG.find(c => c.version === APP_VERSION);
  const changesList = entry ? entry.changes.slice(0, 4).map(c => `<div style="font-size:11px;color:#cbd5e1;padding:2px 0 2px 12px;position:relative;line-height:1.4;"><span style="position:absolute;left:2px;color:#4f8cff;">\u2022</span>${c}</div>`).join('') : `<div style="font-size:12px;color:#cbd5e1;">${APP_CHANGES}</div>`;
  const moreCount = entry && entry.changes.length > 4 ? `<div style="font-size:11px;color:#64748b;margin-top:2px;">...y ${entry.changes.length - 4} m\u00E1s</div>` : '';
  const toast = document.createElement('div');
  toast.id = 'version-toast';
  toast.innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:12px;">
      <span style="font-size:22px;line-height:1;">&#x1F680;</span>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:14px;margin-bottom:6px;">Actualizaci\u00F3n v${APP_VERSION}</div>
        ${changesList}${moreCount}
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
          <span style="font-size:11px;color:#64748b;">Anterior: v${prevVersion}</span>
          <a href="#" onclick="event.preventDefault();closeVersionToast();showChangelog();" style="font-size:11px;color:#4f8cff;text-decoration:none;font-weight:600;">Ver historial completo \u2192</a>
        </div>
      </div>
      <button onclick="closeVersionToast()" style="background:none;border:none;color:#94a3b8;font-size:18px;cursor:pointer;padding:0;line-height:1;">&times;</button>
    </div>`;
  toast.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:99999;background:linear-gradient(135deg,#0f172a,#1e293b);color:#f1f5f9;padding:16px 20px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3),0 0 0 1px rgba(255,255,255,0.08);max-width:360px;min-width:280px;opacity:0;transform:translateY(20px);transition:all 0.4s cubic-bezier(0.16,1,0.3,1);font-family:inherit;';
  document.body.appendChild(toast);
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    });
  });
  setTimeout(() => closeVersionToast(), CONFIG.VERSION_TOAST_TIMEOUT);
}
function closeVersionToast() {
  const t = document.getElementById('version-toast');
  if (!t) return;
  t.style.opacity = '0';
  t.style.transform = 'translateY(20px)';
  setTimeout(() => t.remove(), 400);
}
function showVersionInfo() {
  showChangelog();
}

function showChangelog() {
  const body = document.getElementById('changelog-body');
  body.innerHTML = CHANGELOG.map((v, i) => {
    const isCurrent = v.version === APP_VERSION;
    const items = v.changes.map(c => `<li>${c}</li>`).join('');
    return `<div class="cl-version">
      <div class="cl-version-header">
        <span class="cl-badge${isCurrent ? ' current' : ''}">v${v.version}</span>
        <span class="cl-date">${new Date(v.date).toLocaleDateString('es-ES', {day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Europe/Madrid'})}</span>
        ${isCurrent ? '<span style="font-size:11px;color:#43a047;font-weight:600;">&#x2190; actual</span>' : ''}
      </div>
      <ul class="cl-changes">${items}</ul>
    </div>`;
  }).join('');
  document.getElementById('changelog-overlay').style.display = 'flex';
}

function closeChangelog() {
  document.getElementById('changelog-overlay').style.display = 'none';
}

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M05] GOOGLE_AUTH ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â AutenticaciÃƒÆ’Ã‚Â³n OAuth y gestiÃƒÆ’Ã‚Â³n de tokens
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === CONFIGURACIÃƒÆ’Ã¢â‚¬Å“N GOOGLE ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Credenciales OAuth ===
const GOOGLE_CLIENT_ID = '658971789892-cnsnbr36hus5jablgkuj2qk8ipic5ptf.apps.googleusercontent.com';
const GOOGLE_API_KEY   = 'AIzaSyAqn7NyL_QRC97KW-huBjzZjTLPGpEoT-k';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/gmail.send';

// === GOOGLE STATE ===
let _gapiInited = false, _gisInited = false, _googleToken = null, _tokenClient = null;
let _pickerInited = false;
let _sheetHistory = [];
_sheetHistory = SafeStorage.getJSON('gsheet-history', []);
let _defaultSheetUrl = null;
_defaultSheetUrl = SafeStorage.get('gsheet-default-url', null);

function gapiLoaded() {
  gapi.load('client:picker', async () => {
    try {
      await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
      _gapiInited = true; _pickerInited = true;
      maybeEnableGoogleUI();
    } catch(e) { console.warn('gapi init error:', e); }
  });
}

function gisLoaded() {
  _tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID, scope: SCOPES, callback: onTokenResponse,
  });
  _gisInited = true;
  maybeEnableGoogleUI();
}

function maybeEnableGoogleUI() {
  if (_gapiInited && _gisInited) {
    // Auto re-auth silently if user was previously connected
    if (!_googleToken && _tokenClient) {
      try {
        if (SafeStorage.get('gsheet-connected') === '1') {
          _tokenClient.requestAccessToken({ prompt: '' });
        }
      } catch(e) { console.warn('[Auth] Auto-reconnect error:', e.message); }
    }
    renderSheetHistory();
    if (GOOGLE_CLIENT_ID === 'TU_CLIENT_ID.apps.googleusercontent.com') {
      const el = document.getElementById('gsheet-section');
      if (el) el.innerHTML = '<h3>&#128202; Google Sheets</h3>' +
        '<p style="color:#e53935;">Configura GOOGLE_CLIENT_ID y GOOGLE_API_KEY en el c\u00F3digo para activar esta funci\u00F3n. Consulta el README.md para instrucciones.</p>';
    }
  }
}

window.addEventListener('load', () => {
  if (typeof gapi !== 'undefined') gapiLoaded();
  else { const s = document.querySelector('script[src*="apis.google.com"]'); if (s) s.addEventListener('load', gapiLoaded); }
  if (typeof google !== 'undefined' && google.accounts) gisLoaded();
  else { const s = document.querySelector('script[src*="accounts.google.com"]'); if (s) s.addEventListener('load', () => setTimeout(gisLoaded, 100)); }
});

// === GOOGLE AUTH ===
function googleSignIn() {
  if (!_tokenClient) { showToast('Google API no inicializada. Recarga la pÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡gina.', 'error'); return; }
  if (_googleToken) { updateGoogleStatus(true); return; }
  _tokenClient.requestAccessToken({ prompt: '' });
}
function onTokenResponse(resp) {
  if (resp.error) { console.error('Auth error:', resp); return; }
  _googleToken = resp;
  gapi.client.setToken(resp);
  SafeStorage.set('gsheet-connected', '1');
  updateGoogleStatus(true);
}
function googleSignOut() {
  if (_googleToken) { google.accounts.oauth2.revoke(_googleToken.access_token, () => {}); _googleToken = null; }
  SafeStorage.remove('gsheet-connected');
  updateGoogleStatus(false);
}
let _autoLoadAttempted = false;
function updateGoogleStatus(connected) {
  const statusEl = document.getElementById('gsheet-status');
  const labelEl = document.getElementById('gsheet-status-label');
  const btnC = document.getElementById('btn-google-connect');
  const btnD = document.getElementById('btn-google-disconnect');
  const picker = document.getElementById('gsheet-picker-area');
  const sidebar = document.getElementById('sidebar-google');
  const defaultArea = document.getElementById('gsheet-default-area');
  const noDefaultArea = document.getElementById('gsheet-no-default');
  if (connected) {
    statusEl.className = 'gsheet-status connected'; labelEl.textContent = t('upload.connectedGoogle');
    btnC.style.display = 'none'; btnD.style.display = ''; picker.style.display = '';
    sidebar.style.display = 'block';
    document.getElementById('google-dot').className = 'status-dot on';
    document.getElementById('google-status-text').textContent = t('upload.googleConnected');
    if (_defaultSheetUrl) {
      defaultArea.style.display = '';
      noDefaultArea.style.display = 'none';
      renderDefaultUrlDisplay();
      if (!_autoLoadAttempted && allReservas.length === 0) {
        _autoLoadAttempted = true;
        setTimeout(function() { autoLoadDefaultSheet(); }, 300);
      }
    } else {
      defaultArea.style.display = 'none';
      noDefaultArea.style.display = '';
    }
  } else {
    statusEl.className = 'gsheet-status disconnected'; labelEl.textContent = t('upload.notConnected');
    btnC.style.display = ''; btnD.style.display = 'none'; picker.style.display = 'none';
    sidebar.style.display = 'none';
    defaultArea.style.display = 'none';
    noDefaultArea.style.display = 'none';
    document.getElementById('gsheet-autoload-status').style.display = 'none';
  }
  renderSheetHistory();
}

// === DEFAULT SHEET URL MANAGEMENT ===
function renderDefaultUrlDisplay() {
  const el = document.getElementById('default-url-display');
  if (!el || !_defaultSheetUrl) return;
  const short = _defaultSheetUrl.length > 80 ? _defaultSheetUrl.substring(0, 77) + '...' : _defaultSheetUrl;
  el.innerHTML = '<span style="color:#6b7280;font-size:12px;">URL:</span> ' + short;
}
function loadDefaultSheet() {
  if (!_defaultSheetUrl) return;
  const id = extractSheetId(_defaultSheetUrl);
  if (!id) { showToast('La URL por defecto no es vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lida.', 'error'); return; }
  loadSheetById(id, 'Hoja por defecto');
}
function autoLoadDefaultSheet() {
  if (!_defaultSheetUrl || !_googleToken) return;
  let id = extractSheetId(_defaultSheetUrl);
  if (!id) return;
  const statusEl = document.getElementById('gsheet-autoload-status');
  statusEl.style.display = '';
  document.getElementById('autoload-status-text').textContent = t('upload.loadingDefault');
  loadSheetById(id, 'Hoja por defecto');
}
function editDefaultUrl() {
  document.getElementById('default-url-display').style.display = 'none';
  document.getElementById('default-url-edit').style.display = '';
  document.getElementById('default-url-edit-input').value = _defaultSheetUrl || '';
  document.getElementById('default-url-edit-input').focus();
}
function cancelDefaultUrlEdit() {
  document.getElementById('default-url-display').style.display = '';
  document.getElementById('default-url-edit').style.display = 'none';
}
function saveDefaultUrlEdit() {
  const url = document.getElementById('default-url-edit-input').value.trim();
  if (!url) { showToast('Introduce una URL vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lida.', 'warning'); return; }
  let id = extractSheetId(url);
  if (!id) { showToast('URL no vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lida. Debe ser Google Sheets.', 'error'); return; }
  _defaultSheetUrl = url;
  SafeStorage.set('gsheet-default-url', url);
  cancelDefaultUrlEdit();
  renderDefaultUrlDisplay();
  document.getElementById('gsheet-default-area').style.display = '';
  document.getElementById('gsheet-no-default').style.display = 'none';
}
function clearDefaultUrl() {
  if (!confirm('\u00BFQuitar la hoja por defecto?')) return;
  _defaultSheetUrl = null;
  SafeStorage.remove('gsheet-default-url');
  document.getElementById('gsheet-default-area').style.display = 'none';
  if (_googleToken) document.getElementById('gsheet-no-default').style.display = '';
}
function showSetDefaultUrl() {
  const form = document.getElementById('set-default-url-form');
  form.style.display = form.style.display === 'none' ? '' : 'none';
  if (form.style.display !== 'none') document.getElementById('set-default-url-input').focus();
}
function saveNewDefaultUrl() {
  const url = document.getElementById('set-default-url-input').value.trim();
  if (!url) { showToast('Introduce una URL vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lida.', 'warning'); return; }
  let id = extractSheetId(url);
  if (!id) { showToast('URL no vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lida. Debe ser Google Sheets.', 'error'); return; }
  _defaultSheetUrl = url;
  SafeStorage.set('gsheet-default-url', url);
  document.getElementById('set-default-url-form').style.display = 'none';
  document.getElementById('set-default-url-input').value = '';
  document.getElementById('gsheet-no-default').style.display = 'none';
  document.getElementById('gsheet-default-area').style.display = '';
  renderDefaultUrlDisplay();
}

// === GOOGLE PICKER ===
function getAppId() {
  const m = GOOGLE_CLIENT_ID.match(/^(\d+)/);
  return m ? m[1] : '';
}
function openGooglePicker() {
  if (!_pickerInited || !_googleToken) { showToast('Inicia sesiÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n con Google primero.', 'warning'); return; }
  const view = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS).setIncludeFolders(true).setSelectFolderEnabled(false);
  const sharedView = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS).setIncludeFolders(true).setOwnedByMe(false);
  const picker = new google.picker.PickerBuilder()
    .enableFeature(google.picker.Feature.NAV_HIDDEN)
    .setTitle('Selecciona la hoja de reservas')
    .addView(view).addView(sharedView)
    .setOAuthToken(_googleToken.access_token)
    .setDeveloperKey(GOOGLE_API_KEY)
    .setAppId(getAppId())
    .setCallback(onPickerCallback)
    .setSize(900, 550).build();
  picker.setVisible(true);
}
function onPickerCallback(data) {
  if (data.action === google.picker.Action.PICKED) {
    const doc = data.docs[0]; loadSheetById(doc.id, doc.name);
  }
}

// === LOAD FROM URL ===
function loadFromUrl() {
  const url = document.getElementById('gsheet-url-input').value.trim();
  if (!url) { showToast(t('toast.pasteUrl'), 'warning'); return; }
  const id = extractSheetId(url);
  if (!id) { showToast('URL no vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lida. Debe ser Google Sheets.', 'error'); return; }
  loadSheetById(id, 'Google Sheet');
}
function extractSheetId(url) {
  const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  if (m) return m[1];
  if (/^[a-zA-Z0-9_-]{20,}$/.test(url)) return url;
  return null;
}

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M06] GOOGLE_SHEETS ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Carga de datos, write-back y persistencia
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === LOAD SHEET DATA ===
async function loadSheetById(sheetId, sheetName) {
  if (!_googleToken) { showToast('Inicia sesiÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n con Google primero.', 'warning'); return; }
  showGSheetLoading(t('loading.gettingInfo'));
  try {
    const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: sheetId, fields: 'properties.title,sheets.properties' });
    const title = meta.result.properties.title;
    const sheets = meta.result.sheets.map(s => ({ name: s.properties.title, index: s.properties.index }));
    const dataSheets = sheets.filter(s => s.name !== CONFIG_TAB_NAME && s.name !== PROPIETARIOS_TAB_NAME);
    if (dataSheets.length === 0) { hideGSheetLoading(); showToast(t('toast.noDataSheets'), 'warning'); return; }
    if (dataSheets.length === 1) { await loadSheetData(sheetId, dataSheets[0].name, title); }
    else { hideGSheetLoading(); showSheetSelector(sheetId, dataSheets, title); }
  } catch(e) {
    hideGSheetLoading();
    const errMsg = safeGet(e, 'result.error.message', '');
    console.error('[GSheets] Error loading sheet:', errMsg || e);
    showToast(errMsg ? 'Error: ' + errMsg : t('toast.errorLoadSheet'), 'error', 5000);
  }
}
function showSheetSelector(sheetId, sheets, title) {
  const sel = document.getElementById('gsheet-sheets-selector');
  const list = document.getElementById('gsheet-sheets-list');
  sel.style.display = '';
  list.innerHTML = '';
  const visibleSheets = sheets.filter(s => s.name !== CONFIG_TAB_NAME && s.name !== PROPIETARIOS_TAB_NAME);
  visibleSheets.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline btn-sm';
    btn.textContent = s.name;
    btn.addEventListener('click', () => selectSheetTab(sheetId, s.name, title + ' / ' + s.name));
    list.appendChild(btn);
  });
}
async function selectSheetTab(sheetId, sheetTab, title) {
  document.getElementById('gsheet-sheets-selector').style.display = 'none';
  await loadSheetData(sheetId, sheetTab, title + ' / ' + sheetTab);
}
/**
 * @description Carga los datos de una hoja especÃƒÆ’Ã‚Â­fica del Google Sheet.
 * Es la funciÃƒÆ’Ã‚Â³n principal del flujo de carga desde Google Sheets.
 * Tras cargar los datos, configura write-back, config y propietarios.
 * @param {string} sheetId - ID del spreadsheet de Google
 * @param {string} sheetTab - Nombre de la pestaÃƒÆ’Ã‚Â±a a leer
 * @param {string} displayName - Nombre para mostrar al usuario
 */
async function loadSheetData(sheetId, sheetTab, displayName) {
  showGSheetLoading(t('loading.reading') + ' "' + displayName + '"...');
  try {
    const range = sheetTab + '!A1:Z10000';
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: sheetId, range: range,
      valueRenderOption: 'UNFORMATTED_VALUE', dateTimeRenderOption: 'SERIAL_NUMBER'
    });
    const rows = resp.result.values;
    if (!rows || rows.length < 2) { hideGSheetLoading(); showToast('La hoja estÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡ vacÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­a o no tiene datos suficientes.', 'warning'); return; }
    showGSheetLoading(t('loading.processing', rows.length - 1));
    if (!processRows(rows)) { hideGSheetLoading(); return; }

    // Set up sheet source for write-back
    const lastResult = processRows._lastResult || {};



    const valColIdx = lastResult.valColIdx !== undefined ? lastResult.valColIdx : null;
    const headerRowIdx = lastResult.headerRow !== undefined ? lastResult.headerRow : 0;
    await setupSheetSource(sheetId, sheetTab, headerRowIdx, valColIdx);

    // Load or create config tab for persistence
    await loadOrCreateConfigTab(sheetId);

    // Load propietarios mapping
    await loadPropietariosTab(sheetId);

    addToSheetHistory(sheetId, displayName, sheetTab);
    document.getElementById("file-name").textContent = '\u{1F4CA} ' + displayName;
    document.getElementById("file-indicator").style.display = "block";
    document.getElementById("nav-consol").style.display = "block";
    updateSyncIndicator('idle');
    document.getElementById('sync-toggle-btn').style.display = 'block';
    // One-time migration: force highest commission for non-validated Booking reservations
    _migrateBookingCommission();

    hideGSheetLoading(); showScreen("list"); renderTable();
    // Auto-start multi-user sync if enabled
    _autoStartSyncIfReady();
  } catch(e) {
    hideGSheetLoading();
    const errMsg = safeGet(e, 'result.error.message', '');
    console.error('[GSheets] Error reading sheet data:', errMsg || e);
    showToast(errMsg ? 'Error: ' + errMsg : t('toast.errorReadData'), 'error', 5000);
  }
}

// === LOADING UI ===
function showGSheetLoading(text) { document.getElementById('gsheet-loading').style.display = 'flex'; document.getElementById('gsheet-loading-text').textContent = text || 'Cargando...'; }
function hideGSheetLoading() { document.getElementById('gsheet-loading').style.display = 'none'; document.getElementById('gsheet-autoload-status').style.display = 'none'; }

// === SHEET WRITE-BACK: Validation column ===
function colIndexToLetter(idx) {
  let s = '';
  idx = Math.max(0, idx);
  while (true) {
    s = String.fromCharCode(65 + (idx % 26)) + s;
    idx = Math.floor(idx / 26) - 1;
    if (idx < 0) break;
  }
  return s;
}

async function setupSheetSource(sheetId, sheetTab, headerRowIdx, valColIdx) {
  if (valColIdx !== null) {
    // Column already exists
    _sheetSource = {
      id: sheetId,
      tab: sheetTab,
      valColIdx: valColIdx,
      valColLetter: colIndexToLetter(valColIdx),
      headerRow: headerRowIdx
    };
    console.log('[Sync] Validation column found at ' + _sheetSource.valColLetter + ' (index ' + valColIdx + ')');
    return;
  }

  // Column doesn't exist \u2014 create it after the last used column
  // Find the max column used in header row
  const headerResp = await gapi.client.sheets.spreadsheets.values.get({
    spreadsheetId: sheetId,
    range: sheetTab + '!' + (headerRowIdx + 1) + ':' + (headerRowIdx + 1),
    valueRenderOption: 'UNFORMATTED_VALUE'
  });
  const headerVals = (headerResp.result.values && headerResp.result.values[0]) || [];
  const newColIdx = headerVals.length; // next empty column
  const newColLetter = colIndexToLetter(newColIdx);

  // Write the header "Validada"
  await gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId: sheetId,
    range: sheetTab + '!' + newColLetter + (headerRowIdx + 1),
    valueInputOption: 'RAW',
    resource: { values: [['Validada']] }
  });

  _sheetSource = {
    id: sheetId,
    tab: sheetTab,
    valColIdx: newColIdx,
    valColLetter: newColLetter,
    headerRow: headerRowIdx
  };
  console.log('[Sync] Created validation column at ' + newColLetter + ' (index ' + newColIdx + ')');
}

async function writeValidationToSheet(reservaIdx, isValidated) {
  // Validations now persist in Configuracion tab (not data sheet)
  scheduleReservaConfigSave(reservaIdx);
}

async function batchWriteValidation(reservaIndices, isValidated) {
  // Validations now persist in Configuracion tab (not data sheet)
  // All indices are added to pending set, debounce coalesces into single write
  if (!_sheetSource || !_googleToken || reservaIndices.length === 0) return;
  reservaIndices.forEach(function(idx) { _pendingReservaConfigSaves.add(idx); });
  if (_reservaConfigSaveTimer) clearTimeout(_reservaConfigSaveTimer);
  _reservaConfigSaveTimer = setTimeout(flushReservaConfigSaves, 300); // faster for batch
}

// Sync status indicator
function updateSyncIndicator(state) {
  const el = document.getElementById('sync-indicator');
  if (!el) return;
  if (!_sheetSource) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  const dot = el.querySelector('.sync-dot');
  const text = el.querySelector('.sync-text');
  switch(state) {
    case 'syncing':
      dot.className = 'sync-dot syncing';
      text.textContent = t('save.saving');
      break;
    case 'saved':
      dot.className = 'sync-dot saved';
      text.textContent = t('save.saved');
      // Fade back to idle after 2s
      clearTimeout(el._fadeTimer);
      el._fadeTimer = setTimeout(() => updateSyncIndicator('idle'), 2500);
      break;
    case 'error':
      dot.className = 'sync-dot error';
      text.textContent = t('save.error');
      clearTimeout(el._fadeTimer);
      el._fadeTimer = setTimeout(() => updateSyncIndicator('idle'), 5000);
      break;
    default: // idle
      dot.className = 'sync-dot idle';
      text.textContent = t('save.synced');
      break;
  }
}


// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M06-PERSIST] CONFIG PERSISTENCE ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â PestaÃƒÆ’Ã‚Â±a "Configuracion" en Google Sheets
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === CONFIG PERSISTENCE: "Configuracion" tab in Google Sheets ===
const CONFIG_TAB_NAME = CONFIG.CONFIG_TAB_NAME;
const PROPIETARIOS_TAB_NAME = CONFIG.PROPIETARIOS_TAB_NAME;
let _propietariosMap = {}; // alojamiento code (normalized) -> propietario name
let _propietariosEmailMap = {}; // alojamiento code (normalized) -> propietario email
let _propietariosKeys = []; // sorted by length desc for best match
let _propietariosRowMap = {}; // alojamiento code (normalized) -> sheet row number (1-based)
let _propietariosSheetId = null;

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M07] PROPIETARIOS ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Mapeo alojamientoÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢propietario y ediciÃƒÆ’Ã‚Â³n inline
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

/**
 * @description Busca el propietario de un alojamiento.
 * Primero intenta match exacto, luego match parcial (substring).
 * @param {string} alojamiento - Nombre/cÃƒÆ’Ã‚Â³digo del alojamiento
 * @returns {string} Nombre del propietario o t('consol.missingOwner')
 */
function getPropietario(alojamiento) {
  if (!alojamiento) return t('consol.missingOwner');
  const key = alojamiento.trim().toLowerCase();
  if (_propietariosMap[key]) return _propietariosMap[key];
  for (let i = 0; i < _propietariosKeys.length; i++) {
    if (key.indexOf(_propietariosKeys[i]) !== -1) return _propietariosMap[_propietariosKeys[i]];
  }
  return t('consol.missingOwner');
}

/**
 * @description Busca el email del propietario de un alojamiento.
 * @param {string} alojamiento - Nombre/cÃƒÆ’Ã‚Â³digo del alojamiento
 * @returns {string} Email del propietario o cadena vacÃƒÆ’Ã‚Â­a
 */
function getPropietarioEmail(alojamiento) {
  if (!alojamiento) return '';
  const key = alojamiento.trim().toLowerCase();
  if (_propietariosEmailMap[key]) return _propietariosEmailMap[key];
  for (let i = 0; i < _propietariosKeys.length; i++) {
    if (key.indexOf(_propietariosKeys[i]) !== -1) return _propietariosEmailMap[_propietariosKeys[i]] || '';
  }
  return '';
}

/**
 * @description Guarda el email del propietario en Google Sheets (columna C).
 * @param {string} alojamiento - Nombre/cÃƒÆ’Ã‚Â³digo del alojamiento
 * @param {string} email - Email del propietario
 * @returns {Promise<boolean>} true si se guardÃƒÆ’Ã‚Â³ correctamente
 */
async function savePropietarioEmail(alojamiento, email) {
  const matchedKey = _getPropietarioKey(alojamiento);
  if (!_propietariosSheetId || !_googleToken || !matchedKey) return false;
  try {
    const row = _propietariosRowMap[matchedKey];
    if (!row) return false;
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: _propietariosSheetId,
      range: PROPIETARIOS_TAB_NAME + '!C' + row,
      valueInputOption: 'RAW'
    }, { values: [[email]] });
    _propietariosEmailMap[matchedKey] = email;
    return true;
  } catch(e) { console.error('[Propietarios] Error saving email:', e); return false; }
}

function _getPropietarioKey(alojamiento) {
  if (!alojamiento) return null;
  const key = alojamiento.trim().toLowerCase();
  if (_propietariosMap[key]) return key;
  for (let i = 0; i < _propietariosKeys.length; i++) {
    if (key.indexOf(_propietariosKeys[i]) !== -1) return _propietariosKeys[i];
  }
  return null;
}

async function savePropietario(alojamiento, newName) {
  const matchedKey = _getPropietarioKey(alojamiento);
  if (!_propietariosSheetId || !_googleToken) return false;
  try {
    if (matchedKey && _propietariosRowMap[matchedKey]) {
      // Update existing row
      const row = _propietariosRowMap[matchedKey];
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: _propietariosSheetId,
        range: PROPIETARIOS_TAB_NAME + '!B' + row,
        valueInputOption: 'RAW'
      }, { values: [[newName]] });
      _propietariosMap[matchedKey] = newName;
    } else {
      // New entry: find alojamiento code from the full name
      const code = alojamiento.trim();
      const codeKey = code.toLowerCase();
      // Append new row
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: _propietariosSheetId,
        range: PROPIETARIOS_TAB_NAME + '!A:B',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS'
      }, { values: [[code, newName]] });
      _propietariosMap[codeKey] = newName;
      // Estimate new row number
      let maxRow = 1;
      for (const k in _propietariosRowMap) { if (_propietariosRowMap[k] > maxRow) maxRow = _propietariosRowMap[k]; }
      _propietariosRowMap[codeKey] = maxRow + 1;
      _propietariosKeys = Object.keys(_propietariosMap).sort(function(a, b) { return b.length - a.length; });
    }
    return true;
  } catch(e) { console.error('[Propietarios] Error saving:', e); return false; }
}

function editPropietarioInline(alojamiento, el) {
  let current = getPropietario(alojamiento);
  if (current === t('consol.missingOwner')) current = '';
  const inp = document.createElement('input');
  inp.type = 'text'; inp.value = current;
  inp.style.cssText = 'font-size:inherit;font-weight:700;border:2px solid #3b82f6;border-radius:6px;padding:4px 8px;width:100%;max-width:350px;outline:none;';
  const container = el.parentNode;
  const original = el;
  container.replaceChild(inp, original);
  inp.focus(); inp.select();

  let saving = false;
  async function doSave() {
    if (saving) return; saving = true;
    const val = inp.value.trim();
    if (!val) val = current; // revert if empty
    if (val !== current) {
      inp.disabled = true; inp.style.opacity = '0.5';
      const ok = await savePropietario(alojamiento, val);
      if (!ok) { showToast('Error al guardar. ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¿EstÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡s conectado a Google Sheets?', 'error'); }
    }
    // Rebuild element
    const span = document.createElement('span');
    span.className = original.className;
    const prop = getPropietario(alojamiento);
    span.textContent = prop;
    span.title = 'Clic para editar propietario';
    span.style.cursor = 'pointer';
    if (prop === t('consol.missingOwner')) span.style.color = '#e53935';
    span.onclick = function() { editPropietarioInline(alojamiento, span); };
    container.replaceChild(span, inp);
  }
  inp.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); doSave(); } if (e.key === 'Escape') { saving = true; container.replaceChild(original, inp); } });
  inp.addEventListener('blur', function() { setTimeout(doSave, 100); });
}

async function loadPropietariosTab(sheetId) {
  _propietariosMap = {};
  _propietariosEmailMap = {};
  _propietariosRowMap = {};
  _propietariosSheetId = sheetId;
  try {
    const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: sheetId, fields: 'sheets.properties' });
    const sheets = meta.result.sheets || [];
    const hasTab = sheets.some(function(s) { return s.properties.title === PROPIETARIOS_TAB_NAME; });
    if (!hasTab) { console.log('[Propietarios] No tab found'); return; }
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: sheetId, range: PROPIETARIOS_TAB_NAME + '!A1:C1000',
      valueRenderOption: 'FORMATTED_VALUE'
    });
    const rows = resp.result.values;
    if (!rows || rows.length < 2) return;
    for (let i = 1; i < rows.length; i++) {
      const aloj = (rows[i][0] || '').trim();
      const prop = (rows[i][1] || '').trim();
      const email = (rows[i][2] || '').trim();
      if (aloj) {
        const k = aloj.toLowerCase();
        _propietariosMap[k] = prop || '';
        _propietariosEmailMap[k] = email || '';
        _propietariosRowMap[k] = i + 1; // 1-based sheet row
      }
    }
    console.log('[Propietarios] Loaded:', Object.keys(_propietariosMap).length);
    _propietariosKeys = Object.keys(_propietariosMap).sort(function(a, b) { return b.length - a.length; });
  } catch(e) { console.warn('Error loading Propietarios tab:', e); }
}
let _configLoaded = false; // true after config has been loaded/created for current sheet

// Debounce timers for saving
let _globalConfigSaveTimer = null;
let _reservaConfigSaveTimer = null;
let _pendingReservaConfigSaves = new Set();

/**
 * @description Programa el guardado de configuraciÃƒÆ’Ã‚Â³n global con debounce de 1500ms.
 * Cada llamada reinicia el timer. Solo se ejecuta si hay conexiÃƒÆ’Ã‚Â³n a Google Sheets.
 */
function scheduleGlobalConfigSave() {
  if (!_sheetSource || !_googleToken) return;
  if (_globalConfigSaveTimer) clearTimeout(_globalConfigSaveTimer);
  _globalConfigSaveTimer = setTimeout(saveGlobalConfigToSheet, 1500);
}

/**
 * @description Programa el guardado de configuraciÃƒÆ’Ã‚Â³n de una reserva con debounce.
 * Acumula mÃƒÆ’Ã‚Âºltiples cambios y los guarda en batch tras 1000ms de inactividad.
 * @param {number} idx - ÃƒÆ’Ã‚Ândice de la reserva modificada
 */
function scheduleReservaConfigSave(idx) {
  if (!_sheetSource || !_googleToken) return;
  _pendingReservaConfigSaves.add(idx);
  if (_reservaConfigSaveTimer) clearTimeout(_reservaConfigSaveTimer);
  _reservaConfigSaveTimer = setTimeout(flushReservaConfigSaves, 1000);
}

// Build global config data as key-value rows
function buildGlobalConfigRows() {
  const rows = [];
  Object.keys(platformOptions).sort().forEach(function(name) {
    rows.push(['plataforma:' + name, platformOptions[name].join(',')]);
  });
  rows.push(['pasarela_stripe', pasarelaStripeOptions.join(',')]);
  rows.push(['pasarela_booking', pasarelaBookingOptions.join(',')]);
  rows.push(['limpieza', cleaningOptions.join(',')]);
  rows.push(['irpf', irpfOptions.join(',')]);
  rows.push(['gtc', gtcOptions.join(',')]);
  rows.push(['amenities', amenitiesOptions.join(',')]);
  rows.push(['mantenimiento', maintenanceOptions.join(',')]);
  rows.push(['gtc_split', _gtcSplitAlojamientos.join(',')]);
  rows.push(['gtc_owned', _gtcOwnedAlojamientos.join(',')]);
  // Per-consolidation monthly deductions
  Object.keys(_consolMaint).forEach(function(k) {
    const m = _consolMaint[k];
    rows.push(['maint:' + k, (m.enabled?'1':'0') + ',' + m.amount]);
  });
  Object.keys(_consolExtras).forEach(function(k) {
    const exs = _consolExtras[k];
    if (exs.length > 0) {
      rows.push(['extras:' + k, JSON.stringify(exs)]);
    }
  });
  return rows;
}

// Build per-reservation config rows
function buildReservaConfigRows(indices) {
  const rows = [];
  const list = indices ? [...indices] : allReservas.map(function(r) { return r.idx; });
  list.forEach(function(idx) {
    const r = allReservas[idx];
    const s = settings[idx];
    if (!r || !s) return;
    rows.push([
      r.id,
      s.comPlataforma !== undefined ? s.comPlataforma : '',
      s.comGTC !== undefined ? s.comGTC : '',
      s.limpieza !== undefined ? s.limpieza : '',
      s.amenities !== undefined ? s.amenities : '',
      s.irpf !== undefined ? s.irpf : '',
      s.pasarela ? 'true' : 'false',
      s.pasarelaRate !== undefined ? s.pasarelaRate : '',
      (s.conceptosEspeciales && s.conceptosEspeciales.length > 0) ? JSON.stringify(s.conceptosEspeciales) : '',
      (s.conceptosSinIVA && s.conceptosSinIVA.length > 0) ? JSON.stringify(s.conceptosSinIVA) : '',
      validated.has(idx) ? 'true' : 'false'
    ]);
  });
  return rows;
}

// Full build of the Configuracion tab content
function buildFullConfigTabData() {
  const data = [];
  data.push(['Configuracion', 'Liquidaciones App', 'v' + APP_VERSION]);
  data.push([]);
  data.push(['OPCIONES GLOBALES']);
  data.push(['Clave', 'Valor']);
  let globalRows = buildGlobalConfigRows();
  globalRows.forEach(function(row) { data.push(row); });
  data.push([]);
  data.push(['AJUSTES POR RESERVA']);
  data.push(['ID Reserva', 'comPlataforma', 'comGTC', 'limpieza', 'amenities', 'irpf', 'pasarela', 'pasarelaRate', 'conceptosEspeciales', 'conceptosSinIVA', 'validated']);
  let reservaRows = buildReservaConfigRows();
  reservaRows.forEach(function(row) { data.push(row); });
  return data;
}

// Load or create the Configuracion tab
/**
 * @description Carga o crea la pestaÃƒÆ’Ã‚Â±a "Configuracion" del Google Sheet.
 * Esta pestaÃƒÆ’Ã‚Â±a almacena todas las opciones globales y ajustes por reserva.
 * Si no existe, la crea con los datos actuales.
 * @param {string} sheetId - ID del spreadsheet
 */
async function loadOrCreateConfigTab(sheetId) {
  if (!_googleToken) return;
  _configLoaded = false;
  try {
    console.log('[Config] Loading config tab...');
    const meta = await gapi.client.sheets.spreadsheets.get({
      spreadsheetId: sheetId,
      fields: 'sheets.properties.title'
    });
    const tabExists = meta.result.sheets.some(function(s) {
      return s.properties.title === CONFIG_TAB_NAME;
    });

    if (tabExists) {
      const resp = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sheetId,
        range: CONFIG_TAB_NAME + '!A1:K' + CONFIG.MAX_CONFIG_ROWS,
        valueRenderOption: 'UNFORMATTED_VALUE'
      });
      const rows = resp.result.values || [];
      applyConfigFromRows(rows);
      _configLoaded = true;
      console.log('[Config] Loaded config from "' + CONFIG_TAB_NAME + '" tab (' + rows.length + ' rows)');

      // Migration: if config didn't have 'validated' column, save now to persist
      // validations that were read from the data sheet column
      if (!applyConfigFromRows._hadValidatedCol && validated.size > 0) {
        console.log('[Config] Migrating ' + validated.size + ' validations from data sheet to Configuracion...');
        try {
          const data = buildFullConfigTabData();
          await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: sheetId,
            range: CONFIG_TAB_NAME + '!A1',
            valueInputOption: 'RAW',
            resource: { values: data }
          });
          const clearFrom = data.length + 1;
          await gapi.client.sheets.spreadsheets.values.clear({
            spreadsheetId: sheetId,
            range: CONFIG_TAB_NAME + '!A' + clearFrom + ':K' + CONFIG.MAX_CONFIG_ROWS
          }).catch(function() {});
          console.log('[Config] Migration complete: ' + validated.size + ' validations saved to Configuracion');
        } catch(me) {
          console.warn('[Config] Migration save failed:', me);
        }
      }
    } else {
      await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: sheetId,
        resource: {
          requests: [{ addSheet: { properties: { title: CONFIG_TAB_NAME } } }]
        }
      });
      const data = buildFullConfigTabData();
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: sheetId,
        range: CONFIG_TAB_NAME + '!A1',
        valueInputOption: 'RAW',
        resource: { values: data }
      });
      _configLoaded = true;
      console.log('[Config] Created "' + CONFIG_TAB_NAME + '" tab with ' + data.length + ' rows');
    }
  } catch(e) {
    console.warn('[Config] Error loading/creating config tab:', e);
  }
}

// Parse config rows and apply to app state
function applyConfigFromRows(rows) {
  if (!rows || rows.length < 4) return;

  let globalStart = -1, reservaHeaderRow = -1;
  for (let i = 0; i < rows.length; i++) {
    const cell = String(rows[i][0] || '').trim();
    if (cell === 'Clave' && globalStart === -1) { globalStart = i + 1; }
    if (cell === 'ID Reserva') { reservaHeaderRow = i; break; }
  }

  // Parse global options
  if (globalStart >= 0) {
    const endRow = reservaHeaderRow > 0 ? reservaHeaderRow : rows.length;
    let newPlatformOptions = {};
    let newPasStripe = null, newPasBooking = null, newLimpieza = null;
    let newIrpf = null, newGtc = null, newAmenities = null;

    for (let i = globalStart; i < endRow; i++) {
      const key = String(rows[i][0] || '').trim();
      const val = String(rows[i][1] || '').trim();
      if (!key || !val) continue;

      if (key.startsWith('plataforma:')) {
        const platName = key.substring(11);
        const nums = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
        if (nums.length > 0) newPlatformOptions[platName] = nums;
      } else if (key === 'pasarela_stripe') {
        newPasStripe = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'pasarela_booking') {
        newPasBooking = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'limpieza') {
        newLimpieza = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'irpf') {
        newIrpf = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'gtc') {
        newGtc = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'amenities') {
        newAmenities = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'mantenimiento') {
        const newMaint = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
        if (newMaint.length > 0) maintenanceOptions = newMaint;
      } else if (key === 'gtc_split') {
        const splitList = val.split(',').map(function(v) { return v.trim(); }).filter(Boolean);
        if (splitList.length > 0) _gtcSplitAlojamientos = splitList;
      } else if (key === 'gtc_owned') {
        const ownedList = val.split(',').map(function(v) { return v.trim(); }).filter(Boolean);
        if (ownedList.length > 0) _gtcOwnedAlojamientos = ownedList;
      } else if (key.startsWith('maint:')) {
        const maintAloj = key.substring(6);
        const parts = val.split(',');
        _consolMaint[maintAloj] = { enabled: parts[0] === '1', amount: parseFloat(parts[1]) || maintenanceOptions[0] };
      } else if (key.startsWith('extras:')) {
        const extAloj = key.substring(7);
        try { _consolExtras[extAloj] = JSON.parse(val); } catch(e) { _consolExtras[extAloj] = []; }
      }
    }

    // Apply global options (merge with platforms from data)
    if (Object.keys(newPlatformOptions).length > 0) {
      Object.keys(platformOptions).forEach(function(p) {
        if (!newPlatformOptions[p]) newPlatformOptions[p] = platformOptions[p];
      });
      platformOptions = newPlatformOptions;
    }
    if (newPasStripe && newPasStripe.length > 0) pasarelaStripeOptions = newPasStripe;
    if (newPasBooking && newPasBooking.length > 0) pasarelaBookingOptions = newPasBooking;
    if (newLimpieza && newLimpieza.length > 0) cleaningOptions = newLimpieza;
    if (newIrpf && newIrpf.length > 0) irpfOptions = newIrpf;
    if (newGtc && newGtc.length > 0) gtcOptions = newGtc;
    if (newAmenities !== null && newAmenities.length > 0) amenitiesOptions = newAmenities;

    console.log('[Config] Applied global options: ' + Object.keys(platformOptions).length + ' plataformas');
  }

  // Parse per-reservation settings
  if (reservaHeaderRow >= 0) {
    // Detect column positions from header row (backwards compatible)
    const hdr = rows[reservaHeaderRow].map(function(c) { return String(c || '').trim(); });
    const colMap = {};
    hdr.forEach(function(name, idx) { colMap[name] = idx; });
    const idCol = colMap['ID Reserva'] !== undefined ? colMap['ID Reserva'] : 0;
    const cpCol = colMap['comPlataforma'];
    const cgCol = colMap['comGTC'];
    const lmCol = colMap['limpieza'];
    const amCol = colMap['amenities'];
    const irCol = colMap['irpf'];
    const paCol = colMap['pasarela'];
    const prCol = colMap['pasarelaRate'];
    const ceCol = colMap['conceptosEspeciales'];
    const ce2Col = colMap['conceptosSinIVA'];
    const valCol = colMap['validated'];

    const reservaMap = {};
    allReservas.forEach(function(r) { reservaMap[r.id] = r.idx; });

    // If config has validated column, it overrides the data sheet column
    let hasConfigValidation = valCol !== undefined;
    if (hasConfigValidation) {
      validated = new Set(); // reset â€” config is authoritative
    }
    applyConfigFromRows._hadValidatedCol = hasConfigValidation;

    let applied = 0;
    for (let i = reservaHeaderRow + 1; i < rows.length; i++) {
      const id = String(rows[i][idCol] || '').trim();
      if (!id) continue;
      let rIdx = reservaMap[id];
      if (rIdx === undefined) continue;

      let s = settings[rIdx];
      if (!s) continue;

      if (cpCol !== undefined) { let v = rows[i][cpCol]; if (v !== undefined && v !== '') s.comPlataforma = parseFloat(v); }
      if (cgCol !== undefined) { let v = rows[i][cgCol]; if (v !== undefined && v !== '') s.comGTC = parseFloat(v); }
      if (lmCol !== undefined) { let v = rows[i][lmCol]; if (v !== undefined && v !== '') s.limpieza = parseFloat(v); }
      if (amCol !== undefined) { let v = rows[i][amCol]; if (v !== undefined && v !== '') { const av = parseFloat(v); if (!isNaN(av) && amenitiesOptions.some(function(o){return Math.abs(o-av)<0.001;})) s.amenities = av; } }
      if (irCol !== undefined) { let v = rows[i][irCol]; if (v !== undefined && v !== '') s.irpf = parseFloat(v); }
      if (paCol !== undefined) { let v = rows[i][paCol]; if (v !== undefined && v !== '') s.pasarela = String(v).trim() === 'true'; }
      if (prCol !== undefined) { let v = rows[i][prCol]; if (v !== undefined && v !== '') s.pasarelaRate = parseFloat(v); }
      if (ceCol !== undefined) { let v = String(rows[i][ceCol] || '').trim(); if (v) { try { const parsed = JSON.parse(v); if (Array.isArray(parsed)) s.conceptosEspeciales = parsed.filter(function(item){return item && typeof item.amount === 'number';}); } catch(e) { console.warn('[Config] Invalid CE JSON for row', i, e.message); } } }
      if (ce2Col !== undefined) { let v = String(rows[i][ce2Col] || '').trim(); if (v) { try { const parsed = JSON.parse(v); if (Array.isArray(parsed)) s.conceptosSinIVA = parsed.filter(function(item){return item && typeof item.amount === 'number';}); } catch(e) { console.warn('[Config] Invalid CE2 JSON for row', i, e.message); } } }
      if (valCol !== undefined) { let v = String(rows[i][valCol] || '').trim(); if (v === 'true') validated.add(rIdx); }

      applied++;
    }
    console.log('[Config] Applied per-reservation settings: ' + applied + ' reservas' + (hasConfigValidation ? ' (validated from config: ' + validated.size + ')' : ''));

    // Sanitize: reset any amenities value that isn't in amenitiesOptions
    let sanitized = 0;
    allReservas.forEach(function(r) {
      let s = settings[r.idx];
      if (s && s.amenities !== undefined && !amenitiesOptions.some(function(o){return Math.abs(o-s.amenities)<0.001;})) {
        s.amenities = amenitiesOptions[0];
        sanitized++;
      }
    });
    if (sanitized > 0) console.log('[Config] Sanitized ' + sanitized + ' reservas with invalid amenities value');
  }

  // Rebuild caches after applying config
  rebuildSelectCache();
  invalidateCache();
}

// Save full global config to sheet (write-first for safety)
/**
 * @description Guarda toda la configuraciÃƒÆ’Ã‚Â³n en la pestaÃƒÆ’Ã‚Â±a "Configuracion".
 * Usa patrÃƒÆ’Ã‚Â³n write-first: escribe datos nuevos ANTES de limpiar obsoletos.
 * Esto garantiza que si la limpieza falla, los datos ya estÃƒÆ’Ã‚Â¡n salvados.
 */
async function saveGlobalConfigToSheet() {
  if (!_sheetSource || !_googleToken || !_configLoaded) return;
  updateSyncIndicator('syncing');
  try {
    let data = buildFullConfigTabData();
    // Write new data first (safe: if clear fails, data is already saved)
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A1',
      valueInputOption: 'RAW',
      resource: { values: data }
    });
    // Clear any stale rows below the new data
    const clearFrom = data.length + 1;
    await gapi.client.sheets.spreadsheets.values.clear({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A' + clearFrom + ':K' + CONFIG.MAX_CONFIG_ROWS
    }).catch(function(e) { console.warn('[Config] Non-critical: clear stale rows failed', e); });
    updateSyncIndicator('saved');
    console.log('[Config] Saved full config (' + data.length + ' rows)');
  } catch(e) {
    console.error('[Config] Error saving config:', e);
    updateSyncIndicator('error');
  }
}

// Flush pending per-reservation config saves (write-first for safety)
async function flushReservaConfigSaves() {
  if (!_sheetSource || !_googleToken || !_configLoaded) return;
  if (_pendingReservaConfigSaves.size === 0) return;

  const indices = [..._pendingReservaConfigSaves];
  _pendingReservaConfigSaves.clear();

  updateSyncIndicator('syncing');
  try {
    let data = buildFullConfigTabData();
    // Write new data first (safe: if clear fails, data is already saved)
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A1',
      valueInputOption: 'RAW',
      resource: { values: data }
    });
    // Clear any stale rows below the new data
    const clearFrom = data.length + 1;
    await gapi.client.sheets.spreadsheets.values.clear({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A' + clearFrom + ':K' + CONFIG.MAX_CONFIG_ROWS
    }).catch(function(e) { console.warn('[Config] Non-critical: clear stale rows failed', e); });
    updateSyncIndicator('saved');
    console.log('[Config] Saved config for ' + indices.length + ' reserva(s)');
  } catch(e) {
    console.error('[Config] Error saving reserva config:', e);
    updateSyncIndicator('error');
  }
}

// === SHEET HISTORY ===
function addToSheetHistory(sheetId, name, sheetTab) {
  _sheetHistory = _sheetHistory.filter(h => h.id !== sheetId || h.tab !== sheetTab);
  _sheetHistory.unshift({ id: sheetId, name, tab: sheetTab, date: new Date().toISOString() });
  if (_sheetHistory.length > CONFIG.SHEET_HISTORY_MAX) _sheetHistory = _sheetHistory.slice(0, CONFIG.SHEET_HISTORY_MAX);
  SafeStorage.set('gsheet-history', JSON.stringify(_sheetHistory));
  renderSheetHistory();
}
function removeFromHistory(idx) {
  _sheetHistory.splice(idx, 1);
  SafeStorage.set('gsheet-history', JSON.stringify(_sheetHistory));
  renderSheetHistory();
}
function renderSheetHistory() {
  const container = document.getElementById('gsheet-history');
  const list = document.getElementById('gsheet-history-list');
  if (!container || !list) return;
  if (!_sheetHistory.length) { container.style.display = 'none'; return; }
  container.style.display = '';
  list.innerHTML = '';
  _sheetHistory.forEach((h, i) => {
    const d = new Date(h.date);
    const dateStr = d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' });
    const canLoad = !!_googleToken;
    const item = document.createElement('div');
    item.className = 'gsheet-history-item';
    if (!canLoad) item.style.cssText = 'opacity:0.5;cursor:default;';
    item.innerHTML = '<div><div class="name">&#128202; ' + (h.name || h.id) + '</div><div class="meta">' + dateStr + (h.tab ? ' &middot; ' + h.tab : '') + '</div></div>';
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.title = 'Eliminar';
    removeBtn.innerHTML = '&#10005;';
    removeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeFromHistory(i); });
    item.appendChild(removeBtn);
    if (canLoad) {
      item.addEventListener('click', () => loadSheetById(h.id, h.name || h.id));
    }
    list.appendChild(item);
  });
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  [M06b-SYNC] MULTI-USER SYNC â€” Polling Configuracion tab for remote changes
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

let _syncEnabled = false;
let _syncTimerId = null;
let _syncBusy = false;
let _syncLastPoll = 0;

function startSync() {
  if (_syncEnabled) return;
  if (!_sheetSource || !_googleToken || !_configLoaded) {
    console.warn('[Sync] Cannot start: no sheet/token/config');
    return;
  }
  _syncEnabled = true;
  _syncLastPoll = Date.now();
  SafeStorage.set('sync-enabled', 'true');
  _scheduleSyncPoll();
  _updateSyncToggleUI();
  console.log('[Sync] Multi-user sync started (interval: ' + CONFIG.SYNC_POLL_INTERVAL + 'ms)');
}

function stopSync() {
  _syncEnabled = false;
  SafeStorage.set('sync-enabled', 'false');
  if (_syncTimerId) { clearTimeout(_syncTimerId); _syncTimerId = null; }
  _updateSyncToggleUI();
  console.log('[Sync] Multi-user sync stopped');
}

function toggleSync() {
  if (_syncEnabled) stopSync(); else startSync();
}

function _scheduleSyncPoll() {
  if (!_syncEnabled) return;
  if (_syncTimerId) clearTimeout(_syncTimerId);
  _syncTimerId = setTimeout(_doSyncPoll, CONFIG.SYNC_POLL_INTERVAL);
}

async function _doSyncPoll() {
  _syncTimerId = null;
  if (!_syncEnabled || !_sheetSource || !_googleToken || !_configLoaded) {
    _scheduleSyncPoll();
    return;
  }
  if (_pendingReservaConfigSaves.size > 0 || _reservaConfigSaveTimer) {
    console.log('[Sync] Skipping poll \u2014 local save pending');
    _scheduleSyncPoll();
    return;
  }
  if (_syncBusy) return;
  _syncBusy = true;

  try {
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A1:K' + CONFIG.MAX_CONFIG_ROWS,
      valueRenderOption: 'UNFORMATTED_VALUE'
    });
    const rows = resp.result.values || [];
    const deltas = _computeSyncDeltas(rows);
    if (deltas.totalChanges > 0) {
      _applySyncDeltas(deltas, rows);
      console.log('[Sync] Applied ' + deltas.totalChanges + ' remote change(s)');
    }
    _syncLastPoll = Date.now();
  } catch(e) {
    console.warn('[Sync] Poll error:', e.message || e);
  } finally {
    _syncBusy = false;
    _scheduleSyncPoll();
  }
}

function _computeSyncDeltas(rows) {
  const result = {
    settingsChanged: [],
    validationChanged: [],
    globalChanged: false,
    totalChanges: 0
  };

  if (!rows || rows.length < 4) return result;

  let reservaHeaderRow = -1;
  for (let i = 0; i < rows.length; i++) {
    if (String(rows[i][0] || '').trim() === 'ID Reserva') { reservaHeaderRow = i; break; }
  }
  if (reservaHeaderRow < 0) return result;

  const hdr = rows[reservaHeaderRow].map(function(c) { return String(c || '').trim(); });
  const colMap = {};
  hdr.forEach(function(name, ci) { colMap[name] = ci; });
  const idCol = colMap['ID Reserva'] !== undefined ? colMap['ID Reserva'] : 0;
  const cpCol = colMap['comPlataforma'];
  const cgCol = colMap['comGTC'];
  const lmCol = colMap['limpieza'];
  const amCol = colMap['amenities'];
  const irCol = colMap['irpf'];
  const paCol = colMap['pasarela'];
  const prCol = colMap['pasarelaRate'];
  const ceCol = colMap['conceptosEspeciales'];
  const ce2Col = colMap['conceptosSinIVA'];
  const valCol = colMap['validated'];

  const reservaMap = {};
  allReservas.forEach(function(r) { reservaMap[r.id] = r.idx; });

  for (let i = reservaHeaderRow + 1; i < rows.length; i++) {
    const id = String(rows[i][idCol] || '').trim();
    if (!id) continue;
    const rIdx = reservaMap[id];
    if (rIdx === undefined) continue;
    const s = settings[rIdx];
    if (!s) continue;

    const checks = [
      { col: cpCol, field: 'comPlataforma', parse: parseFloat },
      { col: cgCol, field: 'comGTC', parse: parseFloat },
      { col: lmCol, field: 'limpieza', parse: parseFloat },
      { col: amCol, field: 'amenities', parse: parseFloat },
      { col: irCol, field: 'irpf', parse: parseFloat },
      { col: prCol, field: 'pasarelaRate', parse: parseFloat },
    ];
    checks.forEach(function(chk) {
      if (chk.col === undefined) return;
      const remoteRaw = rows[i][chk.col];
      if (remoteRaw === undefined || remoteRaw === '') return;
      const remoteVal = chk.parse(remoteRaw);
      const localVal = s[chk.field];
      if (!isNaN(remoteVal) && localVal !== undefined && Math.abs(remoteVal - localVal) > 0.0001) {
        result.settingsChanged.push({ idx: rIdx, field: chk.field, oldVal: localVal, newVal: remoteVal });
      }
    });

    if (paCol !== undefined) {
      const remotePas = String(rows[i][paCol] || '').trim() === 'true';
      if (remotePas !== s.pasarela) {
        result.settingsChanged.push({ idx: rIdx, field: 'pasarela', oldVal: s.pasarela, newVal: remotePas });
      }
    }

    [{ col: ceCol, field: 'conceptosEspeciales' }, { col: ce2Col, field: 'conceptosSinIVA' }].forEach(function(chk) {
      if (chk.col === undefined) return;
      const remoteStr = String(rows[i][chk.col] || '').trim();
      const localStr = (s[chk.field] && s[chk.field].length > 0) ? JSON.stringify(s[chk.field]) : '';
      if (remoteStr !== localStr) {
        try {
          const parsed = remoteStr ? JSON.parse(remoteStr) : [];
          if (Array.isArray(parsed)) {
            result.settingsChanged.push({ idx: rIdx, field: chk.field, oldVal: s[chk.field], newVal: parsed });
          }
        } catch(e) { /* skip invalid JSON */ }
      }
    });

    if (valCol !== undefined) {
      const remoteValidated = String(rows[i][valCol] || '').trim() === 'true';
      const localValidated = validated.has(rIdx);
      if (remoteValidated !== localValidated) {
        result.validationChanged.push({ idx: rIdx, wasValidated: localValidated, nowValidated: remoteValidated });
      }
    }
  }

  // Check global config: maint/extras
  let globalStart = -1;
  for (let i = 0; i < rows.length; i++) {
    const cell = String(rows[i][0] || '').trim();
    if (cell === 'Clave' && globalStart === -1) { globalStart = i + 1; break; }
  }
  if (globalStart >= 0) {
    for (let i = globalStart; i < reservaHeaderRow; i++) {
      const key = String(rows[i][0] || '').trim();
      const val = String(rows[i][1] || '').trim();
      if (!key || !val) continue;
      if (key.startsWith('maint:')) {
        const aloj = key.substring(6);
        const parts = val.split(',');
        const rEnabled = parts[0] === '1';
        const rAmount = parseFloat(parts[1]) || 0;
        const local = _consolMaint[aloj];
        if (!local || local.enabled !== rEnabled || Math.abs(local.amount - rAmount) > 0.01) {
          result.globalChanged = true;
        }
      } else if (key.startsWith('extras:')) {
        const aloj = key.substring(7);
        const localStr = _consolExtras[aloj] ? JSON.stringify(_consolExtras[aloj]) : '[]';
        if (val !== localStr) result.globalChanged = true;
      }
    }
  }

  result.totalChanges = result.settingsChanged.length + result.validationChanged.length + (result.globalChanged ? 1 : 0);
  return result;
}

function _applySyncDeltas(deltas, rawRows) {
  let needRender = false;
  let needConsolRefresh = false;
  const changedIdxs = new Set();

  deltas.settingsChanged.forEach(function(d) {
    const s = settings[d.idx];
    if (!s) return;
    s[d.field] = d.newVal;
    invalidateCache(d.idx);
    changedIdxs.add(d.idx);
    needRender = true;
  });

  deltas.validationChanged.forEach(function(d) {
    if (d.nowValidated) validated.add(d.idx); else validated.delete(d.idx);
    changedIdxs.add(d.idx);
    needRender = true;
  });

  if (deltas.globalChanged && rawRows) {
    // Re-parse global config section from remote rows
    let globalStart = -1, reservaHdr = -1;
    for (let i = 0; i < rawRows.length; i++) {
      const cell = String(rawRows[i][0] || '').trim();
      if (cell === 'Clave' && globalStart === -1) globalStart = i + 1;
      if (cell === 'ID Reserva') { reservaHdr = i; break; }
    }
    if (globalStart >= 0 && reservaHdr > globalStart) {
      for (let i = globalStart; i < reservaHdr; i++) {
        const key = String(rawRows[i][0] || '').trim();
        const val = String(rawRows[i][1] || '').trim();
        if (!key || !val) continue;
        if (key.startsWith('maint:')) {
          const aloj = key.substring(6);
          const parts = val.split(',');
          _consolMaint[aloj] = { enabled: parts[0] === '1', amount: parseFloat(parts[1]) || maintenanceOptions[0] };
        } else if (key.startsWith('extras:')) {
          const aloj = key.substring(7);
          try { _consolExtras[aloj] = JSON.parse(val); } catch(e) { _consolExtras[aloj] = []; }
        }
      }
    }
    needConsolRefresh = true;
    needRender = true;
  }

  if (needRender) {
    _validatedVersion++;
    invalidateFilterCache();
    invalidateGlobalStats();
    _cachedFilteredStats = null;
    renderTable();

    if (needConsolRefresh || (document.getElementById('screen-consoldetail') &&
        document.getElementById('screen-consoldetail').classList.contains('active') && currentConsolAloj)) {
      viewConsolDetail(currentConsolAloj);
    }

    const nSet = deltas.settingsChanged.length;
    const nVal = deltas.validationChanged.length;
    const parts = [];
    if (nVal > 0) parts.push(nVal + ' validaci\u00F3n' + (nVal > 1 ? 'es' : ''));
    if (nSet > 0) parts.push(nSet + ' ajuste' + (nSet > 1 ? 's' : ''));
    if (deltas.globalChanged) parts.push('config global');
    showToast('\uD83D\uDD04 Sync: ' + parts.join(', ') + ' ' + (deltas.totalChanges > 1 ? t('sync.updatedPl') : t('sync.updated')), 'info', 4000);
  }
}

function _updateSyncToggleUI() {
  const btn = document.getElementById('sync-toggle-btn');
  if (!btn) return;
  const dot = btn.querySelector('.sync-toggle-dot');
  const label = btn.querySelector('.sync-toggle-label');
  if (_syncEnabled) {
    if (dot) dot.style.background = '#16a34a';
    if (label) label.textContent = t('sync.on');
    btn.title = t('sync.activeTitle') + ' (' + t('sync.on') + ' - ' + (CONFIG.SYNC_POLL_INTERVAL/1000) + 's)';
  } else {
    if (dot) dot.style.background = '#6b7280';
    if (label) label.textContent = t('sync.off');
    btn.title = t('sync.activateBtn');
  }
}

function _autoStartSyncIfReady() {
  if (_sheetSource && _googleToken && _configLoaded && allReservas.length > 0) {
    const pref = SafeStorage.get('sync-enabled');
    if (pref !== 'false') startSync();
  }
}

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M08] DATA_MODEL ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Estado de la aplicaciÃƒÆ’Ã‚Â³n y opciones globales
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

/**
 * @description Opciones de configuraciÃƒÆ’Ã‚Â³n editables por el usuario.
 * Cada array contiene los valores disponibles para los <select> de la UI.
 * Se persisten en la pestaÃƒÆ’Ã‚Â±a "Configuracion" del Google Sheet.
 *
 * platformOptions    ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ comisiones por plataforma (% sobre total con IVA)
 * pasarelaStripeOptions/pasarelaBookingOptions ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ tasa pasarela de pago (%)
 * cleaningOptions    ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ importes fijos de limpieza (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬)
 * irpfOptions        ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ tasas de retenciÃƒÆ’Ã‚Â³n IRPF (%)
 * gtcOptions         ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ tasas de gestiÃƒÆ’Ã‚Â³n GTC (%)
 * amenitiesOptions   ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ importes fijos de amenities (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬)
 * maintenanceOptions ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ importes fijos de mantenimiento mensual (ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬)
 */

// IVA constants now in CONFIG object
const IVA_RESERVA = CONFIG.IVA_RESERVA, IVA_SUBTOTAL = CONFIG.IVA_SUBTOTAL;
let amenitiesOptions = [7];

let platformOptions = {
  "Airbnb.com": [15.5], "Booking.com": [15, 17, 22], "Caddie Golf": [10],
  "Comercial": [10], "De Propietario": [0], "Frontex": [10],
  "Granadabeachgolf.com": [10], "Homeaway.com": [15], "Sport2event SL": [10],
};
let pasarelaStripeOptions = [1.3];
let pasarelaBookingOptions = [1.5];
let cleaningOptions = [100, 120];
let irpfOptions = [19, 24];
let gtcOptions = [20];
let maintenanceOptions = [80];

/**
 * @description Deducciones mensuales por alojamiento (mantenimiento).
 * Clave: nombre del alojamiento. Valor: { enabled: boolean, amount: number }
 * @type {Object.<string, {enabled: boolean, amount: number}>}
 */
let _consolMaint = {}; // { alojName: { enabled:true, amount:80 } }
let _consolExtras = {};
/**
 * @description Conceptos extraordinarios mensuales por alojamiento.
 * Clave: nombre alojamiento. Valor: array de { label: string, amount: number }
 * Se editan inline en la vista consoldetail y se persisten en Google Sheets.
 * @type {Object.<string, Array<{label: string, amount: number}>>}
 */

// Special 80/20 GTC split alojamientos
/**
 * @description Tasa de retenciÃƒÆ’Ã‚Â³n GTC para propiedades con mÃƒÆ’Ã‚Â­nimo garantizado.
 * GTC retiene 20% del subtotal de reservas, el propietario recibe el 80%.
 * @const {number}
 */
const GTC_SPLIT_RATE = 0.20; // GTC retains 20%, owner gets 80%
let _gtcSplitAlojamientos = ['MA-2-P2-1A','MA-2-P3-1C','MA-2-P3-1D','MA-2-P3-1E','MA-2-P4-1C','MG-2-0D'];
let _gtcOwnedAlojamientos = [
  'MA-2-P1-4C','MA-2-P1-1C','MA-2-P2-1A','MA-2-P3-1B','MA-2-P3-1C','MA-2-P3-1D','MA-2-P3-1E',
  'MA-2-P4-1A','MA-2-P4-1B','MA-2-P4-1C','MG-2-0D','MG-2-0F','MG-2-0I','MG-2-1F',
  'MG-2-1K','MG-2-1M','MG-2-1N','MG-2-2N','MG-2-3L','MG-3-0C'
];
/**
 * @description Comprueba si un alojamiento tiene reparto 80/20 GTC.
 * @param {string} alojName - Nombre del alojamiento
 * @returns {boolean} true si tiene condiciÃƒÆ’Ã‚Â³n especial de mÃƒÆ’Ã‚Â­nimo garantizado
 */
function isGtcSplit(alojName) { return _gtcSplitAlojamientos.some(function(a){ return alojName === a || alojName.indexOf(a) !== -1; }); }
/**
 * @description Comprueba si un alojamiento es propiedad de GTC.
 * @param {string} alojName - Nombre del alojamiento
 * @returns {boolean} true si es propiedad de GTC
 */
function isGtcOwned(alojName) { return _gtcOwnedAlojamientos.some(function(a){ return alojName === a || alojName.indexOf(a) !== -1; }); }

function getConsolMaint(alojName) {
  if (!_consolMaint[alojName]) _consolMaint[alojName] = { enabled: true, amount: maintenanceOptions[0] };
  return _consolMaint[alojName];
}
function getConsolExtras(alojName) {
  if (!_consolExtras[alojName]) _consolExtras[alojName] = [];
  return _consolExtras[alojName];
}
function getConsolDeductions(alojName) {
  let m = getConsolMaint(alojName);
  let extras = getConsolExtras(alojName);
  let maintBase = m.enabled ? m.amount : 0;
  let extrasTotal = extras.reduce(function(s,e){ return s + e.amount; }, 0);
  return { maintBase: maintBase, extrasTotal: extrasTotal, totalBase: maintBase + extrasTotal };
}

let allReservas = [], settings = {}, validated = new Set(), _lastFiltered = [];
let currentConsolAloj = null, currentDetailIdx = null;
// Google Sheets write-back state
/**
 * @description Fuente de datos Google Sheets para write-back.
 * null cuando se cargÃƒÆ’Ã‚Â³ desde fichero local. Contiene:
 *   .id           - ID del spreadsheet
 *   .tab          - Nombre de la pestaÃƒÆ’Ã‚Â±a de datos
 *   .valColIdx    - ÃƒÆ’Ã‚Ândice de la columna "Validada"
 *   .valColLetter - Letra de la columna (ej: "Q")
 *   .headerRow    - ÃƒÆ’Ã‚Ândice de la fila de cabecera
 * @type {Object|null}
 */
let _sheetSource = null; // null when loaded from file
let _syncQueue = []; // pending write operations
let _syncActive = false; // true while a write is in flight
// Performance: liquidation cache + pagination + render debouncing
let _pageSize = CONFIG.DEFAULT_PAGE_SIZE;
let _liqCache = {}, _currentPage = 1, _fmtCache = {};
/**
 * @description Invalida la cachÃƒÆ’Ã‚Â© de cÃƒÆ’Ã‚Â¡lculos.
 * @param {number} [idx] - Si se pasa, invalida solo esa reserva. Sin param = invalida todo.
 */
function invalidateCache(idx) { if (idx !== undefined) { delete _liqCache[idx]; } else { _liqCache = {}; invalidateGlobalStats(); invalidateFilterCache(); } }
/**
 * @description Obtiene los cÃƒÆ’Ã‚Â¡lculos de liquidaciÃƒÆ’Ã‚Â³n de una reserva (con cachÃƒÆ’Ã‚Â©).
 * @param {Object} r - Objeto reserva de allReservas[]
 * @returns {Object} Resultado de calcLiquidacion() (cacheado)
 */
function getLiq(r) {
  const idx = r.idx;
  if (_liqCache[idx]) return _liqCache[idx];
  _liqCache[idx] = calcLiquidacion(r, settings[idx] || {});
  return _liqCache[idx];
}
// Debounced render via requestAnimationFrame - coalesces multiple renderTable calls into one frame
let _renderRafId = 0, _renderMode = 'full'; // 'full' | 'append'
function scheduleRender(mode) {
  // 'full' overrides 'append'; 'append' only if no pending full
  if (mode === 'full' || _renderMode === 'full') _renderMode = 'full';
  else _renderMode = mode || 'full';
  if (_renderRafId) return; // already scheduled
  _renderRafId = requestAnimationFrame(() => {
    _renderRafId = 0;
    const m = _renderMode; _renderMode = 'full';
    if (m === 'append') _renderPageOnly();
    else _renderFull();
  });
}
// Cached filter+sort result \u2014 invalidated on filter/sort/data changes, NOT on pagination
let _cachedFiltered = null, _filterSortKey = '', _validatedVersion = 0;
let _searchText = '', _searchTextConsol = '';
let _consolValToggle = 'noval'; // 'noval' | 'val' | null (default: No Validadas primero)
function getFilterSortKey() {
  const pKey = [...comboState.platform.selected].sort().join(',') || 'all';
  const aKey = [...comboState.aloj.selected].sort().join(',') || 'all';
  return pKey + '|' + aKey + '|' + [..._mpSelYears].sort().join(',') + '|' + [..._mpSelMonths].sort().join(',') + '|' +
    simpleComboState.status.value + '|' + simpleComboState.sort.value + '|' +
    simpleComboState.sortdir.value + '|' + _validatedVersion + '|' + allReservas.length + '|' + _searchText;
}
function invalidateFilterCache() { _cachedFiltered = null; _filterSortKey = ''; _cachedFilteredStats = null; }
/**
 * @description Obtiene las reservas filtradas y ordenadas segÃƒÆ’Ã‚Âºn los filtros activos.
 * Usa cachÃƒÆ’Ã‚Â©: solo recalcula si los filtros han cambiado.
 * @returns {Array} Array de reservas que pasan todos los filtros
 */
function getFilteredSorted() {
  const key = getFilterSortKey();
  if (_cachedFiltered && _filterSortKey === key) return _cachedFiltered;
  const pSel = comboState.platform.selected, aSel = comboState.aloj.selected;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value, sortD = simpleComboState.sortdir.value;
  let fil = allReservas.filter(r => {
    if (pSel.size > 0 && !pSel.has(r.plataforma)) return false;
    if (aSel.size > 0 && !aSel.has(r.alojamiento)) return false;
    if (_mpSelYears.size > 0 && !_mpMatchDate(r._dEntrada)) return false;
    if (sf2 === "validated" && !validated.has(r.idx)) return false;
    if (sf2 === "pending" && validated.has(r.idx)) return false;
    if (_searchText) {
      const s = _searchText;
      const c = getLiq(r);
      const fTotal = fmt(r.totalReserva), fLiq = fmt(c.totalLiq), fBase = fmt(c.baseSinIVA), fSub = fmt(c.sub);
      if (!(r._clienteLc.includes(s) || r._alojLc.includes(s) || r._platLc.includes(s) ||
            r.id.toLowerCase().includes(s) || r.localizador.toLowerCase().includes(s) ||
            (r.edificio||'').toLowerCase().includes(s) || (r.atendidoPor||'').toLowerCase().includes(s) ||
            (r.origenMarketing||'').toLowerCase().includes(s) || (r.observacion||'').toLowerCase().includes(s) ||
            (r.tipoReserva||'').toLowerCase().includes(s) ||
            r._fmtEntrada.includes(s) || r._fmtSalida.includes(s) || r._fmtAlta.includes(s) ||
            fTotal.includes(s) || fLiq.includes(s) || fBase.includes(s) || fSub.includes(s) ||
            String(r.totalReserva).includes(s) || String(r._nights) === s)) return false;
    }
    return true;
  });
  fil.sort((a, b) => {
    let va = getSortValue(a, sortF), vb = getSortValue(b, sortF);
    if (typeof va === "string") return sortD === "asc" ? va.localeCompare(vb) : vb.localeCompare(va);
    return sortD === "asc" ? va - vb : vb - va;
  });
  _cachedFiltered = fil;
  _filterSortKey = key;
  return fil;
}
// Pre-computed select option strings (rebuilt when config changes)
let _selectCache = {};
function rebuildSelectCache() {
  _selectCache = {};
  // Platform options per platform name
  Object.keys(platformOptions).forEach(name => {
    const opts = platformOptions[name];
    _selectCache['plat_' + name] = opts.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  });
  // GTC
  _selectCache.gtc = gtcOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  // Cleaning
  _selectCache.clean = cleaningOptions.map(o => `<option value="${o}">${o} \u20AC</option>`).join('');
  // Amenities
  _selectCache.amenities = amenitiesOptions.map(o => `<option value="${o}">${o} \u20AC</option>`).join('');
  // IRPF
  _selectCache.irpf = irpfOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  // Pasarela
  _selectCache.pasStripe = pasarelaStripeOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  _selectCache.pasBooking = pasarelaBookingOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
}
function selectWithValue(html, val) {
  // Set selected on matching option via string replace (fast)
  const needle = `value="${val}"`;
  return html.replace(needle, needle + ' selected');
}
function selectCleanWithValue(html, val) {
  const needle = `value="${val}"`;
  return html.replace(needle, needle + ' selected');
}

// Fast number formatter (avoid toLocaleString which is ~50x slower)
function fmt(n) {
  const fixed = Math.abs(n).toFixed(2);
  const [int, dec] = fixed.split('.');
  // Add thousands separator (dot for es-ES)
  let result = '';
  for (let i = int.length - 1, c = 0; i >= 0; i--, c++) {
    if (c > 0 && c % 3 === 0) result = '.' + result;
    result = int[i] + result;
  }
  if (n < 0) result = '-' + result;
  return result + ',' + dec;
}
// Fast date formatter (avoid toLocaleDateString)
function fmtDate(d) {
  if (!d) return '\u2014';
  const dd = d.getDate(), mm = d.getMonth() + 1, yy = d.getFullYear();
  return (dd < 10 ? '0' : '') + dd + '/' + (mm < 10 ? '0' : '') + mm + '/' + yy;
}
function parseDate(val) {
  if (!val) return null;
  if (val instanceof Date) return val;
  if (typeof val === "number") return new Date((val - 25569) * 86400000);
  const s = String(val).trim();
  // DD/MM/YYYY or DD/MM/YY
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (m) { const y = m[3].length === 2 ? 2000 + parseInt(m[3]) : parseInt(m[3]); return new Date(y, parseInt(m[2])-1, parseInt(m[1])); }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function formatDate(val) {
  const d = parseDate(val);
  return d ? fmtDate(d) : (val ? String(val) : "\u2014");
}
function dateToNum(val) { const d = parseDate(val); return d ? d.getTime() : 0; }
function calcNights(e, s) {
  const a = parseDate(e), b = parseDate(s);
  if (!a || !b) return 0; return Math.max(0, Math.round((b - a) / 86400000));
}
/**
 * @description Parsea un valor a nÃƒÆ’Ã‚Âºmero, manejando formatos espaÃƒÆ’Ã‚Â±oles (1.234,56).
 * IMPORTANTE: Si v ya es number nativo (de Google Sheets API), lo devuelve directo.
 * @param {*} v - Valor a parsear (number, string, null)
 * @returns {number} Valor numÃƒÆ’Ã‚Â©rico (0 si no parseable)
 */
function parseNum(v) {
  if (v == null || v === '') return 0;
  if (typeof v === 'number') return isFinite(v) ? v : 0;
  var s = String(v).replace(/[^\d.,-]/g, '').replace(/\./g, '').replace(',', '.');
  return parseFloat(s) || 0;
}
function parseRate(v, min, max) {
  var n = parseNum(v);
  if (min !== undefined && n < min) n = min;
  if (max !== undefined && n > max) n = max;
  return n;
}
function getDefaultForPlatform(plat) { const o = platformOptions[plat]; return o && o.length ? o[o.length-1] / 100 : 0.10; }

/**
 * @description One-time migration: sets all non-validated Booking.com reservations
 * to the highest available commission percentage.
 * Only modifies reservations that haven't been validated yet.
 */
function _migrateBookingCommission() {
  const bookingOpts = platformOptions['Booking.com'];
  if (!bookingOpts || bookingOpts.length === 0) return;
  const maxRate = bookingOpts[bookingOpts.length - 1] / 100;
  let count = 0;
  allReservas.forEach(function(r) {
    if (r.plataforma !== 'Booking.com') return;
    if (validated[r.idx]) return;
    const s = settings[r.idx] || {};
    if (s.comPlataforma === maxRate) return;
    if (!settings[r.idx]) settings[r.idx] = {};
    settings[r.idx].comPlataforma = maxRate;
    invalidateCache(r.idx);
    _pendingReservaConfigSaves.add(r.idx);
    count++;
  });
  if (count > 0) {
    console.log('[Migration] Booking commission set to ' + (maxRate*100) + '% for ' + count + ' non-validated reservations');
    showToast('Booking: ' + count + ' ' + t('stats.reservationCount') + ' ' + t('sync.updatedPl') + ' ' + (maxRate*100) + '%', 'info', 4000);
    // Schedule save of all modified reservations
    if (_reservaConfigSaveTimer) clearTimeout(_reservaConfigSaveTimer);
    _reservaConfigSaveTimer = setTimeout(flushReservaConfigSaves, 2000);
  }
}

/**
 * @description Calcula la liquidaciÃƒÆ’Ã‚Â³n completa de una reserva.
 * Este es el CORAZÃƒÆ’Ã¢â‚¬Å“N del sistema de cÃƒÆ’Ã‚Â¡lculo financiero.
 *
 * @param {Object} r - Objeto reserva de allReservas[]
 * @param {Object} s - Settings de la reserva (settings[r.idx])
 * @returns {Object} Objeto con todos los importes calculados:
 *   .totalOriginal - Importe original de la reserva
 *   .ceTotal       - Total de conceptos extraordinarios con IVA
 *   .total         - totalOriginal - ceTotal
 *   .baseSinIVA    - Base imponible sin IVA turÃƒÆ’Ã‚Â­stico (10%)
 *   .comRate       - Tasa de comisiÃƒÆ’Ã‚Â³n de plataforma aplicada
 *   .comPlat       - Importe comisiÃƒÆ’Ã‚Â³n plataforma
 *   .gtcRate       - Tasa de gestiÃƒÆ’Ã‚Â³n GTC aplicada
 *   .comGTC        - Importe comisiÃƒÆ’Ã‚Â³n GTC
 *   .comPas        - Importe comisiÃƒÆ’Ã‚Â³n pasarela (0 si desactivada)
 *   .limp          - Importe limpieza
 *   .amen          - Importe amenities
 *   .ceSinIvaTotal - Total conceptos extraordinarios sin IVA
 *   .sub           - Subtotal (base - todas las deducciones)
 *   .iva           - IVA 21% sobre subtotal
 *   .irpfRate      - Tasa IRPF aplicada
 *   .ret           - RetenciÃƒÆ’Ã‚Â³n IRPF
 *   .totalLiq      - TOTAL A LIQUIDAR (sub + iva - ret)
 */
function calcLiquidacion(r, s) {
  if (!r) return { totalOriginal:0, ceTotal:0, total:0, baseSinIVA:0, comRate:0, comPlat:0, gtcRate:0, comGTC:0, comPas:0, limp:0, amen:0, ceSinIvaTotal:0, sub:0, iva:0, irpfRate:0, ret:0, totalLiq:0 };
  const totalOriginal = r.totalReserva || 0;
  const ce = (s.conceptosEspeciales && s.conceptosEspeciales.length > 0) ? s.conceptosEspeciales : [];
  const ceTotal = ce.reduce(function(sum, item) { return sum + (item.amount || 0); }, 0);
  const total = totalOriginal - ceTotal;
  const baseSinIVA = total / (1 + IVA_RESERVA);
  let comRate = s.comPlataforma !== undefined ? s.comPlataforma : getDefaultForPlatform(r.plataforma);
  const comPlat = total * comRate;
  const gtcRate = s.comGTC !== undefined ? s.comGTC : gtcOptions[0]/100;
  const comGTC = baseSinIVA * gtcRate;
  let comPas = 0;
  if (s.pasarela) {
    const isB = r.plataforma === "Booking.com";
    const pr = s.pasarelaRate !== undefined ? s.pasarelaRate : (isB ? pasarelaBookingOptions[pasarelaBookingOptions.length-1]/100 : pasarelaStripeOptions[pasarelaStripeOptions.length-1]/100);
    comPas = total * pr;
  }
  const limp = s.limpieza !== undefined ? s.limpieza : cleaningOptions[0];
  const rawAmen = s.amenities;
  const amen = (rawAmen !== undefined && amenitiesOptions.some(function(o){return Math.abs(o-rawAmen)<0.001;})) ? rawAmen : amenitiesOptions[0];
  const ce2 = (s.conceptosSinIVA && s.conceptosSinIVA.length > 0) ? s.conceptosSinIVA : [];
  const ceSinIvaTotal = ce2.reduce(function(sum, item) { return sum + (item.amount || 0); }, 0);
  const sub = baseSinIVA - comPlat - comGTC - comPas - limp - amen - ceSinIvaTotal;
  const irpfRate = s.irpf !== undefined ? s.irpf : irpfOptions[0]/100;
  const iva = sub * IVA_SUBTOTAL, ret = sub * irpfRate;
  return { totalOriginal, ceTotal, total, baseSinIVA, comRate, comPlat, gtcRate, comGTC, comPas, limp, amen, ceSinIvaTotal, sub, iva, irpfRate, ret, totalLiq: sub + iva - ret };
}

// \u2500\u2500\u2500 FILE \u2500\u2500\u2500
function isHtmlFile(buf) {
  // Detect HTML-based .xls (Avantio exports): first bytes contain "<html" or start with whitespace+<
  const head = new TextDecoder("utf-8").decode(buf.slice(0, 200)).trim().toLowerCase();
  return head.startsWith("<html") || head.startsWith("<!doctype") || head.includes("<html");
}

function parseHtmlXls(text) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(text, "text/html");
  const trs = doc.querySelectorAll("table tr");
  const json = [];
  trs.forEach(tr => {
    const cells = [];
    tr.querySelectorAll("td, th").forEach(td => cells.push(td.textContent.trim()));
    json.push(cells);
  });
  return json;
}

/**
 * @description Procesa los datos crudos del Sheet/Excel y construye el modelo de datos.
 * Esta funciÃƒÆ’Ã‚Â³n es el PUNTO DE ENTRADA de datos en la aplicaciÃƒÆ’Ã‚Â³n.
 * Llena allReservas[], settings{}, validated Set, y construye los combos de filtro.
 *
 * @param {Array[]} json - Array de arrays (filas del Sheet). Primera fila ÃƒÆ’Ã‚Âºtil = cabecera.
 * @returns {boolean} true si se procesaron datos correctamente
 *
 * @sideeffects Modifica: allReservas, settings, validated, platformOptions,
 *              comboState, _mpAvailable, caches
 */
function processRows(json) {
  if (!json || !Array.isArray(json) || json.length < 2) {
    showToast("El archivo no contiene datos vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lidos.", "error");
    return false;
  }
  const headerRow = json.findIndex(r => r && r[0] && String(r[0]).includes("ID Reserva"));
  if (headerRow === -1) { showToast(t("msg.noHeader"), "error"); return false; }

  // Detect validation column in header
  const hdr = json[headerRow];
  let detectedValColIdx = null;
  for (let c = 0; c < (hdr ? hdr.length : 0); c++) {
    const h = String(hdr[c] || '').trim().toLowerCase();
    if (h === 'validada' || h === 'validado' || h === 'validated') { detectedValColIdx = c; break; }
  }

  // Build rows preserving original json row index (for sheet write-back)
  const dataStart = headerRow + 1;
  const allDataRows = json.slice(dataStart);
  const rowEntries = [];
  allDataRows.forEach((row, localIdx) => {
    if (row && row[0] && String(row[0]).trim().toLowerCase() !== 'total') {
      rowEntries.push({ data: row, jsonRow: dataStart + localIdx });
    }
  });

  allReservas = rowEntries.map((entry, idx) => {
    const row = entry.data;
    const r = {
      id: String(row[0]||""), localizador: String(row[1]||""), fechaAlta: row[2],
      alojamiento: String(row[3]||""), edificio: String(row[4]||""),
      plataforma: String(row[5]||"").trim() || "Granadabeachgolf.com",
      atendidoPor: String(row[6]||""), origenMarketing: String(row[7]||""),
      cliente: String(row[8]||""),
      tipoReserva: String(row[9]||""), fechaEntrada: row[10], fechaSalida: row[11],
      totalReserva: parseNum(row[12]), observacion: String(row[13]||""), idx,
      _sheetRow: entry.jsonRow + 1, // 1-indexed row in spreadsheet
    };
    const dE = parseDate(r.fechaEntrada), dS = parseDate(r.fechaSalida);
    const dA = parseDate(r.fechaAlta);
    r._dEntrada = dE; r._dSalida = dS; r._dAlta = dA;
    r._fmtEntrada = dE ? fmtDate(dE) : '\u2014';
    r._fmtSalida = dS ? fmtDate(dS) : '\u2014';
    r._fmtAlta = dA ? fmtDate(dA) : '\u2014';
    r._dateNum = dE ? dE.getTime() : 0;
    r._dateAltaNum = dA ? dA.getTime() : 0;
    r._nights = (dE && dS) ? Math.max(0, Math.round((dS - dE) / 86400000)) : 0;
    r._clienteLc = (r.cliente||"").toLowerCase();
    r._alojLc = (r.alojamiento||"").toLowerCase();
    r._platLc = (r.plataforma||"").toLowerCase();
    r._isBooking = r.plataforma === "Booking.com";
    return r;
  });
  settings = {}; validated = new Set();
  allReservas.forEach(r => {
    const isB = r.plataforma === "Booking.com";
    if (!platformOptions[r.plataforma]) platformOptions[r.plataforma] = [10];
    settings[r.idx] = {
      comPlataforma: getDefaultForPlatform(r.plataforma), comGTC: gtcOptions[0]/100,
      limpieza: cleaningOptions[0], amenities: amenitiesOptions[0], irpf: irpfOptions[0]/100, pasarela: false,
      pasarelaRate: isB ? pasarelaBookingOptions[pasarelaBookingOptions.length-1]/100 : pasarelaStripeOptions[pasarelaStripeOptions.length-1]/100,
      conceptosEspeciales: [],
      conceptosSinIVA: [],
    };
  });

  // Read validation state from sheet if column exists
  if (detectedValColIdx !== null) {
    allReservas.forEach((r, idx) => {
      const val = String(rowEntries[idx].data[detectedValColIdx] || '').trim().toLowerCase();
      if (val && (val === 's\u00ED' || val === 'si' || val === 'yes' || val === '1' || val === 'true' || val === 'x')) {
        validated.add(r.idx);
      }
    });
  }

  // Store metadata for sheet source setup (used by loadSheetData)
  processRows._lastResult = { valColIdx: detectedValColIdx, headerRow: headerRow };

  const plats = [...new Set(allReservas.map(r => r.plataforma))].sort();
  populateCombo('platform', plats);
  const alojs = [...new Set(allReservas.map(r => r.alojamiento))].sort();
  populateCombo('aloj', alojs);
  buildAvailableMonths();
  invalidateCache();
  invalidateAlojCache();
  rebuildSelectCache();
  // Phase 4: Reset AI context cache and alerts when data reloads
  if (typeof _aiContextCache !== 'undefined') _aiContextCache = { key: '', ctx: '', ts: 0 };
  if (typeof _aiAlertsShown !== 'undefined') _aiAlertsShown = false;
  _currentPage = 1;
  return true;
}

/**
 * @description Procesa un fichero Excel (.xlsx/.xls) cargado por el usuario.
 * Detecta si es HTML-based (Avantio) o XLSX real (SheetJS).
 * @param {File} file - Objeto File del input o drag&drop
 */
function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const buf = new Uint8Array(e.target.result);
    let json;
    if (isHtmlFile(buf)) {
      // HTML-based .xls (Avantio): parse as HTML to preserve original text values
      const text = new TextDecoder("utf-8").decode(buf);
      json = parseHtmlXls(text);
    } else {
      // Real .xlsx: use SheetJS
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      json = XLSX.utils.sheet_to_json(ws, { header: 1 });
    }
    if (!processRows(json)) return;
    _sheetSource = null; // not loaded from Google Sheets
    document.getElementById("file-name").textContent = file.name;
    document.getElementById("file-indicator").style.display = "block";
    document.getElementById("nav-consol").style.display = "block";
    showScreen("list"); renderTable();
  };
  reader.readAsArrayBuffer(file);
}

let _navigating = false;
/**
 * @description Cambia la pantalla activa de la SPA.
 * Gestiona la navegaciÃƒÆ’Ã‚Â³n entre las 5 vistas principales.
 * @param {string} name - Nombre de la pantalla: 'upload'|'list'|'detail'|'consol'|'consoldetail'
 */
function showScreen(name) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
  document.getElementById("screen-" + name).classList.add("active");
  document.getElementById("nav-" + name).classList.add("active");
  if (_previewActive) exitPreview();
  if (_navigating) return;
  _navigating = true;
  if (name === "list") renderTable();
  if (name === "consol") renderConsolGrid();
  if (name === "consoldetail" && currentConsolAloj) viewConsolDetail(currentConsolAloj);
  if (name === "detail" && currentDetailIdx !== null) viewDetail(currentDetailIdx);
  _navigating = false;
}

// \u2500\u2500\u2500 TABLE \u2500\u2500\u2500
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M11] TABLE_RENDER ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Tabla de preliquidaciÃƒÆ’Ã‚Â³n, columnas, paginaciÃƒÆ’Ã‚Â³n
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

/**
 * @description DefiniciÃƒÆ’Ã‚Â³n de columnas de la tabla principal de preliquidaciÃƒÆ’Ã‚Â³n.
 * Cada columna tiene: key (CSS class), label (cabecera HTML), sortable, right (alinear), locked.
 * Las columnas locked no se pueden ocultar desde el toggle de columnas.
 */
const COLUMNS = [
  { key:"estado",label:t("col.estado"),sortable:true,locked:true },
  { key:"idReserva",label:t("col.idReserva"),sortable:true },
  { key:"localizador",label:t("col.localizador"),sortable:true },
  { key:"fechaAlta",label:t("col.fechaAlta"),sortable:true },
  { key:"cliente",label:t("col.cliente"),sortable:true },
  { key:"alojamiento",label:t("col.alojamiento"),sortable:true },
  { key:"edificio",label:t("col.edificio"),sortable:true },
  { key:"plataforma",label:t("col.plataforma"),sortable:true },
  { key:"atendidoPor",label:t("col.atendidoPor"),sortable:true },
  { key:"origenMarketing",label:t("col.origenMarketing"),sortable:true },
  { key:"tipoReserva",label:t("col.tipoReserva"),sortable:true },
  { key:"fechaEntrada",label:t("col.fechaEntrada"),sortable:true },
  { key:"fechaSalida",label:t("col.fechaSalida"),sortable:true },
  { key:"noches",label:t("col.noches"),sortable:true },
  { key:"totalReserva",label:t("col.totalReserva"),sortable:true,right:true },
  { key:"ce",label:"C.E.<br>(IVA inc.)",sortable:false },
  { key:"baseSinIVA",label:t("col.baseSinIVA"),sortable:true,right:true },
  { key:"comPlataforma",label:t("col.comPlataforma"),sortable:false },
  { key:"comGTC",label:"Gesti\u00F3n<br>GTC",sortable:false },
  { key:"limpieza",label:t("col.limpieza"),sortable:false },
  { key:"amenities",label:t("col.amenities"),sortable:false },
  { key:"pasarela",label:"Pasarela",sortable:false },
  { key:"ceSinIva",label:"C.E.<br>(Sin IVA)",sortable:false },
  { key:"subtotal",label:t("col.subtotal"),sortable:true,right:true },
  { key:"irpf",label:"IRPF",sortable:false },
  { key:"iva21",label:"IVA 21%",sortable:false },
  { key:"totalLiquidar",label:t("col.totalLiquidar"),sortable:true,right:true,locked:true },
  { key:"observacion",label:t("col.observacion"),sortable:true },
  { key:"acciones",label:"",sortable:true,locked:true },
];
// Column visibility state
let colVisibility = {};
COLUMNS.forEach(c => { colVisibility[c.key] = true; });
// Hidden by default
colVisibility['irpf'] = false;
colVisibility['iva21'] = false;
colVisibility['subtotal'] = false;
colVisibility['idReserva'] = true;
colVisibility['localizador'] = false;
colVisibility['fechaAlta'] = false;
colVisibility['edificio'] = false;
colVisibility['atendidoPor'] = false;
colVisibility['origenMarketing'] = false;
colVisibility['tipoReserva'] = false;
colVisibility['observacion'] = false;
function isColVisible(key) { return colVisibility[key] !== false; }
function toggleColVisibility(key) {
  const col = COLUMNS.find(c => c.key === key);
  if (col && col.locked) return;
  colVisibility[key] = !colVisibility[key];
  updateColStyles(); renderTable(); renderColToggle();
}
function updateColStyles() {
  let css = '';
  COLUMNS.forEach(c => {
    if (!isColVisible(c.key)) css += '.col-' + c.key + ' { display: none !important; }\n';
  });
  document.getElementById('col-visibility-style').textContent = css;
}
function renderColToggle() {
  const dd = document.getElementById('col-toggle-dd');
  dd.innerHTML = COLUMNS.filter(c => c.label).map(c => {
    const checked = isColVisible(c.key) ? 'checked' : '';
    const locked = c.locked ? 'locked' : '';
    const dis = c.locked ? 'disabled' : '';
    return '<label class="col-toggle-item ' + locked + '"><input type="checkbox" ' + checked + ' ' + dis +
      ' onchange="toggleColVisibility(\'' + c.key + '\')"> ' + c.label + '</label>';
  }).join('');
}
function toggleColDropdown() {
  const dd = document.getElementById('col-toggle-dd');
  const isOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!isOpen) renderColToggle();
}

// \u2500\u2500\u2500 CONSOLIDATED TABLE: columns, sort, visibility \u2500\u2500\u2500
const CONSOL_COLUMNS = COLUMNS.filter(c => c.key !== 'alojamiento');
let consolColVis = {};
CONSOL_COLUMNS.forEach(c => { consolColVis[c.key] = true; });
consolColVis['irpf'] = false;
consolColVis['iva21'] = false;
consolColVis['subtotal'] = false;
consolColVis['idReserva'] = true;
consolColVis['localizador'] = false;
consolColVis['fechaAlta'] = false;
consolColVis['edificio'] = false;
consolColVis['atendidoPor'] = false;
consolColVis['origenMarketing'] = false;
consolColVis['tipoReserva'] = false;
consolColVis['observacion'] = false;
let consolSortF = 'idx', consolSortD = 'asc';
// Apply initial col visibility
setTimeout(updateConsolColStyles, 0);
setTimeout(updateColStyles, 0);

function isConsolColVis(key) { return consolColVis[key] !== false; }
function toggleConsolColVis(key) {
  const col = CONSOL_COLUMNS.find(c => c.key === key);
  if (col && col.locked) return;
  consolColVis[key] = !consolColVis[key];
  updateConsolColStyles();
}
function updateConsolColStyles() {
  let css = '';
  CONSOL_COLUMNS.forEach(c => {
    if (!isConsolColVis(c.key)) css += '.cc-' + c.key + ' { display: none !important; }\n';
  });
  document.getElementById('consol-col-visibility-style').textContent = css;
}
function renderConsolColToggle() {
  const dd = document.getElementById('consol-col-toggle-dd');
  if (!dd) return;
  dd.innerHTML = CONSOL_COLUMNS.filter(c => c.label).map(c => {
    const checked = isConsolColVis(c.key) ? 'checked' : '';
    const locked = c.locked ? 'locked' : '';
    const dis = c.locked ? 'disabled' : '';
    return '<label class="col-toggle-item ' + locked + '"><input type="checkbox" ' + checked + ' ' + dis +
      ' onchange="toggleConsolColVis(\'' + c.key + '\')"> ' + c.label + '</label>';
  }).join('');
}
function toggleConsolColDropdown() {
  const dd = document.getElementById('consol-col-toggle-dd');
  const isOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!isOpen) renderConsolColToggle();
}
function consolSortByColumn(f) {
  if (consolSortF === f) { consolSortD = consolSortD === 'asc' ? 'desc' : 'asc'; }
  else { consolSortF = f; consolSortD = 'asc'; }
  if (currentConsolAloj) viewConsolDetail(currentConsolAloj);
}
// Shared sort value extraction - used by both main table and consolidated view
function _extractSortValue(r, c, f) {
  switch(f) {
    case "estado": return validated.has(r.idx)?1:0;
    case "idReserva": return r.id.toLowerCase();
    case "localizador": return r.localizador.toLowerCase();
    case "fechaAlta": return r._dateAltaNum;
    case "cliente": return r._clienteLc;
    case "alojamiento": return r._alojLc;
    case "edificio": return (r.edificio||"").toLowerCase();
    case "plataforma": return r._platLc;
    case "atendidoPor": return (r.atendidoPor||"").toLowerCase();
    case "origenMarketing": return (r.origenMarketing||"").toLowerCase();
    case "tipoReserva": return (r.tipoReserva||"").toLowerCase();
    case "fechaEntrada": return r._dateNum;
    case "fechaSalida": return r._dSalida ? r._dSalida.getTime() : 0;
    case "noches": return r._nights;
    case "totalReserva": return r.totalReserva;
    case "baseSinIVA": return c.baseSinIVA;
    case "subtotal": return c.sub;
    case "totalLiquidar": return c.totalLiq;
    case "observacion": return (r.observacion||"").toLowerCase();
    case "acciones": return validated.has(r.idx)?1:0;
    default: return r.idx;
  }
}
function consolGetSortValue(x, f) {
  return _extractSortValue(x.r, x.c, f);
}
function getSortValue(r, f) {
  return _extractSortValue(r, getLiq(r), f);
}
function sortByColumn(f) {
  const sortInput = document.querySelector('#combo-sort .combo-input');
  const sortWrap = document.getElementById('combo-sort');
  const dirInput = document.querySelector('#combo-sortdir .combo-input');
  const dirWrap = document.getElementById('combo-sortdir');
  if(simpleComboState.sort.value===f) {
    const nv = simpleComboState.sortdir.value==="asc"?"desc":"asc";
    simpleComboState.sortdir.value = nv;
    if (nv==='asc') { dirInput.value=''; dirInput.placeholder='\u2191'; dirWrap.classList.remove('has-value'); }
    else { dirInput.value='\u2193'; dirWrap.classList.add('has-value'); }
  } else {
    simpleComboState.sort.value = f;
    const opt = simpleComboOptions.sort.find(o=>o.value===f);
    if (f==='idx') { sortInput.value=''; sortInput.placeholder=t('sort.originalOrder'); sortWrap.classList.remove('has-value'); }
    else { sortInput.value=opt?opt.label:f; sortWrap.classList.add('has-value'); }
    simpleComboState.sortdir.value = 'asc';
    dirInput.value=''; dirInput.placeholder='\u2191'; dirWrap.classList.remove('has-value');
  }
  _currentPage = 1;
  renderTable();
}

// Global stats cache (recomputed only when needed)
let _globalStatsCache = null;
function getGlobalStats() {
  if (_globalStatsCache) return _globalStatsCache;
  let tR = 0, tL = 0;
  for (let i = 0; i < allReservas.length; i++) {
    const r = allReservas[i];
    tR += r.totalReserva;
    tL += getLiq(r).totalLiq;
  }
  _globalStatsCache = { tR, tL };
  return _globalStatsCache;
}
function invalidateGlobalStats() { _globalStatsCache = null; }

/**
 * @description Renderiza la tabla principal de preliquidaciÃƒÆ’Ã‚Â³n.
 * Delega en _renderFull() que aplica filtros, ordenaciÃƒÆ’Ã‚Â³n, paginaciÃƒÆ’Ã‚Â³n y stats.
 * Es el punto de entrada pÃƒÆ’Ã‚Âºblico ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â las funciones internas son _renderFull() y _renderPageOnly().
 */
function renderTable() { _renderFull(); }

/**
 * @description Genera el HTML completo de una fila de la tabla de preliquidaciÃƒÆ’Ã‚Â³n.
 * Incluye todas las celdas, selects, botones CE/CE2 y acciones.
 * @param {Object} r - Objeto reserva
 * @returns {string} HTML de la fila <tr> + paneles CE/CE2
 * @private
 */
function _buildRowHtml(r) {
  const s = settings[r.idx] || {}, c = getLiq(r), isV = validated.has(r.idx), isB = r._isBooking, dis = isV ? "disabled" : "";
  const pO = selectWithValue(_selectCache['plat_' + r.plataforma] || '<option>10%</option>', s.comPlataforma);
  const gO = selectWithValue(_selectCache.gtc, s.comGTC);
  const cO = selectCleanWithValue(_selectCache.clean, s.limpieza);
  const aO = selectCleanWithValue(_selectCache.amenities, s.amenities);
  const iO = selectWithValue(_selectCache.irpf, s.irpf);
  const psO = selectWithValue(isB ? _selectCache.pasBooking : _selectCache.pasStripe, s.pasarelaRate);
  return `<tr ${isV ? 'class="validated"' : (c.ceTotal > 0 ? 'class="ce-highlighted"' : (c.ceSinIvaTotal > 0 ? 'class="ce2-highlighted"' : ''))} id="row-${r.idx}">
    <td class="col-estado">${isV ? '<span class="badge badge-green">&#10003; ' + t('status.validated') + '</span>' : '<span class="badge badge-amber">' + t('status.pending') + '</span>'}</td>
    <td class="col-idReserva muted" style="font-size:12px;">${r.id}</td>
    <td class="col-localizador muted" style="font-size:11px;white-space:nowrap;">${r.localizador}</td>
    <td class="col-fechaAlta muted" style="font-size:12px;">${r._fmtAlta}</td>
    <td class="col-cliente bold ellip">${esc(r.cliente)}</td>
    <td class="col-alojamiento ellip muted">${esc(r.alojamiento)}</td>
    <td class="col-edificio ellip muted" style="font-size:12px;">${esc(r.edificio)}</td>
    <td class="col-plataforma"><span class="badge ${isB ? 'badge-purple' : 'badge-blue'}">${r.plataforma}</span></td>
    <td class="col-atendidoPor ellip muted" style="font-size:12px;">${esc(r.atendidoPor)}</td>
    <td class="col-origenMarketing ellip muted" style="font-size:12px;">${esc(r.origenMarketing)}</td>
    <td class="col-tipoReserva muted" style="font-size:12px;">${esc(r.tipoReserva)}</td>
    <td class="col-fechaEntrada" style="font-size:12px;white-space:nowrap;">${r._fmtEntrada}</td>
    <td class="col-fechaSalida" style="font-size:12px;white-space:nowrap;">${r._fmtSalida}</td>
    <td class="col-noches" style="text-align:center">${r._nights}</td>
    <td class="col-totalReserva right bold">${fmt(r.totalReserva)} &#8364;</td>
    <td class="col-ce" style="text-align:center;vertical-align:middle;">${_buildCEButton(r.idx, c)}</td>
    <td class="col-baseSinIVA right" style="color:#6b7280;font-size:12px;">${fmt(c.baseSinIVA)} &#8364;</td>
    <td class="col-comPlataforma" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'comPlataforma',parseFloat(this.value))" ${dis}>${pO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPlat)} &#8364;</span></div></td>
    <td class="col-comGTC" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'comGTC',parseFloat(this.value))" ${dis}>${gO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comGTC)} &#8364;</span></div></td>
    <td class="col-limpieza" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'limpieza',parseFloat(this.value))" ${dis}>${cO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.limp)} &#8364;</span></div></td>
    <td class="col-amenities" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'amenities',parseFloat(this.value))" ${dis}>${aO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.amen)} &#8364;</span></div></td>
    <td class="col-pasarela" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><div style="display:flex;align-items:center;justify-content:center;gap:6px;">
      <div class="toggle" onclick="if(!${isV}){togglePasarela(${r.idx})}"><div class="toggle-track ${s.pasarela ? 'on' : ''}"><div class="toggle-thumb"></div></div></div>
      ${s.pasarela ? `<select class="sel" style="width:70px;font-size:11px;padding:4px 6px;" onchange="changeSetting(${r.idx},'pasarelaRate',parseFloat(this.value))" ${dis}>${psO}</select>` : `<span class="toggle-label">${isB ? 'Booking' : 'Stripe'}</span>`}
    </div>${s.pasarela && c.comPas > 0 ? `<span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPas)} &#8364;</span>` : ''}</div></td>
    <td class="col-ceSinIva" style="text-align:center;vertical-align:middle;">${_buildCE2Button(r.idx, c)}</td>
    <td class="col-subtotal right bold" style="font-size:12px;">${fmt(c.sub)} &#8364;</td>
    <td class="col-irpf" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'irpf',parseFloat(this.value))" ${dis}>${iO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.ret)} &#8364;</span></div></td>
    <td class="col-iva21" style="text-align:center;vertical-align:middle;"><span style="font-size:11px;color:#43a047;font-variant-numeric:tabular-nums;">+ ${fmt(c.iva)} &#8364;</span></td>
    <td class="col-totalLiquidar right bold" style="color:${c.totalLiq >= 0 ? '#1a2744' : '#e53935'}">${fmt(c.totalLiq)} &#8364;</td>
    <td class="col-observacion ellip muted" style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${esc(r.observacion)}">${esc(r.observacion)}</td>
    <td class="col-acciones"><div style="display:flex;gap:6px;">
      <button class="btn btn-sm btn-primary" onclick="viewDetail(${r.idx})">&#128065;</button>
      ${!isV ? `<button class="btn btn-sm btn-orange" onclick="toggleValidate(${r.idx})">&#10004;</button>` : `<button class="btn btn-sm btn-success" onclick="toggleValidate(${r.idx})">&#8617;</button>`}
    </div></td>
  </tr>` + _buildCEPanelRow(r.idx, s, c) + _buildCE2PanelRow(r.idx, s, c);
}

function _buildCEButton(idx, c, view) {
  const v = view || 'p';
  if (c.ceTotal > 0) {
    return `<button class="ce-btn has" onclick="event.stopPropagation();toggleCEPanel(${idx},'${v}')"><span class="ce-dot"></span>&#8211;${fmt(c.ceTotal)} &#8364;</button>`;
  }
  return `<button class="ce-btn" onclick="event.stopPropagation();toggleCEPanel(${idx},'${v}')" title="${t('ce.specialConcepts')}">+</button>`;
}

function _buildCEPanelRow(idx, s, c, view) {
  const v = view || 'p';
  const ce = s.conceptosEspeciales || [];
  const colCount = v === 'c'
    ? CONSOL_COLUMNS.filter(function(col){return consolColVis[col.key]!==false;}).length
    : COLUMNS.filter(function(col){return colVisibility[col.key]!==false;}).length;
  const r = allReservas[idx];
  const itemsHtml = ce.map(function(item, i) {
    return `<div class="ce-item-row"><input class="ce-inp-label" type="text" value="${(item.label||'').replace(/"/g,'&quot;')}" onchange="updateCEItem(${idx},${i},'label',this.value,'${v}')" onkeydown="_ceKey(event,${idx},'${v}',false)" placeholder="${t('ce.placeholder')}" /><input class="ce-inp-amt" type="text" value="${fmt(item.amount||0)}" onchange="updateCEItem(${idx},${i},'amount',this.value,'${v}')" onkeydown="_ceKey(event,${idx},'${v}',true)" /><button class="ce-del" onclick="removeCEItem(${idx},${i},'${v}')">&#215;</button></div>`;
  }).join('');
  const _b = 'text-align:center;padding:8px 12px;border-radius:8px;min-width:110px;';
  return `<tr class="ce-panel-row" id="ce-${v}panel-${idx}" style="display:none"><td colspan="${colCount}" style="padding:0"><div class="ce-panel-inner"><div class="ce-panel-left"><div class="ce-panel-title">${t("ce.title")} <span class="ce-eye">${t("ce.internalOnly")}</span></div>${itemsHtml}<div class="ce-add-link" onclick="addCEItem(${idx},'${v}')">${t("ce.addItem")}</div></div><div class="ce-panel-summary" style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;"><div style="${_b}background:#f3f4f6;"><div class="ce-sum-label" style="color:#374151">${t("ce.totalReserva")}<br>${t("ce.ivaInc")}</div><div class="ce-sum-val" style="color:#1a2744">${fmt(c.totalOriginal)} &#8364;</div></div><div style="${_b}background:#fef3c7;"><div class="ce-sum-label">${t("ce.deduct")}<br>${t("ce.ivaInc")}</div><div class="ce-sum-val">&#8211; ${fmt(c.ceTotal)} &#8364;</div></div><div style="${_b}background:#fff3e0;"><div class="ce-sum-label" style="color:#e65100">${t("ce.totalSinCE")}<br>${t("ce.ivaInc")}</div><div class="ce-sum-val" style="color:#e65100">${fmt(c.total)} &#8364;</div></div><div style="${_b}background:#e8f5e9;"><div class="ce-sum-label" style="color:#2e7d32">${t("ce.totalSinCE")}<br>${t("ce.sinIVA")}</div><div class="ce-sum-val" style="color:#2e7d32;font-size:15px">${fmt(c.baseSinIVA)} &#8364;</div></div></div></div></td></tr>`;
}

let _openCEPanel = null;
let _openCEView = 'p';
function toggleCEPanel(idx, view) {
  if (idx == null || !allReservas[idx]) return;
  const v = view || 'p';
  const panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  if (_openCEPanel !== null && (_openCEPanel !== idx || _openCEView !== v)) {
    let prev = document.getElementById('ce-' + _openCEView + 'panel-' + _openCEPanel);
    if (prev) prev.style.display = 'none';
  }
  if (panel.style.display === 'none') {
    let wrap = panel.closest('.table-wrap');
    let st = wrap ? wrap.scrollTop : window.scrollY;
    panel.style.display = '';
    if (wrap) wrap.scrollTop = st; else window.scrollTo(0, st);
    _openCEPanel = idx;
    _openCEView = v;
    let s = settings[idx];
    if (!s.conceptosEspeciales || s.conceptosEspeciales.length === 0) {
      s.conceptosEspeciales = [{label:'', amount:0}];
      _refreshCEPanel(idx, v);
    }
  } else {
    panel.style.display = 'none';
    _openCEPanel = null;
  }
}


// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M12] CE_SYSTEM ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Conceptos Extraordinarios (CE con IVA + CE2 sin IVA)
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === CE/CE2 LIVE INPUT DEBOUNCE (event delegation) ===
var _ceInputTimer = null;
document.addEventListener('input', function(e) {
  var el = e.target;
  var isCE = el.classList.contains('ce-inp-amt');
  var isCE2 = el.classList.contains('ce2-inp-amt');
  if (!isCE && !isCE2) return;
  clearTimeout(_ceInputTimer);
  _ceInputTimer = setTimeout(function() {
    var row = el.closest('.ce-item-row') || el.closest('.ce2-item-row');
    if (!row) return;
    var panel = el.closest('[id^="ce-"]') || el.closest('[id^="ce2-"]');
    if (!panel) return;
    var prefix = isCE2 ? 'ce2-' : 'ce-';
    var idMatch = panel.id.match(new RegExp(prefix + '([pc])panel-(\\d+)'));
    if (!idMatch) return;
    var view = idMatch[1], idx = parseInt(idMatch[2]);
    var rows = panel.querySelectorAll(isCE2 ? '.ce2-item-row' : '.ce-item-row');
    var itemIdx = Array.prototype.indexOf.call(rows, row);
    if (itemIdx < 0) return;
    var s = settings[idx]; if (!s) return;
    var arr = isCE2 ? s.conceptosSinIVA : s.conceptosEspeciales;
    if (!arr || !arr[itemIdx]) return;
    var v = parseFloat(String(el.value).replace(/\./g,'').replace(',','.'));
    if (isNaN(v)) v = 0;
    if (arr[itemIdx].amount === v) return;
    arr[itemIdx].amount = v;
    // Lightweight path: update cache + summary without full DOM rebuild
    var oldC = getLiq(allReservas[idx]);
    invalidateCache(idx);
    var newC = getLiq(allReservas[idx]);
    if (isCE2) { _refreshCE2Summary(idx, view); }
    else { _refreshCESummary(idx, view); }
    _patchMainRowCells(idx, oldC, newC);
    // Update footer stats
    var st = _cachedFilteredStats;
    if (st && oldC && newC) {
      st.fL += (newC.totalLiq - oldC.totalLiq);
      st.tLiq += (newC.totalLiq - oldC.totalLiq);
      if (isCE2) { st.tCE2 += (newC.ceSinIvaTotal - oldC.ceSinIvaTotal); }
      else { st.tCE += (newC.ceTotal - oldC.ceTotal); st.tBase += (newC.baseSinIVA - oldC.baseSinIVA); }
      st.tSub += (newC.sub - oldC.sub);
      _renderStatsFromCache(_lastFiltered, st);
    }
    // Update consol view lightweight (no DOM rebuild = no jumps, panel stays open)
    if (view === 'c' && currentConsolAloj) {
      _patchConsolLightweight(idx, oldC, newC);
    }
    scheduleReservaConfigSave(idx);
  }, 400);
});

// === LIVE DEBOUNCED INPUT: Otros Conceptos ===
var _cexInputTimer = null;
document.addEventListener('input', function(e) {
  var el = e.target;
  if (!el.classList.contains('cex-inp-amt')) return;
  // Immediately update the red neg span in the same row
  var row = el.closest('.cex-item-row');
  if (row) {
    var negSpan = row.querySelector('.neg');
    var v = parseFloat(String(el.value).replace(/\./g,'').replace(',','.'));
    if (negSpan) negSpan.textContent = '- ' + fmt(isNaN(v) ? 0 : v) + ' \u20AC';
  }
  clearTimeout(_cexInputTimer);
  _cexInputTimer = setTimeout(function() {
    if (!currentConsolAloj) return;
    var box = el.closest('.consol-monthly-box');
    if (!row || !box) return;
    var rows = box.querySelectorAll('.cex-item-row');
    var itemIdx = Array.prototype.indexOf.call(rows, row);
    if (itemIdx < 0) return;
    var extras = getConsolExtras(currentConsolAloj);
    if (!extras[itemIdx]) return;
    var v2 = parseFloat(String(el.value).replace(/\./g,'').replace(',','.'));
    if (isNaN(v2)) v2 = 0;
    if (extras[itemIdx].amount === v2) return;
    extras[itemIdx].amount = v2;
    scheduleGlobalConfigSave();
    _patchConsolFinalTotals();
  }, 400);
});

// === KEYBOARD: Enter labelÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢amt, Enter amtÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢new row, EscapeÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢remove if empty ===
function _cexKey(e, alojName, isAmt) {
  if (e.key === 'Enter') {
    e.preventDefault();
    var row = e.target.closest('.cex-item-row');
    if (!row) return;
    if (!isAmt) {
      // Enter on label ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ focus amount
      var amt = row.querySelector('.cex-inp-amt');
      if (amt) { amt.focus(); amt.select(); }
    } else {
      // Enter on amount ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ trigger change, then add new row
      e.target.dispatchEvent(new Event('change', {bubbles:true}));
      addConsolExtra(alojName);
    }
  } else if (e.key === 'Escape') {
    var row2 = e.target.closest('.cex-item-row');
    if (!row2) return;
    var lbl = row2.querySelector('.cex-inp-label');
    var amt2 = row2.querySelector('.cex-inp-amt');
    // If both empty, remove the row
    if (lbl && !lbl.value.trim() && amt2 && (!amt2.value.trim() || amt2.value.trim() === '0,00')) {
      var box = row2.closest('.consol-monthly-box');
      if (box) {
        var rows = box.querySelectorAll('.cex-item-row');
        var idx = Array.prototype.indexOf.call(rows, row2);
        if (idx >= 0) removeConsolExtra(alojName, idx);
      }
    }
  }
}

// ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ [M14-PATCH] Patch ligero consolidado (sin reconstruir DOM) ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬

/**
 * @description Sistema de actualizaciÃƒÆ’Ã‚Â³n ligera para la vista consolidada.
 * En vez de reconstruir todo el DOM con viewConsolDetail(), estas funciones
 * parchean solo las celdas/secciones que han cambiado:
 *   - _patchConsolRowCells() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ actualiza celdas numÃƒÆ’Ã‚Â©ricas de una fila
 *   - _patchConsolFooterRow() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ actualiza totales del tfoot
 *   - _buildConsolSummaryInner() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ regenera HTML del resumen financiero
 *   - _getConsolCalcsAndSums() ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ helper de cÃƒÆ’Ã‚Â¡lculo reutilizable
 */

// === LIGHTWEIGHT CONSOL PATCH (no DOM rebuild) ===
function _getConsolCalcsAndSums(alojName) {
  var alojamientos = getAlojamientos();
  var a = alojamientos.find(function(x) { return x.name === alojName; });
  if (!a) return null;
  var filteredReservas = a.reservas;
  if (_mpHasFilter()) filteredReservas = a.reservas.filter(function(r) { return _mpMatchDate(r._dEntrada); });
  var calcs = filteredReservas.map(function(r) { return { r: r, s: settings[r.idx] || {}, c: getLiq(r) }; });
  var sums = { CE:0, orig:0, total:0, base:0, comPlat:0, comGTC:0, comPas:0, limp:0, amen:0, CE2:0, sub:0, iva:0, ret:0, liq:0, noches:0 };
  calcs.forEach(function(x) {
    sums.CE += x.c.ceTotal; sums.orig += x.r.totalReserva; sums.total += x.c.total;
    sums.base += x.c.baseSinIVA; sums.comPlat += x.c.comPlat; sums.comGTC += x.c.comGTC;
    sums.comPas += x.c.comPas; sums.limp += x.c.limp; sums.amen += x.c.amen;
    sums.CE2 += x.c.ceSinIvaTotal; sums.sub += x.c.sub; sums.iva += x.c.iva;
    sums.ret += x.c.ret; sums.liq += x.c.totalLiq; sums.noches += x.r._nights;
  });
  return { calcs: calcs, sums: sums, a: a };
}

function _buildConsolSummaryInner(calcs, sums, alojName) {
  var _dedHtml = buildConsolDeductionsHtml(alojName);
  var _ded = getConsolDeductions(alojName);
  var _isSplit = isGtcSplit(alojName);
  var _gtcSplitAmt = _isSplit ? sums.sub * GTC_SPLIT_RATE : 0;
  var _ownerBase = _isSplit ? sums.sub - _gtcSplitAmt : sums.sub;
  var adjSub = _ownerBase - _ded.totalBase;
  var avgIrpfRate = sums.sub > 0 ? sums.ret / sums.sub : 0;
  var adjRet = adjSub * avgIrpfRate;
  var adjIva = adjSub * IVA_SUBTOTAL;
  var adjLiq = adjSub - adjRet + adjIva;
  var sumNoches = calcs.reduce(function(s,x){return s+x.r._nights;},0);
  var sumVGO = sums.comPlat + sums.comGTC + sums.limp + sums.amen + sums.comPas;
  var allVal = calcs.every(function(x){return validated.has(x.r.idx);});
  var h = '';
  // LEFT column
  h += '<div class="cd-summary-left">';
  h += `<div class="cd-sum-title">${t('consol.summary')}</div>`;
  h += `<div class="consol-row bold"><span>${t('consol.totalReservasVAT')}</span><span>${fmt(sums.total)} \u20AC</span></div>`;
  if (sums.CE > 0) {
    h += '<div class="no-print" style="background:#fffdf5;border:1px dashed #f59e0b;border-radius:6px;margin:4px 0;padding:4px 12px;">';
    h += `<div class="consol-row" style="color:#d97706;font-size:12px;padding:4px 0;"><span>\u26A0 ${t('consol.originalTotal')}</span><span>${fmt(sums.orig)} \u20AC</span></div>`;
    h += `<div class="consol-row" style="color:#d97706;font-size:12px;padding:4px 0;"><span>${t('consol.specialConceptsDisc')}</span><span class="neg">- ${fmt(sums.CE)} \u20AC</span></div>`;
    h += '</div>';
  }
  h += `<div class="consol-row"><span>${t('consol.vatReservas')} (10%)</span><span class="neg">- ${fmt(sums.total - sums.base)} \u20AC</span></div>`;
  h += '<div class="consol-row bold"><span>Base sin IVA</span><span>' + fmt(sums.base) + ' \u20AC</span></div>';
  h += '<div class="consol-divider"></div>';
  h += buildComPlatRows(calcs);
  h += '<div class="consol-divider"></div>';
  h += buildGTCRows(calcs);
  h += buildLimpRows(calcs);
  h += `<div class="consol-row"><span>${t('liq.amenities')}</span><span class="neg">- ${fmt(sums.amen)} \u20AC</span></div>`;
  h += '<div class="consol-divider"></div>';
  h += buildPasarelaRows(calcs);
  if (sums.CE2 > 0) {
    h += '<div class="no-print" style="background:#faf8ff;border:1px dashed #7c3aed;border-radius:6px;margin:4px 0;padding:4px 12px;">';
    h += `<div class="consol-row" style="color:#7c3aed;font-size:12px;padding:4px 0;"><span>\u26A0 ${t('consol.ceNoVatDisc')}</span><span class="neg">- ${fmt(sums.CE2)} \u20AC</span></div>`;
    calcs.forEach(function(x) {
      (x.s.conceptosSinIVA||[]).filter(function(it){return it.amount>0;}).forEach(function(it) {
        h += '<div class="consol-row sub" style="color:#9f7aea;font-size:11px;padding:2px 0 2px 12px;"><span>' + esc(it.label||t('liq.noName')) + ' <span style="color:#c4b5fd;font-size:10px">(Res. ' + esc(x.r.id) + ')</span></span><span class="neg">- ' + fmt(it.amount) + ' \u20AC</span></div>';
      });
    });
    h += '</div>';
  }
  h += `<div class="consol-subtotal-reservas"><span>${t('consol.subtotalReservas')}</span><span>${fmt(sums.sub)} \u20AC</span></div>`;
  if (_isSplit) {
    h += '<div class="consol-split-box">';
    h += `<div class="consol-split-title">\u21AD ${t('consol.splitTitle')}</div>`;
    h += '<div class="consol-row bold" style="color:#7c3aed;padding:8px 16px;"><span><span class="consol-split-dot" style="background:#7c3aed;"></span>GTC retiene (' + (GTC_SPLIT_RATE*100).toFixed(0) + '%)</span><span>' + fmt(_gtcSplitAmt) + ' \u20AC</span></div>';
    h += '<div class="consol-split-divider"></div>';
    h += '<div class="consol-row bold" style="color:#16a34a;padding:8px 16px;"><span><span class="consol-split-dot" style="background:#16a34a;"></span>' + t('liq.ownerReceives') + ' (' + ((1-GTC_SPLIT_RATE)*100).toFixed(0) + '%)</span><span>' + fmt(_ownerBase) + ' \u20AC</span></div>';
    h += '<div class="consol-split-bar"><div class="consol-split-bar-gtc" style="width:' + (GTC_SPLIT_RATE*100).toFixed(0) + '%;">' + (GTC_SPLIT_RATE*100).toFixed(0) + '%</div><div class="consol-split-bar-owner" style="width:' + ((1-GTC_SPLIT_RATE)*100).toFixed(0) + '%;">' + ((1-GTC_SPLIT_RATE)*100).toFixed(0) + '%</div></div>';
    h += '</div>';
  }
  h += '<div class="consol-monthly-box no-print">';
  h += `<div class="consol-monthly-title">\uD83D\uDCC5 ${t('consol.otherConcepts')}</div>`;
  h += _dedHtml;
  h += '</div>';
  h += `<div class="consol-row bold" id="csf-subtotal"><span>${t('consol.subtotalFinal')}</span><span>${fmt(adjSub)} \u20AC</span></div>`;
  h += `<div class="consol-row" id="csf-irpf"><span>${t('liq.irpfWithholding')} (${(avgIrpfRate*100).toFixed(0)}%)</span><span class="neg">- ${fmt(adjRet)} \u20AC</span></div>`;
  h += `<div class="consol-row" id="csf-iva"><span>${t('liq.vatSubtotal')} (21%)</span><span class="pos">+ ${fmt(adjIva)} \u20AC</span></div>`;
  h += '</div>';
  // RIGHT column
  h += '<div class="cd-summary-right">';
  h += `<div class="cd-sum-title">${t('consol.quickSummary')}</div>`;
  h += '<div class="cd-quick-stats">';
  h += `<div class="cd-qs-item"><div class="cd-qs-label">${t("stats.reservations")}</div><div class="cd-qs-value">${calcs.length}</div></div>`;
  h += `<div class="cd-qs-item"><div class="cd-qs-label">${t("stats.nights")}</div><div class="cd-qs-value">${sumNoches}</div></div>`;
  h += `<div class="cd-qs-item"><div class="cd-qs-label">${t("stats.billing")}</div><div class="cd-qs-value">${fmt(sums.total)} \u20AC</div></div>`;
  h += '</div>';
  h += '<div style="margin-bottom:16px;">';
  h += `<div class="cd-tb-row"><span>${t('liq.baseNoVAT')}</span><span class="cd-tb-val">${fmt(sums.base)} \u20AC</span></div>`;
  h += `<div class="cd-tb-row"><span>${t('liq.salesOps')}</span><span class="cd-tb-val neg">\u2212 ${fmt(sumVGO)} \u20AC</span></div>`;
  h += `<div class="cd-tb-row" style="font-weight:700;"><span>${t('consol.subtotalReservas2')}</span><span class="cd-tb-val">${fmt(sums.sub)} \u20AC</span></div>`;
  if (_isSplit) {
    h += `<div class="cd-split-mini"><div class="cd-split-mini-header">\u21AD ${t('consol.specialAgreement')}</div>`;
    h += '<div class="cd-split-mini-row"><span><span class="consol-split-dot" style="background:#7c3aed;"></span>GTC (' + (GTC_SPLIT_RATE*100).toFixed(0) + '%)</span><span style="color:#7c3aed;font-weight:600;">\u2212 ' + fmt(_gtcSplitAmt) + ' \u20AC</span></div>';
    h += '<div class="cd-split-mini-row"><span><span class="consol-split-dot" style="background:#16a34a;"></span>' + t('liq.ownerLabel') + ' (' + ((1-GTC_SPLIT_RATE)*100).toFixed(0) + '%)</span><span style="color:#16a34a;font-weight:700;">' + fmt(_ownerBase) + ' \u20AC</span></div>';
    h += '</div>';
  }
  h += `<div class="cd-tb-row"><span>${t('consol.otherConceptsShort')}</span><span class="cd-tb-val neg">\u2212 ${fmt(_ded.totalBase)} \u20AC</span></div>`;
  h += `<div class="cd-tb-row" style="font-weight:700;"><span>${t('consol.subtotalFinalMonth')}</span><span class="cd-tb-val">${fmt(adjSub)} \u20AC</span></div>`;
  h += `<div class="cd-tb-row"><span>${t('liq.irpfWithholding')} (${(avgIrpfRate*100).toFixed(0)}%)</span><span class="cd-tb-val neg">\u2212 ${fmt(adjRet)} \u20AC</span></div>`;
  h += `<div class="cd-tb-row"><span>${t('liq.vatSubtotal')} (21%)</span><span class="cd-tb-val pos">+ ${fmt(adjIva)} \u20AC</span></div>`;
  h += '</div>';
  h += '<div style="flex:1;"></div>';
  h += '<div class="cd-total-hero" id="csf-total"><div class="cd-total-hero-label">' + t('liq.totalToSettleFull') + (_isSplit ? ' \u2014 ' + t('liq.propietario') : '') + '</div><div class="cd-total-hero-amount">' + fmt(adjLiq) + ' <span class="eur">\u20AC</span></div></div>';
  h += '<div class="no-print" style="margin-top:12px;">';
  h += allVal ? '<button class="cd-btn-generate" onclick="handleGenerar()">\uD83D\uDDA8 ' + t('btn.generate') + '</button><button class="pdf-download-btn" onclick="handleDownloadPdf()">\u2B73 ' + t('btn.downloadPdfLiq') + '</button><button class="email-btn" onclick="handleEmailLiquidacion()">\u2709 ' + t('btn.sendEmailLiq') + '</button>' : '<button class="cd-btn-generate disabled">\u26A0 ' + t('btn.validateFirst') + '</button><button class="pdf-download-btn disabled">\u2B73 ' + t('btn.downloadPdfLiq') + '</button><button class="email-btn disabled">\u2709 ' + t('btn.sendEmailLiq') + '</button>';
  h += '</div>';
  h += '</div>';
  return h;
}

function _patchConsolRowCells(idx, newC) {
  var crow = document.getElementById('crow-' + idx);
  if (!crow) return;
  // Note: cc-totalReserva shows r.totalReserva (original) which never changes with CE/CE2
  var el;
  el = crow.querySelector('.cc-ce'); if (el) el.innerHTML = _buildCEButton(idx, newC, 'c');
  el = crow.querySelector('.cc-baseSinIVA'); if (el) el.innerHTML = fmt(newC.baseSinIVA) + ' \u20AC';
  // For cells with select+span, patch only the span
  var sp;
  sp = crow.querySelector('.cc-comPlataforma span[style*="tabular"]'); if (sp) sp.innerHTML = '\u2013 ' + fmt(newC.comPlat) + ' \u20AC';
  sp = crow.querySelector('.cc-comGTC span[style*="tabular"]'); if (sp) sp.innerHTML = '\u2013 ' + fmt(newC.comGTC) + ' \u20AC';
  sp = crow.querySelector('.cc-pasarela span[style*="tabular"]'); if (sp) sp.innerHTML = '\u2013 ' + fmt(newC.comPas) + ' \u20AC';
  el = crow.querySelector('.cc-ceSinIva'); if (el) el.innerHTML = _buildCE2Button(idx, newC, 'c');
  el = crow.querySelector('.cc-subtotal'); if (el) el.innerHTML = fmt(newC.sub) + ' \u20AC';
  sp = crow.querySelector('.cc-irpf span[style*="tabular"]'); if (sp) sp.innerHTML = '\u2013 ' + fmt(newC.ret) + ' \u20AC';
  sp = crow.querySelector('.cc-iva21 span[style*="tabular"]'); if (sp) sp.innerHTML = '+ ' + fmt(newC.iva) + ' \u20AC';
  el = crow.querySelector('.cc-totalLiquidar'); if (el) { el.innerHTML = fmt(newC.totalLiq) + ' \u20AC'; el.style.color = newC.totalLiq >= 0 ? '#1a2744' : '#e53935'; }
}

function _patchConsolFooterRow(sums, count) {
  var frow = document.getElementById('consol-tfoot-row');
  if (!frow) return;
  var p = function(cls, val) { var el = frow.querySelector('.'+cls); if (el) el.innerHTML = fmt(val) + ' \u20AC'; };
  // cc-totalReserva shows sum of original r.totalReserva (not affected by CE)
  p('cc-totalReserva', sums.orig);
  var ceCel = frow.querySelector('.cc-ce'); if (ceCel) ceCel.innerHTML = sums.CE > 0 ? '\u2013 ' + fmt(sums.CE) + ' \u20AC' : '';
  p('cc-baseSinIVA', sums.base);
  p('cc-comPlataforma', sums.comPlat);
  p('cc-comGTC', sums.comGTC);
  p('cc-limpieza', sums.limp);
  p('cc-amenities', sums.amen);
  var pasCel = frow.querySelector('.cc-pasarela'); if (pasCel) pasCel.innerHTML = sums.comPas > 0 ? fmt(sums.comPas) + ' \u20AC' : '\u2013';
  var ce2Cel = frow.querySelector('.cc-ceSinIva'); if (ce2Cel) ce2Cel.innerHTML = sums.CE2 > 0 ? '\u2013 ' + fmt(sums.CE2) + ' \u20AC' : '';
  p('cc-subtotal', sums.sub);
  var retCel = frow.querySelector('.cc-irpf'); if (retCel) retCel.innerHTML = '\u2013 ' + fmt(sums.ret) + ' \u20AC';
  var ivaCel = frow.querySelector('.cc-iva21'); if (ivaCel) ivaCel.innerHTML = '+ ' + fmt(sums.iva) + ' \u20AC';
  p('cc-totalLiquidar', sums.liq);
}

function _patchConsolLightweight(idx, oldC, newC) {
  if (!currentConsolAloj) return;
  // 1. Patch individual row
  _patchConsolRowCells(idx, newC);
  // 2. Recalculate sums and patch footer + summary
  var data = _getConsolCalcsAndSums(currentConsolAloj);
  if (!data) return;
  _patchConsolFooterRow(data.sums, data.calcs.length);
  var summaryBlock = document.getElementById('consol-summary-block');
  if (summaryBlock) summaryBlock.innerHTML = _buildConsolSummaryInner(data.calcs, data.sums, currentConsolAloj);
}

// ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ [M12-KEYBOARD] Atajos de teclado para CE/CE2 ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬
/**
 * @description Manejo de Enter/Escape en campos CE/CE2:
 *   - Enter en nombre ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ mueve foco a importe
 *   - Enter en importe ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ crea nueva fila
 *   - Escape en fila vacÃƒÆ’Ã‚Â­a ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ la elimina
 * PatrÃƒÆ’Ã‚Â³n zero-jump: la fila se inserta PRIMERO, los nÃƒÆ’Ã‚Âºmeros se actualizan
 * en el siguiente frame con requestAnimationFrame para evitar layout thrashing.
 */

// === CE ENTER KEY HANDLERS (row-first, numbers async) ===
function _ceKey(e, idx, view, isAmt) {
  if (e.key !== 'Enter') return;
  e.preventDefault();
  if (!isAmt) {
    var amt = e.target.parentNode.querySelector('.ce-inp-amt');
    if (amt) { amt.focus({preventScroll:true}); amt.select(); }
    return;
  }
  var inp = e.target;
  var row = inp.closest('.ce-item-row');
  var panel = inp.closest('[id^="ce-"]');
  if (!panel) return;
  var rows = panel.querySelectorAll('.ce-item-row');
  var itemIdx = Array.prototype.indexOf.call(rows, row);
  // 1. Save value to model + prevent onchange double-fire
  var val = parseFloat(String(inp.value).replace(/\./g,'').replace(',','.'));
  if (isNaN(val)) val = 0;
  var s = settings[idx];
  if (s && s.conceptosEspeciales && s.conceptosEspeciales[itemIdx]) {
    s.conceptosEspeciales[itemIdx].amount = val;
  }
  inp.removeAttribute('onchange');
  // 2. Check if last row is already empty ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â if so, just focus it
  var allRows = panel.querySelectorAll('.ce-item-row');
  var lastRow = allRows.length ? allRows[allRows.length - 1] : null;
  if (lastRow && lastRow !== row) {
    var lastLbl = lastRow.querySelector('.ce-inp-label');
    var lastAmt = lastRow.querySelector('.ce-inp-amt');
    if (lastLbl && !lastLbl.value.trim() && lastAmt && (!lastAmt.value.trim() || lastAmt.value.trim() === '0,00')) {
      lastLbl.focus({preventScroll:true});
      requestAnimationFrame(function() {
        var oldC = getLiq(allReservas[idx]);
        invalidateCache(idx);
        var newC = getLiq(allReservas[idx]);
        _refreshCESummary(idx, view);
        _patchMainRowCells(idx, oldC, newC);
        scheduleReservaConfigSave(idx);
      });
      return;
    }
  }
  // 3. Add new row (no empty row exists)
  addCEItem(idx, view);
  // 3. Update numbers in next frame (user doesn't see the delay)
  requestAnimationFrame(function() {
    var oldC = getLiq(allReservas[idx]);
    invalidateCache(idx);
    var newC = getLiq(allReservas[idx]);
    _refreshCESummary(idx, view);
    _patchMainRowCells(idx, oldC, newC);
    scheduleReservaConfigSave(idx);
  });
}
function _ce2Key(e, idx, view, isAmt) {
  if (e.key !== 'Enter') return;
  e.preventDefault();
  if (!isAmt) {
    var amt = e.target.parentNode.querySelector('.ce2-inp-amt');
    if (amt) { amt.focus({preventScroll:true}); amt.select(); }
    return;
  }
  var inp = e.target;
  var row = inp.closest('.ce2-item-row');
  var panel = inp.closest('[id^="ce2-"]');
  if (!panel) return;
  var rows = panel.querySelectorAll('.ce2-item-row');
  var itemIdx = Array.prototype.indexOf.call(rows, row);
  var val = parseFloat(String(inp.value).replace(/\./g,'').replace(',','.'));
  if (isNaN(val)) val = 0;
  var s = settings[idx];
  if (s && s.conceptosSinIVA && s.conceptosSinIVA[itemIdx]) {
    s.conceptosSinIVA[itemIdx].amount = val;
  }
  inp.removeAttribute('onchange');
  // Check if last row is already empty
  var allRows2 = panel.querySelectorAll('.ce2-item-row');
  var lastRow2 = allRows2.length ? allRows2[allRows2.length - 1] : null;
  if (lastRow2 && lastRow2 !== row) {
    var lastLbl2 = lastRow2.querySelector('.ce2-inp-label');
    var lastAmt2 = lastRow2.querySelector('.ce2-inp-amt');
    if (lastLbl2 && !lastLbl2.value.trim() && lastAmt2 && (!lastAmt2.value.trim() || lastAmt2.value.trim() === '0,00')) {
      lastLbl2.focus({preventScroll:true});
      requestAnimationFrame(function() {
        var oldC = getLiq(allReservas[idx]);
        invalidateCache(idx);
        var newC = getLiq(allReservas[idx]);
        _refreshCE2Summary(idx, view);
        _patchMainRowCells(idx, oldC, newC);
        scheduleReservaConfigSave(idx);
      });
      return;
    }
  }
  addCE2Item(idx, view);
  requestAnimationFrame(function() {
    var oldC = getLiq(allReservas[idx]);
    invalidateCache(idx);
    var newC = getLiq(allReservas[idx]);
    _refreshCE2Summary(idx, view);
    _patchMainRowCells(idx, oldC, newC);
    scheduleReservaConfigSave(idx);
  });
}
// Patch only numeric cells in main table row (no DOM rebuild, no scroll jump)
// Live CE/CE2 sync: updates button+summary+cells while user types (before blur/save)
function _liveCESync(idx, view) {
  var v = view || 'p', s = settings[idx];
  if (!s || !s.conceptosEspeciales) return;
  var panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  var amts = panel.querySelectorAll('.ce-inp-amt');
  amts.forEach(function(inp, i) {
    if (i < s.conceptosEspeciales.length) {
      var val = parseFloat(String(inp.value).replace(/\./g,'').replace(',','.'));
      s.conceptosEspeciales[i].amount = isNaN(val) ? 0 : val;
    }
  });
  var oldC = getLiq(allReservas[idx]);
  invalidateCache(idx);
  var newC = getLiq(allReservas[idx]);
  _patchMainRowCells(idx, oldC, newC);
  _refreshCESummary(idx, v);
}
function _liveCE2Sync(idx, view) {
  var v = view || 'p', s = settings[idx];
  if (!s || !s.conceptosSinIVA) return;
  var panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  var amts = panel.querySelectorAll('.ce2-inp-amt');
  amts.forEach(function(inp, i) {
    if (i < s.conceptosSinIVA.length) {
      var val = parseFloat(String(inp.value).replace(/\./g,'').replace(',','.'));
      s.conceptosSinIVA[i].amount = isNaN(val) ? 0 : val;
    }
  });
  var oldC = getLiq(allReservas[idx]);
  invalidateCache(idx);
  var newC = getLiq(allReservas[idx]);
  _patchMainRowCells(idx, oldC, newC);
  _refreshCE2Summary(idx, v);
}
function _patchMainRowCells(idx, oldC, newC) {
  var mainRow = document.getElementById('row-' + idx);
  if (mainRow) {
    var c = function(cls, val) { var el = mainRow.querySelector(cls); if (el) el.innerHTML = fmt(val) + ' \u20AC'; };
    c('.col-totalLiquidar', newC.totalLiq);
    c('.col-subtotal', newC.sub);
    c('.col-baseSinIVA', newC.baseSinIVA);
    // Update CE/CE2 buttons
    var ceCel = mainRow.querySelector('.col-ce');
    if (ceCel) ceCel.innerHTML = _buildCEButton(idx, newC);
    var ce2Cel = mainRow.querySelector('.col-ceSinIva');
    if (ce2Cel) ce2Cel.innerHTML = _buildCE2Button(idx, newC);
  }
  // Incremental footer stats update
  var st = _cachedFilteredStats;
  if (st && oldC && newC) {
    st.fL += (newC.totalLiq - oldC.totalLiq);
    st.tLiq += (newC.totalLiq - oldC.totalLiq);
    st.tSub += (newC.sub - oldC.sub);
    st.tBase += (newC.baseSinIVA - oldC.baseSinIVA);
    st.tCE += (newC.ceTotal - oldC.ceTotal);
    st.tCE2 += (newC.ceSinIvaTotal - oldC.ceSinIvaTotal);
    _renderStatsFromCache(_lastFiltered, st);
  }
}
function addCEItem(idx, view) {
  let s = settings[idx]; if (!s) return;
  if (!s.conceptosEspeciales) s.conceptosEspeciales = [];
  let i = s.conceptosEspeciales.length;
  s.conceptosEspeciales.push({label:'', amount:0});
  let v = view || 'p';
  let panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  let addLink = panel.querySelector('.ce-add-link');
  if (!addLink) { _refreshCEPanel(idx, v); return; }
  // Create new row via DOM (no full re-render)
  let row = document.createElement('div');
  row.className = 'ce-item-row ce-new';
  row.innerHTML = '<input class="ce-inp-label" type="text" value="" onchange="updateCEItem('+idx+','+i+',\'label\',this.value,\''+v+'\')" onkeydown="_ceKey(event,'+idx+',\''+v+'\',false)" placeholder="'+t('ce.placeholder')+'" /><input class="ce-inp-amt" type="text" value="0,00" onchange="updateCEItem('+idx+','+i+',\'amount\',this.value,\''+v+'\')" onkeydown="_ceKey(event,'+idx+',\''+v+'\',true)" /><button class="ce-del" onclick="removeCEItem('+idx+','+i+',\''+v+'\')">&#215;</button>';
  addLink.parentNode.insertBefore(row, addLink);
  row.querySelector('.ce-inp-label').focus({preventScroll:true});
  scheduleReservaConfigSave(idx);
}

function removeCEItem(idx, itemIdx, view) {
  let s = settings[idx]; if (!s || !s.conceptosEspeciales) return;
  let v = view || 'p';
  let panel = document.getElementById('ce-' + v + 'panel-' + idx);
  let rows = panel ? panel.querySelectorAll('.ce-item-row') : [];
  if (rows[itemIdx]) {
    let row = rows[itemIdx];
    row.style.animation = 'ceRowOut .2s ease forwards';
    row.addEventListener('animationend', function() {
      row.remove();
      s.conceptosEspeciales.splice(itemIdx, 1);
      // Update cache
      let oldC = getLiq(allReservas[idx]);
      invalidateCache(idx);
      let newC = getLiq(allReservas[idx]);
      if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
      // Patch only the changed cells in the main table row (no full rebuild)
      let mainRow = document.getElementById('row-' + idx);
      if (mainRow) {
        let ceCel = mainRow.querySelector('.col-ce');
        if (ceCel) ceCel.innerHTML = _buildCEButton(idx, newC, v);
        let liqCel = mainRow.querySelector('.col-totalLiquidar');
        if (liqCel) liqCel.innerHTML = fmt(newC.totalLiq) + ' &#8364;';
        let subCel = mainRow.querySelector('.col-subtotal');
        if (subCel) subCel.innerHTML = fmt(newC.sub) + ' &#8364;';
        let baseCel = mainRow.querySelector('.col-baseSinIVA');
        if (baseCel) baseCel.innerHTML = fmt(newC.baseSinIVA) + ' &#8364;';
      }
      // Update summary numbers in CE panel
      _refreshCESummary(idx, v);
      // Update footer stats
      let st = _cachedFilteredStats;
      if (st && oldC && newC) {
        st.fL += (newC.totalLiq - oldC.totalLiq);
        st.tLiq += (newC.totalLiq - oldC.totalLiq);
        st.tCE += (newC.ceTotal - oldC.ceTotal);
        st.tSub += (newC.sub - oldC.sub);
        st.tBase += (newC.baseSinIVA - oldC.baseSinIVA);
        _renderStatsFromCache(_lastFiltered, st);
      }
      scheduleReservaConfigSave(idx);
      if (v === 'c' && currentConsolAloj) _patchConsolLightweight(idx, oldC, newC);
    }, {once:true});
  } else {
    s.conceptosEspeciales.splice(itemIdx, 1);
    _applyCEChange(idx, v);
  }
}

function updateCEItem(idx, itemIdx, field, rawVal, view) {
  let s = settings[idx]; if (!s || !s.conceptosEspeciales || !s.conceptosEspeciales[itemIdx]) return;
  if (field === 'label') {
    s.conceptosEspeciales[itemIdx].label = rawVal;
    scheduleReservaConfigSave(idx);
  } else {
    let v = parseFloat(String(rawVal).replace(/\./g,'').replace(',','.'));
    if (isNaN(v)) v = 0;
    s.conceptosEspeciales[itemIdx].amount = v;
    _applyCEChange(idx, view || 'p');
  }
}

function _applyCEChange(idx, view) {
  let v = view || 'p';
  let oldC = getLiq(allReservas[idx]);
  invalidateCache(idx);
  let newC = getLiq(allReservas[idx]);
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _refreshCESummary(idx, v);
  _patchMainRowCells(idx, oldC, newC);
  scheduleReservaConfigSave(idx);
  // If changed from consol view, patch lightweight
  if (v === 'c' && currentConsolAloj) {
    _patchConsolLightweight(idx, oldC, newC);
  } else {
    let panel = document.getElementById('ce-' + v + 'panel-' + idx);
    if (panel) { panel.style.display = ''; _openCEPanel = idx; _openCEView = v; }
  }
}

function _refreshCESummary(idx, view) {
  let v = view || 'p';
  let c = getLiq(allReservas[idx]);
  let panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  let vals = panel.querySelectorAll('.ce-sum-val');
  if (vals.length >= 4) {
    vals[0].innerHTML = fmt(c.totalOriginal) + ' &#8364;';
    vals[1].innerHTML = '&#8211; ' + fmt(c.ceTotal) + ' &#8364;';
    vals[2].innerHTML = fmt(c.total) + ' &#8364;';
    vals[3].innerHTML = fmt(c.baseSinIVA) + ' &#8364;';
  }
  // Always sync the CE button in the main table row
  var mainRow = document.getElementById('row-' + idx);
  if (mainRow) {
    var ceCel = mainRow.querySelector('.col-ce');
    if (ceCel) ceCel.innerHTML = _buildCEButton(idx, c, v);
  }
  // Re-index onclick handlers for remaining rows
  let rows = panel.querySelectorAll('.ce-item-row');
  rows.forEach(function(row, i) {
    const del = row.querySelector('.ce-del');
    if (del) del.setAttribute('onclick', "removeCEItem("+idx+","+i+",'"+v+"')");
    let lbl = row.querySelector('.ce-inp-label');
    if (lbl) lbl.setAttribute('onchange', "updateCEItem("+idx+","+i+",'label',this.value,'"+v+"')");
    let amt = row.querySelector('.ce-inp-amt');
    if (amt) amt.setAttribute('onchange', "updateCEItem("+idx+","+i+",'amount',this.value,'"+v+"')");
  });
}

function _refreshCEPanel(idx, view) {
  let v = view || 'p';
  let s = settings[idx] || {}, c = getLiq(allReservas[idx]);
  let panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  // Preserve scroll position to avoid layout jump
  let wrap = panel.closest('.table-wrap') || panel.closest('.main');
  let scrollY = wrap ? wrap.scrollTop : window.scrollY;
  let colCount = v === 'c'
    ? CONSOL_COLUMNS.filter(function(col){return consolColVis[col.key]!==false;}).length
    : COLUMNS.filter(function(col){return colVisibility[col.key]!==false;}).length;
  let ce = s.conceptosEspeciales || [];
  let itemsHtml = ce.map(function(item, i) {
    return '<div class="ce-item-row"><input class="ce-inp-label" type="text" value="'+(item.label||'').replace(/"/g,'&quot;')+'" onchange="updateCEItem('+idx+','+i+',\'label\',this.value,\''+v+'\')" onkeydown="_ceKey(event,'+idx+',\''+v+'\',false)" placeholder="'+t('ce.placeholder')+'" /><input class="ce-inp-amt" type="text" value="'+fmt(item.amount||0)+'" onchange="updateCEItem('+idx+','+i+',\'amount\',this.value,\''+v+'\')" onkeydown="_ceKey(event,'+idx+',\''+v+'\',true)" /><button class="ce-del" onclick="removeCEItem('+idx+','+i+',\''+v+'\')">&#215;</button></div>';
  }).join('');
  let _b = 'text-align:center;padding:8px 12px;border-radius:8px;min-width:110px;';
  panel.innerHTML = '<td colspan="'+colCount+'" style="padding:0"><div class="ce-panel-inner"><div class="ce-panel-left"><div class="ce-panel-title">'+t('ce.title')+' <span class="ce-eye">'+t('ce.internalOnly')+'</span></div>'+itemsHtml+'<div class="ce-add-link" onclick="addCEItem('+idx+',\''+v+'\')">'+t("ce.addItem")+'</div></div><div class="ce-panel-summary" style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;"><div style="'+_b+'background:#f3f4f6;"><div class="ce-sum-label" style="color:#374151">'+t('ce.totalReserva')+'<br>'+t('ce.ivaInc')+'</div><div class="ce-sum-val" style="color:#1a2744">'+fmt(c.totalOriginal)+' &#8364;</div></div><div style="'+_b+'background:#fef3c7;"><div class="ce-sum-label">'+t('ce.deduct')+'<br>'+t('ce.ivaInc')+'</div><div class="ce-sum-val">&#8211; '+fmt(c.ceTotal)+' &#8364;</div></div><div style="'+_b+'background:#fff3e0;"><div class="ce-sum-label" style="color:#e65100">'+t('ce.totalSinCE')+'<br>'+t('ce.ivaInc')+'</div><div class="ce-sum-val" style="color:#e65100">'+fmt(c.total)+' &#8364;</div></div><div style="'+_b+'background:#e8f5e9;"><div class="ce-sum-label" style="color:#2e7d32">'+t('ce.totalSinCE')+'<br>'+t('ce.sinIVA')+'</div><div class="ce-sum-val" style="color:#2e7d32;font-size:15px">'+fmt(c.baseSinIVA)+' &#8364;</div></div></div></div></td>';
  // Restore scroll position to prevent jump
  if (wrap) wrap.scrollTop = scrollY;
  // Auto-focus the last added label input
  let labels = panel.querySelectorAll('.ce-inp-label');
  if (labels.length > 0) labels[labels.length - 1].focus({preventScroll:true});
}

// ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ [M12-CE2] Conceptos Extraordinarios Sin IVA (CE2) ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬

// === CE2: CONCEPTOS ESPECIALES SIN IVA (violet) ===
function _buildCE2Button(idx, c, view) {
  const v = view || 'p';
  if (c.ceSinIvaTotal > 0) {
    return `<button class="ce2-btn has" onclick="event.stopPropagation();toggleCE2Panel(${idx},'${v}')"><span class="ce2-dot"></span>&#8211;${fmt(c.ceSinIvaTotal)} &#8364;</button>`;
  }
  return `<button class="ce2-btn" onclick="event.stopPropagation();toggleCE2Panel(${idx},'${v}')" title="${t('ce2.specialConcepts')}">+</button>`;
}

function _buildCE2PanelRow(idx, s, c, view) {
  const v = view || 'p';
  const ce2 = s.conceptosSinIVA || [];
  const colCount = v === 'c'
    ? CONSOL_COLUMNS.filter(function(col){return consolColVis[col.key]!==false;}).length
    : COLUMNS.filter(function(col){return colVisibility[col.key]!==false;}).length;
  const itemsHtml = ce2.map(function(item, i) {
    return `<div class="ce2-item-row"><input class="ce2-inp-label" type="text" value="${(item.label||'').replace(/"/g,'&quot;')}" onchange="updateCE2Item(${idx},${i},'label',this.value,'${v}')" onkeydown="_ce2Key(event,${idx},'${v}',false)" placeholder="${t('ce2.placeholder')}" /><input class="ce2-inp-amt" type="text" value="${fmt(item.amount||0)}" onchange="updateCE2Item(${idx},${i},'amount',this.value,'${v}')" onkeydown="_ce2Key(event,${idx},'${v}',true)" /><button class="ce2-del" onclick="removeCE2Item(${idx},${i},'${v}')">&#215;</button></div>`;
  }).join('');
  const subBefore = c.sub + c.ceSinIvaTotal; // subtotal before CE2 deduction
  const _b = 'text-align:center;padding:8px 12px;border-radius:8px;min-width:110px;';
  return `<tr class="ce2-panel-row" id="ce2-${v}panel-${idx}" style="display:none"><td colspan="${colCount}" style="padding:0"><div class="ce2-panel-inner"><div class="ce2-panel-left"><div class="ce2-panel-title">${t("ce2.title")} <span class="ce2-eye">${t("ce2.subtractSub")}</span></div>${itemsHtml}<div class="ce2-add-link2" onclick="addCE2Item(${idx},'${v}')">${t("ce.addItem")}</div></div><div class="ce2-panel-summary" style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;"><div style="${_b}background:#f3f4f6;"><div class="ce2-sum-label" style="color:#374151">${t("ce2.subBefore")}<br>${t("ce2.beforeCE")}</div><div class="ce2-sum-val" style="color:#1a2744">${fmt(subBefore)} &#8364;</div></div><div style="${_b}background:#f5f0ff;"><div class="ce2-sum-label" style="color:#6d28d9">${t("ce2.deductNoVat")}<br>${t("ce.sinIVA")}</div><div class="ce2-sum-val" style="color:#7c3aed">&#8211; ${fmt(c.ceSinIvaTotal)} &#8364;</div></div><div style="${_b}background:#ede9fe;"><div class="ce2-sum-label" style="color:#5b21b6">${t("ce2.subFinal")}<br>${t("ce2.final")}</div><div class="ce2-sum-val" style="color:#5b21b6">${fmt(c.sub)} &#8364;</div></div></div></div></td></tr>`;
}

let _openCE2Panel = null;
let _openCE2View = 'p';
function toggleCE2Panel(idx, view) {
  if (idx == null || !allReservas[idx]) return;
  const v = view || 'p';
  const panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  if (_openCE2Panel !== null && (_openCE2Panel !== idx || _openCE2View !== v)) {
    let prev = document.getElementById('ce2-' + _openCE2View + 'panel-' + _openCE2Panel);
    if (prev) prev.style.display = 'none';
  }
  if (panel.style.display === 'none') {
    let wrap = panel.closest('.table-wrap');
    let st = wrap ? wrap.scrollTop : window.scrollY;
    panel.style.display = '';
    if (wrap) wrap.scrollTop = st; else window.scrollTo(0, st);
    _openCE2Panel = idx;
    _openCE2View = v;
    let s = settings[idx];
    if (!s.conceptosSinIVA || s.conceptosSinIVA.length === 0) {
      s.conceptosSinIVA = [{label:'', amount:0}];
      _refreshCE2Panel(idx, v);
    }
  } else {
    panel.style.display = 'none';
    _openCE2Panel = null;
  }
}

function addCE2Item(idx, view) {
  let s = settings[idx]; if (!s) return;
  if (!s.conceptosSinIVA) s.conceptosSinIVA = [];
  let i = s.conceptosSinIVA.length;
  s.conceptosSinIVA.push({label:'', amount:0});
  let v = view || 'p';
  let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  let addLink = panel.querySelector('.ce2-add-link2');
  if (!addLink) { _refreshCE2Panel(idx, v); return; }
  let row = document.createElement('div');
  row.className = 'ce2-item-row ce2-new';
  row.innerHTML = '<input class="ce2-inp-label" type="text" value="" onchange="updateCE2Item('+idx+','+i+',\'label\',this.value,\''+v+'\')" onkeydown="_ce2Key(event,'+idx+',\''+v+'\',false)" placeholder="'+t('ce2.placeholder')+'" /><input class="ce2-inp-amt" type="text" value="0,00" onchange="updateCE2Item('+idx+','+i+',\'amount\',this.value,\''+v+'\')" onkeydown="_ce2Key(event,'+idx+',\''+v+'\',true)" /><button class="ce2-del" onclick="removeCE2Item('+idx+','+i+',\''+v+'\')">&#215;</button>';
  addLink.parentNode.insertBefore(row, addLink);
  row.querySelector('.ce2-inp-label').focus({preventScroll:true});
  scheduleReservaConfigSave(idx);
}

function removeCE2Item(idx, itemIdx, view) {
  let s = settings[idx]; if (!s || !s.conceptosSinIVA) return;
  let v = view || 'p';
  let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  let rows = panel ? panel.querySelectorAll('.ce2-item-row') : [];
  if (rows[itemIdx]) {
    let row = rows[itemIdx];
    row.style.animation = 'ceRowOut .2s ease forwards';
    row.addEventListener('animationend', function() {
      row.remove();
      s.conceptosSinIVA.splice(itemIdx, 1);
      let oldC = getLiq(allReservas[idx]);
      invalidateCache(idx);
      let newC = getLiq(allReservas[idx]);
      if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
      let mainRow = document.getElementById('row-' + idx);
      if (mainRow) {
        let ce2Cel = mainRow.querySelector('.col-ceSinIva');
        if (ce2Cel) ce2Cel.innerHTML = _buildCE2Button(idx, newC, v);
        let liqCel = mainRow.querySelector('.col-totalLiquidar');
        if (liqCel) liqCel.innerHTML = fmt(newC.totalLiq) + ' &#8364;';
        let subCel = mainRow.querySelector('.col-subtotal');
        if (subCel) subCel.innerHTML = fmt(newC.sub) + ' &#8364;';
      }
      _refreshCE2Summary(idx, v);
      let st = _cachedFilteredStats;
      if (st && oldC && newC) {
        st.fL += (newC.totalLiq - oldC.totalLiq);
        st.tLiq += (newC.totalLiq - oldC.totalLiq);
        st.tCE2 += (newC.ceSinIvaTotal - oldC.ceSinIvaTotal);
        st.tSub += (newC.sub - oldC.sub);
        _renderStatsFromCache(_lastFiltered, st);
      }
      scheduleReservaConfigSave(idx);
      if (v === 'c' && currentConsolAloj) _patchConsolLightweight(idx, oldC, newC);
    }, {once:true});
  } else {
    s.conceptosSinIVA.splice(itemIdx, 1);
    _applyCE2Change(idx, v);
  }
}

function updateCE2Item(idx, itemIdx, field, rawVal, view) {
  let s = settings[idx]; if (!s || !s.conceptosSinIVA || !s.conceptosSinIVA[itemIdx]) return;
  if (field === 'label') {
    s.conceptosSinIVA[itemIdx].label = rawVal;
    scheduleReservaConfigSave(idx);
  } else {
    let v = parseFloat(String(rawVal).replace(/\./g,'').replace(',','.'));
    if (isNaN(v)) v = 0;
    s.conceptosSinIVA[itemIdx].amount = v;
    _applyCE2Change(idx, view || 'p');
  }
}

function _applyCE2Change(idx, view) {
  let v = view || 'p';
  let oldC = getLiq(allReservas[idx]);
  invalidateCache(idx);
  let newC = getLiq(allReservas[idx]);
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _refreshCE2Summary(idx, v);
  _patchMainRowCells(idx, oldC, newC);
  scheduleReservaConfigSave(idx);
  if (v === 'c' && currentConsolAloj) {
    _patchConsolLightweight(idx, oldC, newC);
  } else {
    let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
    if (panel) { panel.style.display = ''; _openCE2Panel = idx; _openCE2View = v; }
  }
}

function _refreshCE2Summary(idx, view) {
  let v = view || 'p';
  let c = getLiq(allReservas[idx]);
  let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  let vals = panel.querySelectorAll('.ce2-sum-val');
  const subBefore = c.sub + c.ceSinIvaTotal;
  if (vals.length >= 3) {
    vals[0].innerHTML = fmt(subBefore) + ' &#8364;';
    vals[1].innerHTML = '&#8211; ' + fmt(c.ceSinIvaTotal) + ' &#8364;';
    vals[2].innerHTML = fmt(c.sub) + ' &#8364;';
  }
  // Always sync the CE2 button in the main table row
  var mainRow = document.getElementById('row-' + idx);
  if (mainRow) {
    var ce2Cel = mainRow.querySelector('.col-ceSinIva');
    if (ce2Cel) ce2Cel.innerHTML = _buildCE2Button(idx, c, v);
  }
  let rows = panel.querySelectorAll('.ce2-item-row');
  rows.forEach(function(row, i) {
    const del = row.querySelector('.ce2-del');
    if (del) del.setAttribute('onclick', "removeCE2Item("+idx+","+i+",'"+v+"')");
    let lbl = row.querySelector('.ce2-inp-label');
    if (lbl) lbl.setAttribute('onchange', "updateCE2Item("+idx+","+i+",'label',this.value,'"+v+"')");
    let amt = row.querySelector('.ce2-inp-amt');
    if (amt) amt.setAttribute('onchange', "updateCE2Item("+idx+","+i+",'amount',this.value,'"+v+"')");
  });
}

function _refreshCE2Panel(idx, view) {
  let v = view || 'p';
  let s = settings[idx] || {}, c = getLiq(allReservas[idx]);
  let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  let wrap = panel.closest('.table-wrap') || panel.closest('.main');
  let scrollY = wrap ? wrap.scrollTop : window.scrollY;
  let colCount = v === 'c'
    ? CONSOL_COLUMNS.filter(function(col){return consolColVis[col.key]!==false;}).length
    : COLUMNS.filter(function(col){return colVisibility[col.key]!==false;}).length;
  let ce2 = s.conceptosSinIVA || [];
  let itemsHtml = ce2.map(function(item, i) {
    return '<div class="ce2-item-row"><input class="ce2-inp-label" type="text" value="'+(item.label||'').replace(/"/g,'&quot;')+'" onchange="updateCE2Item('+idx+','+i+',\'label\',this.value,\''+v+'\')" onkeydown="_ce2Key(event,'+idx+',\''+v+'\',false)" placeholder="'+t('ce2.placeholder')+'" /><input class="ce2-inp-amt" type="text" value="'+fmt(item.amount||0)+'" onchange="updateCE2Item('+idx+','+i+',\'amount\',this.value,\''+v+'\')" onkeydown="_ce2Key(event,'+idx+',\''+v+'\',true)" /><button class="ce2-del" onclick="removeCE2Item('+idx+','+i+',\''+v+'\')">&#215;</button></div>';
  }).join('');
  const subBefore = c.sub + c.ceSinIvaTotal;
  let _b = 'text-align:center;padding:8px 12px;border-radius:8px;min-width:110px;';
  panel.innerHTML = '<td colspan="'+colCount+'" style="padding:0"><div class="ce2-panel-inner"><div class="ce2-panel-left"><div class="ce2-panel-title">'+t('ce2.title')+' <span class="ce2-eye">'+t('ce2.subtractSub')+'</span></div>'+itemsHtml+'<div class="ce2-add-link2" onclick="addCE2Item('+idx+',\''+v+'\')">'+t("ce.addItem")+'</div></div><div class="ce2-panel-summary" style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;"><div style="'+_b+'background:#f3f4f6;"><div class="ce2-sum-label" style="color:#374151">'+t('ce2.subBefore')+'<br>'+t('ce2.beforeCE')+'</div><div class="ce2-sum-val" style="color:#1a2744">'+fmt(subBefore)+' &#8364;</div></div><div style="'+_b+'background:#f5f0ff;"><div class="ce2-sum-label" style="color:#6d28d9">'+t('ce2.deductNoVat')+'<br>'+t('ce.sinIVA')+'</div><div class="ce2-sum-val" style="color:#7c3aed">&#8211; '+fmt(c.ceSinIvaTotal)+' &#8364;</div></div><div style="'+_b+'background:#ede9fe;"><div class="ce2-sum-label" style="color:#5b21b6">'+t('ce2.subFinal')+'<br>'+t('ce2.final')+'</div><div class="ce2-sum-val" style="color:#5b21b6">'+fmt(c.sub)+' &#8364;</div></div></div></div></td>';
  if (wrap) wrap.scrollTop = scrollY;
  let labels = panel.querySelectorAll('.ce2-inp-label');
  if (labels.length > 0) labels[labels.length - 1].focus({preventScroll:true});
}

/**
 * @description Render completo de la tabla: filtrado + stats + cabecera + filas + footer + paginaciÃƒÆ’Ã‚Â³n.
 * Se llama tras cambios en filtros, datos o navegaciÃƒÆ’Ã‚Â³n.
 * @private
 */
function _renderFull() {
  const fil = getFilteredSorted();
  _lastFiltered = fil;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value, sortD = simpleComboState.sortdir.value;
  const hasFilter = comboState.platform.selected.size > 0 || comboState.aloj.selected.size > 0 || sf2 !== "all" || _mpHasFilter();

  document.getElementById("filter-count").textContent = fil.length + " " + t("stats.reservationCount");

  // Single pass over filtered: stats + totals + button counts
  const st = _computeStatsFromScratch(fil);
  const filPendingCount = st.filPendingCount, filValidatedCount = st.filValidatedCount;
  const fR = st.fR, fL = st.fL, fV = st.fV;
  const tNoches = st.tNoches, tTotal = st.tTotal, tBase = st.tBase;
  const tComPlat = st.tComPlat, tComGTC = st.tComGTC, tLimp = st.tLimp, tAmen = st.tAmen;
  const tComPas = st.tComPas, tSub = st.tSub, tRet = st.tRet, tIva21 = st.tIva21, tLiq = st.tLiq;
  const tCE = st.tCE;
  const tCE2 = st.tCE2;

  // Global stats (cached)
  const gs = getGlobalStats();
  const tR = gs.tR, tL = gs.tL;
  const vC = validated.size;

  const btnVal = document.getElementById("btn-validar-todas");
  const btnDesval = document.getElementById("btn-desvalidar-todas");
  btnVal.style.display = filPendingCount > 0 ? '' : 'none';
  btnVal.textContent = filPendingCount === fil.length ? `\u2713 ${t('btn.validateAll')} (${filPendingCount})` : `\u2713 ${t('btn.validatePending')} (${filPendingCount})`;
  btnDesval.style.display = filValidatedCount > 0 ? '' : 'none';
  btnDesval.textContent = filValidatedCount === fil.length ? `\u21A9 ${t('btn.unvalidateAll')} (${filValidatedCount})` : `\u21A9 ${t('btn.unvalidateValidated')} (${filValidatedCount})`;

  const pctR = allReservas.length > 0 ? (fil.length / allReservas.length * 100).toFixed(1) : 0;
  const pctTR = tR > 0 ? (fR / tR * 100).toFixed(1) : 0;
  const pctTL = tL > 0 ? (fL / tL * 100).toFixed(1) : 0;
  const pctV = vC > 0 ? (fV / vC * 100).toFixed(1) : 0;
  document.getElementById("stats-row").innerHTML = `
    <div class="stat-card"><div class="stat-label">${t("stats.reservations")}</div><div class="stat-value">${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fil.length} ${t("stats.filtered")} <span class="stat-pct">(${pctR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">${t("stats.totalReservations")}</div><div class="stat-value" style="color:#1a2744">${fmt(tR)} \u20AC</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(fR)} \u20AC <span class="stat-pct">(${pctTR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">${t("stats.totalToSettle")}</div><div class="stat-value" style="color:#4f8cff">${fmt(tL)} \u20AC</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(fL)} \u20AC <span class="stat-pct">(${pctTL}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">${t("stats.validated")}</div><div class="stat-value" style="color:#43a047">${vC} / ${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fV} / ${fil.length} ${t("stats.filtered")} <span class="stat-pct">(${pctV}%)</span></div>` : ''}</div>`;

  const thead = document.getElementById("table-header");
  thead.innerHTML = COLUMNS.map(c => { const is = sortF === c.key; const ar = c.sortable ? `<span class="sort-arrow">${is ? (sortD === "asc" ? "&#9650;" : "&#9660;") : "&#8661;"}</span>` : "";
    const cls = ["col-" + c.key, c.right ? "right" : "", is ? "sorted" : "", c.sortable ? "" : "no-sort"].filter(Boolean).join(" ");
    return `<th class="${cls}" ${c.sortable ? `onclick="sortByColumn('${c.key}')"` : ""}>${c.label}${ar}</th>`; }).join("");

  // PAGINATION: render only current page slice
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  if (_currentPage > totalPages) _currentPage = totalPages;
  const startIdx = (_currentPage - 1) * _pageSize;
  const endIdx = Math.min(startIdx + _pageSize, fil.length);

  // Build row HTML for current page only
  const rowsHtml = new Array(endIdx - startIdx);
  for (let i = startIdx; i < endIdx; i++) {
    rowsHtml[i - startIdx] = _buildRowHtml(fil[i]);
  }
  document.getElementById("table-body").innerHTML = rowsHtml.join('');

  // Pagination bar
  _updatePaginationBar(fil.length, totalPages);

  // Totals footer (always over ALL filtered, not just visible)
  _updateFooter(fil.length, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq, tCE, tCE2);
}

// Fast re-render for page changes only \u2014 no stats recalc
function _renderPageOnly() {
  const fil = getFilteredSorted();
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  if (_currentPage > totalPages) _currentPage = totalPages;
  const startIdx = (_currentPage - 1) * _pageSize;
  const endIdx = Math.min(startIdx + _pageSize, fil.length);
  const rowsHtml = new Array(endIdx - startIdx);
  for (let i = startIdx; i < endIdx; i++) {
    rowsHtml[i - startIdx] = _buildRowHtml(fil[i]);
  }
  document.getElementById("table-body").innerHTML = rowsHtml.join('');
  _updatePaginationBar(fil.length, totalPages);
}

function _updatePaginationBar(totalCount, totalPages) {
  const pagBar = document.getElementById("pagination-bar");
  if (totalCount === 0) { pagBar.style.display = 'none'; return; }
  pagBar.style.display = 'flex';

  const startIdx = (_currentPage - 1) * _pageSize + 1;
  const endIdx = Math.min(_currentPage * _pageSize, totalCount);

  // Build page buttons (show max 7 pages with ellipsis)
  let pageButtons = '';
  const maxBtns = 7;
  let pages = [];
  if (totalPages <= maxBtns) {
    for (let i = 1; i <= totalPages; i++) pages.push(i);
  } else {
    pages.push(1);
    let lo = Math.max(2, _currentPage - 1);
    let hi = Math.min(totalPages - 1, _currentPage + 1);
    if (_currentPage <= 3) { lo = 2; hi = 5; }
    if (_currentPage >= totalPages - 2) { lo = totalPages - 4; hi = totalPages - 1; }
    if (lo > 2) pages.push('...');
    for (let i = lo; i <= hi; i++) pages.push(i);
    if (hi < totalPages - 1) pages.push('...');
    pages.push(totalPages);
  }

  pages.forEach(p => {
    if (p === '...') {
      pageButtons += `<span style="padding:4px 2px;color:#9ca3af;font-size:12px;">\u2026</span>`;
    } else {
      const active = p === _currentPage;
      pageButtons += `<button onclick="goToPage(${p})" style="
        min-width:32px;height:32px;border-radius:6px;border:1.5px solid ${active ? '#4f8cff' : '#dde1e8'};
        background:${active ? '#4f8cff' : '#fff'};color:${active ? '#fff' : '#6b7280'};
        font-size:12px;font-weight:${active ? '700' : '500'};cursor:pointer;font-family:inherit;
        transition:all 0.15s;" onmouseover="if(!${active})this.style.borderColor='#4f8cff'" onmouseout="if(!${active})this.style.borderColor='#dde1e8'">${p}</button>`;
    }
  });

  // Page size options
  const sizes = [100, 500, 1000];
  const sizeOpts = sizes.map(s => `<option value="${s}" ${_pageSize === s ? 'selected' : ''}>${s}</option>`).join('');

  pagBar.innerHTML = `
    <div style="display:flex;align-items:center;gap:6px;">
      <button onclick="goToPage(_currentPage-1)" class="btn btn-sm btn-outline" style="padding:4px 10px;${_currentPage <= 1 ? 'opacity:0.4;pointer-events:none;' : ''}">&#8249;</button>
      ${pageButtons}
      <button onclick="goToPage(_currentPage+1)" class="btn btn-sm btn-outline" style="padding:4px 10px;${_currentPage >= totalPages ? 'opacity:0.4;pointer-events:none;' : ''}">&#8250;</button>
    </div>
    <span style="font-size:12px;color:#6b7280;">${startIdx}\u2013${endIdx} ${t("pager.of")} ${totalCount}</span>
    <div style="display:flex;align-items:center;gap:6px;">
      <label style="font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;">Mostrar</label>
      <select class="sel" style="font-size:12px;padding:4px 8px;" onchange="changePageSize(parseInt(this.value))">${sizeOpts}</select>
    </div>`;
}

function goToPage(p) {
  const fil = getFilteredSorted();
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  _currentPage = Math.max(1, Math.min(p, totalPages));
  _renderPageOnly();
  // Scroll table to top
  document.querySelector('#screen-list .table-wrap').scrollTop = 0;
}

function changePageSize(size) {
  // Keep roughly the same scroll position
  const firstVisibleIdx = (_currentPage - 1) * _pageSize;
  _pageSize = size;
  _currentPage = Math.max(1, Math.floor(firstVisibleIdx / _pageSize) + 1);
  _renderPageOnly();
}

function _updateFooter(count, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq, tCE, tCE2) {
  const tfoot = document.getElementById("table-foot");
  const _fs = 'border:none;padding:10px 8px;';
  const _fr = 'border:none;padding:10px 8px;color:#ff8a80;text-align:center;font-variant-numeric:tabular-nums;';
  tfoot.innerHTML = count > 0 ? `<tr style="background:#0f1628;color:#fff;font-weight:700;font-size:12px;">
    <td class="col-estado" style="${_fs}"></td>
    <td class="col-idReserva" style="${_fs}"></td>
    <td class="col-localizador" style="${_fs}"></td>
    <td class="col-fechaAlta" style="${_fs}"></td>
    <td class="col-cliente" style="${_fs}text-align:right;text-transform:uppercase;letter-spacing:0.06em;font-size:11px;color:rgba(255,255,255,0.6);">${t('consol.reservasTotal')} (${count})</td>
    <td class="col-alojamiento" style="${_fs}"></td>
    <td class="col-edificio" style="${_fs}"></td>
    <td class="col-plataforma" style="${_fs}"></td>
    <td class="col-atendidoPor" style="${_fs}"></td>
    <td class="col-origenMarketing" style="${_fs}"></td>
    <td class="col-tipoReserva" style="${_fs}"></td>
    <td class="col-fechaEntrada" style="${_fs}"></td>
    <td class="col-fechaSalida" style="${_fs}"></td>
    <td class="col-noches" style="${_fs}text-align:center;">${tNoches}</td>
    <td class="col-totalReserva" style="${_fs}text-align:right;">${fmt(tTotal)} &#8364;</td>
    <td class="col-ce" style="${_fs}text-align:center;color:#d97706;font-size:11px;">${tCE > 0 ? '&#8211; ' + fmt(tCE) + ' &#8364;' : ''}</td>
    <td class="col-baseSinIVA" style="${_fs}text-align:right;color:rgba(255,255,255,0.6);">${fmt(tBase)} &#8364;</td>
    <td class="col-comPlataforma" style="${_fr}">${fmt(tComPlat)} &#8364;</td>
    <td class="col-comGTC" style="${_fr}">${fmt(tComGTC)} &#8364;</td>
    <td class="col-limpieza" style="${_fr}">${fmt(tLimp)} &#8364;</td>
    <td class="col-amenities" style="${_fr}">${fmt(tAmen)} &#8364;</td>
    <td class="col-pasarela" style="${_fr}">${tComPas > 0 ? fmt(tComPas) + ' &#8364;' : '&#8211;'}</td>
    <td class="col-ceSinIva" style="${_fs}text-align:center;color:#c4b5fd;font-size:11px;">${tCE2 > 0 ? '&#8211; ' + fmt(tCE2) + ' &#8364;' : ''}</td>
    <td class="col-subtotal" style="${_fs}text-align:right;">${fmt(tSub)} &#8364;</td>
    <td class="col-irpf" style="${_fr}">&#8211; ${fmt(tRet)} &#8364;</td>
    <td class="col-iva21" style="${_fs}text-align:center;color:#81c784;font-variant-numeric:tabular-nums;">+ ${fmt(tIva21)} &#8364;</td>
    <td class="col-totalLiquidar" style="${_fs}text-align:right;color:#81d4fa;font-size:14px;">${fmt(tLiq)} &#8364;</td>
    <td class="col-observacion" style="${_fs}"></td>
    <td class="col-acciones" style="${_fs}"></td>
  </tr>` : '';
}

/**
 * @description Cambia un ajuste individual de una reserva y actualiza la UI.
 * Usa delta-update: actualiza solo la fila afectada sin re-render completo.
 * @param {number} i - ÃƒÆ’Ã‚Ândice de la reserva
 * @param {string} k - Clave del setting ('comPlataforma', 'comGTC', etc.)
 * @param {*} v - Nuevo valor
 */
function changeSetting(i,k,v){
  if (!allReservas[i] || !settings[i]) { console.warn('[Settings] Invalid index:', i); return; }
  if (typeof v === 'number' && isNaN(v)) { console.warn('[Settings] NaN value for', k); return; }
  const oldC = getLiq(allReservas[i]); // capture BEFORE invalidating
  settings[i][k]=v; invalidateCache(i);
  const newC = getLiq(allReservas[i]);
  // Delta update global stats O(1) instead of recomputing O(n)
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _patchSingleRow(i, oldC, newC);
  scheduleReservaConfigSave(i);
}
function validarTodas() { const pending=_lastFiltered.filter(r=>!validated.has(r.idx)); const n=pending.length; if(!n||!confirm(`\u00BFValidar ${n} reserva${n>1?'s':''}?`))return; pending.forEach(r => validated.add(r.idx)); _validatedVersion++; invalidateFilterCache(); renderTable(); batchWriteValidation(pending.map(r=>r.idx), true); }
function desvalidarTodas() { const vals=_lastFiltered.filter(r=>validated.has(r.idx)); const n=vals.length; if(!n||!confirm(`\u00BFDesvalidar ${n} reserva${n>1?'s':''}?`))return; vals.forEach(r => validated.delete(r.idx)); _validatedVersion++; invalidateFilterCache(); renderTable(); batchWriteValidation(vals.map(r=>r.idx), false); }
function changeSettingConsol(i,k,v){const oldC=getLiq(allReservas[i]);settings[i][k]=v;invalidateCache(i);const newC=getLiq(allReservas[i]);if(_globalStatsCache)_globalStatsCache.tL+=(newC.totalLiq-oldC.totalLiq);if(currentConsolAloj)viewConsolDetail(currentConsolAloj);scheduleReservaConfigSave(i);}
function togglePasarelaConsol(i){const oldC=getLiq(allReservas[i]);settings[i].pasarela=!settings[i].pasarela;invalidateCache(i);const newC=getLiq(allReservas[i]);if(_globalStatsCache)_globalStatsCache.tL+=(newC.totalLiq-oldC.totalLiq);if(currentConsolAloj)viewConsolDetail(currentConsolAloj);scheduleReservaConfigSave(i);}
function toggleValidateConsol(i){const wasV=validated.has(i);if(wasV)validated.delete(i);else validated.add(i);_validatedVersion++;invalidateFilterCache();if(currentConsolAloj)viewConsolDetail(currentConsolAloj);writeValidationToSheet(i,!wasV);}
function validarTodasConsol(alojName) {
  let src=allReservas.filter(r => r.alojamiento === alojName);
  if (_mpHasFilter()) src = src.filter(r => _mpMatchDate(r._dEntrada));
  const pending=src.filter(r => !validated.has(r.idx));
  if(!pending.length||!confirm(`\u00BFValidar ${pending.length} reserva${pending.length>1?'s':''} de ${alojName}?`))return;
  pending.forEach(r => validated.add(r.idx));
  _validatedVersion++; invalidateFilterCache();
  if(currentConsolAloj) viewConsolDetail(currentConsolAloj);
  batchWriteValidation(pending.map(r=>r.idx), true);
}
function desvalidarTodasConsol(alojName) {
  let src=allReservas.filter(r => r.alojamiento === alojName);
  if (_mpHasFilter()) src = src.filter(r => _mpMatchDate(r._dEntrada));
  const vals=src.filter(r => validated.has(r.idx));
  if(!vals.length||!confirm(`\u00BFDesvalidar ${vals.length} reserva${vals.length>1?'s':''} de ${alojName}?`))return;
  vals.forEach(r => validated.delete(r.idx));
  _validatedVersion++; invalidateFilterCache();
  if(currentConsolAloj) viewConsolDetail(currentConsolAloj);
  batchWriteValidation(vals.map(r=>r.idx), false);
}
function togglePasarela(i){
  const oldC = getLiq(allReservas[i]);
  settings[i].pasarela=!settings[i].pasarela; invalidateCache(i);
  const newC = getLiq(allReservas[i]);
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _patchSingleRow(i, oldC, newC);
  scheduleReservaConfigSave(i);
}
function toggleValidate(i){
  const wasValidated = validated.has(i);
  if(wasValidated) validated.delete(i); else validated.add(i);
  _validatedVersion++;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value;
  if (sf2 !== 'all' || sortF === 'estado') {
    invalidateFilterCache();
    renderTable();
  } else {
    // Patch path \u2014 filtered set unchanged, just toggle badge + update stats
    _patchSingleRow(i, null, null, wasValidated);
  }
  if(document.getElementById("screen-detail").classList.contains("active"))viewDetail(i);
  if(document.getElementById("screen-consoldetail").classList.contains("active") && currentConsolAloj) viewConsolDetail(currentConsolAloj);
  writeValidationToSheet(i, !wasValidated);
}

// \u2500\u2500\u2500 CACHED STATS for incremental updates \u2500\u2500\u2500
let _cachedFilteredStats = null; // { filPendingCount, filValidatedCount, fR, fL, fV, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq }

function _computeStatsFromScratch(fil) {
  const s = { filPendingCount:0, filValidatedCount:0, fR:0, fL:0, fV:0,
    tNoches:0, tTotal:0, tBase:0, tComPlat:0, tComGTC:0, tLimp:0, tAmen:0, tComPas:0, tSub:0, tRet:0, tIva21:0, tLiq:0, tCE:0, tCE2:0 };
  for (let i = 0; i < fil.length; i++) {
    const r = fil[i], c = getLiq(r), isV = validated.has(r.idx);
    s.fR += r.totalReserva; s.fL += c.totalLiq;
    if (isV) { s.fV++; s.filValidatedCount++; } else s.filPendingCount++;
    s.tNoches += r._nights; s.tTotal += r.totalReserva; s.tBase += c.baseSinIVA;
    s.tComPlat += c.comPlat; s.tComGTC += c.comGTC; s.tLimp += c.limp; s.tAmen += c.amen; s.tComPas += c.comPas;
    s.tSub += c.sub; s.tRet += c.ret; s.tIva21 += c.iva; s.tLiq += c.totalLiq; s.tCE += c.ceTotal; s.tCE2 += c.ceSinIvaTotal;
  }
  _cachedFilteredStats = s;
  return s;
}

function _getOrComputeStats(fil) {
  if (_cachedFilteredStats) return _cachedFilteredStats;
  return _computeStatsFromScratch(fil);
}

// \u2500\u2500\u2500 IN-PLACE ROW UPDATE O(1) \u2500\u2500\u2500
/**
 * @description Actualiza una sola fila de la tabla sin reconstruir todo el DOM.
 * TÃƒÆ’Ã‚Â©cnica delta-update: compara cÃƒÆ’Ã‚Â¡lculos antiguos vs nuevos y actualiza solo
 * las celdas numÃƒÆ’Ã‚Â©ricas que han cambiado, mÃƒÆ’Ã‚Â¡s el footer incrementalmente.
 * @param {number} idx - ÃƒÆ’Ã‚Ândice de la reserva
 * @param {Object} oldC - CÃƒÆ’Ã‚Â¡lculos anteriores (de calcLiquidacion)
 * @param {Object} newC - CÃƒÆ’Ã‚Â¡lculos nuevos
 * @param {boolean} validationFlipped - Si cambiÃƒÆ’Ã‚Â³ el estado de validaciÃƒÆ’Ã‚Â³n
 * @private
 */
function _patchSingleRow(idx, oldC, newC, validationFlipped) {
  const row = document.getElementById("row-" + idx);
  if (!row) { renderTable(); return; }
  const r = allReservas[idx];
  if (!r) return;

  // Save scroll position before DOM changes
  const wrap = row.closest('.table-wrap');
  const scrollBefore = wrap ? wrap.scrollTop : window.scrollY;

  // Build new HTML (main row + CE panel row + CE2 panel row)
  const tmp = document.createElement('tbody');
  tmp.innerHTML = _buildRowHtml(r);
  let newMainRow = tmp.children[0];
  let newCePanel = tmp.children[1]; // CE (IVA inc.) panel
  let newCe2Panel = tmp.children[2]; // CE (Sin IVA) panel

  // Remember if CE panels were open
  let oldCePanel = document.getElementById('ce-ppanel-' + idx);
  let cePanelWasOpen = oldCePanel && oldCePanel.style.display !== 'none';
  let oldCe2Panel = document.getElementById('ce2-ppanel-' + idx);
  let ce2PanelWasOpen = oldCe2Panel && oldCe2Panel.style.display !== 'none';

  // Batch all DOM mutations: use replaceWith to swap in one go
  let fragment = document.createDocumentFragment();
  fragment.appendChild(newMainRow);
  if (newCePanel) {
    if (cePanelWasOpen) { newCePanel.style.display = ''; _openCEPanel = idx; _openCEView = 'p'; }
    fragment.appendChild(newCePanel);
  }
  if (newCe2Panel) {
    if (ce2PanelWasOpen) { newCe2Panel.style.display = ''; _openCE2Panel = idx; _openCE2View = 'p'; }
    fragment.appendChild(newCe2Panel);
  }
  if (oldCe2Panel) oldCe2Panel.remove();
  if (oldCePanel) oldCePanel.remove();
  row.replaceWith(fragment);

  // Restore scroll position synchronously
  if (wrap) wrap.scrollTop = scrollBefore; else window.scrollTo(0, scrollBefore);

  // Incremental stats update
  const fil = _lastFiltered;
  if (!fil) { renderTable(); return; }

  let st = _cachedFilteredStats;
  if (!st) { st = _computeStatsFromScratch(fil); }

  if (oldC && newC) {
    st.fL += (newC.totalLiq - oldC.totalLiq);
    st.tBase += (newC.baseSinIVA - oldC.baseSinIVA);
    st.tComPlat += (newC.comPlat - oldC.comPlat);
    st.tComGTC += (newC.comGTC - oldC.comGTC);
    st.tLimp += (newC.limp - oldC.limp);
    st.tAmen += (newC.amen - oldC.amen);
    st.tComPas += (newC.comPas - oldC.comPas);
    st.tSub += (newC.sub - oldC.sub);
    st.tRet += (newC.ret - oldC.ret);
    st.tIva21 += (newC.iva - oldC.iva);
    st.tLiq += (newC.totalLiq - oldC.totalLiq);
    st.tCE += (newC.ceTotal - oldC.ceTotal);
    st.tCE2 += (newC.ceSinIvaTotal - oldC.ceSinIvaTotal);
  }
  if (validationFlipped !== undefined) {
    if (validationFlipped) {
      st.filValidatedCount--; st.filPendingCount++; st.fV--;
    } else {
      st.filValidatedCount++; st.filPendingCount--; st.fV++;
    }
  }

  _renderStatsFromCache(fil, st);
}

function _renderStatsFromCache(fil, st) {
  const sf2 = simpleComboState.status.value;
  const hasFilter = comboState.platform.selected.size > 0 || comboState.aloj.selected.size > 0 || sf2 !== "all" || _mpHasFilter();

  const gs = getGlobalStats();
  const tR = gs.tR, tL = gs.tL, vC = validated.size;

  const btnVal = document.getElementById("btn-validar-todas");
  const btnDesval = document.getElementById("btn-desvalidar-todas");
  btnVal.style.display = st.filPendingCount > 0 ? '' : 'none';
  btnVal.textContent = st.filPendingCount === fil.length ? `\u2713 ${t('btn.validateAll')} (${st.filPendingCount})` : `\u2713 ${t('btn.validatePending')} (${st.filPendingCount})`;
  btnDesval.style.display = st.filValidatedCount > 0 ? '' : 'none';
  btnDesval.textContent = st.filValidatedCount === fil.length ? `\u21A9 ${t('btn.unvalidateAll')} (${st.filValidatedCount})` : `\u21A9 ${t('btn.unvalidateValidated')} (${st.filValidatedCount})`;

  document.getElementById("filter-count").textContent = fil.length + " " + t("stats.reservationCount");
  const pctR = allReservas.length > 0 ? (fil.length / allReservas.length * 100).toFixed(1) : 0;
  const pctTR = tR > 0 ? (st.fR / tR * 100).toFixed(1) : 0;
  const pctTL = tL > 0 ? (st.fL / tL * 100).toFixed(1) : 0;
  const pctV = vC > 0 ? (st.fV / vC * 100).toFixed(1) : 0;
  document.getElementById("stats-row").innerHTML = `
    <div class="stat-card"><div class="stat-label">${t("stats.reservations")}</div><div class="stat-value">${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fil.length} ${t("stats.filtered")} <span class="stat-pct">(${pctR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">${t("stats.totalReservations")}</div><div class="stat-value" style="color:#1a2744">${fmt(tR)} \u20AC</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(st.fR)} \u20AC <span class="stat-pct">(${pctTR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">${t("stats.totalToSettle")}</div><div class="stat-value" style="color:#4f8cff">${fmt(tL)} \u20AC</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(st.fL)} \u20AC <span class="stat-pct">(${pctTL}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">${t("stats.validated")}</div><div class="stat-value" style="color:#43a047">${vC} / ${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${st.fV} / ${fil.length} ${t("stats.filtered")} <span class="stat-pct">(${pctV}%)</span></div>` : ''}</div>`;

  _updateFooter(fil.length, st.tNoches, st.tTotal, st.tBase, st.tComPlat, st.tComGTC, st.tLimp, st.tAmen, st.tComPas, st.tSub, st.tRet, st.tIva21, st.tLiq, st.tCE, st.tCE2);
}

let highlightIdx = null;
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M13] DETAIL_VIEW ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Vista de detalle individual de una reserva
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

/**
 * @description Navega a una reserva especÃƒÆ’Ã‚Â­fica: cambia de pÃƒÆ’Ã‚Â¡gina si necesario y la resalta.
 * @param {number} idx - ÃƒÆ’Ã‚Ândice de la reserva en allReservas[]
 */
function goToReserva(idx) {
  // Reset filters so the reservation is visible
  comboState.platform.selected = new Set(); updateComboDisplay('platform');
  comboState.aloj.selected = new Set(); updateComboDisplay('aloj');
  clearMonthFilter();
  simpleComboState.status.value = 'all';
  document.querySelector('#combo-status .combo-input').value = '';
  document.querySelector('#combo-status .combo-input').placeholder = t('filter.allStatuses2');
  document.getElementById('combo-status').classList.remove('has-value');
  simpleComboState.sort.value = 'idx';
  document.querySelector('#combo-sort .combo-input').value = '';
  document.querySelector('#combo-sort .combo-input').placeholder = t('sort.originalOrder');
  document.getElementById('combo-sort').classList.remove('has-value');
  simpleComboState.sortdir.value = 'asc';
  document.querySelector('#combo-sortdir .combo-input').value = '';
  document.querySelector('#combo-sortdir .combo-input').placeholder = '\u2191';
  document.getElementById('combo-sortdir').classList.remove('has-value');
  highlightIdx = idx;
  showScreen("list");
  renderTable();
  setTimeout(() => {
    const row = document.getElementById("row-" + idx);
    if (row) {
      row.scrollIntoView({ behavior: "smooth", block: "center" });
      row.classList.add("highlight");
      setTimeout(() => { row.classList.remove("highlight"); highlightIdx = null; }, 2000);
    }
  }, 100);
}

// \\u2500\\u2500\\u2500 INDIVIDUAL DETAIL \\u2500\\u2500\\u2500
/**
 * @description Renderiza la vista de detalle de una reserva individual.
 * Muestra desglose completo de la liquidaciÃƒÆ’Ã‚Â³n con controles editables.
 * @param {number} idx - ÃƒÆ’Ã‚Ândice de la reserva en allReservas[]
 */
function viewDetail(idx) {
  currentDetailIdx = idx;
  const r=allReservas.find(x=>x.idx===idx); if(!r)return;
  const s=settings[r.idx]||{},c=calcLiquidacion(r,s),isV=validated.has(r.idx),isB=r.plataforma==="Booking.com";
  const pasL=isB?"Booking":"Stripe",pasR=s.pasarelaRate!==undefined?s.pasarelaRate:(isB?pasarelaBookingOptions[pasarelaBookingOptions.length-1]/100:pasarelaStripeOptions[pasarelaStripeOptions.length-1]/100);
  const _vd = (idx, key) => `changeSetting(${idx},'${key}',parseFloat(this.value));viewDetail(${idx})`;
  const _sel = (opts, current, idx, key, unitPct) => {
    if(isV) return unitPct ? `(${(current*100).toFixed(1)}%)` : ``;
    return `<select class="liq-sel" onchange="${_vd(idx,key)}">` +
      opts.map(o => { const v = unitPct ? o/100 : o;
        return `<option value="${v}" ${Math.abs(current-v)<0.0001?'selected':''}>${unitPct?o+'%':o+' &#8364;'}</option>`;
      }).join('') + `</select>`;
  };
  const fv = (v) => { const d = v < 0 ? `\u2212 ${fmt(Math.abs(v))}` : (v > 0 ? `+ ${fmt(v)}` : fmt(v)); return d + ' \u20AC'; };
  const platOpts = platformOptions[r.plataforma]||[10];
  const pasOpts = isB ? pasarelaBookingOptions : pasarelaStripeOptions;
  const _prop = getPropietario(r.alojamiento);
  const _propStyle = _prop === t('consol.missingOwner') ? ' style="color:#c0392b;cursor:pointer" ' : ' style="cursor:pointer" ';
  const _propClick = `editPropietarioInline('${r.alojamiento.replace(/'/g,"\\'")}', this)`;

  // Build pasarela row HTML
  let pasHtml = '';
  if (!isV) {
    const pasSelHtml = s.pasarela ? _sel(pasOpts, pasR, r.idx, 'pasarelaRate', true) : '';
    const lblStyle = s.pasarela ? '' : ' style="color:#9ca8ab;opacity:0.5"';
    const valCls = s.pasarela ? 'liq-pas-val' : 'liq-pas-val off';
    const trackCls = s.pasarela ? 'liq-sw-track on' : 'liq-sw-track';
    pasHtml = `<div class="liq-pas-row"><div class="liq-pas-left">` +
      `<div class="liq-sw" onclick="togglePasarela(${r.idx});viewDetail(${r.idx})"><div class="${trackCls}"><div class="liq-sw-thumb"></div></div></div>` +
      `<span${lblStyle}>${t('liq.gateway')} ${pasL} ${pasSelHtml}</span></div>` +
      `<span class="${valCls}">${fv(-c.comPas)}</span></div>`;
  } else if (s.pasarela) {
    pasHtml = `<div class="liq-row"><span>${t('liq.gatewayPayment')} ${pasL} (${(pasR*100).toFixed(1)}%)</span><span class="liq-val neg">${fv(-c.comPas)}</span></div>`;
  }

  // Build CE2 section
  let ce2Html = '';
  if (c.ceSinIvaTotal > 0) {
    const ce2Items = s.conceptosSinIVA || [];
    let ce2Rows = '';
    ce2Items.forEach(function(item) {
      if (item.amount > 0) ce2Rows += `<div class="liq-row"><span><span class="liq-ce2-dot"></span>${esc(item.label || t('liq.noName'))}</span><span class="liq-val">${fv(-item.amount)}</span></div>`;
    });
    if (ce2Rows) {
      ce2Html = `<div class="liq-ce2"><div class="liq-sec-label">${t('liq.specialConcepts')}</div>${ce2Rows}</div>`;
    }
  }

  document.getElementById("detail-content").innerHTML=`<div class="liq-container print-target" id="print-zone">
    <div class="liq-gold-bar-top"></div>
    <div class="liq-header"><div class="liq-header-top"><div><div class="type">${isV?t('liq.settlement'):t('liq.reservation')}</div><div class="name"${_propStyle} title="Clic para editar propietario" onclick="${_propClick}">${_prop}</div></div>
    <div style="display:flex;align-items:center;gap:12px;"><div class="liq-header-logo"><span class="logo-main">h\u00F4mity</span><span class="logo-sub">holidays</span></div>
    ${isV?'<span class="badge-liq badge-liq-green">&#10003; ' + t('status.validated') + '</span>':'<span class="badge-liq badge-liq-amber">' + t('status.pending') + '</span>'}</div></div>
    <div class="liq-meta-strip"><div class="liq-meta-item"><div class="liq-meta-label">${t("col.alojamiento")}</div><div class="liq-meta-value">${esc(r.alojamiento)}</div></div>
    <div class="liq-meta-item"><div class="liq-meta-label">${t("sort.fechaEntrada")}</div><div class="liq-meta-value">${formatDate(r.fechaEntrada)} &#8594; ${formatDate(r.fechaSalida)}</div></div>
    <div class="liq-meta-item"><div class="liq-meta-label">${t("liq.salesChannel")}</div><div class="liq-meta-value">${r.plataforma}</div></div>
    <div class="liq-meta-item"><div class="liq-meta-label">${t("sort.idReserva")}</div><div class="liq-meta-value">${r.id}</div></div>
    <div class="liq-meta-item"><div class="liq-meta-label">${t("sort.localizador")}</div><div class="liq-meta-value sm">${r.localizador}</div></div>
    <div class="liq-meta-item"><div class="liq-meta-label">${t("col.edificio")}</div><div class="liq-meta-value">${esc(r.edificio)}</div></div></div></div>
    <div class="liq-sec">
      <div class="liq-row bold"><span>${t('liq.totalVAT')}</span><span class="liq-val">${fv(c.total)}</span></div>
      <div class="liq-row"><span>${t('liq.vatReservation')} (${(IVA_RESERVA*100).toFixed(0)}%)</span><span class="liq-val neg">${fv(-(c.total-c.baseSinIVA))}</span></div>
      <div class="liq-row bold"><span>${t('liq.baseNoVAT')}</span><span class="liq-val">${fv(c.baseSinIVA)}</span></div>
    </div>
    <div class="liq-sec">
      <div class="liq-sec-label">${t('liq.salesOps')}</div>
      <div class="liq-row"><span>${t('liq.salesChannel')} ${esc(r.plataforma)} ${_sel(platOpts, c.comRate, r.idx, 'comPlataforma', true)}</span><span class="liq-val neg">${fv(-c.comPlat)}</span></div>
      <div class="liq-row"><span>${t('liq.gtcMgmt')} ${_sel(gtcOptions, c.gtcRate, r.idx, 'comGTC', true)}</span><span class="liq-val neg">${fv(-c.comGTC)}</span></div>
      <div class="liq-row"><span>${t('liq.cleaning')} ${_sel(cleaningOptions, c.limp, r.idx, 'limpieza', false)}</span><span class="liq-val neg">${fv(-c.limp)}</span></div>
      <div class="liq-row"><span>${t('liq.amenities')} ${_sel(amenitiesOptions, c.amen, r.idx, 'amenities', false)}</span><span class="liq-val neg">${fv(-c.amen)}</span></div>
      <div class="liq-divider"></div>
      ${pasHtml}
    </div>
    ${ce2Html}
    <div class="liq-sec">
      <div class="liq-subtotal-bar"><span>${t('liq.subtotal')}</span><span>${fv(c.sub)}</span></div>
      <div class="liq-row" style="margin-top:8px"><span>${t('liq.irpfWithholding')} ${_sel(irpfOptions, c.irpfRate, r.idx, 'irpf', true)}</span><span class="liq-val neg">${fv(-c.ret)}</span></div>
      <div class="liq-row"><span>${t('liq.vatSubtotal')} (${(IVA_SUBTOTAL*100).toFixed(0)}%)</span><span class="liq-val pos">${fv(c.iva)}</span></div>
    </div>
    <div class="liq-total-bar"><div class="liq-total"><div><span class="liq-total-label">${t("liq.totalToSettle")}</span><div class="liq-total-label-sub">${t("liq.monthlySettlement")}</div></div><span class="liq-total-value">${fmt(c.totalLiq)} \u20AC</span></div></div>
    <div class="liq-gold-bar-bottom"></div></div>
    <div class="liq-actions no-print">
      ${!isV?`<button class="btn btn-orange" onclick="toggleValidate(${r.idx})">&#10003; ${t('btn.validate')}</button>`:`<button class="btn btn-success" onclick="toggleValidate(${r.idx})">&#8617; ${t('btn.unvalidate')}</button>`}
      <button class="btn btn-outline" onclick="window.print()">&#128424; ${t('btn.print')}</button></div>`;
  document.getElementById("nav-detail").style.display="block"; showScreen("detail");
}


// \u2500\u2500\u2500 CONSOLIDATED GRID \u2500\u2500\u2500
let _alojCache = null;
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M14] CONSOL_VIEW ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Vista consolidada por alojamiento
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

/** @description Invalida la cachÃƒÆ’Ã‚Â© de agrupaciÃƒÆ’Ã‚Â³n por alojamiento */
function invalidateAlojCache() { _alojCache = null; }
/**
 * @description Agrupa reservas por alojamiento para la vista consolidada.
 * Solo incluye reservas VALIDADAS. Usa cachÃƒÆ’Ã‚Â© para evitar recÃƒÆ’Ã‚Â¡lculos.
 * @returns {Object.<string, Object>} Mapa alojamiento ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ { items[], totalR, totalL }
 */
function getAlojamientos() {
  if (_alojCache) return _alojCache;
  const map = {};
  allReservas.forEach(r => {
    if (!map[r.alojamiento]) map[r.alojamiento] = { name: r.alojamiento, edificio: r.edificio, reservas: [] };
    map[r.alojamiento].reservas.push(r);
  });
  _alojCache = Object.values(map).sort((a, b) => a.name.localeCompare(b.name));
  return _alojCache;
}

/**
 * @description Renderiza el grid de tarjetas de alojamientos (pantalla "consol").
 * Agrupa reservas validadas por alojamiento y muestra stats por tarjeta.
 */
function renderConsolGrid() {
  const alojamientos = getAlojamientos();

  // Apply date filter helper
  function filterByDate(reservas) {
    if (!_mpHasFilter()) return reservas;
    return reservas.filter(r => _mpMatchDate(r._dEntrada));
  }

  let totalAloj = 0, readyCount = 0, totalLiq = 0;

  // Pre-compute stats for sorting (with date-filtered reservas)
  let alojData = alojamientos.map(a => {
    const filtered = filterByDate(a.reservas);
    if (filtered.length === 0) return null; // hide alojamientos with 0 reservas in range
    const total = filtered.length;
    const valCount = filtered.filter(r => validated.has(r.idx)).length;
    const allVal = valCount === total;
    const sumReservas = filtered.reduce((s, r) => s + r.totalReserva, 0);
    const sumLiq = filtered.reduce((s, r) => s + getLiq(r).totalLiq, 0);
    return { ...a, reservas: filtered, total, valCount, allVal, sumReservas, sumLiq };
  }).filter(Boolean);

  // Text search filter for consol
  if (_searchTextConsol) {
    const s = _searchTextConsol;
    alojData = alojData.filter(a => {
      // Search in alojamiento name and edificio
      if (a.name.toLowerCase().includes(s) || (a.edificio||'').toLowerCase().includes(s)) return true;
      // Search in any reservation field within this alojamiento
      return a.reservas.some(r => {
        const c = getLiq(r);
        return r._clienteLc.includes(s) || r.id.toLowerCase().includes(s) ||
        r.localizador.toLowerCase().includes(s) || r._platLc.includes(s) ||
        (r.atendidoPor||'').toLowerCase().includes(s) ||
        (r.observacion||'').toLowerCase().includes(s) ||
        r._fmtEntrada.includes(s) || r._fmtSalida.includes(s) ||
        fmt(r.totalReserva).includes(s) || fmt(c.totalLiq).includes(s) ||
        fmt(c.baseSinIVA).includes(s) || String(r.totalReserva).includes(s);
      });
    });
  }

  // Compute stats after all filters
  alojData.forEach(a => {
    totalAloj++;
    if (a.allVal) readyCount++;
    totalLiq += a.sumLiq;
  });

  // Sort: toggle takes priority, then dropdown sort as tiebreaker
  const sortMode = simpleComboState.consolsort.value;
  const _vtMode = _consolValToggle; // 'noval' | 'val' | null
  alojData.sort((a, b) => {
    // Primary: toggle-based validation sort
    if (_vtMode === 'noval') {
      const d = (a.allVal?1:0) - (b.allVal?1:0);
      if (d !== 0) return d;
    } else if (_vtMode === 'val') {
      const d = (b.allVal?1:0) - (a.allVal?1:0);
      if (d !== 0) return d;
    }
    // Secondary: dropdown sort
    switch(sortMode) {
      case 'name': return a.name.localeCompare(b.name);
      case 'name-desc': return b.name.localeCompare(a.name);
      case 'reservas-desc': return b.total - a.total || a.name.localeCompare(b.name);
      case 'reservas-asc': return a.total - b.total || a.name.localeCompare(b.name);
      case 'liq-desc': return b.sumLiq - a.sumLiq || a.name.localeCompare(b.name);
      case 'liq-asc': return a.sumLiq - b.sumLiq || a.name.localeCompare(b.name);
      case 'total-desc': return b.sumReservas - a.sumReservas || a.name.localeCompare(b.name);
      case 'total-asc': return a.sumReservas - b.sumReservas || a.name.localeCompare(b.name);
      default: return a.name.localeCompare(b.name);
    }
  });

  // Render position badges for top sorts
  const showRank = ['reservas-desc','liq-desc','total-desc'].includes(sortMode);

  // Counts for toggle badges
  const pendingCount = alojData.filter(a => !a.allVal).length;
  const readyCountBadge = alojData.filter(a => a.allVal).length;

  let cardsHTML = '';
  alojData.forEach((a, idx) => {
    const pct = a.total > 0 ? (a.valCount / a.total * 100) : 0;
    const barColor = a.allVal ? '#43a047' : '#ff9800';
    const rankBadge = showRank ? `<div style="position:absolute;top:12px;left:12px;width:24px;height:24px;border-radius:12px;background:${idx<3?'#4f8cff':'#e0e4ea'};color:${idx<3?'#fff':'#6b7280'};font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;">${idx+1}</div>` : '';
    // Dimmed: when toggle is active, dim the non-priority group
    const dimmed = _vtMode !== null && (
      (_vtMode === 'noval' && a.allVal) || (_vtMode === 'val' && !a.allVal)
    );

    cardsHTML += `
      <div class="aloj-card ${a.allVal ? 'ready' : 'pending'}${dimmed ? ' dimmed' : ''}" onclick="viewConsolDetail('${a.name.replace(/'/g, "\\'")}')">
        ${rankBadge}
        <div class="aloj-semaforo">${a.allVal ? '&#128994;' : '&#128992;'}</div>
        <div class="aloj-name" ${showRank?'style="padding-left:28px;"':''}>${a.name}</div>
        <div class="aloj-edificio">${a.edificio}</div>
        <div class="aloj-stats">
          <div><div class="aloj-stat-label">${t('consol.reservations')}</div><div class="aloj-stat-value">${a.total}</div></div>
          <div><div class="aloj-stat-label">${t('consol.billing')}</div><div class="aloj-stat-value" style="font-size:14px;color:#1a2744">${fmt(a.sumReservas)} \u20AC</div></div>
          <div><div class="aloj-stat-label">${t('consol.toSettle')}</div><div class="aloj-stat-value" style="color:#4f8cff;font-size:14px">${fmt(a.sumLiq)} \u20AC</div></div>
        </div>
        <div class="aloj-bar"><div class="aloj-bar-fill" style="width:${pct}%;background:${barColor};"></div></div>
      </div>`;
  });

  // Compute total facturacion
  const totalFact = alojData.reduce((s, a) => s + a.sumReservas, 0);

  document.getElementById("consol-stats").innerHTML = `
    <div class="stat-card"><div class="stat-label">${t("stats.properties")}</div><div class="stat-value">${totalAloj}</div></div>
    <div class="stat-card"><div class="stat-label">${t("stats.totalBilling")}</div><div class="stat-value" style="color:#1a2744">${fmt(totalFact)} \u20AC</div></div>
    <div class="stat-card"><div class="stat-label">${t("stats.totalToSettle")}</div><div class="stat-value" style="color:#4f8cff">${fmt(totalLiq)} \u20AC</div></div>
    <div class="stat-card"><div class="stat-label">${t("stats.readyToSettle")}</div><div class="stat-value" style="color:#43a047">${readyCount} / ${totalAloj}</div></div>`;
  document.getElementById("aloj-grid").innerHTML = cardsHTML;

  // Update validation toggle buttons and counts
  const btnNo = document.getElementById('vt-btn-noval');
  const btnYes = document.getElementById('vt-btn-val');
  if (btnNo && btnYes) {
    btnNo.classList.toggle('active', _vtMode === 'noval');
    btnYes.classList.toggle('active', _vtMode === 'val');
    document.getElementById('vt-count-noval').textContent = pendingCount;
    document.getElementById('vt-count-val').textContent = readyCountBadge;
  }
}

// \u2500\u2500\u2500 CONSOLIDATED DETAIL \u2500\u2500\u2500
function buildComPlatRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const key = x.r.plataforma + '|' + (x.c.comRate * 100).toFixed(1);
    if (!groups[key]) groups[key] = { plat: x.r.plataforma, rate: x.c.comRate, sum: 0, count: 0 };
    groups[key].sum += x.c.comPlat;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>${t('liq.salesChannel')} ${g.plat} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} ${g.count>1?t('consol.reservations'):t('consol.reservation')}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '';
  let total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.plat} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} ${g.count>1?t('consol.reservations'):t('consol.reservation')}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>${t('liq.salesChannel')}</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildGTCRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const rate = x.c.gtcRate;
    const key = (rate * 100).toFixed(0);
    if (!groups[key]) groups[key] = { rate, sum: 0, count: 0 };
    groups[key].sum += x.c.comGTC;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>${t('liq.gtcMgmt')} (${(g.rate*100).toFixed(0)}%) &#8212; ${g.count} ${g.count>1?t('consol.reservations'):t('consol.reservation')}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>GTC al ${(g.rate*100).toFixed(0)}% &#8212; ${g.count} ${g.count>1?t('consol.reservations'):t('consol.reservation')}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>${t('liq.gtcMgmt')}</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildPasarelaRows(calcs) {
  const withPas = calcs.filter(x => x.s.pasarela && x.c.comPas > 0);
  if (withPas.length === 0) return '';
  const groups = {};
  withPas.forEach(x => {
    const isB = x.r.plataforma === 'Booking.com';
    const label = isB ? 'Booking' : 'Stripe';
    const rate = x.s.pasarelaRate || (isB ? pasarelaBookingOptions[pasarelaBookingOptions.length-1]/100 : pasarelaStripeOptions[pasarelaStripeOptions.length-1]/100);
    const key = label + '|' + (rate * 100).toFixed(1);
    if (!groups[key]) groups[key] = { label, rate, sum: 0, count: 0 };
    groups[key].sum += x.c.comPas;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>${t('liq.paymentGateway')} ${g.label} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} ${g.count>1?t('consol.reservations'):t('consol.reservation')}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.label} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} ${g.count>1?t('consol.reservations'):t('consol.reservation')}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>${t('liq.paymentGateway')}</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildIrpfRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const rate = x.c.irpfRate;
    const key = (rate * 100).toFixed(0);
    if (!groups[key]) groups[key] = { rate, sum: 0, count: 0 };
    groups[key].sum += x.c.ret;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>${t('liq.irpfWithholding')} (${(g.rate*100).toFixed(0)}%) &#8212; ${g.count} ${g.count>1?t('consol.reservations'):t('consol.reservation')}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>IRPF al ${(g.rate*100).toFixed(0)}% &#8212; ${g.count} ${g.count>1?t('consol.reservations'):t('consol.reservation')}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>${t('liq.irpfWithholding')}</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildLimpRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const v = x.c.limp;
    const key = v.toFixed(0);
    if (!groups[key]) groups[key] = { val: v, sum: 0, count: 0 };
    groups[key].sum += v;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>${t('liq.cleaning')} (${g.count} &#215; ${fmt(g.val)} &#8364;)</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.count} &#215; ${fmt(g.val)} &#8364;</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>${t('liq.cleaning')}</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M15] CONSOL_DEDUCT ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Mantenimiento y extras mensuales por alojamiento
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === Consolidated monthly deductions management ===
function buildPrintDeductionsHtml(alojName, lang) {
  const _en = lang === 'en';
  let maint = getConsolMaint(alojName);
  let extras = getConsolExtras(alojName);
  let h = '';
  if (maint.enabled) {
    h += '<div class="liq-row"><span>' + t('liq.maintenance') + '</span><span class="neg">- ' + fmt(maint.amount) + ' \u20AC</span></div>';
  }
  extras.forEach(function(ex) {
    h += '<div class="liq-row"><span>' + ex.label + '</span><span class="neg">- ' + fmt(ex.amount) + ' \u20AC</span></div>';
  });
  return h;
}

function buildConsolDeductionsHtml(alojName) {
  let maint = getConsolMaint(alojName);
  let extras = getConsolExtras(alojName);
  let esc2 = alojName.replace(/'/g, "\\'");
  let maintSelOpts = maintenanceOptions.map(function(o) {
    return '<option value="'+o+'"'+(o===maint.amount?' selected':'')+'>'+o+' \u20AC</option>';
  }).join('');

  let html = '';

  // Maintenance row ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â same consol-row style
  html += '<div class="consol-row"><span style="display:flex;align-items:center;gap:8px;">';
  html += '<span class="no-print" style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:3px;border:2px solid '+(maint.enabled?'#16a34a':'#d1d5db')+';background:'+(maint.enabled?'#16a34a':'#fff')+';color:#fff;font-size:11px;cursor:pointer;" onclick="toggleConsolMaint(\''+esc2+'\')">'+(maint.enabled?'&#10003;':'')+'</span>';
  html += '<span style="'+(maint.enabled?'':'color:#9ca3af;text-decoration:line-through;')+'">'+t('liq.maintenance')+'</span>';
  if (maint.enabled) html += ' <select class="sel no-print" onchange="changeConsolMaintAmount(\''+esc2+'\',this.value)" style="font-size:11px;padding:2px 6px;">'+maintSelOpts+'</select>';
  html += '</span>';
  if (maint.enabled) html += '<span class="neg">- '+fmt(maint.amount)+' \u20AC</span>';
  html += '</div>';

  // Extra concepts ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â CE-style editable rows
  extras.forEach(function(ex, ei) {
    html += '<div class="cex-item-row" style="display:flex;align-items:center;gap:8px;padding:4px 8px;animation:ceRowIn .2s ease;">';
    html += '<input class="cex-inp-label" type="text" value="'+(ex.label||'').replace(/"/g,'&quot;')+'" onchange="updateConsolExtra(\''+esc2+'\','+ei+',\'label\',this.value)" onkeydown="_cexKey(event,\''+esc2+'\',false)" placeholder="'+t('cex.placeholder')+'" style="flex:0 0 50%;border:1.5px solid #e5e7eb;border-radius:5px;padding:5px 8px;font-size:12px;font-family:inherit;outline:none;" />';
    html += '<input class="cex-inp-amt" type="text" value="'+fmt(ex.amount||0)+'" onchange="updateConsolExtra(\''+esc2+'\','+ei+',\'amount\',this.value)" onkeydown="_cexKey(event,\''+esc2+'\',true)" placeholder="0,00" style="width:80px;border:1.5px solid #e5e7eb;border-radius:5px;padding:5px 8px;font-size:12px;font-family:inherit;outline:none;text-align:right;font-weight:600;" />';
    html += '<span style="font-size:12px;color:#6b7280;flex-shrink:0;">\u20AC</span>';
    html += '<button class="ce-del" onclick="removeConsolExtra(\''+esc2+'\','+ei+')" style="width:22px;height:22px;border-radius:5px;border:none;background:#fef2f2;color:#ef4444;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">\u00D7</button>';
    html += '<span class="neg" style="margin-left:auto;white-space:nowrap;">- '+fmt(ex.amount||0)+' \u20AC</span>';
    html += '</div>';
  });

  // Add concept link ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â same style as CE
  html += '<div class="no-print" style="padding:4px 8px;">';
  html += '<a class="cex-add-link" onclick="addConsolExtra(\''+esc2+'\')" style="font-size:12px;color:#3b82f6;cursor:pointer;text-decoration:none;">'+t('ce.addItem')+'</a>';
  html += '</div>';

  return html;
}

function toggleConsolMaint(alojName) {
  let m = getConsolMaint(alojName);
  m.enabled = !m.enabled;
  scheduleGlobalConfigSave();
  // Re-render just the maint row + patch totals
  _refreshConsolMaintRow(alojName);
  _patchConsolFinalTotals();
}
function changeConsolMaintAmount(alojName, val) {
  let m = getConsolMaint(alojName);
  m.amount = parseFloat(val) || maintenanceOptions[0];
  scheduleGlobalConfigSave();
  // Patch the displayed neg span in maint row
  var box = document.querySelector('.consol-monthly-box');
  if (box) { var nr = box.querySelector('.consol-row .neg'); if (nr) nr.textContent = '- ' + fmt(m.amount) + ' \u20AC'; }
  _patchConsolFinalTotals();
}
function updateConsolExtra(alojName, idx, field, rawVal) {
  var extras = getConsolExtras(alojName);
  if (!extras[idx]) return;
  if (field === 'label') {
    extras[idx].label = rawVal;
    scheduleGlobalConfigSave();
  } else {
    var v = parseFloat(String(rawVal).replace(/\./g,'').replace(',','.'));
    if (isNaN(v)) v = 0;
    extras[idx].amount = v;
    scheduleGlobalConfigSave();
    _patchConsolFinalTotals();
  }
}
function addConsolExtra(alojName) {
  var extras = getConsolExtras(alojName);
  extras.push({ label: '', amount: 0 });
  scheduleGlobalConfigSave();
  // Append DOM row instead of full re-render
  var box = document.querySelector('.consol-monthly-box');
  if (!box) return;
  var addLink = box.querySelector('.cex-add-link');
  if (!addLink) return;
  var ei = extras.length - 1;
  var esc2 = alojName.replace(/'/g, "\\'");
  var row = document.createElement('div');
  row.className = 'cex-item-row';
  row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:4px 8px;animation:ceRowIn .2s ease;';
  row.innerHTML = '<input class="cex-inp-label" type="text" value="" onchange="updateConsolExtra(\''+esc2+'\','+ei+',\'label\',this.value)" onkeydown="_cexKey(event,\''+esc2+'\',false)" placeholder="'+t('cex.placeholder')+'" style="flex:0 0 50%;border:1.5px solid #e5e7eb;border-radius:5px;padding:5px 8px;font-size:12px;font-family:inherit;outline:none;" />'
    + '<input class="cex-inp-amt" type="text" value="0,00" onchange="updateConsolExtra(\''+esc2+'\','+ei+',\'amount\',this.value)" onkeydown="_cexKey(event,\''+esc2+'\',true)" placeholder="0,00" style="width:80px;border:1.5px solid #e5e7eb;border-radius:5px;padding:5px 8px;font-size:12px;font-family:inherit;outline:none;text-align:right;font-weight:600;" />'
    + '<span style="font-size:12px;color:#6b7280;flex-shrink:0;">\u20AC</span>'
    + '<button class="ce-del" onclick="removeConsolExtra(\''+esc2+'\','+ei+')" style="width:22px;height:22px;border-radius:5px;border:none;background:#fef2f2;color:#ef4444;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">\u00D7</button>'
    + '<span class="neg" style="margin-left:auto;white-space:nowrap;">- 0,00 \u20AC</span>';
  var addLinkWrap = addLink.parentNode;
  addLinkWrap.parentNode.insertBefore(row, addLinkWrap);
  var inp = row.querySelector('.cex-inp-label');
  if (inp) inp.focus();
}
function removeConsolExtra(alojName, idx) {
  var box = document.querySelector('.consol-monthly-box');
  if (box) {
    var rows = box.querySelectorAll('.cex-item-row');
    if (rows[idx]) {
      rows[idx].style.animation = 'ceRowOut .2s ease forwards';
      rows[idx].addEventListener('animationend', function() {
        rows[idx].remove();
        var extras = getConsolExtras(alojName);
        if (idx >= 0 && idx < extras.length) extras.splice(idx, 1);
        scheduleGlobalConfigSave();
        // Rebuild onclick/onchange indices on remaining rows
        _rebuildCexIndices(alojName);
        _patchConsolFinalTotals();
      }, {once:true});
      return;
    }
  }
  var extras = getConsolExtras(alojName);
  if (idx >= 0 && idx < extras.length) extras.splice(idx, 1);
  scheduleGlobalConfigSave();
  _patchConsolFinalTotals();
}

function _rebuildCexIndices(alojName) {
  var box = document.querySelector('.consol-monthly-box');
  if (!box) return;
  var esc2 = alojName.replace(/'/g, "\\'");
  var rows = box.querySelectorAll('.cex-item-row');
  rows.forEach(function(row, ei) {
    var lbl = row.querySelector('.cex-inp-label');
    var amt = row.querySelector('.cex-inp-amt');
    var del = row.querySelector('.ce-del');
    if (lbl) {
      lbl.setAttribute('onchange', "updateConsolExtra('"+esc2+"',"+ei+",'label',this.value)");
      lbl.setAttribute('onkeydown', "_cexKey(event,'"+esc2+"',false)");
    }
    if (amt) {
      amt.setAttribute('onchange', "updateConsolExtra('"+esc2+"',"+ei+",'amount',this.value)");
      amt.setAttribute('onkeydown', "_cexKey(event,'"+esc2+"',true)");
    }
    if (del) del.setAttribute('onclick', "removeConsolExtra('"+esc2+"',"+ei+")");
  });
}

function _refreshConsolMaintRow(alojName) {
  var box = document.querySelector('.consol-monthly-box');
  if (!box) return;
  // First child is the maint consol-row
  var maintRow = box.querySelector('.consol-row');
  if (!maintRow) return;
  var maint = getConsolMaint(alojName);
  var esc2 = alojName.replace(/'/g, "\\'");
  var maintSelOpts = maintenanceOptions.map(function(o) {
    return '<option value="'+o+'"'+(o===maint.amount?' selected':'')+'>'+o+' \u20AC</option>';
  }).join('');
  var html = '<span style="display:flex;align-items:center;gap:8px;">';
  html += '<span class="no-print" style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:3px;border:2px solid '+(maint.enabled?'#16a34a':'#d1d5db')+';background:'+(maint.enabled?'#16a34a':'#fff')+';color:#fff;font-size:11px;cursor:pointer;" onclick="toggleConsolMaint(\''+esc2+'\')">'+(maint.enabled?'&#10003;':'')+'</span>';
  html += '<span style="'+(maint.enabled?'':'color:#9ca3af;text-decoration:line-through;')+'">'+t('liq.maintenance')+'</span>';
  if (maint.enabled) html += ' <select class="sel no-print" onchange="changeConsolMaintAmount(\''+esc2+'\',this.value)" style="font-size:11px;padding:2px 6px;">'+maintSelOpts+'</select>';
  html += '</span>';
  if (maint.enabled) html += '<span class="neg">- '+fmt(maint.amount)+' \u20AC</span>';
  else html += '';
  maintRow.innerHTML = html;
}

function _refreshConsolDeductionsBox(alojName) {
  var box = document.querySelector('.consol-monthly-box');
  if (!box) return;
  box.innerHTML = '<div class="consol-monthly-title">&#128197; ' + t('consol.otherConcepts') + '</div>' + buildConsolDeductionsHtml(alojName);
}

function _patchConsolFinalTotals() {
  if (!currentConsolAloj) return;
  var data = _getConsolCalcsAndSums(currentConsolAloj);
  if (!data) return;
  var sums = data.sums;
  var _ded = getConsolDeductions(currentConsolAloj);
  var _isSplit = isGtcSplit(currentConsolAloj);
  var _gtcSplitAmt = _isSplit ? sums.sub * GTC_SPLIT_RATE : 0;
  var _ownerBase = _isSplit ? sums.sub - _gtcSplitAmt : sums.sub;
  var adjSub = _ownerBase - _ded.totalBase;
  var avgIrpfRate = sums.sub > 0 ? sums.ret / sums.sub : 0;
  var adjRet = adjSub * avgIrpfRate;
  var adjIva = adjSub * IVA_SUBTOTAL;
  var adjLiq = adjSub - adjRet + adjIva;
  var el;
  el = document.getElementById('csf-subtotal'); if (el) el.innerHTML = '<span>' + t('consol.subtotalFinal') + '</span><span>' + fmt(adjSub) + ' \u20AC</span>';
  el = document.getElementById('csf-irpf'); if (el) el.innerHTML = '<span>' + t('liq.irpfWithholding') + ' (' + (avgIrpfRate*100).toFixed(0) + '%)</span><span class="neg">- ' + fmt(adjRet) + ' \u20AC</span>';
  el = document.getElementById('csf-iva'); if (el) el.innerHTML = '<span>' + t('liq.vatSubtotal') + ' (21%)</span><span class="pos">+ ' + fmt(adjIva) + ' \u20AC</span>';
  el = document.getElementById('csf-total'); if (el) el.innerHTML = '<div class="cd-total-hero-label">' + t('liq.totalToSettleFull') + (_isSplit ? ' \u2014 ' + t('liq.propietario') : '') + '</div><div class="cd-total-hero-amount">' + fmt(adjLiq) + ' <span class="eur">\u20AC</span></div>';
  el = document.getElementById('csf-total-bar'); if (el) { el.querySelector('.cd-total-bar-amount').textContent = fmt(adjLiq) + ' \u20AC'; }
}

function _refreshConsolSummaryBlock() {
  if (!currentConsolAloj) return;
  var data = _getConsolCalcsAndSums(currentConsolAloj);
  if (!data) return;
  var summaryBlock = document.getElementById('consol-summary-block');
  if (summaryBlock) summaryBlock.innerHTML = _buildConsolSummaryInner(data.calcs, data.sums, currentConsolAloj);
}

/**
 * @description Renderiza la liquidaciÃƒÆ’Ã‚Â³n consolidada completa de un alojamiento.
 * Incluye tabla de reservas, resumen financiero, deducciones mensuales,
 * reparto 80/20 GTC (si aplica), y totales con IRPF/IVA.
 * @param {string} alojName - Nombre del alojamiento
 */
function viewConsolDetail(alojName) {
  currentConsolAloj = alojName;
  const alojamientos = getAlojamientos();
  const a = alojamientos.find(x => x.name === alojName);
  if (!a) return;

  // Apply date filter
  let filteredReservas = a.reservas;
  if (_mpHasFilter()) {
    filteredReservas = a.reservas.filter(r => _mpMatchDate(r._dEntrada));
  }

  const allVal = filteredReservas.every(r => validated.has(r.idx));
  const calcs = filteredReservas.map(r => ({ r, s: settings[r.idx] || {}, c: getLiq(r) }));

  // Sums
  const sumCE = calcs.reduce((s, x) => s + x.c.ceTotal, 0);
  const sumOriginal = calcs.reduce((s, x) => s + x.r.totalReserva, 0);
  const sumTotal = calcs.reduce((s, x) => s + x.c.total, 0);
  const sumBase = calcs.reduce((s, x) => s + x.c.baseSinIVA, 0);
  const sumComPlat = calcs.reduce((s, x) => s + x.c.comPlat, 0);
  const sumComGTC = calcs.reduce((s, x) => s + x.c.comGTC, 0);
  const sumComPas = calcs.reduce((s, x) => s + x.c.comPas, 0);
  const sumLimp = calcs.reduce((s, x) => s + x.c.limp, 0);
  const sumAmen = calcs.reduce((s, x) => s + x.c.amen, 0);
  const sumCE2 = calcs.reduce((s, x) => s + x.c.ceSinIvaTotal, 0);
  const sumSub = calcs.reduce((s, x) => s + x.c.sub, 0);
  const sumIva = calcs.reduce((s, x) => s + x.c.iva, 0);
  const sumRet = calcs.reduce((s, x) => s + x.c.ret, 0);
  const sumLiq = calcs.reduce((s, x) => s + x.c.totalLiq, 0);

  // Sort calcs
  calcs.sort((a,b) => {
    let va = consolGetSortValue(a, consolSortF), vb = consolGetSortValue(b, consolSortF);
    if (typeof va === "string") return consolSortD === "asc" ? va.localeCompare(vb) : vb.localeCompare(va);
    return consolSortD === "asc" ? va - vb : vb - va;
  });

  // Consolidated table - identical look to main preliquidaciones (without alojamiento)
  let cNoches=0, cTotal=0, cBase=0, cComPlat=0, cComGTC=0, cLimp=0, cAmen=0, cComPas=0, cSub=0, cRet=0, cIva21=0, cLiq=0, cCE=0, cCE2=0;

  let miniRows = calcs.map(x => {
    const r = x.r, c = x.c, s = x.s, isV = validated.has(r.idx), isB = r._isBooking;
    const nights = r._nights;
    const dis = isV ? 'disabled' : '';

    const pO = selectWithValue(_selectCache['plat_'+r.plataforma]||'<option>10%</option>', s.comPlataforma);
    const gO = selectWithValue(_selectCache.gtc, s.comGTC);
    const cO = selectCleanWithValue(_selectCache.clean, s.limpieza);
    const aO = selectCleanWithValue(_selectCache.amenities, s.amenities);
    const iO = selectWithValue(_selectCache.irpf, s.irpf);
    const psO = selectWithValue(isB?_selectCache.pasBooking:_selectCache.pasStripe, s.pasarelaRate);

    cNoches+=nights; cTotal+=r.totalReserva; cBase+=c.baseSinIVA; cComPlat+=c.comPlat; cComGTC+=c.comGTC; cLimp+=c.limp; cAmen+=c.amen; cComPas+=c.comPas; cSub+=c.sub; cRet+=c.ret; cIva21+=c.iva; cLiq+=c.totalLiq; cCE+=c.ceTotal; cCE2+=c.ceSinIvaTotal;

    return `<tr ${isV?'class="validated"':''} id="crow-${r.idx}">
      <td class="cc-estado">${isV?'<span class="badge badge-green">&#10003; ' + t('status.validated') + '</span>':'<span class="badge badge-amber">' + t('status.pending') + '</span>'}</td>
      <td class="cc-idReserva" style="font-size:12px;color:#6b7280;">${r.id}</td>
      <td class="cc-localizador" style="font-size:11px;color:#6b7280;white-space:nowrap;">${r.localizador}</td>
      <td class="cc-fechaAlta" style="font-size:12px;color:#6b7280;">${r._fmtAlta}</td>
      <td class="cc-cliente bold ellip">${esc(r.cliente)}</td>
      <td class="cc-edificio ellip" style="font-size:12px;color:#6b7280;">${esc(r.edificio)}</td>
      <td class="cc-plataforma"><span class="badge ${isB?'badge-purple':'badge-blue'}">${r.plataforma}</span></td>
      <td class="cc-atendidoPor ellip" style="font-size:12px;color:#6b7280;">${esc(r.atendidoPor)}</td>
      <td class="cc-origenMarketing ellip" style="font-size:12px;color:#6b7280;">${esc(r.origenMarketing)}</td>
      <td class="cc-tipoReserva" style="font-size:12px;color:#6b7280;">${esc(r.tipoReserva)}</td>
      <td class="cc-fechaEntrada" style="font-size:12px;white-space:nowrap;">${r._fmtEntrada}</td>
      <td class="cc-fechaSalida" style="font-size:12px;white-space:nowrap;">${r._fmtSalida}</td>
      <td class="cc-noches" style="text-align:center">${nights}</td>
      <td class="cc-totalReserva right bold">${fmt(r.totalReserva)} &#8364;</td>
      <td class="cc-ce" style="text-align:center;vertical-align:middle;">${_buildCEButton(r.idx, c, 'c')}</td>
      <td class="cc-baseSinIVA right" style="color:#6b7280;font-size:12px;">${fmt(c.baseSinIVA)} &#8364;</td>
      <td class="cc-comPlataforma" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'comPlataforma',parseFloat(this.value))" ${dis}>${pO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPlat)} &#8364;</span></div></td>
      <td class="cc-comGTC" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'comGTC',parseFloat(this.value))" ${dis}>${gO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comGTC)} &#8364;</span></div></td>
      <td class="cc-limpieza" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'limpieza',parseFloat(this.value))" ${dis}>${cO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.limp)} &#8364;</span></div></td>
      <td class="cc-amenities" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'amenities',parseFloat(this.value))" ${dis}>${aO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.amen)} &#8364;</span></div></td>
      <td class="cc-pasarela" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><div style="display:flex;align-items:center;justify-content:center;gap:6px;">
        <div class="toggle" onclick="event.stopPropagation();if(!${isV}){togglePasarelaConsol(${r.idx})}"><div class="toggle-track ${s.pasarela?'on':''}"><div class="toggle-thumb"></div></div></div>
        ${s.pasarela?`<select class="sel" style="width:70px;font-size:11px;padding:4px 6px;" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'pasarelaRate',parseFloat(this.value))" ${dis}>${psO}</select>`:`<span class="toggle-label">${isB?'Booking':'Stripe'}</span>`}
      </div>${s.pasarela&&c.comPas>0?`<span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPas)} &#8364;</span>`:''}</div></td>
      <td class="cc-ceSinIva" style="text-align:center;vertical-align:middle;">${_buildCE2Button(r.idx, c, 'c')}</td>
      <td class="cc-subtotal right bold" style="font-size:12px;">${fmt(c.sub)} &#8364;</td>
      <td class="cc-irpf" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'irpf',parseFloat(this.value))" ${dis}>${iO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.ret)} &#8364;</span></div></td>
      <td class="cc-iva21" style="text-align:center;vertical-align:middle;"><span style="font-size:11px;color:#43a047;font-variant-numeric:tabular-nums;">+ ${fmt(c.iva)} &#8364;</span></td>
      <td class="cc-totalLiquidar right bold" style="color:${c.totalLiq>=0?'#1a2744':'#e53935'}">${fmt(c.totalLiq)} &#8364;</td>
      <td class="cc-observacion ellip" style="font-size:11px;color:#6b7280;max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${esc(r.observacion)}">${esc(r.observacion)}</td>
      <td class="cc-acciones"><div style="display:flex;gap:6px;">
        ${!isV?`<button class="btn btn-sm btn-orange" onclick="event.stopPropagation();toggleValidateConsol(${r.idx})">&#10004;</button>`:`<button class="btn btn-sm btn-success" onclick="event.stopPropagation();toggleValidateConsol(${r.idx})">&#8617;</button>`}
      </div></td>
    </tr>${_buildCEPanelRow(r.idx, settings[r.idx], c, 'c')}${_buildCE2PanelRow(r.idx, settings[r.idx], c, 'c')}`;
  }).join("");

  // Footer totals - identical dark bar like main table
  const _cfs='border:none;padding:10px 8px;';
  const _cfr='border:none;padding:10px 8px;color:#ff8a80;text-align:center;font-variant-numeric:tabular-nums;';
  const miniTotals = `<tr id="consol-tfoot-row" style="background:#0f1628;color:#fff;font-weight:700;font-size:12px;">
    <td class="cc-estado" style="${_cfs}"></td>
    <td class="cc-idReserva" style="${_cfs}"></td>
    <td class="cc-localizador" style="${_cfs}"></td>
    <td class="cc-fechaAlta" style="${_cfs}"></td>
    <td class="cc-cliente" style="${_cfs}text-align:right;text-transform:uppercase;letter-spacing:0.06em;font-size:11px;color:rgba(255,255,255,0.6);">${t('consol.reservasTotal')} (${calcs.length})</td>
    <td class="cc-edificio" style="${_cfs}"></td>
    <td class="cc-plataforma" style="${_cfs}"></td>
    <td class="cc-atendidoPor" style="${_cfs}"></td>
    <td class="cc-origenMarketing" style="${_cfs}"></td>
    <td class="cc-tipoReserva" style="${_cfs}"></td>
    <td class="cc-fechaEntrada" style="${_cfs}"></td>
    <td class="cc-fechaSalida" style="${_cfs}"></td>
    <td class="cc-noches" style="${_cfs}text-align:center;">${cNoches}</td>
    <td class="cc-totalReserva" style="${_cfs}text-align:right;">${fmt(cTotal)} &#8364;</td>
    <td class="cc-ce" style="${_cfs}text-align:center;color:#d97706;font-size:11px;">${cCE > 0 ? '&#8211; ' + fmt(cCE) + ' &#8364;' : ''}</td>
    <td class="cc-baseSinIVA" style="${_cfs}text-align:right;color:rgba(255,255,255,0.6);">${fmt(cBase)} &#8364;</td>
    <td class="cc-comPlataforma" style="${_cfr}">${fmt(cComPlat)} &#8364;</td>
    <td class="cc-comGTC" style="${_cfr}">${fmt(cComGTC)} &#8364;</td>
    <td class="cc-limpieza" style="${_cfr}">${fmt(cLimp)} &#8364;</td>
    <td class="cc-amenities" style="${_cfr}">${fmt(cAmen)} &#8364;</td>
    <td class="cc-pasarela" style="${_cfr}">${cComPas>0?fmt(cComPas)+' &#8364;':'&#8211;'}</td>
    <td class="cc-ceSinIva" style="${_cfs}text-align:center;color:#c4b5fd;font-size:11px;">${cCE2 > 0 ? '&#8211; ' + fmt(cCE2) + ' &#8364;' : ''}</td>
    <td class="cc-subtotal" style="${_cfs}text-align:right;">${fmt(cSub)} &#8364;</td>
    <td class="cc-irpf" style="${_cfr}">&#8211; ${fmt(cRet)} &#8364;</td>
    <td class="cc-iva21" style="${_cfs}text-align:center;color:#81c784;font-variant-numeric:tabular-nums;">+ ${fmt(cIva21)} &#8364;</td>
    <td class="cc-totalLiquidar" style="${_cfs}text-align:right;color:#81d4fa;font-size:14px;">${fmt(cLiq)} &#8364;</td>
    <td class="cc-observacion" style="${_cfs}"></td>
    <td class="cc-acciones" style="${_cfs}"></td>
  </tr>`;

  const _dedHtml = buildConsolDeductionsHtml(alojName);
  const _ded = getConsolDeductions(alojName);
  const _isSplit = isGtcSplit(alojName);
  const _gtcSplitAmt = _isSplit ? sumSub * GTC_SPLIT_RATE : 0;
  const _ownerBase = _isSplit ? sumSub - _gtcSplitAmt : sumSub;
  const adjSub = _ownerBase - _ded.totalBase;
  const avgIrpfRate = sumSub > 0 ? sumRet / sumSub : 0;
  const adjRet = adjSub * avgIrpfRate;
  const adjIva = adjSub * IVA_SUBTOTAL;
  const adjLiq = adjSub - adjRet + adjIva;
  const valCount = filteredReservas.filter(r=>validated.has(r.idx)).length;
  const valPct = filteredReservas.length > 0 ? Math.round(valCount / filteredReservas.length * 100) : 0;
  const progressColor = allVal ? 'linear-gradient(90deg,#43a047,#66bb6a)' : 'linear-gradient(90deg,#ff9800,#ffb74d)';
  const _propName = getPropietario(a.name);
  const _propIsMissing = _propName === t('consol.missingOwner');
  const sumNoches = calcs.reduce((s, x) => s + x.r._nights, 0);
  const sumVGO = sumComPlat + sumComGTC + sumLimp + sumAmen + sumComPas;

  const content = `
    <div class="consol-container print-target" id="print-zone">
      <div class="liq-gold-bar-top" style="border-radius:14px 14px 0 0;"></div>
      <div class="consol-header" style="border-radius:0;">
        <div class="header-top" style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div>
            <div class="type">${t('liq.monthlyConsol')}</div>
            <div class="name">${a.name}</div>
          </div>
          <div style="display:flex;align-items:center;gap:12px;">
            <div class="liq-header-logo"><span class="logo-main">h\u00F4mity</span><span class="logo-sub">holidays</span></div>
            ${allVal?'<span class="badge-liq badge-liq-green">&#10003; ' + t('status.ready') + '</span>':'<span class="badge-liq badge-liq-amber">' + t('status.pending') + '</span>'}</div>
        </div>
        <div class="cd-progress-wrap">
          <div class="cd-progress">
            <div class="cd-progress-bar"><div class="cd-progress-fill" style="width:${valPct}%;background:${progressColor};"></div></div>
            <div class="cd-progress-text"><strong>${valCount} / ${filteredReservas.length}</strong> ${t('consol.validated_pl')}</div>
          </div>
        </div>
        <div class="consol-meta-strip">
          <div class="consol-meta-item"><div class="consol-meta-label">${t("consol.owner")}</div><div class="consol-meta-value${_propIsMissing?' alert':''}" style="cursor:pointer" title="Clic para editar propietario" onclick="editPropietarioInline('${a.name.replace(/'/g,"\\'")}', this)">${_propName}</div></div>
          <div class="consol-meta-item"><div class="consol-meta-label">${t("consol.building")}</div><div class="consol-meta-value">${a.edificio}</div></div>
          <div class="consol-meta-item"><div class="consol-meta-label">${t("consol.numReservations")}</div><div class="consol-meta-value">${filteredReservas.length}</div></div>
          <div class="consol-meta-item"><div class="consol-meta-label">${t("stats.billing")}</div><div class="consol-meta-value">${fmt(sumTotal)} \u20AC</div></div>
        </div>
      </div>

      <div class="consol-body">
        <div class="no-print" style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid #eef0f4;background:#f8f9fb;position:relative;z-index:10;">
          <div style="display:flex;gap:8px;align-items:center;">
            ${!allVal ? `<button class="btn btn-sm btn-orange" onclick="validarTodasConsol('${a.name.replace(/'/g, "\\'")}')">${t('btn.validateAll')} (${filteredReservas.filter(r=>!validated.has(r.idx)).length})</button>` : ''}
            ${filteredReservas.some(r=>validated.has(r.idx)) ? `<button class="btn btn-sm btn-success" onclick="desvalidarTodasConsol('${a.name.replace(/'/g, "\\'")}')">${t('btn.unvalidateAll')}</button>` : ''}
          </div>
          <div class="col-toggle-wrap">
            <button class="col-toggle-btn" onclick="toggleConsolColDropdown()" data-i18n-title="misc.showHideCols" title="${t('misc.showHideCols')}">&#9783; <span data-i18n="filter.columns">${t('filter.columns')}</span></button>
            <div class="col-toggle-dd" id="consol-col-toggle-dd"></div>
          </div>
        </div>
        <div class="card" style="padding:0;overflow:hidden;margin-bottom:0;border-radius:0;box-shadow:none;">
        <div class="table-wrap">
          <table>
            <thead><tr>
              ${CONSOL_COLUMNS.map(c => {
                const is = consolSortF===c.key;
                const ar = c.sortable ? '<span class="sort-arrow">'+(is?(consolSortD==="asc"?"&#9650;":"&#9660;"):"&#8661;")+'</span>' : '';
                const cls = ["cc-"+c.key, c.right?"right":"", is?"sorted":"", c.sortable?"":"no-sort"].filter(Boolean).join(" ");
                return '<th class="'+cls+'" '+(c.sortable?'onclick="consolSortByColumn(\''+c.key+'\')"':'')+'>'+c.label+ar+'</th>';
              }).join("")}
            </tr></thead>
            <tbody>${miniRows}</tbody>
            <tfoot>${miniTotals}</tfoot>
          </table>
        </div>
        </div>

        <div class="cd-summary-section" id="consol-summary-block">
          <!-- LEFT: Detailed breakdown -->
          <div class="cd-summary-left">
            <div class="cd-sum-title">${t('consol.summary')}</div>
            <div class="consol-row bold"><span>${t('consol.totalReservasVAT')}</span><span>${fmt(sumTotal)} \u20AC</span></div>
${sumCE > 0 ? `<div class="no-print" style="background:#fffdf5;border:1px dashed #f59e0b;border-radius:6px;margin:4px 0;padding:4px 12px;">
              <div class="consol-row" style="color:#d97706;font-size:12px;padding:4px 0;"><span>&#9888; ${t('consol.originalTotal')}</span><span>${fmt(sumOriginal)} \u20AC</span></div>
              <div class="consol-row" style="color:#d97706;font-size:12px;padding:4px 0;"><span>${t('consol.specialConceptsDisc')}</span><span class="neg">- ${fmt(sumCE)} \u20AC</span></div>
            </div>` : ''}
            <div class="consol-row"><span>${t('consol.vatReservas')} (10%)</span><span class="neg">- ${fmt(sumTotal - sumBase)} \u20AC</span></div>
            <div class="consol-row bold"><span>${t('liq.baseNoVAT')}</span><span>${fmt(sumBase)} \u20AC</span></div>
            <div class="consol-divider"></div>
            ${buildComPlatRows(calcs)}
            <div class="consol-divider"></div>
            ${buildGTCRows(calcs)}
            ${buildLimpRows(calcs)}
            <div class="consol-row"><span>${t('liq.amenities')}</span><span class="neg">- ${fmt(sumAmen)} \u20AC</span></div>
            <div class="consol-divider"></div>
            ${buildPasarelaRows(calcs)}
${sumCE2 > 0 ? `<div class="no-print" style="background:#faf8ff;border:1px dashed #7c3aed;border-radius:6px;margin:4px 0;padding:4px 12px;">
              <div class="consol-row" style="color:#7c3aed;font-size:12px;padding:4px 0;"><span>&#9888; C.E. sin IVA descontados</span><span class="neg">- ${fmt(sumCE2)} \u20AC</span></div>
              ${calcs.flatMap(x => (x.s.conceptosSinIVA||[]).filter(it=>it.amount>0).map(it=>({label:it.label||t('liq.noName'),amount:it.amount,reserva:x.r.id}))).map(it=>`<div class="consol-row sub" style="color:#9f7aea;font-size:11px;padding:2px 0 2px 12px;"><span>${esc(it.label)} <span style="color:#c4b5fd;font-size:10px">(Res. ${esc(it.reserva)})</span></span><span class="neg">- ${fmt(it.amount)} \u20AC</span></div>`).join('')}
            </div>` : ''}
            <div class="consol-subtotal-reservas"><span>${t('consol.subtotalReservas')}</span><span>${fmt(sumSub)} \u20AC</span></div>
${_isSplit ? `<div class="consol-split-box">
              <div class="consol-split-title">&#8621; ${t('consol.splitTitle')}</div>
              <div class="consol-row bold" style="color:#7c3aed;padding:8px 16px;"><span><span class="consol-split-dot" style="background:#7c3aed;"></span>${t('consol.gtcRetains')} (${(GTC_SPLIT_RATE*100).toFixed(0)}%)</span><span>${fmt(_gtcSplitAmt)} \u20AC</span></div>
              <div class="consol-split-divider"></div>
              <div class="consol-row bold" style="color:#16a34a;padding:8px 16px;"><span><span class="consol-split-dot" style="background:#16a34a;"></span>${t('consol.ownerReceives')} (${((1-GTC_SPLIT_RATE)*100).toFixed(0)}%)</span><span>${fmt(_ownerBase)} \u20AC</span></div>
              <div class="consol-split-bar"><div class="consol-split-bar-gtc" style="width:${(GTC_SPLIT_RATE*100).toFixed(0)}%;">${(GTC_SPLIT_RATE*100).toFixed(0)}%</div><div class="consol-split-bar-owner" style="width:${((1-GTC_SPLIT_RATE)*100).toFixed(0)}%;">${((1-GTC_SPLIT_RATE)*100).toFixed(0)}%</div></div>
            </div>` : ''}
            <div class="consol-monthly-box no-print">
              <div class="consol-monthly-title">&#128197; ${t('consol.otherConcepts')}</div>
              ${_dedHtml}
            </div>
            <div class="consol-row bold" id="csf-subtotal"><span>${t('consol.subtotalFinal')}</span><span>${fmt(adjSub)} \u20AC</span></div>
            <div class="consol-row" id="csf-irpf"><span>${t('liq.irpfWithholding')} (${(avgIrpfRate*100).toFixed(0)}%)</span><span class="neg">- ${fmt(adjRet)} \u20AC</span></div>
            <div class="consol-row" id="csf-iva"><span>${t('liq.vatSubtotal')} (21%)</span><span class="pos">+ ${fmt(adjIva)} \u20AC</span></div>
          </div>

          <!-- RIGHT: Quick stats + Total hero -->
          <div class="cd-summary-right">
            <div class="cd-sum-title">${t('consol.quickSummary')}</div>
            <div class="cd-quick-stats">
              <div class="cd-qs-item"><div class="cd-qs-label">${t("stats.reservations")}</div><div class="cd-qs-value">${filteredReservas.length}</div></div>
              <div class="cd-qs-item"><div class="cd-qs-label">${t("stats.nights")}</div><div class="cd-qs-value">${sumNoches}</div></div>
              <div class="cd-qs-item"><div class="cd-qs-label">${t("stats.billing")}</div><div class="cd-qs-value">${fmt(sumTotal)} \u20AC</div></div>
            </div>
            <div style="margin-bottom:16px;">
              <div class="cd-tb-row"><span>${t('liq.baseNoVAT')}</span><span class="cd-tb-val">${fmt(sumBase)} \u20AC</span></div>
              <div class="cd-tb-row"><span>${t('consol.salesOps')}</span><span class="cd-tb-val neg">\u2212 ${fmt(sumVGO)} \u20AC</span></div>
              <div class="cd-tb-row" style="font-weight:700;"><span>${t('consol.subtotalReservas2')}</span><span class="cd-tb-val">${fmt(sumSub)} \u20AC</span></div>
${_isSplit ? `<div class="cd-split-mini">
                <div class="cd-split-mini-header">&#8621; ${t('consol.specialAgreement')}</div>
                <div class="cd-split-mini-row"><span><span class="consol-split-dot" style="background:#7c3aed;"></span>GTC (${(GTC_SPLIT_RATE*100).toFixed(0)}%)</span><span style="color:#7c3aed;font-weight:600;">\u2212 ${fmt(_gtcSplitAmt)} \u20AC</span></div>
                <div class="cd-split-mini-row"><span><span class="consol-split-dot" style="background:#16a34a;"></span>${t('liq.propietario')} (${((1-GTC_SPLIT_RATE)*100).toFixed(0)}%)</span><span style="color:#16a34a;font-weight:700;">${fmt(_ownerBase)} \u20AC</span></div>
              </div>` : ''}
              <div class="cd-tb-row"><span>${t('consol.otherConceptsShort')}</span><span class="cd-tb-val neg">\u2212 ${fmt(_ded.totalBase)} \u20AC</span></div>
              <div class="cd-tb-row" style="font-weight:700;"><span>${t('consol.subtotalFinalMonth')}</span><span class="cd-tb-val">${fmt(adjSub)} \u20AC</span></div>
              <div class="cd-tb-row"><span>${t('liq.irpfWithholding')} (${(avgIrpfRate*100).toFixed(0)}%)</span><span class="cd-tb-val neg">\u2212 ${fmt(adjRet)} \u20AC</span></div>
              <div class="cd-tb-row"><span>${t('liq.vatSubtotal')} (21%)</span><span class="cd-tb-val pos">+ ${fmt(adjIva)} \u20AC</span></div>
            </div>
            <div style="flex:1;"></div>
            <div class="cd-total-hero" id="csf-total">
              <div class="cd-total-hero-label">${t(_isSplit ? 'consol.toSettleOwner' : 'consol.totalToSettle')}</div>
              <div class="cd-total-hero-amount">${fmt(adjLiq)} <span class="eur">\u20AC</span></div>
            </div>
            <div class="no-print" style="margin-top:12px;">
              ${allVal
                ? `<button class="cd-btn-generate" onclick="handleGenerar()">&#128424; ${t('btn.generate')}</button>
                   <button class="pdf-download-btn" onclick="handleDownloadPdf()">&#11123; ${t('btn.downloadPdf')}</button>
                   <button class="email-btn" onclick="handleEmailLiquidacion()">&#9993; ${t('btn.sendEmail')}</button>`
                : `<button class="cd-btn-generate disabled">&#9888; ${t('btn.validateFirst')}</button>
                   <button class="pdf-download-btn disabled">&#11123; ${t('btn.downloadPdf')}</button>
                   <button class="email-btn disabled">&#9993; ${t('btn.sendEmail')}</button>`}
            </div>
            ${allVal && _previewPref !== null
              ? `<div class="no-print" style="text-align:center;font-size:12px;color:#9ca3af;margin-top:8px;">
                  ${_previewPref ? '\ud83d\udc41 ' + t('preview.show') : '\ud83d\udda8 ' + t('preview.direct')}
                  &nbsp;\u00B7&nbsp; <a href="#" onclick="resetPreviewPref();return false;" style="color:#4f8cff;">${t('preview.change')}</a>
                </div>`
              : allVal ? `<div class="no-print" id="preview-options" style="display:flex;flex-direction:column;gap:8px;align-items:center;margin-top:8px;">
                  <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;">
                    <input type="checkbox" id="chk-preview" checked style="width:14px;height:14px;cursor:pointer;">
                    ${t('preview.before')}
                  </label>
                  <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:#9ca3af;cursor:pointer;">
                    <input type="checkbox" id="chk-remember" style="width:13px;height:13px;cursor:pointer;">
                    ${t('preview.dontAsk')}
                  </label>
                </div>` : ''}
          </div>
        </div>

        <div class="cd-total-bar" id="csf-total-bar">
          <div class="cd-total-bar-label">${t(_isSplit ? 'consol.toSettleOwner' : 'consol.totalToSettle')}<strong>${a.name}</strong></div>
          <div class="cd-total-bar-amount">${fmt(adjLiq)} \u20AC</div>
        </div>
        <div class="liq-gold-bar-bottom"></div>
      </div>
    </div>

    <div class="no-print" style="display:flex;justify-content:center;padding:16px;">
      <button class="btn btn-outline" onclick="showScreen('consol')">&#8592; ${t('btn.back')}</button>
    </div>

    <div id="preview-zone" style="display:none;"></div>`;

  _previewActive = false;
  document.getElementById("consoldetail-content").innerHTML = content;
  document.getElementById("nav-consoldetail").style.display = "block";
  showScreen("consoldetail");
}

// \u2500\u2500\u2500 PRINT PREFERENCES \u2500\u2500\u2500
let _previewPref = null; // null = show options, true = always preview, false = never preview
{ const v = SafeStorage.get('liq-preview-pref'); if (v !== null) _previewPref = v === 'true'; }

function getPreviewPref() { return _previewPref === null ? true : _previewPref; }

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M16] PRINT ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â GeneraciÃƒÆ’Ã‚Â³n de impresiÃƒÆ’Ã‚Â³n y vista previa
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

/**
 * @description Genera la liquidaciÃƒÆ’Ã‚Â³n para imprimir: muestra preview o imprime directo.
 * Respeta la preferencia del usuario (ver preview o ir directo a imprimir).
 */
function handleGenerar() {
  // If preference is saved, use it directly
  if (_previewPref !== null) {
    if (_previewPref) showPrintPreview(); else printConsolDirect();
    return;
  }
  // Otherwise read checkboxes
  const chkPreview = document.getElementById('chk-preview');
  const chkRemember = document.getElementById('chk-remember');
  const wantPreview = chkPreview ? chkPreview.checked : true;

  if (chkRemember && chkRemember.checked) {
    _previewPref = wantPreview;
    SafeStorage.set('liq-preview-pref', String(wantPreview));
  }

  if (wantPreview) showPrintPreview(); else printConsolDirect();
}

function resetPreviewPref() {
  _previewPref = null;
  SafeStorage.remove('liq-preview-pref');
  // Re-render to show checkboxes
  if (currentConsolAloj) viewConsolDetail(currentConsolAloj);
}

function buildPrintCards(lang) {
  const _en = lang === 'en';
  const alojName = currentConsolAloj;
  if (!alojName) return null;
  const alojamientos = getAlojamientos();
  const a = alojamientos.find(x => x.name === alojName);
  if (!a) return null;

  const calcs_src = _mpHasFilter() ? a.reservas.filter(r => _mpMatchDate(r._dEntrada)) : a.reservas;
  const calcs = calcs_src.map(r => ({ r, s: settings[r.idx] || {}, c: getLiq(r) }));

  let cardsHtml = calcs.map((x, i) => {
    const r = x.r, s = x.s, c = x.c;
    const isB = r.plataforma === 'Booking.com';
    const pasL = isB ? 'Booking' : 'Stripe';
    const pasR = s.pasarelaRate !== undefined ? s.pasarelaRate : (isB ? pasarelaBookingOptions[pasarelaBookingOptions.length-1]/100 : pasarelaStripeOptions[pasarelaStripeOptions.length-1]/100);

    let rows = [
      {l:t('liq.totalResIva'),v:c.total,bold:true},
      {l:(t('liq.ivaReserva'))+` (${(IVA_RESERVA*100).toFixed(0)}%)`,v:-(c.total-c.baseSinIVA),neg:true},
      {l:t('liq.baseExclVat'),v:c.baseSinIVA,bold:true},{div:true},
      {l:(t('liq.salesChannel'))+` ${r.plataforma} (${(c.comRate*100).toFixed(1)}%)`,v:-c.comPlat,neg:true},{div:true},
      {l:(t('liq.gtcMgmt'))+` (${(c.gtcRate*100).toFixed(0)}%)`,v:-c.comGTC,neg:true},
      {l:(t('liq.cleaning'))+` (${fmt(c.limp)} \u20AC)`,v:-c.limp,neg:true},
      {l:`Amenities (${fmt(c.amen)} \u20AC)`,v:-c.amen,neg:true},{div:true},
    ];
    if(s.pasarela) rows.push({l:(t('liq.paymentGw'))+` ${pasL} (${(pasR*100).toFixed(1)}%)`,v:-c.comPas,neg:true},{div:true});
    // CE Sin IVA items
    if (c.ceSinIvaTotal > 0) {
      const ce2Items = s.conceptosSinIVA || [];
      ce2Items.forEach(function(item) {
        if (item.amount > 0) rows.push({l:(t('liq.ceNoVat'))+(item.label || (t('liq.unnamed'))),v:-item.amount,neg:true});
      });
      rows.push({div:true});
    }
    rows.push(
      {l:t('liq.subtotal'),v:c.sub,bold:true},
      {l:(t('liq.irpfWithhold'))+` (${(c.irpfRate*100).toFixed(0)}%)`,v:-c.ret,neg:true},
      {l:(t('liq.vatOnSub'))+` (${(IVA_SUBTOTAL*100).toFixed(0)}%)`,v:c.iva,pos:true});

    const rowsHtml = rows.map(row => {
      if (row.div) return '<div class="liq-divider"></div>';
      const cl = row.bold ? ' bold' : '';
      const vc = row.neg ? 'neg' : row.pos ? 'pos' : '';
      const d = row.v < 0 ? `- ${fmt(Math.abs(row.v))}` : fmt(row.v);
      return `<div class="liq-row${cl}"><span>${row.l}</span><span class="${vc}">${d} &#8364;</span></div>`;
    }).join('');

    return `<div class="liq-container print-card" style="margin-bottom:24px;">
      <div class="liq-gold-bar-top"></div>
      <div class="liq-header">
        <div class="liq-header-top"><div><div class="type">${t('liq.settlement')} ${i+1} ${t('liq.of')} ${calcs.length}</div><div class="name">${getPropietario(r.alojamiento)}</div></div><div class="liq-header-logo"><span class="logo-main">h\u00F4mity</span><span class="logo-sub">holidays</span></div></div>
        <div class="liq-meta-strip">
          <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.property')}</div><div class="liq-meta-value">${esc(r.alojamiento)}</div></div>
          <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.dates')}</div><div class="liq-meta-value">${formatDate(r.fechaEntrada)} &#8594; ${formatDate(r.fechaSalida)}</div></div>
          <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.salesChannel')}</div><div class="liq-meta-value">${r.plataforma}</div></div>
          <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.bookingId')}</div><div class="liq-meta-value">${r.id}</div></div>
          <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.reference')}</div><div class="liq-meta-value sm">${r.localizador}</div></div>
          <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.building')}</div><div class="liq-meta-value">${esc(r.edificio)}</div></div>
        </div>
      </div>
      <div class="liq-sec" style="padding-top:8px;padding-bottom:8px;">${rowsHtml}</div>
      <div class="liq-total-bar"><div class="liq-total"><div><span class="liq-total-label">${t('liq.totalSettle')}</span><div class="liq-total-label-sub">${t('liq.monthlySettle')}</div></div><span class="liq-total-value">${fmt(c.totalLiq)} &#8364;</span></div></div>
      <div class="liq-gold-bar-bottom"></div>
    </div>`;
  }).join('');

  const sumSub = calcs.reduce((s, x) => s + x.c.sub, 0);
  const sumRet = calcs.reduce((s, x) => s + x.c.ret, 0);
  const sumIva = calcs.reduce((s, x) => s + x.c.iva, 0);
  const sumLiq = calcs.reduce((s, x) => s + x.c.totalLiq, 0);

  const _printDed = getConsolDeductions(a.name);
  const _printDedHtml = buildPrintDeductionsHtml(a.name, lang);
  const _pIsSplit = isGtcSplit(a.name);
  const _pGtcSplit = _pIsSplit ? sumSub * GTC_SPLIT_RATE : 0;
  const _pOwnerBase = _pIsSplit ? sumSub - _pGtcSplit : sumSub;
  const _pAdjSub = _pOwnerBase - _printDed.totalBase;
  const _pAvgIrpf = sumSub > 0 ? sumRet / sumSub : 0;
  const _pAdjRet = _pAdjSub * _pAvgIrpf;
  const _pAdjIva = _pAdjSub * IVA_SUBTOTAL;
  const _pAdjLiq = _pAdjSub - _pAdjRet + _pAdjIva;
  const _pSplitHtml = _pIsSplit ? `<div class="liq-divider"></div>
      <div class="liq-row" style="color:#7c3aed;"><span>${t('liq.gtcRetains')} (${(GTC_SPLIT_RATE*100).toFixed(0)}%)</span><span>${fmt(_pGtcSplit)} &#8364;</span></div>
      <div class="liq-row bold" style="color:#16a34a;"><span>${t('liq.ownerReceives')} (${((1-GTC_SPLIT_RATE)*100).toFixed(0)}%)</span><span>${fmt(_pOwnerBase)} &#8364;</span></div>` : '';
  const summaryHtml = `<div class="liq-container print-summary" style="margin-top:8px;">
    <div class="liq-gold-bar-top"></div>
    <div class="liq-header">
      <div class="liq-header-top"><div><div class="type">${t('liq.consolSummary')} \u2014 ${calcs.length} ${t('liq.reservations')}</div><div class="name">${a.name}</div></div><div class="liq-header-logo"><span class="logo-main">h\u00F4mity</span><span class="logo-sub">holidays</span></div></div>
      <div class="liq-meta-strip">
        <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.building')}</div><div class="liq-meta-value">${a.edificio}</div></div>
        <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.numReserv')}</div><div class="liq-meta-value">${calcs.length}</div></div>
        <div class="liq-meta-item"><div class="liq-meta-label">${t('liq.ownerLabel')}</div><div class="liq-meta-value">${getPropietario(a.name)}</div></div>
      </div>
    </div>
    <div class="liq-sec" style="padding-top:8px;padding-bottom:8px;">
      <div class="liq-row bold"><span>${t('liq.resSub')}</span><span>${fmt(sumSub)} &#8364;</span></div>
      ${_pSplitHtml}
      ${_printDedHtml}
      <div class="liq-divider"></div>
      <div class="liq-row bold"><span>${t('liq.monthFinalSub')}</span><span>${fmt(_pAdjSub)} &#8364;</span></div>
      <div class="liq-row"><span>${t('liq.irpfWithhold')} (${(_pAvgIrpf*100).toFixed(0)}%)</span><span class="neg">- ${fmt(_pAdjRet)} &#8364;</span></div>
      <div class="liq-row"><span>${t('liq.vat')} 21%</span><span class="pos">+ ${fmt(_pAdjIva)} &#8364;</span></div>
    </div>
    <div class="liq-total-bar"><div class="liq-total"><div><span class="liq-total-label">${t('liq.totalSettle')}${_pIsSplit ? (t('liq.ownerSuffix')) : ''}</span><div class="liq-total-label-sub">${t('liq.consolLabel')}</div></div><span class="liq-total-value">${fmt(_pAdjLiq)} &#8364;</span></div></div>
    <div class="liq-gold-bar-bottom"></div>
  </div>`;

  return { cardsHtml, summaryHtml };
}

/** @description Estado del modo preview de impresiÃƒÆ’Ã‚Â³n */
let _previewActive = false;

function showPrintPreview() {
  const result = buildPrintCards();
  if (!result) return;

  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  // Populate preview zone with cards + action buttons
  previewZone.innerHTML = result.cardsHtml + result.summaryHtml
    + `<div class="liq-actions no-print" style="margin-top:28px;justify-content:center;">
        <button class="btn btn-success" onclick="printFromPreview()">&#128424; Imprimir</button>
        <button class="btn btn-outline" onclick="exitPreview()">&#8592; Volver a la liquidaci\u00F3n</button>
      </div>`;

  // Toggle visibility: hide table, show preview
  printZone.style.display = 'none';
  printZone.classList.remove('print-target');
  if (actions) actions.style.display = 'none';
  previewZone.style.display = 'block';
  previewZone.classList.add('print-target');
  _previewActive = true;

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function printFromPreview() {
  window.print();
}

function exitPreview() {
  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  if (!_previewActive) return;

  // Toggle back: show table, hide preview
  previewZone.style.display = 'none';
  previewZone.classList.remove('print-target');
  previewZone.innerHTML = '';
  printZone.style.display = '';
  printZone.classList.add('print-target');
  if (actions) actions.style.display = '';
  _previewActive = false;
}

function printConsolDirect() {
  const result = buildPrintCards();
  if (!result) return;

  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  // Temporarily swap to preview for printing only
  previewZone.innerHTML = result.cardsHtml + result.summaryHtml;
  printZone.style.display = 'none';
  printZone.classList.remove('print-target');
  if (actions) actions.style.display = 'none';
  previewZone.style.display = 'block';
  previewZone.classList.add('print-target');

  setTimeout(() => {
    window.print();
    // Restore after print dialog closes
    setTimeout(() => {
      previewZone.style.display = 'none';
      previewZone.classList.remove('print-target');
      previewZone.innerHTML = '';
      printZone.style.display = '';
      printZone.classList.add('print-target');
      if (actions) actions.style.display = '';
    }, 500);
  }, 100);
}

// \u2500\u2500\u2500 CONFIG MODAL \u2500\u2500\u2500
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M17] SETTINGS_UI ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Modal de configuraciÃƒÆ’Ã‚Â³n y gestiÃƒÆ’Ã‚Â³n de opciones
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

/** @description Cambia de pestaÃƒÆ’Ã‚Â±a en el modal de configuraciÃƒÆ’Ã‚Â³n */
function switchTab(tabId, btn) {
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".modal-tab").forEach(t => { t.classList.remove("active"); t.classList.remove("active-purple"); });
  document.getElementById(tabId).classList.add("active");
  btn.classList.add(tabId === 'tab-8020' ? 'active-purple' : 'active');
}
function openConfigModal() { renderConfigModal(); document.getElementById("config-modal").style.display = "flex"; }
function closeConfigModal() { document.getElementById("config-modal").style.display = "none"; rebuildSelectCache(); invalidateCache(); renderTable(); scheduleGlobalConfigSave(); }

function buildOS(title, desc, vals, unit, addId, addFn, delFn) {
  const items = vals.map((v, i) => `<div class="option-item"><span class="val">${v}${unit}</span>
    ${vals.length > 1 ? `<button class="option-delete" onclick="${delFn}(${i})">&#10005;</button>` : '<span style="width:28px"></span>'}</div>`).join("");
  return `<div class="modal-section"><h4>${title}</h4>${desc?`<div class="desc">${desc}</div>`:''}
    <div class="option-list">${items}</div>
    <div class="add-row"><input class="add-input" type="number" id="${addId}" placeholder="${t('config.newValue')}" step="any" onkeydown="if(event.key==='Enter'){event.preventDefault();${addFn}();}">
    <button class="btn btn-sm btn-primary" onclick="${addFn}()">${t('btn.addValue')}</button></div></div>`;
}

function renderConfigModal() {
  const pN = Object.keys(platformOptions).sort();
  let pH = '';
  pN.forEach(name => {
    const safe = name.replace(/[^a-zA-Z0-9]/g,'');
    pH += buildOS(name, "% sobre total reserva (IVA incl.)", platformOptions[name], "%", `add-plat-${safe}`, `addP_${safe}`, `delP_${safe}`);
    window[`addP_${safe}`] = function() { const inp=document.getElementById(`add-plat-${safe}`); const v=parseFloat(inp.value);
      if(isNaN(v)||v<0||v>100){showToast("Porcentaje vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lido: 0-100", "warning");return;} if(platformOptions[name].some(x=>Math.abs(x-v)<0.001)){showToast("Ya existe.", "warning");return;}
      platformOptions[name].push(v); platformOptions[name].sort((a,b)=>a-b); inp.value=""; renderConfigModal(); };
    window[`delP_${safe}`] = function(i) { if(platformOptions[name].length<=1)return; platformOptions[name].splice(i,1); renderConfigModal(); };
  });
  document.getElementById("tab-plat").innerHTML = pH;
  document.getElementById("tab-pasarela").innerHTML =
    buildOS(t("cfg.pasarelaStripe"),t("cfg.pasarelaDesc"),pasarelaStripeOptions,"%","add-ps","addPS","delPS") +
    '<hr class="section-divider">' +
    buildOS("Pasarela Booking","Solo para Booking.com",pasarelaBookingOptions,"%","add-pb","addPB","delPB");
  document.getElementById("tab-otros").innerHTML =
    buildOS("Gesti\u00F3n GTC","% sobre base sin IVA",gtcOptions,"%","add-gtc","addGTC","delGTC") +
    '<hr class="section-divider">' +
    buildOS("Limpieza","\u20AC sin IVA",cleaningOptions," \u20AC","add-cl","addCL","delCL") +
    '<hr class="section-divider">' +
    buildOS("Amenities","Coste fijo por reserva en \u20AC",amenitiesOptions," \u20AC","add-am","addAM","delAM") +
    '<hr class="section-divider">' +
    buildOS(t("liq.maintenanceMonthly"),t("liq.maintenanceDesc"),maintenanceOptions," \u20AC","add-mt","addMT","delMT");
  document.getElementById("tab-impuestos").innerHTML =
    buildOS("Retenci\u00F3n IRPF","Porcentaje",irpfOptions,"%","add-ir","addIR","delIR");
  document.getElementById("tab-8020").innerHTML = buildGtcSplitSection();
}
function addPS(){aL(pasarelaStripeOptions,"add-ps",100);} function delPS(i){dL(pasarelaStripeOptions,i);}
function addPB(){aL(pasarelaBookingOptions,"add-pb",100);} function delPB(i){dL(pasarelaBookingOptions,i);}
function addCL(){aL(cleaningOptions,"add-cl",99999,false);} function delCL(i){dL(cleaningOptions,i);}
function addIR(){aL(irpfOptions,"add-ir",100);} function delIR(i){dL(irpfOptions,i);}
function addGTC(){aL(gtcOptions,"add-gtc",100);} function delGTC(i){dL(gtcOptions,i);}
function addAM(){aL(amenitiesOptions,"add-am",99999,false);} function delAM(i){dL(amenitiesOptions,i);}
function addMT(){aL(maintenanceOptions,"add-mt",99999,false);} function delMT(i){dL(maintenanceOptions,i);}
function aL(list,inputId,max,isP){const inp=document.getElementById(inputId);const v=parseFloat(inp.value);
  if(isP!==false){if(isNaN(v)||v<0||v>max){showToast("Valor no vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lido.", "warning");return;}}else{if(isNaN(v)||v<0){showToast("Valor no vÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡lido.", "warning");return;}}
  if(list.some(x=>Math.abs(x-v)<0.001)){showToast("Ya existe.", "warning");return;} list.push(v);list.sort((a,b)=>a-b);inp.value="";renderConfigModal();}
function dL(list,i){if(list.length<=1)return;list.splice(i,1);renderConfigModal();}

function buildGtcSplitSection() {
  const alojs = _gtcOwnedAlojamientos.slice().sort();
  if (alojs.length === 0) return '<div style="padding:24px;text-align:center;color:#9ca3af;font-size:13px;">'+t('msg.noGtcAlojs')+'</div>';
  const rows = alojs.map(function(name) {
    const on = isGtcSplit(name);
    return '<div class="gtc-split-row"><span class="name' + (on ? ' on' : '') + '">' + esc(name) + '</span>' +
      '<div class="toggle" onclick="toggleGtcSplit(\'' + name.replace(/'/g, "\\'") + '\')"><div class="toggle-track' + (on ? ' on' : '') + '" style="' + (on ? 'background:#7c3aed;' : '') + '"><div class="toggle-thumb"></div></div></div></div>';
  }).join('<div class="gtc-split-divider-row"></div>');
  const count = alojs.filter(function(n){ return isGtcSplit(n); }).length;
  return '<div class="gtc-split-section"><div class="gtc-split-title">' +
    '&#8621; Acuerdo 80/20 GTC</div>' +
    '<div class="gtc-split-desc">Alojamientos propiedad GTC. Activa los que ya est\u00E1n vendidos: GTC retiene el 20% del Subtotal Reservas, el propietario recibe el 80%.</div>' +
    '<div class="gtc-split-list">' + rows + '</div>' +
    '<div class="gtc-split-counter"><span class="badge">' + count + '</span> de ' + alojs.length + ' vendido' + (count !== 1 ? 's' : '') + ' (80/20 activo)</div></div>';
}
function toggleGtcSplit(alojName) {
  const idx = _gtcSplitAlojamientos.indexOf(alojName);
  if (idx >= 0) { _gtcSplitAlojamientos.splice(idx, 1); }
  else { _gtcSplitAlojamientos.push(alojName); _gtcSplitAlojamientos.sort(); }
  renderConfigModal();
  scheduleGlobalConfigSave();
}

// \u2500\u2500\u2500 SEARCHABLE COMBO SYSTEM \u2500\u2500\u2500
const comboState = { platform: { selected: new Set(), options: [] }, aloj: { selected: new Set(), options: [] } };
var comboLabels = { platform: t('filter.allPlatforms'), aloj: t('filter.allProperties') };

// \u2014\u2014\u2014 MONTH PICKER STATE (multi-select) \u2014\u2014\u2014
const MONTH_NAMES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const MONTH_FULL = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
let _mpSelYears = new Set();
let _mpSelMonths = new Set();
let _mpAvailable = {};
let _mpAllYears = [];
let _mpActiveSrc = 'p';

// ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ [M10-MONTHPICKER] Selector de mes/aÃƒÆ’Ã‚Â±o con multi-selecciÃƒÆ’Ã‚Â³n ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬

/**
 * @description Comprueba si una fecha coincide con los filtros de mes/aÃƒÆ’Ã‚Â±o activos.
 * Soporta multi-selecciÃƒÆ’Ã‚Â³n: varios aÃƒÆ’Ã‚Â±os y/o varios meses simultÃƒÆ’Ã‚Â¡neamente.
 * @param {Date} d - Fecha a comprobar
 * @returns {boolean} true si la fecha pasa el filtro
 */
function _mpMatchDate(d) {
  if (_mpSelYears.size === 0) return true;
  if (!d) return false;
  if (!_mpSelYears.has(d.getFullYear())) return false;
  if (_mpSelMonths.size > 0 && !_mpSelMonths.has(d.getMonth())) return false;
  return true;
}
function _mpHasFilter() { return _mpSelYears.size > 0; }

function buildAvailableMonths() {
  _mpAvailable = {};
  allReservas.forEach(r => {
    if (!r._dEntrada) return;
    const y = r._dEntrada.getFullYear(), m = r._dEntrada.getMonth();
    if (!_mpAvailable[y]) _mpAvailable[y] = {};
    _mpAvailable[y][m] = (_mpAvailable[y][m] || 0) + 1;
  });
  _mpAllYears = Object.keys(_mpAvailable).map(Number).sort((a,b) => b-a);
  // Default to previous month (liquidations are always for the month before)
  const now = new Date();
  now.setMonth(now.getMonth() - 1);
  const curY = now.getFullYear();
  const curM = now.getMonth();
  _mpSelYears = new Set();
  _mpSelMonths = new Set();
  if (_mpAvailable[curY]) {
    _mpSelYears.add(curY);
    if (_mpAvailable[curY][curM] !== undefined) _mpSelMonths.add(curM);
  } else if (_mpAllYears.length > 0) {
    _mpSelYears.add(_mpAllYears[0]);
  }
  updateMonthPickerBtn();
}

function toggleMonthPicker(src) {
  _mpActiveSrc = src || 'p';
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  const otherId = _mpActiveSrc === 'p' ? 'mp-dd-c' : 'mp-dd-p';
  document.getElementById(otherId).classList.remove('open');
  const dd = document.getElementById('mp-dd-' + _mpActiveSrc);
  const wasOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!wasOpen) renderMonthPickerDD();
}

function renderMonthPickerDD() {
  const dd = document.getElementById('mp-dd-' + _mpActiveSrc);
  if (!dd) return;
  let monthCounts = {};
  let yearsForMonths = _mpSelYears.size > 0 ? _mpSelYears : new Set(_mpAllYears);
  yearsForMonths.forEach(function(y) {
    let ym = _mpAvailable[y] || {};
    for (let m = 0; m < 12; m++) {
      monthCounts[m] = (monthCounts[m] || 0) + (ym[m] || 0);
    }
  });
  let yearsHtml = _mpAllYears.map(y =>
    `<button class="mp-year ${_mpSelYears.has(y)?'sel':''}" onclick="event.stopPropagation();toggleMPYear(${y})">${y}</button>`
  ).join('');
  let monthsHtml = '';
  for (let m = 0; m < 12; m++) {
    const cnt = monthCounts[m] || 0;
    const isSel = _mpSelMonths.has(m);
    const dim = cnt === 0 ? 'dim' : '';
    monthsHtml += `<button class="mp-month ${isSel?'sel':''} ${dim}" onclick="event.stopPropagation();toggleMPMonth(${m})">${MONTH_NAMES[m]}<span class="mp-cnt">${cnt>0?cnt:''}</span></button>`;
  }
  dd.innerHTML = `
    <div class="mp-years">${yearsHtml}</div>
    <div class="mp-grid">${monthsHtml}</div>
    ${_mpSelYears.size > 0 || _mpSelMonths.size > 0 ? '<button class="mp-all" onclick="event.stopPropagation();clearMonthFilter()">' + t('filter.clearDate') + '</button>' : ''}
  `;
}

function toggleMPYear(year) {
  if (_mpSelYears.has(year)) _mpSelYears.delete(year);
  else _mpSelYears.add(year);
  if (_mpSelYears.size === 0) _mpSelMonths.clear();
  _mpRefreshAll();
  renderMonthPickerDD();
}

function toggleMPMonth(month) {
  if (_mpSelMonths.has(month)) _mpSelMonths.delete(month);
  else _mpSelMonths.add(month);
  _mpRefreshAll();
  renderMonthPickerDD();
}

function clearMonthFilter() {
  _mpSelYears.clear(); _mpSelMonths.clear();
  _mpRefreshAll();
  document.getElementById('mp-dd-p').classList.remove('open');
  document.getElementById('mp-dd-c').classList.remove('open');
}

function _mpRefreshAll() {
  updateMonthPickerBtn();
  invalidateFilterCache(); _currentPage = 1; renderTable();
  renderConsolGrid();
  if (document.getElementById("screen-consoldetail").classList.contains("active") && currentConsolAloj) viewConsolDetail(currentConsolAloj);
}

function _mpBtnHtml() {
  if (_mpSelYears.size === 0) return { active: false, html: null };
  let yArr = [..._mpSelYears].sort();
  let label = '';
  let arrows = false;
  if (_mpSelYears.size === 1 && _mpSelMonths.size <= 1) {
    // Single selection: show arrows
    arrows = true;
    if (_mpSelMonths.size === 1) {
      let m = [..._mpSelMonths][0];
      label = MONTH_FULL[m] + ' ' + yArr[0];
    } else {
      label = 'A\u00F1o ' + yArr[0];
    }
  } else if (_mpSelMonths.size > 0) {
    let mArr = [..._mpSelMonths].sort((a,b) => a-b);
    let mNames = mArr.map(m => MONTH_NAMES[m]).join(', ');
    label = mNames + ' ' + yArr.join(', ');
  } else {
    label = yArr.join(', ');
  }
  let html = '';
  if (arrows) {
    html += '<span class="mp-nav"><button class="mp-arrow" onclick="event.stopPropagation();mpPrev()">&#8249;</button></span>';
  }
  html += label;
  if (arrows) {
    html += '<span class="mp-nav"><button class="mp-arrow" onclick="event.stopPropagation();mpNext()">&#8250;</button></span>';
  }
  html += '<span class="mp-clear" onclick="event.stopPropagation();clearMonthFilter();">\u2715</span>';
  return { active: true, html: html };
}

function mpPrev() {
  if (_mpSelYears.size !== 1) return;
  let y = [..._mpSelYears][0];
  if (_mpSelMonths.size === 1) {
    let m = [..._mpSelMonths][0];
    m--;
    if (m < 0) { m = 11; y--; }
    _mpSelYears = new Set([y]);
    _mpSelMonths = new Set([m]);
  } else {
    _mpSelYears = new Set([y - 1]);
  }
  _mpRefreshAll();
}

function mpNext() {
  if (_mpSelYears.size !== 1) return;
  let y = [..._mpSelYears][0];
  if (_mpSelMonths.size === 1) {
    let m = [..._mpSelMonths][0];
    m++;
    if (m > 11) { m = 0; y++; }
    _mpSelYears = new Set([y]);
    _mpSelMonths = new Set([m]);
  } else {
    _mpSelYears = new Set([y + 1]);
  }
  _mpRefreshAll();
}

function updateMonthPickerBtn() {
  const info = _mpBtnHtml();
  ['p','c'].forEach(src => {
    const btn = document.getElementById('mp-btn-' + src);
    const label = document.getElementById('mp-label-' + src);
    if (!btn || !label) return;
    if (info.active) {
      label.innerHTML = info.html;
      btn.classList.add('active');
    } else {
      label.textContent = t('filter.allMonths');
      btn.classList.remove('active');
    }
  });
}

// ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ [M10-COMBO] Combobox searchable con multi-selecciÃƒÆ’Ã‚Â³n ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬ÃƒÂ¢Ã¢â‚¬ÂÃ¢â€šÂ¬

/**
 * @description Rellena un combobox con las opciones disponibles.
 * @param {string} id - ID del combo ('platform', 'aloj')
 * @param {string[]} items - Array de opciones ÃƒÆ’Ã‚Âºnicas
 */
function populateCombo(id, items) {
  comboState[id].options = items;
  comboState[id].selected = new Set();
  updateComboDisplay(id);
}

function openCombo(id) {
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  document.querySelectorAll('.mp-dd').forEach(l => l.classList.remove('open'));
  const input = document.querySelector(`#combo-${id} .combo-input`);
  input.value = '';
  input.select();
  renderComboList(id, '');
  document.getElementById(`combo-list-${id}`).classList.add('open');
}

function filterCombo(id) {
  const input = document.querySelector(`#combo-${id} .combo-input`);
  renderComboList(id, input.value);
  document.getElementById(`combo-list-${id}`).classList.add('open');
}

function renderComboList(id, query) {
  const list = document.getElementById(`combo-list-${id}`);
  const q = query.toLowerCase().trim();
  const items = comboState[id].options;
  let filtered = items;
  if (q) filtered = items.filter(i => i.toLowerCase().includes(q));
  const sel = comboState[id].selected;

  const countFn = id === 'platform'
    ? (v) => allReservas.filter(r => r.plataforma === v).length
    : (v) => allReservas.filter(r => r.alojamiento === v).length;

  const allChecked = sel.size === 0;
  let html = `<label class="combo-selall" onclick="event.stopPropagation()"><input type="checkbox" ${allChecked?'checked':''} onchange="toggleComboAll('${id}', this.checked)"> ${comboLabels[id]} <span class="combo-item-count">(${allReservas.length})</span></label>`;
  if (filtered.length === 0) {
    html += '<div class="combo-empty">Sin resultados</div>';
  } else {
    filtered.forEach(item => {
      const isChecked = sel.has(item);
      let label = item;
      if (q) {
        const idx = item.toLowerCase().indexOf(q);
        if (idx >= 0) label = item.slice(0, idx) + '<span class="match">' + item.slice(idx, idx + q.length) + '</span>' + item.slice(idx + q.length);
      }
      const count = countFn(item);
      const esc = item.replace(/'/g, "\\'");
      html += `<label class="combo-item-chk" onclick="event.stopPropagation()"><input type="checkbox" ${isChecked?'checked':''} onchange="toggleComboItem('${id}','${esc}',this.checked)"> ${label} <span class="combo-item-count">(${count})</span></label>`;
    });
  }
  list.innerHTML = html;
}

function toggleComboItem(id, item, checked) {
  const sel = comboState[id].selected;
  if (checked) sel.add(item); else sel.delete(item);
  updateComboDisplay(id);
  invalidateFilterCache(); _currentPage = 1; renderTable();
  // Re-render list to update checkboxes
  const input = document.querySelector(`#combo-${id} .combo-input`);
  renderComboList(id, '');
}

function toggleComboAll(id, checked) {
  if (checked) {
    comboState[id].selected = new Set();
  } else {
    comboState[id].selected = new Set(comboState[id].options);
  }
  updateComboDisplay(id);
  invalidateFilterCache(); _currentPage = 1; renderTable();
  renderComboList(id, '');
}

function updateComboDisplay(id) {
  const input = document.querySelector(`#combo-${id} .combo-input`);
  const wrap = document.getElementById(`combo-${id}`);
  const sel = comboState[id].selected;
  if (sel.size === 0) {
    input.value = '';
    input.placeholder = comboLabels[id];
    wrap.classList.remove('has-value');
  } else if (sel.size === 1) {
    input.value = [...sel][0];
    wrap.classList.add('has-value');
  } else {
    const noun = id === 'platform' ? 'plataformas' : 'alojamientos';
    input.value = sel.size + ' ' + noun;
    wrap.classList.add('has-value');
  }
}

function clearCombo(id) {
  comboState[id].selected = new Set();
  updateComboDisplay(id);
  document.getElementById(`combo-list-${id}`).classList.remove('open');
  invalidateFilterCache(); _currentPage = 1; renderTable();
}

// \u2500\u2500\u2500 SIMPLE COMBO SYSTEM (for status, sort, sortdir) \u2500\u2500\u2500
const simpleComboState = {
  status: { value: 'all', label: t('status.all') },
  sort: { value: 'idx', label: t('sort.original') },
  sortdir: { value: 'asc', label: '&#8593;' },
  consolsort: { value: 'name', label: t('sort.nameAZ') }
};
const simpleComboOptions = {
  status: [
    { value: 'all', label: t('status.all') },
    { value: 'pending', label: t('status.pendingPl') },
    { value: 'validated', label: t('status.validatedPl') }
  ],
  sort: [
    { value: 'idx', label: t('sort.original') },
    { value: 'estado', label: t('sort.status') },
    { value: 'idReserva', label: t('sort.idReserva') },
    { value: 'localizador', label: t('sort.localizador') },
    { value: 'fechaAlta', label: t('sort.fechaAlta') },
    { value: 'cliente', label: t('sort.cliente') },
    { value: 'alojamiento', label: t('sort.alojamiento') },
    { value: 'edificio', label: t('sort.edificio') },
    { value: 'plataforma', label: t('sort.plataforma') },
    { value: 'atendidoPor', label: t('sort.atendidoPor') },
    { value: 'origenMarketing', label: t('sort.origenMkt') },
    { value: 'tipoReserva', label: t('sort.tipoReserva') },
    { value: 'fechaEntrada', label: t('sort.fechaEntrada') },
    { value: 'fechaSalida', label: t('sort.fechaSalida') },
    { value: 'noches', label: t('sort.nights') },
    { value: 'totalReserva', label: t('sort.totalReserva') },
    { value: 'baseSinIVA', label: t('sort.baseNoVAT') },
    { value: 'subtotal', label: t('sort.subtotal') },
    { value: 'totalLiquidar', label: t('sort.totalToSettle') },
    { value: 'observacion', label: t('sort.observation') }
  ],
  sortdir: [
    { value: 'asc', label: t('sort.ascending') },
    { value: 'desc', label: t('sort.descending') }
  ],
  consolsort: [
    { value: 'name', label: t('sort.nameAZ') },
    { value: 'name-desc', label: t('sort.nameZA') },
    { value: 'reservas-desc', label: t('sort.moreReservations') },
    { value: 'reservas-asc', label: t('sort.lessReservations') },
    { value: 'liq-desc', label: t('sort.higherSettlement') },
    { value: 'liq-asc', label: t('sort.lowerSettlement') },
    { value: 'total-desc', label: t('sort.higherBilling') },
    { value: 'total-asc', label: t('sort.lowerBilling') }
  ]
};

function openSimpleCombo(id) {
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  const list = document.getElementById(`combo-list-${id}`);
  const opts = simpleComboOptions[id];
  const current = simpleComboState[id].value;
  list.innerHTML = opts.map(o =>
    `<div class="combo-item ${o.value===current?'active':''}" onclick="selectSimpleCombo('${id}','${o.value}')">${o.label}</div>`
  ).join('');
  list.classList.add('open');
}

function selectSimpleCombo(id, value) {
  const opt = simpleComboOptions[id].find(o => o.value === value);
  simpleComboState[id].value = value;
  simpleComboState[id].label = opt ? opt.label : value;
  const input = document.querySelector(`#combo-${id} .combo-input`);
  const wrap = document.getElementById(`combo-${id}`);
  if (id === 'status') {
    if (value === 'all') {
      input.value = ''; input.placeholder = t('filter.allStatuses'); wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  } else if (id === 'sort') {
    if (value === 'idx') {
      input.value = ''; input.placeholder = t('sort.originalOrder'); wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  } else if (id === 'sortdir') {
    if (value === 'asc') {
      input.value = ''; input.placeholder = '\u2191'; wrap.classList.remove('has-value');
    } else {
      input.value = '\u2193'; wrap.classList.add('has-value');
    }
  } else if (id === 'consolsort') {
    if (value === 'name') {
      input.value = ''; input.placeholder = t('sort.nameAsc'); wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  }
  document.getElementById(`combo-list-${id}`).classList.remove('open');
  if (id === 'consolsort') { renderConsolGrid(); }
  else { _currentPage = 1; renderTable(); }
}

function clearSimpleCombo(id) {
  const defaults = { status: 'all', sort: 'idx', sortdir: 'asc', consolsort: 'name' };
  selectSimpleCombo(id, defaults[id] || 'all');
}

// Close all combos on outside click
document.addEventListener('click', function(e) {
  // Close column toggles
  document.querySelectorAll('.col-toggle-wrap').forEach(ctw => {
    if (!ctw.contains(e.target)) {
      const dd = ctw.querySelector('.col-toggle-dd');
      if (dd) dd.classList.remove('open');
    }
  });
  // Close month pickers
  ['p','c'].forEach(src => {
    const mpWrap = document.getElementById('mp-wrap-' + src);
    if (mpWrap && !mpWrap.contains(e.target)) {
      document.getElementById('mp-dd-' + src).classList.remove('open');
    }
  });
  document.querySelectorAll('.combo').forEach(c => {
    if (!c.contains(e.target)) {
      c.querySelector('.combo-list').classList.remove('open');
      const id = c.id.replace('combo-', '');
      // Restore display for searchable combos
      if (comboState[id]) updateComboDisplay(id);
    }
  });
});

// Keyboard nav for combos
document.querySelectorAll('.combo-input').forEach(input => {
  input.addEventListener('keydown', function(e) {
    const id = this.closest('.combo').id.replace('combo-', '');
    const list = document.getElementById(`combo-list-${id}`);
    if (e.key === 'Escape') { list.classList.remove('open'); this.blur(); }
  });
});

// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â
//  [M18] AI_ASSISTANT ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â Chat con IA integrado (Claude API)
// ÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚ÂÃƒÂ¢Ã¢â‚¬Â¢Ã‚Â

// === AI ASSISTANT ===
let _aiPanelOpen = false;
let _aiHistory = [];
let _aiProcessing = false;
let _aiContextCache = { key: '', ctx: '', ts: 0 }; // Phase 4: context cache
let _aiAlertsShown = false; // Phase 4: anomaly alerts shown flag
let _aiEntityMemory = { pisos: [], propietarios: [], plataformas: [] }; // Phase 5: entity tracking

function sendAIChip(btn) {
  var qKey = btn.getAttribute('data-q-key');
  var q = qKey ? t(qKey) : btn.getAttribute('data-q');
  if (!q) return;
  // Decode HTML entities
  var tmp = document.createElement('textarea');
  tmp.innerHTML = q;
  q = tmp.value;
  document.getElementById('ai-input').value = q;
  // Hide chips after first click
  var chips = document.getElementById('ai-chips');
  if (chips) chips.classList.add('ai-chips-hidden');
  sendAIMessage();
}

function toggleAIPanel() {
  _aiPanelOpen = !_aiPanelOpen;
  document.getElementById('ai-panel').classList.toggle('open', _aiPanelOpen);
  if (_aiPanelOpen) {
    document.getElementById('ai-badge').style.display = 'none';
    setTimeout(function(){ document.getElementById('ai-input').focus(); }, 300);
    // Phase 4: Show anomaly alerts on first open after data load
    if (!_aiAlertsShown && allReservas && allReservas.length > 0) {
      _aiAlertsShown = true;
      setTimeout(_showAnomalyAlerts, 400);
    }
  }
}

/**
 * @description Detecta anomal\u00EDas en los datos y muestra alertas proactivas.
 * Se ejecuta una vez al abrir el panel tras cargar datos.
 */
function _showAnomalyAlerts() {
  if (!allReservas || allReservas.length === 0) return;
  var alerts = [];
  var f = function(v) { return v.toFixed(2); };

  // 1. Pisos con ADR bajo (<50 EUR/noche)
  var lowAdr = [];
  var byAloj = {};
  allReservas.forEach(function(r) {
    var a = r.alojamiento || 'Sin'; var c = getLiq(r); var n = r._nights || 0;
    if (!byAloj[a]) byAloj[a] = {n:0, noch:0, imp:0, liq:0};
    byAloj[a].n++; byAloj[a].noch += n; byAloj[a].imp += c.total; byAloj[a].liq += c.totalLiq;
  });
  Object.keys(byAloj).forEach(function(a) {
    var d = byAloj[a];
    if (d.noch >= 5) { // solo si tiene al menos 5 noches
      var adr = d.imp / d.noch;
      if (adr < 50) lowAdr.push({ name: a, adr: adr, noch: d.noch });
    }
  });
  if (lowAdr.length > 0) {
    alerts.push('\u26A0\uFE0F **' + lowAdr.length + ' ' + t('alert.lowAdr') + '**: ' +
      lowAdr.slice(0,5).map(function(x){ return x.name + ' (' + f(x.adr) + '\u20AC)'; }).join(', ') +
      (lowAdr.length > 5 ? '... ' + t('alert.andMore').replace('%s', lowAdr.length-5) : ''));
  }

  // 2. Pisos sin reservas (en propietarios pero 0 reservas)
  if (_propietariosMap) {
    var sinReservas = [];
    Object.keys(_propietariosMap).forEach(function(k) {
      if (!_propietariosMap[k]) return;
      var found = false;
      for (var i = 0; i < allReservas.length; i++) {
        if (allReservas[i]._alojLc === k) { found = true; break; }
      }
      if (!found) sinReservas.push(k.toUpperCase());
    });
    if (sinReservas.length > 0) {
      alerts.push('\uD83D\uDEAB **' + sinReservas.length + ' ' + t('alert.noReserv') + '**: ' +
        sinReservas.slice(0,5).join(', ') + (sinReservas.length > 5 ? '...' : ''));
    }
  }

  // 3. Alto % de pendientes de validar
  var pctPend = allReservas.length > 0 ? ((allReservas.length - validated.size) / allReservas.length * 100) : 0;
  if (pctPend > 50 && allReservas.length > 20) {
    alerts.push('\u2705 **' + (allReservas.length - validated.size) + ' ' + t('alert.pendingVal') + '** (' + pctPend.toFixed(0) + '% ' + t('alert.ofTotal') + ')');
  }

  // 4. Pisos con margen propietario muy bajo (<30%)
  var lowMargin = [];
  Object.keys(byAloj).forEach(function(a) {
    var d = byAloj[a];
    if (d.imp > 500) { // solo pisos con ingresos significativos
      var margin = d.liq / d.imp * 100;
      if (margin < 30) lowMargin.push({ name: a, margin: margin });
    }
  });
  if (lowMargin.length > 0) {
    alerts.push('\uD83D\uDCC9 **' + lowMargin.length + ' ' + t('alert.lowMargin') + '**: ' +
      lowMargin.slice(0,4).map(function(x){ return x.name + ' (' + x.margin.toFixed(0) + '%)'; }).join(', '));
  }

  // 5. Phase 5: Duplicados detectados
  var dupSeen = {};
  var dupCount = 0;
  allReservas.forEach(function(r) {
    var key = (r.cliente||'').toLowerCase().trim() + '|' + (r.alojamiento||'').toLowerCase() + '|' + (r._fmtEntrada||'') + '|' + (r._fmtSalida||'');
    if (key.length < 10) return;
    if (dupSeen[key]) dupCount++; else dupSeen[key] = true;
  });
  if (dupCount > 0) {
    alerts.push('\uD83D\uDD04 **' + dupCount + ' ' + t('alert.duplicates') + '** ' + t('alert.showDups'));
  }

  if (alerts.length > 0) {
    var alertDiv = document.createElement('div');
    alertDiv.className = 'ai-msg ai-alert';
    alertDiv.innerHTML = '<strong>' + t('alert.detected') + '</strong><br>' +
      alerts.join('<br>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>') +
      '<br><em style="font-size:11px;color:#6b7280;">' + t('alert.askMore') + '</em>';
    document.getElementById('ai-messages').appendChild(alertDiv);
    document.getElementById('ai-messages').scrollTop = document.getElementById('ai-messages').scrollHeight;
  }
}

function _toggleAIHelp() {
  var overlay = document.getElementById('ai-help-overlay');
  if (overlay) overlay.classList.toggle('open');
}

function _getAIKey() {
  let key = SafeStorage.get('ai-api-key');
  if (!key) {
    key = prompt(t('ai.apiKeyPrompt'));
    if (key && key.trim()) {
      SafeStorage.set('ai-api-key', key.trim());
    } else { return null; }
  }
  return key;
}

/**
 * @description Fase 2: Clasificador de queries.
 * Analiza la pregunta del usuario y devuelve un Set de categor\u00EDas
 * para construir solo el contexto relevante.
 * @param {string} text - Pregunta del usuario
 * @returns {Set<string>} Categor\u00EDas activas
 */
function _classifyQuery(text) {
  var cats = new Set();
  var t = text.toLowerCase();

  // Always include global summary (cheap)
  cats.add('GLOBAL');

  var patterns = {
    FINANCIAL: /comisi[oÃ³]n|irpf|retenci[oÃ³]n|limpieza|amenities|pasarela|desglose|coste|gasto|margen|beneficio|ingres/i,
    PLATFORM:  /plataforma|booking|airbnb|vrbo|canal|venta|stripe/i,
    PROPERTY:  /alojamiento|piso|apartamento|propiedad|vivienda|top.*(aloj|piso)|ranking/i,
    OWNER:     /propietario|due[Ã±n]o|liquidaci[oÃ³]n\s+(de|para|del)|qui[eÃ©]n|owner/i,
    TIME:      /mes(es)?|mensual|enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|trimestre|semestre|estacion|temporada|verano|invierno|a[Ã±n]o|anual|201|202|comparar?|vs|versus|evolu|creci|tendencia/i,
    AGENT:     /agente|atendido|gestion[oÃ³]?|qui[eÃ©]n (atiende|gestiona|lleva)/i,
    MARKETING: /marketing|origen|captaci|campa[Ã±n]a|fuente|canal.*(market|captac)/i,
    GTC_SPLIT: /80.?20|m[iÃ­]nimo.*garant|acuerdo|split|especial/i,
    MAINT:     /mantenimiento|extra(ordinari)?|cuota|gasto.*fijo/i,
    VALIDATE:  /validar?|validaci|pendiente|estado|revisar/i,
    DETAIL:    /detalle|lista|reserva.*(de|del|para)|cliente|localizador|busca|espec[iÃ­]fic/i,
    SUMMARY:   /resumen|ejecutivo|general|total|global|overview|todo|completo/i,
    KPI:       /kpi|indicador|adr|revpar|ocupaci|media|promedio|ratio|eficiencia|rendimiento|m[eÃ©]trica|estad[iÃ­]stic/i,
    YOY:       /interanual|yoy|year.over|a[Ã±n]o.a.a[Ã±n]o|compar.*(a[Ã±n]o|anual|201|202)|creci.*anual|vs\s*20[12]/i,
    SEASON:    /estacion|temporada|verano|invierno|alta|baja|trimestre|q[1234]|t[1234]|pico|valle/i,
    CMP_OWNER: /compar.*propietario|propietario.*vs|versus.*propietario|pisos\s+de\s+\w+\s+(vs|contra|frente|compar)/i,
    PREDICT:   /predicci[oÃ³]n|proyecci[oÃ³]n|previsi[oÃ³]n|estimar?|pronostic|futuro|pr[oÃ³]ximo|siguiente|forecast/i,
    EXPORT:    /export|excel|csv|descargar?|generar?.*(tabla|archivo|fichero)|guardar.*(tabla|datos)/i,
    DUPCHECK:  /duplicad|sospech|an[oÃ³]mal|raro|extra[Ã±n]|repetid|error|inconsist/i,
    SEGMENT:   /segmento|tipo.*(estancia|cliente|reserva)|escapada|corta|larga|media.*(estancia|duraci)|clasificar?/i,
    HEATMAP:   /heatmap|mapa.*calor|calendario|ocupaci[oÃ³]n.*(mes|piso|visual)|vista.*(anual|mensual|calend)|parrilla/i,
    LEADTIME:  /antelaci[oÃ³]n|lead.?time|anticipo|d[iÃ­]as.*antes|reserv.*(anticip|antelac|previo)|cuando.*reserv/i,
    BRIEFING:  /briefing|resumen.*r[aÃ¡]pido|3.*frase|estado.*actual|lo m[aÃ¡]s.*importante|titulares|flash|quick/i,
    WHATIF:    /qu[eÃ©].*pasar|simular?|simulaci|what.?if|hipot[eÃ©]tic|escenario|si.*subir|si.*bajar|si.*cambiar|ahorrar[iÃ­]amos/i,
  };

  Object.keys(patterns).forEach(function(cat) {
    if (patterns[cat].test(t)) cats.add(cat);
  });

  // If only GLOBAL matched (no specific pattern), assume SUMMARY
  if (cats.size === 1) cats.add('SUMMARY');

  return cats;
}

/**
 * @description Construye el contexto de datos seg\u00FAn las categor\u00EDas detectadas.
 * Fase 4: Cache + predicci\u00F3n + comparaci\u00F3n propietarios.
 * @param {Set<string>} cats - Categor\u00EDas de la query
 * @returns {string} Contexto optimizado
 */
function buildAIContext(cats) {
  if (!allReservas || allReservas.length === 0) return t('msg.noData');
  if (!cats) cats = new Set(['GLOBAL', 'SUMMARY']);

  // Phase 4: Context cache - reuse if same categories and data hasn't changed
  var cacheKey = Array.from(cats).sort().join(',') + '|' + allReservas.length + '|' + validated.size;
  if (_aiContextCache.key === cacheKey && (Date.now() - _aiContextCache.ts) < 30000) {
    console.log('[AI] Context cache HIT');
    return _aiContextCache.ctx;
  }

  var total = allReservas.length;
  var needAloj = cats.has('PROPERTY') || cats.has('SUMMARY') || cats.has('FINANCIAL') || cats.has('OWNER') || cats.has('MAINT') || cats.has('KPI') || cats.has('YOY') || cats.has('CMP_OWNER') || cats.has('DUPCHECK');
  var needPlat = cats.has('PLATFORM') || cats.has('SUMMARY') || cats.has('FINANCIAL') || cats.has('SEASON') || cats.has('WHATIF');
  var needMes = cats.has('TIME') || cats.has('SUMMARY') || cats.has('SEASON') || cats.has('PREDICT') || cats.has('BRIEFING');
  var needYear = cats.has('TIME') || cats.has('SUMMARY') || cats.has('YOY') || cats.has('PREDICT');
  var needAgent = cats.has('AGENT') || cats.has('SUMMARY');
  var needMkt = cats.has('MARKETING') || cats.has('SUMMARY');
  var needOwner = cats.has('OWNER') || cats.has('SUMMARY') || cats.has('CMP_OWNER');
  var needGtc = cats.has('GTC_SPLIT') || cats.has('OWNER') || cats.has('SUMMARY');
  var needMaint = cats.has('MAINT') || cats.has('OWNER') || cats.has('SUMMARY');
  var needDetail = cats.has('DETAIL');
  var needVal = cats.has('VALIDATE');
  var needKpi = cats.has('KPI') || cats.has('SUMMARY');
  var needYoy = cats.has('YOY') || cats.has('TIME');
  var needSeason = cats.has('SEASON') || cats.has('TIME');
  var needPredict = cats.has('PREDICT');
  var needCmpOwner = cats.has('CMP_OWNER');
  var needDup = cats.has('DUPCHECK');
  var needSegment = cats.has('SEGMENT') || cats.has('SUMMARY');
  var needHeatmap = cats.has('HEATMAP');
  var needLeadtime = cats.has('LEADTIME');
  var needBriefing = cats.has('BRIEFING');
  var needWhatif = cats.has('WHATIF');

  // Always compute global
  var byAloj = {}, byPlat = {}, byMes = {}, byYear = {}, byAgent = {}, byMarketing = {};
  var byPlatQ = {}; // plataforma Ã— trimestre (seasonality)
  var byAlojYear = {}; // alojamiento Ã— a\u00F1o (YoY)
  var bySegment = {corta:0, media:0, larga:0, cortaN:0, mediaN:0, largaN:0, cortaI:0, mediaI:0, largaI:0}; // Phase 5
  var byAlojMes = {}; // Phase 5: heatmap alojÃ—mes
  var leadTimes = []; // Phase 5: lead time data
  var dupCandidates = []; // Phase 5: duplicate candidates
  var G = {n:0, noch:0, imp:0, base:0, cPlat:0, cGTC:0, cPas:0, limp:0, amen:0, ce:0, ce2:0, irpf:0, liq:0, val:0, pend:0};

  allReservas.forEach(function(r) {
    var c = getLiq(r), n = r._nights || 0;
    G.n++; G.noch += n; G.imp += c.total; G.base += c.baseSinIVA;
    G.cPlat += c.comPlat; G.cGTC += c.comGTC; G.cPas += c.comPas;
    G.limp += c.limp; G.amen += c.amen; G.ce += c.ceTotal; G.ce2 += c.ceSinIvaTotal;
    G.irpf += c.ret; G.liq += c.totalLiq;
    if (validated.has(r.idx)) G.val++; else G.pend++;

    if (needAloj) {
      var a = r.alojamiento || 'Sin alojamiento';
      if (!byAloj[a]) byAloj[a] = {n:0, noch:0, imp:0, base:0, cPlat:0, cGTC:0, limp:0, amen:0, liq:0};
      var da = byAloj[a]; da.n++; da.noch += n; da.imp += c.total; da.base += c.baseSinIVA;
      da.cPlat += c.comPlat; da.cGTC += c.comGTC; da.limp += c.limp; da.amen += c.amen; da.liq += c.totalLiq;
    }
    if (needPlat) {
      var p = r.plataforma || 'Desconocida';
      if (!byPlat[p]) byPlat[p] = {n:0, imp:0, base:0, cPlat:0, cPas:0, liq:0};
      var dp = byPlat[p]; dp.n++; dp.imp += c.total; dp.base += c.baseSinIVA;
      dp.cPlat += c.comPlat; dp.cPas += c.comPas; dp.liq += c.totalLiq;
    }
    var fE = r._dEntrada;
    if (fE && (needMes || needYear)) {
      if (needMes) {
        var mes = (fE.getMonth()+1).toString().padStart(2,'0') + '/' + fE.getFullYear();
        if (!byMes[mes]) byMes[mes] = {n:0, noch:0, imp:0, liq:0};
        var dm = byMes[mes]; dm.n++; dm.noch += n; dm.imp += c.total; dm.liq += c.totalLiq;
      }
      if (needYear) {
        var yr = fE.getFullYear().toString();
        if (!byYear[yr]) byYear[yr] = {n:0, noch:0, imp:0, base:0, liq:0, cPlat:0, cGTC:0};
        var dy = byYear[yr]; dy.n++; dy.noch += n; dy.imp += c.total; dy.base += c.baseSinIVA; dy.liq += c.totalLiq;
        dy.cPlat += c.comPlat; dy.cGTC += c.comGTC;
      }
      // Estacionalidad: plataforma x trimestre
      if (needSeason) {
        var q = 'T' + (Math.floor(fE.getMonth() / 3) + 1);
        var pk = (r.plataforma || 'Desconocida') + '|' + q;
        if (!byPlatQ[pk]) byPlatQ[pk] = {n:0, noch:0, imp:0};
        byPlatQ[pk].n++; byPlatQ[pk].noch += n; byPlatQ[pk].imp += c.total;
      }
      // YoY por alojamiento
      if (needYoy) {
        var yk = (r.alojamiento || 'Sin') + '|' + fE.getFullYear();
        if (!byAlojYear[yk]) byAlojYear[yk] = {n:0, noch:0, imp:0, liq:0};
        byAlojYear[yk].n++; byAlojYear[yk].noch += n; byAlojYear[yk].imp += c.total; byAlojYear[yk].liq += c.totalLiq;
      }
    }
    if (needAgent) {
      var ag = r.atendidoPor || 'Sin asignar';
      if (!byAgent[ag]) byAgent[ag] = {n:0, imp:0};
      byAgent[ag].n++; byAgent[ag].imp += c.total;
    }
    if (needMkt) {
      var mk = r.origenMarketing || 'Sin origen';
      if (!byMarketing[mk]) byMarketing[mk] = {n:0, imp:0};
      byMarketing[mk].n++; byMarketing[mk].imp += c.total;
    }
    // Phase 5: Client segmentation
    if (needSegment) {
      if (n <= 2) { bySegment.corta++; bySegment.cortaN += n; bySegment.cortaI += c.total; }
      else if (n <= 7) { bySegment.media++; bySegment.mediaN += n; bySegment.mediaI += c.total; }
      else { bySegment.larga++; bySegment.largaN += n; bySegment.largaI += c.total; }
    }
    // Phase 5: Heatmap alojÃ—mes
    if (needHeatmap && fE) {
      var hmKey = (r.alojamiento || 'Sin') + '|' + (fE.getMonth()+1).toString().padStart(2,'0');
      if (!byAlojMes[hmKey]) byAlojMes[hmKey] = {n:0, noch:0};
      byAlojMes[hmKey].n++; byAlojMes[hmKey].noch += n;
    }
    // Phase 5: Lead time
    if (needLeadtime && fE && r._dAlta) {
      var ltDays = Math.round((fE - r._dAlta) / 86400000);
      if (ltDays >= 0 && ltDays < 730) {
        leadTimes.push({days: ltDays, plat: r.plataforma || 'Desconocida', aloj: r.alojamiento || 'Sin'});
      }
    }
    // Phase 5: Duplicate detection (collect fingerprints)
    if (needDup) {
      dupCandidates.push({
        idx: r.idx, cliente: (r.cliente||'').toLowerCase().trim(),
        aloj: (r.alojamiento||'').toLowerCase(), plat: r.plataforma||'',
        entrada: r._fmtEntrada||'', salida: r._fmtSalida||'',
        imp: c.total, n: n
      });
    }
  });

  var f = function(v){ return v.toFixed(2); };

  // GLOBAL (always)
  var ctx = '=== RESUMEN GLOBAL ===\n';
  ctx += 'Reservas: ' + G.n + ' (Validadas: ' + G.val + ', Pendientes: ' + G.pend + ')\n';
  ctx += 'Noches: ' + G.noch + '\n';
  if (cats.has('FINANCIAL') || cats.has('SUMMARY') || cats.has('GLOBAL')) {
    ctx += 'Importe(IVA): ' + f(G.imp) + ', Base(sinIVA): ' + f(G.base) + '\n';
    ctx += 'Comisi\u00F3n canales: ' + f(G.cPlat) + ', Comisi\u00F3n GTC: ' + f(G.cGTC) + ', Pasarela: ' + f(G.cPas) + '\n';
    ctx += 'Limpieza: ' + f(G.limp) + ', Amenities: ' + f(G.amen) + '\n';
    ctx += 'CE(IVA): ' + f(G.ce) + ', CE(sinIVA): ' + f(G.ce2) + ', IRPF: ' + f(G.irpf) + '\n';
    ctx += 'Total a liquidar: ' + f(G.liq) + '\n';
    if (G.n > 0) ctx += 'Media/reserva: ' + f(G.imp/G.n) + ', Media/noche: ' + (G.noch>0 ? f(G.imp/G.noch) : '-') + '\n';
  } else {
    ctx += 'Importe(IVA): ' + f(G.imp) + ', A liquidar: ' + f(G.liq) + '\n';
  }

  // POR ALOJAMIENTO
  if (needAloj) {
    ctx += '\n=== POR ALOJAMIENTO ===\n';
    Object.keys(byAloj).sort().forEach(function(a) {
      var d = byAloj[a];
      ctx += a + ': ' + d.n + 'res ' + d.noch + 'noch, imp=' + f(d.imp) + ' comCanal=' + f(d.cPlat) + ' comGTC=' + f(d.cGTC) + ' limp=' + f(d.limp) + ' liq=' + f(d.liq) + '\n';
    });
  }

  // POR PLATAFORMA
  if (needPlat) {
    ctx += '\n=== POR PLATAFORMA ===\n';
    Object.keys(byPlat).sort().forEach(function(p) {
      var d = byPlat[p];
      ctx += p + ': ' + d.n + 'res, imp=' + f(d.imp) + ' comCanal=' + f(d.cPlat) + ' comPas=' + f(d.cPas) + ' liq=' + f(d.liq) + '\n';
    });
  }

  // POR MES
  if (needMes) {
    ctx += '\n=== POR MES ===\n';
    Object.keys(byMes).sort().forEach(function(m) {
      var d = byMes[m];
      ctx += m + ': ' + d.n + 'res ' + d.noch + 'noch, imp=' + f(d.imp) + ' liq=' + f(d.liq) + '\n';
    });
  }

  // POR A\u00D1O
  if (needYear) {
    var years = Object.keys(byYear).sort();
    if (years.length > 1) {
      ctx += '\n=== POR A\u00D1O ===\n';
      years.forEach(function(yr) {
        var d = byYear[yr];
        ctx += yr + ': ' + d.n + 'res ' + d.noch + 'noch, imp=' + f(d.imp) + ' comCanal=' + f(d.cPlat) + ' comGTC=' + f(d.cGTC) + ' liq=' + f(d.liq) + '\n';
      });
    }
  }

  // POR AGENTE
  if (needAgent) {
    var agents = Object.keys(byAgent).sort();
    if (agents.length > 1) {
      ctx += '\n=== POR AGENTE ===\n';
      agents.forEach(function(ag) { var d=byAgent[ag]; ctx += ag + ': ' + d.n + 'res, imp=' + f(d.imp) + '\n'; });
    }
  }

  // POR MARKETING
  if (needMkt) {
    var mkKeys = Object.keys(byMarketing).filter(function(k){ return k !== 'Sin origen'; }).sort();
    if (mkKeys.length > 1) {
      ctx += '\n=== POR ORIGEN MARKETING ===\n';
      mkKeys.forEach(function(mk) { var d=byMarketing[mk]; ctx += mk + ': ' + d.n + 'res, imp=' + f(d.imp) + '\n'; });
    }
  }

  // PROPIETARIOS
  if (needOwner && _propietariosMap && Object.keys(_propietariosMap).length > 0) {
    var byOwner = {};
    allReservas.forEach(function(r) {
      var ownerName = getPropietario(r.alojamiento);
      if (!ownerName || ownerName === t('consol.missingOwner')) return;
      if (!byOwner[ownerName]) byOwner[ownerName] = { pisos: {}, reservas: 0, imp: 0, liq: 0 };
      byOwner[ownerName].pisos[r.alojamiento] = true;
      byOwner[ownerName].reservas++;
      var c = getLiq(r);
      byOwner[ownerName].imp += c.total;
      byOwner[ownerName].liq += c.totalLiq;
    });
    var owners = Object.keys(byOwner).sort();
    if (owners.length > 0) {
      ctx += '\n=== PROPIETARIOS ===\n';
      owners.forEach(function(ow) {
        var d = byOwner[ow];
        ctx += ow + ': ' + Object.keys(d.pisos).sort().join(', ') + ' (' + d.reservas + 'res, imp=' + f(d.imp) + ' liq=' + f(d.liq) + ')\n';
      });
    }
  }

  // ACUERDOS ESPECIALES
  if (needGtc && (_gtcSplitAlojamientos.length > 0 || _gtcOwnedAlojamientos.length > 0)) {
    ctx += '\n=== ACUERDOS ESPECIALES ===\n';
    if (_gtcSplitAlojamientos.length > 0) {
      ctx += 'M\u00EDnimo garantizado 80/20: ' + _gtcSplitAlojamientos.join(', ') + '\n';
      ctx += '(GTC retiene 20%, propietario recibe 80%)\n';
    }
    if (_gtcOwnedAlojamientos.length > 0) {
      ctx += 'Propiedades GTC: ' + _gtcOwnedAlojamientos.join(', ') + ' (' + _gtcOwnedAlojamientos.length + ' pisos)\n';
    }
  }

  // MANTENIMIENTO
  if (needMaint) {
    var maintEntries = Object.keys(_consolMaint).filter(function(k){ return _consolMaint[k] && _consolMaint[k].enabled; });
    if (maintEntries.length > 0) {
      ctx += '\n=== MANTENIMIENTO MENSUAL ===\n';
      maintEntries.sort().forEach(function(a) { ctx += a + ': ' + f(_consolMaint[a].amount) + ' EUR/mes\n'; });
    }
  }

  // KPIs AVANZADOS
  if (needKpi && G.n > 0) {
    ctx += '\n=== KPIs ===\n';
    var adr = G.noch > 0 ? G.imp / G.noch : 0;
    var estanciaMedia = G.noch / G.n;
    var numAloj = Object.keys(byAloj).length || 1;
    var impPorPiso = G.imp / numAloj;
    var liqPorPiso = G.liq / numAloj;
    var comEfectiva = G.imp > 0 ? (G.cPlat + G.cGTC + G.cPas) / G.imp * 100 : 0;
    var margenProp = G.imp > 0 ? G.liq / G.imp * 100 : 0;
    ctx += 'ADR (tarifa media diaria): ' + f(adr) + ' EUR/noche (IVA incl.)\n';
    ctx += 'Estancia media: ' + estanciaMedia.toFixed(1) + ' noches/reserva\n';
    ctx += 'Ingreso medio por piso: ' + f(impPorPiso) + ' EUR (' + numAloj + ' alojamientos)\n';
    ctx += 'Liquidaci\u00F3n media por piso: ' + f(liqPorPiso) + ' EUR\n';
    ctx += 'Comisi\u00F3n efectiva total: ' + comEfectiva.toFixed(1) + '% (canal+GTC+pasarela sobre importe)\n';
    ctx += 'Margen propietario: ' + margenProp.toFixed(1) + '% (liquidaci\u00F3n/importe)\n';
    ctx += 'Reservas/piso: ' + (G.n / numAloj).toFixed(1) + ', Noches/piso: ' + (G.noch / numAloj).toFixed(1) + '\n';
    // Top 5 alojamientos por liquidaci\u00F3n
    if (needAloj) {
      var topAloj = Object.keys(byAloj).sort(function(a,b){ return byAloj[b].liq - byAloj[a].liq; }).slice(0,5);
      ctx += 'Top 5 pisos (liq): ';
      ctx += topAloj.map(function(a){ return a + '=' + f(byAloj[a].liq); }).join(', ') + '\n';
      // Bottom 5
      var botAloj = Object.keys(byAloj).sort(function(a,b){ return byAloj[a].liq - byAloj[b].liq; }).slice(0,5);
      ctx += 'Bottom 5 pisos (liq): ';
      ctx += botAloj.map(function(a){ return a + '=' + f(byAloj[a].liq); }).join(', ') + '\n';
      // ADR por alojamiento (top 5 + bottom 5)
      var alojByAdr = Object.keys(byAloj).filter(function(a){ return byAloj[a].noch > 0; })
        .sort(function(a,b){ return (byAloj[b].imp/byAloj[b].noch) - (byAloj[a].imp/byAloj[a].noch); });
      if (alojByAdr.length > 0) {
        ctx += 'Top 5 ADR: ' + alojByAdr.slice(0,5).map(function(a){ return a + '=' + f(byAloj[a].imp/byAloj[a].noch); }).join(', ') + '\n';
        ctx += 'Bottom 5 ADR: ' + alojByAdr.slice(-5).reverse().map(function(a){ return a + '=' + f(byAloj[a].imp/byAloj[a].noch); }).join(', ') + '\n';
      }
    }
  }

  // COMPARATIVA INTERANUAL (YoY)
  if (needYoy) {
    var yoyYears = Object.keys(byYear).sort();
    if (yoyYears.length >= 2) {
      ctx += '\n=== COMPARATIVA INTERANUAL ===\n';
      // Table header
      ctx += 'Concepto|' + yoyYears.join('|') + '|\u0394% \u00FAlt.\n';
      var last = yoyYears[yoyYears.length - 1], prev = yoyYears[yoyYears.length - 2];
      var dl = byYear[last], dp = byYear[prev];
      var pct = function(a,b){ return b > 0 ? ((a-b)/b*100).toFixed(1)+'%' : 'n/a'; };
      ctx += 'Reservas|' + yoyYears.map(function(y){ return byYear[y].n; }).join('|') + '|' + pct(dl.n,dp.n) + '\n';
      ctx += 'Noches|' + yoyYears.map(function(y){ return byYear[y].noch; }).join('|') + '|' + pct(dl.noch,dp.noch) + '\n';
      ctx += 'Importe|' + yoyYears.map(function(y){ return f(byYear[y].imp); }).join('|') + '|' + pct(dl.imp,dp.imp) + '\n';
      ctx += 'Liquidaci\u00F3n|' + yoyYears.map(function(y){ return f(byYear[y].liq); }).join('|') + '|' + pct(dl.liq,dp.liq) + '\n';
      ctx += 'ADR|' + yoyYears.map(function(y){ return byYear[y].noch>0 ? f(byYear[y].imp/byYear[y].noch) : '-'; }).join('|') + '|' + pct(dl.noch>0?dl.imp/dl.noch:0, dp.noch>0?dp.imp/dp.noch:0) + '\n';

      // Top movers por alojamiento (solo los que existen en ambos a\u00F1os)
      var alojYoy = {};
      Object.keys(byAlojYear).forEach(function(k) {
        var parts = k.split('|'), aloj = parts[0], yr = parts[1];
        if (!alojYoy[aloj]) alojYoy[aloj] = {};
        alojYoy[aloj][yr] = byAlojYear[k];
      });
      var movers = Object.keys(alojYoy).filter(function(a){ return alojYoy[a][last] && alojYoy[a][prev]; })
        .map(function(a){
          var curImp = alojYoy[a][last].imp, prevImp = alojYoy[a][prev].imp;
          return { name: a, cur: curImp, prev: prevImp, delta: prevImp > 0 ? (curImp-prevImp)/prevImp*100 : 999 };
        })
        .sort(function(a,b){ return b.delta - a.delta; });
      if (movers.length > 0) {
        ctx += '\nTop 5 crecimiento (' + prev + '\u2192' + last + '):\n';
        movers.slice(0,5).forEach(function(m) {
          ctx += m.name + ': ' + f(m.prev) + ' \u2192 ' + f(m.cur) + ' (' + (m.delta >= 999 ? 'nuevo' : (m.delta>0?'+':'') + m.delta.toFixed(1) + '%') + ')\n';
        });
        if (movers.length > 5) {
          var decliners = movers.slice().reverse().slice(0,5);
          ctx += 'Top 5 descenso:\n';
          decliners.forEach(function(m) {
            ctx += m.name + ': ' + f(m.prev) + ' \u2192 ' + f(m.cur) + ' (' + (m.delta>0?'+':'') + m.delta.toFixed(1) + '%)\n';
          });
        }
      }
    }
  }

  // ESTACIONALIDAD CRUZADA (plataforma x trimestre)
  if (needSeason && Object.keys(byPlatQ).length > 0) {
    ctx += '\n=== ESTACIONALIDAD (PLATAFORMA x TRIMESTRE) ===\n';
    // Collect all platforms and quarters
    var sPlats = {}, sQuarts = {};
    Object.keys(byPlatQ).forEach(function(k) {
      var parts = k.split('|');
      sPlats[parts[0]] = true; sQuarts[parts[1]] = true;
    });
    var platList = Object.keys(sPlats).sort();
    var qList = Object.keys(sQuarts).sort();
    ctx += 'Plataforma|' + qList.join('|') + '|Total\n';
    platList.forEach(function(p) {
      var totalP = 0;
      var row = p;
      qList.forEach(function(q) {
        var d = byPlatQ[p + '|' + q];
        var val = d ? d.imp : 0;
        totalP += val;
        row += '|' + (d ? d.n + 'res/' + f(val) : '-');
      });
      row += '|' + f(totalP);
      ctx += row + '\n';
    });
    // Quarter totals
    var rowT = 'TOTAL';
    var grandT = 0;
    qList.forEach(function(q) {
      var qTotal = 0;
      platList.forEach(function(p) { var d = byPlatQ[p+'|'+q]; if(d) qTotal += d.imp; });
      grandT += qTotal;
      rowT += '|' + f(qTotal);
    });
    rowT += '|' + f(grandT);
    ctx += rowT + '\n';
    // Pico vs valle
    var qTotals = qList.map(function(q) {
      var t = 0; platList.forEach(function(p) { var d = byPlatQ[p+'|'+q]; if(d) t += d.imp; }); return {q:q, imp:t};
    }).sort(function(a,b){ return b.imp - a.imp; });
    if (qTotals.length >= 2) {
      ctx += 'Trimestre pico: ' + qTotals[0].q + ' (' + f(qTotals[0].imp) + '), Valle: ' + qTotals[qTotals.length-1].q + ' (' + f(qTotals[qTotals.length-1].imp) + ')\n';
    }
  }

  // COMPARACIÃ“N DE PROPIETARIOS (detalle por owner con mÃ©tricas por piso)
  if (needCmpOwner && _propietariosMap && Object.keys(_propietariosMap).length > 0) {
    var cmpOwners = {};
    allReservas.forEach(function(r) {
      var ownerName = getPropietario(r.alojamiento);
      if (!ownerName || ownerName === t('consol.missingOwner')) return;
      if (!cmpOwners[ownerName]) cmpOwners[ownerName] = { pisos: {} };
      var a = r.alojamiento;
      if (!cmpOwners[ownerName].pisos[a]) cmpOwners[ownerName].pisos[a] = {n:0, noch:0, imp:0, liq:0};
      var c = getLiq(r), n = r._nights || 0;
      var dp = cmpOwners[ownerName].pisos[a];
      dp.n++; dp.noch += n; dp.imp += c.total; dp.liq += c.totalLiq;
    });
    ctx += '\n=== COMPARACI\u00D3N PROPIETARIOS (detalle por piso) ===\n';
    Object.keys(cmpOwners).sort().forEach(function(ow) {
      var pisos = cmpOwners[ow].pisos;
      var owTot = {n:0, noch:0, imp:0, liq:0};
      ctx += '\n' + ow + ':\n';
      ctx += 'Piso|Res|Noch|ADR|Imp|Liq|Margen%\n';
      Object.keys(pisos).sort().forEach(function(p) {
        var d = pisos[p];
        owTot.n += d.n; owTot.noch += d.noch; owTot.imp += d.imp; owTot.liq += d.liq;
        var adr = d.noch > 0 ? d.imp / d.noch : 0;
        var margin = d.imp > 0 ? d.liq / d.imp * 100 : 0;
        ctx += p + '|' + d.n + '|' + d.noch + '|' + f(adr) + '|' + f(d.imp) + '|' + f(d.liq) + '|' + margin.toFixed(1) + '%\n';
      });
      var owAdr = owTot.noch > 0 ? owTot.imp / owTot.noch : 0;
      var owMargin = owTot.imp > 0 ? owTot.liq / owTot.imp * 100 : 0;
      ctx += 'TOTAL|' + owTot.n + '|' + owTot.noch + '|' + f(owAdr) + '|' + f(owTot.imp) + '|' + f(owTot.liq) + '|' + owMargin.toFixed(1) + '%\n';
    });
  }

  // PREDICCI\u00D3N DE OCUPACI\u00D3N (proyecci\u00F3n simple basada en hist\u00F3rico)
  if (needPredict && Object.keys(byMes).length >= 12) {
    ctx += '\n=== PREDICCI\u00D3N / PROYECCI\u00D3N ===\n';
    var monthAvg = {};
    var monthYears = {};
    Object.keys(byMes).forEach(function(m) {
      var parts = m.split('/');
      var mm = parseInt(parts[0]);
      var yr = parts[1];
      if (!monthAvg[mm]) { monthAvg[mm] = {n:0, noch:0, imp:0, liq:0, count:0}; monthYears[mm] = []; }
      monthAvg[mm].n += byMes[m].n;
      monthAvg[mm].noch += byMes[m].noch;
      monthAvg[mm].imp += byMes[m].imp;
      monthAvg[mm].liq += byMes[m].liq;
      monthAvg[mm].count++;
      monthYears[mm].push(yr);
    });
    var mNames = ['','Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    ctx += 'Mes|Prom.Reservas|Prom.Noches|Prom.Importe|Prom.Liquidaci\u00F3n|A\u00F1os\n';
    for (var mm = 1; mm <= 12; mm++) {
      if (monthAvg[mm] && monthAvg[mm].count > 0) {
        var d = monthAvg[mm], c2 = d.count;
        ctx += mNames[mm] + '|' + (d.n/c2).toFixed(0) + '|' + (d.noch/c2).toFixed(0) + '|' + f(d.imp/c2) + '|' + f(d.liq/c2) + '|' + c2 + ' a\u00F1os\n';
      } else {
        ctx += mNames[mm] + '|sin datos\n';
      }
    }
    var yrKeys = Object.keys(byYear).sort();
    if (yrKeys.length >= 2) {
      var lastY = byYear[yrKeys[yrKeys.length-1]], prevY = byYear[yrKeys[yrKeys.length-2]];
      var growthRes = prevY.n > 0 ? ((lastY.n - prevY.n) / prevY.n * 100) : 0;
      var growthImp = prevY.imp > 0 ? ((lastY.imp - prevY.imp) / prevY.imp * 100) : 0;
      ctx += 'Tendencia ' + yrKeys[yrKeys.length-2] + '\u2192' + yrKeys[yrKeys.length-1] + ': reservas ' + (growthRes>0?'+':'') + growthRes.toFixed(1) + '%, importe ' + (growthImp>0?'+':'') + growthImp.toFixed(1) + '%\n';
      ctx += 'NOTA: La proyecci\u00F3n es una media hist\u00F3rica. Usa la tendencia para ajustar al alza/baja.\n';
    }
  }

  // PHASE 5: SEGMENTACI\u00D3N DE CLIENTES
  if (needSegment && G.n > 0) {
    ctx += '\n=== SEGMENTACI\u00D3N POR TIPO ESTANCIA ===\n';
    ctx += 'Tipo|Reservas|%Total|Noches|Importe|ADR|Estancia.Media\n';
    var segs = [
      {name:'Escapada (\u22642 noch)', n:bySegment.corta, noch:bySegment.cortaN, imp:bySegment.cortaI},
      {name:'Vacaciones (3-7 noch)', n:bySegment.media, noch:bySegment.mediaN, imp:bySegment.mediaI},
      {name:'Larga estancia (>7 noch)', n:bySegment.larga, noch:bySegment.largaN, imp:bySegment.largaI}
    ];
    segs.forEach(function(s) {
      var pct = (s.n / G.n * 100).toFixed(1);
      var adr = s.noch > 0 ? f(s.imp / s.noch) : '-';
      var avg = s.n > 0 ? (s.noch / s.n).toFixed(1) : '-';
      ctx += s.name + '|' + s.n + '|' + pct + '%|' + s.noch + '|' + f(s.imp) + '|' + adr + '|' + avg + ' noches\n';
    });
    // Segmentation by platform
    if (needPlat) {
      ctx += '\nSegmentaci\u00F3n por plataforma:\n';
      var segByPlat = {};
      allReservas.forEach(function(r2) {
        var p2 = r2.plataforma || 'Desconocida', n2 = r2._nights || 0;
        if (!segByPlat[p2]) segByPlat[p2] = {corta:0, media:0, larga:0};
        if (n2 <= 2) segByPlat[p2].corta++;
        else if (n2 <= 7) segByPlat[p2].media++;
        else segByPlat[p2].larga++;
      });
      ctx += 'Plataforma|Escapadas|Vacaciones|Larga\n';
      Object.keys(segByPlat).sort().forEach(function(p2) {
        var s2 = segByPlat[p2];
        ctx += p2 + '|' + s2.corta + '|' + s2.media + '|' + s2.larga + '\n';
      });
    }
  }

  // PHASE 5: HEATMAP OCUPACI\u00D3N (aloj \u00D7 mes)
  if (needHeatmap && Object.keys(byAlojMes).length > 0) {
    ctx += '\n=== HEATMAP OCUPACI\u00D3N (noches por aloj\u00D7mes) ===\n';
    var hmAlojs = new Set(), hmMonths = new Set();
    Object.keys(byAlojMes).forEach(function(k) {
      var p = k.split('|'); hmAlojs.add(p[0]); hmMonths.add(p[1]);
    });
    var hmMList = Array.from(hmMonths).sort();
    var hmMNames = {'\u002701':'Ene','\u002702':'Feb','\u002703':'Mar','\u002704':'Abr','\u002705':'May','\u002706':'Jun','\u002707':'Jul','\u002708':'Ago','\u002709':'Sep','10':'Oct','11':'Nov','12':'Dic'};
    ctx += 'Alojamiento|' + hmMList.map(function(m){ return hmMNames[m]||m; }).join('|') + '|Total\n';
    // Find global max for sparkline
    var hmMax = 0;
    Object.values(byAlojMes).forEach(function(v){ if(v.noch > hmMax) hmMax = v.noch; });
    var spark = ['\u2581','\u2582','\u2583','\u2584','\u2585','\u2586','\u2587','\u2588'];
    Array.from(hmAlojs).sort().slice(0,30).forEach(function(a) {
      var row = a.substring(0,20), rowTotal = 0;
      hmMList.forEach(function(m) {
        var d = byAlojMes[a + '|' + m];
        var noch = d ? d.noch : 0;
        rowTotal += noch;
        var si = hmMax > 0 ? Math.min(7, Math.floor(noch / hmMax * 7)) : 0;
        row += '|' + (noch > 0 ? spark[si] + noch : '\u00B7');
      });
      row += '|' + rowTotal;
      ctx += row + '\n';
    });
  }

  // PHASE 5: LEAD TIME (antelaci\u00F3n de reserva)
  if (needLeadtime && leadTimes.length > 0) {
    ctx += '\n=== LEAD TIME (antelaci\u00F3n de reserva en d\u00EDas) ===\n';
    var ltTotal = 0, ltCount = leadTimes.length;
    leadTimes.forEach(function(l){ ltTotal += l.days; });
    var ltAvg = ltTotal / ltCount;
    var ltSorted = leadTimes.map(function(l){ return l.days; }).sort(function(a,b){ return a-b; });
    var ltMedian = ltSorted[Math.floor(ltCount / 2)];
    ctx += 'Media: ' + ltAvg.toFixed(0) + ' d\u00EDas | Mediana: ' + ltMedian + ' d\u00EDas | Rango: ' + ltSorted[0] + '-' + ltSorted[ltCount-1] + ' d\u00EDas\n';
    // Lead time by platform
    var ltByPlat = {};
    leadTimes.forEach(function(l) {
      if (!ltByPlat[l.plat]) ltByPlat[l.plat] = {sum:0, n:0, vals:[]};
      ltByPlat[l.plat].sum += l.days; ltByPlat[l.plat].n++; ltByPlat[l.plat].vals.push(l.days);
    });
    ctx += '\nPor plataforma:\nPlataforma|Media.D\u00EDas|Mediana|Reservas\n';
    Object.keys(ltByPlat).sort().forEach(function(p) {
      var d = ltByPlat[p];
      d.vals.sort(function(a,b){return a-b;});
      ctx += p + '|' + (d.sum/d.n).toFixed(0) + '|' + d.vals[Math.floor(d.n/2)] + '|' + d.n + '\n';
    });
    // Lead time buckets
    var ltBuckets = {'0-1d':0, '2-7d':0, '8-30d':0, '31-90d':0, '>90d':0};
    leadTimes.forEach(function(l) {
      if (l.days <= 1) ltBuckets['0-1d']++;
      else if (l.days <= 7) ltBuckets['2-7d']++;
      else if (l.days <= 30) ltBuckets['8-30d']++;
      else if (l.days <= 90) ltBuckets['31-90d']++;
      else ltBuckets['>90d']++;
    });
    ctx += '\nDistribuci\u00F3n:\n';
    Object.keys(ltBuckets).forEach(function(b) {
      var pct = (ltBuckets[b] / ltCount * 100).toFixed(1);
      ctx += b + ': ' + ltBuckets[b] + ' (' + pct + '%)\n';
    });
  }

  // PHASE 5: DUPLICADOS / ANOMAL\u00CDAS
  if (needDup && dupCandidates.length > 0) {
    ctx += '\n=== POSIBLES DUPLICADOS / ANOMAL\u00CDAS ===\n';
    // Find exact duplicates (same client+aloj+dates)
    var dupMap = {};
    var dups = [];
    dupCandidates.forEach(function(d) {
      var key = d.cliente + '|' + d.aloj + '|' + d.entrada + '|' + d.salida;
      if (key.length < 10) return; // skip empty
      if (!dupMap[key]) { dupMap[key] = [d]; } else { dupMap[key].push(d); }
    });
    Object.keys(dupMap).forEach(function(k) {
      if (dupMap[k].length > 1) dups.push({key:k, count:dupMap[k].length, items:dupMap[k]});
    });
    if (dups.length > 0) {
      ctx += 'Posibles duplicados exactos: ' + dups.length + ' grupos\n';
      ctx += 'Cliente|Aloj|Entrada|Salida|Veces\n';
      dups.slice(0,20).forEach(function(d) {
        var p = d.key.split('|');
        ctx += p[0].substring(0,20) + '|' + p[1].substring(0,18) + '|' + p[2] + '|' + p[3] + '|' + d.count + '\n';
      });
    } else {
      ctx += 'No se encontraron duplicados exactos.\n';
    }
    // Suspicious imports (very high or very low vs property avg)
    var suspHigh = [], suspLow = [];
    if (Object.keys(byAloj).length > 0) {
      allReservas.forEach(function(r2) {
        var a2 = r2.alojamiento || 'Sin'; var da2 = byAloj[a2];
        if (!da2 || da2.noch < 5 || !r2._nights || r2._nights < 1) return;
        var avgADR = da2.imp / da2.noch;
        var c2 = getLiq(r2);
        var thisADR = c2.total / r2._nights;
        if (thisADR > avgADR * 3 && c2.total > 200) suspHigh.push({id:r2.id, aloj:a2, adr:thisADR, avg:avgADR, imp:c2.total});
        if (thisADR < avgADR * 0.25 && c2.total > 10) suspLow.push({id:r2.id, aloj:a2, adr:thisADR, avg:avgADR, imp:c2.total});
      });
    }
    if (suspHigh.length > 0) {
      ctx += '\nReservas con importe anormalmente ALTO (>3x ADR medio del piso):\n';
      ctx += 'ID|Aloj|ADR.Reserva|ADR.Medio|Importe\n';
      suspHigh.slice(0,10).forEach(function(s) {
        ctx += s.id + '|' + s.aloj.substring(0,18) + '|' + f(s.adr) + '|' + f(s.avg) + '|' + f(s.imp) + '\n';
      });
    }
    if (suspLow.length > 0) {
      ctx += '\nReservas con importe anormalmente BAJO (<0.25x ADR medio):\n';
      ctx += 'ID|Aloj|ADR.Reserva|ADR.Medio|Importe\n';
      suspLow.slice(0,10).forEach(function(s) {
        ctx += s.id + '|' + s.aloj.substring(0,18) + '|' + f(s.adr) + '|' + f(s.avg) + '|' + f(s.imp) + '\n';
      });
    }
    if (dups.length === 0 && suspHigh.length === 0 && suspLow.length === 0) {
      ctx += 'No se detectaron anomal\u00EDas significativas.\n';
    }
  }

  // PHASE 5: WHAT-IF SIMULATOR DATA
  if (needWhatif) {
    ctx += '\n=== DATOS PARA SIMULACI\u00D3N WHAT-IF ===\n';
    ctx += 'Estructura actual de costes:\n';
    var totCom = G.cPlat + G.cGTC + G.cPas;
    ctx += 'Comisi\u00F3n total: ' + f(totCom) + ' (' + (G.imp > 0 ? (totCom/G.imp*100).toFixed(1) : '0') + '% del importe)\n';
    ctx += '  Canal: ' + f(G.cPlat) + ' (' + (G.imp>0?(G.cPlat/G.imp*100).toFixed(1):'0') + '%), GTC: ' + f(G.cGTC) + ', Pasarela: ' + f(G.cPas) + '\n';
    ctx += 'Limpieza: ' + f(G.limp) + ', Amenities: ' + f(G.amen) + '\n';
    ctx += 'IRPF retenido: ' + f(G.irpf) + '\n';
    ctx += 'Liquidaci\u00F3n actual: ' + f(G.liq) + ' (' + (G.imp>0?(G.liq/G.imp*100).toFixed(1):'0') + '% del importe)\n\n';
    // By platform for what-if simulations
    ctx += 'Comisiones por plataforma (para simular cambios):\n';
    ctx += 'Plataforma|Reservas|Importe|Com.Canal|Com.Pasarela|%Comisi\u00F3n\n';
    Object.keys(byPlat).sort().forEach(function(p) {
      var dp = byPlat[p];
      var pctCom = dp.imp > 0 ? ((dp.cPlat+dp.cPas)/dp.imp*100).toFixed(1) : '0';
      ctx += p + '|' + dp.n + '|' + f(dp.imp) + '|' + f(dp.cPlat) + '|' + f(dp.cPas) + '|' + pctCom + '%\n';
    });
    ctx += '\nADR global: ' + (G.noch>0 ? f(G.imp/G.noch) : '-') + '\n';
    ctx += 'INSTRUCCIONES WHAT-IF: Cuando el usuario pida simular un escenario, calcula el impacto usando estos datos base. Muestra antes/despu\u00E9s con diferencia.\n';
  }

  // PHASE 5: BRIEFING R\u00C1PIDO
  if (needBriefing) {
    // Build sparklines for monthly trend
    var mSorted = Object.keys(byMes).sort();
    if (mSorted.length > 0) {
      var spark = ['\u2581','\u2582','\u2583','\u2584','\u2585','\u2586','\u2587','\u2588'];
      var maxImp = 0;
      mSorted.forEach(function(m){ if (byMes[m].imp > maxImp) maxImp = byMes[m].imp; });
      var sparkLine = '';
      mSorted.forEach(function(m) {
        var si = maxImp > 0 ? Math.min(7, Math.floor(byMes[m].imp / maxImp * 7)) : 0;
        sparkLine += spark[si];
      });
      ctx += '\n=== BRIEFING EJECUTIVO ===\n';
      ctx += 'Tendencia ingresos: ' + sparkLine + ' (' + mSorted[0] + ' a ' + mSorted[mSorted.length-1] + ')\n';
      // Best and worst month
      var bestM = mSorted[0], worstM = mSorted[0];
      mSorted.forEach(function(m) {
        if (byMes[m].imp > byMes[bestM].imp) bestM = m;
        if (byMes[m].imp < byMes[worstM].imp) worstM = m;
      });
      ctx += 'Mejor mes: ' + bestM + ' (' + f(byMes[bestM].imp) + '), Peor: ' + worstM + ' (' + f(byMes[worstM].imp) + ')\n';
      ctx += 'INSTRUCCIONES: Resume en m\u00E1ximo 5 frases los datos m\u00E1s importantes. S\u00E9 directo, como un briefing matutino.\n';
    }
  }

  // DETALLE (solo si se piden datos espec\u00EDficos o hay pocas filtradas)
  if (needDetail || needVal) {
    var filtered = (typeof getFilteredSorted === 'function') ? getFilteredSorted() : allReservas;
    var maxDetail = Math.min(CONFIG.MAX_AI_DETAIL_ROWS, filtered.length);
    if (maxDetail > 0) {
      ctx += '\n=== DETALLE (' + maxDetail + ' de ' + filtered.length + ' filtradas, ' + total + ' totales) ===\n';
      ctx += 'ID|Cliente|Aloj|Plat|Entrada|Salida|Noch|ImpIVA|ComCanal|ComGTC|Limp|Liq|Estado\n';
      for (var i = 0; i < maxDetail; i++) {
        var r = filtered[i], c = getLiq(r);
        ctx += [r.id||'-',(r.cliente||'-').substring(0,20),(r.alojamiento||'-').substring(0,18),
          (r.plataforma||'-').substring(0,12),r._fmtEntrada||'-',r._fmtSalida||'-',r._nights||0,
          f(c.total),f(c.comPlat),f(c.comGTC),f(c.limp),f(c.totalLiq),validated.has(r.idx)?'V':'P'
        ].join('|') + '\n';
      }
      if (filtered.length > maxDetail) ctx += '...(' + (filtered.length - maxDetail) + ' m\u00E1s, totales en res\u00FAmenes)\n';
    }
  }

  // Info de contexto selectivo (para debug)
  ctx += '\n[Secciones incluidas: ' + Array.from(cats).join(', ') + ']\n';

  // Phase 4: Save to cache
  _aiContextCache = { key: cacheKey, ctx: ctx, ts: Date.now() };
  return ctx;
}

/**
 * @description Compacta el historial de chat para mantener tokens bajos.
 * Cuando hay m\u00E1s de 10 mensajes, resume los m\u00E1s antiguos en una l\u00EDnea.
 * Mantiene los \u00FAltimos 6 mensajes intactos para continuidad.
 */
function _compactHistory() {
  if (_aiHistory.length <= 10) return;

  var keepLast = 6; // mantener \u00FAltimos 3 turnos (6 mensajes)
  var old = _aiHistory.slice(0, -keepLast);
  var recent = _aiHistory.slice(-keepLast);

  // Extract user questions from old messages
  var topics = [];
  old.forEach(function(m) {
    if (m.role === 'user' && m.content.length < 200) {
      topics.push(m.content);
    }
  });

  var summary = 'Resumen de la conversaci\u00F3n previa: el usuario pregunt\u00F3 sobre: ' + topics.join('; ');
  if (summary.length > 400) summary = summary.substring(0, 400) + '...';

  _aiHistory = [
    { role: 'user', content: summary },
    { role: 'assistant', content: 'Entendido, tengo el contexto de la conversaci\u00F3n anterior.' }
  ].concat(recent);

  console.log('[AI] Compacted history: ' + old.length + ' msgs \u2192 summary + ' + recent.length + ' recent');
}

/**
 * @description Genera y descarga un archivo Excel CSV desde el chat.
 * Soporta varios tipos de export predefinidos.
 * @param {string} type - Tipo de export solicitado
 */
function _aiExportExcel(type) {
  if (!allReservas || allReservas.length === 0) return;
  var f = function(v) { return v.toFixed(2); };
  var rows = [];
  var filename = 'export';

  if (type === 'adr') {
    filename = 'ranking-adr';
    rows.push([t('csv.property'),t('csv.reservations'),t('csv.nights'),t('csv.adr'),t('csv.totalAmount'),t('csv.settlement'),t('csv.margin')]);
    var byA = {};
    allReservas.forEach(function(r) {
      var a = r.alojamiento||'Sin'; var c = getLiq(r); var n = r._nights||0;
      if (!byA[a]) byA[a] = {n:0, noch:0, imp:0, liq:0};
      byA[a].n++; byA[a].noch += n; byA[a].imp += c.total; byA[a].liq += c.totalLiq;
    });
    Object.keys(byA).filter(function(a){ return byA[a].noch > 0; })
      .sort(function(a,b){ return (byA[b].imp/byA[b].noch)-(byA[a].imp/byA[a].noch); })
      .forEach(function(a) {
        var d = byA[a]; var adr = d.imp/d.noch; var mg = d.imp>0 ? d.liq/d.imp*100 : 0;
        rows.push([a, d.n, d.noch, f(adr), f(d.imp), f(d.liq), mg.toFixed(1)+'%']);
      });
  } else if (type === 'owners') {
    filename = 'propietarios';
    rows.push([t('csv.owner'),t('csv.units'),t('csv.reservations'),t('csv.nights'),t('csv.amount'),t('csv.settlement'),'ADR',t('csv.margin')]);
    var byO = {};
    allReservas.forEach(function(r) {
      var ow = getPropietario(r.alojamiento); if (!ow || ow === t('consol.missingOwner')) return;
      if (!byO[ow]) byO[ow] = {pisos:{}, n:0, noch:0, imp:0, liq:0};
      byO[ow].pisos[r.alojamiento] = true; byO[ow].n++; byO[ow].noch += r._nights||0;
      var c = getLiq(r); byO[ow].imp += c.total; byO[ow].liq += c.totalLiq;
    });
    Object.keys(byO).sort().forEach(function(ow) {
      var d = byO[ow]; var adr = d.noch>0 ? d.imp/d.noch : 0; var mg = d.imp>0 ? d.liq/d.imp*100 : 0;
      rows.push([ow, Object.keys(d.pisos).sort().join('; '), d.n, d.noch, f(d.imp), f(d.liq), f(adr), mg.toFixed(1)+'%']);
    });
  } else if (type === 'monthly') {
    filename = 'mensual';
    rows.push([t('csv.month'),t('csv.reservations'),t('csv.nights'),t('csv.amount'),t('csv.settlement'),'ADR']);
    var byM = {};
    allReservas.forEach(function(r) {
      var fE = r._dEntrada; if (!fE) return;
      var m = (fE.getMonth()+1).toString().padStart(2,'0') + '/' + fE.getFullYear();
      if (!byM[m]) byM[m] = {n:0, noch:0, imp:0, liq:0};
      byM[m].n++; byM[m].noch += r._nights||0; var c = getLiq(r); byM[m].imp += c.total; byM[m].liq += c.totalLiq;
    });
    Object.keys(byM).sort().forEach(function(m) {
      var d = byM[m]; var adr = d.noch>0 ? d.imp/d.noch : 0;
      rows.push([m, d.n, d.noch, f(d.imp), f(d.liq), f(adr)]);
    });
  } else if (type === 'platforms') {
    filename = 'plataformas';
    rows.push([t('csv.platform'),t('csv.reservations'),t('csv.amount'),t('csv.channelCom'),t('csv.gatewayCom'),t('csv.settlement'),t('csv.effectivePct')]);
    var byP = {};
    allReservas.forEach(function(r) {
      var p = r.plataforma||'Desconocida'; var c = getLiq(r);
      if (!byP[p]) byP[p] = {n:0, imp:0, cPlat:0, cPas:0, liq:0};
      byP[p].n++; byP[p].imp += c.total; byP[p].cPlat += c.comPlat; byP[p].cPas += c.comPas; byP[p].liq += c.totalLiq;
    });
    Object.keys(byP).sort().forEach(function(p) {
      var d = byP[p]; var ce = d.imp>0 ? (d.cPlat+d.cPas)/d.imp*100 : 0;
      rows.push([p, d.n, f(d.imp), f(d.cPlat), f(d.cPas), f(d.liq), ce.toFixed(1)+'%']);
    });
  } else if (type === 'all') {
    filename = 'reservas-completo';
    rows.push(['ID','Localizador','Cliente','Alojamiento','Plataforma','Entrada','Salida','Noches','Importe','ComCanal','ComGTC','Limpieza','Liquidaci\u00F3n','Estado']);
    allReservas.forEach(function(r) {
      var c = getLiq(r);
      rows.push([r.id||'', r.localizador||'', r.cliente||'', r.alojamiento||'', r.plataforma||'',
        r._fmtEntrada||'', r._fmtSalida||'', r._nights||0,
        f(c.total), f(c.comPlat), f(c.comGTC), f(c.limp), f(c.totalLiq),
        validated.has(r.idx)?t('csv.validated'):t('csv.pending')]);
    });
  } else {
    return; // unknown type
  }

  // Generate CSV with BOM for Excel UTF-8 compatibility
  var csv = '\uFEFF' + rows.map(function(row) {
    return row.map(function(cell) {
      var s = String(cell);
      if (s.indexOf(',') >= 0 || s.indexOf('"') >= 0 || s.indexOf(';') >= 0 || s.indexOf('\n') >= 0) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }).join(';'); // semicolon for Spanish Excel
  }).join('\r\n');

  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = filename + '-' + new Date().toISOString().slice(0,10) + '.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  console.log('[AI] Export CSV:', filename, rows.length, 'rows');
}

function _addAIMsg(role, text) {
  let box = document.getElementById('ai-messages');
  let div = document.createElement('div');
  div.className = 'ai-msg ' + role;
  if (role === 'assistant') {
    let html = text
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\n/g, '<br>');
    div.innerHTML = html;
  } else {
    div.textContent = text;
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

function _showTyping() {
  let box = document.getElementById('ai-messages');
  let div = document.createElement('div');
  div.className = 'ai-msg assistant'; div.id = 'ai-typing';
  div.innerHTML = '<div class="ai-typing"><span></span><span></span><span></span></div>';
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
function _removeTyping() { const el = document.getElementById('ai-typing'); if(el) el.remove(); }

/**
 * @description Extrae entidades (pisos, propietarios, plataformas) del texto.
 * Phase 5: Entity memory for multi-turn conversations.
 */
function _extractEntities(text) {
  var entities = {pisos:[], propietarios:[], plataformas:[]};
  if (!allReservas || allReservas.length === 0) return entities;
  var tLow = text.toLowerCase();
  // Match known pisos
  var knownPisos = new Set();
  allReservas.forEach(function(r){ if(r.alojamiento) knownPisos.add(r.alojamiento); });
  knownPisos.forEach(function(p) {
    if (tLow.indexOf(p.toLowerCase()) >= 0) entities.pisos.push(p);
  });
  // Match known propietarios
  if (_propietariosMap) {
    var owners = new Set();
    Object.values(_propietariosMap).forEach(function(v){ if(v) owners.add(v); });
    owners.forEach(function(o) {
      if (tLow.indexOf(o.toLowerCase()) >= 0) entities.propietarios.push(o);
    });
  }
  // Match platforms
  ['Booking.com','Airbnb','VRBO','Stripe','Web directa'].forEach(function(p) {
    if (tLow.indexOf(p.toLowerCase()) >= 0) entities.plataformas.push(p);
  });
  return entities;
}

/**
 * @description Genera sugerencias de follow-up basadas en categor\u00EDas.
 * Phase 5: Contextual follow-up suggestions.
 */
function _getFollowUpSuggestions(cats) {
  var suggestions = [];
  if (cats.has('KPI') || cats.has('SUMMARY')) {
    suggestions.push({q:t('fu.worstAdrQ'), label:t('fu.worstAdr')});
    suggestions.push({q:t('fu.exportQ'), label:t('fu.export')});
    suggestions.push({q:t('fu.ownersQ'), label:t('fu.owners')});
  }
  if (cats.has('FINANCIAL')) {
    suggestions.push({q:t('fu.simMinusQ'), label:t('fu.simMinus')});
    suggestions.push({q:t('fu.rankMarginQ'), label:t('fu.rankMargin')});
  }
  if (cats.has('PLATFORM')) {
    suggestions.push({q:t('fu.leadtimeQ'), label:t('fu.leadtime')});
    suggestions.push({q:t('fu.segmentsQ'), label:t('fu.segments')});
  }
  if (cats.has('PROPERTY') || cats.has('CMP_OWNER')) {
    suggestions.push({q:t('fu.heatmapQ'), label:t('fu.heatmap')});
    suggestions.push({q:t('fu.duplicatesQ'), label:t('fu.duplicates')});
  }
  if (cats.has('PREDICT')) {
    suggestions.push({q:t('fu.seasonQ'), label:t('fu.season')});
    suggestions.push({q:t('fu.simPlusQ'), label:t('fu.simPlus')});
  }
  if (cats.has('YOY')) {
    suggestions.push({q:t('fu.predictQ'), label:t('fu.predict')});
    suggestions.push({q:t('fu.topGrowthQ'), label:t('fu.topGrowth')});
  }
  if (cats.has('SEASON')) {
    suggestions.push({q:t('fu.segHighQ'), label:t('fu.segHigh')});
  }
  if (cats.has('SEGMENT')) {
    suggestions.push({q:t('fu.ltByStayQ'), label:t('fu.ltByStay')});
  }
  if (cats.has('LEADTIME')) {
    suggestions.push({q:t('fu.byPropQ'), label:t('fu.byProp')});
  }
  if (cats.has('DUPCHECK')) {
    suggestions.push({q:t('fu.kpisQ'), label:t('fu.kpis')});
  }
  if (cats.has('WHATIF')) {
    suggestions.push({q:t('fu.realCommQ'), label:t('fu.realComm')});
  }
  if (cats.has('HEATMAP')) {
    suggestions.push({q:t('fu.predictQ'), label:t('fu.predict')});
  }
  if (cats.has('BRIEFING')) {
    suggestions.push({q:t('fu.kpiDetailQ'), label:t('fu.kpiDetail')});
    suggestions.push({q:t('fu.anomaliesQ'), label:t('fu.anomalies')});
  }
  // Deduplicate and limit to 3
  var seen = new Set();
  return suggestions.filter(function(s) {
    if (seen.has(s.label)) return false;
    seen.add(s.label); return true;
  }).slice(0, 3);
}

async function sendAIMessage() {
  if (_aiProcessing) return;
  let input = document.getElementById('ai-input');
  let text = input.value.trim();
  if (!text) return;

  if (!allReservas || allReservas.length === 0) {
    _addAIMsg('error', t('ai.loadFirst'));
    return;
  }

  let apiKey = _getAIKey();
  if (!apiKey) return;

  _addAIMsg('user', text);
  input.value = ''; input.style.height = 'auto';
  _aiHistory.push({role:'user', content:text});

  // Phase 5: Extract and track entities
  var newEntities = _extractEntities(text);
  if (newEntities.pisos.length > 0) _aiEntityMemory.pisos = newEntities.pisos;
  if (newEntities.propietarios.length > 0) _aiEntityMemory.propietarios = newEntities.propietarios;
  if (newEntities.plataformas.length > 0) _aiEntityMemory.plataformas = newEntities.plataformas;

  // Phase 2: Compact history before sending
  _compactHistory();

  _aiProcessing = true;
  document.getElementById('ai-send').disabled = true;
  _showTyping();

  try {
    // Phase 2: Classify query and build selective context
    let cats = _classifyQuery(text);
    let context = buildAIContext(cats);
    console.log('[AI] Query categories:', Array.from(cats).join(', '), '| Context length:', context.length);

    // Phase 5: Entity memory context
    var entityCtx = '';
    if (_aiEntityMemory.pisos.length > 0 || _aiEntityMemory.propietarios.length > 0 || _aiEntityMemory.plataformas.length > 0) {
      entityCtx = '\nCONTEXTO DE CONVERSACI\u00D3N (entidades mencionadas previamente):\n';
      if (_aiEntityMemory.pisos.length > 0) entityCtx += 'Pisos referenciados: ' + _aiEntityMemory.pisos.join(', ') + '\n';
      if (_aiEntityMemory.propietarios.length > 0) entityCtx += 'Propietarios referenciados: ' + _aiEntityMemory.propietarios.join(', ') + '\n';
      if (_aiEntityMemory.plataformas.length > 0) entityCtx += 'Plataformas referenciadas: ' + _aiEntityMemory.plataformas.join(', ') + '\n';
      entityCtx += 'Si el usuario hace preguntas ambiguas (ej: "y sus comisiones?"), ref\u00E9rete a estas entidades.\n';
    }

    let sysPrompt = 'Eres el "Asistente Hist\u00F3rico Reservas" de Liquidaciones GTC (Green Tropical Coast / Homity Holidays).\n\n' +
      'REGLAS:\n' +
      '1. SOLO responde con los datos proporcionados. NUNCA inventes cifras.\n' +
      '2. Sin informaci\u00F3n: "No tengo esa informaci\u00F3n en los datos cargados."\n' +
      '3. NUNCA des consejos financieros, legales ni fiscales.\n' +
      '4. Responde en ' + ({es:'espa\u00F1ol',en:'English',de:'Deutsch'}[_currentLang]||'espa\u00F1ol') + '. Conciso pero completo.\n' +
      '5. Cifras con 2 decimales y \u20AC. Indica siempre si son con/sin IVA.\n' +
      '6. Res\u00FAmenes = TODAS las reservas. Detalle = filtradas (max 50).\n' +
      '7. Si falta info, sugiere filtrar la tabla o reformular.\n' +
      '8. Los datos se seleccionan seg\u00FAn tu pregunta. Si necesitas una secci\u00F3n que no ves, p\u00EDdela.\n\n' +
      'CAPACIDADES:\n' +
      '- KPIs: ADR, estancia media, comisi\u00F3n efectiva %, margen propietario %, rankings top/bottom\n' +
      '- Comparativa interanual (YoY) con \u0394% y top movers\n' +
      '- Estacionalidad cruzada: plataforma \u00D7 trimestre con pico/valle\n' +
      '- Comparaci\u00F3n entre propietarios: m\u00E9tricas por piso de cada uno\n' +
      '- Predicci\u00F3n: media hist\u00F3rica mensual con tendencia interanual\n' +
      '- Export: CSV/Excel con botones de descarga autom\u00E1ticos\n' +
      '- Duplicados: detecta reservas duplicadas y anomal\u00EDas de importe\n' +
      '- Segmentaci\u00F3n: escapada (\u22642 noches), vacaciones (3-7), larga estancia (>7)\n' +
      '- Heatmap: mapa de calor piso\u00D7mes con sparklines de ocupaci\u00F3n\n' +
      '- Lead time: antelaci\u00F3n de reserva por plataforma y distribuci\u00F3n\n' +
      '- What-if: simula escenarios (cambiar ADR, comisiones, mover plataforma)\n' +
      '- Briefing: resumen r\u00E1pido ejecutivo en 3-5 frases directas\n' +
      '- Usa sparklines Unicode (\u2581\u2582\u2583\u2584\u2585\u2586\u2587\u2588) para mostrar tendencias en l\u00EDnea cuando sea \u00FAtil\n\n' +
      entityCtx +
      'DATOS:\n' + context;

    let messages = _aiHistory.slice(-CONFIG.MAX_AI_HISTORY);

    // Retry logic for rate limits (429)
    let maxRetries = 2;
    let resp = null;
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: CONFIG.AI_MODEL,
          max_tokens: CONFIG.AI_MAX_TOKENS,
          system: sysPrompt,
          messages: messages
        })
      });

      if (resp.status === 429 && attempt < maxRetries) {
        let waitSec = (attempt + 1) * 30;
        let retryAfter = resp.headers.get('retry-after');
        if (retryAfter) waitSec = Math.min(parseInt(retryAfter) || waitSec, 90);
        _removeTyping();
        _addAIMsg('info', t('ai.rateLimit').replace('%s', waitSec));
        await new Promise(function(resolve) { setTimeout(resolve, waitSec * 1000); });
        const infoMsgs = document.querySelectorAll('.ai-msg.info');
        infoMsgs.forEach(function(el) { el.remove(); });
        _showTyping();
        continue;
      }
      break;
    }

    _removeTyping();

    if (!resp.ok) {
      let errData = await resp.json().catch(function(){ return {}; });
      if (resp.status === 401) {
        SafeStorage.remove('ai-api-key');
        _addAIMsg('error', t('ai.invalidKey'));
      } else {
        _addAIMsg('error', t('ai.errorPrefix') + (errData.error && errData.error.message ? errData.error.message : resp.statusText));
      }
      _aiHistory.pop();
    } else {
      let data = await resp.json();
      let reply = data.content.map(function(b){ return b.text||''; }).join('');
      _aiHistory.push({role:'assistant', content:reply});
      let msgDiv = _addAIMsg('assistant', reply);

      // Phase 4: Auto-add export buttons for EXPORT queries
      if (cats.has('EXPORT') && msgDiv) {
        var exportBar = document.createElement('div');
        exportBar.style.cssText = 'margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;';
        var exports = [
          {type:'adr', label:'\uD83D\uDCC9 Ranking ADR'},
          {type:'owners', label:'\uD83D\uDC64 Propietarios'},
          {type:'monthly', label:'\uD83D\uDCC5 Mensual'},
          {type:'platforms', label:'\uD83C\uDFE2 Plataformas'},
          {type:'all', label:'\uD83D\uDCCB Todo (detalle)'},
        ];
        exports.forEach(function(ex) {
          var btn = document.createElement('a');
          btn.className = 'ai-export-link';
          btn.textContent = ex.label;
          btn.onclick = function(e) { e.preventDefault(); _aiExportExcel(ex.type); };
          exportBar.appendChild(btn);
        });
        msgDiv.appendChild(exportBar);
      }

      // Phase 5: Follow-up suggestions
      if (msgDiv) {
        var followUps = _getFollowUpSuggestions(cats);
        if (followUps.length > 0) {
          var fuDiv = document.createElement('div');
          fuDiv.className = 'ai-followups';
          followUps.forEach(function(fu) {
            var btn = document.createElement('button');
            btn.className = 'ai-followup-btn';
            btn.textContent = fu.label;
            btn.onclick = function() {
              document.getElementById('ai-input').value = fu.q;
              sendAIMessage();
            };
            fuDiv.appendChild(btn);
          });
          document.getElementById('ai-messages').appendChild(fuDiv);
          document.getElementById('ai-messages').scrollTop = document.getElementById('ai-messages').scrollHeight;
        }
      }
    }
  } catch(e) {
    _removeTyping();
    _addAIMsg('error', 'Error de conexi\u00F3n: ' + e.message);
    _aiHistory.pop();
  }

  _aiProcessing = false;
  document.getElementById('ai-send').disabled = false;
  document.getElementById('ai-input').focus();
}

// Auto-resize AI textarea
(function(){
  let ta = document.getElementById('ai-input');
  if(ta) ta.addEventListener('input', function(){ this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,100)+'px'; });
})();
// === END AI ASSISTANT ===
</script>
<script src="email-module.js"></script>
<script>
// Initialize i18n on page load
(function() {
  // Render AI guide in default language first
  if (typeof _renderAIGuide === 'function') _renderAIGuide();
  const saved = SafeStorage.get('liq-lang');
  if (saved && saved !== 'es') {
    // Defer to allow DOM to be ready
    setTimeout(() => setLanguage(saved), 100);
  }
})();
</script>
</body>
</html>
