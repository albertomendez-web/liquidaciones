<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Liquidaciones &mdash; Gesti&oacute;n de Reservas</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'DM Sans', 'Helvetica Neue', sans-serif; background: #f0f2f5; color: #1a1a2e; min-height: 100vh; }
.sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 250px; background: linear-gradient(195deg, #0f1628 0%, #1a2744 100%); color: #fff; display: flex; flex-direction: column; z-index: 50; }
.logo { padding: 28px 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
.logo h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.02em; }
.logo p { font-size: 11px; color: rgba(255,255,255,0.45); margin-top: 4px; letter-spacing: 0.06em; text-transform: uppercase; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 13px 24px; font-size: 14px; color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
.nav-item:hover { color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.04); }
.nav-item.active { color: #fff; font-weight: 600; background: rgba(255,255,255,0.08); border-left-color: #4f8cff; }
.sidebar-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 11px; color: rgba(255,255,255,0.35); margin-top: auto; }
.changelog-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
.changelog-modal { background:#fff; border-radius:16px; max-width:640px; width:90vw; max-height:80vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
.changelog-header { display:flex; justify-content:space-between; align-items:center; padding:20px 24px; border-bottom:1px solid #e5e7eb; }
.changelog-header h3 { margin:0; font-size:18px; color:#1a2744; }
.changelog-body { overflow-y:auto; padding:20px 24px; flex:1; }
.cl-version { margin-bottom:20px; }
.cl-version:last-child { margin-bottom:0; }
.cl-version-header { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.cl-badge { background:#4f8cff; color:#fff; font-size:12px; font-weight:700; padding:3px 10px; border-radius:20px; }
.cl-badge.current { background:#43a047; }
.cl-date { font-size:12px; color:#9ca3af; }
.cl-changes { list-style:none; padding:0; margin:0; }
.cl-changes li { font-size:13px; color:#4b5563; padding:3px 0 3px 18px; position:relative; line-height:1.5; }
.cl-changes li::before { content:'\2022'; position:absolute; left:4px; color:#4f8cff; font-weight:700; }
.main { margin-left: 250px; padding: 32px 40px; min-height: 100vh; }
.card { background: #fff; border-radius: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); padding: 28px 32px; margin-bottom: 24px; }
.upload-wrap { display: flex; align-items: center; justify-content: center; min-height: 70vh; }
.upload-inner { max-width: 520px; width: 100%; text-align: center; }
.upload-inner h2 { font-size: 32px; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 8px; }
.upload-inner p { color: #6b7280; font-size: 15px; margin-bottom: 32px; }
.dropzone { border: 2px dashed #cfd5de; border-radius: 16px; padding: 64px 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fafbfc; }
.dropzone.dragging { border-color: #4f8cff; background: rgba(79,140,255,0.04); }
.dropzone svg { color: #9ca3af; margin-bottom: 16px; }
.dropzone .title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
.dropzone .sub { font-size: 13px; color: #9ca3af; }
.stats-row { display: flex; gap: 16px; margin-bottom: 24px; }
.stat-card { flex: 1; padding: 20px 24px; border-radius: 12px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.stat-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; margin-bottom: 6px; }
.stat-value { font-size: 26px; font-weight: 700; letter-spacing: -0.02em; }
.stat-filtered { font-size: 13px; font-weight: 600; color: #4f8cff; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #e0e4ea; }
.stat-pct { font-size: 11px; font-weight: 500; color: #9ca3af; }
.filters-bar { display: flex; gap: 12px; align-items: center; padding: 16px 24px; margin-bottom: 16px; flex-wrap: wrap; }
.filters-bar label { font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.06em; }
.filters-bar .count { font-size: 12px; color: #9ca3af; margin-left: auto; }
.search-wrap { position: relative; display: flex; align-items: center; }
.search-icon { position: absolute; left: 8px; font-size: 13px; pointer-events: none; z-index: 1; opacity: 0.5; }
.search-input { padding: 6px 28px 6px 28px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-weight: 500; background: #fafbfc; outline: none; transition: border-color 0.2s; font-family: inherit; width: 220px; }
.search-input:focus { border-color: #4f8cff; }
.search-input::placeholder { color: #9ca3af; font-weight: 400; }
.search-clear { position: absolute; right: 6px; cursor: pointer; color: #9ca3af; font-size: 14px; line-height: 1; padding: 2px; }
.search-clear:hover { color: #e53935; }
.filter-sep { width: 1px; height: 24px; background: #e5e7eb; }
.table-wrap { overflow-x: auto; overflow-y: scroll; max-height: 75vh; overscroll-behavior: contain; overflow-anchor: none; }
.table-wrap::-webkit-scrollbar { width: 6px; }
.table-wrap::-webkit-scrollbar-track { background: transparent; }
.table-wrap::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
.table-wrap::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
table { width: 100%; border-collapse: collapse; }
th { padding: 8px 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; border-bottom: 2px solid #eef0f4; text-align: center; white-space: nowrap; background: #f8f9fb; cursor: pointer; user-select: none; position: sticky; top: 0; z-index: 3; line-height: 1.35; vertical-align: middle; }
th:hover { color: #4f8cff; }
th.right { text-align: center; }
th .sort-arrow { font-size: 9px; margin-left: 3px; opacity: 0.3; }
th.sorted .sort-arrow { opacity: 1; color: #4f8cff; }
th.no-sort { cursor: default; }
th.no-sort:hover { color: #6b7280; }
td { padding: 9px 10px; font-size: 13px; border-bottom: 1px solid #f3f4f6; white-space: nowrap; vertical-align: middle; }
td.right { text-align: right; font-variant-numeric: tabular-nums; }
td.bold { font-weight: 700; }
td.ellip { max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
td.muted { font-size: 12px; color: #6b7280; }
tr:hover td { background: #f8f9ff; }
tfoot td { position: sticky; bottom: 0; z-index: 2; background: #0f1628 !important; }
tfoot tr:hover td { background: #0f1628 !important; }
th.col-comPlataforma, th.col-comGTC, th.col-limpieza, th.col-amenities, th.col-pasarela, th.col-noches { text-align: center; }
tr.validated td { background: rgba(232,245,233,0.3); }
tr.highlight td { animation: pulse-highlight 0.6s ease-in-out 3; }
@keyframes pulse-highlight {
  0% { background: #fff; }
  50% { background: #e3f0ff; }
  100% { background: #fff; }
}
.badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.02em; }
.badge-green { background: #e8f5e9; color: #2e7d32; }
.badge-amber { background: #fff8e1; color: #f57f17; }
.badge-blue { background: #e3f2fd; color: #1565c0; }
.badge-purple { background: #f3e5f5; color: #7b1fa2; }
.badge-red { background: #ffebee; color: #c62828; }
select.sel { padding: 6px 10px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-weight: 500; background: #fafbfc; outline: none; cursor: pointer; transition: border-color 0.2s; font-family: inherit; display: inline-block; text-align: center; text-align-last: center; }
select.sel:focus { border-color: #4f8cff; }
select.sel:disabled { opacity: 0.5; cursor: not-allowed; }
.toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; }
.toggle-track { width: 38px; height: 22px; border-radius: 11px; background: #d1d5db; position: relative; transition: background 0.2s; flex-shrink: 0; }
.toggle-track.on { background: #4f8cff; }
.toggle-thumb { position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; border-radius: 9px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.15); transition: left 0.2s; }
.toggle-track.on .toggle-thumb { left: 18px; }
.toggle-label { font-size: 11px; color: #6b7280; }
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
.btn:hover { opacity: 0.88; }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-primary { background: #4f8cff; color: #fff; }
.btn-success { background: #43a047; color: #fff; }
.btn-orange { background: #ef6c00; color: #fff; }
.btn-outline { background: transparent; color: #4f8cff; border: 1.5px solid #4f8cff; }
.btn-disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; }
.btn-disabled:hover { opacity: 1; }

/* MODAL */
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 100; display: flex; align-items: flex-start; justify-content: center; padding-top: 8vh; backdrop-filter: blur(3px); }
.modal { background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); width: 600px; max-height: 85vh; min-height: 520px; overflow-y: auto; }
.modal-header { padding: 24px 28px 16px; border-bottom: 1px solid #eef0f4; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 2; border-radius: 16px 16px 0 0; }
.modal-header h3 { font-size: 18px; font-weight: 700; }
.modal-close { width: 32px; height: 32px; border-radius: 8px; border: none; background: #f3f4f6; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
.modal-close:hover { background: #e5e7eb; }
.modal-body { padding: 24px 28px; }
.modal-section { margin-bottom: 28px; }
.modal-section:last-child { margin-bottom: 0; }
.modal-section h4 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; margin-bottom: 12px; }
.modal-section .desc { font-size: 12px; color: #9ca3af; margin-top: -8px; margin-bottom: 12px; }
.option-list { display: flex; flex-direction: column; gap: 6px; }
.option-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 8px; background: #f8f9fb; font-size: 14px; font-weight: 500; }
.option-delete { width: 28px; height: 28px; border-radius: 6px; border: none; background: transparent; color: #e53935; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.option-delete:hover { background: #ffebee; }
.add-row { display: flex; gap: 8px; margin-top: 10px; }
.add-input { flex: 1; padding: 8px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 14px; font-family: inherit; outline: none; }
.add-input:focus { border-color: #4f8cff; }
.add-input::placeholder { color: #bbb; }
.section-divider { border: none; border-top: 2px solid #eef0f4; margin: 28px 0; }
.modal-tabs { display: flex; gap: 4px; padding: 16px 28px 0; background: #fff; position: sticky; top: 60px; z-index: 1; border-bottom: 1px solid #eef0f4; }
.modal-tab { padding: 10px 18px; font-size: 13px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
.modal-tab:hover { color: #4f8cff; }
.modal-tab.active { color: #4f8cff; border-bottom-color: #4f8cff; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ALOJAMIENTO CARDS */
.aloj-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-bottom: 24px; }
.aloj-card { background: #fff; border-radius: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); padding: 24px; transition: all 0.2s; cursor: pointer; border: 2px solid transparent; position: relative; overflow: hidden; }
.aloj-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }
.aloj-card.ready { border-color: #43a047; }
.aloj-card.pending { border-color: #ff9800; }
.aloj-semaforo { position: absolute; top: 0; right: 0; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
.aloj-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; padding-right: 40px; }
.aloj-edificio { font-size: 12px; color: #6b7280; margin-bottom: 16px; }
.aloj-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.aloj-stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; }
.aloj-stat-value { font-size: 18px; font-weight: 700; margin-top: 2px; }
.aloj-bar { height: 4px; border-radius: 2px; background: #eef0f4; margin-top: 16px; overflow: hidden; }
.aloj-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

/* CONSOLIDATED LIQUIDACION */
.consol-container { max-width: 100%; margin: 0 auto; }
.consol-header { background: linear-gradient(135deg, #0f1628 0%, #1a2744 100%); color: #fff; padding: 32px 32px; border-radius: 14px 14px 0 0; }
.consol-header .type { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.6; margin-bottom: 4px; }
.consol-header .name { font-size: 24px; font-weight: 700; }
.consol-meta { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 24px; font-size: 13px; }
.consol-meta-label { opacity: 0.5; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; }
.consol-meta-value { font-weight: 600; margin-top: 2px; }
.consol-body { background: #fff; border-radius: 0 0 14px 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); overflow: hidden; }
.consol-section-title { padding: 14px 28px 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; background: #f8f9fb; border-top: 2px solid #eef0f4; }
.consol-section-title:first-child { border-top: none; }
.consol-summary-block { padding: 0; }
.consol-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 28px; font-size: 13px; }
.consol-row:nth-child(even) { background: #fafbfc; }
.consol-row.sub { padding-left: 44px; font-size: 12px; color: #6b7280; }
.consol-row .neg { color: #e53935; font-variant-numeric: tabular-nums; }
.consol-row .pos { color: #43a047; font-variant-numeric: tabular-nums; }
.consol-row.bold { font-weight: 700; }
.consol-divider { height: 1px; background: #eef0f4; margin: 4px 28px; }
.consol-subtotal-reservas { display: flex; justify-content: space-between; align-items: center; padding: 12px 28px; font-size: 14px; font-weight: 700; background: linear-gradient(90deg,#eef3ff,#f8f9fb); border-top: 2px solid #4f8cff; border-bottom: 2px solid #4f8cff; color: #1a2744; }
.consol-monthly-box { background: #f0fdf4; border: 1.5px dashed #16a34a; border-radius: 8px; margin: 8px 20px; padding: 4px 8px; }
.consol-monthly-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #16a34a; padding: 6px 8px 4px; }
.consol-monthly-box .consol-row { padding: 8px 8px; border-radius: 4px; }
.consol-split-box { background: linear-gradient(135deg,#faf5ff,#f3e8ff); border: 2px solid #a855f7; border-radius: 10px; margin: 8px 20px; padding: 4px 8px; }
.consol-split-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #7c3aed; padding: 6px 8px 4px; }
.consol-split-box .consol-row { padding: 8px 8px; border-radius: 4px; }
.consol-split-divider { height: 1px; background: #d8b4fe; margin: 2px 8px; }
.gtc-split-section { background: linear-gradient(135deg,#faf5ff,#f3e8ff); border: 1.5px solid #d8b4fe; border-radius: 10px; margin: 8px 0 0; padding: 14px 16px; }
.gtc-split-title { font-size: 12px; font-weight: 700; color: #7c3aed; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
.gtc-split-desc { font-size: 11px; color: #6b7280; margin-bottom: 12px; line-height: 1.5; }
.gtc-split-list { display: flex; flex-direction: column; gap: 2px; }
.gtc-split-row { display: flex; align-items: center; justify-content: space-between; padding: 7px 10px; border-radius: 6px; transition: background 0.15s; }
.gtc-split-row:hover { background: rgba(168,85,247,0.06); }
.gtc-split-row .name { font-size: 12px; font-weight: 500; }
.gtc-split-row .name.on { color: #7c3aed; font-weight: 600; }
.gtc-split-divider-row { height: 1px; background: #ede9fe; margin: 0 10px; }
.gtc-split-counter { display: flex; align-items: center; gap: 8px; margin-top: 10px; padding: 8px 10px; background: rgba(168,85,247,0.08); border-radius: 8px; font-size: 11px; color: #6b7280; }
.gtc-split-counter .badge { display: inline-flex; align-items: center; justify-content: center; background: #7c3aed; color: #fff; font-size: 10px; font-weight: 700; min-width: 20px; height: 20px; border-radius: 10px; padding: 0 6px; }
.consol-subtotal { display: flex; justify-content: space-between; align-items: center; padding: 14px 28px; font-size: 15px; font-weight: 700; background: #f0f2f5; }
.consol-total { display: flex; justify-content: space-between; align-items: center; padding: 20px 28px; font-size: 20px; font-weight: 700; background: #0f1628; color: #fff; border-radius: 0 0 14px 14px; }
.consol-mini-table { margin: 0; width: 100%; table-layout: auto; }
.consol-mini-table th { font-size: 10px; padding: 10px 8px; }
.consol-mini-table td { font-size: 11px; padding: 8px 8px; }
.consol-mini-table tbody tr:hover td { background: #eef3ff; }
.consol-mini-table .ellip { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 160px; }

/* LIQUIDACI&#xC3;&ldquo;N INDIVIDUAL */
.liq-container { max-width: 800px; margin: 0 auto; background: #fff; border-radius: 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); overflow: hidden; }
.liq-header { background: linear-gradient(135deg, #0f1628 0%, #1a2744 100%); color: #fff; padding: 36px 40px; }
.liq-header .type { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.6; margin-bottom: 4px; }
.liq-header .name { font-size: 24px; font-weight: 700; }
.liq-meta { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 24px; font-size: 13px; }
.liq-meta-label { opacity: 0.5; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; }
.liq-meta-value { font-weight: 600; margin-top: 2px; }
.liq-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 40px; font-size: 14px; }
.liq-row:nth-child(even) { background: #f8f9fb; }
.liq-row.bold { font-weight: 700; }
.liq-row .neg { color: #e53935; }
.liq-row .pos { color: #43a047; }
.liq-divider { height: 1px; background: #eef0f4; margin: 4px 40px; }
.liq-total { display: flex; justify-content: space-between; align-items: center; padding: 18px 40px; font-size: 18px; font-weight: 700; background: #0f1628; color: #fff; }
.liq-actions { display: flex; gap: 12px; justify-content: center; margin-top: 28px; }
.header-top { display: flex; justify-content: space-between; align-items: flex-start; }
.badge-liq { padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
.badge-liq-green { background: rgba(67,160,71,0.2); color: #81c784; }
.badge-liq-amber { background: rgba(255,183,77,0.2); color: #ffb74d; }

.screen { display: none; }
.screen.active { display: block; }
.gear-btn { width: 36px; height: 36px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; }
.gear-btn:hover { border-color: #4f8cff; background: #f0f5ff; }

/* SEARCHABLE COMBO */
.combo { position: relative; min-width: 190px; }
.combo-input { padding: 6px 30px 6px 10px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-weight: 500; background: #fafbfc; outline: none; cursor: pointer; transition: border-color 0.2s; font-family: inherit; width: 100%; }
.combo-input:focus { border-color: #4f8cff; }
.combo-input::placeholder { color: #6b7280; font-weight: 500; }
.combo-clear { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; border-radius: 4px; display: none; align-items: center; justify-content: center; font-size: 11px; color: #9ca3af; cursor: pointer; background: transparent; }
.combo-clear:hover { color: #e53935; background: #ffebee; }
.combo.has-value .combo-clear { display: flex; }
.combo.has-value .combo-input { padding-right: 30px; font-weight: 600; color: #1a1a2e; }
.combo-list { display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; max-height: 260px; overflow-y: auto; padding: 4px; }
.combo-list.open { display: block; }
.combo-item { padding: 8px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
.combo-item:hover { background: #eef3ff; }
.combo-item.active { background: #e3f2fd; font-weight: 600; color: #4f8cff; }
.combo-item .match { font-weight: 700; color: #4f8cff; }
.combo-item-count { font-size: 11px; color: #9ca3af; margin-left: 6px; }
.combo-empty { padding: 12px; font-size: 12px; color: #9ca3af; text-align: center; }
@media print {
  @page { size: A4 landscape; margin: 10mm 12mm; }
  body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  body * { visibility: hidden; }
  .print-target, .print-target * { visibility: visible; }
  .print-target { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none !important; border-radius: 0 !important; }
  .sidebar, .btn, .no-print, .liq-actions, .gear-btn { display: none !important; }

  /* Container */
  .consol-container, .liq-container { max-width: 100% !important; box-shadow: none !important; border-radius: 0 !important; }

  /* Header */
  .consol-header, .liq-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; border-radius: 0 !important; padding: 16px 20px !important; }
  .consol-header .name { font-size: 18px !important; }
  .consol-meta { gap: 12px !important; margin-top: 14px !important; font-size: 11px !important; }

  /* Body */
  .consol-body { box-shadow: none !important; border-radius: 0 !important; overflow: visible !important; }
  .table-wrap { overflow: visible !important; }

  /* Mini table \u2014 compact for landscape A4 */
  .consol-mini-table { table-layout: fixed !important; width: 100% !important; }
  .consol-mini-table th { padding: 4px 5px !important; font-size: 8px !important; }
  .consol-mini-table td { padding: 4px 5px !important; font-size: 9px !important; }
  .consol-mini-table .ellip { max-width: 0; }
  .badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 7px !important; padding: 1px 4px !important; }

  /* Summary rows */
  .consol-section-title { padding: 8px 16px 4px !important; font-size: 9px !important; }
  .consol-row { padding: 5px 16px !important; font-size: 10px !important; }
  .consol-row.sub { padding-left: 28px !important; font-size: 9px !important; }
  .consol-divider { margin: 2px 16px !important; }
  .consol-subtotal { padding: 8px 16px !important; font-size: 12px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .consol-total { padding: 12px 16px !important; font-size: 15px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; border-radius: 0 !important; }

  /* CRITICAL: keep summary + total together \u2014 never split across pages */
  .consol-summary-block { page-break-inside: avoid !important; break-inside: avoid !important; }

  /* Table page break rules */
  table { page-break-inside: auto; }
  thead { display: table-header-group; }
  tr { page-break-inside: avoid; }
  .consol-section-title { page-break-after: avoid; }

  /* Individual liquidaci&oacute;n */
  .liq-row { padding: 6px 20px !important; font-size: 11px !important; }
  .liq-divider { margin: 2px 20px !important; }
  .liq-total { padding: 10px 20px !important; font-size: 15px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .liq-header { padding: 16px 20px !important; }

  /* Print cards: keep each card together, break between them */
  .print-card { page-break-inside: avoid !important; break-inside: avoid !important; margin-bottom: 12px !important; }
  .print-summary { page-break-inside: avoid !important; break-inside: avoid !important; margin-top: 12px !important; }
}
::-webkit-scrollbar { height: 6px; width: 6px; }
::-webkit-scrollbar-thumb { background: #cfd5de; border-radius: 3px; }
/* GOOGLE SHEETS UI */
.gsheet-section { margin-top: 32px; padding-top: 28px; border-top: 2px solid #eef0f4; }
.gsheet-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.gsheet-section p { font-size: 13px; color: #9ca3af; margin-bottom: 16px; }
.gsheet-status { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; margin-bottom: 16px; }
.gsheet-status.connected { background: #e8f5e9; color: #2e7d32; }
.gsheet-status.disconnected { background: #f3f4f6; color: #6b7280; }
.gsheet-status .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.gsheet-status.connected .dot { background: #43a047; }
.gsheet-status.disconnected .dot { background: #9ca3af; }
.gsheet-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
.gsheet-history { margin-top: 20px; }
.gsheet-history h4 { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #9ca3af; margin-bottom: 10px; }
.gsheet-history-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 8px; background: #f8f9fb; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; border: 1.5px solid transparent; }
.gsheet-history-item:hover { border-color: #4f8cff; background: #f0f5ff; }
.gsheet-history-item .name { font-size: 13px; font-weight: 600; }
.gsheet-history-item .meta { font-size: 11px; color: #9ca3af; }
.gsheet-history-item .remove-btn { width: 24px; height: 24px; border-radius: 6px; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
.gsheet-history-item .remove-btn:hover { background: #ffebee; color: #e53935; }
.gsheet-url-row { display: flex; gap: 8px; margin-bottom: 12px; }
.gsheet-url-input { flex: 1; padding: 10px 14px; border-radius: 8px; border: 1.5px solid #dde1e8; font-size: 13px; font-family: inherit; outline: none; }
.gsheet-url-input:focus { border-color: #4f8cff; }
.gsheet-url-input::placeholder { color: #bbb; }
.gsheet-loading { display: flex; align-items: center; gap: 10px; padding: 16px; font-size: 14px; color: #6b7280; }
.gsheet-spinner { width: 20px; height: 20px; border: 2.5px solid #e0e4ea; border-top-color: #4f8cff; border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.sidebar-google { padding: 10px 24px; border-top: 1px solid rgba(255,255,255,0.08); }
.sidebar-google .status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }
.sidebar-google .status-text { font-size: 11px; color: rgba(255,255,255,0.5); }
.sidebar-google .status-dot.on { background: #43a047; }
.sidebar-google .status-dot.off { background: #666; }
/* SYNC INDICATOR */
.sync-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; transition: background 0.3s; }
.sync-dot.idle { background: #43a047; }
.sync-dot.syncing { background: #ff9800; animation: sync-pulse 0.8s ease-in-out infinite; }
.sync-dot.saved { background: #43a047; }
.sync-dot.error { background: #e53935; }
@keyframes sync-pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
.page-header h1 { font-size: 26px; font-weight: 700; letter-spacing: -0.02em; }
.page-header p { color: #6b7280; font-size: 14px; margin-top: 4px; }
/* COLUMN TOGGLE DROPDOWN */
.col-toggle-wrap { position: relative; }
.col-toggle-btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fafbfc; font-size: 12px; font-weight: 600; color: #6b7280; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.col-toggle-btn:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
.col-toggle-dd { display: none; position: absolute; top: calc(100% + 4px); right: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; padding: 8px 4px; min-width: 200px; max-height: 60vh; overflow-y: auto; }
.col-toggle-dd.open { display: block; }
.col-toggle-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; }
.col-toggle-item:hover { background: #eef3ff; }
.col-toggle-item input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; }
.col-toggle-item.locked { opacity: 0.4; cursor: not-allowed; }
.col-toggle-item.locked:hover { background: transparent; }
/* MONTH PICKER */
.mp-wrap { position: relative; }
.mp-btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; border: 1.5px solid #dde1e8; background: #fafbfc; font-size: 13px; font-weight: 500; color: #6b7280; cursor: pointer; font-family: inherit; transition: all 0.2s; white-space: nowrap; }
.mp-btn:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
.mp-btn.active { border-color: #4f8cff; background: #e3f2fd; color: #1565c0; font-weight: 600; }
.mp-btn .mp-icon { font-size: 14px; }
.mp-btn .mp-clear { margin-left: 4px; width: 16px; height: 16px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; color: #9ca3af; }
.mp-btn .mp-clear:hover { color: #e53935; background: #ffebee; }
.mp-nav { display: inline-flex; align-items: center; gap: 0; margin-right: 2px; }
.mp-arrow { width: 22px; height: 22px; border-radius: 5px; border: none; background: transparent; cursor: pointer; font-size: 13px; color: #4f8cff; display: inline-flex; align-items: center; justify-content: center; transition: all 0.15s; font-family: inherit; padding: 0; }
.mp-arrow:hover { background: rgba(79,140,255,0.15); }
.mp-dd { display: none; position: absolute; top: calc(100% + 4px); left: 0; background: #fff; border: 1.5px solid #dde1e8; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 60; padding: 12px; min-width: 280px; }
.mp-dd.open { display: block; }
.mp-years { display: flex; gap: 4px; margin-bottom: 10px; flex-wrap: wrap; }
.mp-year { padding: 5px 12px; border-radius: 6px; border: 1.5px solid #e0e4ea; background: #fafbfc; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; font-family: inherit; color: #6b7280; }
.mp-year:hover { border-color: #4f8cff; color: #4f8cff; }
.mp-year.sel { background: #4f8cff; color: #fff; border-color: #4f8cff; }
.mp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
.mp-month { padding: 8px 4px; border-radius: 6px; border: none; background: #f8f9fb; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; font-family: inherit; text-align: center; color: #1a1a2e; }
.mp-month:hover { background: #e3f2fd; color: #1565c0; }
.mp-month.sel { background: #4f8cff; color: #fff; font-weight: 700; }
.mp-month.dim { opacity: 0.3; cursor: default; pointer-events: none; }
.mp-month .mp-cnt { display: block; font-size: 10px; font-weight: 400; opacity: 0.6; margin-top: 1px; }
.mp-month.sel .mp-cnt { opacity: 0.8; }
.mp-all { display: block; width: 100%; padding: 7px; margin-top: 8px; border-radius: 6px; border: 1.5px dashed #dde1e8; background: transparent; font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; color: #6b7280; text-align: center; transition: all 0.15s; }
.mp-all:hover { border-color: #4f8cff; color: #4f8cff; background: #f0f5ff; }
/* MULTI-SELECT COMBO ADDITIONS */
.combo-item-chk { display: flex; align-items: center; gap: 8px; padding: 7px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; }
.combo-item-chk:hover { background: #eef3ff; }
.combo-item-chk input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; flex-shrink: 0; }
.combo-item-chk .match { font-weight: 700; color: #4f8cff; }
.combo-item-chk .combo-item-count { font-size: 11px; color: #9ca3af; margin-left: auto; }
.combo-selall { display: flex; align-items: center; gap: 8px; padding: 7px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; transition: background 0.15s; user-select: none; color: #4f8cff; font-weight: 600; border-bottom: 1px solid #eef0f4; margin-bottom: 2px; }
.combo-selall:hover { background: #f0f5ff; }
.combo-selall input[type=checkbox] { accent-color: #4f8cff; width: 15px; height: 15px; cursor: pointer; flex-shrink: 0; }
.combo-tags { display: flex; gap: 4px; flex-wrap: wrap; max-width: 240px; }
.combo-tag { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 4px; background: #e3f2fd; color: #1565c0; font-size: 11px; font-weight: 600; white-space: nowrap; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
/* === CONCEPTOS ESPECIALES === */
.ce-btn { display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:7px;border:1.5px dashed #d0d5dd;background:transparent;color:#9ca3af;font-size:15px;cursor:pointer;transition:all .15s;padding:0; }
.ce-btn * { pointer-events:none; }
.ce-btn:hover { border-color:#f59e0b;background:#fffbeb;color:#f59e0b;transform:scale(1.08); }
.ce-btn.has { width:auto;padding:0 8px;height:24px;gap:4px;border:1.5px solid #f59e0b;background:#fffbeb;color:#d97706;font-size:11px;font-weight:700;border-style:solid;white-space:nowrap; }
.ce-btn.has .ce-dot { width:5px;height:5px;border-radius:50%;background:#f59e0b;animation:cePulse 2s infinite; }
.ce-btn.has:hover { background:#fef3c7;border-color:#d97706; }
@keyframes cePulse { 0%,100%{opacity:1}50%{opacity:.4} }
.ce-panel-row td { padding:0!important;border-bottom:1px solid #f59e0b!important; }
.ce-panel-inner { background:#fffdf5;border-top:2px solid #f59e0b;padding:12px 16px 12px 48px;display:flex;align-items:flex-start;gap:16px;animation:ceSlide .2s ease; }
@keyframes ceSlide { from{opacity:0;max-height:0}to{opacity:1;max-height:300px} }
.ce-panel-left { flex:1; }
.ce-panel-title { font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#d97706;margin-bottom:8px;display:flex;align-items:center;gap:8px; }
.ce-panel-title .ce-eye { font-size:9px;color:#9ca3af;font-weight:500;letter-spacing:0;text-transform:none; }
.ce-item-row { display:flex;align-items:center;gap:8px;margin-bottom:5px; }
.ce-item-row.ce-new { animation:ceRowIn .25s ease; }
@keyframes ceRowIn { from { opacity:0;max-height:0;margin-bottom:0;overflow:hidden; } to { opacity:1;max-height:40px;margin-bottom:5px; } }
@keyframes ceRowOut { from { opacity:1;max-height:40px;margin-bottom:5px; } to { opacity:0;max-height:0;margin-bottom:0;overflow:hidden; } }
.ce-item-row input { border:1px solid #e5e7eb;border-radius:5px;padding:4px 8px;font-size:12px;font-family:inherit;background:white; }
.ce-item-row .ce-inp-label { width:180px; }
.ce-item-row .ce-inp-amt { width:90px;text-align:right;font-weight:600; }
.ce-item-row .ce-del { width:22px;height:22px;border-radius:5px;border:none;background:#fef2f2;color:#ef4444;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center; }
.ce-item-row .ce-del:hover { background:#ef4444;color:white; }
.ce-add-link { color:#4f8cff;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-top:2px; }
.ce-add-link:hover { text-decoration:underline; }
.ce-panel-summary { text-align:right;padding:8px 14px;background:#fef3c7;border-radius:8px;min-width:140px; }
.ce-panel-summary .ce-sum-label { font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#92400e;line-height:1.3; }
.ce-panel-summary .ce-sum-val { font-size:16px;font-weight:700;color:#d97706;margin-top:4px; }
tr.ce-highlighted { background:#fffdf5; }
/* === CE SIN IVA (violet) === */
.ce2-btn { display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:7px;border:1.5px dashed #d0d5dd;background:transparent;color:#9ca3af;font-size:15px;cursor:pointer;transition:all .15s;padding:0; }
.ce2-btn * { pointer-events:none; }
.ce2-btn:hover { border-color:#7c3aed;background:#f5f0ff;color:#7c3aed;transform:scale(1.08); }
.ce2-btn.has { width:auto;padding:0 8px;height:24px;gap:4px;border:1.5px solid #7c3aed;background:#f5f0ff;color:#6d28d9;font-size:11px;font-weight:700;border-style:solid;white-space:nowrap; }
.ce2-btn.has .ce2-dot { width:5px;height:5px;border-radius:50%;background:#7c3aed;animation:cePulse 2s infinite; }
.ce2-btn.has:hover { background:#ede9fe;border-color:#6d28d9; }
.ce2-panel-row td { padding:0!important;border-bottom:1px solid #7c3aed!important; }
.ce2-panel-inner { background:#faf8ff;border-top:2px solid #7c3aed;padding:12px 16px 12px 48px;display:flex;align-items:flex-start;gap:16px;animation:ceSlide .2s ease; }
.ce2-panel-left { flex:1; }
.ce2-panel-title { font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#7c3aed;margin-bottom:8px;display:flex;align-items:center;gap:8px; }
.ce2-panel-title .ce2-eye { font-size:9px;color:#9ca3af;font-weight:500;letter-spacing:0;text-transform:none; }
.ce2-item-row { display:flex;align-items:center;gap:8px;margin-bottom:5px; }
.ce2-item-row.ce2-new { animation:ceRowIn .25s ease; }
.ce2-item-row input { border:1px solid #e5e7eb;border-radius:5px;padding:4px 8px;font-size:12px;font-family:inherit;background:white; }
.ce2-item-row .ce2-inp-label { width:180px; }
.ce2-item-row .ce2-inp-amt { width:90px;text-align:right;font-weight:600; }
.ce2-item-row .ce2-del { width:22px;height:22px;border-radius:5px;border:none;background:#fef2f2;color:#ef4444;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center; }
.ce2-item-row .ce2-del:hover { background:#ef4444;color:white; }
.ce2-add-link2 { color:#7c3aed;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-top:2px; }
.ce2-add-link2:hover { text-decoration:underline; }
.ce2-panel-summary { text-align:right;padding:8px 14px;background:#f5f0ff;border-radius:8px;min-width:140px; }
.ce2-panel-summary .ce2-sum-label { font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#5b21b6;line-height:1.3; }
.ce2-panel-summary .ce2-sum-val { font-size:16px;font-weight:700;color:#7c3aed;margin-top:4px; }
tr.ce2-highlighted { background:#faf8ff; }
@media print { .ce-panel-row,.col-ce,.cc-ce,.ce-highlighted,.ce2-panel-row,.col-ceSinIva,.cc-ceSinIva,.ce2-highlighted { display:none!important;background:transparent!important; } }
/* === AI ASSISTANT === */
.ai-fab { position:fixed; bottom:24px; right:24px; width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,#4f8cff,#3b6de0); color:#fff; border:none; font-size:24px; cursor:pointer; box-shadow:0 4px 16px rgba(79,140,255,0.4); z-index:90; display:flex; align-items:center; justify-content:center; transition:transform 0.2s,box-shadow 0.2s; }
.ai-fab:hover { transform:scale(1.08); box-shadow:0 6px 24px rgba(79,140,255,0.5); }
.ai-fab .fab-badge { position:absolute; top:-2px; right:-2px; width:14px; height:14px; background:#43a047; border-radius:50%; border:2px solid #fff; display:none; }
.ai-panel { position:fixed; right:-420px; top:0; bottom:0; width:400px; background:#fff; box-shadow:-4px 0 24px rgba(0,0,0,0.12); z-index:95; display:flex; flex-direction:column; transition:right 0.3s cubic-bezier(0.16,1,0.3,1); }
.ai-panel.open { right:0; }
.ai-header { padding:16px 20px; background:linear-gradient(135deg,#0f1628,#1a2744); color:#fff; display:flex; align-items:center; gap:12px; }
.ai-header h3 { margin:0; font-size:15px; font-weight:600; flex:1; }
.ai-header .ai-close { background:none; border:none; color:rgba(255,255,255,0.6); font-size:20px; cursor:pointer; padding:4px; }
.ai-header .ai-close:hover { color:#fff; }
.ai-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
.ai-msg { max-width:88%; padding:10px 14px; border-radius:14px; font-size:13px; line-height:1.5; word-wrap:break-word; }
.ai-msg.user { align-self:flex-end; background:#4f8cff; color:#fff; border-bottom-right-radius:4px; }
.ai-msg.assistant { align-self:flex-start; background:#f1f3f5; color:#1a2744; border-bottom-left-radius:4px; }
.ai-msg.assistant strong { font-weight:700; }
.ai-msg.system { align-self:center; background:transparent; color:#9ca3af; font-size:11px; text-align:center; padding:4px; }
.ai-msg.error { align-self:center; background:#fef2f2; color:#dc2626; font-size:12px; text-align:center; border-radius:8px; }
.ai-input-wrap { padding:12px 16px; border-top:1px solid #eef0f4; display:flex; gap:8px; background:#fff; }
.ai-input-wrap textarea { flex:1; border:1.5px solid #dde1e8; border-radius:10px; padding:10px 12px; font-size:13px; font-family:inherit; resize:none; outline:none; min-height:20px; max-height:100px; line-height:1.4; }
.ai-input-wrap textarea:focus { border-color:#4f8cff; }
.ai-input-wrap button { background:#4f8cff; color:#fff; border:none; border-radius:10px; padding:0 16px; cursor:pointer; font-size:14px; font-weight:600; transition:background 0.2s; }
.ai-input-wrap button:hover { background:#3b6de0; }
.ai-input-wrap button:disabled { background:#a0c4ff; cursor:not-allowed; }
.ai-typing { display:flex; gap:4px; padding:8px 14px; }
.ai-typing span { width:7px; height:7px; background:#9ca3af; border-radius:50%; animation:aiDot 1.4s infinite; }
.ai-typing span:nth-child(2) { animation-delay:0.2s; }
.ai-typing span:nth-child(3) { animation-delay:0.4s; }
@keyframes aiDot { 0%,80%,100%{opacity:0.3;transform:scale(0.8)} 40%{opacity:1;transform:scale(1)} }
@media print { .ai-fab,.ai-panel { display:none!important; } }
</style>
<style id="col-visibility-style"></style>
<style id="consol-col-visibility-style"></style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>

<div class="sidebar">
  <div class="logo"><h1>Liquidaciones</h1><p>Gesti&oacute;n de Reservas</p></div>
  <nav style="margin-top:16px; flex:1;">
    <div class="nav-item active" id="nav-upload" onclick="showScreen('upload')">&#128228; Cargar Fichero</div>
    <div class="nav-item" id="nav-list" onclick="showScreen('list')">&#128203; Preliquidaciones</div>
    <div class="nav-item" id="nav-consol" onclick="showScreen('consol')" style="display:none;">&#127968; Por Alojamiento</div>
    <div class="nav-item" id="nav-detail" onclick="showScreen('detail')" style="display:none;">&#128065; Detalle</div>
    <div class="nav-item" id="nav-consoldetail" onclick="showScreen('consoldetail')" style="display:none;">&#128196; Liquidaci&oacute;n</div>
  </nav>
  <div class="sidebar-google" id="sidebar-google" style="display:none;">
    <span class="status-dot" id="google-dot"></span>
    <span class="status-text" id="google-status-text"></span>
  </div>
  <div class="sidebar-footer" id="file-indicator" style="display:none;">&#128206; <span id="file-name"></span></div>
  <div id="sync-indicator" style="display:none;padding:8px 24px;align-items:center;gap:8px;font-size:11px;color:rgba(255,255,255,0.6);">
    <div class="sync-dot idle"></div>
    <span class="sync-text">Sincronizado</span>
  </div>
  <div class="sidebar-footer" id="version-indicator" style="cursor:pointer;" onclick="showVersionInfo()" title="Info de versi&oacute;n">v<span id="version-label"></span></div>
  <div style="padding:0 24px 12px; font-size:11px;"><a href="#" onclick="event.preventDefault();showChangelog()" style="color:rgba(255,255,255,0.4);text-decoration:none;" onmouseover="this.style.color='rgba(255,255,255,0.7)'" onmouseout="this.style.color='rgba(255,255,255,0.4)'">&#x1F4CB; Historial de cambios</a></div>
</div>

<!-- Changelog Modal -->
<div class="changelog-overlay" id="changelog-overlay" onclick="if(event.target===this)closeChangelog()">
  <div class="changelog-modal">
    <div class="changelog-header">
      <h3>&#x1F4CB; Historial de versiones</h3>
      <button onclick="closeChangelog()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#6b7280;padding:4px;">&times;</button>
    </div>
    <div class="changelog-body" id="changelog-body"></div>
  </div>
</div>

<!-- AI Assistant -->
<button class="ai-fab" id="ai-fab" onclick="toggleAIPanel()" title="Asistente Hist&oacute;rico Reservas">&#x1F916;<span class="fab-badge" id="ai-badge"></span></button>
<div class="ai-panel" id="ai-panel">
  <div class="ai-header">
    <span style="font-size:20px;">&#x1F916;</span>
    <h3>Asistente Hist&oacute;rico Reservas</h3>
    <button class="ai-close" onclick="toggleAIPanel()">&times;</button>
  </div>
  <div class="ai-messages" id="ai-messages">
    <div class="ai-msg system">Preg&uacute;ntame sobre tus reservas, liquidaciones, importes... Respondo solo con tus datos reales.</div>
  </div>
  <div class="ai-input-wrap">
    <textarea id="ai-input" placeholder="Escribe tu pregunta..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAIMessage();}"></textarea>
    <button id="ai-send" onclick="sendAIMessage()">Enviar</button>
  </div>
</div>

<div class="main">
  <!-- UPLOAD -->
  <div class="screen active" id="screen-upload">
    <div class="upload-wrap"><div class="upload-inner">
      <h2>Cargar Reservas</h2>
      <p>Sube un fichero Excel o conecta con Google Sheets para cargar las reservas</p>
      <div class="dropzone" id="dropzone"
        ondragover="event.preventDefault(); this.classList.add('dragging');"
        ondragleave="this.classList.remove('dragging');"
        ondrop="event.preventDefault(); this.classList.remove('dragging'); handleFile(event.dataTransfer.files[0]);"
        onclick="document.getElementById('fileInput').click();">
        <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
        <div class="title">Arrastra tu fichero aqu&iacute;</div>
        <div class="sub">o haz clic para seleccionar &mdash; formato .xlsx</div>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;" onchange="handleFile(this.files[0]);">

      <!-- GOOGLE SHEETS SECTION -->
      <div class="gsheet-section" id="gsheet-section">
        <h3>&#128202; Cargar desde Google Sheets</h3>
        <p>Conecta con tu cuenta Google para cargar datos directamente desde una hoja de c&aacute;lculo</p>
        <div id="gsheet-auth-area">
          <div class="gsheet-status disconnected" id="gsheet-status">
            <div class="dot"></div>
            <span id="gsheet-status-label">No conectado</span>
          </div>
          <div class="gsheet-actions">
            <button class="btn btn-primary" id="btn-google-connect" onclick="googleSignIn()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#fff"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#fff" opacity=".8"/></svg>
              Conectar con Google
            </button>
            <button class="btn btn-outline" id="btn-google-disconnect" onclick="googleSignOut()" style="display:none;">Desconectar</button>
          </div>
        </div>
        <div id="gsheet-default-area" style="display:none; margin-top:20px;">
          <div style="background:#f0f5ff;border:1.5px solid #c3d9ff;border-radius:10px;padding:16px 20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#4f8cff;">&#9733; Hoja por defecto</span>
              <div style="display:flex;gap:6px;">
                <button class="btn btn-sm btn-primary" id="btn-load-default" onclick="loadDefaultSheet()">&#9654; Cargar ahora</button>
                <button class="btn btn-sm btn-outline" onclick="editDefaultUrl()" title="Cambiar URL">&#9998;</button>
                <button class="btn btn-sm" style="background:#ffebee;color:#e53935;padding:6px 10px;" onclick="clearDefaultUrl()" title="Quitar por defecto">&#10005;</button>
              </div>
            </div>
            <div id="default-url-display" style="font-size:13px;color:#1a2744;font-weight:500;word-break:break-all;"></div>
            <div id="default-url-edit" style="display:none;">
              <div class="gsheet-url-row" style="margin-bottom:0;">
                <input class="gsheet-url-input" type="text" id="default-url-edit-input" placeholder="https://docs.google.com/spreadsheets/d/...">
                <button class="btn btn-sm btn-success" onclick="saveDefaultUrlEdit()">Guardar</button>
                <button class="btn btn-sm btn-outline" onclick="cancelDefaultUrlEdit()">Cancelar</button>
              </div>
            </div>
          </div>
        </div>
        <div id="gsheet-autoload-status" style="display:none;margin-top:12px;">
          <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;background:#e8f5e9;color:#2e7d32;font-size:13px;font-weight:500;">
            <div class="gsheet-spinner" style="border-top-color:#43a047;border-color:#c8e6c9;width:18px;height:18px;"></div>
            <span id="autoload-status-text">Cargando hoja por defecto...</span>
          </div>
        </div>
        <div id="gsheet-no-default" style="display:none; margin-top:20px;">
          <div style="background:#f8f9fb;border:1.5px dashed #dde1e8;border-radius:10px;padding:14px 20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div>
                <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#9ca3af;margin-bottom:4px;">Hoja por defecto</div>
                <div style="font-size:13px;color:#6b7280;">Configura una URL para cargar autom&aacute;ticamente al conectar</div>
              </div>
              <button class="btn btn-sm btn-outline" onclick="showSetDefaultUrl()">Configurar</button>
            </div>
            <div id="set-default-url-form" style="display:none;margin-top:12px;">
              <div class="gsheet-url-row" style="margin-bottom:0;">
                <input class="gsheet-url-input" type="text" id="set-default-url-input" placeholder="https://docs.google.com/spreadsheets/d/...">
                <button class="btn btn-sm btn-success" onclick="saveNewDefaultUrl()">Guardar</button>
              </div>
            </div>
          </div>
        </div>
        <div id="gsheet-picker-area" style="display:none; margin-top:20px;">
          <div class="gsheet-actions" style="margin-bottom:12px;">
            <button class="btn btn-primary" onclick="openGooglePicker()">&#128193; Explorar Google Drive</button>
          </div>
          <div style="display:flex;align-items:center;gap:12px;margin:12px 0;">
            <div style="flex:1;height:1px;background:#e0e4ea;"></div>
            <span style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.08em;">o pega la URL</span>
            <div style="flex:1;height:1px;background:#e0e4ea;"></div>
          </div>
          <div class="gsheet-url-row">
            <input class="gsheet-url-input" type="text" id="gsheet-url-input" placeholder="https://docs.google.com/spreadsheets/d/...">
            <button class="btn btn-primary" onclick="loadFromUrl()">Cargar</button>
          </div>
        </div>
        <div id="gsheet-loading" style="display:none;" class="gsheet-loading">
          <div class="gsheet-spinner"></div>
          <span id="gsheet-loading-text">Cargando datos...</span>
        </div>
        <div id="gsheet-sheets-selector" style="display:none; margin-top:16px;">
          <label style="font-size:12px;font-weight:600;color:#6b7280;display:block;margin-bottom:8px;">Selecciona la hoja:</label>
          <div id="gsheet-sheets-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
        <div class="gsheet-history" id="gsheet-history" style="display:none;">
          <h4>Hojas recientes</h4>
          <div id="gsheet-history-list"></div>
        </div>
      </div>
    </div></div>
  </div>

  <!-- LIST -->
  <div class="screen" id="screen-list">
    <div class="page-header" style="margin-bottom:28px;">
      <h1>Preliquidaciones</h1>
      <p>Revisa, ajusta y valida cada reserva antes de generar la liquidaci&oacute;n definitiva</p>
    </div>
    <div class="stats-row" id="stats-row"></div>
    <div class="card filters-bar">
      <label>Filtros</label>
      <div class="combo" id="combo-platform">
        <input class="combo-input" type="text" placeholder="Todas las plataformas" onclick="openCombo('platform')" oninput="filterCombo('platform')">
        <div class="combo-clear" onclick="clearCombo('platform')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-platform"></div>
      </div>
      <div class="combo" id="combo-aloj">
        <input class="combo-input" type="text" placeholder="Todos los alojamientos" onclick="openCombo('aloj')" oninput="filterCombo('aloj')">
        <div class="combo-clear" onclick="clearCombo('aloj')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-aloj"></div>
      </div>
      <div class="combo" id="combo-status" style="min-width:150px;">
        <input class="combo-input" type="text" placeholder="Todos los estados" readonly onclick="openSimpleCombo('status')" style="cursor:pointer;">
        <div class="combo-clear" onclick="clearSimpleCombo('status')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-status"></div>
      </div>
      <div class="mp-wrap" id="mp-wrap-p">
        <button class="mp-btn" id="mp-btn-p" onclick="toggleMonthPicker('p')"><span class="mp-icon">&#128197;</span> <span id="mp-label-p">Todos los meses</span></button>
        <div class="mp-dd" id="mp-dd-p"></div>
      </div>
      <div class="filter-sep"></div>
      <div class="search-wrap">
        <span class="search-icon">&#128269;</span>
        <input type="text" class="search-input" id="search-preliq" placeholder="Buscar cliente, importe, fecha..." oninput="onSearchPreliq(this.value)">
        <div class="search-clear" id="search-preliq-clear" onclick="clearSearchPreliq()" style="display:none;">&#10005;</div>
      </div>
      <div class="filter-sep"></div>
      <label>Ordenar</label>
      <div class="combo" id="combo-sort" style="min-width:160px;">
        <input class="combo-input" type="text" placeholder="Orden original" readonly onclick="openSimpleCombo('sort')" style="cursor:pointer;">
        <div class="combo-list" id="combo-list-sort"></div>
      </div>
      <div class="combo" id="combo-sortdir" style="min-width:50px;">
        <input class="combo-input" type="text" placeholder="&#8593;" readonly onclick="openSimpleCombo('sortdir')" style="cursor:pointer;text-align:center;padding:6px 8px;">
        <div class="combo-list" id="combo-list-sortdir"></div>
      </div>
      <div class="filter-sep"></div>
      <button class="gear-btn" onclick="openConfigModal()" title="Configurar valores">&#9881;</button>
      <div class="col-toggle-wrap">
        <button class="col-toggle-btn" onclick="toggleColDropdown()" title="Mostrar/ocultar columnas">&#9783; Columnas</button>
        <div class="col-toggle-dd" id="col-toggle-dd"></div>
      </div>
      <div class="filter-sep"></div>
      <button class="btn btn-sm btn-success" id="btn-validar-todas" onclick="validarTodas()" style="display:none;">&#10004; Validar todas</button>
      <button class="btn btn-sm btn-orange" id="btn-desvalidar-todas" onclick="desvalidarTodas()" style="display:none;">&#8617; Desvalidar todas</button>
      <span class="count" id="filter-count"></span>
    </div>
    <div class="card" style="padding:0; overflow:hidden;">
      <div class="table-wrap">
        <table><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody><tfoot id="table-foot"></tfoot></table>
      </div>
      <div id="pagination-bar" class="no-print" style="display:none;padding:12px 20px;align-items:center;justify-content:space-between;gap:16px;border-top:1px solid #eef0f4;flex-wrap:wrap;"></div>
    </div>
  </div>

  <!-- DETAIL (individual) -->
  <div class="screen" id="screen-detail">
    <button class="btn btn-outline no-print" style="margin-bottom:24px;" onclick="showScreen('list')">&#8592; Volver a la lista</button>
    <div id="detail-content"></div>
  </div>

  <!-- CONSOLIDATED: grid of alojamientos -->
  <div class="screen" id="screen-consol">
    <div class="page-header" style="margin-bottom:28px;">
      <h1>Liquidaciones por Alojamiento</h1>
      <p>Consolida las reservas validadas de cada alojamiento para generar la liquidaci&oacute;n mensual</p>
    </div>
    <div class="stats-row" id="consol-stats"></div>
    <div class="card filters-bar" style="padding:12px 24px;">
      <div class="mp-wrap" id="mp-wrap-c">
        <button class="mp-btn" id="mp-btn-c" onclick="toggleMonthPicker('c')"><span class="mp-icon">&#128197;</span> <span id="mp-label-c">Todos los meses</span></button>
        <div class="mp-dd" id="mp-dd-c"></div>
      </div>
      <div class="filter-sep"></div>
      <div class="search-wrap">
        <span class="search-icon">&#128269;</span>
        <input type="text" class="search-input" id="search-consol" placeholder="Buscar alojamiento, importe..." oninput="onSearchConsol(this.value)">
        <div class="search-clear" id="search-consol-clear" onclick="clearSearchConsol()" style="display:none;">&#10005;</div>
      </div>
      <div class="filter-sep"></div>
      <label>Ordenar por</label>
      <div class="combo" id="combo-consolsort" style="min-width:190px;">
        <input class="combo-input" type="text" placeholder="Nombre A\u2191Z" readonly onclick="openSimpleCombo('consolsort')" style="cursor:pointer;">
        <div class="combo-clear" onclick="clearSimpleCombo('consolsort')" title="Limpiar">&#10005;</div>
        <div class="combo-list" id="combo-list-consolsort"></div>
      </div>
    </div>
    <div class="aloj-grid" id="aloj-grid"></div>
  </div>

  <!-- CONSOLIDATED DETAIL: one alojamiento -->
  <div class="screen" id="screen-consoldetail">
    <button class="btn btn-outline no-print" style="margin-bottom:24px;" onclick="showScreen('consol')">&#8592; Volver a alojamientos</button>
    <div id="consoldetail-content"></div>
  </div>
</div>

<!-- CONFIG MODAL -->
<div class="modal-overlay" id="config-modal" style="display:none;" onclick="if(event.target===this)closeConfigModal();">
  <div class="modal">
    <div class="modal-header">
      <h3>&#9881; Configurar Valores</h3>
      <button class="modal-close" onclick="closeConfigModal()">&#10005;</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab('tab-plat',this)">Canal de Venta</button>
      <button class="modal-tab" onclick="switchTab('tab-otros',this)">Servicio GTC / Limpieza / Amenities / Mant.</button>
      <button class="modal-tab" onclick="switchTab('tab-pasarela',this)">Pasarela</button>
      <button class="modal-tab" onclick="switchTab('tab-impuestos',this)">Impuestos</button>
    </div>
    <div class="modal-body">
      <div class="tab-panel active" id="tab-plat"></div>
      <div class="tab-panel" id="tab-otros"></div>
      <div class="tab-panel" id="tab-pasarela"></div>
      <div class="tab-panel" id="tab-impuestos"></div>
    </div>
  </div>
</div>

<script>
// ===
// CONTROL DE VERSIONES
// ===
// \u2500\u2500\u2500 SEARCH \u2500\u2500\u2500
function onSearchPreliq(val) {
  _searchText = val.trim().toLowerCase();
  document.getElementById('search-preliq-clear').style.display = _searchText ? 'block' : 'none';
  invalidateFilterCache();
  _currentPage = 1;
  renderTable();
}
function clearSearchPreliq() {
  document.getElementById('search-preliq').value = '';
  onSearchPreliq('');
}
function onSearchConsol(val) {
  _searchTextConsol = val.trim().toLowerCase();
  document.getElementById('search-consol-clear').style.display = _searchTextConsol ? 'block' : 'none';
  renderConsolGrid();
}
function clearSearchConsol() {
  document.getElementById('search-consol').value = '';
  onSearchConsol('');
}

/*
 * 
 *                     VERSIONING RULES (SemVer)                       
 *   OBLIGATORIO actualizar en CADA entrega de cdigo sin excepcin.   
 * 
 *   MAJOR (X.0.0)  Cambios incompatibles, reestructuracin total,   
 *                    migracin de datos necesaria                     
 *   MINOR (x.Y.0)  Nueva funcionalidad, nueva seccin UI,           
 *                    nuevo campo/columna, nueva integracin           
 *   PATCH (x.y.Z)  Bugfix, ajuste visual, optimizacin,             
 *                    refactor sin cambio funcional                    
 * 
 *   CHECKLIST por entrega:                                            
 *    1. Leer versin actual de APP_VERSION                          
 *    2. Decidir bump: MAJOR / MINOR / PATCH                        
 *    3. Actualizar APP_VERSION con nueva versin                    
 *    4. Actualizar APP_BUILD con fecha/hora actual Madrid (+01/+02) 
 *    5. Actualizar APP_CHANGES con resumen breve (< 100 chars)     
 *    6. Aadir entrada al array CHANGELOG (al principio)           
 *        con version, date (ISO Madrid), y array changes detallado   
 *    7. NUNCA reutilizar un nmero de versin ya existente          
 * 
 */
const APP_VERSION = '2.3.2';
const APP_BUILD   = '2026-02-12T23:45:00+01:00';
const APP_CHANGES = 'Lista 80/20 limitada a 20 alojamientos GTC propietaria';

// === UTILITY: XSS Escaping ===
function esc(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// === UTILITY: Safe JSON parse ===
function safeJSON(str, fallback) {
  if (fallback === undefined) fallback = null;
  if (!str || typeof str !== 'string') return fallback;
  try { return JSON.parse(str); }
  catch(e) { console.warn('[SafeJSON] Failed to parse:', str.substring(0, 100), e.message); return fallback; }
}

// === UTILITY: Safe localStorage ===
const SafeStorage = {
  get(key, fallback) {
    try { const v = localStorage.getItem(key); return v !== null ? v : (fallback !== undefined ? fallback : null); }
    catch(e) { console.warn('[Storage] Read error for', key, e.message); return fallback !== undefined ? fallback : null; }
  },
  set(key, value) {
    try { localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value)); return true; }
    catch(e) { console.warn('[Storage] Write error for', key, e.message); return false; }
  },
  remove(key) {
    try { localStorage.removeItem(key); return true; }
    catch(e) { console.warn('[Storage] Remove error for', key, e.message); return false; }
  },
  getJSON(key, fallback) {
    const raw = this.get(key, null);
    return raw ? safeJSON(raw, fallback !== undefined ? fallback : null) : (fallback !== undefined ? fallback : null);
  }
};

// === UTILITY: Debounce ===
function debounce(fn, ms) {
  let timer = null;
  const debounced = function() {
    const args = arguments;
    const ctx = this;
    if (timer) clearTimeout(timer);
    timer = setTimeout(function() { timer = null; fn.apply(ctx, args); }, ms);
  };
  debounced.cancel = function() { if (timer) { clearTimeout(timer); timer = null; } };
  return debounced;
}

// === UTILITY: Safe property access ===
function safeGet(obj, path, fallback) {
  if (!obj) return fallback;
  const keys = path.split('.');
  let current = obj;
  for (let i = 0; i < keys.length; i++) {
    if (current == null || typeof current !== 'object') return fallback;
    current = current[keys[i]];
  }
  return current !== undefined ? current : fallback;
}

// === CONFIG: Application Constants ===
const CONFIG = Object.freeze({
  IVA_RESERVA: 0.10,
  IVA_SUBTOTAL: 0.21,
  MAX_SHEET_ROWS: 10000,
  MAX_CONFIG_ROWS: 10000,
  MAX_AI_DETAIL_ROWS: 200,
  MAX_AI_HISTORY: 20,
  DEFAULT_PAGE_SIZE: 100,
  PAGE_SIZES: [100, 500, 1000],
  MAX_PAGINATION_BUTTONS: 7,
  DEBOUNCE_GLOBAL_CONFIG: 1500,
  DEBOUNCE_RESERVA_CONFIG: 1000,
  SYNC_SAVED_TIMEOUT: 2500,
  SYNC_ERROR_TIMEOUT: 5000,
  VERSION_TOAST_TIMEOUT: 12000,
  SHEET_HISTORY_MAX: 10,
  CONFIG_TAB_NAME: 'Configuracion',
  PROPIETARIOS_TAB_NAME: 'Propietarios',
  AI_MODEL: 'claude-sonnet-4-20250514',
  AI_MAX_TOKENS: 1024,
});


const CHANGELOG = [
  { version: '2.3.2', date: '2026-02-12T23:45:00+01:00', changes: [
    'Lista toggles 80/20 limitada a 20 alojamientos propiedad GTC',
    'Nueva lista _gtcOwnedAlojamientos persistida en Google Sheets (clave gtc_owned)',
    'Descripci\u00F3n actualizada: activa los vendidos, GTC retiene 20%'
  ]},
  { version: '2.3.1', date: '2026-02-12T23:30:00+01:00', changes: [
    'Selector visual de alojamientos 80/20 con toggles en pesta\u00F1a Configuraci\u00F3n > GTC',
    'Lista din\u00E1mica generada a partir de alojamientos cargados',
    'Contador de alojamientos activos con guardado autom\u00E1tico'
  ]},
  { version: '2.3.0', date: '2026-02-12T23:15:00+01:00', changes: [
    'Reparto 80/20 GTC: alojamientos con condici\u00F3n especial retienen 20% para GTC del Subtotal Reservas',
    'Caja violeta de reparto entre Subtotal Reservas y Conceptos Extraordinarios del Mes',
    'IRPF e IVA se calculan sobre Subtotal Final Mes (80% \u2212 conceptos ext.)',
    'Lista de alojamientos especiales persistida en pesta\u00F1a Configuraci\u00F3n de Google Sheets',
    'Versi\u00F3n impresa incluye desglose del reparto GTC/Propietario'
  ]},
  { version: '2.2.0', date: '2026-02-12T22:45:00+01:00', changes: [
    'Nuevo orden resumen consolidado: sigue orden columnas tabla (Amenities \u2192 Pasarela \u2192 C.E. Sin IVA)',
    'Nuevo Subtotal Reservas: subtotal intermedio que cierra deducciones por reserva',
    'Secci\u00F3n Conceptos Extraordinarios del Mes separada en caja verde',
    'Subtotal renombrado a Subtotal Final Mes para distinguir del Subtotal Reservas',
    'Versi\u00F3n impresa actualizada con nuevos nombres de subtotales'
  ]},
  { version: '2.1.1', date: '2026-02-12T22:15:00+01:00', changes: [
    'Fix: dropdown selector de columnas se cortaba en secci\u00F3n Liquidaci\u00F3n por overflow del contenedor',
    'A\u00F1adido max-height: 60vh con scroll al desplegable de columnas para evitar desbordamiento'
  ]},
  { version: '2.1.0', date: '2026-02-12T17:30:00+01:00', changes: [
    'Nueva columna C.E. (Sin IVA): conceptos especiales que restan directamente al subtotal',
    'Panel desplegable violeta con misma mec\u00E1nica que C.E. (IVA inc.) pero en base sin IVA',
    'Integrado en preliquidaciones, vista consolidada, detalle individual y vista de impresi\u00F3n',
    'Persistencia autom\u00E1tica en pesta\u00F1a Configuracion de Google Sheets',
    'C\u00E1lculo: sub = baseSinIVA \u2212 comPlat \u2212 comGTC \u2212 comPas \u2212 limp \u2212 amen \u2212 ceSinIva'
  ]},
  { version: '2.0.2', date: '2026-02-13T00:20:00+01:00', changes: [
    'Bloque VERSIONING RULES (SemVer) embebido en el c\u00F3digo con checklist obligatorio',
    'Memoria actualizada para forzar cumplimiento de versionado en cada entrega'
  ]},
  { version: '2.0.1', date: '2026-02-13T00:15:00+01:00', changes: [
    'Fix: addCEItem ahora persiste inmediatamente al a\u00F1adir concepto especial',
    'Persistencia write-first: datos se escriben antes de limpiar filas obsoletas',
    'Si la limpieza de filas residuales falla, los datos nuevos ya est\u00E1n seguros',
    'Eliminado riesgo de p\u00E9rdida de config si la red falla entre clear y update'
  ]},
  { version: '2.0.0', date: '2026-02-12T22:45:00+01:00', changes: [
    'Refactorizaci\u00F3n profunda del c\u00F3digo base para mayor robustez y mantenibilidad',
    'Nuevo objeto CONFIG centraliza todas las constantes de la aplicaci\u00F3n',
    'Nuevo objeto AppState unifica variables globales dispersas (60+ vars \u2192 1 objeto)',
    'Funci\u00F3n esc() para sanitizaci\u00F3n XSS en todos los templates HTML',
    'Deduplicaci\u00F3n: getSortValue() unificada para tabla principal y consolidada',
    'Deduplicaci\u00F3n: _buildFooterHtml() genera footer para ambas vistas',
    'Error handling robusto con try/catch y mensajes descriptivos en operaciones Google API',
    'Eliminado patr\u00F3n fr\u00E1gil processRows._lastValColIdx \u2192 retorno por objeto',
    'Conversi\u00F3n completa var \u2192 const/let en todo el c\u00F3digo',
    'SafeJSON: parsing JSON defensivo con fallback para datos corruptos',
    'Validaci\u00F3n de inputs en funciones cr\u00EDticas (changeSetting, processRows)',
    'Funciones de cache centralizadas en CacheManager',
    'Helpers: safeGet() para acceso seguro a propiedades anidadas',
    'Console logging mejorado con prefijos [Module] consistentes',
    'Correcci\u00F3n de potenciales memory leaks en event listeners'
  ]},
  { version: '1.9.1', date: '2026-02-11T01:12:00+01:00', changes: [
    'CE: eliminar concepto con animaci\u00F3n slide-out sin flash ni re-render',
    'CE: a\u00F1adir concepto con animaci\u00F3n slide-in + auto-focus',
    'Texto: "Totales" \u2192 "Reservas Totales" en barra de totales'
  ]},
  { version: '1.9.0', date: '2026-02-11T01:01:00+01:00', changes: [
    'Filtro de fecha multi-selecci\u00F3n: selecciona varios a\u00F1os y meses simult\u00E1neamente',
    'Combinatoria libre: Ene+Feb de 2025+2026, o un mes en 3 a\u00F1os, etc.',
    'Flechas \u2039 \u203A para navegar cuando hay selecci\u00F3n simple (1 a\u00F1o o 1 a\u00F1o+mes)',
    'Contador de reservas por mes agregado seg\u00FAn a\u00F1os seleccionados',
    'Fix: a\u00F1adir concepto CE suave \u2014 inserta DOM sin re-render + animaci\u00F3n slide-down',
    'Texto: "Totales" \u2192 "Reservas Totales" en barra de totales'
  ]},
  { version: '1.8.0', date: '2026-02-11T00:33:00+01:00', changes: [
    'Asistente Hist\u00F3rico Reservas: chat IA integrado con bot\u00F3n flotante y panel lateral',
    'Responde solo con datos reales cargados \u2014 nunca inventa cifras ni nombres',
    'Contexto completo: res\u00FAmenes por alojamiento, plataforma, mes, edificio, atendido por, tipo reserva',
    'Detalle por reserva: todos los campos del Sheet (ID, localizador, cliente, edificio, etc.)',
    'Desglose de liquidaci\u00F3n: base, comisiones, limpieza, amenities, CE, pasarela, subtotal',
    'System prompt estricto anti-alucinaciones con referencia a campos disponibles',
    'API Key se guarda localmente en el navegador (localStorage)',
    'Contexto inteligente: res\u00FAmenes cubren 100% reservas, detalle usa filtros activos (max 200)'
  ]},
  { version: '1.7.5', date: '2026-02-10T09:07:00+01:00', changes: [
    'Changelog muestra d\u00EDa, hora y segundos en horario Madrid (+01:00)',
    'Sidebar muestra hora real del deploy (primer acceso a la versi\u00F3n), no hora de build',
    'Meta tags anti-cach\u00E9: navegador siempre pide versi\u00F3n fresca al servidor',
    'Scrollbar permanente, fino (6px) y transparente \u2014 elimina sombra al abrir/cerrar CE',
    'Fix: modal config no salta al cambiar de tab (posici\u00F3n fija arriba + min-height)'
  ]},
  { version: '1.7.4', date: '2026-02-10T08:30:00+01:00', changes: [
    'Historial de versiones integrado en la app con enlace en sidebar',
    'Tab de configuraci\u00F3n renombrado: Servicio GTC / Limpieza / Amenities / Mant.',
    'Pesta\u00F1a "Impuestos" separada para IRPF',
    'Toast de nueva versi\u00F3n con lista de cambios y link a historial completo',
    'Toast m\u00E1s duradero (12s)',
    'Fix: toast no aparec\u00EDa al no cambiar string de versi\u00F3n',
    'Fix: doble-click necesario tras buscar (search input cambiaba de ancho al perder foco)',
    'Fix: micro-vibraci\u00F3n DOM con overflow-anchor y DocumentFragment'
  ]},
  { version: '1.7.3', date: '2026-02-10T08:00:00+01:00', changes: [
    'Renombrar "Plataforma" \u2192 "Canal de Venta" en cabeceras y detalle',
    'Reordenar secciones: Canal de Venta \u2192 GTC/Limpieza \u2192 Pasarela \u2192 Impuestos',
    'Fix: salto de scroll al hacer click con pocos resultados filtrados',
    'Fix: IDs de panel CE corregidos en _patchSingleRow (ce-ppanel-)'
  ]},
  { version: '1.7.2', date: '2026-02-10T07:20:00+01:00', changes: [
    'CE interactivo en vista consolidada (panel desplegable)',
    'Sistema de prefijo de vista (p/c) para evitar conflictos de IDs',
    'Toast de notificaci\u00F3n de nueva versi\u00F3n al arrancar',
    'Filtro mes/a\u00F1o por defecto al mes y a\u00F1o actual',
    'Deducciones mensuales (mantenimiento + extras) antes del subtotal',
    'Fix: limpieza e IRPF con valor 0\u20AC no se aplicaban (bug falsy)',
    'Fix: estilos consol-row mejorados'
  ]},
  { version: '1.7.1', date: '2026-02-09T19:30:00+01:00', changes: [
    'Integraci\u00F3n de propietarios desde Google Sheets con edici\u00F3n inline',
    'Columnas renombradas: Canal de Venta, Gesti\u00F3n GTC, Pasarela de pago',
    'Estado de validaci\u00F3n ordenable en la tabla',
    'Fix: filtrado por tab en configuraci\u00F3n'
  ]},
  { version: '1.7.0', date: '2026-02-09T18:40:00+01:00', changes: [
    'Conceptos Especiales (CE): panel inline con bot\u00F3n +/- por reserva',
    'CE se descuenta del total antes de calcular comisiones',
    'CE integrado en vista principal, consolidada, detalle e impresi\u00F3n',
    'Persistencia de CE en Google Sheets (tab Configuracion)',
    'B\u00FAsqueda mejorada: filtra tambi\u00E9n por importes y CE',
    'Fix: cabeceras de columna CE con tooltip',
    'Fix: comportamiento de click en bot\u00F3n CE',
    'Fix: persistencia de autenticaci\u00F3n Google entre sesiones'
  ]},
  { version: '1.6.1', date: '2026-02-09T16:23:00+01:00', changes: [
    'Amenities configurables por reserva (no solo global)',
    'Fix: tab Configuracion se filtraba incorrectamente en carga',
    'Fix: estado de carga atascado al cambiar de fuente',
    'Fix: correcciones de codificaci\u00F3n UTF-8 en textos espa\u00F1oles'
  ]},
  { version: '1.6.0', date: '2026-02-09T14:21:00+01:00', changes: [
    'Persistencia de configuraci\u00F3n en pesta\u00F1a "Configuracion" de Google Sheets',
    'Auto-guardado de opciones globales y ajustes por reserva',
    'Carga autom\u00E1tica de configuraci\u00F3n al conectar Google Sheets',
    'Debounce inteligente para minimizar escrituras API'
  ]},
  { version: '1.5.1', date: '2026-02-09T06:00:00+01:00', changes: [
    'Sincronizaci\u00F3n inmediata con indicadores visuales de estado',
    'B\u00FAsqueda de texto global en todas las vistas',
    'Mejoras en layout de columnas',
    'Escritura de validaciones directamente en Google Sheets'
  ]},
  { version: '1.5.0', date: '2026-02-08T21:00:00+01:00', changes: [
    'Write-back de estado de validaci\u00F3n a Google Sheets',
    'Detecci\u00F3n autom\u00E1tica de columna de validaci\u00F3n',
    'Operaciones batch para validar/desvalidar m\u00FAltiples reservas',
    'Paginaci\u00F3n con delta-updates para rendimiento O(1)',
    'Optimizaci\u00F3n de rendimiento para miles de reservas',
    'Integraci\u00F3n con Google Sheets v\u00EDa OAuth',
    'Deploy en GitHub Pages'
  ]},
  { version: '1.4.0', date: '2026-02-08T19:00:00+01:00', changes: [
    'Vista consolidada por alojamiento con resumen financiero',
    'Liquidaci\u00F3n individual con desglose completo',
    'Impresi\u00F3n optimizada de liquidaciones'
  ]},
  { version: '1.3.0', date: '2026-02-08T17:00:00+01:00', changes: [
    'Sistema de filtros combinados: plataforma, alojamiento, estado',
    'Filtro por mes/a\u00F1o con selector visual',
    'Ordenaci\u00F3n por m\u00FAltiples campos',
    'Tarjetas de estad\u00EDsticas con porcentajes filtrados'
  ]},
  { version: '1.2.0', date: '2026-02-08T15:00:00+01:00', changes: [
    'Pasarela de pago configurable (Stripe/Booking)',
    'Toggle de activaci\u00F3n/desactivaci\u00F3n por reserva',
    'Modal de configuraci\u00F3n con gesti\u00F3n de opciones',
    'C\u00E1lculo de IVA sobre subtotal'
  ]},
  { version: '1.1.0', date: '2026-02-08T13:00:00+01:00', changes: [
    'C\u00E1lculo de liquidaci\u00F3n: comisiones, limpieza, IRPF',
    'Vista de detalle individual por reserva',
    'Validaci\u00F3n de reservas con estado persistente',
    'Exportaci\u00F3n y carga de ficheros Excel'
  ]},
  { version: '1.0.0', date: '2026-02-08T11:00:00+01:00', changes: [
    'Versi\u00F3n inicial: carga de ficheros Excel de reservas',
    'Tabla de preliquidaciones con columnas configurables',
    'Sidebar de navegaci\u00F3n',
    'Dise\u00F1o responsive'
  ]}
];

// Mostrar versi\u00F3n en sidebar + toast si nueva versi\u00F3n
window.addEventListener('DOMContentLoaded', () => {
  const vl = document.getElementById('version-label');
  if (vl) {
    // Record actual deploy time (first load of this version)
    const deployKey = 'app-deploy-time-' + APP_VERSION;
    let deployTime = SafeStorage.get(deployKey);
    if (!deployTime) {
      deployTime = new Date().toISOString();
      SafeStorage.set(deployKey, deployTime);
    }
    const bd = new Date(deployTime);
    const bStr = bd.toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Europe/Madrid'});
    vl.textContent = APP_VERSION + ' (' + bStr + ')';
  }
  const lastSeen = SafeStorage.get('app-last-version');
  if (lastSeen && lastSeen !== APP_VERSION) {
    showVersionToast(lastSeen);
  }
  SafeStorage.set('app-last-version', APP_VERSION);
});

function showVersionToast(prevVersion) {
  const entry = CHANGELOG.find(c => c.version === APP_VERSION);
  const changesList = entry ? entry.changes.slice(0, 4).map(c => `<div style="font-size:11px;color:#cbd5e1;padding:2px 0 2px 12px;position:relative;line-height:1.4;"><span style="position:absolute;left:2px;color:#4f8cff;">\u2022</span>${c}</div>`).join('') : `<div style="font-size:12px;color:#cbd5e1;">${APP_CHANGES}</div>`;
  const moreCount = entry && entry.changes.length > 4 ? `<div style="font-size:11px;color:#64748b;margin-top:2px;">...y ${entry.changes.length - 4} m\u00E1s</div>` : '';
  const toast = document.createElement('div');
  toast.id = 'version-toast';
  toast.innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:12px;">
      <span style="font-size:22px;line-height:1;">&#x1F680;</span>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:14px;margin-bottom:6px;">Actualizaci\u00F3n v${APP_VERSION}</div>
        ${changesList}${moreCount}
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
          <span style="font-size:11px;color:#64748b;">Anterior: v${prevVersion}</span>
          <a href="#" onclick="event.preventDefault();closeVersionToast();showChangelog();" style="font-size:11px;color:#4f8cff;text-decoration:none;font-weight:600;">Ver historial completo \u2192</a>
        </div>
      </div>
      <button onclick="closeVersionToast()" style="background:none;border:none;color:#94a3b8;font-size:18px;cursor:pointer;padding:0;line-height:1;">&times;</button>
    </div>`;
  toast.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:99999;background:linear-gradient(135deg,#0f172a,#1e293b);color:#f1f5f9;padding:16px 20px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3),0 0 0 1px rgba(255,255,255,0.08);max-width:360px;min-width:280px;opacity:0;transform:translateY(20px);transition:all 0.4s cubic-bezier(0.16,1,0.3,1);font-family:inherit;';
  document.body.appendChild(toast);
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    });
  });
  setTimeout(() => closeVersionToast(), CONFIG.VERSION_TOAST_TIMEOUT);
}
function closeVersionToast() {
  const t = document.getElementById('version-toast');
  if (!t) return;
  t.style.opacity = '0';
  t.style.transform = 'translateY(20px)';
  setTimeout(() => t.remove(), 400);
}
function showVersionInfo() {
  showChangelog();
}

function showChangelog() {
  const body = document.getElementById('changelog-body');
  body.innerHTML = CHANGELOG.map((v, i) => {
    const isCurrent = v.version === APP_VERSION;
    const items = v.changes.map(c => `<li>${c}</li>`).join('');
    return `<div class="cl-version">
      <div class="cl-version-header">
        <span class="cl-badge${isCurrent ? ' current' : ''}">v${v.version}</span>
        <span class="cl-date">${new Date(v.date).toLocaleDateString('es-ES', {day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Europe/Madrid'})}</span>
        ${isCurrent ? '<span style="font-size:11px;color:#43a047;font-weight:600;">&#x2190; actual</span>' : ''}
      </div>
      <ul class="cl-changes">${items}</ul>
    </div>`;
  }).join('');
  document.getElementById('changelog-overlay').style.display = 'flex';
}

function closeChangelog() {
  document.getElementById('changelog-overlay').style.display = 'none';
}

// === CONFIGURACI\u00D3N GOOGLE \u2014 Sustituye con tus credenciales reales ===
const GOOGLE_CLIENT_ID = '658971789892-cnsnbr36hus5jablgkuj2qk8ipic5ptf.apps.googleusercontent.com';
const GOOGLE_API_KEY   = 'AIzaSyAqn7NyL_QRC97KW-huBjzZjTLPGpEoT-k';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';

// === GOOGLE STATE ===
let _gapiInited = false, _gisInited = false, _googleToken = null, _tokenClient = null;
let _pickerInited = false;
let _sheetHistory = [];
_sheetHistory = SafeStorage.getJSON('gsheet-history', []);
let _defaultSheetUrl = null;
_defaultSheetUrl = SafeStorage.get('gsheet-default-url', null);

function gapiLoaded() {
  gapi.load('client:picker', async () => {
    try {
      await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
      _gapiInited = true; _pickerInited = true;
      maybeEnableGoogleUI();
    } catch(e) { console.warn('gapi init error:', e); }
  });
}

function gisLoaded() {
  _tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID, scope: SCOPES, callback: onTokenResponse,
  });
  _gisInited = true;
  maybeEnableGoogleUI();
}

function maybeEnableGoogleUI() {
  if (_gapiInited && _gisInited) {
    // Auto re-auth silently if user was previously connected
    if (!_googleToken && _tokenClient) {
      try {
        if (SafeStorage.get('gsheet-connected') === '1') {
          _tokenClient.requestAccessToken({ prompt: '' });
        }
      } catch(e) { console.warn('[Auth] Auto-reconnect error:', e.message); }
    }
    renderSheetHistory();
    if (GOOGLE_CLIENT_ID === 'TU_CLIENT_ID.apps.googleusercontent.com') {
      const el = document.getElementById('gsheet-section');
      if (el) el.innerHTML = '<h3>&#128202; Google Sheets</h3>' +
        '<p style="color:#e53935;">Configura GOOGLE_CLIENT_ID y GOOGLE_API_KEY en el c\u00F3digo para activar esta funci\u00F3n. Consulta el README.md para instrucciones.</p>';
    }
  }
}

window.addEventListener('load', () => {
  if (typeof gapi !== 'undefined') gapiLoaded();
  else { const s = document.querySelector('script[src*="apis.google.com"]'); if (s) s.addEventListener('load', gapiLoaded); }
  if (typeof google !== 'undefined' && google.accounts) gisLoaded();
  else { const s = document.querySelector('script[src*="accounts.google.com"]'); if (s) s.addEventListener('load', () => setTimeout(gisLoaded, 100)); }
});

// === GOOGLE AUTH ===
function googleSignIn() {
  if (!_tokenClient) { alert('Google API no inicializada. Recarga la p\u00E1gina.'); return; }
  if (_googleToken) { updateGoogleStatus(true); return; }
  _tokenClient.requestAccessToken({ prompt: '' });
}
function onTokenResponse(resp) {
  if (resp.error) { console.error('Auth error:', resp); return; }
  _googleToken = resp;
  gapi.client.setToken(resp);
  SafeStorage.set('gsheet-connected', '1');
  updateGoogleStatus(true);
}
function googleSignOut() {
  if (_googleToken) { google.accounts.oauth2.revoke(_googleToken.access_token, () => {}); _googleToken = null; }
  SafeStorage.remove('gsheet-connected');
  updateGoogleStatus(false);
}
let _autoLoadAttempted = false;
function updateGoogleStatus(connected) {
  const statusEl = document.getElementById('gsheet-status');
  const labelEl = document.getElementById('gsheet-status-label');
  const btnC = document.getElementById('btn-google-connect');
  const btnD = document.getElementById('btn-google-disconnect');
  const picker = document.getElementById('gsheet-picker-area');
  const sidebar = document.getElementById('sidebar-google');
  const defaultArea = document.getElementById('gsheet-default-area');
  const noDefaultArea = document.getElementById('gsheet-no-default');
  if (connected) {
    statusEl.className = 'gsheet-status connected'; labelEl.textContent = 'Conectado con Google';
    btnC.style.display = 'none'; btnD.style.display = ''; picker.style.display = '';
    sidebar.style.display = 'block';
    document.getElementById('google-dot').className = 'status-dot on';
    document.getElementById('google-status-text').textContent = 'Google conectado';
    if (_defaultSheetUrl) {
      defaultArea.style.display = '';
      noDefaultArea.style.display = 'none';
      renderDefaultUrlDisplay();
      if (!_autoLoadAttempted && allReservas.length === 0) {
        _autoLoadAttempted = true;
        setTimeout(function() { autoLoadDefaultSheet(); }, 300);
      }
    } else {
      defaultArea.style.display = 'none';
      noDefaultArea.style.display = '';
    }
  } else {
    statusEl.className = 'gsheet-status disconnected'; labelEl.textContent = 'No conectado';
    btnC.style.display = ''; btnD.style.display = 'none'; picker.style.display = 'none';
    sidebar.style.display = 'none';
    defaultArea.style.display = 'none';
    noDefaultArea.style.display = 'none';
    document.getElementById('gsheet-autoload-status').style.display = 'none';
  }
  renderSheetHistory();
}

// === DEFAULT SHEET URL MANAGEMENT ===
function renderDefaultUrlDisplay() {
  const el = document.getElementById('default-url-display');
  if (!el || !_defaultSheetUrl) return;
  const short = _defaultSheetUrl.length > 80 ? _defaultSheetUrl.substring(0, 77) + '...' : _defaultSheetUrl;
  el.innerHTML = '<span style="color:#6b7280;font-size:12px;">URL:</span> ' + short;
}
function loadDefaultSheet() {
  if (!_defaultSheetUrl) return;
  const id = extractSheetId(_defaultSheetUrl);
  if (!id) { alert('La URL por defecto no es v\u00E1lida.'); return; }
  loadSheetById(id, 'Hoja por defecto');
}
function autoLoadDefaultSheet() {
  if (!_defaultSheetUrl || !_googleToken) return;
  let id = extractSheetId(_defaultSheetUrl);
  if (!id) return;
  const statusEl = document.getElementById('gsheet-autoload-status');
  statusEl.style.display = '';
  document.getElementById('autoload-status-text').textContent = 'Cargando hoja por defecto...';
  loadSheetById(id, 'Hoja por defecto');
}
function editDefaultUrl() {
  document.getElementById('default-url-display').style.display = 'none';
  document.getElementById('default-url-edit').style.display = '';
  document.getElementById('default-url-edit-input').value = _defaultSheetUrl || '';
  document.getElementById('default-url-edit-input').focus();
}
function cancelDefaultUrlEdit() {
  document.getElementById('default-url-display').style.display = '';
  document.getElementById('default-url-edit').style.display = 'none';
}
function saveDefaultUrlEdit() {
  const url = document.getElementById('default-url-edit-input').value.trim();
  if (!url) { alert('Introduce una URL v\u00E1lida.'); return; }
  let id = extractSheetId(url);
  if (!id) { alert('URL no v\u00E1lida. Debe ser una URL de Google Sheets.'); return; }
  _defaultSheetUrl = url;
  SafeStorage.set('gsheet-default-url', url);
  cancelDefaultUrlEdit();
  renderDefaultUrlDisplay();
  document.getElementById('gsheet-default-area').style.display = '';
  document.getElementById('gsheet-no-default').style.display = 'none';
}
function clearDefaultUrl() {
  if (!confirm('\u00BFQuitar la hoja por defecto?')) return;
  _defaultSheetUrl = null;
  SafeStorage.remove('gsheet-default-url');
  document.getElementById('gsheet-default-area').style.display = 'none';
  if (_googleToken) document.getElementById('gsheet-no-default').style.display = '';
}
function showSetDefaultUrl() {
  const form = document.getElementById('set-default-url-form');
  form.style.display = form.style.display === 'none' ? '' : 'none';
  if (form.style.display !== 'none') document.getElementById('set-default-url-input').focus();
}
function saveNewDefaultUrl() {
  const url = document.getElementById('set-default-url-input').value.trim();
  if (!url) { alert('Introduce una URL v\u00E1lida.'); return; }
  let id = extractSheetId(url);
  if (!id) { alert('URL no v\u00E1lida. Debe ser una URL de Google Sheets.'); return; }
  _defaultSheetUrl = url;
  SafeStorage.set('gsheet-default-url', url);
  document.getElementById('set-default-url-form').style.display = 'none';
  document.getElementById('set-default-url-input').value = '';
  document.getElementById('gsheet-no-default').style.display = 'none';
  document.getElementById('gsheet-default-area').style.display = '';
  renderDefaultUrlDisplay();
}

// === GOOGLE PICKER ===
function getAppId() {
  const m = GOOGLE_CLIENT_ID.match(/^(\d+)/);
  return m ? m[1] : '';
}
function openGooglePicker() {
  if (!_pickerInited || !_googleToken) { alert('Inicia sesi\u00F3n con Google primero.'); return; }
  const view = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS).setIncludeFolders(true).setSelectFolderEnabled(false);
  const sharedView = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS).setIncludeFolders(true).setOwnedByMe(false);
  const picker = new google.picker.PickerBuilder()
    .enableFeature(google.picker.Feature.NAV_HIDDEN)
    .setTitle('Selecciona la hoja de reservas')
    .addView(view).addView(sharedView)
    .setOAuthToken(_googleToken.access_token)
    .setDeveloperKey(GOOGLE_API_KEY)
    .setAppId(getAppId())
    .setCallback(onPickerCallback)
    .setSize(900, 550).build();
  picker.setVisible(true);
}
function onPickerCallback(data) {
  if (data.action === google.picker.Action.PICKED) {
    const doc = data.docs[0]; loadSheetById(doc.id, doc.name);
  }
}

// === LOAD FROM URL ===
function loadFromUrl() {
  const url = document.getElementById('gsheet-url-input').value.trim();
  if (!url) { alert('Pega la URL de la hoja de Google Sheets'); return; }
  const id = extractSheetId(url);
  if (!id) { alert('URL no v\u00E1lida. Debe ser una URL de Google Sheets.'); return; }
  loadSheetById(id, 'Google Sheet');
}
function extractSheetId(url) {
  const m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  if (m) return m[1];
  if (/^[a-zA-Z0-9_-]{20,}$/.test(url)) return url;
  return null;
}

// === LOAD SHEET DATA ===
async function loadSheetById(sheetId, sheetName) {
  if (!_googleToken) { alert('Inicia sesi\u00F3n con Google primero.'); return; }
  showGSheetLoading('Obteniendo informaci\u00F3n de la hoja...');
  try {
    const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: sheetId, fields: 'properties.title,sheets.properties' });
    const title = meta.result.properties.title;
    const sheets = meta.result.sheets.map(s => ({ name: s.properties.title, index: s.properties.index }));
    const dataSheets = sheets.filter(s => s.name !== CONFIG_TAB_NAME && s.name !== PROPIETARIOS_TAB_NAME);
    if (dataSheets.length === 0) { hideGSheetLoading(); alert('No se encontraron hojas de datos.'); return; }
    if (dataSheets.length === 1) { await loadSheetData(sheetId, dataSheets[0].name, title); }
    else { hideGSheetLoading(); showSheetSelector(sheetId, dataSheets, title); }
  } catch(e) {
    hideGSheetLoading();
    const errMsg = safeGet(e, 'result.error.message', '');
    console.error('[GSheets] Error loading sheet:', errMsg || e);
    alert(errMsg ? 'Error de Google Sheets: ' + errMsg : 'Error al cargar la hoja. Verifica que tienes acceso y que la URL es correcta.');
  }
}
function showSheetSelector(sheetId, sheets, title) {
  const sel = document.getElementById('gsheet-sheets-selector');
  const list = document.getElementById('gsheet-sheets-list');
  sel.style.display = '';
  list.innerHTML = '';
  const visibleSheets = sheets.filter(s => s.name !== CONFIG_TAB_NAME && s.name !== PROPIETARIOS_TAB_NAME);
  visibleSheets.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline btn-sm';
    btn.textContent = s.name;
    btn.addEventListener('click', () => selectSheetTab(sheetId, s.name, title + ' / ' + s.name));
    list.appendChild(btn);
  });
}
async function selectSheetTab(sheetId, sheetTab, title) {
  document.getElementById('gsheet-sheets-selector').style.display = 'none';
  await loadSheetData(sheetId, sheetTab, title + ' / ' + sheetTab);
}
async function loadSheetData(sheetId, sheetTab, displayName) {
  showGSheetLoading('Leyendo datos de "' + displayName + '"...');
  try {
    const range = sheetTab + '!A1:Z10000';
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: sheetId, range: range,
      valueRenderOption: 'UNFORMATTED_VALUE', dateTimeRenderOption: 'SERIAL_NUMBER'
    });
    const rows = resp.result.values;
    if (!rows || rows.length < 2) { hideGSheetLoading(); alert('La hoja est\u00E1 vac\u00EDa o no tiene datos suficientes.'); return; }
    showGSheetLoading('Procesando ' + (rows.length - 1) + ' filas...');
    if (!processRows(rows)) { hideGSheetLoading(); return; }

    // Set up sheet source for write-back
    const lastResult = processRows._lastResult || {};
    const valColIdx = lastResult.valColIdx !== undefined ? lastResult.valColIdx : null;
    const headerRowIdx = lastResult.headerRow !== undefined ? lastResult.headerRow : 0;
    await setupSheetSource(sheetId, sheetTab, headerRowIdx, valColIdx);

    // Load or create config tab for persistence
    await loadOrCreateConfigTab(sheetId);

    // Load propietarios mapping
    await loadPropietariosTab(sheetId);

    addToSheetHistory(sheetId, displayName, sheetTab);
    document.getElementById("file-name").textContent = '\u{1F4CA} ' + displayName;
    document.getElementById("file-indicator").style.display = "block";
    document.getElementById("nav-consol").style.display = "block";
    updateSyncIndicator('idle');
    hideGSheetLoading(); showScreen("list"); renderTable();
  } catch(e) {
    hideGSheetLoading();
    const errMsg = safeGet(e, 'result.error.message', '');
    console.error('[GSheets] Error reading sheet data:', errMsg || e);
    alert(errMsg ? 'Error al leer datos: ' + errMsg : 'Error al leer los datos de la hoja. Comprueba los permisos.');
  }
}

// === LOADING UI ===
function showGSheetLoading(text) { document.getElementById('gsheet-loading').style.display = 'flex'; document.getElementById('gsheet-loading-text').textContent = text || 'Cargando...'; }
function hideGSheetLoading() { document.getElementById('gsheet-loading').style.display = 'none'; document.getElementById('gsheet-autoload-status').style.display = 'none'; }

// === SHEET WRITE-BACK: Validation column ===
function colIndexToLetter(idx) {
  let s = '';
  idx = Math.max(0, idx);
  while (true) {
    s = String.fromCharCode(65 + (idx % 26)) + s;
    idx = Math.floor(idx / 26) - 1;
    if (idx < 0) break;
  }
  return s;
}

async function setupSheetSource(sheetId, sheetTab, headerRowIdx, valColIdx) {
  if (valColIdx !== null) {
    // Column already exists
    _sheetSource = {
      id: sheetId,
      tab: sheetTab,
      valColIdx: valColIdx,
      valColLetter: colIndexToLetter(valColIdx),
      headerRow: headerRowIdx
    };
    console.log('[Sync] Validation column found at ' + _sheetSource.valColLetter + ' (index ' + valColIdx + ')');
    return;
  }

  // Column doesn't exist \u2014 create it after the last used column
  // Find the max column used in header row
  const headerResp = await gapi.client.sheets.spreadsheets.values.get({
    spreadsheetId: sheetId,
    range: sheetTab + '!' + (headerRowIdx + 1) + ':' + (headerRowIdx + 1),
    valueRenderOption: 'UNFORMATTED_VALUE'
  });
  const headerVals = (headerResp.result.values && headerResp.result.values[0]) || [];
  const newColIdx = headerVals.length; // next empty column
  const newColLetter = colIndexToLetter(newColIdx);

  // Write the header "Validada"
  await gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId: sheetId,
    range: sheetTab + '!' + newColLetter + (headerRowIdx + 1),
    valueInputOption: 'RAW',
    resource: { values: [['Validada']] }
  });

  _sheetSource = {
    id: sheetId,
    tab: sheetTab,
    valColIdx: newColIdx,
    valColLetter: newColLetter,
    headerRow: headerRowIdx
  };
  console.log('[Sync] Created validation column at ' + newColLetter + ' (index ' + newColIdx + ')');
}

async function writeValidationToSheet(reservaIdx, isValidated) {
  if (!_sheetSource || !_googleToken) return;
  const r = allReservas[reservaIdx];
  if (!r) return;
  const cell = _sheetSource.tab + '!' + _sheetSource.valColLetter + r._sheetRow;
  const value = isValidated ? 'S\u00ED' : '';
  updateSyncIndicator('syncing');
  try {
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: _sheetSource.id,
      range: cell,
      valueInputOption: 'RAW',
      resource: { values: [[value]] }
    });
    updateSyncIndicator('saved');
    console.log('[Sync] Wrote ' + (isValidated ? 'S\u00ED' : '(empty)') + ' to ' + cell);
  } catch(e) {
    console.error('[Sync] Error writing to ' + cell + ':', e);
    updateSyncIndicator('error');
  }
}

async function batchWriteValidation(reservaIndices, isValidated) {
  if (!_sheetSource || !_googleToken || reservaIndices.length === 0) return;
  updateSyncIndicator('syncing');
  const value = isValidated ? 'S\u00ED' : '';
  const data = reservaIndices.map(idx => {
    const r = allReservas[idx];
    if (!r) return null;
    return {
      range: _sheetSource.tab + '!' + _sheetSource.valColLetter + r._sheetRow,
      values: [[value]]
    };
  }).filter(Boolean);

  if (data.length === 0) { updateSyncIndicator('idle'); return; }

  try {
    await gapi.client.sheets.spreadsheets.values.batchUpdate({
      spreadsheetId: _sheetSource.id,
      resource: {
        valueInputOption: 'RAW',
        data: data
      }
    });
    updateSyncIndicator('saved');
    console.log('[Sync] Batch wrote ' + data.length + ' cells (' + (isValidated ? 'validar' : 'desvalidar') + ')');
  } catch(e) {
    console.error('[Sync] Batch write error:', e);
    updateSyncIndicator('error');
  }
}

// Sync status indicator
function updateSyncIndicator(state) {
  const el = document.getElementById('sync-indicator');
  if (!el) return;
  if (!_sheetSource) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  const dot = el.querySelector('.sync-dot');
  const text = el.querySelector('.sync-text');
  switch(state) {
    case 'syncing':
      dot.className = 'sync-dot syncing';
      text.textContent = 'Guardando...';
      break;
    case 'saved':
      dot.className = 'sync-dot saved';
      text.textContent = 'Guardado';
      // Fade back to idle after 2s
      clearTimeout(el._fadeTimer);
      el._fadeTimer = setTimeout(() => updateSyncIndicator('idle'), 2500);
      break;
    case 'error':
      dot.className = 'sync-dot error';
      text.textContent = 'Error al guardar';
      clearTimeout(el._fadeTimer);
      el._fadeTimer = setTimeout(() => updateSyncIndicator('idle'), 5000);
      break;
    default: // idle
      dot.className = 'sync-dot idle';
      text.textContent = 'Sincronizado';
      break;
  }
}


// === CONFIG PERSISTENCE: "Configuracion" tab in Google Sheets ===
const CONFIG_TAB_NAME = CONFIG.CONFIG_TAB_NAME;
const PROPIETARIOS_TAB_NAME = CONFIG.PROPIETARIOS_TAB_NAME;
let _propietariosMap = {}; // alojamiento code (normalized) -> propietario name
let _propietariosKeys = []; // sorted by length desc for best match
let _propietariosRowMap = {}; // alojamiento code (normalized) -> sheet row number (1-based)
let _propietariosSheetId = null;

function getPropietario(alojamiento) {
  if (!alojamiento) return 'Falta propietario';
  const key = alojamiento.trim().toLowerCase();
  if (_propietariosMap[key]) return _propietariosMap[key];
  for (let i = 0; i < _propietariosKeys.length; i++) {
    if (key.indexOf(_propietariosKeys[i]) !== -1) return _propietariosMap[_propietariosKeys[i]];
  }
  return 'Falta propietario';
}

function _getPropietarioKey(alojamiento) {
  if (!alojamiento) return null;
  const key = alojamiento.trim().toLowerCase();
  if (_propietariosMap[key]) return key;
  for (let i = 0; i < _propietariosKeys.length; i++) {
    if (key.indexOf(_propietariosKeys[i]) !== -1) return _propietariosKeys[i];
  }
  return null;
}

async function savePropietario(alojamiento, newName) {
  const matchedKey = _getPropietarioKey(alojamiento);
  if (!_propietariosSheetId || !_googleToken) return false;
  try {
    if (matchedKey && _propietariosRowMap[matchedKey]) {
      // Update existing row
      const row = _propietariosRowMap[matchedKey];
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: _propietariosSheetId,
        range: PROPIETARIOS_TAB_NAME + '!B' + row,
        valueInputOption: 'RAW'
      }, { values: [[newName]] });
      _propietariosMap[matchedKey] = newName;
    } else {
      // New entry: find alojamiento code from the full name
      const code = alojamiento.trim();
      const codeKey = code.toLowerCase();
      // Append new row
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: _propietariosSheetId,
        range: PROPIETARIOS_TAB_NAME + '!A:B',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS'
      }, { values: [[code, newName]] });
      _propietariosMap[codeKey] = newName;
      // Estimate new row number
      let maxRow = 1;
      for (const k in _propietariosRowMap) { if (_propietariosRowMap[k] > maxRow) maxRow = _propietariosRowMap[k]; }
      _propietariosRowMap[codeKey] = maxRow + 1;
      _propietariosKeys = Object.keys(_propietariosMap).sort(function(a, b) { return b.length - a.length; });
    }
    return true;
  } catch(e) { console.error('[Propietarios] Error saving:', e); return false; }
}

function editPropietarioInline(alojamiento, el) {
  let current = getPropietario(alojamiento);
  if (current === 'Falta propietario') current = '';
  const inp = document.createElement('input');
  inp.type = 'text'; inp.value = current;
  inp.style.cssText = 'font-size:inherit;font-weight:700;border:2px solid #3b82f6;border-radius:6px;padding:4px 8px;width:100%;max-width:350px;outline:none;';
  const container = el.parentNode;
  const original = el;
  container.replaceChild(inp, original);
  inp.focus(); inp.select();

  let saving = false;
  async function doSave() {
    if (saving) return; saving = true;
    const val = inp.value.trim();
    if (!val) val = current; // revert if empty
    if (val !== current) {
      inp.disabled = true; inp.style.opacity = '0.5';
      const ok = await savePropietario(alojamiento, val);
      if (!ok) { alert('Error al guardar. \u00BFEst\u00E1s conectado a Google Sheets?'); }
    }
    // Rebuild element
    const span = document.createElement('span');
    span.className = original.className;
    const prop = getPropietario(alojamiento);
    span.textContent = prop;
    span.title = 'Clic para editar propietario';
    span.style.cursor = 'pointer';
    if (prop === 'Falta propietario') span.style.color = '#e53935';
    span.onclick = function() { editPropietarioInline(alojamiento, span); };
    container.replaceChild(span, inp);
  }
  inp.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); doSave(); } if (e.key === 'Escape') { saving = true; container.replaceChild(original, inp); } });
  inp.addEventListener('blur', function() { setTimeout(doSave, 100); });
}

async function loadPropietariosTab(sheetId) {
  _propietariosMap = {};
  _propietariosRowMap = {};
  _propietariosSheetId = sheetId;
  try {
    const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: sheetId, fields: 'sheets.properties' });
    const sheets = meta.result.sheets || [];
    const hasTab = sheets.some(function(s) { return s.properties.title === PROPIETARIOS_TAB_NAME; });
    if (!hasTab) { console.log('[Propietarios] No tab found'); return; }
    const resp = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: sheetId, range: PROPIETARIOS_TAB_NAME + '!A1:B1000',
      valueRenderOption: 'FORMATTED_VALUE'
    });
    const rows = resp.result.values;
    if (!rows || rows.length < 2) return;
    for (let i = 1; i < rows.length; i++) {
      const aloj = (rows[i][0] || '').trim();
      const prop = (rows[i][1] || '').trim();
      if (aloj) {
        const k = aloj.toLowerCase();
        _propietariosMap[k] = prop || '';
        _propietariosRowMap[k] = i + 1; // 1-based sheet row
      }
    }
    console.log('[Propietarios] Loaded:', Object.keys(_propietariosMap).length);
    _propietariosKeys = Object.keys(_propietariosMap).sort(function(a, b) { return b.length - a.length; });
  } catch(e) { console.warn('Error loading Propietarios tab:', e); }
}
let _configLoaded = false; // true after config has been loaded/created for current sheet

// Debounce timers for saving
let _globalConfigSaveTimer = null;
let _reservaConfigSaveTimer = null;
let _pendingReservaConfigSaves = new Set();

function scheduleGlobalConfigSave() {
  if (!_sheetSource || !_googleToken) return;
  if (_globalConfigSaveTimer) clearTimeout(_globalConfigSaveTimer);
  _globalConfigSaveTimer = setTimeout(saveGlobalConfigToSheet, 1500);
}

function scheduleReservaConfigSave(idx) {
  if (!_sheetSource || !_googleToken) return;
  _pendingReservaConfigSaves.add(idx);
  if (_reservaConfigSaveTimer) clearTimeout(_reservaConfigSaveTimer);
  _reservaConfigSaveTimer = setTimeout(flushReservaConfigSaves, 1000);
}

// Build global config data as key-value rows
function buildGlobalConfigRows() {
  const rows = [];
  Object.keys(platformOptions).sort().forEach(function(name) {
    rows.push(['plataforma:' + name, platformOptions[name].join(',')]);
  });
  rows.push(['pasarela_stripe', pasarelaStripeOptions.join(',')]);
  rows.push(['pasarela_booking', pasarelaBookingOptions.join(',')]);
  rows.push(['limpieza', cleaningOptions.join(',')]);
  rows.push(['irpf', irpfOptions.join(',')]);
  rows.push(['gtc', gtcOptions.join(',')]);
  rows.push(['amenities', amenitiesOptions.join(',')]);
  rows.push(['mantenimiento', maintenanceOptions.join(',')]);
  rows.push(['gtc_split', _gtcSplitAlojamientos.join(',')]);
  rows.push(['gtc_owned', _gtcOwnedAlojamientos.join(',')]);
  // Per-consolidation monthly deductions
  Object.keys(_consolMaint).forEach(function(k) {
    const m = _consolMaint[k];
    rows.push(['maint:' + k, (m.enabled?'1':'0') + ',' + m.amount]);
  });
  Object.keys(_consolExtras).forEach(function(k) {
    const exs = _consolExtras[k];
    if (exs.length > 0) {
      rows.push(['extras:' + k, JSON.stringify(exs)]);
    }
  });
  return rows;
}

// Build per-reservation config rows
function buildReservaConfigRows(indices) {
  const rows = [];
  const list = indices ? [...indices] : allReservas.map(function(r) { return r.idx; });
  list.forEach(function(idx) {
    const r = allReservas[idx];
    const s = settings[idx];
    if (!r || !s) return;
    rows.push([
      r.id,
      s.comPlataforma !== undefined ? s.comPlataforma : '',
      s.comGTC !== undefined ? s.comGTC : '',
      s.limpieza !== undefined ? s.limpieza : '',
      s.amenities !== undefined ? s.amenities : '',
      s.irpf !== undefined ? s.irpf : '',
      s.pasarela ? 'true' : 'false',
      s.pasarelaRate !== undefined ? s.pasarelaRate : '',
      (s.conceptosEspeciales && s.conceptosEspeciales.length > 0) ? JSON.stringify(s.conceptosEspeciales) : '',
      (s.conceptosSinIVA && s.conceptosSinIVA.length > 0) ? JSON.stringify(s.conceptosSinIVA) : ''
    ]);
  });
  return rows;
}

// Full build of the Configuracion tab content
function buildFullConfigTabData() {
  const data = [];
  data.push(['Configuracion', 'Liquidaciones App', 'v' + APP_VERSION]);
  data.push([]);
  data.push(['OPCIONES GLOBALES']);
  data.push(['Clave', 'Valor']);
  let globalRows = buildGlobalConfigRows();
  globalRows.forEach(function(row) { data.push(row); });
  data.push([]);
  data.push(['AJUSTES POR RESERVA']);
  data.push(['ID Reserva', 'comPlataforma', 'comGTC', 'limpieza', 'amenities', 'irpf', 'pasarela', 'pasarelaRate', 'conceptosEspeciales', 'conceptosSinIVA']);
  let reservaRows = buildReservaConfigRows();
  reservaRows.forEach(function(row) { data.push(row); });
  return data;
}

// Load or create the Configuracion tab
async function loadOrCreateConfigTab(sheetId) {
  if (!_googleToken) return;
  _configLoaded = false;
  try {
    console.log('[Config] Loading config tab...');
    const meta = await gapi.client.sheets.spreadsheets.get({
      spreadsheetId: sheetId,
      fields: 'sheets.properties.title'
    });
    const tabExists = meta.result.sheets.some(function(s) {
      return s.properties.title === CONFIG_TAB_NAME;
    });

    if (tabExists) {
      const resp = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: sheetId,
        range: CONFIG_TAB_NAME + '!A1:I' + CONFIG.MAX_CONFIG_ROWS,
        valueRenderOption: 'UNFORMATTED_VALUE'
      });
      const rows = resp.result.values || [];
      applyConfigFromRows(rows);
      _configLoaded = true;
      console.log('[Config] Loaded config from "' + CONFIG_TAB_NAME + '" tab (' + rows.length + ' rows)');
    } else {
      await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: sheetId,
        resource: {
          requests: [{ addSheet: { properties: { title: CONFIG_TAB_NAME } } }]
        }
      });
      const data = buildFullConfigTabData();
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: sheetId,
        range: CONFIG_TAB_NAME + '!A1',
        valueInputOption: 'RAW',
        resource: { values: data }
      });
      _configLoaded = true;
      console.log('[Config] Created "' + CONFIG_TAB_NAME + '" tab with ' + data.length + ' rows');
    }
  } catch(e) {
    console.warn('[Config] Error loading/creating config tab:', e);
  }
}

// Parse config rows and apply to app state
function applyConfigFromRows(rows) {
  if (!rows || rows.length < 4) return;

  let globalStart = -1, reservaHeaderRow = -1;
  for (let i = 0; i < rows.length; i++) {
    const cell = String(rows[i][0] || '').trim();
    if (cell === 'Clave' && globalStart === -1) { globalStart = i + 1; }
    if (cell === 'ID Reserva') { reservaHeaderRow = i; break; }
  }

  // Parse global options
  if (globalStart >= 0) {
    const endRow = reservaHeaderRow > 0 ? reservaHeaderRow : rows.length;
    let newPlatformOptions = {};
    let newPasStripe = null, newPasBooking = null, newLimpieza = null;
    let newIrpf = null, newGtc = null, newAmenities = null;

    for (let i = globalStart; i < endRow; i++) {
      const key = String(rows[i][0] || '').trim();
      const val = String(rows[i][1] || '').trim();
      if (!key || !val) continue;

      if (key.startsWith('plataforma:')) {
        const platName = key.substring(11);
        const nums = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
        if (nums.length > 0) newPlatformOptions[platName] = nums;
      } else if (key === 'pasarela_stripe') {
        newPasStripe = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'pasarela_booking') {
        newPasBooking = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'limpieza') {
        newLimpieza = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'irpf') {
        newIrpf = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'gtc') {
        newGtc = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'amenities') {
        newAmenities = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
      } else if (key === 'mantenimiento') {
        const newMaint = val.split(',').map(function(v) { return parseFloat(v.trim()); }).filter(function(v) { return !isNaN(v); });
        if (newMaint.length > 0) maintenanceOptions = newMaint;
      } else if (key === 'gtc_split') {
        const splitList = val.split(',').map(function(v) { return v.trim(); }).filter(Boolean);
        if (splitList.length > 0) _gtcSplitAlojamientos = splitList;
      } else if (key === 'gtc_owned') {
        const ownedList = val.split(',').map(function(v) { return v.trim(); }).filter(Boolean);
        if (ownedList.length > 0) _gtcOwnedAlojamientos = ownedList;
      } else if (key.startsWith('maint:')) {
        const maintAloj = key.substring(6);
        const parts = val.split(',');
        _consolMaint[maintAloj] = { enabled: parts[0] === '1', amount: parseFloat(parts[1]) || maintenanceOptions[0] };
      } else if (key.startsWith('extras:')) {
        const extAloj = key.substring(7);
        try { _consolExtras[extAloj] = JSON.parse(val); } catch(e) { _consolExtras[extAloj] = []; }
      }
    }

    // Apply global options (merge with platforms from data)
    if (Object.keys(newPlatformOptions).length > 0) {
      Object.keys(platformOptions).forEach(function(p) {
        if (!newPlatformOptions[p]) newPlatformOptions[p] = platformOptions[p];
      });
      platformOptions = newPlatformOptions;
    }
    if (newPasStripe && newPasStripe.length > 0) pasarelaStripeOptions = newPasStripe;
    if (newPasBooking && newPasBooking.length > 0) pasarelaBookingOptions = newPasBooking;
    if (newLimpieza && newLimpieza.length > 0) cleaningOptions = newLimpieza;
    if (newIrpf && newIrpf.length > 0) irpfOptions = newIrpf;
    if (newGtc && newGtc.length > 0) gtcOptions = newGtc;
    if (newAmenities !== null && newAmenities.length > 0) amenitiesOptions = newAmenities;

    console.log('[Config] Applied global options: ' + Object.keys(platformOptions).length + ' plataformas');
  }

  // Parse per-reservation settings
  if (reservaHeaderRow >= 0) {
    // Detect column positions from header row (backwards compatible)
    const hdr = rows[reservaHeaderRow].map(function(c) { return String(c || '').trim(); });
    const colMap = {};
    hdr.forEach(function(name, idx) { colMap[name] = idx; });
    const idCol = colMap['ID Reserva'] !== undefined ? colMap['ID Reserva'] : 0;
    const cpCol = colMap['comPlataforma'];
    const cgCol = colMap['comGTC'];
    const lmCol = colMap['limpieza'];
    const amCol = colMap['amenities'];
    const irCol = colMap['irpf'];
    const paCol = colMap['pasarela'];
    const prCol = colMap['pasarelaRate'];
    const ceCol = colMap['conceptosEspeciales'];
    const ce2Col = colMap['conceptosSinIVA'];

    const reservaMap = {};
    allReservas.forEach(function(r) { reservaMap[r.id] = r.idx; });

    let applied = 0;
    for (let i = reservaHeaderRow + 1; i < rows.length; i++) {
      const id = String(rows[i][idCol] || '').trim();
      if (!id) continue;
      let rIdx = reservaMap[id];
      if (rIdx === undefined) continue;

      let s = settings[rIdx];
      if (!s) continue;

      if (cpCol !== undefined) { let v = rows[i][cpCol]; if (v !== undefined && v !== '') s.comPlataforma = parseFloat(v); }
      if (cgCol !== undefined) { let v = rows[i][cgCol]; if (v !== undefined && v !== '') s.comGTC = parseFloat(v); }
      if (lmCol !== undefined) { let v = rows[i][lmCol]; if (v !== undefined && v !== '') s.limpieza = parseFloat(v); }
      if (amCol !== undefined) { let v = rows[i][amCol]; if (v !== undefined && v !== '') { const av = parseFloat(v); if (!isNaN(av) && amenitiesOptions.some(function(o){return Math.abs(o-av)<0.001;})) s.amenities = av; } }
      if (irCol !== undefined) { let v = rows[i][irCol]; if (v !== undefined && v !== '') s.irpf = parseFloat(v); }
      if (paCol !== undefined) { let v = rows[i][paCol]; if (v !== undefined && v !== '') s.pasarela = String(v).trim() === 'true'; }
      if (prCol !== undefined) { let v = rows[i][prCol]; if (v !== undefined && v !== '') s.pasarelaRate = parseFloat(v); }
      if (ceCol !== undefined) { let v = String(rows[i][ceCol] || '').trim(); if (v) { try { const parsed = JSON.parse(v); if (Array.isArray(parsed)) s.conceptosEspeciales = parsed.filter(function(item){return item && typeof item.amount === 'number';}); } catch(e) { console.warn('[Config] Invalid CE JSON for row', i, e.message); } } }
      if (ce2Col !== undefined) { let v = String(rows[i][ce2Col] || '').trim(); if (v) { try { const parsed = JSON.parse(v); if (Array.isArray(parsed)) s.conceptosSinIVA = parsed.filter(function(item){return item && typeof item.amount === 'number';}); } catch(e) { console.warn('[Config] Invalid CE2 JSON for row', i, e.message); } } }

      applied++;
    }
    console.log('[Config] Applied per-reservation settings: ' + applied + ' reservas');

    // Sanitize: reset any amenities value that isn't in amenitiesOptions
    let sanitized = 0;
    allReservas.forEach(function(r) {
      let s = settings[r.idx];
      if (s && s.amenities !== undefined && !amenitiesOptions.some(function(o){return Math.abs(o-s.amenities)<0.001;})) {
        s.amenities = amenitiesOptions[0];
        sanitized++;
      }
    });
    if (sanitized > 0) console.log('[Config] Sanitized ' + sanitized + ' reservas with invalid amenities value');
  }

  // Rebuild caches after applying config
  rebuildSelectCache();
  invalidateCache();
}

// Save full global config to sheet (write-first for safety)
async function saveGlobalConfigToSheet() {
  if (!_sheetSource || !_googleToken || !_configLoaded) return;
  updateSyncIndicator('syncing');
  try {
    let data = buildFullConfigTabData();
    // Write new data first (safe: if clear fails, data is already saved)
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A1',
      valueInputOption: 'RAW',
      resource: { values: data }
    });
    // Clear any stale rows below the new data
    const clearFrom = data.length + 1;
    await gapi.client.sheets.spreadsheets.values.clear({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A' + clearFrom + ':I' + CONFIG.MAX_CONFIG_ROWS
    }).catch(function(e) { console.warn('[Config] Non-critical: clear stale rows failed', e); });
    updateSyncIndicator('saved');
    console.log('[Config] Saved full config (' + data.length + ' rows)');
  } catch(e) {
    console.error('[Config] Error saving config:', e);
    updateSyncIndicator('error');
  }
}

// Flush pending per-reservation config saves (write-first for safety)
async function flushReservaConfigSaves() {
  if (!_sheetSource || !_googleToken || !_configLoaded) return;
  if (_pendingReservaConfigSaves.size === 0) return;

  const indices = [..._pendingReservaConfigSaves];
  _pendingReservaConfigSaves.clear();

  updateSyncIndicator('syncing');
  try {
    let data = buildFullConfigTabData();
    // Write new data first (safe: if clear fails, data is already saved)
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A1',
      valueInputOption: 'RAW',
      resource: { values: data }
    });
    // Clear any stale rows below the new data
    const clearFrom = data.length + 1;
    await gapi.client.sheets.spreadsheets.values.clear({
      spreadsheetId: _sheetSource.id,
      range: CONFIG_TAB_NAME + '!A' + clearFrom + ':I' + CONFIG.MAX_CONFIG_ROWS
    }).catch(function(e) { console.warn('[Config] Non-critical: clear stale rows failed', e); });
    updateSyncIndicator('saved');
    console.log('[Config] Saved config for ' + indices.length + ' reserva(s)');
  } catch(e) {
    console.error('[Config] Error saving reserva config:', e);
    updateSyncIndicator('error');
  }
}

// === SHEET HISTORY ===
function addToSheetHistory(sheetId, name, sheetTab) {
  _sheetHistory = _sheetHistory.filter(h => h.id !== sheetId || h.tab !== sheetTab);
  _sheetHistory.unshift({ id: sheetId, name, tab: sheetTab, date: new Date().toISOString() });
  if (_sheetHistory.length > CONFIG.SHEET_HISTORY_MAX) _sheetHistory = _sheetHistory.slice(0, CONFIG.SHEET_HISTORY_MAX);
  SafeStorage.set('gsheet-history', JSON.stringify(_sheetHistory));
  renderSheetHistory();
}
function removeFromHistory(idx) {
  _sheetHistory.splice(idx, 1);
  SafeStorage.set('gsheet-history', JSON.stringify(_sheetHistory));
  renderSheetHistory();
}
function renderSheetHistory() {
  const container = document.getElementById('gsheet-history');
  const list = document.getElementById('gsheet-history-list');
  if (!container || !list) return;
  if (!_sheetHistory.length) { container.style.display = 'none'; return; }
  container.style.display = '';
  list.innerHTML = '';
  _sheetHistory.forEach((h, i) => {
    const d = new Date(h.date);
    const dateStr = d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' });
    const canLoad = !!_googleToken;
    const item = document.createElement('div');
    item.className = 'gsheet-history-item';
    if (!canLoad) item.style.cssText = 'opacity:0.5;cursor:default;';
    item.innerHTML = '<div><div class="name">&#128202; ' + (h.name || h.id) + '</div><div class="meta">' + dateStr + (h.tab ? ' &middot; ' + h.tab : '') + '</div></div>';
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.title = 'Eliminar';
    removeBtn.innerHTML = '&#10005;';
    removeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeFromHistory(i); });
    item.appendChild(removeBtn);
    if (canLoad) {
      item.addEventListener('click', () => loadSheetById(h.id, h.name || h.id));
    }
    list.appendChild(item);
  });
}

// ===
// APP ORIGINAL
// ===

// IVA constants now in CONFIG object
const IVA_RESERVA = CONFIG.IVA_RESERVA, IVA_SUBTOTAL = CONFIG.IVA_SUBTOTAL;
let amenitiesOptions = [7];

let platformOptions = {
  "Airbnb.com": [15.5], "Booking.com": [15, 17, 22], "Caddie Golf": [10],
  "Comercial": [10], "De Propietario": [0], "Frontex": [10],
  "Granadabeachgolf.com": [10], "Homeaway.com": [15], "Sport2event SL": [10],
};
let pasarelaStripeOptions = [1.3];
let pasarelaBookingOptions = [1.5];
let cleaningOptions = [100, 120];
let irpfOptions = [19, 24];
let gtcOptions = [20];
let maintenanceOptions = [80];

// Per-consolidation monthly deductions (keyed by alojamiento name)
let _consolMaint = {}; // { alojName: { enabled:true, amount:80 } }
let _consolExtras = {}; // { alojName: [ { label:'...', amount:123.45 } ] }

// Special 80/20 GTC split alojamientos
const GTC_SPLIT_RATE = 0.20; // GTC retains 20%, owner gets 80%
let _gtcSplitAlojamientos = ['MA-2-P2-1A','MA-2-P3-1C','MA-2-P3-1D','MA-2-P3-1E','MA-2-P4-1C','MG-2-0D'];
let _gtcOwnedAlojamientos = [
  'MA-2-P1-4C','MA-2-P1-1C','MA-2-P2-1A','MA-2-P3-1B','MA-2-P3-1C','MA-2-P3-1D','MA-2-P3-1E',
  'MA-2-P4-1A','MA-2-P4-1B','MA-2-P4-1C','MG-2-0D','MG-2-0F','MG-2-0I','MG-2-1F',
  'MG-2-1K','MG-2-1M','MG-2-1N','MG-2-2N','MG-2-3L','MG-3-0C'
];
function isGtcSplit(alojName) { return _gtcSplitAlojamientos.some(function(a){ return alojName === a || alojName.indexOf(a) !== -1; }); }
function isGtcOwned(alojName) { return _gtcOwnedAlojamientos.some(function(a){ return alojName === a || alojName.indexOf(a) !== -1; }); }

function getConsolMaint(alojName) {
  if (!_consolMaint[alojName]) _consolMaint[alojName] = { enabled: true, amount: maintenanceOptions[0] };
  return _consolMaint[alojName];
}
function getConsolExtras(alojName) {
  if (!_consolExtras[alojName]) _consolExtras[alojName] = [];
  return _consolExtras[alojName];
}
function getConsolDeductions(alojName) {
  let m = getConsolMaint(alojName);
  let extras = getConsolExtras(alojName);
  let maintBase = m.enabled ? m.amount : 0;
  let extrasTotal = extras.reduce(function(s,e){ return s + e.amount; }, 0);
  return { maintBase: maintBase, extrasTotal: extrasTotal, totalBase: maintBase + extrasTotal };
}

let allReservas = [], settings = {}, validated = new Set(), _lastFiltered = [];
let currentConsolAloj = null, currentDetailIdx = null;
// Google Sheets write-back state
let _sheetSource = null; // { id, tab, valColIdx, valColLetter, headerRow } \u2013 null when loaded from file
let _syncQueue = []; // pending write operations
let _syncActive = false; // true while a write is in flight
// Performance: liquidation cache + pagination + render debouncing
let _pageSize = CONFIG.DEFAULT_PAGE_SIZE;
let _liqCache = {}, _currentPage = 1, _fmtCache = {};
function invalidateCache(idx) { if (idx !== undefined) { delete _liqCache[idx]; } else { _liqCache = {}; invalidateGlobalStats(); invalidateFilterCache(); } }
function getLiq(r) {
  const idx = r.idx;
  if (_liqCache[idx]) return _liqCache[idx];
  _liqCache[idx] = calcLiquidacion(r, settings[idx] || {});
  return _liqCache[idx];
}
// Debounced render via requestAnimationFrame - coalesces multiple renderTable calls into one frame
let _renderRafId = 0, _renderMode = 'full'; // 'full' | 'append'
function scheduleRender(mode) {
  // 'full' overrides 'append'; 'append' only if no pending full
  if (mode === 'full' || _renderMode === 'full') _renderMode = 'full';
  else _renderMode = mode || 'full';
  if (_renderRafId) return; // already scheduled
  _renderRafId = requestAnimationFrame(() => {
    _renderRafId = 0;
    const m = _renderMode; _renderMode = 'full';
    if (m === 'append') _renderPageOnly();
    else _renderFull();
  });
}
// Cached filter+sort result \u2014 invalidated on filter/sort/data changes, NOT on pagination
let _cachedFiltered = null, _filterSortKey = '', _validatedVersion = 0;
let _searchText = '', _searchTextConsol = '';
function getFilterSortKey() {
  const pKey = [...comboState.platform.selected].sort().join(',') || 'all';
  const aKey = [...comboState.aloj.selected].sort().join(',') || 'all';
  return pKey + '|' + aKey + '|' + [..._mpSelYears].sort().join(',') + '|' + [..._mpSelMonths].sort().join(',') + '|' +
    simpleComboState.status.value + '|' + simpleComboState.sort.value + '|' +
    simpleComboState.sortdir.value + '|' + _validatedVersion + '|' + allReservas.length + '|' + _searchText;
}
function invalidateFilterCache() { _cachedFiltered = null; _filterSortKey = ''; _cachedFilteredStats = null; }
function getFilteredSorted() {
  const key = getFilterSortKey();
  if (_cachedFiltered && _filterSortKey === key) return _cachedFiltered;
  const pSel = comboState.platform.selected, aSel = comboState.aloj.selected;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value, sortD = simpleComboState.sortdir.value;
  let fil = allReservas.filter(r => {
    if (pSel.size > 0 && !pSel.has(r.plataforma)) return false;
    if (aSel.size > 0 && !aSel.has(r.alojamiento)) return false;
    if (_mpSelYears.size > 0 && !_mpMatchDate(r._dEntrada)) return false;
    if (sf2 === "validated" && !validated.has(r.idx)) return false;
    if (sf2 === "pending" && validated.has(r.idx)) return false;
    if (_searchText) {
      const s = _searchText;
      const c = getLiq(r);
      const fTotal = fmt(r.totalReserva), fLiq = fmt(c.totalLiq), fBase = fmt(c.baseSinIVA), fSub = fmt(c.sub);
      if (!(r._clienteLc.includes(s) || r._alojLc.includes(s) || r._platLc.includes(s) ||
            r.id.toLowerCase().includes(s) || r.localizador.toLowerCase().includes(s) ||
            (r.edificio||'').toLowerCase().includes(s) || (r.atendidoPor||'').toLowerCase().includes(s) ||
            (r.origenMarketing||'').toLowerCase().includes(s) || (r.observacion||'').toLowerCase().includes(s) ||
            (r.tipoReserva||'').toLowerCase().includes(s) ||
            r._fmtEntrada.includes(s) || r._fmtSalida.includes(s) || r._fmtAlta.includes(s) ||
            fTotal.includes(s) || fLiq.includes(s) || fBase.includes(s) || fSub.includes(s) ||
            String(r.totalReserva).includes(s) || String(r._nights) === s)) return false;
    }
    return true;
  });
  fil.sort((a, b) => {
    let va = getSortValue(a, sortF), vb = getSortValue(b, sortF);
    if (typeof va === "string") return sortD === "asc" ? va.localeCompare(vb) : vb.localeCompare(va);
    return sortD === "asc" ? va - vb : vb - va;
  });
  _cachedFiltered = fil;
  _filterSortKey = key;
  return fil;
}
// Pre-computed select option strings (rebuilt when config changes)
let _selectCache = {};
function rebuildSelectCache() {
  _selectCache = {};
  // Platform options per platform name
  Object.keys(platformOptions).forEach(name => {
    const opts = platformOptions[name];
    _selectCache['plat_' + name] = opts.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  });
  // GTC
  _selectCache.gtc = gtcOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  // Cleaning
  _selectCache.clean = cleaningOptions.map(o => `<option value="${o}">${o} \u20AC</option>`).join('');
  // Amenities
  _selectCache.amenities = amenitiesOptions.map(o => `<option value="${o}">${o} \u20AC</option>`).join('');
  // IRPF
  _selectCache.irpf = irpfOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  // Pasarela
  _selectCache.pasStripe = pasarelaStripeOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
  _selectCache.pasBooking = pasarelaBookingOptions.map(o => `<option value="${o/100}">${o}%</option>`).join('');
}
function selectWithValue(html, val) {
  // Set selected on matching option via string replace (fast)
  const needle = `value="${val}"`;
  return html.replace(needle, needle + ' selected');
}
function selectCleanWithValue(html, val) {
  const needle = `value="${val}"`;
  return html.replace(needle, needle + ' selected');
}

// Fast number formatter (avoid toLocaleString which is ~50x slower)
function fmt(n) {
  const fixed = Math.abs(n).toFixed(2);
  const [int, dec] = fixed.split('.');
  // Add thousands separator (dot for es-ES)
  let result = '';
  for (let i = int.length - 1, c = 0; i >= 0; i--, c++) {
    if (c > 0 && c % 3 === 0) result = '.' + result;
    result = int[i] + result;
  }
  if (n < 0) result = '-' + result;
  return result + ',' + dec;
}
// Fast date formatter (avoid toLocaleDateString)
function fmtDate(d) {
  if (!d) return '\u2014';
  const dd = d.getDate(), mm = d.getMonth() + 1, yy = d.getFullYear();
  return (dd < 10 ? '0' : '') + dd + '/' + (mm < 10 ? '0' : '') + mm + '/' + yy;
}
function parseDate(val) {
  if (!val) return null;
  if (val instanceof Date) return val;
  if (typeof val === "number") return new Date((val - 25569) * 86400000);
  const s = String(val).trim();
  // DD/MM/YYYY or DD/MM/YY
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (m) { const y = m[3].length === 2 ? 2000 + parseInt(m[3]) : parseInt(m[3]); return new Date(y, parseInt(m[2])-1, parseInt(m[1])); }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function formatDate(val) {
  const d = parseDate(val);
  return d ? fmtDate(d) : (val ? String(val) : "\u2014");
}
function dateToNum(val) { const d = parseDate(val); return d ? d.getTime() : 0; }
function calcNights(e, s) {
  const a = parseDate(e), b = parseDate(s);
  if (!a || !b) return 0; return Math.max(0, Math.round((b - a) / 86400000));
}
function parseNum(v) {
  if (typeof v === "number") return v;
  if (!v) return 0;
  const s = String(v).trim();
  // Spanish format: 1.400,00 \u2191 remove dots, replace comma with dot
  if (s.includes(",")) return parseFloat(s.replace(/\./g, "").replace(",", ".")) || 0;
  return parseFloat(s) || 0;
}
function getDefaultForPlatform(plat) { const o = platformOptions[plat]; return o && o.length ? o[0] / 100 : 0.10; }

function calcLiquidacion(r, s) {
  if (!r) return { totalOriginal:0, ceTotal:0, total:0, baseSinIVA:0, comRate:0, comPlat:0, gtcRate:0, comGTC:0, comPas:0, limp:0, amen:0, ceSinIvaTotal:0, sub:0, iva:0, irpfRate:0, ret:0, totalLiq:0 };
  const totalOriginal = r.totalReserva || 0;
  const ce = (s.conceptosEspeciales && s.conceptosEspeciales.length > 0) ? s.conceptosEspeciales : [];
  const ceTotal = ce.reduce(function(sum, item) { return sum + (item.amount || 0); }, 0);
  const total = totalOriginal - ceTotal;
  const baseSinIVA = total / (1 + IVA_RESERVA);
  let comRate = s.comPlataforma !== undefined ? s.comPlataforma : getDefaultForPlatform(r.plataforma);
  const comPlat = total * comRate;
  const gtcRate = s.comGTC !== undefined ? s.comGTC : gtcOptions[0]/100;
  const comGTC = baseSinIVA * gtcRate;
  let comPas = 0;
  if (s.pasarela) {
    const isB = r.plataforma === "Booking.com";
    const pr = s.pasarelaRate !== undefined ? s.pasarelaRate : (isB ? pasarelaBookingOptions[0]/100 : pasarelaStripeOptions[0]/100);
    comPas = total * pr;
  }
  const limp = s.limpieza !== undefined ? s.limpieza : cleaningOptions[0];
  const rawAmen = s.amenities;
  const amen = (rawAmen !== undefined && amenitiesOptions.some(function(o){return Math.abs(o-rawAmen)<0.001;})) ? rawAmen : amenitiesOptions[0];
  const ce2 = (s.conceptosSinIVA && s.conceptosSinIVA.length > 0) ? s.conceptosSinIVA : [];
  const ceSinIvaTotal = ce2.reduce(function(sum, item) { return sum + (item.amount || 0); }, 0);
  const sub = baseSinIVA - comPlat - comGTC - comPas - limp - amen - ceSinIvaTotal;
  const irpfRate = s.irpf !== undefined ? s.irpf : irpfOptions[0]/100;
  const iva = sub * IVA_SUBTOTAL, ret = sub * irpfRate;
  return { totalOriginal, ceTotal, total, baseSinIVA, comRate, comPlat, gtcRate, comGTC, comPas, limp, amen, ceSinIvaTotal, sub, iva, irpfRate, ret, totalLiq: sub + iva - ret };
}

// \u2500\u2500\u2500 FILE \u2500\u2500\u2500
function isHtmlFile(buf) {
  // Detect HTML-based .xls (Avantio exports): first bytes contain "<html" or start with whitespace+<
  const head = new TextDecoder("utf-8").decode(buf.slice(0, 200)).trim().toLowerCase();
  return head.startsWith("<html") || head.startsWith("<!doctype") || head.includes("<html");
}

function parseHtmlXls(text) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(text, "text/html");
  const trs = doc.querySelectorAll("table tr");
  const json = [];
  trs.forEach(tr => {
    const cells = [];
    tr.querySelectorAll("td, th").forEach(td => cells.push(td.textContent.trim()));
    json.push(cells);
  });
  return json;
}

function processRows(json) {
  if (!json || !Array.isArray(json) || json.length < 2) {
    alert("El archivo no contiene datos v\u00E1lidos.");
    return false;
  }
  const headerRow = json.findIndex(r => r && r[0] && String(r[0]).includes("ID Reserva"));
  if (headerRow === -1) { alert("No se encontr\u00F3 la cabecera 'ID Reserva'."); return false; }

  // Detect validation column in header
  const hdr = json[headerRow];
  let detectedValColIdx = null;
  for (let c = 0; c < (hdr ? hdr.length : 0); c++) {
    const h = String(hdr[c] || '').trim().toLowerCase();
    if (h === 'validada' || h === 'validado' || h === 'validated') { detectedValColIdx = c; break; }
  }

  // Build rows preserving original json row index (for sheet write-back)
  const dataStart = headerRow + 1;
  const allDataRows = json.slice(dataStart);
  const rowEntries = [];
  allDataRows.forEach((row, localIdx) => {
    if (row && row[0] && String(row[0]).trim().toLowerCase() !== 'total') {
      rowEntries.push({ data: row, jsonRow: dataStart + localIdx });
    }
  });

  allReservas = rowEntries.map((entry, idx) => {
    const row = entry.data;
    const r = {
      id: String(row[0]||""), localizador: String(row[1]||""), fechaAlta: row[2],
      alojamiento: String(row[3]||""), edificio: String(row[4]||""),
      plataforma: String(row[5]||"").trim() || "Granadabeachgolf.com",
      atendidoPor: String(row[6]||""), origenMarketing: String(row[7]||""),
      cliente: String(row[8]||""),
      tipoReserva: String(row[9]||""), fechaEntrada: row[10], fechaSalida: row[11],
      totalReserva: parseNum(row[12]), observacion: String(row[13]||""), idx,
      _sheetRow: entry.jsonRow + 1, // 1-indexed row in spreadsheet
    };
    const dE = parseDate(r.fechaEntrada), dS = parseDate(r.fechaSalida);
    const dA = parseDate(r.fechaAlta);
    r._dEntrada = dE; r._dSalida = dS; r._dAlta = dA;
    r._fmtEntrada = dE ? fmtDate(dE) : '\u2014';
    r._fmtSalida = dS ? fmtDate(dS) : '\u2014';
    r._fmtAlta = dA ? fmtDate(dA) : '\u2014';
    r._dateNum = dE ? dE.getTime() : 0;
    r._dateAltaNum = dA ? dA.getTime() : 0;
    r._nights = (dE && dS) ? Math.max(0, Math.round((dS - dE) / 86400000)) : 0;
    r._clienteLc = (r.cliente||"").toLowerCase();
    r._alojLc = (r.alojamiento||"").toLowerCase();
    r._platLc = (r.plataforma||"").toLowerCase();
    r._isBooking = r.plataforma === "Booking.com";
    return r;
  });
  settings = {}; validated = new Set();
  allReservas.forEach(r => {
    const isB = r.plataforma === "Booking.com";
    if (!platformOptions[r.plataforma]) platformOptions[r.plataforma] = [10];
    settings[r.idx] = {
      comPlataforma: getDefaultForPlatform(r.plataforma), comGTC: gtcOptions[0]/100,
      limpieza: cleaningOptions[0], amenities: amenitiesOptions[0], irpf: irpfOptions[0]/100, pasarela: false,
      pasarelaRate: isB ? pasarelaBookingOptions[0]/100 : pasarelaStripeOptions[0]/100,
      conceptosEspeciales: [],
      conceptosSinIVA: [],
    };
  });

  // Read validation state from sheet if column exists
  if (detectedValColIdx !== null) {
    allReservas.forEach((r, idx) => {
      const val = String(rowEntries[idx].data[detectedValColIdx] || '').trim().toLowerCase();
      if (val && (val === 's\u00ED' || val === 'si' || val === 'yes' || val === '1' || val === 'true' || val === 'x')) {
        validated.add(r.idx);
      }
    });
  }

  // Store metadata for sheet source setup (used by loadSheetData)
  processRows._lastResult = { valColIdx: detectedValColIdx, headerRow: headerRow };

  const plats = [...new Set(allReservas.map(r => r.plataforma))].sort();
  populateCombo('platform', plats);
  const alojs = [...new Set(allReservas.map(r => r.alojamiento))].sort();
  populateCombo('aloj', alojs);
  buildAvailableMonths();
  invalidateCache();
  invalidateAlojCache();
  rebuildSelectCache();
  _currentPage = 1;
  return true;
}

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const buf = new Uint8Array(e.target.result);
    let json;
    if (isHtmlFile(buf)) {
      // HTML-based .xls (Avantio): parse as HTML to preserve original text values
      const text = new TextDecoder("utf-8").decode(buf);
      json = parseHtmlXls(text);
    } else {
      // Real .xlsx: use SheetJS
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      json = XLSX.utils.sheet_to_json(ws, { header: 1 });
    }
    if (!processRows(json)) return;
    _sheetSource = null; // not loaded from Google Sheets
    document.getElementById("file-name").textContent = file.name;
    document.getElementById("file-indicator").style.display = "block";
    document.getElementById("nav-consol").style.display = "block";
    showScreen("list"); renderTable();
  };
  reader.readAsArrayBuffer(file);
}

let _navigating = false;
function showScreen(name) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
  document.getElementById("screen-" + name).classList.add("active");
  document.getElementById("nav-" + name).classList.add("active");
  if (_previewActive) exitPreview();
  if (_navigating) return;
  _navigating = true;
  if (name === "list") renderTable();
  if (name === "consol") renderConsolGrid();
  if (name === "consoldetail" && currentConsolAloj) viewConsolDetail(currentConsolAloj);
  if (name === "detail" && currentDetailIdx !== null) viewDetail(currentDetailIdx);
  _navigating = false;
}

// \u2500\u2500\u2500 TABLE \u2500\u2500\u2500
const COLUMNS = [
  { key:"estado",label:"Estado",sortable:true,locked:true },
  { key:"idReserva",label:"ID<br>Reserva",sortable:true },
  { key:"localizador",label:"Localizador",sortable:true },
  { key:"fechaAlta",label:"Fecha<br>Alta",sortable:true },
  { key:"cliente",label:"Cliente",sortable:true },
  { key:"alojamiento",label:"Alojamiento",sortable:true },
  { key:"edificio",label:"Edificio",sortable:true },
  { key:"plataforma",label:"Plataforma",sortable:true },
  { key:"atendidoPor",label:"Atendido<br>por",sortable:true },
  { key:"origenMarketing",label:"Origen<br>Mkt.",sortable:true },
  { key:"tipoReserva",label:"Tipo<br>Reserva",sortable:true },
  { key:"fechaEntrada",label:"Fecha<br>Entrada",sortable:true },
  { key:"fechaSalida",label:"Fecha<br>Salida",sortable:true },
  { key:"noches",label:"Noches",sortable:true },
  { key:"totalReserva",label:"Total Reserva<br>(IVA inc.)",sortable:true,right:true },
  { key:"ce",label:"C.E.<br>(IVA inc.)",sortable:false },
  { key:"baseSinIVA",label:"Base<br>sin IVA",sortable:true,right:true },
  { key:"comPlataforma",label:"Canal de<br>Venta",sortable:false },
  { key:"comGTC",label:"Gesti\u00F3n<br>GTC",sortable:false },
  { key:"limpieza",label:"Limpieza",sortable:false },
  { key:"amenities",label:"Amenities",sortable:false },
  { key:"pasarela",label:"Pasarela",sortable:false },
  { key:"ceSinIva",label:"C.E.<br>(Sin IVA)",sortable:false },
  { key:"subtotal",label:"Subtotal",sortable:true,right:true },
  { key:"irpf",label:"IRPF",sortable:false },
  { key:"iva21",label:"IVA 21%",sortable:false },
  { key:"totalLiquidar",label:"A<br>Liquidar",sortable:true,right:true,locked:true },
  { key:"observacion",label:"Observaci\u00F3n",sortable:true },
  { key:"acciones",label:"",sortable:true,locked:true },
];
// Column visibility state
let colVisibility = {};
COLUMNS.forEach(c => { colVisibility[c.key] = true; });
// Hidden by default
colVisibility['irpf'] = false;
colVisibility['iva21'] = false;
colVisibility['subtotal'] = false;
colVisibility['idReserva'] = false;
colVisibility['localizador'] = false;
colVisibility['fechaAlta'] = false;
colVisibility['edificio'] = false;
colVisibility['atendidoPor'] = false;
colVisibility['origenMarketing'] = false;
colVisibility['tipoReserva'] = false;
colVisibility['observacion'] = false;
function isColVisible(key) { return colVisibility[key] !== false; }
function toggleColVisibility(key) {
  const col = COLUMNS.find(c => c.key === key);
  if (col && col.locked) return;
  colVisibility[key] = !colVisibility[key];
  updateColStyles(); renderTable(); renderColToggle();
}
function updateColStyles() {
  let css = '';
  COLUMNS.forEach(c => {
    if (!isColVisible(c.key)) css += '.col-' + c.key + ' { display: none !important; }\n';
  });
  document.getElementById('col-visibility-style').textContent = css;
}
function renderColToggle() {
  const dd = document.getElementById('col-toggle-dd');
  dd.innerHTML = COLUMNS.filter(c => c.label).map(c => {
    const checked = isColVisible(c.key) ? 'checked' : '';
    const locked = c.locked ? 'locked' : '';
    const dis = c.locked ? 'disabled' : '';
    return '<label class="col-toggle-item ' + locked + '"><input type="checkbox" ' + checked + ' ' + dis +
      ' onchange="toggleColVisibility(\'' + c.key + '\')"> ' + c.label + '</label>';
  }).join('');
}
function toggleColDropdown() {
  const dd = document.getElementById('col-toggle-dd');
  const isOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!isOpen) renderColToggle();
}

// \u2500\u2500\u2500 CONSOLIDATED TABLE: columns, sort, visibility \u2500\u2500\u2500
const CONSOL_COLUMNS = COLUMNS.filter(c => c.key !== 'alojamiento');
let consolColVis = {};
CONSOL_COLUMNS.forEach(c => { consolColVis[c.key] = true; });
consolColVis['irpf'] = false;
consolColVis['iva21'] = false;
consolColVis['subtotal'] = false;
consolColVis['idReserva'] = false;
consolColVis['localizador'] = false;
consolColVis['fechaAlta'] = false;
consolColVis['edificio'] = false;
consolColVis['atendidoPor'] = false;
consolColVis['origenMarketing'] = false;
consolColVis['tipoReserva'] = false;
consolColVis['observacion'] = false;
let consolSortF = 'idx', consolSortD = 'asc';
// Apply initial col visibility
setTimeout(updateConsolColStyles, 0);
setTimeout(updateColStyles, 0);

function isConsolColVis(key) { return consolColVis[key] !== false; }
function toggleConsolColVis(key) {
  const col = CONSOL_COLUMNS.find(c => c.key === key);
  if (col && col.locked) return;
  consolColVis[key] = !consolColVis[key];
  updateConsolColStyles();
}
function updateConsolColStyles() {
  let css = '';
  CONSOL_COLUMNS.forEach(c => {
    if (!isConsolColVis(c.key)) css += '.cc-' + c.key + ' { display: none !important; }\n';
  });
  document.getElementById('consol-col-visibility-style').textContent = css;
}
function renderConsolColToggle() {
  const dd = document.getElementById('consol-col-toggle-dd');
  if (!dd) return;
  dd.innerHTML = CONSOL_COLUMNS.filter(c => c.label).map(c => {
    const checked = isConsolColVis(c.key) ? 'checked' : '';
    const locked = c.locked ? 'locked' : '';
    const dis = c.locked ? 'disabled' : '';
    return '<label class="col-toggle-item ' + locked + '"><input type="checkbox" ' + checked + ' ' + dis +
      ' onchange="toggleConsolColVis(\'' + c.key + '\')"> ' + c.label + '</label>';
  }).join('');
}
function toggleConsolColDropdown() {
  const dd = document.getElementById('consol-col-toggle-dd');
  const isOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!isOpen) renderConsolColToggle();
}
function consolSortByColumn(f) {
  if (consolSortF === f) { consolSortD = consolSortD === 'asc' ? 'desc' : 'asc'; }
  else { consolSortF = f; consolSortD = 'asc'; }
  if (currentConsolAloj) viewConsolDetail(currentConsolAloj);
}
// Shared sort value extraction - used by both main table and consolidated view
function _extractSortValue(r, c, f) {
  switch(f) {
    case "estado": return validated.has(r.idx)?1:0;
    case "idReserva": return r.id.toLowerCase();
    case "localizador": return r.localizador.toLowerCase();
    case "fechaAlta": return r._dateAltaNum;
    case "cliente": return r._clienteLc;
    case "alojamiento": return r._alojLc;
    case "edificio": return (r.edificio||"").toLowerCase();
    case "plataforma": return r._platLc;
    case "atendidoPor": return (r.atendidoPor||"").toLowerCase();
    case "origenMarketing": return (r.origenMarketing||"").toLowerCase();
    case "tipoReserva": return (r.tipoReserva||"").toLowerCase();
    case "fechaEntrada": return r._dateNum;
    case "fechaSalida": return r._dSalida ? r._dSalida.getTime() : 0;
    case "noches": return r._nights;
    case "totalReserva": return r.totalReserva;
    case "baseSinIVA": return c.baseSinIVA;
    case "subtotal": return c.sub;
    case "totalLiquidar": return c.totalLiq;
    case "observacion": return (r.observacion||"").toLowerCase();
    case "acciones": return validated.has(r.idx)?1:0;
    default: return r.idx;
  }
}
function consolGetSortValue(x, f) {
  return _extractSortValue(x.r, x.c, f);
}
function getSortValue(r, f) {
  return _extractSortValue(r, getLiq(r), f);
}
function sortByColumn(f) {
  const sortInput = document.querySelector('#combo-sort .combo-input');
  const sortWrap = document.getElementById('combo-sort');
  const dirInput = document.querySelector('#combo-sortdir .combo-input');
  const dirWrap = document.getElementById('combo-sortdir');
  if(simpleComboState.sort.value===f) {
    const nv = simpleComboState.sortdir.value==="asc"?"desc":"asc";
    simpleComboState.sortdir.value = nv;
    if (nv==='asc') { dirInput.value=''; dirInput.placeholder='\u2191'; dirWrap.classList.remove('has-value'); }
    else { dirInput.value='\u2193'; dirWrap.classList.add('has-value'); }
  } else {
    simpleComboState.sort.value = f;
    const opt = simpleComboOptions.sort.find(o=>o.value===f);
    if (f==='idx') { sortInput.value=''; sortInput.placeholder='Orden original'; sortWrap.classList.remove('has-value'); }
    else { sortInput.value=opt?opt.label:f; sortWrap.classList.add('has-value'); }
    simpleComboState.sortdir.value = 'asc';
    dirInput.value=''; dirInput.placeholder='\u2191'; dirWrap.classList.remove('has-value');
  }
  _currentPage = 1;
  renderTable();
}

// Global stats cache (recomputed only when needed)
let _globalStatsCache = null;
function getGlobalStats() {
  if (_globalStatsCache) return _globalStatsCache;
  let tR = 0, tL = 0;
  for (let i = 0; i < allReservas.length; i++) {
    const r = allReservas[i];
    tR += r.totalReserva;
    tL += getLiq(r).totalLiq;
  }
  _globalStatsCache = { tR, tL };
  return _globalStatsCache;
}
function invalidateGlobalStats() { _globalStatsCache = null; }

function renderTable() { _renderFull(); }

function _buildRowHtml(r) {
  const s = settings[r.idx] || {}, c = getLiq(r), isV = validated.has(r.idx), isB = r._isBooking, dis = isV ? "disabled" : "";
  const pO = selectWithValue(_selectCache['plat_' + r.plataforma] || '<option>10%</option>', s.comPlataforma);
  const gO = selectWithValue(_selectCache.gtc, s.comGTC);
  const cO = selectCleanWithValue(_selectCache.clean, s.limpieza);
  const aO = selectCleanWithValue(_selectCache.amenities, s.amenities);
  const iO = selectWithValue(_selectCache.irpf, s.irpf);
  const psO = selectWithValue(isB ? _selectCache.pasBooking : _selectCache.pasStripe, s.pasarelaRate);
  return `<tr ${isV ? 'class="validated"' : (c.ceTotal > 0 ? 'class="ce-highlighted"' : (c.ceSinIvaTotal > 0 ? 'class="ce2-highlighted"' : ''))} id="row-${r.idx}">
    <td class="col-estado">${isV ? '<span class="badge badge-green">&#10003; Validada</span>' : '<span class="badge badge-amber">Pendiente</span>'}</td>
    <td class="col-idReserva muted" style="font-size:12px;">${r.id}</td>
    <td class="col-localizador muted" style="font-size:11px;white-space:nowrap;">${r.localizador}</td>
    <td class="col-fechaAlta muted" style="font-size:12px;">${r._fmtAlta}</td>
    <td class="col-cliente bold ellip">${esc(r.cliente)}</td>
    <td class="col-alojamiento ellip muted">${esc(r.alojamiento)}</td>
    <td class="col-edificio ellip muted" style="font-size:12px;">${esc(r.edificio)}</td>
    <td class="col-plataforma"><span class="badge ${isB ? 'badge-purple' : 'badge-blue'}">${r.plataforma}</span></td>
    <td class="col-atendidoPor ellip muted" style="font-size:12px;">${esc(r.atendidoPor)}</td>
    <td class="col-origenMarketing ellip muted" style="font-size:12px;">${esc(r.origenMarketing)}</td>
    <td class="col-tipoReserva muted" style="font-size:12px;">${esc(r.tipoReserva)}</td>
    <td class="col-fechaEntrada" style="font-size:12px;white-space:nowrap;">${r._fmtEntrada}</td>
    <td class="col-fechaSalida" style="font-size:12px;white-space:nowrap;">${r._fmtSalida}</td>
    <td class="col-noches" style="text-align:center">${r._nights}</td>
    <td class="col-totalReserva right bold">${fmt(r.totalReserva)} &#8364;</td>
    <td class="col-ce" style="text-align:center;vertical-align:middle;">${_buildCEButton(r.idx, c)}</td>
    <td class="col-baseSinIVA right" style="color:#6b7280;font-size:12px;">${fmt(c.baseSinIVA)} &#8364;</td>
    <td class="col-comPlataforma" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'comPlataforma',parseFloat(this.value))" ${dis}>${pO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPlat)} &#8364;</span></div></td>
    <td class="col-comGTC" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'comGTC',parseFloat(this.value))" ${dis}>${gO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comGTC)} &#8364;</span></div></td>
    <td class="col-limpieza" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'limpieza',parseFloat(this.value))" ${dis}>${cO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.limp)} &#8364;</span></div></td>
    <td class="col-amenities" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'amenities',parseFloat(this.value))" ${dis}>${aO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.amen)} &#8364;</span></div></td>
    <td class="col-pasarela" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><div style="display:flex;align-items:center;justify-content:center;gap:6px;">
      <div class="toggle" onclick="if(!${isV}){togglePasarela(${r.idx})}"><div class="toggle-track ${s.pasarela ? 'on' : ''}"><div class="toggle-thumb"></div></div></div>
      ${s.pasarela ? `<select class="sel" style="width:70px;font-size:11px;padding:4px 6px;" onchange="changeSetting(${r.idx},'pasarelaRate',parseFloat(this.value))" ${dis}>${psO}</select>` : `<span class="toggle-label">${isB ? 'Booking' : 'Stripe'}</span>`}
    </div>${s.pasarela && c.comPas > 0 ? `<span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPas)} &#8364;</span>` : ''}</div></td>
    <td class="col-ceSinIva" style="text-align:center;vertical-align:middle;">${_buildCE2Button(r.idx, c)}</td>
    <td class="col-subtotal right bold" style="font-size:12px;">${fmt(c.sub)} &#8364;</td>
    <td class="col-irpf" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="changeSetting(${r.idx},'irpf',parseFloat(this.value))" ${dis}>${iO}</select>
      <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.ret)} &#8364;</span></div></td>
    <td class="col-iva21" style="text-align:center;vertical-align:middle;"><span style="font-size:11px;color:#43a047;font-variant-numeric:tabular-nums;">+ ${fmt(c.iva)} &#8364;</span></td>
    <td class="col-totalLiquidar right bold" style="color:${c.totalLiq >= 0 ? '#1a2744' : '#e53935'}">${fmt(c.totalLiq)} &#8364;</td>
    <td class="col-observacion ellip muted" style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${esc(r.observacion)}">${esc(r.observacion)}</td>
    <td class="col-acciones"><div style="display:flex;gap:6px;">
      <button class="btn btn-sm btn-primary" onclick="viewDetail(${r.idx})">&#128065;</button>
      ${!isV ? `<button class="btn btn-sm btn-success" onclick="toggleValidate(${r.idx})">&#10004;</button>` : `<button class="btn btn-sm btn-orange" onclick="toggleValidate(${r.idx})">&#8617;</button>`}
    </div></td>
  </tr>` + _buildCEPanelRow(r.idx, s, c) + _buildCE2PanelRow(r.idx, s, c);
}

function _buildCEButton(idx, c, view) {
  const v = view || 'p';
  if (c.ceTotal > 0) {
    return `<button class="ce-btn has" onclick="event.stopPropagation();toggleCEPanel(${idx},'${v}')"><span class="ce-dot"></span>&#8211;${fmt(c.ceTotal)} &#8364;</button>`;
  }
  return `<button class="ce-btn" onclick="event.stopPropagation();toggleCEPanel(${idx},'${v}')" title="Conceptos especiales (IVA inc.)">+</button>`;
}

function _buildCEPanelRow(idx, s, c, view) {
  const v = view || 'p';
  const ce = s.conceptosEspeciales || [];
  const colCount = v === 'c'
    ? CONSOL_COLUMNS.filter(function(col){return consolColVis[col.key]!==false;}).length
    : COLUMNS.filter(function(col){return colVisibility[col.key]!==false;}).length;
  const r = allReservas[idx];
  const itemsHtml = ce.map(function(item, i) {
    return `<div class="ce-item-row"><input class="ce-inp-label" type="text" value="${(item.label||'').replace(/"/g,'&quot;')}" onchange="updateCEItem(${idx},${i},'label',this.value,'${v}')" placeholder="Ej: Mascota..." /><input class="ce-inp-amt" type="text" value="${fmt(item.amount||0)}" onchange="updateCEItem(${idx},${i},'amount',this.value,'${v}')" /><button class="ce-del" onclick="removeCEItem(${idx},${i},'${v}')">&#215;</button></div>`;
  }).join('');
  const _b = 'text-align:center;padding:8px 12px;border-radius:8px;min-width:110px;';
  return `<tr class="ce-panel-row" id="ce-${v}panel-${idx}" style="display:none"><td colspan="${colCount}" style="padding:0"><div class="ce-panel-inner"><div class="ce-panel-left"><div class="ce-panel-title">&#9888; Conceptos especiales <span class="ce-eye">&#128065; Solo uso interno</span></div>${itemsHtml}<div class="ce-add-link" onclick="addCEItem(${idx},'${v}')">+ A&#241;adir concepto</div></div><div class="ce-panel-summary" style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;"><div style="${_b}background:#f3f4f6;"><div class="ce-sum-label" style="color:#374151">Total Reserva<br>(IVA inc.)</div><div class="ce-sum-val" style="color:#1a2744">${fmt(c.totalOriginal)} &#8364;</div></div><div style="${_b}background:#fef3c7;"><div class="ce-sum-label">Descontar<br>(IVA inc.)</div><div class="ce-sum-val">&#8211; ${fmt(c.ceTotal)} &#8364;</div></div><div style="${_b}background:#fff3e0;"><div class="ce-sum-label" style="color:#e65100">Total sin C.E.<br>(IVA inc.)</div><div class="ce-sum-val" style="color:#e65100">${fmt(c.total)} &#8364;</div></div><div style="${_b}background:#e8f5e9;"><div class="ce-sum-label" style="color:#2e7d32">Total sin C.E.<br>(sin IVA)</div><div class="ce-sum-val" style="color:#2e7d32;font-size:15px">${fmt(c.baseSinIVA)} &#8364;</div></div></div></div></td></tr>`;
}

let _openCEPanel = null;
let _openCEView = 'p';
function toggleCEPanel(idx, view) {
  if (idx == null || !allReservas[idx]) return;
  const v = view || 'p';
  const panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  if (_openCEPanel !== null && (_openCEPanel !== idx || _openCEView !== v)) {
    let prev = document.getElementById('ce-' + _openCEView + 'panel-' + _openCEPanel);
    if (prev) prev.style.display = 'none';
  }
  if (panel.style.display === 'none') {
    let wrap = panel.closest('.table-wrap');
    let st = wrap ? wrap.scrollTop : window.scrollY;
    panel.style.display = '';
    if (wrap) wrap.scrollTop = st; else window.scrollTo(0, st);
    _openCEPanel = idx;
    _openCEView = v;
    let s = settings[idx];
    if (!s.conceptosEspeciales || s.conceptosEspeciales.length === 0) {
      s.conceptosEspeciales = [{label:'', amount:0}];
      _refreshCEPanel(idx, v);
    }
  } else {
    panel.style.display = 'none';
    _openCEPanel = null;
  }
}

function addCEItem(idx, view) {
  let s = settings[idx]; if (!s) return;
  if (!s.conceptosEspeciales) s.conceptosEspeciales = [];
  let i = s.conceptosEspeciales.length;
  s.conceptosEspeciales.push({label:'', amount:0});
  let v = view || 'p';
  let panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  let addLink = panel.querySelector('.ce-add-link');
  if (!addLink) { _refreshCEPanel(idx, v); return; }
  // Create new row via DOM (no full re-render)
  let row = document.createElement('div');
  row.className = 'ce-item-row ce-new';
  row.innerHTML = '<input class="ce-inp-label" type="text" value="" onchange="updateCEItem('+idx+','+i+',\'label\',this.value,\''+v+'\')" placeholder="Ej: Mascota..." /><input class="ce-inp-amt" type="text" value="0,00" onchange="updateCEItem('+idx+','+i+',\'amount\',this.value,\''+v+'\')" /><button class="ce-del" onclick="removeCEItem('+idx+','+i+',\''+v+'\')">&#215;</button>';
  addLink.parentNode.insertBefore(row, addLink);
  row.querySelector('.ce-inp-label').focus();
  scheduleReservaConfigSave(idx);
}

function removeCEItem(idx, itemIdx, view) {
  let s = settings[idx]; if (!s || !s.conceptosEspeciales) return;
  let v = view || 'p';
  let panel = document.getElementById('ce-' + v + 'panel-' + idx);
  let rows = panel ? panel.querySelectorAll('.ce-item-row') : [];
  if (rows[itemIdx]) {
    let row = rows[itemIdx];
    row.style.animation = 'ceRowOut .2s ease forwards';
    row.addEventListener('animationend', function() {
      row.remove();
      s.conceptosEspeciales.splice(itemIdx, 1);
      // Update cache
      let oldC = getLiq(allReservas[idx]);
      invalidateCache(idx);
      let newC = getLiq(allReservas[idx]);
      if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
      // Patch only the changed cells in the main table row (no full rebuild)
      let mainRow = document.getElementById('row-' + idx);
      if (mainRow) {
        let ceCel = mainRow.querySelector('.col-ce');
        if (ceCel) ceCel.innerHTML = _buildCEButton(idx, newC, v);
        let liqCel = mainRow.querySelector('.col-totalLiquidar');
        if (liqCel) liqCel.innerHTML = fmt(newC.totalLiq) + ' &#8364;';
        let subCel = mainRow.querySelector('.col-subtotal');
        if (subCel) subCel.innerHTML = fmt(newC.sub) + ' &#8364;';
        let baseCel = mainRow.querySelector('.col-baseSinIVA');
        if (baseCel) baseCel.innerHTML = fmt(newC.baseSinIVA) + ' &#8364;';
      }
      // Update summary numbers in CE panel
      _refreshCESummary(idx, v);
      // Update footer stats
      let st = _cachedFilteredStats;
      if (st && oldC && newC) {
        st.fL += (newC.totalLiq - oldC.totalLiq);
        st.tLiq += (newC.totalLiq - oldC.totalLiq);
        st.tCE += (newC.ceTotal - oldC.ceTotal);
        st.tSub += (newC.sub - oldC.sub);
        st.tBase += (newC.baseSinIVA - oldC.baseSinIVA);
        _renderStatsFromCache(_lastFiltered, st);
      }
      scheduleReservaConfigSave(idx);
    }, {once:true});
  } else {
    s.conceptosEspeciales.splice(itemIdx, 1);
    _applyCEChange(idx, v);
  }
}

function updateCEItem(idx, itemIdx, field, rawVal, view) {
  let s = settings[idx]; if (!s || !s.conceptosEspeciales || !s.conceptosEspeciales[itemIdx]) return;
  if (field === 'label') {
    s.conceptosEspeciales[itemIdx].label = rawVal;
    scheduleReservaConfigSave(idx);
  } else {
    let v = parseFloat(String(rawVal).replace(/\./g,'').replace(',','.'));
    if (isNaN(v)) v = 0;
    s.conceptosEspeciales[itemIdx].amount = v;
    _applyCEChange(idx, view || 'p');
  }
}

function _applyCEChange(idx, view) {
  let v = view || 'p';
  let oldC = getLiq(allReservas[idx]);
  invalidateCache(idx);
  let newC = getLiq(allReservas[idx]);
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _patchSingleRow(idx, oldC, newC);
  scheduleReservaConfigSave(idx);
  // If changed from consol view, re-render consol detail
  if (v === 'c' && currentConsolAloj) {
    viewConsolDetail(currentConsolAloj);
  } else {
    // Re-open panel if it was open in preliq
    let panel = document.getElementById('ce-' + v + 'panel-' + idx);
    if (panel) { panel.style.display = ''; _openCEPanel = idx; _openCEView = v; }
  }
}

function _refreshCESummary(idx, view) {
  let v = view || 'p';
  let c = getLiq(allReservas[idx]);
  let panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  let vals = panel.querySelectorAll('.ce-sum-val');
  if (vals.length >= 4) {
    vals[0].innerHTML = fmt(c.totalOriginal) + ' &#8364;';
    vals[1].innerHTML = '&#8211; ' + fmt(c.ceTotal) + ' &#8364;';
    vals[2].innerHTML = fmt(c.total) + ' &#8364;';
    vals[3].innerHTML = fmt(c.baseSinIVA) + ' &#8364;';
  }
  // Re-index onclick handlers for remaining rows
  let rows = panel.querySelectorAll('.ce-item-row');
  rows.forEach(function(row, i) {
    const del = row.querySelector('.ce-del');
    if (del) del.setAttribute('onclick', "removeCEItem("+idx+","+i+",'"+v+"')");
    let lbl = row.querySelector('.ce-inp-label');
    if (lbl) lbl.setAttribute('onchange', "updateCEItem("+idx+","+i+",'label',this.value,'"+v+"')");
    let amt = row.querySelector('.ce-inp-amt');
    if (amt) amt.setAttribute('onchange', "updateCEItem("+idx+","+i+",'amount',this.value,'"+v+"')");
  });
}

function _refreshCEPanel(idx, view) {
  let v = view || 'p';
  let s = settings[idx] || {}, c = getLiq(allReservas[idx]);
  let panel = document.getElementById('ce-' + v + 'panel-' + idx);
  if (!panel) return;
  // Preserve scroll position to avoid layout jump
  let wrap = panel.closest('.table-wrap') || panel.closest('.main');
  let scrollY = wrap ? wrap.scrollTop : window.scrollY;
  let colCount = v === 'c'
    ? CONSOL_COLUMNS.filter(function(col){return consolColVis[col.key]!==false;}).length
    : COLUMNS.filter(function(col){return colVisibility[col.key]!==false;}).length;
  let ce = s.conceptosEspeciales || [];
  let itemsHtml = ce.map(function(item, i) {
    return '<div class="ce-item-row"><input class="ce-inp-label" type="text" value="'+(item.label||'').replace(/"/g,'&quot;')+'" onchange="updateCEItem('+idx+','+i+',\'label\',this.value,\''+v+'\')" placeholder="Ej: Mascota..." /><input class="ce-inp-amt" type="text" value="'+fmt(item.amount||0)+'" onchange="updateCEItem('+idx+','+i+',\'amount\',this.value,\''+v+'\')" /><button class="ce-del" onclick="removeCEItem('+idx+','+i+',\''+v+'\')">&#215;</button></div>';
  }).join('');
  let _b = 'text-align:center;padding:8px 12px;border-radius:8px;min-width:110px;';
  panel.innerHTML = '<td colspan="'+colCount+'" style="padding:0"><div class="ce-panel-inner"><div class="ce-panel-left"><div class="ce-panel-title">&#9888; Conceptos especiales <span class="ce-eye">&#128065; Solo uso interno</span></div>'+itemsHtml+'<div class="ce-add-link" onclick="addCEItem('+idx+',\''+v+'\')">+ A\u00f1adir concepto</div></div><div class="ce-panel-summary" style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;"><div style="'+_b+'background:#f3f4f6;"><div class="ce-sum-label" style="color:#374151">Total Reserva<br>(IVA inc.)</div><div class="ce-sum-val" style="color:#1a2744">'+fmt(c.totalOriginal)+' &#8364;</div></div><div style="'+_b+'background:#fef3c7;"><div class="ce-sum-label">Descontar<br>(IVA inc.)</div><div class="ce-sum-val">&#8211; '+fmt(c.ceTotal)+' &#8364;</div></div><div style="'+_b+'background:#fff3e0;"><div class="ce-sum-label" style="color:#e65100">Total sin C.E.<br>(IVA inc.)</div><div class="ce-sum-val" style="color:#e65100">'+fmt(c.total)+' &#8364;</div></div><div style="'+_b+'background:#e8f5e9;"><div class="ce-sum-label" style="color:#2e7d32">Total sin C.E.<br>(sin IVA)</div><div class="ce-sum-val" style="color:#2e7d32;font-size:15px">'+fmt(c.baseSinIVA)+' &#8364;</div></div></div></div></td>';
  // Restore scroll position to prevent jump
  if (wrap) wrap.scrollTop = scrollY;
  // Auto-focus the last added label input
  let labels = panel.querySelectorAll('.ce-inp-label');
  if (labels.length > 0) labels[labels.length - 1].focus();
}

// === CE2: CONCEPTOS ESPECIALES SIN IVA (violet) ===
function _buildCE2Button(idx, c, view) {
  const v = view || 'p';
  if (c.ceSinIvaTotal > 0) {
    return `<button class="ce2-btn has" onclick="event.stopPropagation();toggleCE2Panel(${idx},'${v}')"><span class="ce2-dot"></span>&#8211;${fmt(c.ceSinIvaTotal)} &#8364;</button>`;
  }
  return `<button class="ce2-btn" onclick="event.stopPropagation();toggleCE2Panel(${idx},'${v}')" title="Conceptos especiales (Sin IVA)">+</button>`;
}

function _buildCE2PanelRow(idx, s, c, view) {
  const v = view || 'p';
  const ce2 = s.conceptosSinIVA || [];
  const colCount = v === 'c'
    ? CONSOL_COLUMNS.filter(function(col){return consolColVis[col.key]!==false;}).length
    : COLUMNS.filter(function(col){return colVisibility[col.key]!==false;}).length;
  const itemsHtml = ce2.map(function(item, i) {
    return `<div class="ce2-item-row"><input class="ce2-inp-label" type="text" value="${(item.label||'').replace(/"/g,'&quot;')}" onchange="updateCE2Item(${idx},${i},'label',this.value,'${v}')" placeholder="Ej: Reparaci\u00F3n..." /><input class="ce2-inp-amt" type="text" value="${fmt(item.amount||0)}" onchange="updateCE2Item(${idx},${i},'amount',this.value,'${v}')" /><button class="ce2-del" onclick="removeCE2Item(${idx},${i},'${v}')">&#215;</button></div>`;
  }).join('');
  const subBefore = c.sub + c.ceSinIvaTotal; // subtotal before CE2 deduction
  const _b = 'text-align:center;padding:8px 12px;border-radius:8px;min-width:110px;';
  return `<tr class="ce2-panel-row" id="ce2-${v}panel-${idx}" style="display:none"><td colspan="${colCount}" style="padding:0"><div class="ce2-panel-inner"><div class="ce2-panel-left"><div class="ce2-panel-title">&#9888; Conceptos especiales (Sin IVA) <span class="ce2-eye">&#128065; Resta al subtotal</span></div>${itemsHtml}<div class="ce2-add-link2" onclick="addCE2Item(${idx},'${v}')">+ A&#241;adir concepto</div></div><div class="ce2-panel-summary" style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;"><div style="${_b}background:#f3f4f6;"><div class="ce2-sum-label" style="color:#374151">Subtotal<br>antes de C.E.</div><div class="ce2-sum-val" style="color:#1a2744">${fmt(subBefore)} &#8364;</div></div><div style="${_b}background:#f5f0ff;"><div class="ce2-sum-label" style="color:#6d28d9">Descontar<br>(Sin IVA)</div><div class="ce2-sum-val" style="color:#7c3aed">&#8211; ${fmt(c.ceSinIvaTotal)} &#8364;</div></div><div style="${_b}background:#ede9fe;"><div class="ce2-sum-label" style="color:#5b21b6">Subtotal<br>final</div><div class="ce2-sum-val" style="color:#5b21b6">${fmt(c.sub)} &#8364;</div></div></div></div></td></tr>`;
}

let _openCE2Panel = null;
let _openCE2View = 'p';
function toggleCE2Panel(idx, view) {
  if (idx == null || !allReservas[idx]) return;
  const v = view || 'p';
  const panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  if (_openCE2Panel !== null && (_openCE2Panel !== idx || _openCE2View !== v)) {
    let prev = document.getElementById('ce2-' + _openCE2View + 'panel-' + _openCE2Panel);
    if (prev) prev.style.display = 'none';
  }
  if (panel.style.display === 'none') {
    let wrap = panel.closest('.table-wrap');
    let st = wrap ? wrap.scrollTop : window.scrollY;
    panel.style.display = '';
    if (wrap) wrap.scrollTop = st; else window.scrollTo(0, st);
    _openCE2Panel = idx;
    _openCE2View = v;
    let s = settings[idx];
    if (!s.conceptosSinIVA || s.conceptosSinIVA.length === 0) {
      s.conceptosSinIVA = [{label:'', amount:0}];
      _refreshCE2Panel(idx, v);
    }
  } else {
    panel.style.display = 'none';
    _openCE2Panel = null;
  }
}

function addCE2Item(idx, view) {
  let s = settings[idx]; if (!s) return;
  if (!s.conceptosSinIVA) s.conceptosSinIVA = [];
  let i = s.conceptosSinIVA.length;
  s.conceptosSinIVA.push({label:'', amount:0});
  let v = view || 'p';
  let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  let addLink = panel.querySelector('.ce2-add-link2');
  if (!addLink) { _refreshCE2Panel(idx, v); return; }
  let row = document.createElement('div');
  row.className = 'ce2-item-row ce2-new';
  row.innerHTML = '<input class="ce2-inp-label" type="text" value="" onchange="updateCE2Item('+idx+','+i+',\'label\',this.value,\''+v+'\')" placeholder="Ej: Reparaci\u00f3n..." /><input class="ce2-inp-amt" type="text" value="0,00" onchange="updateCE2Item('+idx+','+i+',\'amount\',this.value,\''+v+'\')" /><button class="ce2-del" onclick="removeCE2Item('+idx+','+i+',\''+v+'\')">&#215;</button>';
  addLink.parentNode.insertBefore(row, addLink);
  row.querySelector('.ce2-inp-label').focus();
  scheduleReservaConfigSave(idx);
}

function removeCE2Item(idx, itemIdx, view) {
  let s = settings[idx]; if (!s || !s.conceptosSinIVA) return;
  let v = view || 'p';
  let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  let rows = panel ? panel.querySelectorAll('.ce2-item-row') : [];
  if (rows[itemIdx]) {
    let row = rows[itemIdx];
    row.style.animation = 'ceRowOut .2s ease forwards';
    row.addEventListener('animationend', function() {
      row.remove();
      s.conceptosSinIVA.splice(itemIdx, 1);
      let oldC = getLiq(allReservas[idx]);
      invalidateCache(idx);
      let newC = getLiq(allReservas[idx]);
      if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
      let mainRow = document.getElementById('row-' + idx);
      if (mainRow) {
        let ce2Cel = mainRow.querySelector('.col-ceSinIva');
        if (ce2Cel) ce2Cel.innerHTML = _buildCE2Button(idx, newC, v);
        let liqCel = mainRow.querySelector('.col-totalLiquidar');
        if (liqCel) liqCel.innerHTML = fmt(newC.totalLiq) + ' &#8364;';
        let subCel = mainRow.querySelector('.col-subtotal');
        if (subCel) subCel.innerHTML = fmt(newC.sub) + ' &#8364;';
      }
      _refreshCE2Summary(idx, v);
      let st = _cachedFilteredStats;
      if (st && oldC && newC) {
        st.fL += (newC.totalLiq - oldC.totalLiq);
        st.tLiq += (newC.totalLiq - oldC.totalLiq);
        st.tCE2 += (newC.ceSinIvaTotal - oldC.ceSinIvaTotal);
        st.tSub += (newC.sub - oldC.sub);
        _renderStatsFromCache(_lastFiltered, st);
      }
      scheduleReservaConfigSave(idx);
    }, {once:true});
  } else {
    s.conceptosSinIVA.splice(itemIdx, 1);
    _applyCE2Change(idx, v);
  }
}

function updateCE2Item(idx, itemIdx, field, rawVal, view) {
  let s = settings[idx]; if (!s || !s.conceptosSinIVA || !s.conceptosSinIVA[itemIdx]) return;
  if (field === 'label') {
    s.conceptosSinIVA[itemIdx].label = rawVal;
    scheduleReservaConfigSave(idx);
  } else {
    let v = parseFloat(String(rawVal).replace(/\./g,'').replace(',','.'));
    if (isNaN(v)) v = 0;
    s.conceptosSinIVA[itemIdx].amount = v;
    _applyCE2Change(idx, view || 'p');
  }
}

function _applyCE2Change(idx, view) {
  let v = view || 'p';
  let oldC = getLiq(allReservas[idx]);
  invalidateCache(idx);
  let newC = getLiq(allReservas[idx]);
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _patchSingleRow(idx, oldC, newC);
  scheduleReservaConfigSave(idx);
  if (v === 'c' && currentConsolAloj) {
    viewConsolDetail(currentConsolAloj);
  } else {
    let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
    if (panel) { panel.style.display = ''; _openCE2Panel = idx; _openCE2View = v; }
  }
}

function _refreshCE2Summary(idx, view) {
  let v = view || 'p';
  let c = getLiq(allReservas[idx]);
  let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  let vals = panel.querySelectorAll('.ce2-sum-val');
  const subBefore = c.sub + c.ceSinIvaTotal;
  if (vals.length >= 3) {
    vals[0].innerHTML = fmt(subBefore) + ' &#8364;';
    vals[1].innerHTML = '&#8211; ' + fmt(c.ceSinIvaTotal) + ' &#8364;';
    vals[2].innerHTML = fmt(c.sub) + ' &#8364;';
  }
  let rows = panel.querySelectorAll('.ce2-item-row');
  rows.forEach(function(row, i) {
    const del = row.querySelector('.ce2-del');
    if (del) del.setAttribute('onclick', "removeCE2Item("+idx+","+i+",'"+v+"')");
    let lbl = row.querySelector('.ce2-inp-label');
    if (lbl) lbl.setAttribute('onchange', "updateCE2Item("+idx+","+i+",'label',this.value,'"+v+"')");
    let amt = row.querySelector('.ce2-inp-amt');
    if (amt) amt.setAttribute('onchange', "updateCE2Item("+idx+","+i+",'amount',this.value,'"+v+"')");
  });
}

function _refreshCE2Panel(idx, view) {
  let v = view || 'p';
  let s = settings[idx] || {}, c = getLiq(allReservas[idx]);
  let panel = document.getElementById('ce2-' + v + 'panel-' + idx);
  if (!panel) return;
  let wrap = panel.closest('.table-wrap') || panel.closest('.main');
  let scrollY = wrap ? wrap.scrollTop : window.scrollY;
  let colCount = v === 'c'
    ? CONSOL_COLUMNS.filter(function(col){return consolColVis[col.key]!==false;}).length
    : COLUMNS.filter(function(col){return colVisibility[col.key]!==false;}).length;
  let ce2 = s.conceptosSinIVA || [];
  let itemsHtml = ce2.map(function(item, i) {
    return '<div class="ce2-item-row"><input class="ce2-inp-label" type="text" value="'+(item.label||'').replace(/"/g,'&quot;')+'" onchange="updateCE2Item('+idx+','+i+',\'label\',this.value,\''+v+'\')" placeholder="Ej: Reparaci\u00f3n..." /><input class="ce2-inp-amt" type="text" value="'+fmt(item.amount||0)+'" onchange="updateCE2Item('+idx+','+i+',\'amount\',this.value,\''+v+'\')" /><button class="ce2-del" onclick="removeCE2Item('+idx+','+i+',\''+v+'\')">&#215;</button></div>';
  }).join('');
  const subBefore = c.sub + c.ceSinIvaTotal;
  let _b = 'text-align:center;padding:8px 12px;border-radius:8px;min-width:110px;';
  panel.innerHTML = '<td colspan="'+colCount+'" style="padding:0"><div class="ce2-panel-inner"><div class="ce2-panel-left"><div class="ce2-panel-title">&#9888; Conceptos especiales (Sin IVA) <span class="ce2-eye">&#128065; Resta al subtotal</span></div>'+itemsHtml+'<div class="ce2-add-link2" onclick="addCE2Item('+idx+',\''+v+'\')">+ A\u00f1adir concepto</div></div><div class="ce2-panel-summary" style="display:flex;gap:8px;align-items:stretch;flex-wrap:wrap;"><div style="'+_b+'background:#f3f4f6;"><div class="ce2-sum-label" style="color:#374151">Subtotal<br>antes de C.E.</div><div class="ce2-sum-val" style="color:#1a2744">'+fmt(subBefore)+' &#8364;</div></div><div style="'+_b+'background:#f5f0ff;"><div class="ce2-sum-label" style="color:#6d28d9">Descontar<br>(Sin IVA)</div><div class="ce2-sum-val" style="color:#7c3aed">&#8211; '+fmt(c.ceSinIvaTotal)+' &#8364;</div></div><div style="'+_b+'background:#ede9fe;"><div class="ce2-sum-label" style="color:#5b21b6">Subtotal<br>final</div><div class="ce2-sum-val" style="color:#5b21b6">'+fmt(c.sub)+' &#8364;</div></div></div></div></td>';
  if (wrap) wrap.scrollTop = scrollY;
  let labels = panel.querySelectorAll('.ce2-inp-label');
  if (labels.length > 0) labels[labels.length - 1].focus();
}

function _renderFull() {
  const fil = getFilteredSorted();
  _lastFiltered = fil;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value, sortD = simpleComboState.sortdir.value;
  const hasFilter = comboState.platform.selected.size > 0 || comboState.aloj.selected.size > 0 || sf2 !== "all" || _mpHasFilter();

  document.getElementById("filter-count").textContent = fil.length + " reservas";

  // Single pass over filtered: stats + totals + button counts
  const st = _computeStatsFromScratch(fil);
  const filPendingCount = st.filPendingCount, filValidatedCount = st.filValidatedCount;
  const fR = st.fR, fL = st.fL, fV = st.fV;
  const tNoches = st.tNoches, tTotal = st.tTotal, tBase = st.tBase;
  const tComPlat = st.tComPlat, tComGTC = st.tComGTC, tLimp = st.tLimp, tAmen = st.tAmen;
  const tComPas = st.tComPas, tSub = st.tSub, tRet = st.tRet, tIva21 = st.tIva21, tLiq = st.tLiq;
  const tCE = st.tCE;
  const tCE2 = st.tCE2;

  // Global stats (cached)
  const gs = getGlobalStats();
  const tR = gs.tR, tL = gs.tL;
  const vC = validated.size;

  const btnVal = document.getElementById("btn-validar-todas");
  const btnDesval = document.getElementById("btn-desvalidar-todas");
  btnVal.style.display = filPendingCount > 0 ? '' : 'none';
  btnVal.textContent = filPendingCount === fil.length ? `\u2713 Validar todas (${filPendingCount})` : `\u2713 Validar pendientes (${filPendingCount})`;
  btnDesval.style.display = filValidatedCount > 0 ? '' : 'none';
  btnDesval.textContent = filValidatedCount === fil.length ? `\u21A9 Desvalidar todas (${filValidatedCount})` : `\u21A9 Desvalidar validadas (${filValidatedCount})`;

  const pctR = allReservas.length > 0 ? (fil.length / allReservas.length * 100).toFixed(1) : 0;
  const pctTR = tR > 0 ? (fR / tR * 100).toFixed(1) : 0;
  const pctTL = tL > 0 ? (fL / tL * 100).toFixed(1) : 0;
  const pctV = vC > 0 ? (fV / vC * 100).toFixed(1) : 0;
  document.getElementById("stats-row").innerHTML = `
    <div class="stat-card"><div class="stat-label">Reservas</div><div class="stat-value">${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fil.length} filtradas <span class="stat-pct">(${pctR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Total Reservas</div><div class="stat-value" style="color:#1a2744">${fmt(tR)} \u20AC</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(fR)} \u20AC <span class="stat-pct">(${pctTR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Total a Liquidar</div><div class="stat-value" style="color:#4f8cff">${fmt(tL)} \u20AC</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(fL)} \u20AC <span class="stat-pct">(${pctTL}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Validadas</div><div class="stat-value" style="color:#43a047">${vC} / ${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fV} / ${fil.length} filtradas <span class="stat-pct">(${pctV}%)</span></div>` : ''}</div>`;

  const thead = document.getElementById("table-header");
  thead.innerHTML = COLUMNS.map(c => { const is = sortF === c.key; const ar = c.sortable ? `<span class="sort-arrow">${is ? (sortD === "asc" ? "&#9650;" : "&#9660;") : "&#8661;"}</span>` : "";
    const cls = ["col-" + c.key, c.right ? "right" : "", is ? "sorted" : "", c.sortable ? "" : "no-sort"].filter(Boolean).join(" ");
    return `<th class="${cls}" ${c.sortable ? `onclick="sortByColumn('${c.key}')"` : ""}>${c.label}${ar}</th>`; }).join("");

  // PAGINATION: render only current page slice
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  if (_currentPage > totalPages) _currentPage = totalPages;
  const startIdx = (_currentPage - 1) * _pageSize;
  const endIdx = Math.min(startIdx + _pageSize, fil.length);

  // Build row HTML for current page only
  const rowsHtml = new Array(endIdx - startIdx);
  for (let i = startIdx; i < endIdx; i++) {
    rowsHtml[i - startIdx] = _buildRowHtml(fil[i]);
  }
  document.getElementById("table-body").innerHTML = rowsHtml.join('');

  // Pagination bar
  _updatePaginationBar(fil.length, totalPages);

  // Totals footer (always over ALL filtered, not just visible)
  _updateFooter(fil.length, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq, tCE, tCE2);
}

// Fast re-render for page changes only \u2014 no stats recalc
function _renderPageOnly() {
  const fil = getFilteredSorted();
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  if (_currentPage > totalPages) _currentPage = totalPages;
  const startIdx = (_currentPage - 1) * _pageSize;
  const endIdx = Math.min(startIdx + _pageSize, fil.length);
  const rowsHtml = new Array(endIdx - startIdx);
  for (let i = startIdx; i < endIdx; i++) {
    rowsHtml[i - startIdx] = _buildRowHtml(fil[i]);
  }
  document.getElementById("table-body").innerHTML = rowsHtml.join('');
  _updatePaginationBar(fil.length, totalPages);
}

function _updatePaginationBar(totalCount, totalPages) {
  const pagBar = document.getElementById("pagination-bar");
  if (totalCount === 0) { pagBar.style.display = 'none'; return; }
  pagBar.style.display = 'flex';

  const startIdx = (_currentPage - 1) * _pageSize + 1;
  const endIdx = Math.min(_currentPage * _pageSize, totalCount);

  // Build page buttons (show max 7 pages with ellipsis)
  let pageButtons = '';
  const maxBtns = 7;
  let pages = [];
  if (totalPages <= maxBtns) {
    for (let i = 1; i <= totalPages; i++) pages.push(i);
  } else {
    pages.push(1);
    let lo = Math.max(2, _currentPage - 1);
    let hi = Math.min(totalPages - 1, _currentPage + 1);
    if (_currentPage <= 3) { lo = 2; hi = 5; }
    if (_currentPage >= totalPages - 2) { lo = totalPages - 4; hi = totalPages - 1; }
    if (lo > 2) pages.push('...');
    for (let i = lo; i <= hi; i++) pages.push(i);
    if (hi < totalPages - 1) pages.push('...');
    pages.push(totalPages);
  }

  pages.forEach(p => {
    if (p === '...') {
      pageButtons += `<span style="padding:4px 2px;color:#9ca3af;font-size:12px;">\u2026</span>`;
    } else {
      const active = p === _currentPage;
      pageButtons += `<button onclick="goToPage(${p})" style="
        min-width:32px;height:32px;border-radius:6px;border:1.5px solid ${active ? '#4f8cff' : '#dde1e8'};
        background:${active ? '#4f8cff' : '#fff'};color:${active ? '#fff' : '#6b7280'};
        font-size:12px;font-weight:${active ? '700' : '500'};cursor:pointer;font-family:inherit;
        transition:all 0.15s;" onmouseover="if(!${active})this.style.borderColor='#4f8cff'" onmouseout="if(!${active})this.style.borderColor='#dde1e8'">${p}</button>`;
    }
  });

  // Page size options
  const sizes = [100, 500, 1000];
  const sizeOpts = sizes.map(s => `<option value="${s}" ${_pageSize === s ? 'selected' : ''}>${s}</option>`).join('');

  pagBar.innerHTML = `
    <div style="display:flex;align-items:center;gap:6px;">
      <button onclick="goToPage(_currentPage-1)" class="btn btn-sm btn-outline" style="padding:4px 10px;${_currentPage <= 1 ? 'opacity:0.4;pointer-events:none;' : ''}">&#8249;</button>
      ${pageButtons}
      <button onclick="goToPage(_currentPage+1)" class="btn btn-sm btn-outline" style="padding:4px 10px;${_currentPage >= totalPages ? 'opacity:0.4;pointer-events:none;' : ''}">&#8250;</button>
    </div>
    <span style="font-size:12px;color:#6b7280;">${startIdx}\u2013${endIdx} de ${totalCount}</span>
    <div style="display:flex;align-items:center;gap:6px;">
      <label style="font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;">Mostrar</label>
      <select class="sel" style="font-size:12px;padding:4px 8px;" onchange="changePageSize(parseInt(this.value))">${sizeOpts}</select>
    </div>`;
}

function goToPage(p) {
  const fil = getFilteredSorted();
  const totalPages = Math.max(1, Math.ceil(fil.length / _pageSize));
  _currentPage = Math.max(1, Math.min(p, totalPages));
  _renderPageOnly();
  // Scroll table to top
  document.querySelector('#screen-list .table-wrap').scrollTop = 0;
}

function changePageSize(size) {
  // Keep roughly the same scroll position
  const firstVisibleIdx = (_currentPage - 1) * _pageSize;
  _pageSize = size;
  _currentPage = Math.max(1, Math.floor(firstVisibleIdx / _pageSize) + 1);
  _renderPageOnly();
}

function _updateFooter(count, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq, tCE, tCE2) {
  const tfoot = document.getElementById("table-foot");
  const _fs = 'border:none;padding:10px 8px;';
  const _fr = 'border:none;padding:10px 8px;color:#ff8a80;text-align:center;font-variant-numeric:tabular-nums;';
  tfoot.innerHTML = count > 0 ? `<tr style="background:#0f1628;color:#fff;font-weight:700;font-size:12px;">
    <td class="col-estado" style="${_fs}"></td>
    <td class="col-idReserva" style="${_fs}"></td>
    <td class="col-localizador" style="${_fs}"></td>
    <td class="col-fechaAlta" style="${_fs}"></td>
    <td class="col-cliente" style="${_fs}text-align:right;text-transform:uppercase;letter-spacing:0.06em;font-size:11px;color:rgba(255,255,255,0.6);">Reservas Totales (${count})</td>
    <td class="col-alojamiento" style="${_fs}"></td>
    <td class="col-edificio" style="${_fs}"></td>
    <td class="col-plataforma" style="${_fs}"></td>
    <td class="col-atendidoPor" style="${_fs}"></td>
    <td class="col-origenMarketing" style="${_fs}"></td>
    <td class="col-tipoReserva" style="${_fs}"></td>
    <td class="col-fechaEntrada" style="${_fs}"></td>
    <td class="col-fechaSalida" style="${_fs}"></td>
    <td class="col-noches" style="${_fs}text-align:center;">${tNoches}</td>
    <td class="col-totalReserva" style="${_fs}text-align:right;">${fmt(tTotal)} &#8364;</td>
    <td class="col-ce" style="${_fs}text-align:center;color:#d97706;font-size:11px;">${tCE > 0 ? '&#8211; ' + fmt(tCE) + ' &#8364;' : ''}</td>
    <td class="col-baseSinIVA" style="${_fs}text-align:right;color:rgba(255,255,255,0.6);">${fmt(tBase)} &#8364;</td>
    <td class="col-comPlataforma" style="${_fr}">${fmt(tComPlat)} &#8364;</td>
    <td class="col-comGTC" style="${_fr}">${fmt(tComGTC)} &#8364;</td>
    <td class="col-limpieza" style="${_fr}">${fmt(tLimp)} &#8364;</td>
    <td class="col-amenities" style="${_fr}">${fmt(tAmen)} &#8364;</td>
    <td class="col-pasarela" style="${_fr}">${tComPas > 0 ? fmt(tComPas) + ' &#8364;' : '&#8211;'}</td>
    <td class="col-ceSinIva" style="${_fs}text-align:center;color:#c4b5fd;font-size:11px;">${tCE2 > 0 ? '&#8211; ' + fmt(tCE2) + ' &#8364;' : ''}</td>
    <td class="col-subtotal" style="${_fs}text-align:right;">${fmt(tSub)} &#8364;</td>
    <td class="col-irpf" style="${_fr}">&#8211; ${fmt(tRet)} &#8364;</td>
    <td class="col-iva21" style="${_fs}text-align:center;color:#81c784;font-variant-numeric:tabular-nums;">+ ${fmt(tIva21)} &#8364;</td>
    <td class="col-totalLiquidar" style="${_fs}text-align:right;color:#81d4fa;font-size:14px;">${fmt(tLiq)} &#8364;</td>
    <td class="col-observacion" style="${_fs}"></td>
    <td class="col-acciones" style="${_fs}"></td>
  </tr>` : '';
}

function changeSetting(i,k,v){
  if (!allReservas[i] || !settings[i]) { console.warn('[Settings] Invalid index:', i); return; }
  if (typeof v === 'number' && isNaN(v)) { console.warn('[Settings] NaN value for', k); return; }
  const oldC = getLiq(allReservas[i]); // capture BEFORE invalidating
  settings[i][k]=v; invalidateCache(i);
  const newC = getLiq(allReservas[i]);
  // Delta update global stats O(1) instead of recomputing O(n)
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _patchSingleRow(i, oldC, newC);
  scheduleReservaConfigSave(i);
}
function validarTodas() { const pending=_lastFiltered.filter(r=>!validated.has(r.idx)); const n=pending.length; if(!n||!confirm(`\u00BFValidar ${n} reserva${n>1?'s':''}?`))return; pending.forEach(r => validated.add(r.idx)); _validatedVersion++; invalidateFilterCache(); renderTable(); batchWriteValidation(pending.map(r=>r.idx), true); }
function desvalidarTodas() { const vals=_lastFiltered.filter(r=>validated.has(r.idx)); const n=vals.length; if(!n||!confirm(`\u00BFDesvalidar ${n} reserva${n>1?'s':''}?`))return; vals.forEach(r => validated.delete(r.idx)); _validatedVersion++; invalidateFilterCache(); renderTable(); batchWriteValidation(vals.map(r=>r.idx), false); }
function changeSettingConsol(i,k,v){const oldC=getLiq(allReservas[i]);settings[i][k]=v;invalidateCache(i);const newC=getLiq(allReservas[i]);if(_globalStatsCache)_globalStatsCache.tL+=(newC.totalLiq-oldC.totalLiq);if(currentConsolAloj)viewConsolDetail(currentConsolAloj);scheduleReservaConfigSave(i);}
function togglePasarelaConsol(i){const oldC=getLiq(allReservas[i]);settings[i].pasarela=!settings[i].pasarela;invalidateCache(i);const newC=getLiq(allReservas[i]);if(_globalStatsCache)_globalStatsCache.tL+=(newC.totalLiq-oldC.totalLiq);if(currentConsolAloj)viewConsolDetail(currentConsolAloj);scheduleReservaConfigSave(i);}
function toggleValidateConsol(i){const wasV=validated.has(i);if(wasV)validated.delete(i);else validated.add(i);_validatedVersion++;invalidateFilterCache();if(currentConsolAloj)viewConsolDetail(currentConsolAloj);writeValidationToSheet(i,!wasV);}
function validarTodasConsol(alojName) {
  let src=allReservas.filter(r => r.alojamiento === alojName);
  if (_mpHasFilter()) src = src.filter(r => _mpMatchDate(r._dEntrada));
  const pending=src.filter(r => !validated.has(r.idx));
  if(!pending.length||!confirm(`\u00BFValidar ${pending.length} reserva${pending.length>1?'s':''} de ${alojName}?`))return;
  pending.forEach(r => validated.add(r.idx));
  _validatedVersion++; invalidateFilterCache();
  if(currentConsolAloj) viewConsolDetail(currentConsolAloj);
  batchWriteValidation(pending.map(r=>r.idx), true);
}
function desvalidarTodasConsol(alojName) {
  let src=allReservas.filter(r => r.alojamiento === alojName);
  if (_mpHasFilter()) src = src.filter(r => _mpMatchDate(r._dEntrada));
  const vals=src.filter(r => validated.has(r.idx));
  if(!vals.length||!confirm(`\u00BFDesvalidar ${vals.length} reserva${vals.length>1?'s':''} de ${alojName}?`))return;
  vals.forEach(r => validated.delete(r.idx));
  _validatedVersion++; invalidateFilterCache();
  if(currentConsolAloj) viewConsolDetail(currentConsolAloj);
  batchWriteValidation(vals.map(r=>r.idx), false);
}
function togglePasarela(i){
  const oldC = getLiq(allReservas[i]);
  settings[i].pasarela=!settings[i].pasarela; invalidateCache(i);
  const newC = getLiq(allReservas[i]);
  if (_globalStatsCache) _globalStatsCache.tL += (newC.totalLiq - oldC.totalLiq);
  _patchSingleRow(i, oldC, newC);
  scheduleReservaConfigSave(i);
}
function toggleValidate(i){
  const wasValidated = validated.has(i);
  if(wasValidated) validated.delete(i); else validated.add(i);
  _validatedVersion++;
  const sf2 = simpleComboState.status.value;
  const sortF = simpleComboState.sort.value;
  if (sf2 !== 'all' || sortF === 'estado') {
    invalidateFilterCache();
    renderTable();
  } else {
    // Patch path \u2014 filtered set unchanged, just toggle badge + update stats
    _patchSingleRow(i, null, null, wasValidated);
  }
  if(document.getElementById("screen-detail").classList.contains("active"))viewDetail(i);
  if(document.getElementById("screen-consoldetail").classList.contains("active") && currentConsolAloj) viewConsolDetail(currentConsolAloj);
  writeValidationToSheet(i, !wasValidated);
}

// \u2500\u2500\u2500 CACHED STATS for incremental updates \u2500\u2500\u2500
let _cachedFilteredStats = null; // { filPendingCount, filValidatedCount, fR, fL, fV, tNoches, tTotal, tBase, tComPlat, tComGTC, tLimp, tAmen, tComPas, tSub, tRet, tIva21, tLiq }

function _computeStatsFromScratch(fil) {
  const s = { filPendingCount:0, filValidatedCount:0, fR:0, fL:0, fV:0,
    tNoches:0, tTotal:0, tBase:0, tComPlat:0, tComGTC:0, tLimp:0, tAmen:0, tComPas:0, tSub:0, tRet:0, tIva21:0, tLiq:0, tCE:0, tCE2:0 };
  for (let i = 0; i < fil.length; i++) {
    const r = fil[i], c = getLiq(r), isV = validated.has(r.idx);
    s.fR += r.totalReserva; s.fL += c.totalLiq;
    if (isV) { s.fV++; s.filValidatedCount++; } else s.filPendingCount++;
    s.tNoches += r._nights; s.tTotal += r.totalReserva; s.tBase += c.baseSinIVA;
    s.tComPlat += c.comPlat; s.tComGTC += c.comGTC; s.tLimp += c.limp; s.tAmen += c.amen; s.tComPas += c.comPas;
    s.tSub += c.sub; s.tRet += c.ret; s.tIva21 += c.iva; s.tLiq += c.totalLiq; s.tCE += c.ceTotal; s.tCE2 += c.ceSinIvaTotal;
  }
  _cachedFilteredStats = s;
  return s;
}

function _getOrComputeStats(fil) {
  if (_cachedFilteredStats) return _cachedFilteredStats;
  return _computeStatsFromScratch(fil);
}

// \u2500\u2500\u2500 IN-PLACE ROW UPDATE O(1) \u2500\u2500\u2500
function _patchSingleRow(idx, oldC, newC, validationFlipped) {
  const row = document.getElementById("row-" + idx);
  if (!row) { renderTable(); return; }
  const r = allReservas[idx];
  if (!r) return;

  // Save scroll position before DOM changes
  const wrap = row.closest('.table-wrap');
  const scrollBefore = wrap ? wrap.scrollTop : window.scrollY;

  // Build new HTML (main row + CE panel row + CE2 panel row)
  const tmp = document.createElement('tbody');
  tmp.innerHTML = _buildRowHtml(r);
  let newMainRow = tmp.children[0];
  let newCePanel = tmp.children[1]; // CE (IVA inc.) panel
  let newCe2Panel = tmp.children[2]; // CE (Sin IVA) panel

  // Remember if CE panels were open
  let oldCePanel = document.getElementById('ce-ppanel-' + idx);
  let cePanelWasOpen = oldCePanel && oldCePanel.style.display !== 'none';
  let oldCe2Panel = document.getElementById('ce2-ppanel-' + idx);
  let ce2PanelWasOpen = oldCe2Panel && oldCe2Panel.style.display !== 'none';

  // Batch all DOM mutations: use replaceWith to swap in one go
  let fragment = document.createDocumentFragment();
  fragment.appendChild(newMainRow);
  if (newCePanel) {
    if (cePanelWasOpen) { newCePanel.style.display = ''; _openCEPanel = idx; _openCEView = 'p'; }
    fragment.appendChild(newCePanel);
  }
  if (newCe2Panel) {
    if (ce2PanelWasOpen) { newCe2Panel.style.display = ''; _openCE2Panel = idx; _openCE2View = 'p'; }
    fragment.appendChild(newCe2Panel);
  }
  if (oldCe2Panel) oldCe2Panel.remove();
  if (oldCePanel) oldCePanel.remove();
  row.replaceWith(fragment);

  // Restore scroll position synchronously
  if (wrap) wrap.scrollTop = scrollBefore; else window.scrollTo(0, scrollBefore);

  // Incremental stats update
  const fil = _lastFiltered;
  if (!fil) { renderTable(); return; }

  let st = _cachedFilteredStats;
  if (!st) { st = _computeStatsFromScratch(fil); }

  if (oldC && newC) {
    st.fL += (newC.totalLiq - oldC.totalLiq);
    st.tBase += (newC.baseSinIVA - oldC.baseSinIVA);
    st.tComPlat += (newC.comPlat - oldC.comPlat);
    st.tComGTC += (newC.comGTC - oldC.comGTC);
    st.tLimp += (newC.limp - oldC.limp);
    st.tAmen += (newC.amen - oldC.amen);
    st.tComPas += (newC.comPas - oldC.comPas);
    st.tSub += (newC.sub - oldC.sub);
    st.tRet += (newC.ret - oldC.ret);
    st.tIva21 += (newC.iva - oldC.iva);
    st.tLiq += (newC.totalLiq - oldC.totalLiq);
    st.tCE += (newC.ceTotal - oldC.ceTotal);
    st.tCE2 += (newC.ceSinIvaTotal - oldC.ceSinIvaTotal);
  }
  if (validationFlipped !== undefined) {
    if (validationFlipped) {
      st.filValidatedCount--; st.filPendingCount++; st.fV--;
    } else {
      st.filValidatedCount++; st.filPendingCount--; st.fV++;
    }
  }

  _renderStatsFromCache(fil, st);
}

function _renderStatsFromCache(fil, st) {
  const sf2 = simpleComboState.status.value;
  const hasFilter = comboState.platform.selected.size > 0 || comboState.aloj.selected.size > 0 || sf2 !== "all" || _mpHasFilter();

  const gs = getGlobalStats();
  const tR = gs.tR, tL = gs.tL, vC = validated.size;

  const btnVal = document.getElementById("btn-validar-todas");
  const btnDesval = document.getElementById("btn-desvalidar-todas");
  btnVal.style.display = st.filPendingCount > 0 ? '' : 'none';
  btnVal.textContent = st.filPendingCount === fil.length ? `\u2713 Validar todas (${st.filPendingCount})` : `\u2713 Validar pendientes (${st.filPendingCount})`;
  btnDesval.style.display = st.filValidatedCount > 0 ? '' : 'none';
  btnDesval.textContent = st.filValidatedCount === fil.length ? `\u21A9 Desvalidar todas (${st.filValidatedCount})` : `\u21A9 Desvalidar validadas (${st.filValidatedCount})`;

  document.getElementById("filter-count").textContent = fil.length + " reservas";
  const pctR = allReservas.length > 0 ? (fil.length / allReservas.length * 100).toFixed(1) : 0;
  const pctTR = tR > 0 ? (st.fR / tR * 100).toFixed(1) : 0;
  const pctTL = tL > 0 ? (st.fL / tL * 100).toFixed(1) : 0;
  const pctV = vC > 0 ? (st.fV / vC * 100).toFixed(1) : 0;
  document.getElementById("stats-row").innerHTML = `
    <div class="stat-card"><div class="stat-label">Reservas</div><div class="stat-value">${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${fil.length} filtradas <span class="stat-pct">(${pctR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Total Reservas</div><div class="stat-value" style="color:#1a2744">${fmt(tR)} \u20AC</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(st.fR)} \u20AC <span class="stat-pct">(${pctTR}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Total a Liquidar</div><div class="stat-value" style="color:#4f8cff">${fmt(tL)} \u20AC</div>
      ${hasFilter ? `<div class="stat-filtered">${fmt(st.fL)} \u20AC <span class="stat-pct">(${pctTL}%)</span></div>` : ''}</div>
    <div class="stat-card"><div class="stat-label">Validadas</div><div class="stat-value" style="color:#43a047">${vC} / ${allReservas.length}</div>
      ${hasFilter ? `<div class="stat-filtered">${st.fV} / ${fil.length} filtradas <span class="stat-pct">(${pctV}%)</span></div>` : ''}</div>`;

  _updateFooter(fil.length, st.tNoches, st.tTotal, st.tBase, st.tComPlat, st.tComGTC, st.tLimp, st.tAmen, st.tComPas, st.tSub, st.tRet, st.tIva21, st.tLiq, st.tCE, st.tCE2);
}

let highlightIdx = null;
function goToReserva(idx) {
  // Reset filters so the reservation is visible
  comboState.platform.selected = new Set(); updateComboDisplay('platform');
  comboState.aloj.selected = new Set(); updateComboDisplay('aloj');
  clearMonthFilter();
  simpleComboState.status.value = 'all';
  document.querySelector('#combo-status .combo-input').value = '';
  document.querySelector('#combo-status .combo-input').placeholder = 'Todos los estados';
  document.getElementById('combo-status').classList.remove('has-value');
  simpleComboState.sort.value = 'idx';
  document.querySelector('#combo-sort .combo-input').value = '';
  document.querySelector('#combo-sort .combo-input').placeholder = 'Orden original';
  document.getElementById('combo-sort').classList.remove('has-value');
  simpleComboState.sortdir.value = 'asc';
  document.querySelector('#combo-sortdir .combo-input').value = '';
  document.querySelector('#combo-sortdir .combo-input').placeholder = '\u2191';
  document.getElementById('combo-sortdir').classList.remove('has-value');
  highlightIdx = idx;
  showScreen("list");
  renderTable();
  setTimeout(() => {
    const row = document.getElementById("row-" + idx);
    if (row) {
      row.scrollIntoView({ behavior: "smooth", block: "center" });
      row.classList.add("highlight");
      setTimeout(() => { row.classList.remove("highlight"); highlightIdx = null; }, 2000);
    }
  }, 100);
}

// \u2500\u2500\u2500 INDIVIDUAL DETAIL \u2500\u2500\u2500
function viewDetail(idx) {
  currentDetailIdx = idx;
  const r=allReservas.find(x=>x.idx===idx); if(!r)return;
  const s=settings[r.idx]||{},c=calcLiquidacion(r,s),isV=validated.has(r.idx),isB=r.plataforma==="Booking.com";
  const pasL=isB?"Booking":"Stripe",pasR=s.pasarelaRate!==undefined?s.pasarelaRate:(isB?pasarelaBookingOptions[0]/100:pasarelaStripeOptions[0]/100);
  const _vd = (idx, key, val) => `changeSetting(${idx},'${key}',parseFloat(this.value));viewDetail(${idx})`;
  const _sel = (opts, current, idx, key, unitPct) => {
    if(isV) return unitPct ? `(${(current*100).toFixed(1)}%)` : ``;
    return `<select class="sel" style="font-size:12px;padding:3px 6px;margin-left:6px;" onchange="${_vd(idx,key)}">` +
      opts.map(o => { const v = unitPct ? o/100 : o;
        return `<option value="${v}" ${Math.abs(current-v)<0.0001?'selected':''}>${unitPct?o+'%':o+' &#8364;'}</option>`;
      }).join('') + `</select>`;
  };

  const platOpts = platformOptions[r.plataforma]||[10];
  const pasOpts = isB ? pasarelaBookingOptions : pasarelaStripeOptions;

  const comPlatLabel = `Canal de Venta ${r.plataforma} ` + _sel(platOpts, c.comRate, r.idx, 'comPlataforma', true);
  const comGTCLabel = `Gesti\u00F3n GTC ` + _sel(gtcOptions, c.gtcRate, r.idx, 'comGTC', true);
  const limpLabel = `Limpieza ` + _sel(cleaningOptions, c.limp, r.idx, 'limpieza', false);
  const amenLabel = `Amenities ` + _sel(amenitiesOptions, c.amen, r.idx, 'amenities', false);

  const rows=[];
  rows.push({l:"Total Reserva (IVA incluido)",v:c.total,bold:true});
  rows.push({l:`IVA Reserva (${(IVA_RESERVA*100).toFixed(0)}%)`,v:-(c.total-c.baseSinIVA),neg:true},
    {l:"Base sin IVA",v:c.baseSinIVA,bold:true},{div:true},
    {l:comPlatLabel,v:-c.comPlat,neg:true},{div:true},
    {l:comGTCLabel,v:-c.comGTC,neg:true},
    {l:limpLabel,v:-c.limp,neg:true},
    {l:amenLabel,v:-c.amen,neg:true},{div:true}
  );
  if(s.pasarela){
    const pasLabel = isV ? `Pasarela de pago ${pasL} (${(pasR*100).toFixed(1)}%)`
      : `Pasarela de pago ${pasL} ` + _sel(pasOpts, pasR, r.idx, 'pasarelaRate', true);
    rows.push({l:pasLabel,v:-c.comPas,neg:true});
  }
  // Pasarela toggle row (only if not validated)
  if(!isV){
    const toggleHtml = `<div style="display:inline-flex;align-items:center;gap:8px;margin-left:6px;">` +
      `<div class="toggle" onclick="togglePasarela(${r.idx});viewDetail(${r.idx})"><div class="toggle-track ${s.pasarela?'on':''}"><div class="toggle-thumb"></div></div></div>` +
      `<span style="font-size:12px;color:#6b7280;">${s.pasarela?'Activada':'Desactivada'}</span></div>`;
    if(!s.pasarela) rows.push({l:`Pasarela ${pasL} ${toggleHtml}`,v:0,custom:true});
    else rows.push({l:`${toggleHtml}`,v:0,custom:true});
  }
  // CE Sin IVA items in detail view
  if (c.ceSinIvaTotal > 0) {
    const ce2Items = s.conceptosSinIVA || [];
    ce2Items.forEach(function(item) {
      if (item.amount > 0) rows.push({l:`C.E. Sin IVA: ${item.label || 'Sin nombre'}`,v:-item.amount,neg:true});
    });
  }
  rows.push({div:true},
    {l:"Subtotal",v:c.sub,bold:true},
    {l:"__IRPF__",v:-c.ret,neg:true,irpf:true},
    {l:`IVA del Subtotal (${(IVA_SUBTOTAL*100).toFixed(0)}%)`,v:c.iva,pos:true});
  const irpfSelHtml = isV ? `Retenci&#243;n IRPF (${(c.irpfRate*100).toFixed(0)}%)`
    : `Retenci&#243;n IRPF ` + _sel(irpfOptions, c.irpfRate, r.idx, 'irpf', true);
  let rH=rows.map(row=>{if(row.div)return'<div class="liq-divider"></div>';
    if(row.custom)return`<div class="liq-row" style="justify-content:flex-end;"><span>${row.l}</span></div>`;
    const cl=row.bold?' bold':'';const vc=row.neg?'neg':row.pos?'pos':'';
    const d=row.v<0?`- ${fmt(Math.abs(row.v))}`:fmt(row.v);
    const label=row.irpf?irpfSelHtml:row.l;
    return`<div class="liq-row${cl}"><span>${label}</span><span class="${vc}">${d} &#8364;</span></div>`;}).join("");
    const _prop = getPropietario(r.alojamiento);
    const _propStyle = _prop === 'Falta propietario' ? ' style="color:#e53935;cursor:pointer" ' : ' style="cursor:pointer" ';
    document.getElementById("detail-content").innerHTML=`<div class="liq-container print-target" id="print-zone">
    <div class="liq-header"><div class="header-top"><div><div class="type">${isV?'Liquidaci\u00F3n':'Preliquidaci\u00F3n'}</div><div class="name"${_propStyle} title="Clic para editar propietario" onclick="editPropietarioInline('${r.alojamiento.replace(/'/g,"\\'")}', this)">${_prop}</div></div>
    <div>${isV?'<span class="badge-liq badge-liq-green">&#10003; VALIDADA</span>':'<span class="badge-liq badge-liq-amber">PENDIENTE</span>'}</div></div>
    <div class="liq-meta"><div><div class="liq-meta-label">Alojamiento</div><div class="liq-meta-value">${esc(r.alojamiento)}</div></div>
    <div><div class="liq-meta-label">Fechas</div><div class="liq-meta-value">${formatDate(r.fechaEntrada)} &#8594; ${formatDate(r.fechaSalida)}</div></div>
    <div><div class="liq-meta-label">Canal de Venta</div><div class="liq-meta-value">${r.plataforma}</div></div>
    <div><div class="liq-meta-label">ID Reserva</div><div class="liq-meta-value">${r.id}</div></div>
    <div><div class="liq-meta-label">Localizador</div><div class="liq-meta-value" style="font-size:11px">${r.localizador}</div></div>
    <div><div class="liq-meta-label">Edificio</div><div class="liq-meta-value">${esc(r.edificio)}</div></div></div></div>
    <div style="padding:8px 0;">${rH}</div>
    <div class="liq-total"><span>TOTAL A LIQUIDAR</span><span>${fmt(c.totalLiq)} \u20AC</span></div></div>
    <div class="liq-actions no-print">
      ${!isV?`<button class="btn btn-success" onclick="toggleValidate(${r.idx})">&#10003; Validar</button>`:`<button class="btn btn-orange" onclick="toggleValidate(${r.idx})">&#8617; Desvalidar</button>`}
      <button class="btn btn-outline" onclick="window.print()">&#128424; Imprimir</button></div>`;
  document.getElementById("nav-detail").style.display="block"; showScreen("detail");
}

// \u2500\u2500\u2500 CONSOLIDATED GRID \u2500\u2500\u2500
let _alojCache = null;
function invalidateAlojCache() { _alojCache = null; }
function getAlojamientos() {
  if (_alojCache) return _alojCache;
  const map = {};
  allReservas.forEach(r => {
    if (!map[r.alojamiento]) map[r.alojamiento] = { name: r.alojamiento, edificio: r.edificio, reservas: [] };
    map[r.alojamiento].reservas.push(r);
  });
  _alojCache = Object.values(map).sort((a, b) => a.name.localeCompare(b.name));
  return _alojCache;
}

function renderConsolGrid() {
  const alojamientos = getAlojamientos();

  // Apply date filter helper
  function filterByDate(reservas) {
    if (!_mpHasFilter()) return reservas;
    return reservas.filter(r => _mpMatchDate(r._dEntrada));
  }

  let totalAloj = 0, readyCount = 0, totalLiq = 0;

  // Pre-compute stats for sorting (with date-filtered reservas)
  let alojData = alojamientos.map(a => {
    const filtered = filterByDate(a.reservas);
    if (filtered.length === 0) return null; // hide alojamientos with 0 reservas in range
    const total = filtered.length;
    const valCount = filtered.filter(r => validated.has(r.idx)).length;
    const allVal = valCount === total;
    const sumReservas = filtered.reduce((s, r) => s + r.totalReserva, 0);
    const sumLiq = filtered.reduce((s, r) => s + getLiq(r).totalLiq, 0);
    return { ...a, reservas: filtered, total, valCount, allVal, sumReservas, sumLiq };
  }).filter(Boolean);

  // Text search filter for consol
  if (_searchTextConsol) {
    const s = _searchTextConsol;
    alojData = alojData.filter(a => {
      // Search in alojamiento name and edificio
      if (a.name.toLowerCase().includes(s) || (a.edificio||'').toLowerCase().includes(s)) return true;
      // Search in any reservation field within this alojamiento
      return a.reservas.some(r => {
        const c = getLiq(r);
        return r._clienteLc.includes(s) || r.id.toLowerCase().includes(s) ||
        r.localizador.toLowerCase().includes(s) || r._platLc.includes(s) ||
        (r.atendidoPor||'').toLowerCase().includes(s) ||
        (r.observacion||'').toLowerCase().includes(s) ||
        r._fmtEntrada.includes(s) || r._fmtSalida.includes(s) ||
        fmt(r.totalReserva).includes(s) || fmt(c.totalLiq).includes(s) ||
        fmt(c.baseSinIVA).includes(s) || String(r.totalReserva).includes(s);
      });
    });
  }

  // Compute stats after all filters
  alojData.forEach(a => {
    totalAloj++;
    if (a.allVal) readyCount++;
    totalLiq += a.sumLiq;
  });

  // Sort
  const sortMode = simpleComboState.consolsort.value;
  alojData.sort((a, b) => {
    switch(sortMode) {
      case 'name': return a.name.localeCompare(b.name);
      case 'name-desc': return b.name.localeCompare(a.name);
      case 'reservas-desc': return b.total - a.total || a.name.localeCompare(b.name);
      case 'reservas-asc': return a.total - b.total || a.name.localeCompare(b.name);
      case 'liq-desc': return b.sumLiq - a.sumLiq || a.name.localeCompare(b.name);
      case 'liq-asc': return a.sumLiq - b.sumLiq || a.name.localeCompare(b.name);
      case 'total-desc': return b.sumReservas - a.sumReservas || a.name.localeCompare(b.name);
      case 'total-asc': return a.sumReservas - b.sumReservas || a.name.localeCompare(b.name);
      case 'pending': return (a.allVal?1:0) - (b.allVal?1:0) || a.name.localeCompare(b.name);
      case 'ready': return (b.allVal?1:0) - (a.allVal?1:0) || a.name.localeCompare(b.name);
      default: return a.name.localeCompare(b.name);
    }
  });

  // Render position badges for top sorts
  const showRank = ['reservas-desc','liq-desc','total-desc'].includes(sortMode);

  let cardsHTML = '';
  alojData.forEach((a, idx) => {
    const pct = a.total > 0 ? (a.valCount / a.total * 100) : 0;
    const barColor = a.allVal ? '#43a047' : '#ff9800';
    const rankBadge = showRank ? `<div style="position:absolute;top:12px;left:12px;width:24px;height:24px;border-radius:12px;background:${idx<3?'#4f8cff':'#e0e4ea'};color:${idx<3?'#fff':'#6b7280'};font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;">${idx+1}</div>` : '';

    cardsHTML += `
      <div class="aloj-card ${a.allVal ? 'ready' : 'pending'}" onclick="viewConsolDetail('${a.name.replace(/'/g, "\\'")}')">
        ${rankBadge}
        <div class="aloj-semaforo">${a.allVal ? '&#128994;' : '&#128992;'}</div>
        <div class="aloj-name" ${showRank?'style="padding-left:28px;"':''}>${a.name}</div>
        <div class="aloj-edificio">${a.edificio}</div>
        <div class="aloj-stats">
          <div><div class="aloj-stat-label">Reservas</div><div class="aloj-stat-value">${a.total}</div></div>
          <div><div class="aloj-stat-label">Facturaci\u00F3n</div><div class="aloj-stat-value" style="font-size:14px;color:#1a2744">${fmt(a.sumReservas)} \u20AC</div></div>
          <div><div class="aloj-stat-label">A Liquidar</div><div class="aloj-stat-value" style="color:#4f8cff;font-size:14px">${fmt(a.sumLiq)} \u20AC</div></div>
        </div>
        <div class="aloj-bar"><div class="aloj-bar-fill" style="width:${pct}%;background:${barColor};"></div></div>
      </div>`;
  });

  // Compute total facturacion
  const totalFact = alojData.reduce((s, a) => s + a.sumReservas, 0);

  document.getElementById("consol-stats").innerHTML = `
    <div class="stat-card"><div class="stat-label">Alojamientos</div><div class="stat-value">${totalAloj}</div></div>
    <div class="stat-card"><div class="stat-label">Total Facturaci\u00F3n</div><div class="stat-value" style="color:#1a2744">${fmt(totalFact)} \u20AC</div></div>
    <div class="stat-card"><div class="stat-label">Total a Liquidar</div><div class="stat-value" style="color:#4f8cff">${fmt(totalLiq)} \u20AC</div></div>
    <div class="stat-card"><div class="stat-label">Listos para liquidar</div><div class="stat-value" style="color:#43a047">${readyCount} / ${totalAloj}</div></div>`;
  document.getElementById("aloj-grid").innerHTML = cardsHTML;
}

// \u2500\u2500\u2500 CONSOLIDATED DETAIL \u2500\u2500\u2500
function buildComPlatRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const key = x.r.plataforma + '|' + (x.c.comRate * 100).toFixed(1);
    if (!groups[key]) groups[key] = { plat: x.r.plataforma, rate: x.c.comRate, sum: 0, count: 0 };
    groups[key].sum += x.c.comPlat;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Canal de Venta ${g.plat} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '';
  let total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.plat} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Canal de Venta</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildGTCRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const rate = x.c.gtcRate;
    const key = (rate * 100).toFixed(0);
    if (!groups[key]) groups[key] = { rate, sum: 0, count: 0 };
    groups[key].sum += x.c.comGTC;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Gesti\u00F3n GTC (${(g.rate*100).toFixed(0)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>GTC al ${(g.rate*100).toFixed(0)}% &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Gesti\u00F3n GTC</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildPasarelaRows(calcs) {
  const withPas = calcs.filter(x => x.s.pasarela && x.c.comPas > 0);
  if (withPas.length === 0) return '';
  const groups = {};
  withPas.forEach(x => {
    const isB = x.r.plataforma === 'Booking.com';
    const label = isB ? 'Booking' : 'Stripe';
    const rate = x.s.pasarelaRate || (isB ? pasarelaBookingOptions[0]/100 : pasarelaStripeOptions[0]/100);
    const key = label + '|' + (rate * 100).toFixed(1);
    if (!groups[key]) groups[key] = { label, rate, sum: 0, count: 0 };
    groups[key].sum += x.c.comPas;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Pasarela ${g.label} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.label} (${(g.rate*100).toFixed(1)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Pasarela de pago</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildIrpfRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const rate = x.c.irpfRate;
    const key = (rate * 100).toFixed(0);
    if (!groups[key]) groups[key] = { rate, sum: 0, count: 0 };
    groups[key].sum += x.c.ret;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Retenci&#243;n IRPF (${(g.rate*100).toFixed(0)}%) &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>IRPF al ${(g.rate*100).toFixed(0)}% &#8212; ${g.count} reserva${g.count>1?'s':''}</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Retenci&#243;n IRPF</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

function buildLimpRows(calcs) {
  const groups = {};
  calcs.forEach(x => {
    const v = x.c.limp;
    const key = v.toFixed(0);
    if (!groups[key]) groups[key] = { val: v, sum: 0, count: 0 };
    groups[key].sum += v;
    groups[key].count++;
  });
  const entries = Object.values(groups);
  if (entries.length === 1) {
    const g = entries[0];
    return `<div class="consol-row"><span>Limpieza (${g.count} &#215; ${fmt(g.val)} &#8364;)</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
  }
  let html = '', total = 0;
  entries.forEach(g => {
    html += `<div class="consol-row sub"><span>${g.count} &#215; ${fmt(g.val)} &#8364;</span><span class="neg">- ${fmt(g.sum)} &#8364;</span></div>`;
    total += g.sum;
  });
  return `<div class="consol-row"><span>Limpieza</span><span class="neg">- ${fmt(total)} &#8364;</span></div>` + html;
}

// === Consolidated monthly deductions management ===
function buildPrintDeductionsHtml(alojName) {
  let maint = getConsolMaint(alojName);
  let extras = getConsolExtras(alojName);
  let h = '';
  if (maint.enabled) {
    h += '<div class="liq-row"><span>Mantenimiento</span><span class="neg">- ' + fmt(maint.amount) + ' \u20AC</span></div>';
  }
  extras.forEach(function(ex) {
    h += '<div class="liq-row"><span>' + ex.label + '</span><span class="neg">- ' + fmt(ex.amount) + ' \u20AC</span></div>';
  });
  return h;
}

function buildConsolDeductionsHtml(alojName) {
  let maint = getConsolMaint(alojName);
  let extras = getConsolExtras(alojName);
  let esc = alojName.replace(/'/g, "\\'");
  let maintSelOpts = maintenanceOptions.map(function(o) {
    return '<option value="'+o+'"'+(o===maint.amount?' selected':'')+'>'+o+' \u20AC</option>';
  }).join('');

  let html = '';

  // Maintenance row \u2014 same consol-row style
  html += '<div class="consol-row"><span style="display:flex;align-items:center;gap:8px;">';
  html += '<span class="no-print" style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:3px;border:2px solid '+(maint.enabled?'#16a34a':'#d1d5db')+';background:'+(maint.enabled?'#16a34a':'#fff')+';color:#fff;font-size:11px;cursor:pointer;" onclick="toggleConsolMaint(\''+esc+'\')">'+(maint.enabled?'&#10003;':'')+'</span>';
  html += '<span style="'+(maint.enabled?'':'color:#9ca3af;text-decoration:line-through;')+'">Mantenimiento</span>';
  if (maint.enabled) html += ' <select class="sel no-print" onchange="changeConsolMaintAmount(\''+esc+'\',this.value)" style="font-size:11px;padding:2px 6px;">'+maintSelOpts+'</select>';
  html += '</span>';
  if (maint.enabled) html += '<span class="neg">- '+fmt(maint.amount)+' \u20AC</span>';
  html += '</div>';

  // Extra concepts \u2014 same consol-row style
  extras.forEach(function(ex, ei) {
    html += '<div class="consol-row"><span style="display:flex;align-items:center;gap:8px;">';
    html += '<span class="no-print" style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:3px;border:1px solid #fca5a5;background:#fef2f2;color:#e53935;font-size:11px;cursor:pointer;" onclick="removeConsolExtra(\''+esc+'\','+ei+')">&#10005;</span>';
    html += ex.label;
    html += '</span><span class="neg">- '+fmt(ex.amount)+' \u20AC</span></div>';
  });

  // Add concept button
  html += '<div class="consol-row no-print" style="padding-top:4px;padding-bottom:4px;">';
  html += '<button onclick="addConsolExtra(\''+esc+'\')" style="font-size:11px;color:#3b82f6;background:none;border:1px dashed #93c5fd;border-radius:5px;padding:3px 10px;cursor:pointer;">+ A\u00f1adir concepto</button>';
  html += '</div>';

  return html;
}

function toggleConsolMaint(alojName) {
  let m = getConsolMaint(alojName);
  m.enabled = !m.enabled;
  scheduleGlobalConfigSave();
  viewConsolDetail(alojName);
}
function changeConsolMaintAmount(alojName, val) {
  let m = getConsolMaint(alojName);
  m.amount = parseFloat(val) || maintenanceOptions[0];
  scheduleGlobalConfigSave();
  viewConsolDetail(alojName);
}
function addConsolExtra(alojName) {
  let label = prompt('Nombre del concepto:');
  if (!label || !label.trim()) return;
  let amountStr = prompt('Importe base (sin IVA) en \u20AC:');
  let amount = parseFloat((amountStr||'').replace(',','.'));
  if (isNaN(amount) || amount <= 0) { alert('Importe no v\u00E1lido'); return; }
  let extras = getConsolExtras(alojName);
  extras.push({ label: label.trim(), amount: amount });
  scheduleGlobalConfigSave();
  viewConsolDetail(alojName);
}
function removeConsolExtra(alojName, idx) {
  let extras = getConsolExtras(alojName);
  if (idx >= 0 && idx < extras.length) { extras.splice(idx, 1); }
  scheduleGlobalConfigSave();
  viewConsolDetail(alojName);
}

function viewConsolDetail(alojName) {
  currentConsolAloj = alojName;
  const alojamientos = getAlojamientos();
  const a = alojamientos.find(x => x.name === alojName);
  if (!a) return;

  // Apply date filter
  let filteredReservas = a.reservas;
  if (_mpHasFilter()) {
    filteredReservas = a.reservas.filter(r => _mpMatchDate(r._dEntrada));
  }

  const allVal = filteredReservas.every(r => validated.has(r.idx));
  const calcs = filteredReservas.map(r => ({ r, s: settings[r.idx] || {}, c: getLiq(r) }));

  // Sums
  const sumCE = calcs.reduce((s, x) => s + x.c.ceTotal, 0);
  const sumOriginal = calcs.reduce((s, x) => s + x.r.totalReserva, 0);
  const sumTotal = calcs.reduce((s, x) => s + x.c.total, 0);
  const sumBase = calcs.reduce((s, x) => s + x.c.baseSinIVA, 0);
  const sumComPlat = calcs.reduce((s, x) => s + x.c.comPlat, 0);
  const sumComGTC = calcs.reduce((s, x) => s + x.c.comGTC, 0);
  const sumComPas = calcs.reduce((s, x) => s + x.c.comPas, 0);
  const sumLimp = calcs.reduce((s, x) => s + x.c.limp, 0);
  const sumAmen = calcs.reduce((s, x) => s + x.c.amen, 0);
  const sumCE2 = calcs.reduce((s, x) => s + x.c.ceSinIvaTotal, 0);
  const sumSub = calcs.reduce((s, x) => s + x.c.sub, 0);
  const sumIva = calcs.reduce((s, x) => s + x.c.iva, 0);
  const sumRet = calcs.reduce((s, x) => s + x.c.ret, 0);
  const sumLiq = calcs.reduce((s, x) => s + x.c.totalLiq, 0);

  // Sort calcs
  calcs.sort((a,b) => {
    let va = consolGetSortValue(a, consolSortF), vb = consolGetSortValue(b, consolSortF);
    if (typeof va === "string") return consolSortD === "asc" ? va.localeCompare(vb) : vb.localeCompare(va);
    return consolSortD === "asc" ? va - vb : vb - va;
  });

  // Consolidated table - identical look to main preliquidaciones (without alojamiento)
  let cNoches=0, cTotal=0, cBase=0, cComPlat=0, cComGTC=0, cLimp=0, cAmen=0, cComPas=0, cSub=0, cRet=0, cIva21=0, cLiq=0, cCE=0, cCE2=0;

  let miniRows = calcs.map(x => {
    const r = x.r, c = x.c, s = x.s, isV = validated.has(r.idx), isB = r._isBooking;
    const nights = r._nights;
    const dis = isV ? 'disabled' : '';

    const pO = selectWithValue(_selectCache['plat_'+r.plataforma]||'<option>10%</option>', s.comPlataforma);
    const gO = selectWithValue(_selectCache.gtc, s.comGTC);
    const cO = selectCleanWithValue(_selectCache.clean, s.limpieza);
    const aO = selectCleanWithValue(_selectCache.amenities, s.amenities);
    const iO = selectWithValue(_selectCache.irpf, s.irpf);
    const psO = selectWithValue(isB?_selectCache.pasBooking:_selectCache.pasStripe, s.pasarelaRate);

    cNoches+=nights; cTotal+=r.totalReserva; cBase+=c.baseSinIVA; cComPlat+=c.comPlat; cComGTC+=c.comGTC; cLimp+=c.limp; cAmen+=c.amen; cComPas+=c.comPas; cSub+=c.sub; cRet+=c.ret; cIva21+=c.iva; cLiq+=c.totalLiq; cCE+=c.ceTotal; cCE2+=c.ceSinIvaTotal;

    return `<tr ${isV?'class="validated"':''} id="crow-${r.idx}">
      <td class="cc-estado">${isV?'<span class="badge badge-green">&#10003; Validada</span>':'<span class="badge badge-amber">Pendiente</span>'}</td>
      <td class="cc-idReserva" style="font-size:12px;color:#6b7280;">${r.id}</td>
      <td class="cc-localizador" style="font-size:11px;color:#6b7280;white-space:nowrap;">${r.localizador}</td>
      <td class="cc-fechaAlta" style="font-size:12px;color:#6b7280;">${r._fmtAlta}</td>
      <td class="cc-cliente bold ellip">${esc(r.cliente)}</td>
      <td class="cc-edificio ellip" style="font-size:12px;color:#6b7280;">${esc(r.edificio)}</td>
      <td class="cc-plataforma"><span class="badge ${isB?'badge-purple':'badge-blue'}">${r.plataforma}</span></td>
      <td class="cc-atendidoPor ellip" style="font-size:12px;color:#6b7280;">${esc(r.atendidoPor)}</td>
      <td class="cc-origenMarketing ellip" style="font-size:12px;color:#6b7280;">${esc(r.origenMarketing)}</td>
      <td class="cc-tipoReserva" style="font-size:12px;color:#6b7280;">${esc(r.tipoReserva)}</td>
      <td class="cc-fechaEntrada" style="font-size:12px;white-space:nowrap;">${r._fmtEntrada}</td>
      <td class="cc-fechaSalida" style="font-size:12px;white-space:nowrap;">${r._fmtSalida}</td>
      <td class="cc-noches" style="text-align:center">${nights}</td>
      <td class="cc-totalReserva right bold">${fmt(r.totalReserva)} &#8364;</td>
      <td class="cc-ce" style="text-align:center;vertical-align:middle;">${_buildCEButton(r.idx, c, 'c')}</td>
      <td class="cc-baseSinIVA right" style="color:#6b7280;font-size:12px;">${fmt(c.baseSinIVA)} &#8364;</td>
      <td class="cc-comPlataforma" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'comPlataforma',parseFloat(this.value))" ${dis}>${pO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPlat)} &#8364;</span></div></td>
      <td class="cc-comGTC" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'comGTC',parseFloat(this.value))" ${dis}>${gO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comGTC)} &#8364;</span></div></td>
      <td class="cc-limpieza" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'limpieza',parseFloat(this.value))" ${dis}>${cO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.limp)} &#8364;</span></div></td>
      <td class="cc-amenities" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'amenities',parseFloat(this.value))" ${dis}>${aO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.amen)} &#8364;</span></div></td>
      <td class="cc-pasarela" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><div style="display:flex;align-items:center;justify-content:center;gap:6px;">
        <div class="toggle" onclick="event.stopPropagation();if(!${isV}){togglePasarelaConsol(${r.idx})}"><div class="toggle-track ${s.pasarela?'on':''}"><div class="toggle-thumb"></div></div></div>
        ${s.pasarela?`<select class="sel" style="width:70px;font-size:11px;padding:4px 6px;" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'pasarelaRate',parseFloat(this.value))" ${dis}>${psO}</select>`:`<span class="toggle-label">${isB?'Booking':'Stripe'}</span>`}
      </div>${s.pasarela&&c.comPas>0?`<span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.comPas)} &#8364;</span>`:''}</div></td>
      <td class="cc-ceSinIva" style="text-align:center;vertical-align:middle;">${_buildCE2Button(r.idx, c, 'c')}</td>
      <td class="cc-subtotal right bold" style="font-size:12px;">${fmt(c.sub)} &#8364;</td>
      <td class="cc-irpf" style="text-align:center;vertical-align:middle;"><div style="display:flex;flex-direction:column;align-items:center;gap:3px;"><select class="sel" onchange="event.stopPropagation();changeSettingConsol(${r.idx},'irpf',parseFloat(this.value))" ${dis}>${iO}</select>
        <span style="font-size:11px;color:#e53935;font-variant-numeric:tabular-nums;">&#8211; ${fmt(c.ret)} &#8364;</span></div></td>
      <td class="cc-iva21" style="text-align:center;vertical-align:middle;"><span style="font-size:11px;color:#43a047;font-variant-numeric:tabular-nums;">+ ${fmt(c.iva)} &#8364;</span></td>
      <td class="cc-totalLiquidar right bold" style="color:${c.totalLiq>=0?'#1a2744':'#e53935'}">${fmt(c.totalLiq)} &#8364;</td>
      <td class="cc-observacion ellip" style="font-size:11px;color:#6b7280;max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${esc(r.observacion)}">${esc(r.observacion)}</td>
      <td class="cc-acciones"><div style="display:flex;gap:6px;">
        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation();goToReserva(${r.idx})">&#128065;</button>
        ${!isV?`<button class="btn btn-sm btn-success" onclick="event.stopPropagation();toggleValidateConsol(${r.idx})">&#10004;</button>`:`<button class="btn btn-sm btn-orange" onclick="event.stopPropagation();toggleValidateConsol(${r.idx})">&#8617;</button>`}
      </div></td>
    </tr>${_buildCEPanelRow(r.idx, settings[r.idx], c, 'c')}${_buildCE2PanelRow(r.idx, settings[r.idx], c, 'c')}`;
  }).join("");

  // Footer totals - identical dark bar like main table
  const _cfs='border:none;padding:10px 8px;';
  const _cfr='border:none;padding:10px 8px;color:#ff8a80;text-align:center;font-variant-numeric:tabular-nums;';
  const miniTotals = `<tr style="background:#0f1628;color:#fff;font-weight:700;font-size:12px;">
    <td class="cc-estado" style="${_cfs}"></td>
    <td class="cc-idReserva" style="${_cfs}"></td>
    <td class="cc-localizador" style="${_cfs}"></td>
    <td class="cc-fechaAlta" style="${_cfs}"></td>
    <td class="cc-cliente" style="${_cfs}text-align:right;text-transform:uppercase;letter-spacing:0.06em;font-size:11px;color:rgba(255,255,255,0.6);">Reservas Totales (${calcs.length})</td>
    <td class="cc-edificio" style="${_cfs}"></td>
    <td class="cc-plataforma" style="${_cfs}"></td>
    <td class="cc-atendidoPor" style="${_cfs}"></td>
    <td class="cc-origenMarketing" style="${_cfs}"></td>
    <td class="cc-tipoReserva" style="${_cfs}"></td>
    <td class="cc-fechaEntrada" style="${_cfs}"></td>
    <td class="cc-fechaSalida" style="${_cfs}"></td>
    <td class="cc-noches" style="${_cfs}text-align:center;">${cNoches}</td>
    <td class="cc-totalReserva" style="${_cfs}text-align:right;">${fmt(cTotal)} &#8364;</td>
    <td class="cc-ce" style="${_cfs}text-align:center;color:#d97706;font-size:11px;">${cCE > 0 ? '&#8211; ' + fmt(cCE) + ' &#8364;' : ''}</td>
    <td class="cc-baseSinIVA" style="${_cfs}text-align:right;color:rgba(255,255,255,0.6);">${fmt(cBase)} &#8364;</td>
    <td class="cc-comPlataforma" style="${_cfr}">${fmt(cComPlat)} &#8364;</td>
    <td class="cc-comGTC" style="${_cfr}">${fmt(cComGTC)} &#8364;</td>
    <td class="cc-limpieza" style="${_cfr}">${fmt(cLimp)} &#8364;</td>
    <td class="cc-amenities" style="${_cfr}">${fmt(cAmen)} &#8364;</td>
    <td class="cc-pasarela" style="${_cfr}">${cComPas>0?fmt(cComPas)+' &#8364;':'&#8211;'}</td>
    <td class="cc-ceSinIva" style="${_cfs}text-align:center;color:#c4b5fd;font-size:11px;">${cCE2 > 0 ? '&#8211; ' + fmt(cCE2) + ' &#8364;' : ''}</td>
    <td class="cc-subtotal" style="${_cfs}text-align:right;">${fmt(cSub)} &#8364;</td>
    <td class="cc-irpf" style="${_cfr}">&#8211; ${fmt(cRet)} &#8364;</td>
    <td class="cc-iva21" style="${_cfs}text-align:center;color:#81c784;font-variant-numeric:tabular-nums;">+ ${fmt(cIva21)} &#8364;</td>
    <td class="cc-totalLiquidar" style="${_cfs}text-align:right;color:#81d4fa;font-size:14px;">${fmt(cLiq)} &#8364;</td>
    <td class="cc-observacion" style="${_cfs}"></td>
    <td class="cc-acciones" style="${_cfs}"></td>
  </tr>`;

  const _dedHtml = buildConsolDeductionsHtml(alojName);
  const _ded = getConsolDeductions(alojName);
  const _isSplit = isGtcSplit(alojName);
  const _gtcSplitAmt = _isSplit ? sumSub * GTC_SPLIT_RATE : 0;
  const _ownerBase = _isSplit ? sumSub - _gtcSplitAmt : sumSub;
  const adjSub = _ownerBase - _ded.totalBase;
  const avgIrpfRate = sumSub > 0 ? sumRet / sumSub : 0;
  const adjRet = adjSub * avgIrpfRate;
  const adjIva = adjSub * IVA_SUBTOTAL;
  const adjLiq = adjSub - adjRet + adjIva;
  const content = `
    <div class="consol-container print-target" id="print-zone">
      <div class="consol-header">
        <div class="header-top">
          <div>
            <div class="type">Liquidaci\u00F3n Mensual Consolidada</div>
            <div class="name">${a.name}</div>
          </div>
          <div>${allVal?'<span class="badge-liq badge-liq-green">&#10003; LISTA</span>':'<span class="badge-liq badge-liq-amber">PENDIENTE</span>'}</div>
        </div>
        <div class="consol-meta">
          <div><div class="consol-meta-label">Propietario</div><div class="consol-meta-value" style="cursor:pointer;${getPropietario(a.name)==='Falta propietario'?'color:#e53935':''}" title="Clic para editar propietario" onclick="editPropietarioInline('${a.name.replace(/'/g,"\\'")}', this)">${getPropietario(a.name)}</div></div>
          <div><div class="consol-meta-label">Edificio</div><div class="consol-meta-value">${a.edificio}</div></div>
          <div><div class="consol-meta-label">N\u00BA Reservas</div><div class="consol-meta-value">${filteredReservas.length}</div></div>
          <div><div class="consol-meta-label">Validadas</div><div class="consol-meta-value">${filteredReservas.filter(r=>validated.has(r.idx)).length} / ${filteredReservas.length}</div></div>
        </div>
      </div>

      <div class="consol-body">
        <div class="no-print" style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid #eef0f4;background:#f8f9fb;position:relative;z-index:10;">
          <div style="display:flex;gap:8px;align-items:center;">
            ${!allVal ? `<button class="btn btn-sm btn-success" onclick="validarTodasConsol('${a.name.replace(/'/g, "\\'")}')">&#10004; Validar todas (${filteredReservas.filter(r=>!validated.has(r.idx)).length})</button>` : ''}
            ${filteredReservas.some(r=>validated.has(r.idx)) ? `<button class="btn btn-sm btn-orange" onclick="desvalidarTodasConsol('${a.name.replace(/'/g, "\\'")}')">&#8617; Desvalidar todas</button>` : ''}
          </div>
          <div class="col-toggle-wrap">
            <button class="col-toggle-btn" onclick="toggleConsolColDropdown()" title="Mostrar/ocultar columnas">&#9783; Columnas</button>
            <div class="col-toggle-dd" id="consol-col-toggle-dd"></div>
          </div>
        </div>
        <div class="card" style="padding:0;overflow:hidden;margin-bottom:0;border-radius:0;box-shadow:none;">
        <div class="table-wrap">
          <table>
            <thead><tr>
              ${CONSOL_COLUMNS.map(c => {
                const is = consolSortF===c.key;
                const ar = c.sortable ? '<span class="sort-arrow">'+(is?(consolSortD==="asc"?"&#9650;":"&#9660;"):"&#8661;")+'</span>' : '';
                const cls = ["cc-"+c.key, c.right?"right":"", is?"sorted":"", c.sortable?"":"no-sort"].filter(Boolean).join(" ");
                return '<th class="'+cls+'" '+(c.sortable?'onclick="consolSortByColumn(\''+c.key+'\')"':'')+'>'+c.label+ar+'</th>';
              }).join("")}
            </tr></thead>
            <tbody>${miniRows}</tbody>
            <tfoot>${miniTotals}</tfoot>
          </table>
        </div>
        </div>

        <div class="consol-summary-block">
        <div class="consol-section-title">Resumen Consolidado</div>
        <div class="consol-row bold"><span>Total Reservas (IVA incluido)</span><span>${fmt(sumTotal)} &#8364;</span></div>
${sumCE > 0 ? `<div class="no-print" style="background:#fffdf5;border:1px dashed #f59e0b;border-radius:6px;margin:4px 28px;padding:4px 12px;">
          <div class="consol-row" style="color:#d97706;font-size:12px;padding:4px 0;"><span>&#9888; Total original reservas</span><span>${fmt(sumOriginal)} &#8364;</span></div>
          <div class="consol-row" style="color:#d97706;font-size:12px;padding:4px 0;"><span>Conceptos especiales descontados</span><span class="neg">- ${fmt(sumCE)} &#8364;</span></div>
        </div>` : ''}
        <div class="consol-row"><span>IVA Reservas (10%)</span><span class="neg">- ${fmt(sumTotal - sumBase)} &#8364;</span></div>
        <div class="consol-row bold"><span>Base sin IVA</span><span>${fmt(sumBase)} &#8364;</span></div>
        <div class="consol-divider"></div>
        ${buildComPlatRows(calcs)}
        <div class="consol-divider"></div>
        ${buildGTCRows(calcs)}
        ${buildLimpRows(calcs)}
        <div class="consol-row"><span>Amenities</span><span class="neg">- ${fmt(sumAmen)} &#8364;</span></div>
        <div class="consol-divider"></div>
        ${buildPasarelaRows(calcs)}
${sumCE2 > 0 ? `<div class="no-print" style="background:#faf8ff;border:1px dashed #7c3aed;border-radius:6px;margin:4px 28px;padding:4px 12px;">
          <div class="consol-row" style="color:#7c3aed;font-size:12px;padding:4px 0;"><span>&#9888; C.E. Sin IVA descontados</span><span class="neg">- ${fmt(sumCE2)} &#8364;</span></div>
        </div>` : ''}
        <div class="consol-subtotal-reservas"><span>Subtotal Reservas</span><span>${fmt(sumSub)} &#8364;</span></div>
${_isSplit ? `<div class="consol-split-box">
          <div class="consol-split-title">&#8621; Reparto GTC / Propietario &mdash; Condici\u00F3n Especial</div>
          <div class="consol-row bold" style="color:#7c3aed;"><span>GTC retiene (${(GTC_SPLIT_RATE*100).toFixed(0)}%)</span><span>${fmt(_gtcSplitAmt)} &#8364;</span></div>
          <div class="consol-split-divider"></div>
          <div class="consol-row bold" style="color:#16a34a;"><span>Propietario recibe (${((1-GTC_SPLIT_RATE)*100).toFixed(0)}%)</span><span>${fmt(_ownerBase)} &#8364;</span></div>
        </div>` : ''}
        <div class="consol-monthly-box no-print">
          <div class="consol-monthly-title">&#128197; Conceptos Extraordinarios del Mes</div>
          ${_dedHtml}
        </div>
        <div class="consol-subtotal"><span>Subtotal Final Mes</span><span>${fmt(adjSub)} &#8364;</span></div>
        <div class="consol-row"><span>Retenci\u00F3n IRPF (${(avgIrpfRate*100).toFixed(0)}%)</span><span class="neg">- ${fmt(adjRet)} &#8364;</span></div>
        <div class="consol-row"><span>IVA del Subtotal (21%)</span><span class="pos">+ ${fmt(adjIva)} &#8364;</span></div>
        <div class="consol-total"><span>TOTAL A LIQUIDAR</span><span>${fmt(adjLiq)} &#8364;</span></div>
        </div>
      </div>
    </div>

    <div class="liq-actions no-print" style="margin-top:28px;" id="consol-actions">
      ${allVal
        ? `<div style="display:flex;flex-direction:column;align-items:center;gap:14px;">
            <div style="display:flex;gap:12px;align-items:center;">
              <button class="btn btn-success" onclick="handleGenerar()">&#128424; Generar Liquidaci\u00F3n</button>
              <button class="btn btn-outline" onclick="showScreen('consol')">&#8592; Volver</button>
            </div>
            ${_previewPref !== null
              ? `<div style="font-size:12px;color:#9ca3af;">
                  ${_previewPref ? '\ud83d\udc41 Se mostrar\u00E1 previsualizaci\u00F3n' : '\ud83d\udda8 Se imprimir\u00E1 directamente'}
                  &nbsp;\u00B7&nbsp; <a href="#" onclick="resetPreviewPref();return false;" style="color:#4f8cff;">Cambiar</a>
                </div>`
              : `<div id="preview-options" style="display:flex;gap:16px;align-items:center;">
                  <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;">
                    <input type="checkbox" id="chk-preview" checked style="width:16px;height:16px;cursor:pointer;">
                    Ver previsualizaci\u00F3n antes de imprimir
                  </label>
                  <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#9ca3af;cursor:pointer;">
                    <input type="checkbox" id="chk-remember" style="width:14px;height:14px;cursor:pointer;">
                    No preguntar m\u00E1s
                  </label>
                </div>`}
          </div>`
        : `<button class="btn btn-disabled">&#9888; Valida todas las reservas primero</button>
           <button class="btn btn-outline" onclick="showScreen('consol')">&#8592; Volver</button>`}
    </div>

    <div id="preview-zone" style="display:none;"></div>`;

  _previewActive = false;
  document.getElementById("consoldetail-content").innerHTML = content;
  document.getElementById("nav-consoldetail").style.display = "block";
  showScreen("consoldetail");
}

// \u2500\u2500\u2500 PRINT PREFERENCES \u2500\u2500\u2500
let _previewPref = null; // null = show options, true = always preview, false = never preview
{ const v = SafeStorage.get('liq-preview-pref'); if (v !== null) _previewPref = v === 'true'; }

function getPreviewPref() { return _previewPref === null ? true : _previewPref; }

function handleGenerar() {
  // If preference is saved, use it directly
  if (_previewPref !== null) {
    if (_previewPref) showPrintPreview(); else printConsolDirect();
    return;
  }
  // Otherwise read checkboxes
  const chkPreview = document.getElementById('chk-preview');
  const chkRemember = document.getElementById('chk-remember');
  const wantPreview = chkPreview ? chkPreview.checked : true;

  if (chkRemember && chkRemember.checked) {
    _previewPref = wantPreview;
    SafeStorage.set('liq-preview-pref', String(wantPreview));
  }

  if (wantPreview) showPrintPreview(); else printConsolDirect();
}

function resetPreviewPref() {
  _previewPref = null;
  SafeStorage.remove('liq-preview-pref');
  // Re-render to show checkboxes
  if (currentConsolAloj) viewConsolDetail(currentConsolAloj);
}

function buildPrintCards() {
  const alojName = currentConsolAloj;
  if (!alojName) return null;
  const alojamientos = getAlojamientos();
  const a = alojamientos.find(x => x.name === alojName);
  if (!a) return null;

  const calcs_src = _mpHasFilter() ? a.reservas.filter(r => _mpMatchDate(r._dEntrada)) : a.reservas;
  const calcs = calcs_src.map(r => ({ r, s: settings[r.idx] || {}, c: getLiq(r) }));

  let cardsHtml = calcs.map((x, i) => {
    const r = x.r, s = x.s, c = x.c;
    const isB = r.plataforma === 'Booking.com';
    const pasL = isB ? 'Booking' : 'Stripe';
    const pasR = s.pasarelaRate !== undefined ? s.pasarelaRate : (isB ? pasarelaBookingOptions[0]/100 : pasarelaStripeOptions[0]/100);

    let rows = [
      {l:"Total Reserva (IVA incluido)",v:c.total,bold:true},
      {l:`IVA Reserva (${(IVA_RESERVA*100).toFixed(0)}%)`,v:-(c.total-c.baseSinIVA),neg:true},
      {l:"Base sin IVA",v:c.baseSinIVA,bold:true},{div:true},
      {l:`Canal de Venta ${r.plataforma} (${(c.comRate*100).toFixed(1)}%)`,v:-c.comPlat,neg:true},{div:true},
      {l:`Gesti\u00F3n GTC (${(c.gtcRate*100).toFixed(0)}%)`,v:-c.comGTC,neg:true},
      {l:`Limpieza (${fmt(c.limp)} \u20AC)`,v:-c.limp,neg:true},
      {l:`Amenities (${fmt(c.amen)} \u20AC)`,v:-c.amen,neg:true},{div:true},
    ];
    if(s.pasarela) rows.push({l:`Pasarela de pago ${pasL} (${(pasR*100).toFixed(1)}%)`,v:-c.comPas,neg:true},{div:true});
    // CE Sin IVA items
    if (c.ceSinIvaTotal > 0) {
      const ce2Items = s.conceptosSinIVA || [];
      ce2Items.forEach(function(item) {
        if (item.amount > 0) rows.push({l:`C.E. Sin IVA: ${item.label || 'Sin nombre'}`,v:-item.amount,neg:true});
      });
      rows.push({div:true});
    }
    rows.push(
      {l:"Subtotal",v:c.sub,bold:true},
      {l:`Retenci\u00F3n IRPF (${(c.irpfRate*100).toFixed(0)}%)`,v:-c.ret,neg:true},
      {l:`IVA del Subtotal (${(IVA_SUBTOTAL*100).toFixed(0)}%)`,v:c.iva,pos:true});

    const rowsHtml = rows.map(row => {
      if (row.div) return '<div class="liq-divider"></div>';
      const cl = row.bold ? ' bold' : '';
      const vc = row.neg ? 'neg' : row.pos ? 'pos' : '';
      const d = row.v < 0 ? `- ${fmt(Math.abs(row.v))}` : fmt(row.v);
      return `<div class="liq-row${cl}"><span>${row.l}</span><span class="${vc}">${d} &#8364;</span></div>`;
    }).join('');

    return `<div class="liq-container print-card" style="margin-bottom:24px;">
      <div class="liq-header">
        <div class="header-top"><div><div class="type">Liquidaci\u00F3n ${i+1} de ${calcs.length}</div><div class="name">${getPropietario(r.alojamiento)}</div></div></div>
        <div class="liq-meta">
          <div><div class="liq-meta-label">Alojamiento</div><div class="liq-meta-value">${esc(r.alojamiento)}</div></div>
          <div><div class="liq-meta-label">Fechas</div><div class="liq-meta-value">${formatDate(r.fechaEntrada)} &#8594; ${formatDate(r.fechaSalida)}</div></div>
          <div><div class="liq-meta-label">Canal de Venta</div><div class="liq-meta-value">${r.plataforma}</div></div>
          <div><div class="liq-meta-label">ID Reserva</div><div class="liq-meta-value">${r.id}</div></div>
          <div><div class="liq-meta-label">Localizador</div><div class="liq-meta-value" style="font-size:11px">${r.localizador}</div></div>
          <div><div class="liq-meta-label">Edificio</div><div class="liq-meta-value">${esc(r.edificio)}</div></div>
        </div>
      </div>
      <div style="padding:8px 0;">${rowsHtml}</div>
      <div class="liq-total"><span>TOTAL A LIQUIDAR</span><span>${fmt(c.totalLiq)} &#8364;</span></div>
    </div>`;
  }).join('');

  const sumSub = calcs.reduce((s, x) => s + x.c.sub, 0);
  const sumRet = calcs.reduce((s, x) => s + x.c.ret, 0);
  const sumIva = calcs.reduce((s, x) => s + x.c.iva, 0);
  const sumLiq = calcs.reduce((s, x) => s + x.c.totalLiq, 0);

  const _printDed = getConsolDeductions(a.name);
  const _printDedHtml = buildPrintDeductionsHtml(a.name);
  const _pIsSplit = isGtcSplit(a.name);
  const _pGtcSplit = _pIsSplit ? sumSub * GTC_SPLIT_RATE : 0;
  const _pOwnerBase = _pIsSplit ? sumSub - _pGtcSplit : sumSub;
  const _pAdjSub = _pOwnerBase - _printDed.totalBase;
  const _pAvgIrpf = sumSub > 0 ? sumRet / sumSub : 0;
  const _pAdjRet = _pAdjSub * _pAvgIrpf;
  const _pAdjIva = _pAdjSub * IVA_SUBTOTAL;
  const _pAdjLiq = _pAdjSub - _pAdjRet + _pAdjIva;
  const _pSplitHtml = _pIsSplit ? `<div class="liq-divider"></div>
      <div class="liq-row" style="color:#7c3aed;"><span>GTC retiene (${(GTC_SPLIT_RATE*100).toFixed(0)}%)</span><span>${fmt(_pGtcSplit)} &#8364;</span></div>
      <div class="liq-row bold" style="color:#16a34a;"><span>Propietario recibe (${((1-GTC_SPLIT_RATE)*100).toFixed(0)}%)</span><span>${fmt(_pOwnerBase)} &#8364;</span></div>` : '';
  const summaryHtml = `<div class="liq-container print-summary" style="margin-top:8px;">
    <div class="liq-header">
      <div class="header-top"><div><div class="type">Resumen Consolidado \u2014 ${calcs.length} reservas</div><div class="name">${a.name}</div></div></div>
      <div class="liq-meta">
        <div><div class="liq-meta-label">Edificio</div><div class="liq-meta-value">${a.edificio}</div></div>
        <div><div class="liq-meta-label">N\u00BA Reservas</div><div class="liq-meta-value">${calcs.length}</div></div>
        <div></div>
      </div>
    </div>
    <div style="padding:8px 0;">
      <div class="liq-row bold"><span>Subtotal Reservas</span><span>${fmt(sumSub)} &#8364;</span></div>
      ${_pSplitHtml}
      ${_printDedHtml}
      <div class="liq-divider"></div>
      <div class="liq-row bold"><span>Subtotal Final Mes</span><span>${fmt(_pAdjSub)} &#8364;</span></div>
      <div class="liq-row"><span>Retenci\u00F3n IRPF (${(_pAvgIrpf*100).toFixed(0)}%)</span><span class="neg">- ${fmt(_pAdjRet)} &#8364;</span></div>
      <div class="liq-row"><span>IVA 21%</span><span class="pos">+ ${fmt(_pAdjIva)} &#8364;</span></div>
    </div>
    <div class="liq-total"><span>TOTAL A LIQUIDAR</span><span>${fmt(_pAdjLiq)} &#8364;</span></div>
  </div>`;

  return { cardsHtml, summaryHtml };
}

let _previewActive = false;

function showPrintPreview() {
  const result = buildPrintCards();
  if (!result) return;

  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  // Populate preview zone with cards + action buttons
  previewZone.innerHTML = result.cardsHtml + result.summaryHtml
    + `<div class="liq-actions no-print" style="margin-top:28px;justify-content:center;">
        <button class="btn btn-success" onclick="printFromPreview()">&#128424; Imprimir</button>
        <button class="btn btn-outline" onclick="exitPreview()">&#8592; Volver a la liquidaci\u00F3n</button>
      </div>`;

  // Toggle visibility: hide table, show preview
  printZone.style.display = 'none';
  printZone.classList.remove('print-target');
  actions.style.display = 'none';
  previewZone.style.display = 'block';
  previewZone.classList.add('print-target');
  _previewActive = true;

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function printFromPreview() {
  window.print();
}

function exitPreview() {
  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  if (!_previewActive) return;

  // Toggle back: show table, hide preview
  previewZone.style.display = 'none';
  previewZone.classList.remove('print-target');
  previewZone.innerHTML = '';
  printZone.style.display = '';
  printZone.classList.add('print-target');
  actions.style.display = '';
  _previewActive = false;
}

function printConsolDirect() {
  const result = buildPrintCards();
  if (!result) return;

  const printZone = document.getElementById('print-zone');
  const previewZone = document.getElementById('preview-zone');
  const actions = document.getElementById('consol-actions');

  // Temporarily swap to preview for printing only
  previewZone.innerHTML = result.cardsHtml + result.summaryHtml;
  printZone.style.display = 'none';
  printZone.classList.remove('print-target');
  actions.style.display = 'none';
  previewZone.style.display = 'block';
  previewZone.classList.add('print-target');

  setTimeout(() => {
    window.print();
    // Restore after print dialog closes
    setTimeout(() => {
      previewZone.style.display = 'none';
      previewZone.classList.remove('print-target');
      previewZone.innerHTML = '';
      printZone.style.display = '';
      printZone.classList.add('print-target');
      actions.style.display = '';
    }, 500);
  }, 100);
}

// \u2500\u2500\u2500 CONFIG MODAL \u2500\u2500\u2500
function switchTab(tabId, btn) {
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".modal-tab").forEach(t => t.classList.remove("active"));
  document.getElementById(tabId).classList.add("active"); btn.classList.add("active");
}
function openConfigModal() { renderConfigModal(); document.getElementById("config-modal").style.display = "flex"; }
function closeConfigModal() { document.getElementById("config-modal").style.display = "none"; rebuildSelectCache(); invalidateCache(); renderTable(); scheduleGlobalConfigSave(); }

function buildOS(title, desc, vals, unit, addId, addFn, delFn) {
  const items = vals.map((v, i) => `<div class="option-item"><span class="val">${v}${unit}</span>
    ${vals.length > 1 ? `<button class="option-delete" onclick="${delFn}(${i})">&#10005;</button>` : '<span style="width:28px"></span>'}</div>`).join("");
  return `<div class="modal-section"><h4>${title}</h4>${desc?`<div class="desc">${desc}</div>`:''}
    <div class="option-list">${items}</div>
    <div class="add-row"><input class="add-input" type="number" id="${addId}" placeholder="Nuevo valor" step="any">
    <button class="btn btn-sm btn-primary" onclick="${addFn}()">+ A\u00F1adir</button></div></div>`;
}

function renderConfigModal() {
  const pN = Object.keys(platformOptions).sort();
  let pH = '';
  pN.forEach(name => {
    const safe = name.replace(/[^a-zA-Z0-9]/g,'');
    pH += buildOS(name, "% sobre total reserva (IVA incl.)", platformOptions[name], "%", `add-plat-${safe}`, `addP_${safe}`, `delP_${safe}`);
    window[`addP_${safe}`] = function() { const inp=document.getElementById(`add-plat-${safe}`); const v=parseFloat(inp.value);
      if(isNaN(v)||v<0||v>100){alert("Porcentaje v\u00E1lido: 0-100");return;} if(platformOptions[name].some(x=>Math.abs(x-v)<0.001)){alert("Ya existe.");return;}
      platformOptions[name].push(v); platformOptions[name].sort((a,b)=>a-b); inp.value=""; renderConfigModal(); };
    window[`delP_${safe}`] = function(i) { if(platformOptions[name].length<=1)return; platformOptions[name].splice(i,1); renderConfigModal(); };
  });
  document.getElementById("tab-plat").innerHTML = pH;
  document.getElementById("tab-pasarela").innerHTML =
    buildOS("Pasarela Stripe","Plataformas distintas de Booking",pasarelaStripeOptions,"%","add-ps","addPS","delPS") +
    '<hr class="section-divider">' +
    buildOS("Pasarela Booking","Solo para Booking.com",pasarelaBookingOptions,"%","add-pb","addPB","delPB");
  document.getElementById("tab-otros").innerHTML =
    buildOS("Gesti\u00F3n GTC","% sobre base sin IVA",gtcOptions,"%","add-gtc","addGTC","delGTC") +
    '<hr class="section-divider">' +
    buildOS("Limpieza","\u20AC sin IVA",cleaningOptions," \u20AC","add-cl","addCL","delCL") +
    '<hr class="section-divider">' +
    buildOS("Amenities","Coste fijo por reserva en \u20AC",amenitiesOptions," \u20AC","add-am","addAM","delAM") +
    '<hr class="section-divider">' +
    buildOS("Mantenimiento mensual","Importe base (+ 21% IVA) por liquidaci\u00F3n",maintenanceOptions," \u20AC","add-mt","addMT","delMT") +
    '<hr class="section-divider">' +
    buildGtcSplitSection();
  document.getElementById("tab-impuestos").innerHTML =
    buildOS("Retenci\u00F3n IRPF","Porcentaje",irpfOptions,"%","add-ir","addIR","delIR");
}
function addPS(){aL(pasarelaStripeOptions,"add-ps",100);} function delPS(i){dL(pasarelaStripeOptions,i);}
function addPB(){aL(pasarelaBookingOptions,"add-pb",100);} function delPB(i){dL(pasarelaBookingOptions,i);}
function addCL(){aL(cleaningOptions,"add-cl",99999,false);} function delCL(i){dL(cleaningOptions,i);}
function addIR(){aL(irpfOptions,"add-ir",100);} function delIR(i){dL(irpfOptions,i);}
function addGTC(){aL(gtcOptions,"add-gtc",100);} function delGTC(i){dL(gtcOptions,i);}
function addAM(){aL(amenitiesOptions,"add-am",99999,false);} function delAM(i){dL(amenitiesOptions,i);}
function addMT(){aL(maintenanceOptions,"add-mt",99999,false);} function delMT(i){dL(maintenanceOptions,i);}
function aL(list,inputId,max,isP){const inp=document.getElementById(inputId);const v=parseFloat(inp.value);
  if(isP!==false){if(isNaN(v)||v<0||v>max){alert("Valor v\u00E1lido.");return;}}else{if(isNaN(v)||v<0){alert("Valor v\u00E1lido.");return;}}
  if(list.some(x=>Math.abs(x-v)<0.001)){alert("Ya existe.");return;} list.push(v);list.sort((a,b)=>a-b);inp.value="";renderConfigModal();}
function dL(list,i){if(list.length<=1)return;list.splice(i,1);renderConfigModal();}

function buildGtcSplitSection() {
  const alojs = _gtcOwnedAlojamientos.slice().sort();
  if (alojs.length === 0) return '';
  const rows = alojs.map(function(name) {
    const on = isGtcSplit(name);
    return '<div class="gtc-split-row"><span class="name' + (on ? ' on' : '') + '">' + esc(name) + '</span>' +
      '<div class="toggle" onclick="toggleGtcSplit(\'' + name.replace(/'/g, "\\'") + '\')"><div class="toggle-track' + (on ? ' on' : '') + '" style="' + (on ? 'background:#7c3aed;' : '') + '"><div class="toggle-thumb"></div></div></div></div>';
  }).join('<div class="gtc-split-divider-row"></div>');
  const count = alojs.filter(function(n){ return isGtcSplit(n); }).length;
  return '<div class="gtc-split-section"><div class="gtc-split-title">' +
    '&#8621; Reparto 80/20 GTC</div>' +
    '<div class="gtc-split-desc">Alojamientos propiedad GTC. Activa los que ya est\u00E1n vendidos: GTC retiene el 20% del Subtotal Reservas, el propietario recibe el 80%.</div>' +
    '<div class="gtc-split-list">' + rows + '</div>' +
    '<div class="gtc-split-counter"><span class="badge">' + count + '</span> de ' + alojs.length + ' vendido' + (count !== 1 ? 's' : '') + ' (80/20 activo)</div></div>';
}
function toggleGtcSplit(alojName) {
  const idx = _gtcSplitAlojamientos.indexOf(alojName);
  if (idx >= 0) { _gtcSplitAlojamientos.splice(idx, 1); }
  else { _gtcSplitAlojamientos.push(alojName); _gtcSplitAlojamientos.sort(); }
  renderConfigModal();
  scheduleGlobalConfigSave();
}

// \u2500\u2500\u2500 SEARCHABLE COMBO SYSTEM \u2500\u2500\u2500
const comboState = { platform: { selected: new Set(), options: [] }, aloj: { selected: new Set(), options: [] } };
const comboLabels = { platform: 'Todas las plataformas', aloj: 'Todos los alojamientos' };

// \u2014\u2014\u2014 MONTH PICKER STATE (multi-select) \u2014\u2014\u2014
const MONTH_NAMES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const MONTH_FULL = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
let _mpSelYears = new Set();
let _mpSelMonths = new Set();
let _mpAvailable = {};
let _mpAllYears = [];
let _mpActiveSrc = 'p';

function _mpMatchDate(d) {
  if (_mpSelYears.size === 0) return true;
  if (!d) return false;
  if (!_mpSelYears.has(d.getFullYear())) return false;
  if (_mpSelMonths.size > 0 && !_mpSelMonths.has(d.getMonth())) return false;
  return true;
}
function _mpHasFilter() { return _mpSelYears.size > 0; }

function buildAvailableMonths() {
  _mpAvailable = {};
  allReservas.forEach(r => {
    if (!r._dEntrada) return;
    const y = r._dEntrada.getFullYear(), m = r._dEntrada.getMonth();
    if (!_mpAvailable[y]) _mpAvailable[y] = {};
    _mpAvailable[y][m] = (_mpAvailable[y][m] || 0) + 1;
  });
  _mpAllYears = Object.keys(_mpAvailable).map(Number).sort((a,b) => b-a);
  const curY = new Date().getFullYear();
  const curM = new Date().getMonth();
  _mpSelYears = new Set();
  _mpSelMonths = new Set();
  if (_mpAvailable[curY]) {
    _mpSelYears.add(curY);
    if (_mpAvailable[curY][curM] !== undefined) _mpSelMonths.add(curM);
  } else if (_mpAllYears.length > 0) {
    _mpSelYears.add(_mpAllYears[0]);
  }
  updateMonthPickerBtn();
}

function toggleMonthPicker(src) {
  _mpActiveSrc = src || 'p';
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  const otherId = _mpActiveSrc === 'p' ? 'mp-dd-c' : 'mp-dd-p';
  document.getElementById(otherId).classList.remove('open');
  const dd = document.getElementById('mp-dd-' + _mpActiveSrc);
  const wasOpen = dd.classList.contains('open');
  dd.classList.toggle('open');
  if (!wasOpen) renderMonthPickerDD();
}

function renderMonthPickerDD() {
  const dd = document.getElementById('mp-dd-' + _mpActiveSrc);
  if (!dd) return;
  let monthCounts = {};
  let yearsForMonths = _mpSelYears.size > 0 ? _mpSelYears : new Set(_mpAllYears);
  yearsForMonths.forEach(function(y) {
    let ym = _mpAvailable[y] || {};
    for (let m = 0; m < 12; m++) {
      monthCounts[m] = (monthCounts[m] || 0) + (ym[m] || 0);
    }
  });
  let yearsHtml = _mpAllYears.map(y =>
    `<button class="mp-year ${_mpSelYears.has(y)?'sel':''}" onclick="event.stopPropagation();toggleMPYear(${y})">${y}</button>`
  ).join('');
  let monthsHtml = '';
  for (let m = 0; m < 12; m++) {
    const cnt = monthCounts[m] || 0;
    const isSel = _mpSelMonths.has(m);
    const dim = cnt === 0 ? 'dim' : '';
    monthsHtml += `<button class="mp-month ${isSel?'sel':''} ${dim}" onclick="event.stopPropagation();toggleMPMonth(${m})">${MONTH_NAMES[m]}<span class="mp-cnt">${cnt>0?cnt:''}</span></button>`;
  }
  dd.innerHTML = `
    <div class="mp-years">${yearsHtml}</div>
    <div class="mp-grid">${monthsHtml}</div>
    ${_mpSelYears.size > 0 || _mpSelMonths.size > 0 ? '<button class="mp-all" onclick="event.stopPropagation();clearMonthFilter()">\u2715 Quitar filtro de fecha</button>' : ''}
  `;
}

function toggleMPYear(year) {
  if (_mpSelYears.has(year)) _mpSelYears.delete(year);
  else _mpSelYears.add(year);
  if (_mpSelYears.size === 0) _mpSelMonths.clear();
  _mpRefreshAll();
  renderMonthPickerDD();
}

function toggleMPMonth(month) {
  if (_mpSelMonths.has(month)) _mpSelMonths.delete(month);
  else _mpSelMonths.add(month);
  _mpRefreshAll();
  renderMonthPickerDD();
}

function clearMonthFilter() {
  _mpSelYears.clear(); _mpSelMonths.clear();
  _mpRefreshAll();
  document.getElementById('mp-dd-p').classList.remove('open');
  document.getElementById('mp-dd-c').classList.remove('open');
}

function _mpRefreshAll() {
  updateMonthPickerBtn();
  invalidateFilterCache(); _currentPage = 1; renderTable();
  renderConsolGrid();
  if (document.getElementById("screen-consoldetail").classList.contains("active") && currentConsolAloj) viewConsolDetail(currentConsolAloj);
}

function _mpBtnHtml() {
  if (_mpSelYears.size === 0) return { active: false, html: null };
  let yArr = [..._mpSelYears].sort();
  let label = '';
  let arrows = false;
  if (_mpSelYears.size === 1 && _mpSelMonths.size <= 1) {
    // Single selection: show arrows
    arrows = true;
    if (_mpSelMonths.size === 1) {
      let m = [..._mpSelMonths][0];
      label = MONTH_FULL[m] + ' ' + yArr[0];
    } else {
      label = 'A\u00F1o ' + yArr[0];
    }
  } else if (_mpSelMonths.size > 0) {
    let mArr = [..._mpSelMonths].sort((a,b) => a-b);
    let mNames = mArr.map(m => MONTH_NAMES[m]).join(', ');
    label = mNames + ' ' + yArr.join(', ');
  } else {
    label = yArr.join(', ');
  }
  let html = '';
  if (arrows) {
    html += '<span class="mp-nav"><button class="mp-arrow" onclick="event.stopPropagation();mpPrev()">&#8249;</button></span>';
  }
  html += label;
  if (arrows) {
    html += '<span class="mp-nav"><button class="mp-arrow" onclick="event.stopPropagation();mpNext()">&#8250;</button></span>';
  }
  html += '<span class="mp-clear" onclick="event.stopPropagation();clearMonthFilter();">\u2715</span>';
  return { active: true, html: html };
}

function mpPrev() {
  if (_mpSelYears.size !== 1) return;
  let y = [..._mpSelYears][0];
  if (_mpSelMonths.size === 1) {
    let m = [..._mpSelMonths][0];
    m--;
    if (m < 0) { m = 11; y--; }
    _mpSelYears = new Set([y]);
    _mpSelMonths = new Set([m]);
  } else {
    _mpSelYears = new Set([y - 1]);
  }
  _mpRefreshAll();
}

function mpNext() {
  if (_mpSelYears.size !== 1) return;
  let y = [..._mpSelYears][0];
  if (_mpSelMonths.size === 1) {
    let m = [..._mpSelMonths][0];
    m++;
    if (m > 11) { m = 0; y++; }
    _mpSelYears = new Set([y]);
    _mpSelMonths = new Set([m]);
  } else {
    _mpSelYears = new Set([y + 1]);
  }
  _mpRefreshAll();
}

function updateMonthPickerBtn() {
  const info = _mpBtnHtml();
  ['p','c'].forEach(src => {
    const btn = document.getElementById('mp-btn-' + src);
    const label = document.getElementById('mp-label-' + src);
    if (!btn || !label) return;
    if (info.active) {
      label.innerHTML = info.html;
      btn.classList.add('active');
    } else {
      label.textContent = 'Todos los meses';
      btn.classList.remove('active');
    }
  });
}

function populateCombo(id, items) {
  comboState[id].options = items;
  comboState[id].selected = new Set();
  updateComboDisplay(id);
}

function openCombo(id) {
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  document.querySelectorAll('.mp-dd').forEach(l => l.classList.remove('open'));
  const input = document.querySelector(`#combo-${id} .combo-input`);
  input.value = '';
  input.select();
  renderComboList(id, '');
  document.getElementById(`combo-list-${id}`).classList.add('open');
}

function filterCombo(id) {
  const input = document.querySelector(`#combo-${id} .combo-input`);
  renderComboList(id, input.value);
  document.getElementById(`combo-list-${id}`).classList.add('open');
}

function renderComboList(id, query) {
  const list = document.getElementById(`combo-list-${id}`);
  const q = query.toLowerCase().trim();
  const items = comboState[id].options;
  let filtered = items;
  if (q) filtered = items.filter(i => i.toLowerCase().includes(q));
  const sel = comboState[id].selected;

  const countFn = id === 'platform'
    ? (v) => allReservas.filter(r => r.plataforma === v).length
    : (v) => allReservas.filter(r => r.alojamiento === v).length;

  const allChecked = sel.size === 0;
  let html = `<label class="combo-selall" onclick="event.stopPropagation()"><input type="checkbox" ${allChecked?'checked':''} onchange="toggleComboAll('${id}', this.checked)"> ${comboLabels[id]} <span class="combo-item-count">(${allReservas.length})</span></label>`;
  if (filtered.length === 0) {
    html += '<div class="combo-empty">Sin resultados</div>';
  } else {
    filtered.forEach(item => {
      const isChecked = sel.has(item);
      let label = item;
      if (q) {
        const idx = item.toLowerCase().indexOf(q);
        if (idx >= 0) label = item.slice(0, idx) + '<span class="match">' + item.slice(idx, idx + q.length) + '</span>' + item.slice(idx + q.length);
      }
      const count = countFn(item);
      const esc = item.replace(/'/g, "\\'");
      html += `<label class="combo-item-chk" onclick="event.stopPropagation()"><input type="checkbox" ${isChecked?'checked':''} onchange="toggleComboItem('${id}','${esc}',this.checked)"> ${label} <span class="combo-item-count">(${count})</span></label>`;
    });
  }
  list.innerHTML = html;
}

function toggleComboItem(id, item, checked) {
  const sel = comboState[id].selected;
  if (checked) sel.add(item); else sel.delete(item);
  updateComboDisplay(id);
  invalidateFilterCache(); _currentPage = 1; renderTable();
  // Re-render list to update checkboxes
  const input = document.querySelector(`#combo-${id} .combo-input`);
  renderComboList(id, '');
}

function toggleComboAll(id, checked) {
  if (checked) {
    comboState[id].selected = new Set();
  } else {
    comboState[id].selected = new Set(comboState[id].options);
  }
  updateComboDisplay(id);
  invalidateFilterCache(); _currentPage = 1; renderTable();
  renderComboList(id, '');
}

function updateComboDisplay(id) {
  const input = document.querySelector(`#combo-${id} .combo-input`);
  const wrap = document.getElementById(`combo-${id}`);
  const sel = comboState[id].selected;
  if (sel.size === 0) {
    input.value = '';
    input.placeholder = comboLabels[id];
    wrap.classList.remove('has-value');
  } else if (sel.size === 1) {
    input.value = [...sel][0];
    wrap.classList.add('has-value');
  } else {
    const noun = id === 'platform' ? 'plataformas' : 'alojamientos';
    input.value = sel.size + ' ' + noun;
    wrap.classList.add('has-value');
  }
}

function clearCombo(id) {
  comboState[id].selected = new Set();
  updateComboDisplay(id);
  document.getElementById(`combo-list-${id}`).classList.remove('open');
  invalidateFilterCache(); _currentPage = 1; renderTable();
}

// \u2500\u2500\u2500 SIMPLE COMBO SYSTEM (for status, sort, sortdir) \u2500\u2500\u2500
const simpleComboState = {
  status: { value: 'all', label: 'Todos los estados' },
  sort: { value: 'idx', label: 'Orden original' },
  sortdir: { value: 'asc', label: '&#8593;' },
  consolsort: { value: 'name', label: 'Nombre A\u2191Z' }
};
const simpleComboOptions = {
  status: [
    { value: 'all', label: 'Todos los estados' },
    { value: 'pending', label: 'Pendientes' },
    { value: 'validated', label: 'Validadas' }
  ],
  sort: [
    { value: 'idx', label: 'Orden original' },
    { value: 'estado', label: 'Estado' },
    { value: 'idReserva', label: 'ID Reserva' },
    { value: 'localizador', label: 'Localizador' },
    { value: 'fechaAlta', label: 'Fecha Alta' },
    { value: 'cliente', label: 'Cliente' },
    { value: 'alojamiento', label: 'Alojamiento' },
    { value: 'edificio', label: 'Edificio' },
    { value: 'plataforma', label: 'Plataforma' },
    { value: 'atendidoPor', label: 'Atendido por' },
    { value: 'origenMarketing', label: 'Origen Mkt.' },
    { value: 'tipoReserva', label: 'Tipo Reserva' },
    { value: 'fechaEntrada', label: 'Fecha Entrada' },
    { value: 'fechaSalida', label: 'Fecha Salida' },
    { value: 'noches', label: 'Noches' },
    { value: 'totalReserva', label: 'Total reserva' },
    { value: 'baseSinIVA', label: 'Base sin IVA' },
    { value: 'subtotal', label: 'Subtotal' },
    { value: 'totalLiquidar', label: 'Total a liquidar' },
    { value: 'observacion', label: 'Observaci\u00F3n' }
  ],
  sortdir: [
    { value: 'asc', label: '&#8593; Ascendente' },
    { value: 'desc', label: '&#8595; Descendente' }
  ],
  consolsort: [
    { value: 'name', label: 'Nombre A\u2191Z' },
    { value: 'name-desc', label: 'Nombre Z\u2191A' },
    { value: 'reservas-desc', label: 'M\u00E1s reservas' },
    { value: 'reservas-asc', label: 'Menos reservas' },
    { value: 'liq-desc', label: 'Mayor liquidaci\u00F3n' },
    { value: 'liq-asc', label: 'Menor liquidaci\u00F3n' },
    { value: 'total-desc', label: 'Mayor facturaci\u00F3n' },
    { value: 'total-asc', label: 'Menor facturaci\u00F3n' },
    { value: 'pending', label: 'Pendientes primero' },
    { value: 'ready', label: 'Listas primero' }
  ]
};

function openSimpleCombo(id) {
  document.querySelectorAll('.combo-list').forEach(l => l.classList.remove('open'));
  const list = document.getElementById(`combo-list-${id}`);
  const opts = simpleComboOptions[id];
  const current = simpleComboState[id].value;
  list.innerHTML = opts.map(o =>
    `<div class="combo-item ${o.value===current?'active':''}" onclick="selectSimpleCombo('${id}','${o.value}')">${o.label}</div>`
  ).join('');
  list.classList.add('open');
}

function selectSimpleCombo(id, value) {
  const opt = simpleComboOptions[id].find(o => o.value === value);
  simpleComboState[id].value = value;
  simpleComboState[id].label = opt ? opt.label : value;
  const input = document.querySelector(`#combo-${id} .combo-input`);
  const wrap = document.getElementById(`combo-${id}`);
  if (id === 'status') {
    if (value === 'all') {
      input.value = ''; input.placeholder = 'Todos los estados'; wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  } else if (id === 'sort') {
    if (value === 'idx') {
      input.value = ''; input.placeholder = 'Orden original'; wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  } else if (id === 'sortdir') {
    if (value === 'asc') {
      input.value = ''; input.placeholder = '\u2191'; wrap.classList.remove('has-value');
    } else {
      input.value = '\u2193'; wrap.classList.add('has-value');
    }
  } else if (id === 'consolsort') {
    if (value === 'name') {
      input.value = ''; input.placeholder = 'Nombre A\u2191Z'; wrap.classList.remove('has-value');
    } else {
      input.value = opt.label; wrap.classList.add('has-value');
    }
  }
  document.getElementById(`combo-list-${id}`).classList.remove('open');
  if (id === 'consolsort') { renderConsolGrid(); }
  else { _currentPage = 1; renderTable(); }
}

function clearSimpleCombo(id) {
  const defaults = { status: 'all', sort: 'idx', sortdir: 'asc', consolsort: 'name' };
  selectSimpleCombo(id, defaults[id] || 'all');
}

// Close all combos on outside click
document.addEventListener('click', function(e) {
  // Close column toggles
  document.querySelectorAll('.col-toggle-wrap').forEach(ctw => {
    if (!ctw.contains(e.target)) {
      const dd = ctw.querySelector('.col-toggle-dd');
      if (dd) dd.classList.remove('open');
    }
  });
  // Close month pickers
  ['p','c'].forEach(src => {
    const mpWrap = document.getElementById('mp-wrap-' + src);
    if (mpWrap && !mpWrap.contains(e.target)) {
      document.getElementById('mp-dd-' + src).classList.remove('open');
    }
  });
  document.querySelectorAll('.combo').forEach(c => {
    if (!c.contains(e.target)) {
      c.querySelector('.combo-list').classList.remove('open');
      const id = c.id.replace('combo-', '');
      // Restore display for searchable combos
      if (comboState[id]) updateComboDisplay(id);
    }
  });
});

// Keyboard nav for combos
document.querySelectorAll('.combo-input').forEach(input => {
  input.addEventListener('keydown', function(e) {
    const id = this.closest('.combo').id.replace('combo-', '');
    const list = document.getElementById(`combo-list-${id}`);
    if (e.key === 'Escape') { list.classList.remove('open'); this.blur(); }
  });
});

// === AI ASSISTANT ===
let _aiPanelOpen = false;
let _aiHistory = [];
let _aiProcessing = false;

function toggleAIPanel() {
  _aiPanelOpen = !_aiPanelOpen;
  document.getElementById('ai-panel').classList.toggle('open', _aiPanelOpen);
  if (_aiPanelOpen) {
    document.getElementById('ai-badge').style.display = 'none';
    setTimeout(function(){ document.getElementById('ai-input').focus(); }, 300);
  }
}

function _getAIKey() {
  let key = SafeStorage.get('ai-api-key');
  if (!key) {
    key = prompt('Introduce tu API Key de Anthropic para activar el asistente IA.\n\nLa clave se guarda localmente en tu navegador y nunca se comparte.\n\nPuedes obtenerla en: console.anthropic.com');
    if (key && key.trim()) {
      SafeStorage.set('ai-api-key', key.trim());
    } else { return null; }
  }
  return key;
}

function buildAIContext() {
  if (!allReservas || allReservas.length === 0) return 'No hay datos cargados.';

  let total = allReservas.length;
  let byAloj = {}, byPlat = {}, byMes = {}, byEdificio = {}, byAtendido = {}, byTipo = {};
  let sumImporte = 0, sumLiq = 0, sumNoches = 0, sumBase = 0;
  let sumComPlat = 0, sumComGTC = 0, sumLimp = 0, sumAmen = 0, sumPas = 0, sumCE = 0, sumCE2 = 0;
  let numVal = 0, numPend = 0;

  allReservas.forEach(function(r) {
    let c = getLiq(r);
    let n = r._nights || 0;
    sumImporte += c.total; sumLiq += c.totalLiq; sumNoches += n;
    sumBase += c.baseSinIVA; sumComPlat += c.comPlat; sumComGTC += c.comGTC;
    sumLimp += c.limp; sumAmen += c.amen; sumPas += c.comPas; sumCE += c.ceTotal; sumCE2 += c.ceSinIvaTotal;
    if (validated.has(r.idx)) numVal++; else numPend++;

    let a = r.alojamiento || 'Sin alojamiento';
    if (!byAloj[a]) byAloj[a] = {n:0, imp:0, liq:0, noch:0, base:0};
    byAloj[a].n++; byAloj[a].imp += c.total; byAloj[a].liq += c.totalLiq; byAloj[a].noch += n; byAloj[a].base += c.baseSinIVA;

    let p = r.plataforma || 'Desconocida';
    if (!byPlat[p]) byPlat[p] = {n:0, imp:0, liq:0};
    byPlat[p].n++; byPlat[p].imp += c.total; byPlat[p].liq += c.totalLiq;

    let fE = r._dEntrada;
    if (fE) {
      let mes = (fE.getMonth()+1).toString().padStart(2,'0') + '/' + fE.getFullYear();
      if (!byMes[mes]) byMes[mes] = {n:0, imp:0, liq:0, noch:0};
      byMes[mes].n++; byMes[mes].imp += c.total; byMes[mes].liq += c.totalLiq; byMes[mes].noch += n;
    }

    let ed = r.edificio || 'Sin edificio';
    if (!byEdificio[ed]) byEdificio[ed] = {n:0, imp:0};
    byEdificio[ed].n++; byEdificio[ed].imp += c.total;

    let at = r.atendidoPor || 'Sin asignar';
    if (!byAtendido[at]) byAtendido[at] = {n:0, imp:0};
    byAtendido[at].n++; byAtendido[at].imp += c.total;

    let tp = r.tipoReserva || 'Sin tipo';
    if (!byTipo[tp]) byTipo[tp] = {n:0, imp:0};
    byTipo[tp].n++; byTipo[tp].imp += c.total;
  });

  let f = function(v){ return v.toFixed(2); };
  let ctx = '=== RESUMEN GLOBAL ===\n';
  ctx += 'Total reservas: ' + total + ' (Validadas: ' + numVal + ', Pendientes: ' + numPend + ')\n';
  ctx += 'Total noches: ' + sumNoches + '\n';
  ctx += 'Importe total reservas (IVA inc.): ' + f(sumImporte) + ' EUR\n';
  ctx += 'Base sin IVA total: ' + f(sumBase) + ' EUR\n';
  ctx += 'Comision canal total: ' + f(sumComPlat) + ' EUR\n';
  ctx += 'Comision GTC total: ' + f(sumComGTC) + ' EUR\n';
  ctx += 'Limpieza total: ' + f(sumLimp) + ' EUR\n';
  ctx += 'Amenities total: ' + f(sumAmen) + ' EUR\n';
  ctx += 'Pasarela total: ' + f(sumPas) + ' EUR\n';
  ctx += 'Conceptos Especiales total: ' + f(sumCE) + ' EUR\n';
  ctx += 'Conceptos Especiales Sin IVA total: ' + f(sumCE2) + ' EUR\n';
  ctx += 'Total a liquidar: ' + f(sumLiq) + ' EUR\n\n';

  ctx += '=== POR ALOJAMIENTO ===\n';
  Object.keys(byAloj).sort().forEach(function(a) {
    let d = byAloj[a];
    ctx += a + ': ' + d.n + ' reservas, ' + d.noch + ' noches, importe(IVA) ' + f(d.imp) + ' EUR, base ' + f(d.base) + ' EUR, liquidar ' + f(d.liq) + ' EUR\n';
  });

  ctx += '\n=== POR PLATAFORMA/CANAL DE VENTA ===\n';
  Object.keys(byPlat).sort().forEach(function(p) {
    let d = byPlat[p];
    ctx += p + ': ' + d.n + ' reservas, importe(IVA) ' + f(d.imp) + ' EUR, liquidar ' + f(d.liq) + ' EUR\n';
  });

  ctx += '\n=== POR MES ===\n';
  Object.keys(byMes).sort().forEach(function(m) {
    let d = byMes[m];
    ctx += m + ': ' + d.n + ' reservas, ' + d.noch + ' noches, importe(IVA) ' + f(d.imp) + ' EUR, liquidar ' + f(d.liq) + ' EUR\n';
  });

  ctx += '\n=== POR EDIFICIO ===\n';
  Object.keys(byEdificio).sort().forEach(function(e) {
    let d = byEdificio[e];
    ctx += e + ': ' + d.n + ' reservas, importe(IVA) ' + f(d.imp) + ' EUR\n';
  });

  ctx += '\n=== POR ATENDIDO POR ===\n';
  Object.keys(byAtendido).sort().forEach(function(a) {
    let d = byAtendido[a];
    ctx += a + ': ' + d.n + ' reservas, importe(IVA) ' + f(d.imp) + ' EUR\n';
  });

  ctx += '\n=== POR TIPO DE RESERVA ===\n';
  Object.keys(byTipo).sort().forEach(function(t) {
    let d = byTipo[t];
    ctx += t + ': ' + d.n + ' reservas, importe(IVA) ' + f(d.imp) + ' EUR\n';
  });

  // Detail: use FILTERED rows (what user sees) instead of all, max 200
  let filtered = (typeof getFilteredSorted === 'function') ? getFilteredSorted() : allReservas;
  let maxDetail = 200;
  let detailRows = filtered.slice(0, maxDetail);
  let filteredTotal = filtered.length;
  ctx += '\n=== DETALLE RESERVAS ';
  if (filteredTotal < total) {
    ctx += '(FILTRO ACTIVO: ' + filteredTotal + ' de ' + total + ' reservas';
  } else {
    ctx += '(' + total + ' reservas totales';
  }
  ctx += ', mostrando ' + detailRows.length + ') ===\n';
  ctx += 'ID | Localizador | Cliente | Alojamiento | Edificio | Plataforma | AtendidoPor | TipoReserva | Entrada | Salida | Noches | ImporteIVA | BaseSinIVA | ComCanal | ComGTC | Limpieza | Amenities | CE | Pasarela | Subtotal | ALiquidar | Estado\n';
  for (let i = 0; i < detailRows.length; i++) {
    const r = detailRows[i];
    let c = getLiq(r);
    ctx += [
      r.id||'-', r.localizador||'-', (r.cliente||'-').substring(0,25), (r.alojamiento||'-').substring(0,20),
      (r.edificio||'-').substring(0,15), r.plataforma||'-', (r.atendidoPor||'-').substring(0,15),
      (r.tipoReserva||'-').substring(0,10),
      r._fmtEntrada||'-', r._fmtSalida||'-', r._nights||0,
      f(c.total), f(c.baseSinIVA), f(c.comPlat), f(c.comGTC),
      f(c.limp), f(c.amen), f(c.ceTotal||0), f(c.comPas),
      f(c.sub), f(c.totalLiq), validated.has(r.idx)?'Validada':'Pendiente'
    ].join(' | ') + '\n';
  }
  if (filteredTotal > maxDetail) {
    ctx += '... (' + (filteredTotal - maxDetail) + ' reservas mas no incluidas en detalle, pero SI contabilizadas en los resumenes globales)\n';
  }

  return ctx;
}

function _addAIMsg(role, text) {
  let box = document.getElementById('ai-messages');
  let div = document.createElement('div');
  div.className = 'ai-msg ' + role;
  if (role === 'assistant') {
    let html = text
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\n/g, '<br>');
    div.innerHTML = html;
  } else {
    div.textContent = text;
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

function _showTyping() {
  let box = document.getElementById('ai-messages');
  let div = document.createElement('div');
  div.className = 'ai-msg assistant'; div.id = 'ai-typing';
  div.innerHTML = '<div class="ai-typing"><span></span><span></span><span></span></div>';
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
function _removeTyping() { const el = document.getElementById('ai-typing'); if(el) el.remove(); }

async function sendAIMessage() {
  if (_aiProcessing) return;
  let input = document.getElementById('ai-input');
  let text = input.value.trim();
  if (!text) return;

  if (!allReservas || allReservas.length === 0) {
    _addAIMsg('error', 'Primero carga las reservas desde Google Sheets o Excel para poder responder preguntas.');
    return;
  }

  let apiKey = _getAIKey();
  if (!apiKey) return;

  _addAIMsg('user', text);
  input.value = ''; input.style.height = 'auto';
  _aiHistory.push({role:'user', content:text});

  _aiProcessing = true;
  document.getElementById('ai-send').disabled = true;
  _showTyping();

  try {
    let context = buildAIContext();
    let sysPrompt = 'Eres el "Asistente Hist\u00F3rico Reservas" de la aplicaci\u00F3n Liquidaciones GTC, una herramienta de gesti\u00F3n de reservas vacacionales.\n\n' +
      'REGLAS ESTRICTAS:\n' +
      '1. SOLO puedes responder bas\u00E1ndote en los datos proporcionados abajo. NUNCA inventes cifras, fechas, nombres de clientes, alojamientos ni importes.\n' +
      '2. Si no tienes la informaci\u00F3n para responder, di: "No tengo esa informaci\u00F3n en los datos cargados."\n' +
      '3. NUNCA des consejos financieros, legales ni fiscales. Solo reporta datos.\n' +
      '4. Responde siempre en espa\u00F1ol.\n' +
      '5. S\u00E9 conciso y directo. Usa cifras exactas con 2 decimales y el s\u00EDmbolo \u20AC.\n' +
      '6. Cuando cites importes, especifica si son con IVA incluido o sin IVA (base).\n' +
      '7. NUNCA accedas a informaci\u00F3n externa. Solo los datos de abajo.\n' +
      '8. Si te preguntan algo que no son datos de reservas, responde amablemente que solo puedes responder sobre los datos de reservas cargados.\n' +
      '9. Los res\u00FAmenes (por alojamiento, plataforma, mes, edificio, atendido por, tipo) son EXACTOS y cubren TODAS las reservas.\n' +
      '10. El detalle individual muestra las reservas que el usuario tiene filtradas en pantalla (m\u00E1ximo 200). Los totales de los res\u00FAmenes siempre incluyen TODAS las reservas.\n' +
      '11. Si el usuario necesita datos espec\u00EDficos de reservas individuales y hay muchas, sugi\u00E9rele que filtre en la tabla (por alojamiento, plataforma, mes...) y vuelva a preguntar, as\u00ED tendr\u00E1s el detalle exacto.\n\n' +
      'CAMPOS DISPONIBLES POR RESERVA:\n' +
      '- ID Reserva, Localizador, Cliente, Alojamiento, Edificio, Plataforma (canal de venta)\n' +
      '- Atendido Por, Tipo Reserva, Origen Marketing, Observaciones\n' +
      '- Fecha Entrada, Fecha Salida, Noches\n' +
      '- Importe total (IVA inc.), Base sin IVA\n' +
      '- Comisi\u00F3n Canal de Venta, Comisi\u00F3n GTC, Limpieza, Amenities, Conceptos Especiales, Pasarela\n' +
      '- Subtotal, Total a Liquidar, Estado (Validada/Pendiente)\n\n' +
      'DATOS ACTUALES:\n' + context;

    let messages = _aiHistory.slice(-CONFIG.MAX_AI_HISTORY);

    let resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: CONFIG.AI_MODEL,
        max_tokens: CONFIG.AI_MAX_TOKENS,
        system: sysPrompt,
        messages: messages
      })
    });

    _removeTyping();

    if (!resp.ok) {
      let errData = await resp.json().catch(function(){ return {}; });
      if (resp.status === 401) {
        SafeStorage.remove('ai-api-key');
        _addAIMsg('error', 'API Key inv\u00E1lida. Se ha borrado. Vuelve a intentarlo.');
      } else {
        _addAIMsg('error', 'Error: ' + (errData.error && errData.error.message ? errData.error.message : resp.statusText));
      }
      _aiHistory.pop();
    } else {
      let data = await resp.json();
      let reply = data.content.map(function(b){ return b.text||''; }).join('');
      _aiHistory.push({role:'assistant', content:reply});
      _addAIMsg('assistant', reply);
    }
  } catch(e) {
    _removeTyping();
    _addAIMsg('error', 'Error de conexi\u00F3n: ' + e.message);
    _aiHistory.pop();
  }

  _aiProcessing = false;
  document.getElementById('ai-send').disabled = false;
  document.getElementById('ai-input').focus();
}

// Auto-resize AI textarea
(function(){
  let ta = document.getElementById('ai-input');
  if(ta) ta.addEventListener('input', function(){ this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,100)+'px'; });
})();
// === END AI ASSISTANT ===
</script>
</body>
</html>
